begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  * tdport.c  * This file contains port realted functions such as tiCOMPortStart()  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/sadefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|TURN_OFF_HDA
end_ifndef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/hda/64k/aap1img.h>
end_include

begin_comment
comment|/* SPC HDA */
end_comment

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/hda/64k/ilaimg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/hda/64k/iopimg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/hda/64k/istrimg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/hda/64k/aap18008.h>
end_include

begin_comment
comment|/* SPCv HDA */
end_comment

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/hda/64k/iop8008.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/hda/64k/ila8008.h>
end_include

begin_comment
comment|/* Ila common to SPCv SPCvp versions */
end_comment

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/hda/64k/raae8070.h>
end_include

begin_comment
comment|/* SPCv 12g HDA */
end_comment

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/hda/64k/iop8070.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/hda/64k/ila8070.h>
end_include

begin_comment
comment|/* Ila 12g  SPCv SPCvp versions */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TURN_OFF_HDA */
end_comment

begin_decl_stmt
name|bit32
name|gSSC_Disable
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bit32
specifier|volatile
name|sgpioResponseSet
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|ECHO_TESTING
end_ifdef

begin_comment
comment|/* temporary to test saEchoCommand() */
end_comment

begin_decl_stmt
name|bit8
name|gEcho
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|bit32
name|tiCOMConfigureSgpio
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit8
name|enableSgpio
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/***************************************************************************** *! \brief tdsaGetSwConfigParams * *  Purpose:  This function reads software configuration parameters from the *            configuration file * *  \param  tiRoot:            Pointer to driver/port instance. * *  \return: None * *  \note - * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaGetSwConfigParams
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|agsaSwConfig_t
modifier|*
name|SwConfig
decl_stmt|;
name|agsaQueueConfig_t
modifier|*
name|QueueConfig
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|bit32
name|buffLen
decl_stmt|;
name|bit32
name|lenRecv
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pLastUsedChar
init|=
name|agNULL
decl_stmt|;
name|char
name|tmpBuffer
index|[
name|DEFAULT_KEY_BUFFER_SIZE
index|]
decl_stmt|;
name|char
name|globalStr
index|[]
init|=
literal|"Global"
decl_stmt|;
name|char
name|iniParmsStr
index|[]
init|=
literal|"InitiatorParms"
decl_stmt|;
name|char
name|SwParmsStr
index|[]
init|=
literal|"SWParms"
decl_stmt|;
name|char
name|OBQueueProps
index|[]
init|=
literal|"OBQueueProps"
decl_stmt|;
name|char
name|IBQueueProps
index|[]
init|=
literal|"IBQueueProps"
decl_stmt|;
name|char
name|IBQueueSize
index|[
literal|40
index|]
decl_stmt|;
name|char
name|OBQueueSize
index|[
literal|40
index|]
decl_stmt|;
name|char
name|IBQueueEleSize
index|[
literal|40
index|]
decl_stmt|;
name|char
name|OBQueueEleSize
index|[
literal|40
index|]
decl_stmt|;
name|char
name|OBQueueInterruptCount
index|[
literal|40
index|]
decl_stmt|;
name|char
name|OBQueueInterruptDelay
index|[
literal|40
index|]
decl_stmt|;
name|char
name|OBQueueInterruptEnable
index|[
literal|40
index|]
decl_stmt|;
name|char
name|IBQueuePriority
index|[
literal|40
index|]
decl_stmt|;
name|char
modifier|*
name|cardNum
init|=
name|tdsaAllShared
operator|->
name|CardIDString
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|bit32
name|enableDIF
decl_stmt|;
name|bit32
name|enableEncryption
decl_stmt|;
ifdef|#
directive|ifdef
name|SA_CONFIG_MDFD_REGISTRY
name|bit32
name|disableMDF
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_DM
name|dmSwConfig_t
modifier|*
name|dmSwConfig
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_SM
name|smSwConfig_t
modifier|*
name|smSwConfig
decl_stmt|;
endif|#
directive|endif
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: tdsaRoot %p tdsaAllShared %p \n"
operator|,
name|tdsaRoot
operator|,
name|tdsaAllShared
operator|)
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|tmpBuffer
expr_stmt|;
name|buffLen
operator|=
sizeof|sizeof
argument_list|(
name|tmpBuffer
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
comment|/* the followings are the default values */
name|SwConfig
operator|=
operator|(
name|agsaSwConfig_t
operator|*
operator|)
operator|&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|)
expr_stmt|;
name|QueueConfig
operator|=
operator|(
name|agsaQueueConfig_t
operator|*
operator|)
operator|&
operator|(
name|tdsaAllShared
operator|->
name|QueueConfig
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|dmSwConfig
operator|=
operator|(
name|dmSwConfig_t
operator|*
operator|)
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmSwConfig
operator|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_SM
name|smSwConfig
operator|=
operator|(
name|smSwConfig_t
operator|*
operator|)
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smSwConfig
operator|)
expr_stmt|;
endif|#
directive|endif
comment|/*     just default values     and are overwritten later by the configuration file contents   */
name|SwConfig
operator|->
name|numDevHandles
operator|=
name|DEFAULT_MAX_DEV
expr_stmt|;
name|SwConfig
operator|->
name|maxActiveIOs
operator|=
name|DEFAULT_MAX_ACTIVE_IOS
expr_stmt|;
name|SwConfig
operator|->
name|smpReqTimeout
operator|=
name|DEFAULT_SMP_TIMEOUT
expr_stmt|;
comment|/* DEFAULT_VALUE; */
name|SwConfig
operator|->
name|numberOfEventRegClients
operator|=
name|DEFAULT_NUM_REG_CLIENTS
expr_stmt|;
name|SwConfig
operator|->
name|sizefEventLog1
operator|=
name|HOST_EVENT_LOG_SIZE
expr_stmt|;
name|SwConfig
operator|->
name|sizefEventLog2
operator|=
name|HOST_EVENT_LOG_SIZE
expr_stmt|;
name|SwConfig
operator|->
name|eventLog1Option
operator|=
name|DEFAULT_EVENT_LOG_OPTION
expr_stmt|;
name|SwConfig
operator|->
name|eventLog2Option
operator|=
name|DEFAULT_EVENT_LOG_OPTION
expr_stmt|;
name|SwConfig
operator|->
name|fatalErrorInterruptEnable
operator|=
literal|1
expr_stmt|;
name|SwConfig
operator|->
name|fatalErrorInterruptVector
operator|=
literal|0
expr_stmt|;
comment|/* Was 1 */
name|SwConfig
operator|->
name|hostDirectAccessSupport
operator|=
literal|0
expr_stmt|;
name|SwConfig
operator|->
name|hostDirectAccessMode
operator|=
literal|0
expr_stmt|;
name|SwConfig
operator|->
name|FWConfig
operator|=
literal|0
expr_stmt|;
name|SwConfig
operator|->
name|enableDIF
operator|=
name|agFALSE
expr_stmt|;
name|SwConfig
operator|->
name|enableEncryption
operator|=
name|agFALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_CONFIG_MDFD_REGISTRY
name|SwConfig
operator|->
name|disableMDF
operator|=
name|agFALSE
expr_stmt|;
endif|#
directive|endif
name|SwConfig
operator|->
name|param1
operator|=
name|tdsaAllShared
operator|->
name|tdDeviceIdVendId
expr_stmt|;
name|SwConfig
operator|->
name|param2
operator|=
name|tdsaAllShared
operator|->
name|tdSubVendorId
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SwConfig
operator|->
name|sallDebugLevel
operator|=
literal|1
expr_stmt|;
comment|/* DEFAULT_VALUE; */
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|DM_DEBUG
argument_list|)
name|dmSwConfig
operator|->
name|DMDebugLevel
operator|=
literal|1
expr_stmt|;
comment|/* DEFAULT_VALUE; */
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|SM_DEBUG
argument_list|)
name|smSwConfig
operator|->
name|SMDebugLevel
operator|=
literal|1
expr_stmt|;
comment|/* DEFAULT_VALUE; */
endif|#
directive|endif
name|tdsaAllShared
operator|->
name|portTMO
operator|=
name|PORT_RECOVERY_TIMEOUT
expr_stmt|;
comment|/* default 5 sec */
name|tdsaAllShared
operator|->
name|stp_idle_time
operator|=
name|STP_IDLE_TIME
expr_stmt|;
comment|/* default 5 us */
name|tdsaAllShared
operator|->
name|itNexusTimeout
operator|=
name|IT_NEXUS_TIMEOUT
expr_stmt|;
comment|/* default 2000 ms */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|iniParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"MaxTargets"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|numDevHandles
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|numDevHandles
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: MaxTargets  %d\n"
operator|,
name|SwConfig
operator|->
name|numDevHandles
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*    * read the NumInboundQueue parameter    */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|QueueConfig
operator|->
name|numInboundQueues
operator|=
name|DEFAULT_NUM_INBOUND_QUEUE
expr_stmt|;
comment|/* default 1 Inbound queue */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"NumInboundQueues"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|QueueConfig
operator|->
name|numInboundQueues
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|QueueConfig
operator|->
name|numInboundQueues
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|QueueConfig
operator|->
name|numInboundQueues
operator|>
name|AGSA_MAX_INBOUND_Q
condition|)
block|{
name|QueueConfig
operator|->
name|numInboundQueues
operator|=
name|AGSA_MAX_INBOUND_Q
expr_stmt|;
block|}
block|}
comment|/*    * read the NumOutboundQueue parameter    */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|QueueConfig
operator|->
name|numOutboundQueues
operator|=
name|DEFAULT_NUM_OUTBOUND_QUEUE
expr_stmt|;
comment|/* default 1 Outbound queue */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"NumOutboundQueues"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|QueueConfig
operator|->
name|numOutboundQueues
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|QueueConfig
operator|->
name|numOutboundQueues
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|QueueConfig
operator|->
name|numOutboundQueues
operator|>
name|AGSA_MAX_OUTBOUND_Q
condition|)
block|{
name|QueueConfig
operator|->
name|numOutboundQueues
operator|=
name|AGSA_MAX_OUTBOUND_Q
expr_stmt|;
block|}
block|}
comment|/*    * read the outbound queue option    */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|QueueOption
operator|=
name|DEFAULT_QUEUE_OPTION
expr_stmt|;
comment|/* default 0 Outbound queue element */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"QueueOption"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|QueueOption
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|QueueOption
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*    * read the MaxActiveIO parameter    */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"MaxActiveIO"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|maxActiveIOs
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: maxactiveio 1 !!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|maxActiveIOs
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: maxactiveio 2 !!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: maxactiveio 3 !!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*    * read the SMPTO parameter (SMP Timeout)    */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SMPTO"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|smpReqTimeout
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|smpReqTimeout
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*    * read the NumRegClients parameter (SMP Timeout)    */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"NumRegClients"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|numberOfEventRegClients
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|numberOfEventRegClients
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"LLDebugLevel"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|sallDebugLevel
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|sallDebugLevel
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|DM_DEBUG
argument_list|)
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"DMDebugLevel"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dmSwConfig
operator|->
name|DMDebugLevel
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dmSwConfig
operator|->
name|DMDebugLevel
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|SM_DEBUG
argument_list|)
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SMDebugLevel"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|smSwConfig
operator|->
name|SMDebugLevel
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smSwConfig
operator|->
name|SMDebugLevel
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QueueConfig
operator|->
name|numInboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|osti_sprintf
argument_list|(
name|IBQueueSize
argument_list|,
literal|"IBQueueNumElements%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|IBQueueEleSize
argument_list|,
literal|"IBQueueElementSize%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|IBQueuePriority
argument_list|,
literal|"IBQueuePriority%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/*      * read the IBQueueSize      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|InboundQueueSize
index|[
name|i
index|]
operator|=
name|DEFAULT_INBOUND_QUEUE_SIZE
expr_stmt|;
comment|/* default 256 Inbound queue size */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|IBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|IBQueueSize
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|InboundQueueSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|InboundQueueSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d IB queue size %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|InboundQueueSize
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the IBQueueEleSize      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|InboundQueueEleSize
index|[
name|i
index|]
operator|=
name|DEFAULT_INBOUND_QUEUE_ELE_SIZE
expr_stmt|;
comment|/* default 128 Inbound queue element */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|IBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|IBQueueEleSize
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|InboundQueueEleSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|InboundQueueEleSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d IB queue ele size %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|InboundQueueEleSize
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the IBQueuePriority      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|InboundQueuePriority
index|[
name|i
index|]
operator|=
name|DEFAULT_INBOUND_QUEUE_PRIORITY
expr_stmt|;
comment|/* default 0 Inbound queue priority */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|IBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|IBQueuePriority
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|InboundQueuePriority
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|InboundQueuePriority
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d priority %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|InboundQueuePriority
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**********************************************/
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
comment|/* end of loop */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QueueConfig
operator|->
name|numOutboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|osti_sprintf
argument_list|(
name|OBQueueSize
argument_list|,
literal|"OBQueueNumElements%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|OBQueueEleSize
argument_list|,
literal|"OBQueueElementSize%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|OBQueueInterruptDelay
argument_list|,
literal|"OBQueueInterruptDelay%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|OBQueueInterruptCount
argument_list|,
literal|"OBQueueInterruptCount%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|OBQueueInterruptEnable
argument_list|,
literal|"OBQueueInterruptEnable%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/*      * read the OBQueueSize      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|OutboundQueueSize
index|[
name|i
index|]
operator|=
name|DEFAULT_OUTBOUND_QUEUE_SIZE
expr_stmt|;
comment|/* default 256 Outbound queue size */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|OBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|OBQueueSize
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d OB queue size %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueSize
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the OBQueueEleSize      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|OutboundQueueEleSize
index|[
name|i
index|]
operator|=
name|DEFAULT_OUTBOUND_QUEUE_ELE_SIZE
expr_stmt|;
comment|/* default 128 Outbound queue element */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|OBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|OBQueueEleSize
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueEleSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueEleSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d OB queue ele size %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueEleSize
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the OBQueueInterruptDelay      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptDelay
index|[
name|i
index|]
operator|=
name|DEFAULT_OUTBOUND_QUEUE_INTERRUPT_DELAY
expr_stmt|;
comment|/* default 1 Outbound interrupt delay */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|OBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|OBQueueInterruptDelay
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptDelay
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptDelay
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d interrupt delay %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptDelay
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the OBQueueInterruptCount      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptCount
index|[
name|i
index|]
operator|=
name|DEFAULT_OUTBOUND_QUEUE_INTERRUPT_COUNT
expr_stmt|;
comment|/* default 1 Outbound interrupt count */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|OBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|OBQueueInterruptCount
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptCount
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptCount
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d interrupt count %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptCount
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the OBQueueInterruptEnable      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptEnable
index|[
name|i
index|]
operator|=
name|DEFAULT_OUTBOUND_INTERRUPT_ENABLE
expr_stmt|;
comment|/* default 1 Outbound interrupt is enabled */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|OBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|OBQueueInterruptEnable
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptEnable
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptEnable
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d interrupt enable %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptEnable
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**********************************************/
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
comment|/* end of loop */
comment|/********************READ CARD SPECIFIC *******************************************************/
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QueueConfig
operator|->
name|numInboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|osti_sprintf
argument_list|(
name|IBQueueSize
argument_list|,
literal|"IBQueueNumElements%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|IBQueueEleSize
argument_list|,
literal|"IBQueueElementSize%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|IBQueuePriority
argument_list|,
literal|"IBQueuePriority%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/*      * read the IBQueueSize      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|cardNum
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|IBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|IBQueueSize
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|InboundQueueSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|InboundQueueSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d IB queue size %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|InboundQueueSize
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the IBQueueEleSize      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|cardNum
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|IBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|IBQueueEleSize
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|InboundQueueEleSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|InboundQueueEleSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d IB queue ele size %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|InboundQueueEleSize
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the IBQueuePriority      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|cardNum
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|IBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|IBQueuePriority
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|InboundQueuePriority
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|InboundQueuePriority
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: card number %s queue number %d priority %d\n"
operator|,
name|cardNum
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|InboundQueuePriority
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**********************************************/
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
comment|/* end of loop */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QueueConfig
operator|->
name|numOutboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|osti_sprintf
argument_list|(
name|OBQueueSize
argument_list|,
literal|"OBQueueNumElements%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|OBQueueEleSize
argument_list|,
literal|"OBQueueElementSize%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|OBQueueInterruptDelay
argument_list|,
literal|"OBQueueInterruptDelay%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|OBQueueInterruptCount
argument_list|,
literal|"OBQueueInterruptCount%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osti_sprintf
argument_list|(
name|OBQueueInterruptEnable
argument_list|,
literal|"OBQueueInterruptEnable%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/*      * read the OBQueueSize      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|cardNum
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|OBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|OBQueueSize
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d OB queue size %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueSize
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the OBQueueEleSize      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|cardNum
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|OBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|OBQueueEleSize
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueEleSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueEleSize
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: queue number %d OB queue ele size %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueEleSize
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the OBQueueInterruptDelay      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|cardNum
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|OBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|OBQueueInterruptDelay
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptDelay
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptDelay
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: card number %s queue number %d interrupt delay %d\n"
operator|,
name|cardNum
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptDelay
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the OBQueueInterruptCount      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|cardNum
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|OBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|OBQueueInterruptCount
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptCount
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptCount
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: card number %s queue number %d interrupt count %d\n"
operator|,
name|cardNum
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptCount
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * read the OBQueueInterruptEnable      */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|cardNum
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|OBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|OBQueueInterruptEnable
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptEnable
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptEnable
index|[
name|i
index|]
operator|=
operator|(
name|bit16
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: card number %s queue number %d interrupt enable %d\n"
operator|,
name|cardNum
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptEnable
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**********************************************/
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
comment|/* end of loop */
comment|/* process event log related parameters */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"EventLogSize1"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|sizefEventLog1
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|sizefEventLog1
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"EventLogOption1"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|eventLog1Option
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|eventLog1Option
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"EventLogSize2"
argument_list|,
comment|/* valueName */
comment|/* IOP size in K dWords   */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|sizefEventLog2
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|sizefEventLog2
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"EventLogOption2"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|eventLog2Option
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|eventLog2Option
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* end of event log related parameters */
comment|/*     HDA parameters   */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"HDASupport"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|hostDirectAccessSupport
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|hostDirectAccessSupport
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"HDAMode"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|hostDirectAccessMode
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|hostDirectAccessMode
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* the end of HDA parameters */
comment|/* FW configuration */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"FWConfig"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|FWConfig
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|FWConfig
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* The end of FW configuration */
comment|/* IQ Normal priority and High priority */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|IBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"IQNQDepth"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|QueueConfig
operator|->
name|iqNormalPriorityProcessingDepth
operator|=
operator|(
name|bit8
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|QueueConfig
operator|->
name|iqNormalPriorityProcessingDepth
operator|=
operator|(
name|bit8
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|IBQueueProps
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"IQHQDepth"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|QueueConfig
operator|->
name|iqHighPriorityProcessingDepth
operator|=
operator|(
name|bit8
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|QueueConfig
operator|->
name|iqHighPriorityProcessingDepth
operator|=
operator|(
name|bit8
operator|)
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* End IQ Normal priority and High priority */
comment|/* Start port timeout value */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"PortTMO"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|portTMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|portTMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* End port timeout value */
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"TraceDestination"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|TraceDestination
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|TraceDestination
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: SwConfig->TraceDestination %d\n"
operator|,
name|SwConfig
operator|->
name|TraceDestination
operator|)
argument_list|)
expr_stmt|;
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"TraceMask"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|TraceMask
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|TraceMask
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: SwConfig->TraceMask %d %X\n"
operator|,
name|SwConfig
operator|->
name|TraceMask
operator|,
name|SwConfig
operator|->
name|TraceMask
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/*# SA_ENABLE_TRACE_FUNCTIONS */
ifdef|#
directive|ifdef
name|AGTIAPI_CTL
comment|/*    * read the SAS Connection Time Limit parameter    */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|SASConnectTimeLimit
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SASCTL"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|tdsaAllShared
operator|->
name|SASConnectTimeLimit
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|tdsaAllShared
operator|->
name|SASConnectTimeLimit
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* Start FCA value */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|FCA
operator|=
literal|1
expr_stmt|;
comment|/* No FCA by default */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
literal|"InitiatorParms"
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"FCA"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|FCA
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|FCA
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* End FCA value */
comment|/* Start ResetInDiscovery value */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|=
literal|0
expr_stmt|;
comment|/* No ResetInDiscovery by default */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
literal|"InitiatorParms"
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"ResetInDiscovery"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* End ResetInDiscovery value */
comment|/* Start MCN value */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|MCN
operator|=
literal|1
expr_stmt|;
comment|/* default MCN */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"MCN"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|MCN
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|MCN
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: MCN %d\n"
operator|,
name|tdsaAllShared
operator|->
name|MCN
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End MCN value */
comment|/* Start sflag value */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|sflag
operator|=
literal|0
expr_stmt|;
comment|/* default sflag */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"Sflag"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|sflag
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|sflag
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: sflag %d\n"
operator|,
name|tdsaAllShared
operator|->
name|sflag
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End sflag value */
comment|/* Start enable DIF */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"enableDIF"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|enableDIF
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|enableDIF
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: enableDIF %d\n"
operator|,
name|enableDIF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|enableDIF
condition|)
block|{
name|SwConfig
operator|->
name|enableDIF
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|enableDIF
operator|=
name|agFALSE
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: SwConfig->enableDIF %d\n"
operator|,
name|SwConfig
operator|->
name|enableDIF
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End enable DIF */
comment|/* Start enable Encryption */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"enableEncryption"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|enableEncryption
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|enableEncryption
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: enableEncryption %d\n"
operator|,
name|enableEncryption
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|enableEncryption
condition|)
block|{
name|SwConfig
operator|->
name|enableEncryption
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|enableEncryption
operator|=
name|agFALSE
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: SwConfig->enableEncryption %d\n"
operator|,
name|SwConfig
operator|->
name|enableEncryption
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End enable Encryption */
comment|/* Start allow connection rate change */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|RateAdjust
operator|=
literal|0
expr_stmt|;
comment|/* No rate adjust by default */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"RateAdjust"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|RateAdjust
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|RateAdjust
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: tdsaAllShared->RateAdjust %d\n"
operator|,
name|tdsaAllShared
operator|->
name|RateAdjust
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End allow connection rate change */
ifdef|#
directive|ifdef
name|SA_CONFIG_MDFD_REGISTRY
comment|/* Start disable MDF */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"disableMDF"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|disableMDF
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|disableMDF
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: disableMDF %d\n"
operator|,
name|disableMDF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|disableMDF
condition|)
block|{
name|SwConfig
operator|->
name|disableMDF
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|disableMDF
operator|=
name|agFALSE
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: SwConfig->disableMDF %d\n"
operator|,
name|SwConfig
operator|->
name|disableMDF
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End disable MDF */
endif|#
directive|endif
comment|/*SA_CONFIG_MDFD_REGISTRY*/
comment|/* Start IT_NEXUS_TIMEOUT */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"IT_NEXUS_TIMEOUT"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|itNexusTimeout
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|itNexusTimeout
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: tdsaAllShared->itNexusTimeout %d\n"
operator|,
name|tdsaAllShared
operator|->
name|itNexusTimeout
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End IT_NEXUS_TIMEOUT */
comment|/* Start stp idle time */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"STPIdleTime"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|stp_idle_time
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|stp_idle_time
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: STPIdleTime %d\n"
operator|,
name|tdsaAllShared
operator|->
name|stp_idle_time
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End stp idle time */
comment|/* Start STP_MCT_TMO */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|STP_MCT_TMO
operator|=
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_STP_MCT_TMO"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|STP_MCT_TMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|STP_MCT_TMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: STP_MCT_TMO %d\n"
operator|,
name|tdsaAllShared
operator|->
name|STP_MCT_TMO
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  STP_MCT_TMO */
comment|/* Start SSP_MCT_TMO */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|SSP_MCT_TMO
operator|=
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_SSP_MCT_TMO"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|SSP_MCT_TMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|SSP_MCT_TMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: SSP_MCT_TMO %d\n"
operator|,
name|tdsaAllShared
operator|->
name|SSP_MCT_TMO
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  SSP_MCT_TMO */
comment|/* Start MAX_OPEN_TIME */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|MAX_OPEN_TIME
operator|=
literal|5
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_MAX_OPEN_TIME"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|MAX_OPEN_TIME
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|MAX_OPEN_TIME
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: MAX_OPEN_TIME %d\n"
operator|,
name|tdsaAllShared
operator|->
name|MAX_OPEN_TIME
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  MAX_OPEN_TIME */
comment|/* Start SMP_MAX_CONN_TIMER */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|SMP_MAX_CONN_TIMER
operator|=
literal|0xFF
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_SMP_MAX_CONN_TIMER"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|SMP_MAX_CONN_TIMER
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|SMP_MAX_CONN_TIMER
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: SMP_MAX_CONN_TIMER %d\n"
operator|,
name|tdsaAllShared
operator|->
name|SMP_MAX_CONN_TIMER
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  SMP_MAX_CONN_TIMER */
comment|/* Start STP_FRM_TMO */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|STP_FRM_TMO
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_STP_FRM_TMO"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|STP_FRM_TMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|STP_FRM_TMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: STP_FRM_TMO %d\n"
operator|,
name|tdsaAllShared
operator|->
name|STP_FRM_TMO
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  STP_FRM_TMO */
comment|/* Start MFD_OPNRJT_RTRY_INTVL */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|MFD
operator|=
literal|1
expr_stmt|;
comment|/* disabled  by default */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_MFD"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|MFD
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|MFD
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: MFD %d\n"
operator|,
name|tdsaAllShared
operator|->
name|MFD
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  MFD_OPNRJT_RTRY_INTVL */
comment|/* Start MFD_OPNRJT_RTRY_INTVL */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|OPNRJT_RTRY_INTVL
operator|=
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_OPNRJT_RTRY_INTVL"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|OPNRJT_RTRY_INTVL
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|OPNRJT_RTRY_INTVL
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: OPNRJT_RTRY_INTVL %d\n"
operator|,
name|tdsaAllShared
operator|->
name|OPNRJT_RTRY_INTVL
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  MFD_OPNRJT_RTRY_INTVL */
comment|/* Start DOPNRJT_RTRY_TMO */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|DOPNRJT_RTRY_TMO
operator|=
literal|128
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_DOPNRJT_RTRY_TMO"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|DOPNRJT_RTRY_TMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|DOPNRJT_RTRY_TMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: DOPNRJT_RTRY_TMO %d\n"
operator|,
name|tdsaAllShared
operator|->
name|DOPNRJT_RTRY_TMO
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  DOPNRJT_RTRY_TMO */
comment|/* Start COPNRJT_RTRY_TMO */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|//  tdsaAllShared->COPNRJT_RTRY_TMO = 32;
name|tdsaAllShared
operator|->
name|COPNRJT_RTRY_TMO
operator|=
literal|128
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_COPNRJT_RTRY_TMO"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|COPNRJT_RTRY_TMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|COPNRJT_RTRY_TMO
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: COPNRJT_RTRY_TMO %d\n"
operator|,
name|tdsaAllShared
operator|->
name|COPNRJT_RTRY_TMO
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  COPNRJT_RTRY_TMO */
comment|/* Start DOPNRJT_RTRY_THR */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|//  tdsaAllShared->DOPNRJT_RTRY_THR = 16; /* FW default */
comment|/*     Making ORR bigger than IT NEXUS LOSS which is 2000000us = 2 second.     Assuming a bigger value 3 second, 3000000/128 = 23437.5 where 128 is tdsaAllShared->DOPNRJT_RTRY_TMO   */
name|tdsaAllShared
operator|->
name|DOPNRJT_RTRY_THR
operator|=
literal|23438
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_DOPNRJT_RTRY_THR"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|DOPNRJT_RTRY_THR
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|DOPNRJT_RTRY_THR
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: DOPNRJT_RTRY_THR %d\n"
operator|,
name|tdsaAllShared
operator|->
name|DOPNRJT_RTRY_THR
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  DOPNRJT_RTRY_THR */
comment|/* Start COPNRJT_RTRY_THR */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|//  tdsaAllShared->COPNRJT_RTRY_THR = 1024; /* FW default */
comment|/*     Making ORR bigger than IT NEXUS LOSS which is 2000000us = 2 second.     Assuming a bigger value 3 second, 3000000/128 =  23437.5 where 128 is tdsaAllShared->COPNRJT_RTRY_TMO   */
name|tdsaAllShared
operator|->
name|COPNRJT_RTRY_THR
operator|=
literal|23438
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_COPNRJT_RTRY_THR"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|COPNRJT_RTRY_THR
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|COPNRJT_RTRY_THR
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: COPNRJT_RTRY_THR %d\n"
operator|,
name|tdsaAllShared
operator|->
name|COPNRJT_RTRY_THR
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  COPNRJT_RTRY_THR */
comment|/* Start MAX_AIP */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|MAX_AIP
operator|=
literal|0x200000
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"SAS_MAX_AIP"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|MAX_AIP
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|MAX_AIP
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: MAX_AIP %d\n"
operator|,
name|tdsaAllShared
operator|->
name|MAX_AIP
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* End  MAX_AIP */
comment|/***********************************************************************/
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/*     typedef struct agsaMPIContext_s     {       bit32   MPITableType;       bit32   offset;       bit32   value;     } agsaMPIContext_t;     */
block|{
name|bit32
name|MpiContextvalue
init|=
literal|0
decl_stmt|;
name|SwConfig
operator|->
name|mpiContextTable
operator|=
name|agNULL
expr_stmt|;
name|SwConfig
operator|->
name|mpiContextTablelen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"MpiContext"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|MpiContextvalue
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|MpiContextvalue
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|MpiContextvalue
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|mpiContextTable
operator|=
name|agNULL
expr_stmt|;
name|SwConfig
operator|->
name|mpiContextTablelen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|tdsaRoot
condition|)
block|{
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|MPITableType
operator|=
literal|0xFF
expr_stmt|;
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|value
operator|=
literal|0
expr_stmt|;
name|SwConfig
operator|->
name|mpiContextTable
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|)
expr_stmt|;
name|SwConfig
operator|->
name|mpiContextTablelen
operator|=
sizeof|sizeof
argument_list|(
name|agsaMPIContext_t
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: MpiContext %p Len %d\n"
operator|,
name|SwConfig
operator|->
name|mpiContextTable
operator|,
name|SwConfig
operator|->
name|mpiContextTablelen
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|SwConfig
operator|->
name|mpiContextTable
operator|!=
name|agNULL
condition|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|tdsaRoot
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"MpiTableType"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|MPITableType
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|MPITableType
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: MpiOverride.MPITableType  0x%X\n"
operator|,
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|MPITableType
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"MpiTableOffset"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|offset
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|offset
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: MpiOverride.offset 0x%X\n"
operator|,
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"MpiTableValue"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|value
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|value
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: MpiOverride.value 0x%X\n"
operator|,
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|.
name|MpiOverride
operator|.
name|value
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/***********************************************************************/
ifdef|#
directive|ifdef
name|SA_ENABLE_PCI_TRIGGER
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|SwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"PciTrigger"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SwConfig
operator|->
name|PCI_trigger
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SwConfig
operator|->
name|PCI_trigger
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: PciTrigger %d\n"
operator|,
name|SwConfig
operator|->
name|PCI_trigger
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SA_ENABLE_PCI_TRIGGER */
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: $$$$$$$$$$$$$$$$$ merge $$$$$$$$$$$$$\n"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: SwConfig->sallDebugLevel %d\n"
operator|,
name|SwConfig
operator|->
name|sallDebugLevel
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SA_ENABLE_PCI_TRIGGER
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaGetSwConfigParams: SwConfig->PCI_trigger  0x%x   0x%x\n"
operator|,
name|SwConfig
operator|->
name|PCI_trigger
operator|,
name|tdsaRoot
operator|->
name|itdsaIni
operator|->
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|PCI_trigger
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_ENABLE_PCI_TRIGGER */
ifdef|#
directive|ifdef
name|AGTIAPI_CTL
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaLoLevelGetResource: SASConnectTimeLimit 0x%x\n"
operator|,
name|tdsaAllShared
operator|->
name|SASConnectTimeLimit
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaParseLinkRateMode * *  Purpose:  This function parses link rate and mode. * *  \param   LinkRate: Link rate specified by user. *  \param   Mode: Link rate specified by user. * *  \return: *           Value combined with Linkrate and Mode * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaParseLinkRateMode
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|index
parameter_list|,
name|bit32
name|LinkRateRead
parameter_list|,
name|bit32
name|ModeRead
parameter_list|,
name|bit32
name|OpticalModeRead
parameter_list|,
name|bit32
name|LinkRate
parameter_list|,
name|bit32
name|Mode
parameter_list|,
name|bit32
name|OpticalMode
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: index 0x%X\n"
operator|,
name|index
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: LinkRateRead 0x%X    LinkRate 0x%X\n"
operator|,
name|LinkRateRead
operator|,
name|LinkRate
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: ModeRead 0x%X        Mode 0x%X\n"
operator|,
name|ModeRead
operator|,
name|Mode
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: OpticalModeRead 0x%X OpticalMode 0x%X\n"
operator|,
name|OpticalModeRead
operator|,
name|OpticalMode
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|LinkRateRead
operator|==
name|agTRUE
condition|)
block|{
comment|/* link rate */
if|if
condition|(
name|LinkRate
operator|&
literal|0x1
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
literal|0x1
expr_stmt|;
block|}
if|if
condition|(
name|LinkRate
operator|&
literal|0x2
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
literal|0x2
expr_stmt|;
block|}
if|if
condition|(
name|LinkRate
operator|&
literal|0x4
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
literal|0x4
expr_stmt|;
block|}
if|if
condition|(
name|LinkRate
operator|&
literal|0x8
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
literal|0x8
expr_stmt|;
block|}
if|if
condition|(
name|LinkRate
operator|==
literal|0
operator|||
name|LinkRate
operator|>
literal|0xF
condition|)
block|{
comment|/* not allowed, set the rate to default 1.5 G */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
literal|0x1
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode:  LinkRate == 0 || LinkRate>= 0x%x\n"
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode:A index 0x%x LinkRate 0x%x Mode 0x%x\n"
operator|,
name|index
operator|,
name|LinkRate
operator|,
name|Mode
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ModeRead
operator|==
name|agTRUE
condition|)
block|{
comment|/* mode */
if|if
condition|(
name|Mode
operator|&
literal|0x1
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
literal|0x10
expr_stmt|;
block|}
if|if
condition|(
name|Mode
operator|&
literal|0x2
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
literal|0x20
expr_stmt|;
block|}
if|if
condition|(
name|Mode
operator|==
literal|0
operator|||
name|Mode
operator|>=
literal|4
condition|)
block|{
comment|/* not allowed, set the mode to default SAS/SATA */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|&
literal|0xf
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
literal|0x30
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode:1 index 0x%x Mode 0x%x\n"
operator|,
name|index
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|OpticalModeRead
operator|==
name|agTRUE
condition|)
block|{
comment|/* setting bit20 */
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
name|tdsaAllShared
operator|->
name|agRootInt
decl_stmt|;
if|if
condition|(
name|OpticalMode
operator|==
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: OpticalMode 0  phy %d phyProperties 0x%x\n"
operator|,
name|index
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|OpticalMode
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|tIsSPCV12or6G
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: OpticalMode 1  phy %d phyProperties 0x%x\n"
operator|,
name|index
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
operator|(
literal|1
operator|<<
literal|22
operator|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|&=
literal|0xFFFFFFF0
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||=
literal|0x4
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|OpticalMode
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|tIsSPCV12or6G
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: OpticalMode 2  phy %d phyProperties 0x%x\n"
operator|,
name|index
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
operator|(
literal|1
operator|<<
literal|20
operator|)
expr_stmt|;
block|}
else|else
block|{
name|TD_ASSERT
argument_list|(
literal|0
argument_list|,
literal|"SPC optical mode 2"
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: OpticalMode %d phy %d phyProperties 0x%x\n"
operator|,
name|OpticalMode
operator|,
name|index
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: OpticalMode unknown %d  phy %d phyProperties 0x%x\n"
operator|,
name|OpticalMode
operator|,
name|index
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: OpticalMode off phy %d phyProperties 0x%x\n"
operator|,
name|index
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaParseLinkRateMode: phy %d phyProperties 0x%x\n"
operator|,
name|index
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|index
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdsaGetHwConfigParams * *  Purpose:  This function reads hardware configuration parameters from the *            configuration file * *  \param  tiRoot:            Pointer to driver/port instance. * *  \return: None * *  \note - * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaGetHwConfigParams
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|agsaHwConfig_t
modifier|*
name|HwConfig
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|bit32
name|buffLen
decl_stmt|;
name|bit32
name|lenRecv
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pLastUsedChar
init|=
name|agNULL
decl_stmt|;
name|char
name|tmpBuffer
index|[
name|DEFAULT_KEY_BUFFER_SIZE
index|]
decl_stmt|;
name|char
name|globalStr
index|[]
init|=
literal|"Global"
decl_stmt|;
name|char
name|HwParmsStr
index|[]
init|=
literal|"HWParms"
decl_stmt|;
name|char
name|phyReg
index|[
literal|10
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|agsaPhyAnalogSetupTable_t
modifier|*
name|phyRegTable
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetHwConfigParams: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetHwConfigParams: tdsaRoot %p tdsaAllShared %p \n"
operator|,
name|tdsaRoot
operator|,
name|tdsaAllShared
operator|)
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|tmpBuffer
expr_stmt|;
name|buffLen
operator|=
sizeof|sizeof
argument_list|(
name|tmpBuffer
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|HwConfig
operator|=
operator|(
name|agsaHwConfig_t
operator|*
operator|)
operator|&
operator|(
name|tdsaAllShared
operator|->
name|HwConfig
operator|)
expr_stmt|;
name|phyRegTable
operator|=
operator|(
name|agsaPhyAnalogSetupTable_t
operator|*
operator|)
operator|&
operator|(
name|HwConfig
operator|->
name|phyAnalogConfig
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
name|HwConfig
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHwConfig_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*     just default values     and are overwritten later by the configuration file contents     turning off hw control interrupt coalescing   */
name|tdsaAllShared
operator|->
name|FWMaxPorts
operator|=
name|DEFAULT_FW_MAX_PORTS
expr_stmt|;
comment|/* 8, applicable only to SPC not to SPCv */
name|HwConfig
operator|->
name|phyCount
operator|=
name|TD_MAX_NUM_PHYS
expr_stmt|;
name|HwConfig
operator|->
name|hwInterruptCoalescingTimer
operator|=
literal|1
expr_stmt|;
name|HwConfig
operator|->
name|hwInterruptCoalescingControl
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|phyCalibration
operator|=
literal|0
expr_stmt|;
name|HwConfig
operator|->
name|hwOption
operator|=
literal|0
expr_stmt|;
comment|/* default: PI/CI addresses are 32-bit */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"HwIntCoalTimer"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|HwConfig
operator|->
name|hwInterruptCoalescingTimer
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HwConfig
operator|->
name|hwInterruptCoalescingTimer
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"HwIntCoalControl"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|HwConfig
operator|->
name|hwInterruptCoalescingControl
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HwConfig
operator|->
name|hwInterruptCoalescingControl
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* For hwInterruptCoalescingTimer, 0 disables interrrupt, not allowed */
if|if
condition|(
name|HwConfig
operator|->
name|hwInterruptCoalescingControl
operator|==
literal|1
operator|&&
name|HwConfig
operator|->
name|hwInterruptCoalescingTimer
operator|==
literal|0
condition|)
block|{
name|HwConfig
operator|->
name|hwInterruptCoalescingTimer
operator|=
literal|1
expr_stmt|;
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/* interrupt reassetion field*/
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"IntReassertionOpt"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|HwConfig
operator|->
name|intReassertionOption
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HwConfig
operator|->
name|intReassertionOption
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/* interrupt reassetion field*/
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"HwOption"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|HwConfig
operator|->
name|hwOption
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HwConfig
operator|->
name|hwOption
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/* interrupt reassetion field*/
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"MaxFWPorts"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|FWMaxPorts
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|FWMaxPorts
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
literal|"phyCalibration"
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|phyCalibration
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|phyCalibration
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/* phy calibration */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_INDEX
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|10
condition|;
name|j
operator|++
control|)
block|{
name|osti_sprintf
argument_list|(
name|phyReg
argument_list|,
literal|"spaReg%d%d"
argument_list|,
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetHwConfigParams: phyReg %s\n"
operator|,
name|phyReg
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|phyReg
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister0
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister0
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|j
operator|==
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|phyReg
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister1
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister1
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|j
operator|==
literal|2
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|phyReg
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister2
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister2
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|j
operator|==
literal|3
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|phyReg
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister3
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister3
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|j
operator|==
literal|4
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|phyReg
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister4
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister4
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|j
operator|==
literal|5
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|phyReg
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister5
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister5
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|j
operator|==
literal|6
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|phyReg
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister6
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister6
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|j
operator|==
literal|7
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|phyReg
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister7
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister7
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|j
operator|==
literal|8
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|phyReg
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister8
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister8
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|j
operator|==
literal|9
condition|)
block|{
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
comment|/* key */
name|HwParmsStr
argument_list|,
comment|/* subkey1 */
name|agNULL
argument_list|,
comment|/* subkey2 */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
comment|/* subkey5 */
name|phyReg
argument_list|,
comment|/* valueName */
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister9
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|phyRegTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
operator|.
name|spaRegister9
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* inner loop */
block|}
comment|/* outer loop */
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdsaGetCardPhyParams * *  Purpose:  This function reads phy-related configuration parameters from the *            configuration file * *  \param  tiRoot:            Pointer to driver/port instance. * *  \return: None * *  \note - just a place holder for now * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaGetCardPhyParams
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
name|tdsaAllShared
operator|->
name|agRootInt
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|bit32
name|buffLen
decl_stmt|;
name|bit32
name|lenRecv
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pLastUsedChar
init|=
name|agNULL
decl_stmt|;
name|char
name|tmpBuffer
index|[
name|DEFAULT_KEY_BUFFER_SIZE
index|]
decl_stmt|;
name|char
modifier|*
name|globalStr
init|=
name|tdsaAllShared
operator|->
name|CardIDString
decl_stmt|;
name|char
name|phyParmsStr
index|[
literal|12
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|bit32
name|LinkRate
init|=
literal|15
decl_stmt|,
name|Mode
init|=
literal|3
decl_stmt|,
name|OpticalMode
init|=
literal|0
decl_stmt|;
comment|//VG
name|bit32
name|LinkRateRead
init|=
name|agTRUE
decl_stmt|,
name|ModeRead
init|=
name|agFALSE
decl_stmt|,
name|OpticalModeRead
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|flag
init|=
name|agFALSE
decl_stmt|;
comment|/* true only for PM8008 or PM8009 (SPCv and SPCve) controller */
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: start \n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: tdsaRoot %p tdsaAllShared %p \n"
operator|,
name|tdsaRoot
operator|,
name|tdsaAllShared
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiIS_8PHY
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: SPCv or SPCve \n"
operator|)
argument_list|)
expr_stmt|;
name|flag
operator|=
name|agTRUE
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: flag %d\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
ifdef|#
directive|ifdef
name|FPGA_CARD
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
comment|/* setting default phy properties */
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x05060708
argument_list|)
expr_stmt|;
comment|/* 1.5G only, SAS/SATA, no spin-up control */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
literal|0x31
expr_stmt|;
comment|/* 49 */
block|}
else|#
directive|else
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* ASIC */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
comment|/* setting default phy properties */
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x05060708
argument_list|)
expr_stmt|;
comment|/* 1.5G/3G , SAS/SATA, no spin-up control */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
literal|0x37
expr_stmt|;
comment|/* 55 */
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d hi 0x%x lo 0x%x\n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
comment|/* ASIC */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
comment|/* setting default phy properties */
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x05050500
operator|+
name|i
argument_list|)
expr_stmt|;
comment|/* 1.5G/3G , SAS/SATA, no spin-up control */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
literal|0x37
expr_stmt|;
comment|/* 55 */
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d hi 0x%x lo 0x%x\n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
endif|#
directive|endif
comment|/* REMOVED */
name|buffer
operator|=
name|tmpBuffer
expr_stmt|;
name|buffLen
operator|=
sizeof|sizeof
argument_list|(
name|tmpBuffer
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|flag
operator|==
name|agFALSE
condition|)
block|{
name|osti_sprintf
argument_list|(
name|phyParmsStr
argument_list|,
literal|"PhyParms%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|i
operator|>=
literal|4
condition|)
block|{
name|osti_sprintf
argument_list|(
name|phyParmsStr
argument_list|,
literal|"PhyParms%d"
argument_list|,
name|i
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|osti_sprintf
argument_list|(
name|phyParmsStr
argument_list|,
literal|"PhyParms%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: i %d PhyParms %s\n"
operator|,
name|i
operator|,
name|phyParmsStr
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d phyProperties %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|phyParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"AddrHi"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d hi 0x%x \n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d hi %d \n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|phyParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"AddrLow"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d lo 0x%x\n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d lo %d\n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: loop phy %d hi 0x%x lo 0x%x\n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* phy properties */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/*     if ((ostiGetTransportParam (                                 tiRoot,                                 globalStr,                                 phyParmsStr,                                 agNULL,                                 agNULL,                                 agNULL,                                 agNULL,                                 "LinkRate",                                 buffer,                                 buffLen,&lenRecv                                 ) == tiSuccess)&& (lenRecv != 0))     {       LinkRateRead = agTRUE;       if (osti_strncmp(buffer, "0x", 2) == 0)       {         LinkRate = osti_strtoul(buffer,&pLastUsedChar, 0);         TI_DBG6(("tdsaGetCardPhyParams: phy %d linkrate 0x%x \n", i, LinkRate));       }       else       {         LinkRate = osti_strtoul(buffer,&pLastUsedChar, 10);         TI_DBG6(("tdsaGetCardPhyParams: phy %d linkrate %d \n", i, LinkRate));       }     }      TI_DBG2(("tdsaGetCardPhyParams: phy %d linkrate %d \n", i, LinkRate)); */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|phyParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"Mode"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
name|ModeRead
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|Mode
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d Mode 0x%x \n"
operator|,
name|i
operator|,
name|Mode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Mode
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d Mode %d \n"
operator|,
name|i
operator|,
name|Mode
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|phyParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"OpticalMode"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
name|OpticalModeRead
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OpticalMode
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d OpticalMode 0x%x \n"
operator|,
name|i
operator|,
name|OpticalMode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OpticalMode
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d OpticalMode %d \n"
operator|,
name|i
operator|,
name|OpticalMode
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|tdsaParseLinkRateMode
argument_list|(
name|tiRoot
argument_list|,
name|i
argument_list|,
name|LinkRateRead
argument_list|,
name|ModeRead
argument_list|,
name|OpticalModeRead
argument_list|,
name|LinkRate
argument_list|,
name|Mode
argument_list|,
name|OpticalMode
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetCardPhyParams: phy %d phyProperties %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
comment|/**********************************************/
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|LinkRateRead
operator|=
name|agTRUE
expr_stmt|;
comment|//VG
name|ModeRead
operator|=
name|agFALSE
expr_stmt|;
name|OpticalModeRead
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* end for */
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdsaGetGlobalPhyParams * *  Purpose:  This function reads phy-related configuration parameters from the *            configuration file * *  \param  tiRoot:            Pointer to driver/port instance. * *  \return: None * *  \note - just a place holder for now * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaGetGlobalPhyParams
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
name|tdsaAllShared
operator|->
name|agRootInt
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|bit32
name|buffLen
decl_stmt|;
name|bit32
name|lenRecv
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pLastUsedChar
init|=
name|agNULL
decl_stmt|;
name|char
name|tmpBuffer
index|[
name|DEFAULT_KEY_BUFFER_SIZE
index|]
decl_stmt|;
name|char
name|globalStr
index|[]
init|=
literal|"Global"
decl_stmt|;
name|char
name|phyParmsStr
index|[
literal|12
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|bit32
name|LinkRate
init|=
literal|15
comment|/*7*/
decl_stmt|,
name|Mode
init|=
literal|3
decl_stmt|,
name|OpticalMode
init|=
literal|0
decl_stmt|;
name|bit32
name|LinkRateRead
init|=
name|agFALSE
decl_stmt|,
name|ModeRead
init|=
name|agFALSE
decl_stmt|,
name|OpticalModeRead
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|flag
init|=
name|agFALSE
decl_stmt|;
comment|/* true only for PM8008 or PM8009 (SPCv and SPCve) controller */
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: start \n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: tdsaRoot %p tdsaAllShared %p \n"
operator|,
name|tdsaRoot
operator|,
name|tdsaAllShared
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiIS_8PHY
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: SPCv or SPCve \n"
operator|)
argument_list|)
expr_stmt|;
name|flag
operator|=
name|agTRUE
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: flag %d\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FPGA_CARD
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
comment|/* setting default phy properties */
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x05060708
argument_list|)
expr_stmt|;
comment|/* 1.5G only, SAS/SATA, no spin-up control */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
literal|0x31
expr_stmt|;
comment|/* 49 */
block|}
else|#
directive|else
comment|/* ASIC */
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
comment|/* setting default phy properties */
if|if
condition|(
name|flag
operator|==
name|agFALSE
condition|)
comment|/* SPC or SPCv+ */
block|{
if|if
condition|(
literal|0
operator|<=
name|i
operator|&&
name|i
operator|<=
literal|7
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x05060708
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01010101
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x02020202
argument_list|)
expr_stmt|;
block|}
block|}
else|else
comment|/* SPCv or SPCve */
block|{
if|if
condition|(
literal|0
operator|<=
name|i
operator|&&
name|i
operator|<=
literal|3
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x05060708
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
literal|4
operator|<=
name|i
operator|&&
name|i
operator|<=
literal|7
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x02020202
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* don't care */
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01010101
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x0f0f0f0f
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 1.5G/3G , SAS/SATA, no spin-up control */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
literal|0x31
expr_stmt|;
comment|/* 55 */
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: phy %d hi 0x%x lo 0x%x\n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
comment|/* setting default phy properties */
comment|/* SPC; narrow ports; 8 ports        SPCv, SPCve wide port; 8 ports        SPCv+ wide port; 16 ports     */
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
literal|0
operator|<=
name|i
operator|&&
name|i
operator|<=
literal|7
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x05050500
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x06060600
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|tiIS_16PHY
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
literal|0
operator|<=
name|i
operator|&&
name|i
operator|<=
literal|7
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x05050500
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x06060600
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
literal|0
operator|<=
name|i
operator|&&
name|i
operator|<=
literal|3
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x05050500
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
literal|4
operator|<=
name|i
operator|&&
name|i
operator|<=
literal|7
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x06060600
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* don't care */
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|0x01020304
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|0x0f0f0f0f
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 1.5G/3G , SAS/SATA, no spin-up control */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
literal|0x31
expr_stmt|;
comment|/* 49 The default is 1.5G and will be changed based on the registry value */
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: phy %d hi 0x%x lo 0x%x\n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
name|buffer
operator|=
name|tmpBuffer
expr_stmt|;
name|buffLen
operator|=
sizeof|sizeof
argument_list|(
name|tmpBuffer
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/* needs to read Phy's id frame */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|flag
operator|==
name|agFALSE
condition|)
block|{
name|osti_sprintf
argument_list|(
name|phyParmsStr
argument_list|,
literal|"PhyParms%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|i
operator|>=
literal|4
condition|)
block|{
name|osti_sprintf
argument_list|(
name|phyParmsStr
argument_list|,
literal|"PhyParms%d"
argument_list|,
name|i
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|osti_sprintf
argument_list|(
name|phyParmsStr
argument_list|,
literal|"PhyParms%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: i %d PhyParms %s\n"
operator|,
name|i
operator|,
name|phyParmsStr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|phyParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"AddrHi"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: phy %d hi 0x%x \n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: phy %d hi %d \n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|phyParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"AddrLow"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: phy %d lo 0x%x\n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: phy %d lo %d\n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: loop phy %d hi 0x%x lo 0x%x\n"
operator|,
name|i
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* phy properties */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/*     if ((ostiGetTransportParam (                                 tiRoot,                                 globalStr,                                 phyParmsStr,                                 agNULL,                                 agNULL,                                 agNULL,                                 agNULL,                                 "LinkRate",                                 buffer,                                 buffLen,&lenRecv                                 ) == tiSuccess)&& (lenRecv != 0))     {       LinkRateRead = agTRUE;       if (osti_strncmp(buffer, "0x", 2) == 0)       {         LinkRate = osti_strtoul(buffer,&pLastUsedChar, 0);         TI_DBG2(("tdsaGetGlobalPhyParams: phy %d linkrate 0x%x \n", i, LinkRate));       }       else       {         LinkRate = osti_strtoul(buffer,&pLastUsedChar, 10);         TI_DBG2(("tdsaGetGlobalPhyParams: phy %d linkrate %d \n", i, LinkRate));       }     } */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|phyParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"Mode"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
name|ModeRead
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|Mode
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: phy %d Mode 0x%x \n"
operator|,
name|i
operator|,
name|Mode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Mode
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: phy %d Mode %d \n"
operator|,
name|i
operator|,
name|Mode
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|phyParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"OpticalMode"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
name|OpticalModeRead
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OpticalMode
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: phy %d OpticalMode 0x%x \n"
operator|,
name|i
operator|,
name|OpticalMode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OpticalMode
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams: phy %d OpticalMode %d \n"
operator|,
name|i
operator|,
name|OpticalMode
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams:A phy %d phyProperties %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
name|tdsaParseLinkRateMode
argument_list|(
name|tiRoot
argument_list|,
name|i
argument_list|,
name|LinkRateRead
argument_list|,
name|ModeRead
argument_list|,
name|OpticalModeRead
argument_list|,
name|LinkRate
argument_list|,
name|Mode
argument_list|,
name|OpticalMode
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetGlobalPhyParams:B phy %d phyProperties %d\n"
operator|,
name|i
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
comment|/**********************************************/
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/* restore default */
name|LinkRate
operator|=
literal|15
expr_stmt|;
name|Mode
operator|=
literal|3
expr_stmt|;
name|OpticalMode
operator|=
literal|0
expr_stmt|;
name|LinkRateRead
operator|=
name|agTRUE
expr_stmt|;
comment|//VG
name|ModeRead
operator|=
name|agFALSE
expr_stmt|;
name|OpticalModeRead
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* end for */
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaGetPortParams * *  Purpose:  This function reads port-related configuration parameters from the *            configuration file * *  \param  tiRoot:            Pointer to driver/port instance. * *  \return:     None * *  \note - just a place holder for now * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaGetPortParams
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|bit32
name|buffLen
decl_stmt|;
name|bit32
name|lenRecv
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pLastUsedChar
init|=
name|agNULL
decl_stmt|;
name|char
name|tmpBuffer
index|[
name|DEFAULT_KEY_BUFFER_SIZE
index|]
decl_stmt|;
name|char
name|globalStr
index|[]
init|=
literal|"Global"
decl_stmt|;
name|char
name|portParmsStr
index|[]
init|=
literal|"PortParms"
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetPortParams: start \n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetPortParams: tdsaRoot %p tdsaAllShared %p \n"
operator|,
name|tdsaRoot
operator|,
name|tdsaAllShared
operator|)
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|tmpBuffer
expr_stmt|;
name|buffLen
operator|=
sizeof|sizeof
argument_list|(
name|tmpBuffer
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|portParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"InterruptDelay"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaAllShared
operator|->
name|currentInterruptDelay
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|currentInterruptDelay
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetPortParams: in \n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaGetPortParams: out \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* and more .... */
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|FW_EVT_LOG_TST
end_ifdef

begin_function_decl
name|void
name|saLogDump
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|U32
modifier|*
name|eventLogSize
parameter_list|,
name|U32
modifier|*
modifier|*
name|eventLogAddress
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|tiLogDump
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|U32
modifier|*
name|size
parameter_list|,
name|U32
modifier|*
modifier|*
name|addr
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
name|saLogDump
argument_list|(
operator|&
name|tdsaAllShared
operator|->
name|agRootNonInt
argument_list|,
name|size
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *! \brief  tiCOMPortInit * *  Purpose: This function is called to initialize the port hardware. *           This call could only be called until after the successful *           completion tiCOMInit(). * *  \param   tiRoot:         Pointer to root data structure. *  \param   sysIntsActive:  system interrupt flag * *  \return: *           tiSuccess:      Successful. *           Others:             Fail. * *  \note - * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMPortInit
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|sysIntsActive
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tiLoLevelResource_t
modifier|*
name|loResource
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|agsaQueueConfig_t
modifier|*
name|QueueConfig
decl_stmt|;
ifdef|#
directive|ifdef
name|CONTROLLER_STATUS_TESTING
specifier|static
name|agsaControllerStatus_t
name|agcontrollerStatus
decl_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_STATUS_TESTING */
ifdef|#
directive|ifdef
name|CONTROLLER_INFO_TESTING
specifier|static
name|agsaControllerInfo_t
name|agcontrollerInfo
decl_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
ifdef|#
directive|ifdef
name|CONTROLLER_ENCRYPT_TESTING
specifier|static
name|agsaEncryptInfo_t
name|agsaEncryptInfo
decl_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
specifier|static
name|agsaMemoryRequirement_t
name|agMemoryRequirement
decl_stmt|;
ifdef|#
directive|ifdef
name|ECHO_TESTING
comment|/* temp */
specifier|static
name|bit8
name|payload
index|[
literal|56
index|]
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|FDS_DM
argument_list|)
operator|||
name|defined
argument_list|(
name|FDS_SM
argument_list|)
specifier|static
name|agsaMemoryRequirement_t
name|memRequirement
decl_stmt|;
name|bit32
name|maxQueueSets
init|=
literal|0
decl_stmt|;
name|bit32
name|LLMemCount
init|=
literal|0
decl_stmt|;
name|bit32
name|usecsPerTick
init|=
literal|0
decl_stmt|;
specifier|static
name|agsaSwConfig_t
name|tmpLLSwConfig
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_DM
specifier|static
name|dmRoot_t
modifier|*
name|dmRoot
init|=
name|agNULL
decl_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
specifier|static
name|dmSwConfig_t
name|dmSwConfig
decl_stmt|;
endif|#
directive|endif
specifier|static
name|dmMemoryRequirement_t
name|dmMemRequirement
decl_stmt|;
name|bit32
name|DMMemCount
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|FDS_DM
argument_list|)
operator|&&
name|defined
argument_list|(
name|FDS_SM
argument_list|)
name|bit32
name|dmUsecsPerTick
init|=
literal|0
decl_stmt|;
name|bit32
name|dmMaxNumLocks
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
comment|//  smSwConfig_t                   smSwConfig;
specifier|static
name|smMemoryRequirement_t
name|smMemRequirement
decl_stmt|;
name|bit32
name|SMMemCount
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|TURN_OFF_HDA
specifier|static
name|agsaFwImg_t
name|HDAImg
decl_stmt|;
endif|#
directive|endif
comment|/*  TURN_OFF_HDA */
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMPortInit: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: sizeof agsaMemoryRequirement_t %d\n"
operator|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|agsaMemoryRequirement_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|agMemoryRequirement
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaMemoryRequirement_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*    * don't do anything if reset is in progress    */
if|if
condition|(
name|tdsaAllShared
operator|->
name|flags
operator|.
name|resetInProgress
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: resetinProgress error\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|loResource
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|loResource
operator|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|flags
operator|.
name|sysIntsActive
operator|=
name|sysIntsActive
expr_stmt|;
comment|/*      gets port-related parameters; not in use for now      tdsaGetPortParams(tiRoot);    */
comment|/* call these before agroot is created  for testing */
ifdef|#
directive|ifdef
name|CONTROLLER_STATUS_TESTING
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: saGetControllerStatus returns 0x%X\n"
operator|,
name|saGetControllerStatus
argument_list|(
name|agRoot
argument_list|,
operator|&
name|agcontrollerStatus
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
ifdef|#
directive|ifdef
name|CONTROLLER_INFO_TESTING
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: saGetControllerInfo returns 0x%X\n"
operator|,
name|saGetControllerInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|agcontrollerInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
ifdef|#
directive|ifdef
name|CONTROLLER_ENCRYPT_TESTING
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: saEncryptGetMode returns 0x%X\n"
operator|,
name|saEncryptGetMode
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
name|agsaEncryptInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
name|tdsaGetSwConfigParams
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
name|tdsaPrintSwConfig
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|)
argument_list|)
expr_stmt|;
comment|/* setting interrupt requirements */
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSIX_InterruptVectors
operator|=
name|loResource
operator|->
name|loLevelOption
operator|.
name|maxInterruptVectors
expr_stmt|;
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSI_InterruptVectors
operator|=
name|loResource
operator|->
name|loLevelOption
operator|.
name|max_MSI_InterruptVectors
expr_stmt|;
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|legacyInt_X
operator|=
name|loResource
operator|->
name|loLevelOption
operator|.
name|flag
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: got max_MSIX_InterruptVectors %d \n"
operator|,
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSIX_InterruptVectors
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: got max_MSI_InterruptVectors %d \n"
operator|,
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSI_InterruptVectors
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: got flag - legacyInt_X %d \n"
operator|,
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|legacyInt_X
operator|)
argument_list|)
expr_stmt|;
comment|/* error checking for interrupt types */
if|if
condition|(
operator|(
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSIX_InterruptVectors
operator|==
literal|0
operator|)
operator|&&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSI_InterruptVectors
operator|==
literal|0
operator|)
operator|&&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|legacyInt_X
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSIX_InterruptVectors
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSI_InterruptVectors
operator|==
literal|0
operator|)
operator|&&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|legacyInt_X
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSIX_InterruptVectors
operator|==
literal|0
operator|)
operator|&&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSI_InterruptVectors
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|legacyInt_X
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSIX_InterruptVectors
operator|==
literal|0
operator|)
operator|&&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSI_InterruptVectors
operator|==
literal|0
operator|)
operator|&&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|legacyInt_X
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
comment|/* do nothing */
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: incorrect interrupt\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|QueueConfig
operator|=
operator|&
name|tdsaAllShared
operator|->
name|QueueConfig
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QueueConfig
operator|->
name|numInboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|QueueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|elementCount
operator|=
name|tdsaAllShared
operator|->
name|InboundQueueSize
index|[
name|i
index|]
expr_stmt|;
name|QueueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
operator|=
name|tdsaAllShared
operator|->
name|InboundQueueEleSize
index|[
name|i
index|]
expr_stmt|;
name|QueueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|priority
operator|=
name|tdsaAllShared
operator|->
name|InboundQueuePriority
index|[
name|i
index|]
expr_stmt|;
name|QueueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: InboundQueuePriroity %d \n"
operator|,
name|tdsaAllShared
operator|->
name|InboundQueuePriority
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QueueConfig
operator|->
name|numOutboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|QueueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|elementCount
operator|=
name|tdsaAllShared
operator|->
name|OutboundQueueSize
index|[
name|i
index|]
expr_stmt|;
name|QueueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
operator|=
name|tdsaAllShared
operator|->
name|OutboundQueueEleSize
index|[
name|i
index|]
expr_stmt|;
name|QueueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptDelay
operator|=
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptDelay
index|[
name|i
index|]
expr_stmt|;
comment|/* default 0; no interrupt delay */
name|QueueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptCount
operator|=
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptCount
index|[
name|i
index|]
expr_stmt|;
comment|/* default 1 */
name|QueueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptEnable
operator|=
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptEnable
index|[
name|i
index|]
expr_stmt|;
comment|/* default 1 */
name|QueueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptVectorIndex
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSIX_InterruptVectors
operator|!=
literal|0
condition|)
block|{
name|QueueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptVectorIndex
operator|=
name|i
operator|%
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSIX_InterruptVectors
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSI_InterruptVectors
operator|!=
literal|0
condition|)
block|{
name|QueueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptVectorIndex
operator|=
name|i
operator|%
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|max_MSI_InterruptVectors
expr_stmt|;
block|}
else|else
block|{
name|QueueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptVectorIndex
operator|=
literal|0
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: OutboundQueueInterruptDelay %d OutboundQueueInterruptCount %d OutboundQueueInterruptEnable %d\n"
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptDelay
index|[
name|i
index|]
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptCount
index|[
name|i
index|]
operator|,
name|tdsaAllShared
operator|->
name|OutboundQueueInterruptEnable
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* queue option */
name|QueueConfig
operator|->
name|queueOption
operator|=
name|tdsaAllShared
operator|->
name|QueueOption
expr_stmt|;
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|param3
operator|=
operator|(
name|void
operator|*
operator|)
name|QueueConfig
expr_stmt|;
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|stallUsec
operator|=
literal|10
expr_stmt|;
comment|/* finds a first high priority queue for SMP */
name|tdsaAllShared
operator|->
name|SMPQNum
operator|=
literal|0
expr_stmt|;
comment|/* default */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QueueConfig
operator|->
name|numInboundQueues
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|QueueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|priority
operator|!=
name|DEFAULT_INBOUND_QUEUE_PRIORITY
condition|)
comment|/* 0 */
block|{
name|tdsaAllShared
operator|->
name|SMPQNum
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
name|tdsaGetHwConfigParams
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
name|tdsaPrintHwConfig
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|HwConfig
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TARGET_DRIVER
comment|/* target, not yet */
if|if
condition|(
name|tdsaAllShared
operator|->
name|currentOperation
operator|&
name|TD_OPERATION_TARGET
condition|)
block|{
name|ttdssGetTargetParams
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|FDS_DM
argument_list|)
operator|&&
name|defined
argument_list|(
name|FDS_SM
argument_list|)
comment|/*     needs to call saGetRequirements() to find out agMemoryRequirement.count requested by LL   */
name|osti_memcpy
argument_list|(
operator|&
name|tmpLLSwConfig
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSwConfig_t
argument_list|)
argument_list|)
expr_stmt|;
name|saGetRequirements
argument_list|(
name|agRoot
argument_list|,
operator|&
name|tmpLLSwConfig
argument_list|,
operator|&
name|memRequirement
argument_list|,
operator|&
name|usecsPerTick
argument_list|,
operator|&
name|maxQueueSets
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: usecsPerTick %d\n"
operator|,
name|usecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: LL memRequirement.count %d\n"
operator|,
name|memRequirement
operator|.
name|count
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: loResource->loLevelMem.count %d\n"
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|count
operator|)
argument_list|)
expr_stmt|;
name|LLMemCount
operator|=
name|memRequirement
operator|.
name|count
expr_stmt|;
comment|/*     needs to call dmGetRequirements() to find out dmMemoryRequirement.count requested by DM   */
name|dmGetRequirements
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|dmSwConfig
argument_list|,
operator|&
name|dmMemRequirement
argument_list|,
operator|&
name|dmUsecsPerTick
argument_list|,
operator|&
name|dmMaxNumLocks
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: DM dmmemRequirement.count %d\n"
operator|,
name|dmMemRequirement
operator|.
name|count
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: loResource->loLevelMem.count %d\n"
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|count
operator|)
argument_list|)
expr_stmt|;
name|DMMemCount
operator|=
name|dmMemRequirement
operator|.
name|count
expr_stmt|;
name|SMMemCount
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|count
operator|-
name|LLMemCount
operator|-
name|DMMemCount
expr_stmt|;
name|agMemoryRequirement
operator|.
name|count
operator|=
name|LLMemCount
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: SMMemCount %d\n"
operator|,
name|SMMemCount
operator|)
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|FDS_DM
argument_list|)
comment|/*     needs to call saGetRequirements() to find out agMemoryRequirement.count requested by LL   */
name|osti_memcpy
argument_list|(
operator|&
name|tmpLLSwConfig
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSwConfig_t
argument_list|)
argument_list|)
expr_stmt|;
name|saGetRequirements
argument_list|(
name|agRoot
argument_list|,
operator|&
name|tmpLLSwConfig
argument_list|,
operator|&
name|memRequirement
argument_list|,
operator|&
name|usecsPerTick
argument_list|,
operator|&
name|maxQueueSets
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: memRequirement.count %d\n"
operator|,
name|memRequirement
operator|.
name|count
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: loResource->loLevelMem.count %d\n"
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|count
operator|)
argument_list|)
expr_stmt|;
name|LLMemCount
operator|=
name|memRequirement
operator|.
name|count
expr_stmt|;
name|DMMemCount
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|count
operator|-
name|LLMemCount
expr_stmt|;
name|agMemoryRequirement
operator|.
name|count
operator|=
name|LLMemCount
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|FDS_SM
argument_list|)
name|osti_memcpy
argument_list|(
operator|&
name|tmpLLSwConfig
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSwConfig_t
argument_list|)
argument_list|)
expr_stmt|;
name|saGetRequirements
argument_list|(
name|agRoot
argument_list|,
operator|&
name|tmpLLSwConfig
argument_list|,
operator|&
name|memRequirement
argument_list|,
operator|&
name|usecsPerTick
argument_list|,
operator|&
name|maxQueueSets
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: memRequirement.count %d\n"
operator|,
name|memRequirement
operator|.
name|count
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: loResource->loLevelMem.count %d\n"
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|count
operator|)
argument_list|)
expr_stmt|;
name|LLMemCount
operator|=
name|memRequirement
operator|.
name|count
expr_stmt|;
name|SMMemCount
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|count
operator|-
name|LLMemCount
expr_stmt|;
name|agMemoryRequirement
operator|.
name|count
operator|=
name|LLMemCount
expr_stmt|;
else|#
directive|else
name|agMemoryRequirement
operator|.
name|count
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|count
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|FDS_DM
argument_list|)
operator|&&
name|defined
argument_list|(
name|FDS_SM
argument_list|)
comment|/* for debugging */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
call|(
name|int
call|)
argument_list|(
name|LLMemCount
operator|+
name|DMMemCount
operator|+
name|SMMemCount
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d phyAddrUpper 0x%x phyAddrLower 0x%x totalLength %d alignment %d\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d virtPtr %p\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* initialize */
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: AGSA_NUM_MEM_CHUNKS %d\n"
operator|,
name|AGSA_NUM_MEM_CHUNKS
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AGSA_NUM_MEM_CHUNKS
condition|;
name|i
operator|++
control|)
block|{
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|virtPtr
operator|=
name|agNULL
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|osHandle
operator|=
name|agNULL
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|phyAddrUpper
operator|=
literal|0
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|phyAddrLower
operator|=
literal|0
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|totalLength
operator|=
literal|0
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|numElements
operator|=
literal|0
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|singleElementLength
operator|=
literal|0
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|alignment
operator|=
literal|0
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|type
operator|=
literal|0
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|int
operator|)
name|agMemoryRequirement
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: LL copying loResource.loLevelMem to agsaMemoryRequirement_t index %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|virtPtr
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|osHandle
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|osHandle
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|phyAddrUpper
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|phyAddrLower
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|totalLength
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|numElements
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|numElements
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|singleElementLength
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|singleElementLength
expr_stmt|;
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|alignment
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
expr_stmt|;
if|if
condition|(
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|type
operator|==
name|TI_DMA_MEM
condition|)
block|{
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|type
operator|=
name|AGSA_DMA_MEM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|type
operator|==
name|TI_CACHED_MEM
condition|)
block|{
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|type
operator|=
name|AGSA_CACHED_MEM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|type
operator|==
name|TI_CACHED_DMA_MEM
condition|)
block|{
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|type
operator|=
name|AGSA_CACHED_DMA_MEM
expr_stmt|;
block|}
name|agMemoryRequirement
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|reserved
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|reserved
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d virtPtr %p osHandle %p\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|osHandle
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d phyAddrUpper 0x%x phyAddrLower 0x%x totalLength %d numElements %d\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|numElements
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d singleElementLength 0x%x alignment 0x%x type %d reserved %d\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|singleElementLength
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|type
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|reserved
operator|)
argument_list|)
expr_stmt|;
block|}
name|osti_memset
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdFWControlEx_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*    * Note: Be sure to call this only once since sallsdk does initialization only once    * saInitialize(IN, IN, IN, IN, IN);    */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: tdsaAllShared->tdDeviceIdVendId %x\n"
operator|,
name|tdsaAllShared
operator|->
name|tdDeviceIdVendId
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: tdsaAllShared->tdSubVendorId= SUB_VEN_ID %x\n"
operator|,
name|tdsaAllShared
operator|->
name|tdSubVendorId
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: swConfig->param1 hwDEVICE_ID_VENDID %x\n"
operator|,
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|param1
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: swConfig->param2 hwSVID             %x\n"
operator|,
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|param2
operator|)
argument_list|)
expr_stmt|;
comment|/*     1. Read hostDirectAccessSupport     2. If set, read HDA images based on chip ID  */
name|t_MacroCheck
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|TURN_OFF_HDA
if|if
condition|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|hostDirectAccessSupport
operator|!=
literal|0
condition|)
block|{
name|osti_memset
argument_list|(
operator|&
name|HDAImg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|HDAImg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: SPC HDA\n"
operator|)
argument_list|)
expr_stmt|;
name|HDAImg
operator|.
name|aap1Img
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|aap1array
operator|)
expr_stmt|;
name|HDAImg
operator|.
name|aap1Len
operator|=
sizeof|sizeof
argument_list|(
name|aap1array
argument_list|)
expr_stmt|;
name|HDAImg
operator|.
name|iopImg
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|ioparray
operator|)
expr_stmt|;
name|HDAImg
operator|.
name|iopLen
operator|=
sizeof|sizeof
argument_list|(
name|ioparray
argument_list|)
expr_stmt|;
name|HDAImg
operator|.
name|istrImg
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|istrarray
operator|)
expr_stmt|;
name|HDAImg
operator|.
name|istrLen
operator|=
sizeof|sizeof
argument_list|(
name|istrarray
argument_list|)
expr_stmt|;
name|HDAImg
operator|.
name|ilaImg
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|ilaarray
operator|)
expr_stmt|;
name|HDAImg
operator|.
name|ilaLen
operator|=
sizeof|sizeof
argument_list|(
name|ilaarray
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiIS_SPC6V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: SPCv HDA\n"
operator|)
argument_list|)
expr_stmt|;
name|HDAImg
operator|.
name|aap1Img
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|spcv_aap1array
operator|)
expr_stmt|;
name|HDAImg
operator|.
name|aap1Len
operator|=
sizeof|sizeof
argument_list|(
name|spcv_aap1array
argument_list|)
expr_stmt|;
name|HDAImg
operator|.
name|iopImg
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|spcv_ioparray
operator|)
expr_stmt|;
name|HDAImg
operator|.
name|iopLen
operator|=
sizeof|sizeof
argument_list|(
name|spcv_ioparray
argument_list|)
expr_stmt|;
name|HDAImg
operator|.
name|ilaImg
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|spcv_ilaarray
operator|)
expr_stmt|;
name|HDAImg
operator|.
name|ilaLen
operator|=
sizeof|sizeof
argument_list|(
name|spcv_ilaarray
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tIsSPCV12G
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: SPCv12G HDA\n"
operator|)
argument_list|)
expr_stmt|;
name|HDAImg
operator|.
name|aap1Img
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|spcv12g_raaearray
operator|)
expr_stmt|;
name|HDAImg
operator|.
name|aap1Len
operator|=
sizeof|sizeof
argument_list|(
name|spcv12g_raaearray
argument_list|)
expr_stmt|;
name|HDAImg
operator|.
name|iopImg
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|spcv12g_ioparray
operator|)
expr_stmt|;
name|HDAImg
operator|.
name|iopLen
operator|=
sizeof|sizeof
argument_list|(
name|spcv12g_ioparray
argument_list|)
expr_stmt|;
name|HDAImg
operator|.
name|ilaImg
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|spcv12g_ilaarray
operator|)
expr_stmt|;
name|HDAImg
operator|.
name|ilaLen
operator|=
sizeof|sizeof
argument_list|(
name|spcv12g_ilaarray
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: HDA Mode Unknown chip type 0x%08x\n"
operator|,
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: HDA aap1Len 0x%08x iopLen 0x%08x ilaLen 0x%08x\n"
operator|,
name|HDAImg
operator|.
name|aap1Len
operator|,
name|HDAImg
operator|.
name|iopLen
operator|,
name|HDAImg
operator|.
name|ilaLen
operator|)
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|param4
operator|=
operator|&
operator|(
name|HDAImg
operator|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: HDA off\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|param4
operator|=
name|agNULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/*  TURN_OFF_HDA */
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/* FW config is only for SPC */
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|FWConfig
operator|=
literal|0
expr_stmt|;
comment|/* default port recovery timer 0x32 = 50 = 5000ms and port reset timer 3 (300 ms)*/
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|PortRecoveryResetTimer
operator|=
literal|0x30032
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit:only for SPC FWConfig set\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|fatalErrorInterruptVector
operator|=
name|loResource
operator|->
name|loLevelOption
operator|.
name|maxInterruptVectors
operator|>
literal|31
condition|?
literal|31
else|:
name|loResource
operator|->
name|loLevelOption
operator|.
name|maxInterruptVectors
operator|-
literal|1
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: SwConfig->FWConfig 0x%x\n"
operator|,
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|FWConfig
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: SwConfig->fatalErrorInterruptVector 0x%x\n"
operator|,
name|tdsaAllShared
operator|->
name|SwConfig
operator|.
name|fatalErrorInterruptVector
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: loResource->loLevelOption.usecsPerTick %d\n"
operator|,
name|loResource
operator|->
name|loLevelOption
operator|.
name|usecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|saInitialize
argument_list|(
name|agRoot
argument_list|,
operator|&
name|agMemoryRequirement
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|HwConfig
operator|)
argument_list|,
comment|/*&temp_HwConfig, */
operator|&
operator|(
name|tdsaAllShared
operator|->
name|SwConfig
operator|)
argument_list|,
name|loResource
operator|->
name|loLevelOption
operator|.
name|usecsPerTick
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: loResource->loLevelOption.usecsPerTick %d 0x%x\n"
operator|,
name|loResource
operator|->
name|loLevelOption
operator|.
name|usecsPerTick
operator|,
name|loResource
operator|->
name|loLevelOption
operator|.
name|usecsPerTick
operator|)
argument_list|)
expr_stmt|;
comment|/*TI_DBG6(("tiCOMPortInit: tdsaAllShared->SwConfig.enableDIF %d\n", tdsaAllShared->SwConfig.enableDIF)); */
comment|/*TI_DBG6(("tiCOMPortInit: tdsaAllShared->SwConfig.enableEncryption %d\n", tdsaAllShared->SwConfig.enableEncryption)); */
if|if
condition|(
name|status
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: saInitialize AGSA_RC_FAILURE, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|status
operator|==
name|AGSA_RC_VERSION_INCOMPATIBLE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: saInitialize AGSA_RC_VERSION_INCOMPATIBLE, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* let's make sdkData same for Int and Non-int agRoots */
name|tdsaAllShared
operator|->
name|agRootInt
operator|.
name|sdkData
operator|=
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|.
name|sdkData
expr_stmt|;
comment|/* mark the port as initialized */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|flags
operator|.
name|portInitialized
operator|=
name|agTRUE
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|//ini. only in stsdkll spec (TP)
comment|/* register device registration callback function */
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: calling saRegisterEventCallback for device registration\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|saRegisterEventCallback
argument_list|(
name|agRoot
argument_list|,
name|OSSA_EVENT_SOURCE_DEVICE_HANDLE_ADDED
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ossaDeviceRegistrationCB
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: saRegisterEventCallback Device Register failed\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: saRegisterEventCallback Device Register succeeded\n"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* register device deregistration callback function */
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: calling saRegisterEventCallback for device de-registration\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|saRegisterEventCallback
argument_list|(
name|agRoot
argument_list|,
name|OSSA_EVENT_SOURCE_DEVICE_HANDLE_REMOVED
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ossaDeregisterDeviceHandleCB
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: saRegisterEventCallback Device Deregister failed\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: saRegisterEventCallback Device Deregister succeeded\n"
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|ECHO_TESTING
comment|/* temporary to test saEchoCommand() */
comment|/*     send echo   */
name|payload
index|[
literal|0
index|]
operator|=
name|gEcho
expr_stmt|;
name|payload
index|[
literal|55
index|]
operator|=
name|gEcho
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: calling saEchoCommand gEcho %d\n"
operator|,
name|gEcho
operator|)
argument_list|)
expr_stmt|;
name|saEchoCommand
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|payload
argument_list|)
expr_stmt|;
name|gEcho
operator|++
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CONTROLLER_STATUS_TESTING
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: saGetControllerStatus returns 0x%X\n"
operator|,
name|saGetControllerStatus
argument_list|(
name|agRoot
argument_list|,
operator|&
name|agcontrollerStatus
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
ifdef|#
directive|ifdef
name|CONTROLLER_INFO_TESTING
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: saGetControllerInfo returns 0x%X\n"
operator|,
name|saGetControllerInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|agcontrollerInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
ifdef|#
directive|ifdef
name|CONTROLLER_ENCRYPT_TESTING
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: saEncryptGetMode returns 0x%X\n"
operator|,
name|saEncryptGetMode
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
name|agsaEncryptInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
ifdef|#
directive|ifdef
name|VPD_TESTING
comment|/* temporary to test saSetVPDCommand() and saGetVPDCommand */
name|tdsaVPDSet
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* VPD_TESTING */
if|#
directive|if
name|defined
argument_list|(
name|FDS_DM
argument_list|)
operator|&&
name|defined
argument_list|(
name|FDS_SM
argument_list|)
comment|/* initialize DM then SM */
comment|/* DM */
name|dmRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|dmMemRequirement
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dmMemoryRequirement_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmMemRequirement
operator|.
name|count
operator|=
name|DMMemCount
expr_stmt|;
for|for
control|(
name|i
operator|=
name|LLMemCount
init|;
name|i
operator|<
call|(
name|int
call|)
argument_list|(
name|LLMemCount
operator|+
name|DMMemCount
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: DM copying loResource.loLevelMem to agsaMemoryRequirement_t index %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|virtPtr
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|osHandle
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|osHandle
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|physAddrUpper
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|physAddrLower
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|totalLength
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|numElements
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|numElements
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|singleElementLength
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|singleElementLength
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|alignment
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|type
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|reserved
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|reserved
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d virtPtr %p osHandle %p\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|osHandle
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d phyAddrUpper 0x%x phyAddrLower 0x%x totalLength %d numElements %d\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|numElements
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d singleElementLength 0x%x alignment 0x%x type %d reserved %d\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|singleElementLength
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|type
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|reserved
operator|)
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|dmInitialize
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
operator|&
name|dmMemRequirement
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmSwConfig
operator|)
argument_list|,
comment|//&dmSwConfig, /* start here */
name|loResource
operator|->
name|loLevelOption
operator|.
name|usecsPerTick
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|DM_RC_FAILURE
operator|||
name|status
operator|==
name|DM_RC_VERSION_INCOMPATIBLE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: dmInitialize FAILED, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* SM */
name|smRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|smMemRequirement
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smMemoryRequirement_t
argument_list|)
argument_list|)
expr_stmt|;
name|smMemRequirement
operator|.
name|count
operator|=
name|SMMemCount
expr_stmt|;
for|for
control|(
name|i
operator|=
operator|(
name|LLMemCount
operator|+
name|DMMemCount
operator|)
init|;
name|i
operator|<
call|(
name|int
call|)
argument_list|(
name|LLMemCount
operator|+
name|DMMemCount
operator|+
name|SMMemCount
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: SM copying loResource.loLevelMem to agsaMemoryRequirement_t index %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
operator|-
name|DMMemCount
index|]
operator|.
name|virtPtr
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
operator|-
name|DMMemCount
index|]
operator|.
name|osHandle
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|osHandle
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
operator|-
name|DMMemCount
index|]
operator|.
name|physAddrUpper
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
operator|-
name|DMMemCount
index|]
operator|.
name|physAddrLower
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
operator|-
name|DMMemCount
index|]
operator|.
name|totalLength
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
operator|-
name|DMMemCount
index|]
operator|.
name|numElements
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|numElements
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
operator|-
name|DMMemCount
index|]
operator|.
name|singleElementLength
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|singleElementLength
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
operator|-
name|DMMemCount
index|]
operator|.
name|alignment
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
operator|-
name|DMMemCount
index|]
operator|.
name|type
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
operator|-
name|DMMemCount
index|]
operator|.
name|reserved
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|reserved
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d virtPtr %p osHandle %p\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|osHandle
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d phyAddrUpper 0x%x phyAddrLower 0x%x totalLength %d numElements %d\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|numElements
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d singleElementLength 0x%x alignment 0x%x type %d reserved %d\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|singleElementLength
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|type
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|reserved
operator|)
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|smInitialize
argument_list|(
name|smRoot
argument_list|,
name|agRoot
argument_list|,
operator|&
name|smMemRequirement
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smSwConfig
operator|)
argument_list|,
comment|//&smSwConfig, /* start here */
name|loResource
operator|->
name|loLevelOption
operator|.
name|usecsPerTick
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SM_RC_FAILURE
operator|||
name|status
operator|==
name|SM_RC_VERSION_INCOMPATIBLE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: smInitialize FAILED, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
elif|#
directive|elif
name|defined
argument_list|(
name|FDS_DM
argument_list|)
name|dmRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|dmMemRequirement
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dmMemoryRequirement_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmMemRequirement
operator|.
name|count
operator|=
name|DMMemCount
expr_stmt|;
for|for
control|(
name|i
operator|=
name|LLMemCount
init|;
name|i
operator|<
call|(
name|int
call|)
argument_list|(
name|LLMemCount
operator|+
name|DMMemCount
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: copying loResource.loLevelMem to agsaMemoryRequirement_t index %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|virtPtr
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|osHandle
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|osHandle
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|physAddrUpper
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|physAddrLower
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|totalLength
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|numElements
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|numElements
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|singleElementLength
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|singleElementLength
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|alignment
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|type
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
name|dmMemRequirement
operator|.
name|dmMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|reserved
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|reserved
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d phyAddrUpper 0x%x phyAddrLower 0x%x totalLength %d alignment %d\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d virtPtr %p\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
operator|)
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|dmInitialize
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
operator|&
name|dmMemRequirement
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmSwConfig
operator|)
argument_list|,
comment|//&dmSwConfig, /* start here */
name|loResource
operator|->
name|loLevelOption
operator|.
name|usecsPerTick
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|DM_RC_FAILURE
operator|||
name|status
operator|==
name|DM_RC_VERSION_INCOMPATIBLE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: dmInitialize FAILED, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
elif|#
directive|elif
name|defined
argument_list|(
name|FDS_SM
argument_list|)
name|smRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|smMemRequirement
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smMemoryRequirement_t
argument_list|)
argument_list|)
expr_stmt|;
name|smMemRequirement
operator|.
name|count
operator|=
name|SMMemCount
expr_stmt|;
for|for
control|(
name|i
operator|=
name|LLMemCount
init|;
name|i
operator|<
call|(
name|int
call|)
argument_list|(
name|LLMemCount
operator|+
name|SMMemCount
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: copying loResource.loLevelMem to agsaMemoryRequirement_t index %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|virtPtr
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|osHandle
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|osHandle
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|physAddrUpper
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|physAddrLower
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|totalLength
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|numElements
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|numElements
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|singleElementLength
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|singleElementLength
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|alignment
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|type
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
name|smMemRequirement
operator|.
name|smMemory
index|[
name|i
operator|-
name|LLMemCount
index|]
operator|.
name|reserved
operator|=
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|reserved
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d phyAddrUpper 0x%x phyAddrLower 0x%x totalLength %d alignment %d\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrUpper
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|physAddrLower
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|totalLength
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|alignment
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortInit: index %d virtPtr %p\n"
operator|,
name|i
operator|,
name|loResource
operator|->
name|loLevelMem
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|virtPtr
operator|)
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|smInitialize
argument_list|(
name|smRoot
argument_list|,
name|agRoot
argument_list|,
operator|&
name|smMemRequirement
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smSwConfig
operator|)
argument_list|,
comment|//&smSwConfig, /* start here */
name|loResource
operator|->
name|loLevelOption
operator|.
name|usecsPerTick
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SM_RC_FAILURE
operator|||
name|status
operator|==
name|SM_RC_VERSION_INCOMPATIBLE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: smInitialize FAILED, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
else|#
directive|else
comment|/* nothing */
endif|#
directive|endif
comment|/* FDS_DM&& FDS_SM */
comment|/* call these again after agroot is created  for testing */
ifdef|#
directive|ifdef
name|CONTROLLER_STATUS_TESTING
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit:again saGetControllerStatus returns 0x%X\n"
operator|,
name|saGetControllerStatus
argument_list|(
name|agRoot
argument_list|,
operator|&
name|agcontrollerStatus
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
ifdef|#
directive|ifdef
name|CONTROLLER_INFO_TESTING
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit:again saGetControllerInfo returns 0x%X\n"
operator|,
name|saGetControllerInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|agcontrollerInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
ifdef|#
directive|ifdef
name|CONTROLLER_ENCRYPT_TESTING
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit:again saEncryptGetMode returns 0x%X\n"
operator|,
name|saEncryptGetMode
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
name|agsaEncryptInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
comment|/* Enable SGPIO */
if|if
condition|(
name|tiSuccess
operator|==
name|tiCOMConfigureSgpio
argument_list|(
name|tiRoot
argument_list|,
name|agTRUE
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortInit: Successfully sent request to enable SGPIO\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortInit: Failed to enable SGPIO\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief SendSgpioRequest * *  Purpose: This function is used to send SGPIO request during initialization * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   regType: Register Type *  \param   regIndex: Register Index *  \param   regCount: Register Count *  \param   writeData: Part of the request *                   *  \return: *           tiSuccess on success *           Other status on failure * *****************************************************************************/
end_comment

begin_function
specifier|static
name|bit32
name|SendSgpioRequest
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit8
name|regType
parameter_list|,
name|bit8
name|regIndex
parameter_list|,
name|bit8
name|regCount
parameter_list|,
name|bit32
modifier|*
name|writeData
parameter_list|)
block|{
specifier|static
name|bit32
name|buffer
index|[
literal|128
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|bit32
name|retVal
init|=
name|IOCTL_CALL_FAIL
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
init|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
name|buffer
decl_stmt|;
name|agsaSGpioReqResponse_t
modifier|*
name|pSGpioReq
init|=
operator|(
name|agsaSGpioReqResponse_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
decl_stmt|;
name|agsaSGpioReqResponse_t
modifier|*
name|pSgpioResponse
init|=
operator|(
name|agsaSGpioReqResponse_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
decl_stmt|;
do|do
block|{
comment|/* Frame the Ioctl payload */
name|agIOCTLPayload
operator|->
name|MajorFunction
operator|=
name|IOCTL_MJ_SGPIO
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Length
operator|=
sizeof|sizeof
argument_list|(
name|agsaSGpioReqResponse_t
argument_list|)
expr_stmt|;
comment|/* Frame the SGPIO request */
name|pSGpioReq
operator|->
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
name|pSGpioReq
operator|->
name|function
operator|=
name|AGSA_WRITE_SGPIO_REGISTER
expr_stmt|;
name|pSGpioReq
operator|->
name|registerType
operator|=
name|regType
expr_stmt|;
name|pSGpioReq
operator|->
name|registerIndex
operator|=
name|regIndex
expr_stmt|;
name|pSGpioReq
operator|->
name|registerCount
operator|=
name|regCount
expr_stmt|;
name|memcpy
argument_list|(
name|pSGpioReq
operator|->
name|readWriteData
argument_list|,
name|writeData
argument_list|,
name|regCount
operator|*
literal|4
argument_list|)
expr_stmt|;
comment|/* Send the SGPIO request */
name|sgpioResponseSet
operator|=
literal|0
expr_stmt|;
name|retVal
operator|=
name|tdsaSGpioIoctlSetup
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|retVal
operator|!=
name|IOCTL_CALL_PENDING
condition|)
block|{
break|break;
block|}
comment|/* Waiting for SGPIO Response */
while|while
condition|(
operator|!
name|sgpioResponseSet
condition|)
block|{
name|tiCOMDelayedInterruptHandler
argument_list|(
name|tiRoot
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|tiNonInterruptContext
argument_list|)
expr_stmt|;
block|}
name|sgpioResponseSet
operator|=
literal|0
expr_stmt|;
comment|/* Check the ioctl result */
if|if
condition|(
name|agIOCTLPayload
operator|->
name|Status
operator|!=
name|IOCTL_ERR_STATUS_OK
condition|)
block|{
break|break;
block|}
comment|/* Check the sgpio function result */
if|if
condition|(
name|pSgpioResponse
operator|->
name|functionResult
operator|!=
literal|0x00
condition|)
block|{
break|break;
block|}
name|status
operator|=
name|tiSuccess
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tiCOMConfigureSgpio * *  Purpose: This function is used to configure SGPIO during initialization * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   enableSgpio: Enable / Disable SGPIO *                   *  \return: *           tiSuccess on success *           Other status on failure * *****************************************************************************/
end_comment

begin_function
name|bit32
name|tiCOMConfigureSgpio
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit8
name|enableSgpio
parameter_list|)
block|{
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|bit8
name|regCount
decl_stmt|;
name|bit32
name|writeData
index|[
name|OSSA_SGPIO_MAX_READ_DATA_COUNT
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|agsaSGpioCfg0_t
modifier|*
name|pCfg0
init|=
operator|(
name|agsaSGpioCfg0_t
operator|*
operator|)
operator|&
name|writeData
index|[
literal|0
index|]
decl_stmt|;
name|agsaSGpioCfg1_t
modifier|*
name|pCfg1
init|=
operator|(
name|agsaSGpioCfg1_t
operator|*
operator|)
operator|&
name|writeData
index|[
literal|1
index|]
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|phyCount
init|=
name|tdsaAllShared
operator|->
name|phyCount
decl_stmt|;
if|if
condition|(
name|enableSgpio
condition|)
block|{
comment|/* Configure both CFG[0] and CFG[1] */
name|regCount
operator|=
literal|2
expr_stmt|;
comment|/* Enable SGPIO */
name|pCfg0
operator|->
name|gpioEnable
operator|=
literal|1
expr_stmt|;
comment|/* The following are the default values for CFG[1] suggested by SFF-8485 spec */
comment|/* Maximum Activity ON: 2 */
comment|/* Forced Activity OFF: 1 */
name|pCfg1
operator|->
name|maxActOn
operator|=
literal|2
expr_stmt|;
name|pCfg1
operator|->
name|forceActOff
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* Configure CFG[0] only */
name|regCount
operator|=
literal|1
expr_stmt|;
comment|/* Disable SGPIO */
name|pCfg0
operator|->
name|gpioEnable
operator|=
literal|0
expr_stmt|;
block|}
name|status
operator|=
name|SendSgpioRequest
argument_list|(
name|tiRoot
argument_list|,
name|AGSA_SGPIO_CONFIG_REG
argument_list|,
literal|0
argument_list|,
name|regCount
argument_list|,
name|writeData
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tiSuccess
operator|==
name|status
operator|)
operator|&&
operator|(
name|enableSgpio
operator|)
condition|)
block|{
comment|/* Write default values to transmit registers */
comment|/* RegisterCount = Number of phys present in HBA / 4 */
name|regCount
operator|=
name|phyCount
operator|/
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|regCount
condition|;
name|i
operator|++
control|)
block|{
comment|/* Following are the default values specified in SFF-8485 spec */
comment|/* Activity: 5 */
comment|/* Locate: 0 */
comment|/* Error: 0 */
name|writeData
index|[
name|i
index|]
operator|=
literal|0xA0A0A0A0
expr_stmt|;
block|}
name|status
operator|=
name|SendSgpioRequest
argument_list|(
name|tiRoot
argument_list|,
name|AGSA_SGPIO_DRIVE_BY_DRIVE_TRANSMIT_REG
argument_list|,
literal|0
argument_list|,
name|regCount
argument_list|,
name|writeData
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tiCOMPortStart * *  Purpose: This function is called to bring the port hardware online. This *           call could only be called until after the successful completion *           tiCOMPortInit(). * *  \param  tiRoot:          Pointer to root data structure. *  \param  portID:          A ID for this portal to be used by the TD Layer *                           to get the portal configuration information. *  \param  portalContext:   Pointer to the context for this portal. *  \param  option:          An option for starting a port * *  \return: *          tiSuccess:      Successful. *          Others:             Fail. * *  \note - *   If sas or sata initiator, this will be called 8 (the number of phys) times. *   If both sas and sata initiator, this will be called 16 times * *****************************************************************************/
end_comment

begin_comment
comment|/* portID is used as PhyID    Should return always tiSuccess. PortStarted is returned in ossaHwCB() */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMPortStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|portID
parameter_list|,
name|tiPortalContext_t
modifier|*
name|portalContext
parameter_list|,
name|bit32
name|option
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
name|tdsaAllShared
operator|->
name|agRootInt
decl_stmt|;
name|agsaSASProtocolTimerConfigurationPage_t
name|SASConfigPage
decl_stmt|;
name|bit32
name|status
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
specifier|static
name|bit32
name|IsSendSASConfigPage
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMPortStart: start portID %d\n"
operator|,
name|portID
operator|)
argument_list|)
expr_stmt|;
comment|/*    * return error if reset is in progress    */
if|if
condition|(
name|tdsaAllShared
operator|->
name|flags
operator|.
name|resetInProgress
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: reset error\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/*    *    * port is not initialized, return error    */
if|if
condition|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|flags
operator|.
name|portInitialized
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: not intialized error\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* portal has been started. */
if|if
condition|(
name|portalContext
operator|->
name|tdData
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|flags
operator|.
name|portStarted
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMPortStart : Cannot start port again: Port has already been started\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortStarted
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
name|portalContext
operator|->
name|tdData
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiCOMPortStart : saving portalconext portID %d tdsaAllShared %p\n"
operator|,
name|portID
operator|,
name|tdsaAllShared
operator|)
argument_list|)
expr_stmt|;
comment|/* saving tiportalContext_t */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|tiPortalContext
operator|=
name|portalContext
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiCOMPortStart : portID/phyID %d tiPortalContext %p\n"
operator|,
name|portID
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|tiPortalContext
operator|)
argument_list|)
expr_stmt|;
comment|/*     where is "tdsaAllShared->Ports[0].portContext" set?     in ossaHWCB   */
if|if
condition|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|flags
operator|.
name|portStarted
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: port already has been started \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*     hardcode sasID frame. It should be read by ostigettransportparams later from configuration file   */
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|target_ssp_stp_smp
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|SA_IDFRM_SSP_BIT
operator||
name|SA_IDFRM_STP_BIT
operator||
name|SA_IDFRM_SMP_BIT
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|deviceType_addressFrameType
operator|=
name|AGSA_DEV_TYPE_END_DEVICE
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|phyIdentifier
operator|=
operator|(
name|bit8
operator|)
name|portID
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|target_ssp_stp_smp
operator|=
name|SA_IDFRM_SSP_BIT
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|initiator_ssp_stp_smp
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|deviceType_addressFrameType
operator|=
name|AGSA_DEV_TYPE_END_DEVICE
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|phyIdentifier
operator|=
operator|(
name|bit8
operator|)
name|portID
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|&&
name|defined
argument_list|(
name|TARGET_DRIVER
argument_list|)
comment|/* for combo testing */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|target_ssp_stp_smp
operator|=
name|SA_IDFRM_SSP_BIT
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|SA_IDFRM_SSP_BIT
operator||
name|SA_IDFRM_STP_BIT
operator||
name|SA_IDFRM_SMP_BIT
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|deviceType_addressFrameType
operator|=
name|AGSA_DEV_TYPE_END_DEVICE
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|.
name|phyIdentifier
operator|=
operator|(
name|bit8
operator|)
name|portID
expr_stmt|;
endif|#
directive|endif
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortStart: before pid %d\n"
operator|,
name|portID
operator|)
argument_list|)
expr_stmt|;
name|tdssPrintSASIdentify
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortStart: sysIntsActive %s\n"
operator|,
operator|(
name|tdsaAllShared
operator|->
name|flags
operator|.
name|sysIntsActive
operator|==
name|agTRUE
operator|)
condition|?
literal|"agTRUE"
else|:
literal|"agFALSE"
operator|)
argument_list|)
expr_stmt|;
comment|/* Read global configuration first then card-specific configuration */
comment|/* the following must be processed only once */
if|if
condition|(
name|tdsaAllShared
operator|->
name|first_process
operator|==
name|agFALSE
condition|)
block|{
name|tdsaGetGlobalPhyParams
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
name|tdsaGetCardPhyParams
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|first_process
operator|=
name|agTRUE
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortStart: after pid %d\n"
operator|,
name|portID
operator|)
argument_list|)
expr_stmt|;
name|tdssPrintSASIdentify
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|)
argument_list|)
expr_stmt|;
comment|/*      Phy Calibration   */
if|if
condition|(
name|tdsaAllShared
operator|->
name|phyCalibration
condition|)
block|{
comment|/* Change default phy calibration */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
operator||
literal|0x80
expr_stmt|;
comment|/* Setting index of phy calibration table index        portID is used as phy calibration table index     */
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
operator||
operator|(
name|portID
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortStart: tdsaAllShared->Ports[0x%x].agPhyConfig.phyProperties 0x%x\n"
operator|,
name|portID
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|gSSC_Disable
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator||
literal|0x40000
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart:gSSC_Disable tdsaAllShared->Ports[portID].agPhyConfig.phyProperties 0x%x\n"
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|agPhyConfig
operator|.
name|phyProperties
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tIsSPCV12or6G
argument_list|(
name|agRoot
argument_list|)
operator|&&
operator|!
name|IsSendSASConfigPage
condition|)
comment|/* Not SPC */
block|{
comment|/* call saSetControllerConfig() to set STP_IDLE_TIME; All others are the defaults */
name|osti_memset
argument_list|(
operator|&
name|SASConfigPage
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASProtocolTimerConfigurationPage_t
argument_list|)
argument_list|)
expr_stmt|;
name|SASConfigPage
operator|.
name|pageCode
operator|=
name|AGSA_SAS_PROTOCOL_TIMER_CONFIG_PAGE
expr_stmt|;
name|SASConfigPage
operator|.
name|MST_MSI
operator|=
literal|3
operator|<<
literal|15
expr_stmt|;
comment|/* enables both MCT for SSP target and initiator */
name|SASConfigPage
operator|.
name|STP_SSP_MCT_TMO
operator|=
operator|(
name|tdsaAllShared
operator|->
name|STP_MCT_TMO
operator|<<
literal|16
operator|)
operator||
name|tdsaAllShared
operator|->
name|SSP_MCT_TMO
expr_stmt|;
comment|/* default of 3200 us for STP and SSP maximum connection time */
name|SASConfigPage
operator|.
name|STP_FRM_TMO
operator|=
operator|(
name|tdsaAllShared
operator|->
name|MAX_OPEN_TIME
operator|<<
literal|24
operator|)
operator||
operator|(
name|tdsaAllShared
operator|->
name|SMP_MAX_CONN_TIMER
operator|<<
literal|16
operator|)
operator||
name|tdsaAllShared
operator|->
name|STP_FRM_TMO
expr_stmt|;
comment|/* MAX_OPEN_TIME, SMP_MAX_CONN_TIMER, STP frame timeout */
name|SASConfigPage
operator|.
name|STP_IDLE_TMO
operator|=
name|tdsaAllShared
operator|->
name|stp_idle_time
expr_stmt|;
if|if
condition|(
name|SASConfigPage
operator|.
name|STP_IDLE_TMO
operator|>
literal|0x3FFFFFF
condition|)
block|{
name|SASConfigPage
operator|.
name|STP_IDLE_TMO
operator|=
literal|0x3FFFFFF
expr_stmt|;
block|}
name|SASConfigPage
operator|.
name|OPNRJT_RTRY_INTVL
operator|=
operator|(
name|tdsaAllShared
operator|->
name|MFD
operator|<<
literal|16
operator|)
operator||
name|tdsaAllShared
operator|->
name|OPNRJT_RTRY_INTVL
expr_stmt|;
comment|/* Multi Data Fetach enabled and 2 us for Open Reject Retry interval */
name|SASConfigPage
operator|.
name|Data_Cmd_OPNRJT_RTRY_TMO
operator|=
operator|(
name|tdsaAllShared
operator|->
name|DOPNRJT_RTRY_TMO
operator|<<
literal|16
operator|)
operator||
name|tdsaAllShared
operator|->
name|COPNRJT_RTRY_TMO
expr_stmt|;
comment|/* 128 us for ORR Timeout for DATA phase and 32 us for ORR Timeout for command phase */
name|SASConfigPage
operator|.
name|Data_Cmd_OPNRJT_RTRY_THR
operator|=
operator|(
name|tdsaAllShared
operator|->
name|DOPNRJT_RTRY_THR
operator|<<
literal|16
operator|)
operator||
name|tdsaAllShared
operator|->
name|COPNRJT_RTRY_THR
expr_stmt|;
comment|/* 16 for ORR backoff threshold for DATA phase and 1024 for ORR backoff threshold for command phase */
name|SASConfigPage
operator|.
name|MAX_AIP
operator|=
name|tdsaAllShared
operator|->
name|MAX_AIP
expr_stmt|;
comment|/* MAX AIP. Default is  0x200000 */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: saSetControllerConfig SASConfigPage.pageCode                 0x%08x\n"
operator|,
name|SASConfigPage
operator|.
name|pageCode
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: saSetControllerConfig SASConfigPage.MST_MSI                  0x%08x\n"
operator|,
name|SASConfigPage
operator|.
name|MST_MSI
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: saSetControllerConfig SASConfigPage.STP_SSP_MCT_TMO          0x%08x\n"
operator|,
name|SASConfigPage
operator|.
name|STP_SSP_MCT_TMO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: saSetControllerConfig SASConfigPage.STP_FRM_TMO              0x%08x\n"
operator|,
name|SASConfigPage
operator|.
name|STP_FRM_TMO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: saSetControllerConfig SASConfigPage.STP_IDLE_TMO             0x%08x\n"
operator|,
name|SASConfigPage
operator|.
name|STP_IDLE_TMO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: saSetControllerConfig SASConfigPage.OPNRJT_RTRY_INTVL        0x%08x\n"
operator|,
name|SASConfigPage
operator|.
name|OPNRJT_RTRY_INTVL
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: saSetControllerConfig SASConfigPage.Data_Cmd_OPNRJT_RTRY_TMO 0x%08x\n"
operator|,
name|SASConfigPage
operator|.
name|Data_Cmd_OPNRJT_RTRY_TMO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: saSetControllerConfig SASConfigPage.Data_Cmd_OPNRJT_RTRY_THR 0x%08x\n"
operator|,
name|SASConfigPage
operator|.
name|Data_Cmd_OPNRJT_RTRY_THR
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: saSetControllerConfig SASConfigPage.MAX_AIP                  0x%08x\n"
operator|,
name|SASConfigPage
operator|.
name|MAX_AIP
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|saSetControllerConfig
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|,
name|AGSA_SAS_PROTOCOL_TIMER_CONFIG_PAGE
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASProtocolTimerConfigurationPage_t
argument_list|)
argument_list|,
operator|&
name|SASConfigPage
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: calling saSetControllerConfig() failed\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPortStart: calling saSetControllerConfig() is OK\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|IsSendSASConfigPage
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStart: saSetControllerConfig not called tIsSPCV12or6G %d IsSendSASConfigPage %d\n"
operator|,
name|tIsSPCV12or6G
argument_list|(
name|agRoot
argument_list|)
operator|,
name|IsSendSASConfigPage
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* maps portID to phyID */
name|status
operator|=
name|saPhyStart
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|portID
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|agPhyConfig
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|SASID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortStart: saPhyStart status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMPortStart : calling portstarted\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortStarted
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMPortStart : cant' start port\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tiCOMPortStop * *  Purpose: This function is called to bring the port hardware down. * *  \param  tiRoot:          Pointer to root data structure. *  \param  portalContext:   Pointer to the context for this portal. * *  \return: *          tiSuccess:      Successful. *          Others:             Fail. * *  \note - * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMPortStop
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPortalContext_t
modifier|*
name|portalContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
ifdef|#
directive|ifdef
name|CONTROLLER_STATUS_TESTING
name|agsaControllerStatus_t
name|agcontrollerStatus
decl_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_STATUS_TESTING */
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMPortStop: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     find the portcontext     find phys belonging to that portcotext     call saPhyStop for all those phys     call saPhyStop()     remove the portcontext from the portcontext list   */
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONTROLLER_STATUS_TESTING
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStop: saGetControllerStatus returns 0x%X\n"
operator|,
name|saGetControllerStatus
argument_list|(
name|agRoot
argument_list|,
operator|&
name|agcontrollerStatus
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONTROLLER_INFO_TESTING */
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStop: empty tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* find a right portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStop: onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|tiPortalContext
operator|==
name|portalContext
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPortStop: found; oneportContext ID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStop: No corressponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* reset the fields of portcontext */
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_NOT_STARTED
expr_stmt|;
name|onePortContext
operator|->
name|discoveryOptions
operator|=
name|AG_SA_DISCOVERY_OPTION_FULL_START
expr_stmt|;
endif|#
directive|endif
comment|/* INITIATOR_DRIVER */
name|onePortContext
operator|->
name|Count
operator|=
literal|0
expr_stmt|;
name|onePortContext
operator|->
name|agContext
operator|.
name|osData
operator|=
name|onePortContext
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|portContext
operator|=
name|agNULL
expr_stmt|;
ifdef|#
directive|ifdef
name|CCFLAGS_PHYCONTROL_COUNTS
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
operator|&
name|onePortContext
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
name|AGSA_PHY_GET_ERROR_COUNTS
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
operator|&
name|onePortContext
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
name|AGSA_PHY_CLEAR_ERROR_COUNTS
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
operator|&
name|onePortContext
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
name|i
argument_list|,
name|AGSA_PHY_GET_BW_COUNTS
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"\ntiCOMPortStop: CCFLAGS_PHYCONTROL_COUNTS PHY %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|saGetPhyProfile
argument_list|(
name|agRoot
argument_list|,
operator|&
name|onePortContext
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
name|AGSA_SAS_PHY_ERR_COUNTERS_PAGE
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|saGetPhyProfile
argument_list|(
name|agRoot
argument_list|,
operator|&
name|onePortContext
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
name|AGSA_SAS_PHY_BW_COUNTERS_PAGE
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|saGetPhyProfile
argument_list|(
name|agRoot
argument_list|,
operator|&
name|onePortContext
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
name|AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|saGetPhyProfile
argument_list|(
name|agRoot
argument_list|,
operator|&
name|onePortContext
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
name|AGSA_SAS_PHY_GENERAL_STATUS_PAGE
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|saGetPhyProfile
argument_list|(
name|agRoot
argument_list|,
operator|&
name|onePortContext
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
name|AGSA_SAS_PHY_ERR_COUNTERS_CLR_PAGE
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPortStop: CCFLAGS_PHYCONTROL_COUNTS PHY %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CCFLAGS_PHYCONTROL_COUNTS */
name|saPhyStop
argument_list|(
name|agRoot
argument_list|,
operator|&
name|onePortContext
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tiCOMGetPortInfo * *  Purpose:  This function is called to return information about the specific *            port instant * * *  \param   tiRoot:        Pointer to driver/port instance. *  \param   portalContext  Pointer to the context for this portal. *  \param   tiPortInfo:    Pointer to port information structure. * *  \Return: tiSuccess * *****************************************************************************/
end_comment

begin_comment
comment|/*   can't find tdsaportcontext in this function   since discovery has not been called by OS layer yet   Therefore, hardcoded value are being returned for now */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMGetPortInfo
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPortalContext_t
modifier|*
name|portalContext
parameter_list|,
name|tiPortInfo_t
modifier|*
name|tiPortInfo
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
specifier|static
name|bit8
name|localname
index|[
literal|68
index|]
decl_stmt|,
name|remotename
index|[
literal|68
index|]
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMGetPortInfo: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMGetPortInfo: No tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
comment|/* find a corresponding portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMGetPortInfo: oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|tiPortalContext
operator|==
name|portalContext
operator|&&
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMGetPortInfo: found; oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMGetPortInfo: First, No corresponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMGetPortInfo: Second, No corressponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|osti_memset
argument_list|(
name|localname
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|localname
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|remotename
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|remotename
argument_list|)
argument_list|)
expr_stmt|;
comment|/*     Parse the type of port then fill in the information   */
if|if
condition|(
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|==
literal|0xFFFFFFFF
operator|&&
name|onePortContext
operator|->
name|sasRemoteAddressLo
operator|==
literal|0xFFFFFFFF
condition|)
block|{
comment|/* directly attached SATA port */
name|osti_memcpy
argument_list|(
name|localname
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|localname
index|[
literal|4
index|]
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tiPortInfo
operator|->
name|localNameLen
operator|=
literal|8
expr_stmt|;
comment|/* information is from SATA ID device data. remoteName is serial number, firmware version, model number */
name|osti_memcpy
argument_list|(
name|remotename
argument_list|,
name|onePortContext
operator|->
name|remoteName
argument_list|,
literal|68
argument_list|)
expr_stmt|;
name|tiPortInfo
operator|->
name|remoteNameLen
operator|=
literal|68
expr_stmt|;
block|}
else|else
block|{
comment|/* copy hi address and low address */
name|osti_memcpy
argument_list|(
name|localname
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|localname
index|[
literal|4
index|]
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tiPortInfo
operator|->
name|localNameLen
operator|=
literal|8
expr_stmt|;
name|osti_memcpy
argument_list|(
name|remotename
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|remotename
index|[
literal|4
index|]
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|sasRemoteAddressLo
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tiPortInfo
operator|->
name|remoteNameLen
operator|=
literal|8
expr_stmt|;
block|}
name|tiPortInfo
operator|->
name|localName
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|localname
expr_stmt|;
name|tiPortInfo
operator|->
name|remoteName
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|remotename
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMSetControllerConfig * *  Purpose:  This function is called to set the controller's advanced configuration. *            The status is reported via ostiPortEvent(). * *  Parameters: * *    tiRoot:        Pointer to driver/port instance. * *  Return: *     tiSuccess:  The setting controller configuration was started. *     tiError:    The setting controller configuration was not started. * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMSetControllerConfig
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|modePage
parameter_list|,
name|bit32
name|length
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|bit32
name|returnCode
init|=
name|AGSA_RC_BUSY
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiSuccess
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|TD_ASSERT
argument_list|(
name|tiRoot
argument_list|,
literal|"tiRoot"
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaRoot
argument_list|,
literal|"tdsaRoot"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
argument_list|,
literal|"tdsaAllShared"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
argument_list|,
literal|"agRoot"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMSetControllerConfig:\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*do some sanity checking */
if|if
condition|(
operator|(
operator|(
name|modePage
operator|==
name|TI_INTERRUPT_CONFIGURATION_PAGE
operator|)
operator|&&
operator|(
name|length
operator|!=
sizeof|sizeof
argument_list|(
name|tiInterruptConfigPage_t
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|modePage
operator|==
name|TI_ENCRYPTION_GENERAL_CONFIG_PAGE
operator|)
operator|&&
operator|(
name|length
operator|!=
sizeof|sizeof
argument_list|(
name|tiEncryptGeneralPage_t
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|modePage
operator|==
name|TI_ENCRYPTION_DEK_CONFIG_PAGE
operator|)
operator|&&
operator|(
name|length
operator|!=
sizeof|sizeof
argument_list|(
name|tiEncryptDekConfigPage_t
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|modePage
operator|==
name|TI_ENCRYPTION_CONTROL_PARM_PAGE
operator|)
operator|&&
operator|(
name|length
operator|!=
sizeof|sizeof
argument_list|(
name|tiEncryptControlParamPage_t
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|modePage
operator|==
name|TI_ENCRYPTION_HMAC_CONFIG_PAGE
operator|)
operator|&&
operator|(
name|length
operator|!=
sizeof|sizeof
argument_list|(
name|tiEncryptHMACConfigPage_t
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|modePage
operator|==
name|TI_SAS_PROTOCOL_TIMER_CONFIG_PAGE
operator|)
operator|&&
operator|(
name|length
operator|!=
sizeof|sizeof
argument_list|(
name|tiSASProtocolTimerConfigurationPage_t
argument_list|)
operator|)
operator|)
condition|)
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
else|else
block|{
name|returnCode
operator|=
name|saSetControllerConfig
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|,
name|modePage
argument_list|,
name|length
argument_list|,
name|buffer
argument_list|,
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMGetControllerConfig * *  Purpose:  This function is called to get the controller's advanced configuration. *            The status is reported via ostiPortEvent(). * *  Parameters: * *    tiRoot:        Pointer to driver/port instance. *    flag:          Interrupt  Vector Mask *                   This parameter is valid only when modePage is set to TI_INTERRUPT_CONFIGURATION_PAGE. *                   When the modePage field is set to TI_INTERRUPT_CONFIGURATION_PAGE, *                   this field contains a bitmap of interrupt vectors for which interrupt coalescing parameters are retrieved. *  Return: *     tiSuccess:  The controller configuration retrival was started. *     tiError:    The controller configuration retrival was not started. * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMGetControllerConfig
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|modePage
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|bit32
name|returnCode
init|=
name|AGSA_RC_BUSY
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiSuccess
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|TD_ASSERT
argument_list|(
name|tiRoot
argument_list|,
literal|"tiRoot"
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaRoot
argument_list|,
literal|"tdsaRoot"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
argument_list|,
literal|"tdsaAllShared"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
argument_list|,
literal|"agRoot"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMGetControllerConfig: modePage 0x%x context %p\n"
operator|,
name|modePage
operator|,
name|context
operator|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|saGetControllerConfig
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|,
name|modePage
argument_list|,
name|flag
argument_list|,
literal|0
argument_list|,
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMGetControllerConfig:modePage 0x%x tiSuccess\n"
operator|,
name|modePage
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMGetControllerConfig:modePage 0x%x tiBusy\n"
operator|,
name|modePage
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMGetControllerConfig:modePage 0x%x tiError\n"
operator|,
name|modePage
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMEncryptGetInfo * *  Purpose:  This function is called to return information about the encryption *            engine for the specified port. * *  Parameters: * *    tiRoot:        Pointer to driver/port instance. * *  Return: *   tiSuccess       The request is being processed *   tiNotSupported  Encryption is not supported * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMEncryptGetInfo
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tiEncryptInfo_t
name|tiEncryptInfo
decl_stmt|;
name|agsaEncryptInfo_t
name|agsaEncryptInfo
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tiEncryptPort_t
name|tiEncryptPort
decl_stmt|;
name|bit32
name|returnCode
decl_stmt|;
name|bit32
name|tiStatus
decl_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|returnCode
operator|=
name|saEncryptGetMode
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
name|agsaEncryptInfo
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptGetInfo: returnCode 0x%x\n"
operator|,
name|returnCode
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
comment|/*        * The data encoded in the agsaEncryptInfo must be converted        * to match the fields of the tiEncryptInfo structure.        *        * No sector information is currently available.        */
name|osti_memset
argument_list|(
operator|&
name|tiEncryptInfo
argument_list|,
literal|0x0
argument_list|,
sizeof|sizeof
argument_list|(
name|tiEncryptInfo_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* cipher mode */
if|if
condition|(
name|agsaEncryptInfo
operator|.
name|encryptionCipherMode
operator|==
name|agsaEncryptCipherModeXTS
condition|)
block|{
name|tiEncryptInfo
operator|.
name|securityCipherMode
operator|=
name|TI_ENCRYPT_ATTRIB_CIPHER_XTS
expr_stmt|;
block|}
comment|/* security mode */
if|if
condition|(
name|agsaEncryptInfo
operator|.
name|encryptionSecurityMode
operator|==
name|agsaEncryptSMF
condition|)
block|{
name|tiEncryptInfo
operator|.
name|securityCipherMode
operator||=
name|TI_ENCRYPT_SEC_MODE_FACT_INIT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agsaEncryptInfo
operator|.
name|encryptionSecurityMode
operator|==
name|agsaEncryptSMA
condition|)
block|{
name|tiEncryptInfo
operator|.
name|securityCipherMode
operator||=
name|TI_ENCRYPT_SEC_MODE_A
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agsaEncryptInfo
operator|.
name|encryptionSecurityMode
operator|==
name|agsaEncryptSMB
condition|)
block|{
name|tiEncryptInfo
operator|.
name|securityCipherMode
operator||=
name|TI_ENCRYPT_SEC_MODE_B
expr_stmt|;
block|}
name|tiEncryptInfo
operator|.
name|status
operator|=
name|agsaEncryptInfo
operator|.
name|status
expr_stmt|;
name|tiEncryptPort
operator|.
name|pData
operator|=
operator|&
name|tiEncryptInfo
expr_stmt|;
comment|/* The low level returns synchronously, so fake a port event now.*/
name|tiEncryptPort
operator|.
name|encryptEvent
operator|=
name|tiEncryptGetInfo
expr_stmt|;
name|tiEncryptPort
operator|.
name|subEvent
operator|=
literal|0
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiEncryptOperation
argument_list|,
name|tiStatus
argument_list|,
operator|&
name|tiEncryptPort
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_NOT_SUPPORTED
condition|)
block|{
name|tiStatus
operator|=
name|tiNotSupported
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptGetInfo: tiNotSupported\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptGetInfo: tiError returnCode 0x%x\n"
operator|,
name|returnCode
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
name|tiEncryptPort
operator|.
name|pData
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMEncryptSetMode * *  Purpose:  This function is called to set the encryption security and cipher modes *            for the encryption engine. * *  Parameters: * *    tiRoot:        Pointer to driver/port instance. * *  Return: *   tiSuccess       The request is being processed *   tiError         The encryption engine is not in factory init mode or multiple *                   security modes were specified. * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMEncryptSetMode
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|securityCipherMode
parameter_list|)
block|{
name|bit32
name|returnCode
decl_stmt|;
name|bit32
name|tiStatus
decl_stmt|;
name|agsaEncryptInfo_t
name|mode
decl_stmt|;
name|agsaEncryptInfo_t
modifier|*
name|pmode
init|=
operator|&
name|mode
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|TD_ASSERT
argument_list|(
name|tiRoot
argument_list|,
literal|"tiRoot"
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaRoot
argument_list|,
literal|"tdsaRoot"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
argument_list|,
literal|"tdsaAllShared"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
argument_list|,
literal|"agRoot"
argument_list|)
expr_stmt|;
name|pmode
operator|->
name|encryptionSecurityMode
operator|=
literal|0
expr_stmt|;
name|pmode
operator|->
name|encryptionCipherMode
operator|=
literal|0
expr_stmt|;
name|pmode
operator|->
name|status
operator|=
literal|0
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptSetMode:\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|securityCipherMode
operator|&
name|TI_ENCRYPT_SEC_MODE_A
operator|)
operator|==
name|TI_ENCRYPT_SEC_MODE_A
condition|)
block|{
name|pmode
operator|->
name|encryptionSecurityMode
operator|=
name|agsaEncryptSMA
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|securityCipherMode
operator|&
name|TI_ENCRYPT_SEC_MODE_B
operator|)
operator|==
name|TI_ENCRYPT_SEC_MODE_B
condition|)
block|{
name|pmode
operator|->
name|encryptionSecurityMode
operator|=
name|agsaEncryptSMB
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|securityCipherMode
operator|&
name|TI_ENCRYPT_ATTRIB_CIPHER_XTS
operator|)
operator|==
name|TI_ENCRYPT_ATTRIB_CIPHER_XTS
condition|)
block|{
name|pmode
operator|->
name|encryptionCipherMode
operator||=
name|agsaEncryptCipherModeXTS
expr_stmt|;
block|}
comment|/* ECB is not supported in SPCv */
if|if
condition|(
operator|(
name|securityCipherMode
operator|&
name|TI_ENCRYPT_ATTRIB_CIPHER_ECB
operator|)
operator|==
name|TI_ENCRYPT_ATTRIB_CIPHER_ECB
condition|)
block|{
return|return
name|tiError
return|;
block|}
name|returnCode
operator|=
name|saEncryptSetMode
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|pmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptSetMode:tiBusy\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptSetMode:tiError\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMEncryptDekAdd * *  Purpose:  This function is called to add a DEK to the controller cache. * *  Parameters: * *    tiRoot:          Pointer to driver/port instance. *    kekIndext:         Index of the KEK table *    dekTableSelect:  Number of the DEK table receiving a new entry *    dekAddrHi:       Upper 32-bits of the DEK table physical address *    dekAddrLo:       Lower 32-bits of the DEK table physical address *    dekIndex:        Number of the first entry in the DEK table that will inserted in the cache *    dekNumberOfEntries: Number of entries to be inserted in the cache *    dekBlobFormat:     Specifies the DEK blob format *    dekTableKeyEntrySize: Encoded value for DEK Entry Size in the DEK Table * *  Return: *   tiSuccess       The request is being processed *   tiError         An invalid parameter was specified * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMEncryptDekAdd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|kekIndex
parameter_list|,
name|bit32
name|dekTableSelect
parameter_list|,
name|bit32
name|dekAddrHi
parameter_list|,
name|bit32
name|dekAddrLo
parameter_list|,
name|bit32
name|dekIndex
parameter_list|,
name|bit32
name|dekNumberOfEntries
parameter_list|,
name|bit32
name|dekBlobFormat
parameter_list|,
name|bit32
name|dekTableKeyEntrySize
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|bit32
name|returnCode
decl_stmt|;
name|bit32
name|tiStatus
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|TD_ASSERT
argument_list|(
name|tiRoot
argument_list|,
literal|"tiRoot"
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaRoot
argument_list|,
literal|"tdsaRoot"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
argument_list|,
literal|"tdsaAllShared"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
argument_list|,
literal|"agRoot"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptDekAdd:\n"
operator|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|saEncryptDekCacheUpdate
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|kekIndex
argument_list|,
name|dekTableSelect
argument_list|,
name|dekAddrHi
argument_list|,
name|dekAddrLo
argument_list|,
name|dekIndex
argument_list|,
name|dekNumberOfEntries
argument_list|,
name|dekBlobFormat
argument_list|,
name|dekTableKeyEntrySize
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMEncryptDekInvalidate * *  Purpose:  This function is called to remove a DEK entry from the hardware cache. * *  Parameters: * *    tiRoot:        Pointer to driver/port instance. *    dekTable       DEK table that will be affected *    dekIndex:      DEK table entry that will be affected. The value 0xfffffff clears the cache. * *  Return: *   tiSuccess       The request is being processed *   tiError         An invalid parameter was specified *   tiBusy          An operation is already in progress * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMEncryptDekInvalidate
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|dekTable
parameter_list|,
name|bit32
name|dekIndex
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tiEncryptPort_t
name|tiEncryptPort
decl_stmt|;
name|tiEncryptDek_t
name|tiEncryptDek
decl_stmt|;
name|bit32
name|returnCode
decl_stmt|;
name|bit32
name|tiStatus
decl_stmt|;
name|TD_ASSERT
argument_list|(
name|tiRoot
argument_list|,
literal|"tiRoot"
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaRoot
argument_list|,
literal|"tdsaRoot"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
argument_list|,
literal|"tdsaAllShared"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
argument_list|,
literal|"agRoot"
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptDekInvalidate:dekTable 0x%x dekIndex 0x%x\n"
operator|,
name|dekTable
operator|,
name|dekIndex
operator|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|saEncryptDekCacheInvalidate
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|dekTable
argument_list|,
name|dekIndex
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_NOT_SUPPORTED
condition|)
block|{
name|tiStatus
operator|=
name|tiNotSupported
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
name|tiEncryptDek
operator|.
name|dekTable
operator|=
name|dekTable
expr_stmt|;
name|tiEncryptDek
operator|.
name|dekIndex
operator|=
name|dekIndex
expr_stmt|;
name|tiEncryptPort
operator|.
name|encryptEvent
operator|=
name|tiEncryptDekInvalidate
expr_stmt|;
name|tiEncryptPort
operator|.
name|subEvent
operator|=
literal|0
expr_stmt|;
name|tiEncryptPort
operator|.
name|pData
operator|=
operator|(
name|void
operator|*
operator|)
operator|&
name|tiEncryptDek
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiEncryptOperation
argument_list|,
name|tiStatus
argument_list|,
operator|&
name|tiEncryptPort
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMEncryptKekAdd * *  Purpose:  This function is called to add a KEK in the register specified by *            the index parameter. * *  Parameters: * *    tiRoot:           Pointer to driver/port instance. *    kekIndex:         KEK table entry that will be affected *    wrapperKekIndex   KEK table entry that encrypt the KEK blob *    encryptKekBlob    KEK blob that will be added * *  Return: *   tiSuccess       The request is being processed *   tiError         An invalid parameter was specified *   tiBusy          A KEK operation is already in progress * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMEncryptKekAdd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|kekIndex
parameter_list|,
name|bit32
name|wrapperKekIndex
parameter_list|,
name|bit32
name|blobFormat
parameter_list|,
name|tiEncryptKekBlob_t
modifier|*
name|encryptKekBlob
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|bit32
name|returnCode
init|=
name|AGSA_RC_BUSY
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptDekInvalidate: kekIndex 0x%x wrapperKekIndex 0x%x\n"
operator|,
name|kekIndex
operator|,
name|wrapperKekIndex
operator|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|saEncryptKekUpdate
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|AGSA_ENCRYPT_STORE_NVRAM
argument_list|,
name|kekIndex
argument_list|,
name|wrapperKekIndex
argument_list|,
name|blobFormat
argument_list|,
operator|(
name|agsaEncryptKekBlob_t
operator|*
operator|)
name|encryptKekBlob
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HIALEAH_ENCRYPTION
end_ifdef

begin_function
name|osGLOBAL
name|bit32
name|tiCOMEncryptHilSet
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agsaEncryptInfo_t
name|agsaEncryptInfo
decl_stmt|;
name|bit32
name|returnCode
init|=
name|tiBusy
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|returnCode
operator|=
name|saEncryptGetMode
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
name|agsaEncryptInfo
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptHilSet: saEncryptGetMode returnCode 0x%x agsaEncryptInfo status 0x%x Smode 0x%x CMode 0x%x\n"
operator|,
name|returnCode
operator|,
name|agsaEncryptInfo
operator|.
name|status
operator|,
name|agsaEncryptInfo
operator|.
name|encryptionSecurityMode
operator|,
name|agsaEncryptInfo
operator|.
name|encryptionCipherMode
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptHilSet:agsaEncryptInfo.status 0x%x\n"
operator|,
name|agsaEncryptInfo
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agsaEncryptInfo
operator|.
name|status
operator|==
literal|0x81
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptHilSet: status 0x80 KEY CARD MISMATCH agsaEncryptInfo.status 0x%x\n"
operator|,
name|agsaEncryptInfo
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|saEncryptHilUpdate
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptHilSet:AGSA_RC_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|agsaEncryptInfo
operator|.
name|status
operator|==
literal|0x80
condition|)
block|{
name|ostidisableEncryption
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptHilSet: status 0x80 KEY CARD MISSING agsaEncryptInfo.status 0x%x\n"
operator|,
name|agsaEncryptInfo
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|AGSA_RC_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptHilSet: not status 0x81 agsaEncryptInfo.status 0x%x\n"
operator|,
name|agsaEncryptInfo
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptHilSet:AGSA_RC_BUSY\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptHilSet:tiError\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HIALEAH_ENCRYPTION */
end_comment

begin_comment
comment|/***************************************************************************** * * tiCOMEncryptKekStore * *  Purpose:  This function is called to store a KEK in NVRAM. If -1 is specified *            as the KEK index, then all KEKs will be stored. * *  Parameters: * *    tiRoot:        Pointer to driver/port instance. *    kekIndex:      The KEK to be stored in NVRAM * *  Return: *   tiSuccess       The request is being processed *   tiError         An invalid parameter was specified *   tiBusy          A KEK operation is already in progress * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMEncryptKekStore
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|kekIndex
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|NOT_YET
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
endif|#
directive|endif
comment|/*     bit32           returnCode= AGSA_RC_BUSY; */
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptKekStore: Needs code !!!! kekIndex 0x%x\n"
operator|,
name|kekIndex
operator|)
argument_list|)
expr_stmt|;
comment|/*     returnCode = fcEncryptKekStore(agRoot, kekIndex);      if (returnCode == AGSA_RC_SUCCESS)     {         tiStatus = tiSuccess;     }     else if (returnCode == AGSA_RC_BUSY)     {         tiStatus = tiBusy;     }     else     {         tiStatus;     } */
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMEncryptKekLoad * *  Purpose:  This function is called to load a KEK from NVRAM. If -1 is specified *            as the KEK index, then all KEKs will be loaded. * *  Parameters: * *    tiRoot:        Pointer to driver/port instance. *    kekIndex:      The KEK to be loaded in NVRAM * *  Return: *   tiSuccess       The request is being processed *   tiError         An invalid parameter was specified *   tiBusy          A KEK operation is already in progress * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMEncryptKekLoad
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|kekIndex
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|NOT_YET
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
comment|//bit32           returnCode;
endif|#
directive|endif
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
endif|#
directive|endif
comment|/*     returnCode = fcEncryptKekLoad(agRoot, kekIndex);      if (returnCode == AGSA_RC_SUCCESS)     {         tiStatus = tiSuccess;     }     else if (returnCode == AGSA_RC_BUSY)     {         tiStatus = tiBusy;     }     else     {         tiStatus = tiError;     } */
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMEncryptSelfTest * *  Purpose:  This function starts the encryption self test. For the encryption self test, IOs must be quiesced. *                The completion of this function is via ostiPortEvent(). * *  Parameters: * *    tiRoot:      Pointer to driver/port instance. *    type:        Types of test                       0x1: tiBISTTest                       0x2: tiHMACTest                       Others are reserved. *    length:                    Size of the test descriptor in bytes, e.g.,                    Sizeof(tiEncryptSelfTestDescriptor_t)                    Sizeof(tiEncryptHMACTestDescriptor_t) *    TestDescriptor       address of the test descriptor structure. * *  Return: *   tiSuccess     The request is being processed *   tiError          An invalid parameter was specified *   tiBusy          A encrytion operation is already in progress * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMEncryptSelfTest
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|type
parameter_list|,
name|bit32
name|length
parameter_list|,
name|void
modifier|*
name|TestDescriptor
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
name|agNULL
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|bit32
name|returnCode
init|=
name|AGSA_RC_BUSY
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaRoot
operator|!=
name|agNULL
argument_list|,
literal|"tdsaRoot is NULL !!!"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
operator|!=
name|agNULL
argument_list|,
literal|"tdsaAllShared is NULL !!!"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
operator|!=
name|agNULL
argument_list|,
literal|"agRoot is NULL !!!"
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptSelfTest: type =  0x%x length = 0x%x\n"
operator|,
name|type
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
comment|/*do some sanity checking */
if|if
condition|(
operator|(
operator|(
name|type
operator|==
name|TI_ENCRYPTION_TEST_TYPE_BIST
operator|)
operator|&&
operator|(
name|length
operator|!=
sizeof|sizeof
argument_list|(
name|tiEncryptSelfTestDescriptor_t
argument_list|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|type
operator|==
name|TI_ENCRYPTION_TEST_TYPE_HMAC
operator|)
operator|&&
operator|(
name|length
operator|!=
sizeof|sizeof
argument_list|(
name|tiEncryptHMACTestDescriptor_t
argument_list|)
operator|)
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMEncryptSelfTest: type or length error, type 0x%x length 0x%x\n"
operator|,
name|type
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
else|else
block|{
name|returnCode
operator|=
name|saEncryptSelftestExecute
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|type
argument_list|,
name|length
argument_list|,
name|TestDescriptor
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMSetOperator * *  Purpose:  This function is called to login to or logout out from the controller by an operator.                   The status is reported via ostiPortEvent(). * *  Parameters: * *    tiRoot:      Pointer to driver/port instance. *    flag:         operator flag.                      Bits 0-3: Access type (ACS)                        0x1: Login                        0x2: Logout                        All others are reserved.                      Bit 4: KEYopr pinned in the KEK table (PIN)                        0: Not pinned. Operator ID table will be searched during authentication.                        1: Pinned. OPRIDX is referenced to unwrap the certificate.                      Bits 5-7: Reserved                      Bits 8-15: KEKopr Index in the KEK Table (OPRIDX). If KEKopr is pinned in the KEK table, OPRIDX is to reference the KEK for authentication                      Bits 16-31: Reserved.       cert:         The pointer to the operator's certificate. The size of the certificate is 40 bytes. * *  Return: *   tiSuccess     Log in or log out was started. *   tiError          Log in or log out was not started. *   tiBusy          A operator management operation is already in progress * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMSetOperator
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|void
modifier|*
name|cert
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
name|agNULL
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|bit32
name|returnCode
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaRoot
operator|!=
name|agNULL
argument_list|,
literal|"tdsaRoot is NULL !!!"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
operator|!=
name|agNULL
argument_list|,
literal|"tdsaAllShared is NULL !!!"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
operator|!=
name|agNULL
argument_list|,
literal|"agRoot is NULL !!!"
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMSetOperator: flag =  0x%x \n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|saSetOperator
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|flag
argument_list|,
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMGetOperator * *  Purpose:  This function is used to retrieve the role and ID of the current operator or all operators.                   The status is reported via ostiPortEvent(). * *  Parameters: * *    tiRoot:      Pointer to driver/port instance. *    option:     Types of get operations                        0x1: Current operator only                        0x2: All operators                        All others are reserved.       AddrHi      Upper 32-bit host physical address to store operator certificates.                     This field is used only when option is 0x2       AddrLo     Lower 32-bit host physical address to store operator certificates.                     This field is used only when option is 0x2 * *  Return: *   tiSuccess     The operation was started.. *   tiError          The operation was not started. *   tiBusy          A operator management operation is already in progress * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMGetOperator
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|option
parameter_list|,
name|bit32
name|AddrHi
parameter_list|,
name|bit32
name|AddrLo
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
name|agNULL
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|bit32
name|returnCode
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaRoot
operator|!=
name|agNULL
argument_list|,
literal|"tdsaRoot is NULL !!!"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
operator|!=
name|agNULL
argument_list|,
literal|"tdsaAllShared is NULL !!!"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
operator|!=
name|agNULL
argument_list|,
literal|"agRoot is NULL !!!"
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMGetOperator: option = 0x%x \n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|saGetOperator
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|option
argument_list|,
name|AddrHi
argument_list|,
name|AddrLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tiCOMOperationManagement * *  Purpose:  this function is used to manage operators,  e.g. adding or deleting an operator.. * *  Parameters: * *   tiRoot:      Pointer to driver/port instance. *   flag:         operation flag.                     Bits 0-7: Operator Management Operation(OMO)                        0: Add an operator.                        1: Delete an operator.                        2: Delete all operators.                        Others are reserved.                     Bit 8: Pinned to KEK RAM (PKR)                       0: Operator's KEK is stored in the operator ID table(OID_TLB) only.                       1: Operator's KEK is pinned to the internal KEK RAM (1 of the 16 entries) and is also stored in OID_TLB.                     Bits 9-10: KEKopr blob format (KBF)                       00b: Reserved.                       01b: AGSA_ENCRYPTED_KEK_PMCA.                       10b: AGSA_ENCRYPTED_KEK_PMCB.                       11b: Reserved.                     Bits 11-15: Reserved                     Bits 16-23: KEKauth Index in the KEK Table (AUTIDX)                     Bits 24-31: KEKopr Index in the KEK Table (OPRIDX). This field is valid only when PKR is 1.         role        Role                        01b: Crypto officer role.                        10b: User role.                        All others are reserved.  *    idString:         Pointer to the tiID_t structure describing the ID string *    kekBlob          Pointer to the tiEncryptKekBlob_t structure describing KBLOB. * *  Return: *   tiSuccess     The request is being processed *   tiError          An invalid parameter was specified *   tiBusy          A operator management operation is already in progress * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMOperatorManagement
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|bit8
name|role
parameter_list|,
name|tiID_t
modifier|*
name|idString
parameter_list|,
name|tiEncryptKekBlob_t
modifier|*
name|kekBlob
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
name|agNULL
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|bit32
name|returnCode
init|=
name|AGSA_RC_BUSY
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaRoot
operator|!=
name|agNULL
argument_list|,
literal|"tdsaRoot is NULL !!!"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
operator|!=
name|agNULL
argument_list|,
literal|"tdsaAllShared is NULL !!!"
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
operator|!=
name|agNULL
argument_list|,
literal|"agRoot is NULL !!!"
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMOperatorManagement: flag =  0x%x role = 0x%x\n"
operator|,
name|flag
operator|,
name|role
operator|)
argument_list|)
expr_stmt|;
name|returnCode
operator|=
name|saOperatorManagement
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|flag
argument_list|,
name|role
argument_list|,
operator|(
name|agsaID_t
operator|*
operator|)
name|idString
argument_list|,
operator|(
name|agsaEncryptKekBlob_t
operator|*
operator|)
name|kekBlob
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|returnCode
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
operator|(
name|tiStatus
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdssRemoveSASSATAFromSharedcontext * *  Purpose:  This function removes all discovered devices belonging to *            a given portcontext from device list * * *  \param   agRoot                   Pointer to the root data structure of *                                    TD and Lower layer *  \param   tsddPortContext_Instance Pointer to the target port context * *  \Return: none * *****************************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_comment
comment|/*TBD: added to compile tgt_drv. (TP)*/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssRemoveSASSATAFromSharedcontext
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|PortContext_Instance
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontext: pid %d\n"
operator|,
name|PortContext_Instance
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* find oneDeviceData belonging to the portcontext */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontext: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|PortContext_Instance
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontext: pid %d did %d\n"
operator|,
name|PortContext_Instance
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontext: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontext: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* reset valid bit */
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
comment|/* notify only reported devices to OS layer*/
if|if
condition|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|PortContext_Instance
operator|->
name|tiPortalContext
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceRemoval
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
comment|/* to-do: deregister */
ifdef|#
directive|ifdef
name|REMOVED
comment|/* don't remove device from the device list. May screw up ordering */
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontext: move to the next\n"
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
comment|/* while */
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdssRemoveSASSATAFromSharedcontextByReset * *  Purpose:  This function removes all ports and discovered devices * * *  \param   agRoot                   Pointer to the root data structure of *                                    TD and Lower layer * *  \Return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssRemoveSASSATAFromSharedcontextByReset
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|dmRoot_t
modifier|*
name|dmRoot
init|=
name|agNULL
decl_stmt|;
name|dmPortContext_t
modifier|*
name|dmPortContext
init|=
name|agNULL
decl_stmt|;
name|dmPortInfo_t
name|dmPortInfo
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot_t
modifier|*
name|smRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontextByReset: start\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|dmRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
expr_stmt|;
endif|#
directive|endif
comment|/* looping throuhg all portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontextByReset: onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontextByReset: oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontextByReset: sasAddressHi 0x%08x\n"
operator|,
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontextByReset: sasAddressLo 0x%08x\n"
operator|,
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
if|if
condition|(
name|onePortContext
operator|->
name|UseDM
operator|==
name|agTRUE
condition|)
block|{
name|dmPortContext
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|dmPortContext
operator|)
expr_stmt|;
name|dmDestroyPort
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
operator|&
name|dmPortInfo
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|tdsaPortContextReInit
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
comment|/* reinitialize the device data belonging to this portcontext */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontextByReset: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontextByReset: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontextByReset: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSASSATAFromSharedcontextByReset: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|smDeviceHandle
operator|=
operator|(
name|smDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
expr_stmt|;
name|smDeregisterDevice
argument_list|(
name|smRoot
argument_list|,
name|agDevHandle
argument_list|,
name|smDeviceHandle
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|tdsaDeviceDataReInit
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
comment|/* no dequeue from Mainlink for consistant ordering of devices */
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *! \brief tdssAddSASToSharedcontext * *  Purpose:  This function adds a discovered device to a device list of *            a shared context * *  \param   tsddPortContext_Instance Pointer to the target port context *  \param   agRoot                   Pointer to the root data structure of *                                    TD and Lower layer *  \param   agDevHandle              Pointer to a device handle * *  \Return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssAddSASToSharedcontext
parameter_list|(
name|tdsaPortContext_t
modifier|*
name|tdsaPortContext_Instance
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
comment|/* this is NULL */
name|tdsaSASSubID_t
modifier|*
name|agSASSubID
parameter_list|,
name|bit32
name|registered
parameter_list|,
comment|/* no longer in use */
name|bit8
name|phyID
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|new_device
init|=
name|agTRUE
decl_stmt|;
name|bit32
name|Indenom
init|=
name|tdsaAllShared
operator|->
name|QueueConfig
operator|.
name|numInboundQueues
decl_stmt|;
name|bit32
name|Outdenom
init|=
name|tdsaAllShared
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
decl_stmt|;
name|bit8
name|dev_s_rate
init|=
literal|0
decl_stmt|;
name|bit8
name|sasorsata
init|=
literal|1
decl_stmt|;
name|bit8
name|connectionRate
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     find a right portcontext     then, get devicedata from FreeLink in DeviceList     then, do pointer operations     then, add the devicedata to the portcontext   */
comment|/* find a right portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|tdsaPortContext_Instance
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssAddSASToSharedContext: found; oneportContext ID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: found pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: Error!!! no portcontext found!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|agSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|agSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|new_device
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* new device */
if|if
condition|(
name|new_device
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: new device\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TDLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSASToSharedContext: empty DeviceData FreeLink\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|DeviceListList
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|FreeLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: oneDeviceData %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|Count
operator|++
expr_stmt|;
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SAS_DEVICE
expr_stmt|;
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
if|if
condition|(
name|flag
operator|==
name|TD_OPERATION_TARGET
condition|)
block|{
name|oneDeviceData
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
name|agDevHandle
operator|->
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
comment|/* TD layer */
block|}
comment|/* saving sas address */
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|=
name|agSASSubID
operator|->
name|sasAddressLo
expr_stmt|;
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|=
name|agSASSubID
operator|->
name|sasAddressHi
expr_stmt|;
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
comment|/* new */
name|oneDeviceData
operator|->
name|directlyAttached
operator|=
name|agTRUE
expr_stmt|;
comment|/* parse sasIDframe to fill in agDeviceInfo */
name|DEVINFO_PUT_SMPTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|DEFAULT_SMP_TIMEOUT
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_ITNEXUSTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|tdsaAllShared
operator|->
name|itNexusTimeout
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FBS
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* enable TLR */
name|DEVINFO_PUT_FLAG
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sasorsata
operator|=
name|SAS_DEVICE_TYPE
expr_stmt|;
comment|/* SAS target (SAS disk or expander) */
name|connectionRate
operator|=
name|onePortContext
operator|->
name|LinkRate
expr_stmt|;
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
operator|(
name|sasorsata
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
name|connectionRate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_DEV_S_RATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|dev_s_rate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|agSASSubID
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|agSASSubID
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|flag
operator|==
name|TD_OPERATION_INITIATOR
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
if|if
condition|(
name|tdsaAllShared
operator|->
name|sflag
condition|)
block|{
if|if
condition|(
operator|!
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: First, saRegisterNewDevice sflag %d\n"
operator|,
name|tdsaAllShared
operator|->
name|sflag
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||
name|TD_XFER_RDY_PRIORTY_DEVICE_FLAG
expr_stmt|;
block|}
block|}
name|saRegisterNewDevice
argument_list|(
comment|/* tdssAddSASToSharedcontext */
name|agRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|onePortContext
operator|->
name|agPortContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
name|oneDeviceData
operator|->
name|InQID
operator|=
name|oneDeviceData
operator|->
name|id
operator|%
name|Indenom
expr_stmt|;
ifdef|#
directive|ifdef
name|TARGET_DRIVER
block|{
name|bit32
name|localId
init|=
name|oneDeviceData
operator|->
name|id
decl_stmt|;
name|localId
operator|+=
literal|1
expr_stmt|;
name|oneDeviceData
operator|->
name|OutQID
operator|=
name|localId
operator|%
name|Outdenom
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: OutQID %d\n"
operator|,
name|oneDeviceData
operator|->
name|OutQID
operator|)
argument_list|)
expr_stmt|;
comment|/* tdsaRotateQnumber for tgt*/
block|}
endif|#
directive|endif
comment|/* TARGET_DRIVER */
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: SSP target %d STP target %d SATA device %d\n"
operator|,
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* add the devicedata to the portcontext */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssAddSASToSharedContext: one case pid %d did %d \n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssAddSASToSharedContext: new case pid %d did %d phyID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* old device */
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: old device\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: oneDeviceData %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SAS_DEVICE
expr_stmt|;
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
if|if
condition|(
name|flag
operator|==
name|TD_OPERATION_TARGET
condition|)
block|{
name|oneDeviceData
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
name|agDevHandle
operator|->
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
comment|/* TD layer */
block|}
comment|/* saving sas address */
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|=
name|agSASSubID
operator|->
name|sasAddressLo
expr_stmt|;
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|=
name|agSASSubID
operator|->
name|sasAddressHi
expr_stmt|;
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|directlyAttached
operator|=
name|agTRUE
expr_stmt|;
comment|/* new */
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: registering\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* parse sasIDframe to fill in agDeviceInfo */
name|DEVINFO_PUT_SMPTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|DEFAULT_SMP_TIMEOUT
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_ITNEXUSTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|tdsaAllShared
operator|->
name|itNexusTimeout
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FBS
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FLAG
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sasorsata
operator|=
name|SAS_DEVICE_TYPE
expr_stmt|;
comment|/* SAS target (SAS disk or expander) */
name|connectionRate
operator|=
name|onePortContext
operator|->
name|LinkRate
expr_stmt|;
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
operator|(
name|sasorsata
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
name|connectionRate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_DEV_S_RATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|dev_s_rate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|agSASSubID
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|agSASSubID
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|flag
operator|==
name|TD_OPERATION_INITIATOR
condition|)
block|{
if|if
condition|(
name|tdsaAllShared
operator|->
name|sflag
condition|)
block|{
if|if
condition|(
operator|!
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: Second, saRegisterNewDevice sflag %d\n"
operator|,
name|tdsaAllShared
operator|->
name|sflag
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||
name|TD_XFER_RDY_PRIORTY_DEVICE_FLAG
expr_stmt|;
block|}
block|}
name|saRegisterNewDevice
argument_list|(
comment|/* tdssAddSASToSharedcontext */
name|agRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|onePortContext
operator|->
name|agPortContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
name|oneDeviceData
operator|->
name|InQID
operator|=
name|oneDeviceData
operator|->
name|id
operator|%
name|Indenom
expr_stmt|;
name|oneDeviceData
operator|->
name|OutQID
operator|=
name|oneDeviceData
operator|->
name|id
operator|%
name|Outdenom
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: A OutQID %d\n"
operator|,
name|oneDeviceData
operator|->
name|OutQID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssAddSASToSharedcontext: SSP target %d STP target %d SATA device %d\n"
operator|,
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssAddSASToSharedContext: old case pid %d did %d phyID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdssRemoveDevicedataFromSharedcontext * *  Purpose:  This function removes a discovered device from a device list of *            a port context * *  \param   tsddPortContext_Ins      Pointer to the target port context *  \param   tdsaDeviceData_Ins       Pointer to the target device *  \param   agRoot                   Pointer to the root data structure of *                                    TD and Lower layer  * *  \Return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssRemoveSASFromSharedcontext
parameter_list|(
name|tdsaPortContext_t
modifier|*
name|tdsaPortContext_Ins
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData_Ins
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|found
init|=
name|agTRUE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssRemoveSASFromSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a right portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveDevicedataFromSharedcontext: onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|tdsaPortContext_Ins
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssRemoveDevicedataFromSharedcontext: found; oneportContext ID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveDevicedataFromSharedcontext: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|SA_DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|tdsaDeviceData_Ins
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|SA_DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|tdsaDeviceData_Ins
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssRemoveDevicedataFromSharedcontext: pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdssRemoveDevicedataFromSharedcontext: can't find the right devicedata in MainLink\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* remove it and put it back to FreeLink of Devicedata */
name|TI_DBG6
argument_list|(
operator|(
literal|"tdssRemoveDevicedataFromSharedcontext: removing ... pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* invalidate the device but keep it on the list for persistency */
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdssRemoveAllDevicedataFromPortcontext * *  Purpose:  This function removes all discovered devices from a device list of *            a port context * *  \param   tdsaDeviceData           Pointer to a device header * *  \Return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssRemoveAllDevicelistFromPortcontext
parameter_list|(
name|tdsaPortContext_t
modifier|*
name|PortContext_Ins
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdssRemoveAllDevicedataFromPortcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     loop through device list and find the matching portcontext. Then invalidate the     matching devices   */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveAllDevicelistFromPortcontext: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|PortContext_Ins
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssRemoveAllDevicelistFromPortcontext: pid %d did %d\n"
operator|,
name|PortContext_Ins
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|PortContext_Ins
operator|->
name|Count
operator|--
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|TD_DISCOVER
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief tdssNewAddSASToSharedcontext * *  Purpose:  This function adds a discovered SAS device to a device list of *            a shared context. Used only in discovery. * *  \param   agRoot          Pointer to chip/driver Instance. *  \param   onePortContext  Pointer to the target port context *  \param   agSASSubID      Pointer to the SAS identification. * *  \Return: *           Pointer to the device data * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|tdsaDeviceData_t
modifier|*
name|tdssNewAddSASToSharedcontext
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaSASSubID_t
modifier|*
name|agSASSubID
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneExpDeviceData
parameter_list|,
name|bit8
name|phyID
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|new_device
init|=
name|agTRUE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     find a right portcontext     then, get devicedata from FreeLink in DeviceList     then, do pointer operations     then, add the devicedata to the portcontext   */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: oneportContext ID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|agSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|agSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|new_device
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* new device */
if|if
condition|(
name|new_device
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: new device\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TDLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: empty DeviceData FreeLink\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|DeviceListList
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|FreeLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|Count
operator|++
expr_stmt|;
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
comment|/* saving sas address */
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|=
name|agSASSubID
operator|->
name|sasAddressLo
expr_stmt|;
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|=
name|agSASSubID
operator|->
name|sasAddressHi
expr_stmt|;
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
comment|/* handles both SAS target and STP-target, SATA-device */
if|if
condition|(
operator|!
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|&&
operator|!
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SAS_DEVICE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SATA_DEVICE
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|ExpDevice
operator|=
name|oneExpDeviceData
expr_stmt|;
comment|/* set phyID only when it has initial value of 0xFF */
if|if
condition|(
name|oneDeviceData
operator|->
name|phyID
operator|==
literal|0xFF
condition|)
block|{
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FDS_DM
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
else|#
directive|else
comment|/* incremental discovery */
comment|/* add device to incremental-related link. Report using this link        when incremental discovery is done */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: full discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* add the devicedata to the portcontext */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: one case pid %d did %d \n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: new case pid %d did %d phyID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* old device */
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: old device\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
comment|/* saving sas address */
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|=
name|agSASSubID
operator|->
name|sasAddressLo
expr_stmt|;
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|=
name|agSASSubID
operator|->
name|sasAddressHi
expr_stmt|;
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
comment|/* handles both SAS target and STP-target, SATA-device */
if|if
condition|(
operator|!
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|&&
operator|!
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SAS_DEVICE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SATA_DEVICE
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|ExpDevice
operator|=
name|oneExpDeviceData
expr_stmt|;
comment|/* set phyID only when it has initial value of 0xFF */
if|if
condition|(
name|oneDeviceData
operator|->
name|phyID
operator|==
literal|0xFF
condition|)
block|{
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FDS_DM
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: full discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
block|}
endif|#
directive|endif
name|TI_DBG4
argument_list|(
operator|(
literal|"tdssNewAddSASToSharedcontext: old case pid %d did %d phyID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|oneDeviceData
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdsaFindRegNValid * *  Purpose:  This function finds a device which is registered and valid in *            the device list. Used only in incremental discovery. * *  \param   agRoot          Pointer to chip/driver Instance. *  \param   onePortContext  Pointer to the target port context *  \param   tdsaDeviceData  Pointer to a device list header *  \param   agSASSubID      Pointer to the SAS identification. * *  \Return: *           Pointer to the device data * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|tdsaDeviceData_t
modifier|*
name|tdsaFindRegNValid
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaSASSubID_t
modifier|*
name|agSASSubID
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: Full discovery\n"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaFindRegNValid: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|agSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|agSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* incremental discovery */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: Incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaFindRegNValid: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|agSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|agSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: end returning NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRegNValid: end returning NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|oneDeviceData
return|;
block|}
block|}
end_function

begin_comment
comment|//registered to LL or not
end_comment

begin_comment
comment|/***************************************************************************** *! \brief tdssNewSASorNot * *  Purpose:  This function finds whether a device is registered or not * *  \param   agRoot          Pointer to chip/driver Instance. *  \param   onePortContext  Pointer to the target port context *  \param   agSASSubID      Pointer to the SAS identification. * *  \Return: *           agTRUE   Device is not registered (New device). *           agFALSE  Device is registered (Old device). * *****************************************************************************/
end_comment

begin_function
name|bit32
name|tdssNewSASorNot
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaSASSubID_t
modifier|*
name|agSASSubID
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|ret
init|=
name|agTRUE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewSASorNot: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|agSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|agSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewSASorNot: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewSASorNot: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdssSASDiscoveringExpanderAlloc * *  Purpose:  This function allocates an expander from the pre-allocated memory *            pool. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData:  Pointer to the device data. * *  \return: *           Pointer to expander on success *           agNULL              on failure * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|tdsaExpander_t
modifier|*
name|tdssSASDiscoveringExpanderAlloc
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|ExpanderList
decl_stmt|;
comment|/*     move the expander from freeExpanderList     and ground the expander by TDLIST_DEQUEUE_THIS   */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAlloc: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAlloc: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAlloc: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAlloc: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAlloc: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|tdsaDumpAllFreeExp
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|freeExpanderList
operator|)
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAlloc: no free expanders\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|ExpanderList
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|freeExpanderList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
comment|//  oneExpander = TDLIST_OBJECT_BASE(tdsaContext_t, freeExpanderList, ExpanderList);
name|oneExpander
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAlloc: expander id %d\n"
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|tdDevice
operator|=
name|oneDeviceData
expr_stmt|;
name|oneExpander
operator|->
name|tdUpStreamExpander
operator|=
name|agNULL
expr_stmt|;
name|oneExpander
operator|->
name|tdCurrentDownStreamExpander
operator|=
name|agNULL
expr_stmt|;
name|oneExpander
operator|->
name|tdReturnginExpander
operator|=
name|agNULL
expr_stmt|;
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|=
name|agFALSE
expr_stmt|;
name|oneExpander
operator|->
name|numOfUpStreamPhys
operator|=
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|currentUpStreamPhyIndex
operator|=
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|discoveringPhyId
operator|=
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|underDiscovering
operator|=
name|agFALSE
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|currentIndex
operator|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|oneExpander
operator|->
name|currentIndex
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|tdExpander
operator|=
name|oneExpander
expr_stmt|;
block|}
return|return
name|oneExpander
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdssSASDiscoveringExpanderAdd * *  Purpose:  This function adds an expander to the expander list. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneExpander: Pointer to the expander data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssSASDiscoveringExpanderAdd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|tempExpander
decl_stmt|;
endif|#
directive|endif
comment|/* move the expander to discoveringExpanderList */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: expander id %d\n"
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: UPSTREAM\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: DOWNSTREAM\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: BEFORE\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|->
name|underDiscovering
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: ADDED \n"
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|underDiscovering
operator|=
name|agTRUE
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: AFTER\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* debugging */
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ExpanderList
operator|=
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderAdd: expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
endif|#
directive|endif
return|return;
block|}
end_function

begin_comment
comment|/* temp */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdssSASFindDiscoveringExpander
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|tdList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|tmpOnePortContext
init|=
name|onePortContext
decl_stmt|;
name|bit32
name|ret
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASFindDiscoveringExpander: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASFindDiscoveringExpander: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssSASFindDiscoveringExpander: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempExpander
operator|==
name|oneExpander
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASFindDiscoveringExpander: match!!! expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASFindDiscoveringExpander: exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASFindDiscoveringExpander: exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* to be tested */
end_comment

begin_comment
comment|/* move the expander to freeExpanderList */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  tdssSASDiscoveringExpanderRemove * *  Purpose:  This function removes an expander from the expander list. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneExpander: Pointer to the expander data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssSASDiscoveringExpanderRemove
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|tempExpander
decl_stmt|;
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: expander id %d\n"
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: BEFORE\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|tdsaDumpAllUpExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|tdsaDumpAllFreeExp
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* debugging */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: BEFORE\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
endif|#
directive|endif
comment|// if is temporary till smp problem is fixed
if|if
condition|(
name|tdssSASFindDiscoveringExpander
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|oneExpander
operator|->
name|underDiscovering
operator|=
name|agFALSE
expr_stmt|;
name|oneExpander
operator|->
name|discoveringPhyId
operator|=
literal|0
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: DISCOVERY_UP_STREAM\n"
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|upNode
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|UpdiscoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|NumOfUpExp
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: Status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|freeExpanderList
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
block|}
comment|//end temp if
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: !!! problem !!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: AFTER\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|tdsaDumpAllUpExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|tdsaDumpAllFreeExp
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* debugging */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: AFTER\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpanderRemove: expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
endif|#
directive|endif
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SATA_ENABLE
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief tdssNewAddSATAToSharedcontext * *  Purpose:  This function adds a discovered SATA device to a device list of *            a shared context. Used only in discovery. * *  \param   tiRoot  Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   agRoot          Pointer to chip/driver Instance. *  \param   onePortContext  Pointer to the target port context *  \param   tdsaDeviceData  Pointer to a device list header *  \param   agSATADeviceInfo      Pointer to the SATA device information. *  \param   Signature       Pointer to SATA signature *  \param   pm              Port multiplier *  \param   pmField         Port multiplier field *  \param   connectionRate  Connection rate * *  \Return: *           Pointer to the device data * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|tdsaDeviceData_t
modifier|*
name|tdssNewAddSATAToSharedcontext
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|agsaSATADeviceInfo_t
modifier|*
name|agSATADeviceInfo
parameter_list|,
name|bit8
modifier|*
name|Signature
parameter_list|,
name|bit8
name|pm
parameter_list|,
name|bit8
name|pmField
parameter_list|,
name|bit32
name|connectionRate
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneExpDeviceData
parameter_list|,
name|bit8
name|phyID
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|int
name|new_device
init|=
name|agTRUE
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: oneportContext ID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RPM_SOC
comment|/* Find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|osti_memcmp
argument_list|(
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|agSATADeviceInfo
operator|->
name|sataIdentifyData
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|new_device
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|#
directive|else
endif|#
directive|endif
comment|/* New device */
if|if
condition|(
name|new_device
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: new device\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TDLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: ERROR empty DeviceData FreeLink\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|oneDeviceData
return|;
block|}
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|DeviceListList
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|FreeLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|Count
operator|++
expr_stmt|;
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SATA_DEVICE
expr_stmt|;
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: oneDeviceData %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: pSatDevData=%p\n"
operator|,
operator|&
name|oneDeviceData
operator|->
name|satDevData
operator|)
argument_list|)
expr_stmt|;
comment|/* saving PortMultiplier(PM) field */
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satPMField
operator|=
name|pmField
expr_stmt|;
comment|/* saving signature */
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satSignature
operator|)
argument_list|,
name|Signature
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/*       saving device type       ATA device type; here should be either ATA_ATA_DEVICE or ATA_ATAPI_DEVICE     */
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satDeviceType
operator|=
name|tdssSATADeviceTypeDecode
argument_list|(
name|agSATADeviceInfo
operator|->
name|signature
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: device type %d\n"
operator|,
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satDeviceType
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RPM_SOC_REMOVED
comment|/* print device signature - Word8 */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: Word8 %x signature: %x %x %x %x %x %x %x %x\n"
operator|,
name|agSATADeviceInfo
operator|->
name|sataIdentifyData
operator|.
name|word1_9
index|[
literal|7
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|0
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|1
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|2
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|3
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|4
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|5
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|6
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|7
index|]
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|ExpDevice
operator|=
name|oneExpDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
comment|/* Add the devicedata to the portcontext */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: one case pid %d did %d \n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* old device */
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssNewAddSATAToSharedcontext: old device\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|Count
operator|++
expr_stmt|;
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SATA_DEVICE
expr_stmt|;
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|ExpDevice
operator|=
name|oneExpDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
block|}
return|return
name|oneDeviceData
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SATA_ENABLE */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TD_DISCOVER */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INITIATOR_DRIVER */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief  tdssReportRemovals * *  Purpose:  This function goes through device list and removes all devices *            belong to the portcontext. This function also deregiters those *            devices. This function is called in case of incremental discovery *            failure. * *  \param   agRoot        :  Pointer to chip/driver Instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ttdssReportRemovals
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|removed
init|=
name|agFALSE
decl_stmt|;
name|agsaEventSource_t
modifier|*
name|eventSource
decl_stmt|;
name|bit32
name|PhyID
decl_stmt|;
name|bit32
name|HwAckSatus
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|tmpDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* in case nothing was registered */
name|PhyID
operator|=
name|onePortContext
operator|->
name|eventPhyID
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|==
name|agTRUE
operator|&&
name|onePortContext
operator|->
name|RegisteredDevNums
operator|==
literal|0
operator|&&
name|PhyID
operator|!=
literal|0xFF
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: calling saHwEventAck\n"
operator|)
argument_list|)
expr_stmt|;
name|eventSource
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|)
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* toggle */
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|tdsaPortContextReInit
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
comment|/*         put all devices belonging to the onePortContext         back to the free link        */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
break|break;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: sasAddrHi 0x%08x sasAddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: valid %d valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: directlyAttached %d registered %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|,
name|oneDeviceData
operator|->
name|registered
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: right portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: removing\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* notify only reported devices to OS layer*/
name|removed
operator|=
name|agTRUE
expr_stmt|;
comment|/* all targets except expanders */
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: calling tdsaAbortAll\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: sasAddrHi 0x%08x sasAddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|tmpDeviceData
operator|=
name|oneDeviceData
expr_stmt|;
name|ttdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* reset valid bit */
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* called by port invalid case */
if|if
condition|(
name|flag
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|agNULL
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
comment|/* removed */
comment|/* directly attached SATA -> always remove it */
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
operator|&&
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: device did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceLis
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* REMOVED */
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: different portcontext; oneDeviceData->tdPortContext pid %d oneportcontext pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: different portcontext; oneDeviceData->tdPortContext pid NULL oneportcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
if|if
condition|(
name|removed
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssReportRemovals: removed at the end\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiTargetEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
operator|&
operator|(
name|tmpDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|tiTgtEventTypeDeviceChange
argument_list|,
name|tiDeviceRemoval
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* big else */
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TARGET_DRIVER */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  tdsaRotateQnumber * *  Purpose:  This function generates inbound queue number. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. * *  \return: *           Queue number * *   \note: * *****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|bit32
name|tdsaRotateQnumber
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|bit32
name|ret
init|=
literal|0
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaRotateQnumber: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|ret
operator|=
operator|(
name|oneDeviceData
operator|->
name|OutQID
operator|<<
literal|16
operator|)
operator||
name|oneDeviceData
operator|->
name|InQID
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tdsaRotateQnumber1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
comment|//  static int Last_Q;
comment|//  bit32             denom = tdsaAllShared->QueueConfig.numOutboundQueues;
name|bit32
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
comment|//    Last_Q= 0;
return|return
literal|0
return|;
block|}
comment|/* alway use highest Q number */
name|ret
operator|=
operator|(
operator|(
name|tdsaAllShared
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|tdsaAllShared
operator|->
name|QueueConfig
operator|.
name|numInboundQueues
operator|-
literal|1
operator|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_function
name|osGLOBAL
name|bit32
name|tdsaRotateQnumber
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|denom
init|=
name|tdsaAllShared
operator|->
name|QueueConfig
operator|.
name|numInboundQueues
decl_stmt|;
name|bit32
name|ret
init|=
literal|0
decl_stmt|;
comment|/* inbound queue number */
name|tdsaAllShared
operator|->
name|IBQnumber
operator|++
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|IBQnumber
operator|%
name|denom
operator|==
literal|0
condition|)
comment|/* % Qnumber*/
block|{
name|tdsaAllShared
operator|->
name|IBQnumber
operator|=
literal|0
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaRotateQnumber: IBQnumber %d\n"
operator|,
name|tdsaAllShared
operator|->
name|IBQnumber
operator|)
argument_list|)
expr_stmt|;
comment|/* outbound queue number */
name|tdsaAllShared
operator|->
name|OBQnumber
operator|++
expr_stmt|;
name|denom
operator|=
name|tdsaAllShared
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|OBQnumber
operator|%
name|denom
operator|==
literal|0
condition|)
comment|/* % Qnumber*/
block|{
name|tdsaAllShared
operator|->
name|OBQnumber
operator|=
literal|0
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaRotateQnumber: OBQnumber %d\n"
operator|,
name|tdsaAllShared
operator|->
name|OBQnumber
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|(
name|tdsaAllShared
operator|->
name|OBQnumber
operator|<<
literal|16
operator|)
operator||
name|tdsaAllShared
operator|->
name|IBQnumber
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|t_MacroCheck
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPC           %d\n"
operator|,
name|tIsSPC
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPCHIL        %d\n"
operator|,
name|tIsSPCHIL
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPCv          %d\n"
operator|,
name|tIsSPCv
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPCve         %d\n"
operator|,
name|tIsSPCve
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPCvplus      %d\n"
operator|,
name|tIsSPCvplus
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPCveplus     %d\n"
operator|,
name|tIsSPCveplus
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPCADAPvplus  %d\n"
operator|,
name|tIsSPCADAPvplus
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPCADAPveplus %d\n"
operator|,
name|tIsSPCADAPveplus
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPC12Gv       %d\n"
operator|,
name|tIsSPC12Gv
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPC12Gve      %d\n"
operator|,
name|tIsSPC12Gve
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPC12Gvplus   %d\n"
operator|,
name|tIsSPC12Gvplus
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPC12Gveplus  %d\n"
operator|,
name|tIsSPC12Gveplus
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tiIS_SPC         %d\n"
operator|,
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tiIS_HIL         %d\n"
operator|,
name|tiIS_HIL
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tiIS_SPC6V       %d\n"
operator|,
name|tiIS_SPC6V
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tiIS_SPC_ENC     %d\n"
operator|,
name|tiIS_SPC_ENC
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"t_MacroCheck:tIsSPCV12G       %d\n"
operator|,
name|tIsSPCV12G
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_comment
comment|/* for TIDEBUG_MSG */
end_comment

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|SM_DEBUG
argument_list|)
end_if

begin_decl_stmt
specifier|extern
name|bit32
name|gSMDebugLevel
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|osGLOBAL
name|void
name|smReportRemovalDirect
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit8
name|PhyID
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"smReportRemovalDirect: start\n"
operator|)
argument_list|)
expr_stmt|;
name|PhyID
operator|=
name|oneDeviceData
operator|->
name|phyID
expr_stmt|;
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
comment|/* put onedevicedata back to free list */
name|osti_memset
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smReportRemoval
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"smReportRemoval: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
comment|/*       1. remove this device       2. device removal event     */
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceRemoval
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smHandleDirect
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|void
modifier|*
name|IDdata
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|tmpOneDeviceData
init|=
name|agNULL
decl_stmt|;
name|int
name|new_device
init|=
name|agTRUE
decl_stmt|;
name|bit8
name|PhyID
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"smHandleDirect: start\n"
operator|)
argument_list|)
expr_stmt|;
name|PhyID
operator|=
name|oneDeviceData
operator|->
name|phyID
expr_stmt|;
name|pSATAIdData
operator|=
operator|(
name|agsaSATAIdentifyData_t
operator|*
operator|)
name|IDdata
expr_stmt|;
comment|//tdhexdump("satAddSATAIDDevCB after", (bit8 *)pSATAIdData, sizeof(agsaSATAIdentifyData_t));
comment|/* compare idenitfy device data to the exiting list */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|tmpOneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpOneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"smHandleDirect: tmpOneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"smHandleDirect: LOOP tmpOneDeviceData %p did %d\n"
operator|,
name|tmpOneDeviceData
operator|,
name|tmpOneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|//tdhexdump("smHandleDirect LOOP", (bit8 *)&tmpOneDeviceData->satDevData.satIdentifyData, sizeof(agsaSATAIdentifyData_t));
comment|/* what is unique ID for sata device -> response of identify devicedata; not really        Let's compare serial number, firmware version, model number     */
if|if
condition|(
name|tmpOneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
operator|&&
operator|(
name|osti_memcmp
argument_list|(
name|tmpOneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|.
name|serialNumber
argument_list|,
name|pSATAIdData
operator|->
name|serialNumber
argument_list|,
literal|20
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|osti_memcmp
argument_list|(
name|tmpOneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|.
name|firmwareVersion
argument_list|,
name|pSATAIdData
operator|->
name|firmwareVersion
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|osti_memcmp
argument_list|(
name|tmpOneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|.
name|modelNumber
argument_list|,
name|pSATAIdData
operator|->
name|modelNumber
argument_list|,
literal|40
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"smHandleDirect: did %d\n"
operator|,
name|tmpOneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|new_device
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|new_device
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"smHandleDirect: old device data\n"
operator|)
argument_list|)
expr_stmt|;
name|tmpOneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|tmpOneDeviceData
operator|->
name|valid2
operator|=
name|agTRUE
expr_stmt|;
comment|/* save data field from new device data */
name|tmpOneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|tmpOneDeviceData
operator|->
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|tmpOneDeviceData
operator|->
name|agDevHandle
operator|->
name|osData
operator|=
name|tmpOneDeviceData
expr_stmt|;
comment|/* TD layer */
name|tmpOneDeviceData
operator|->
name|tdPortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
name|tmpOneDeviceData
operator|->
name|phyID
operator|=
name|oneDeviceData
operator|->
name|phyID
expr_stmt|;
comment|/*       one SATA directly attached device per phy;       Therefore, deregister then register     */
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpOneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"smHandleDirect: re-registering old device data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* already has old information; just register it again */
name|saRegisterNewDevice
argument_list|(
comment|/* smHandleDirect */
name|agRoot
argument_list|,
operator|&
name|tmpOneDeviceData
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
comment|/*tdsaRotateQnumber(tiRoot, tmpOneDeviceData),*/
operator|&
name|tmpOneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|tmpOneDeviceData
operator|->
name|tdPortContext
operator|->
name|agPortContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|//    tdsaAbortAll(tiRoot, agRoot, oneDeviceData);
comment|/* put tmpOneDeviceData back to free list */
name|osti_memset
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"smHandleDirect: pid %d\n"
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"smHandleDirect: new device data\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|=
operator|*
name|pSATAIdData
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_comment
comment|/*   combine satAddSATAIDDevCB(expander) and satAddSATAIDDevCB(directly attached) */
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsmIDCompletedCB
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|bit32
name|status
parameter_list|,
name|void
modifier|*
name|IDdata
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tiPortalContext_t
modifier|*
name|tiPortalContext
decl_stmt|;
name|bit32
name|pid
init|=
literal|0xff
decl_stmt|;
name|bit32
name|IDstatus
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|smIORequest
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: smDeviceHandle is NULL !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|pid
operator|=
name|tdIORequestBody
operator|->
name|pid
expr_stmt|;
comment|//  oneDeviceData->satDevData.IDDeviceValid = agFALSE;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDPending
operator|=
name|agFALSE
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: tdIORequestBody %p  tdIORequestBody->osMemHandle %p\n"
operator|,
name|tdIORequestBody
operator|,
name|tdIORequestBody
operator|->
name|osMemHandle
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdIDTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TIMER_LOCK
argument_list|)
expr_stmt|;
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|tdIDTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* check port id */
if|if
condition|(
name|pid
operator|!=
name|onePortContext
operator|->
name|id
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: not matching pid; pid %d onePortContext->id %d!!!\n"
operator|,
name|pid
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|smReportRemovalDirect
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smReportRemoval
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiPortalContext
operator|=
name|onePortContext
operator|->
name|tiPortalContext
expr_stmt|;
if|if
condition|(
name|tiPortalContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: tiPortalContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|smReportRemovalDirect
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smReportRemoval
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: agRoot is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
operator|==
name|smIOSuccess
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: smIOSuccess\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: directlyAttached\n"
operator|)
argument_list|)
expr_stmt|;
name|pSATAIdData
operator|=
operator|(
name|agsaSATAIdentifyData_t
operator|*
operator|)
name|IDdata
expr_stmt|;
name|smHandleDirect
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|IDdata
argument_list|)
expr_stmt|;
comment|/* filling in */
name|osti_memcpy
argument_list|(
name|onePortContext
operator|->
name|remoteName
argument_list|,
name|pSATAIdData
operator|->
name|serialNumber
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|remoteName
index|[
literal|20
index|]
operator|)
argument_list|,
name|pSATAIdData
operator|->
name|firmwareVersion
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|remoteName
index|[
literal|28
index|]
operator|)
argument_list|,
name|pSATAIdData
operator|->
name|modelNumber
argument_list|,
literal|40
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* expander attached */
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: expander attached\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|ITD_DSTATE_COMPLETED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: ID completed after discovery is done; tiDeviceArrival\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* ID data completed after discovery is completed */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: tdIORequestBody %p  tdIORequestBody->osMemHandle %p\n"
operator|,
name|tdIORequestBody
operator|,
name|tdIORequestBody
operator|->
name|osMemHandle
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|smIORetry
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: smIORetry!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: smIORetry but device is not valid!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdIORequestBody
operator|->
name|reTries
operator|<=
name|SM_RETRIES
condition|)
block|{
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|agNULL
expr_stmt|;
comment|/* not in use */
name|tdIORequestBody
operator|->
name|pid
operator|=
name|onePortContext
operator|->
name|id
expr_stmt|;
name|smIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
name|smIORequest
operator|->
name|smData
operator|=
operator|&
name|tdIORequestBody
operator|->
name|smIORequestBody
expr_stmt|;
name|smDeviceHandle
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
name|IDstatus
operator|=
name|smIDStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|IDstatus
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* identify device data is not valid */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: smIDStart fail or busy %d!!!\n"
operator|,
name|IDstatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|smReportRemoval
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdIORequestBody
operator|->
name|reTries
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDPending
operator|=
name|agTRUE
expr_stmt|;
comment|/* start a timer */
name|tdIDStartTimer
argument_list|(
name|tiRoot
argument_list|,
name|smIORequest
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: being retried!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* give up */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: retries are over!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
comment|/* SATA device is not usable; remove it */
name|smReportRemoval
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|smIOSTPResourceBusy
condition|)
block|{
comment|/* decides to send smp hard reset or not */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: smIOSTPResourceBusy\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|FCA
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|SMNumOfFCA
operator|<=
literal|0
condition|)
comment|/* does SMP HARD RESET only upto one time */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY; sending HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SMNumOfFCA
operator|++
expr_stmt|;
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* given up after one time of SMP HARD RESET; */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY; but giving up sending HARD_RESET!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smReportRemoval
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* do nothing */
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: smIDStart fail, status 0x%x!!!\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: fail but device is not valid!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
return|return;
block|}
name|tdsaAllShared
operator|->
name|IDRetry
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|IDRetry
condition|)
block|{
if|if
condition|(
name|tdIORequestBody
operator|->
name|reTries
operator|<=
name|SM_RETRIES
condition|)
block|{
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|agNULL
expr_stmt|;
comment|/* not in use */
name|tdIORequestBody
operator|->
name|pid
operator|=
name|onePortContext
operator|->
name|id
expr_stmt|;
name|smIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
name|smIORequest
operator|->
name|smData
operator|=
operator|&
name|tdIORequestBody
operator|->
name|smIORequestBody
expr_stmt|;
name|smDeviceHandle
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
name|IDstatus
operator|=
name|smIDStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|IDstatus
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* identify device data is not valid */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: smIDStart fail or busy %d!!!\n"
operator|,
name|IDstatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|smReportRemovalDirect
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smReportRemoval
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|tdIORequestBody
operator|->
name|reTries
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDPending
operator|=
name|agTRUE
expr_stmt|;
comment|/* start a timer */
name|tdIDStartTimer
argument_list|(
name|tiRoot
argument_list|,
name|smIORequest
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: being retried!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* give up */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: retries are over; sending hard reset!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SMNumOfID
operator|<=
literal|0
condition|)
comment|/* does SMP HARD RESET only upto one time */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: fail; sending HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SMNumOfID
operator|++
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* given up after one time of SMP HARD RESET; */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIDCompletedCB: fail; but giving up sending HARD_RESET!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|smReportRemovalDirect
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smReportRemoval
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
comment|/* do nothing */
block|}
block|}
return|return;
block|}
end_function

begin_function
name|FORCEINLINE
name|void
name|tdsmIOCompletedCB
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|statusDetail
parameter_list|,
name|smSenseData_t
modifier|*
name|senseData
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|smIORequest
operator|->
name|tdData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiIORequest
init|=
name|tdIORequestBody
operator|->
name|tiIORequest
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smSCSIRequest
decl_stmt|;
name|smSuperScsiInitiatorRequest_t
modifier|*
name|smSuperSCSIRequest
decl_stmt|;
name|bit32
name|SMStatus
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdsmIOCompletedCB: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|smIOSuccess
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|,
operator|(
name|tiSenseData_t
operator|*
operator|)
name|senseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|smIORetry
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIOCompletedCB: smIORetry!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|smIORequest
operator|)
expr_stmt|;
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIOCompletedCB: smIORetry but device is not valid!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|,
operator|(
name|tiSenseData_t
operator|*
operator|)
name|senseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdIORequestBody
operator|->
name|reTries
operator|<=
name|SM_RETRIES
condition|)
block|{
name|smDeviceHandle
operator|=
operator|(
name|smDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
expr_stmt|;
if|if
condition|(
name|tdIORequestBody
operator|->
name|superIOFlag
operator|==
name|agTRUE
condition|)
block|{
name|smSuperSCSIRequest
operator|=
operator|(
name|smSuperScsiInitiatorRequest_t
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|SM
operator|.
name|smSuperSCSIRequest
operator|)
expr_stmt|;
name|SMStatus
operator|=
name|smSuperIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSuperSCSIRequest
argument_list|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
argument_list|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smSCSIRequest
operator|=
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|SM
operator|.
name|smSCSIRequest
operator|)
expr_stmt|;
name|SMStatus
operator|=
name|smIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SMStatus
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIOCompletedCB: smIDStart fail or busy %d!!!\n"
operator|,
name|SMStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|,
operator|(
name|tiSenseData_t
operator|*
operator|)
name|senseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIOCompletedCB: being retried!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* give up; complete IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIOCompletedCB: retries are over!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|,
operator|(
name|tiSenseData_t
operator|*
operator|)
name|senseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|smIOSTPResourceBusy
condition|)
block|{
comment|/* decides to send smp hard reset or not */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIOCompletedCB: smIOSTPResourceBusy\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|FCA
condition|)
block|{
name|smIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|smIORequest
operator|)
expr_stmt|;
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SMNumOfFCA
operator|<=
literal|0
condition|)
comment|/* does SMP HARD RESET only upto one time */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIOCompletedCB: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY; sending HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SMNumOfFCA
operator|++
expr_stmt|;
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* given up after one time of SMP HARD RESET; */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIOCompletedCB: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY; but giving up sending HARD_RESET!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|,
operator|(
name|tiSenseData_t
operator|*
operator|)
name|senseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
if|if
condition|(
name|statusDetail
operator|==
name|smDetailAborted
condition|)
block|{
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmIOCompletedCB: agIOStatus = OSSA_IO_ABORTED did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|,
operator|(
name|tiSenseData_t
operator|*
operator|)
name|senseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* completion of taskmanagement osGLOBAL void ostiInitiatorEvent (                         tiRoot_t            *tiRoot,                         tiPortalContext_t   *portalContext,                         tiDeviceHandle_t    *tiDeviceHandle,                         tiIntrEventType_t   eventType,                         bit32               eventStatus,                         void                *parm                         );  */
end_comment

begin_comment
comment|//qqq1
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsmEventCB
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smIntrEventType_t
name|eventType
parameter_list|,
name|bit32
name|eventStatus
parameter_list|,
name|void
modifier|*
name|parm
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|smIORequest_t
modifier|*
name|SMcurrentTaskTag
decl_stmt|;
name|tiIORequest_t
modifier|*
name|currentTaskTag
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tiPortalContext_t
modifier|*
name|tiportalContext
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
decl_stmt|;
comment|/* be sure to free using tdIORequestBody->->IOType.InitiatorTMIO.osMemHandle but how???      parm = pSatDevData->satTmTaskTag (currentTaskTag in tiINITaskManagement)      In this case, parm is smIORequest_t   */
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsmEventCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|eventType
operator|==
name|smIntrEventTypeLocalAbort
condition|)
block|{
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmEventCB: oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tiDeviceHandle
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|SMcurrentTaskTag
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|parm
expr_stmt|;
if|if
condition|(
name|SMcurrentTaskTag
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmEventCB: SMcurrentTaskTag is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|SMcurrentTaskTag
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmEventCB: tdIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|osMemHandle
operator|=
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
expr_stmt|;
name|currentTaskTag
operator|=
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|CurrentTaskTag
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmEventCB: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiDeviceHandle
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmEventCB: onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiportalContext
operator|=
name|onePortContext
operator|->
name|tiPortalContext
expr_stmt|;
comment|/* free tdIORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsmEventCB: calling ostiInitiatorEvent\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiportalContext
argument_list|,
name|tiDeviceHandle
argument_list|,
name|eventType
argument_list|,
name|eventStatus
argument_list|,
operator|(
name|void
operator|*
operator|)
name|currentTaskTag
argument_list|)
expr_stmt|;
comment|/* completion of taskmanagement       osGLOBAL void ostiInitiatorEvent (                               tiRoot_t            *tiRoot,                               tiPortalContext_t   *portalContext,                               tiDeviceHandle_t    *tiDeviceHandle,                               tiIntrEventType_t   eventType,                               bit32               eventStatus,                               void                *parm                               );         ostiFreeAlloc()     */
block|}
return|return;
block|}
end_function

begin_function
name|FORCEINLINE
name|void
name|tdsmSingleThreadedEnter
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|bit32
name|syncLockId
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|bit32
name|offset
init|=
literal|0
decl_stmt|;
name|TI_DBG7
argument_list|(
operator|(
literal|"tdsmSingleThreadedEnter: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmSingleThreadedEnter: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmSingleThreadedEnter: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmSingleThreadedEnter: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|offset
operator|=
name|tdsaAllShared
operator|->
name|MaxNumLLLocks
operator|+
name|tdsaAllShared
operator|->
name|MaxNumOSLocks
operator|+
name|TD_MAX_LOCKS
operator|+
name|tdsaAllShared
operator|->
name|MaxNumDMLocks
expr_stmt|;
name|ostiSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|syncLockId
operator|+
name|offset
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|FORCEINLINE
name|void
name|tdsmSingleThreadedLeave
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|bit32
name|syncLockId
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|bit32
name|offset
init|=
literal|0
decl_stmt|;
name|TI_DBG7
argument_list|(
operator|(
literal|"tdsmSingleThreadedLeave: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmSingleThreadedLeave: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmSingleThreadedLeave: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmSingleThreadedLeave: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|offset
operator|=
name|tdsaAllShared
operator|->
name|MaxNumLLLocks
operator|+
name|tdsaAllShared
operator|->
name|MaxNumOSLocks
operator|+
name|TD_MAX_LOCKS
operator|+
name|tdsaAllShared
operator|->
name|MaxNumDMLocks
expr_stmt|;
name|ostiSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|syncLockId
operator|+
name|offset
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|bit8
name|tdsmBitScanForward
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|bit32
modifier|*
name|Index
parameter_list|,
name|bit32
name|Mask
parameter_list|)
block|{
return|return
name|ostiBitScanForward
argument_list|(
name|agNULL
argument_list|,
name|Index
argument_list|,
name|Mask
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|LINUX_VERSION_CODE
end_ifdef

begin_function
name|osGLOBAL
name|FORCEINLINE
name|sbit32
name|tdsmInterlockedIncrement
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|sbit32
specifier|volatile
modifier|*
name|Addend
parameter_list|)
block|{
return|return
name|ostiAtomicIncrement
argument_list|(
name|agNULL
argument_list|,
name|Addend
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|sbit32
name|tdsmInterlockedDecrement
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|sbit32
specifier|volatile
modifier|*
name|Addend
parameter_list|)
block|{
return|return
name|ostiAtomicDecrement
argument_list|(
name|agNULL
argument_list|,
name|Addend
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|sbit32
name|tdsmAtomicBitClear
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|sbit32
specifier|volatile
modifier|*
name|Destination
parameter_list|,
name|sbit32
name|Value
parameter_list|)
block|{
return|return
name|ostiAtomicBitClear
argument_list|(
name|agNULL
argument_list|,
name|Destination
argument_list|,
name|Value
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|sbit32
name|tdsmAtomicBitSet
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|sbit32
specifier|volatile
modifier|*
name|Destination
parameter_list|,
name|sbit32
name|Value
parameter_list|)
block|{
return|return
name|ostiAtomicBitSet
argument_list|(
name|agNULL
argument_list|,
name|Destination
argument_list|,
name|Value
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|sbit32
name|tdsmAtomicExchange
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|sbit32
specifier|volatile
modifier|*
name|Target
parameter_list|,
name|sbit32
name|Value
parameter_list|)
block|{
return|return
name|ostiAtomicExchange
argument_list|(
name|agNULL
argument_list|,
name|Target
argument_list|,
name|Value
argument_list|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
name|osGLOBAL
name|FORCEINLINE
name|sbit32
name|tdsmInterlockedIncrement
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|sbit32
specifier|volatile
modifier|*
name|Addend
parameter_list|)
block|{
return|return
name|ostiInterlockedIncrement
argument_list|(
name|agNULL
argument_list|,
name|Addend
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|sbit32
name|tdsmInterlockedDecrement
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|sbit32
specifier|volatile
modifier|*
name|Addend
parameter_list|)
block|{
return|return
name|ostiInterlockedDecrement
argument_list|(
name|agNULL
argument_list|,
name|Addend
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|sbit32
name|tdsmInterlockedAnd
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|sbit32
specifier|volatile
modifier|*
name|Destination
parameter_list|,
name|sbit32
name|Value
parameter_list|)
block|{
return|return
name|ostiInterlockedAnd
argument_list|(
name|agNULL
argument_list|,
name|Destination
argument_list|,
name|Value
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|sbit32
name|tdsmInterlockedOr
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|sbit32
specifier|volatile
modifier|*
name|Destination
parameter_list|,
name|sbit32
name|Value
parameter_list|)
block|{
return|return
name|ostiInterlockedOr
argument_list|(
name|agNULL
argument_list|,
name|Destination
argument_list|,
name|Value
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|sbit32
name|tdsmInterlockedExchange
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|sbit32
specifier|volatile
modifier|*
name|Target
parameter_list|,
name|sbit32
name|Value
parameter_list|)
block|{
return|return
name|ostiInterlockedExchange
argument_list|(
name|agNULL
argument_list|,
name|Target
argument_list|,
name|Value
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*LINUX_VERSION_CODE*/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsmAllocMemory
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|void
modifier|*
modifier|*
name|osMemHandle
parameter_list|,
name|void
modifier|*
modifier|*
name|virtPtr
parameter_list|,
name|bit32
modifier|*
name|physAddrUpper
parameter_list|,
name|bit32
modifier|*
name|physAddrLower
parameter_list|,
name|bit32
name|alignment
parameter_list|,
name|bit32
name|allocLength
parameter_list|,
name|smBOOLEAN
name|isCacheable
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdsmAllocMemory: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmAllocMemory: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmAllocMemory: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmAllocMemory: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|status
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
name|virtPtr
argument_list|,
name|physAddrUpper
argument_list|,
name|physAddrLower
argument_list|,
name|alignment
argument_list|,
name|allocLength
argument_list|,
name|isCacheable
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|tiSuccess
condition|)
block|{
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
return|return
name|SM_RC_FAILURE
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tdsmFreeMemory
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|void
modifier|*
name|osDMAHandle
parameter_list|,
name|bit32
name|allocLength
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdsmFreeMemory: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmFreeMemory: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmFreeMemory: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmFreeMemory: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|status
operator|=
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osDMAHandle
argument_list|,
name|allocLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|tiSuccess
condition|)
block|{
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
return|return
name|SM_RC_FAILURE
return|;
block|}
block|}
end_function

begin_function
name|FORCEINLINE
name|bit32
name|tdsmRotateQnumber
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|bit32
name|ret
init|=
literal|0
decl_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsmRotateQnumber: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmRotateQnumber: smDeviceHandle is NULL !!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmRotateQnumber: oneDeviceData is NULL !!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tdsmSetDeviceQueueDepth
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|bit32
name|QueueDepth
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
name|agNULL
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|smIORequest
operator|->
name|tdData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiIORequest
init|=
name|tdIORequestBody
operator|->
name|tiIORequest
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdsmSetDeviceQueueDepth: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmSetDeviceQueueDepth: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmSetDeviceQueueDepth: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsmFreeMemory: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
return|return
name|ostiSetDeviceQueueDepth
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|QueueDepth
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tdsmGetTransportParam
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|char
modifier|*
name|key
parameter_list|,
name|char
modifier|*
name|subkey1
parameter_list|,
name|char
modifier|*
name|subkey2
parameter_list|,
name|char
modifier|*
name|subkey3
parameter_list|,
name|char
modifier|*
name|subkey4
parameter_list|,
name|char
modifier|*
name|subkey5
parameter_list|,
name|char
modifier|*
name|valueName
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|bit32
name|bufferLen
parameter_list|,
name|bit32
modifier|*
name|lenReceived
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|tiError
decl_stmt|;
name|TI_DBG7
argument_list|(
operator|(
literal|"tdsmGetTransportParam: start\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ostiGetTransportParam
argument_list|(
name|agNULL
argument_list|,
name|key
argument_list|,
name|subkey1
argument_list|,
name|subkey2
argument_list|,
name|subkey3
argument_list|,
name|subkey4
argument_list|,
name|subkey5
argument_list|,
name|valueName
argument_list|,
name|buffer
argument_list|,
name|bufferLen
argument_list|,
name|lenReceived
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FDS_SM */
end_comment

end_unit


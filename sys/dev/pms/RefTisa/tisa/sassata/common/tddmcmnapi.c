begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_comment
comment|/* for TIDEBUG_MSG */
end_comment

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|DM_DEBUG
argument_list|)
end_if

begin_decl_stmt
specifier|extern
name|bit32
name|gDMDebugLevel
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|osGLOBAL
name|bit32
name|tddmRotateQnumber
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmRotateQnumber: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmRotateQnumber: agDevHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmRotateQnumber: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmRotateQnumber: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmRotateQnumber: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmRotateQnumber: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tdsaFindLocalMCN
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|,
name|localMCN
init|=
literal|0
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaFindLocalMCN: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaFindLocalMCN: invalid portcontext id %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
name|localMCN
operator|++
expr_stmt|;
block|}
block|}
return|return
name|localMCN
return|;
block|}
end_function

begin_comment
comment|/*  on success,            ostiInitiatorEvent(                              tiRoot,                              onePortContext->tiPortalContext,                              agNULL,                              tiIntrEventTypeDiscovery,                              tiDiscOK,                              agNULL                              ); else         remove(de-register) all devices         ostiInitiatorEvent(                            tiRoot,                            onePortContext->tiPortalContext,                            agNULL,                            tiIntrEventTypeDiscovery,                            tiDiscFailed,                            agNULL                            );     dmRoot->tdData is tdsaRoot_t (just like current TD layer)   dmPortContext->tdData is tdsaPortContext_t  */
end_comment

begin_function
name|osGLOBAL
name|void
name|tddmDiscoverCB
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmPortContext_t
modifier|*
name|dmPortContext
parameter_list|,
name|bit32
name|eventStatus
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agsaPortContext_t
modifier|*
name|agPortContext
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|dmPortContext
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: onePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmDiscoverCB: localMCN 0x%x\n"
operator|,
name|tdsaFindLocalMCN
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eventStatus
operator|==
name|dmDiscCompleted
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: dmDiscCompleted\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_COMPLETED
expr_stmt|;
name|onePortContext
operator|->
name|DMDiscoveryState
operator|=
name|dmDiscCompleted
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: pid %d tiPortalContext %p\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|tiPortalContext
operator|)
argument_list|)
expr_stmt|;
comment|/* update onePortContext->UpdateMCN = agFALSE */
if|if
condition|(
name|onePortContext
operator|->
name|UpdateMCN
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmDiscoverCB: calling tdsaUpdateMCN\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|UpdateMCN
operator|=
name|agFALSE
expr_stmt|;
name|tdsaUpdateMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|eventStatus
operator|==
name|dmDiscFailed
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: dmDiscFailed \n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_COMPLETED
expr_stmt|;
name|onePortContext
operator|->
name|DMDiscoveryState
operator|=
name|dmDiscFailed
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: pid %d tiPortalContext %p\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|tiPortalContext
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
if|if
condition|(
name|agRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: agRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|agPortContext
operator|=
name|onePortContext
operator|->
name|agPortContext
expr_stmt|;
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: agPortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*       invalidate all devices in this port     */
name|tddmInvalidateDevicesInPort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|saPortControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agPortContext
argument_list|,
name|AGSA_PORT_IO_ABORT
argument_list|,
literal|0
comment|/*quarantine */
argument_list|,
literal|0
comment|/* unused */
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|eventStatus
operator|==
name|dmDiscAborted
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: dmDiscAborted \n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DMDiscoveryState
operator|=
name|dmDiscAborted
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|eventStatus
operator|==
name|dmDiscAbortFailed
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: dmDiscAbortFailed  \n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DMDiscoveryState
operator|=
name|dmDiscAbortFailed
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|eventStatus
operator|==
name|dmDiscAbortInvalid
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: dmDiscAbortInvalid  \n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DMDiscoveryState
operator|=
name|dmDiscAbortInvalid
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|eventStatus
operator|==
name|dmDiscAbortInProgress
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: dmDiscAbortInProgress  \n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DMDiscoveryState
operator|=
name|dmDiscAbortInProgress
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmDiscoverCB: undefined eventStatus 0x%x\n"
operator|,
name|eventStatus
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DMDiscoveryState
operator|=
name|dmDiscFailed
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tddmQueryDiscoveryCB
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmPortContext_t
modifier|*
name|dmPortContext
parameter_list|,
name|bit32
name|discType
parameter_list|,
name|bit32
name|discState
parameter_list|)
block|{
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmQueryDiscoveryCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|dmPortContext
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmQueryDiscoveryCB: onePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmQueryDiscoveryCB: discType %d discState %d\n"
operator|,
name|discType
operator|,
name|discState
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DMDiscoveryState
operator|=
name|discState
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tddmInvalidateDevicesInPort
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmInvalidateDevicesInPort: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmInvalidateDevicesInPort: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tddmInvalidateDevicesInPort: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|&&
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|onePortContext
operator|->
name|sasRemoteAddressLo
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmInvalidateDevicesInPort: keeping\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
block|}
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tddmInvalidateDevicesInPort: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tddmNewSASorNot
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaSASSubID_t
modifier|*
name|agSASSubID
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|ret
init|=
name|agTRUE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tddmNewSASorNot: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmNewSASorNot: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agFALSE
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|agSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|agSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tddmNewSASorNot: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tddmNewSASorNot: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|tdsaDeviceData_t
modifier|*
name|tddmPortSASDeviceFind
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|sasAddrLo
parameter_list|,
name|bit32
name|sasAddrHi
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|,
modifier|*
name|RetDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortSASDeviceFind: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|tiRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|onePortContext
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmPortSASDeviceFind: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|sasAddrHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|sasAddrLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortSASDeviceFind: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortSASDeviceFind: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortSASDeviceFind: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|RetDeviceData
operator|=
name|oneDeviceData
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
return|return
name|RetDeviceData
return|;
block|}
end_function

begin_comment
comment|/* not in use yet */
end_comment

begin_function
name|osGLOBAL
name|tdsaDeviceData_t
modifier|*
name|tddmAddToSharedcontext
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaSASSubID_t
modifier|*
name|agSASSubID
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneExpDeviceData
parameter_list|,
name|bit8
name|phyID
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|new_device
init|=
name|agTRUE
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: oneportContext ID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|agSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|agSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: pid %dtddmAddToSharedcontext did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|new_device
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* new device */
if|if
condition|(
name|new_device
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: new device\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TDLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: empty DeviceData FreeLink\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|DeviceListList
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|FreeLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|Count
operator|++
expr_stmt|;
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
comment|/* saving sas address */
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|=
name|agSASSubID
operator|->
name|sasAddressLo
expr_stmt|;
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|=
name|agSASSubID
operator|->
name|sasAddressHi
expr_stmt|;
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
comment|/* handles both SAS target and STP-target, SATA-device */
if|if
condition|(
operator|!
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|&&
operator|!
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SAS_DEVICE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SATA_DEVICE
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|ExpDevice
operator|=
name|oneExpDeviceData
expr_stmt|;
comment|/* set phyID only when it has initial value of 0xFF */
if|if
condition|(
name|oneDeviceData
operator|->
name|phyID
operator|==
literal|0xFF
condition|)
block|{
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
comment|/* add the devicedata to the portcontext */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: one case pid %d did %d \n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: new case pid %d did %d phyID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* old device */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: old device\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
comment|/* saving sas address */
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|=
name|agSASSubID
operator|->
name|sasAddressLo
expr_stmt|;
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|=
name|agSASSubID
operator|->
name|sasAddressHi
expr_stmt|;
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|=
name|agSASSubID
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
comment|/* handles both SAS target and STP-target, SATA-device */
if|if
condition|(
operator|!
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|&&
operator|!
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SAS_DEVICE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SATA_DEVICE
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|ExpDevice
operator|=
name|oneExpDeviceData
expr_stmt|;
comment|/* set phyID only when it has initial value of 0xFF */
if|if
condition|(
name|oneDeviceData
operator|->
name|phyID
operator|==
literal|0xFF
condition|)
block|{
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmAddToSharedcontext: old case pid %d did %d phyID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|oneDeviceData
return|;
block|}
end_function

begin_comment
comment|/*   calls saRegisterNewDevice()   in ossaDeviceRegistrationCB(), if an expander, register to DM #define DEVICE_IS_SMP_TARGET(DeviceData) \   (((DeviceData)->target_ssp_stp_smp& DEVICE_SMP_BIT) == DEVICE_SMP_BIT) */
end_comment

begin_function
name|osGLOBAL
name|tdsaDeviceData_t
modifier|*
name|tddmPortDeviceAdd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceInfo_t
modifier|*
name|dmDeviceInfo
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneExpDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdsaSASSubID_t
name|agSASSubID
decl_stmt|;
name|bit8
name|phyID
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|sasAddressHi
operator|=
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|sasAddressLo
operator|=
name|TD_GET_SAS_ADDRESSLO
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|dmDeviceInfo
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|dmDeviceInfo
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|phyID
operator|=
operator|(
name|dmDeviceInfo
operator|->
name|ext
operator|)
operator|&
literal|0xFF
expr_stmt|;
comment|/* old device and already registered to LL; added by link-up event */
if|if
condition|(
name|agFALSE
operator|==
name|tdssNewSASorNot
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|agSASSubID
argument_list|)
condition|)
block|{
comment|/* old device and already registered to LL; added by link-up event */
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: OLD qqqq initiator_ssp_stp_smp %d target_ssp_stp_smp %d\n"
operator|,
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|,
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
comment|/* find the old device */
name|oneDeviceData
operator|=
name|tdssNewAddSASToSharedcontext
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|agSASSubID
argument_list|,
name|oneExpDeviceData
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: no more device!!! oneDeviceData is null\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* If a device is allocated */
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|agSASSubID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|agSASSubID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: phyID 0x%x\n"
operator|,
name|phyID
operator|)
argument_list|)
expr_stmt|;
comment|/* copy dmDeviceInfo to oneDeviceData->agDeviceInfo except ext field */
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|smpTimeout
operator|=
name|dmDeviceInfo
operator|->
name|smpTimeout
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|it_NexusTimeout
operator|=
name|dmDeviceInfo
operator|->
name|it_NexusTimeout
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|firstBurstSize
operator|=
name|dmDeviceInfo
operator|->
name|firstBurstSize
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
operator|=
name|dmDeviceInfo
operator|->
name|devType_S_Rate
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|sasAddressHi
operator|)
argument_list|,
operator|&
operator|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|sasAddressLo
operator|)
argument_list|,
operator|&
operator|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmDeviceInfo
operator|->
name|sataDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||=
name|ATAPI_DEVICE_FLAG
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satDeviceType
operator|=
name|dmDeviceInfo
operator|->
name|sataDeviceType
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
name|oneDeviceData
return|;
block|}
comment|/* old device */
comment|/* new device */
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: NEW qqqq initiator_ssp_stp_smp %d target_ssp_stp_smp %d\n"
operator|,
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|,
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate a new device and set the valid bit */
name|oneDeviceData
operator|=
name|tdssNewAddSASToSharedcontext
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|agSASSubID
argument_list|,
name|oneExpDeviceData
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: no more device!!! oneDeviceData is null\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* If a device is allocated */
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|agSASSubID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|agSASSubID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: phyID 0x%x\n"
operator|,
name|phyID
operator|)
argument_list|)
expr_stmt|;
comment|/* copy dmDeviceInfo to oneDeviceData->agDeviceInfo except ext field */
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|smpTimeout
operator|=
name|dmDeviceInfo
operator|->
name|smpTimeout
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|it_NexusTimeout
operator|=
name|dmDeviceInfo
operator|->
name|it_NexusTimeout
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|firstBurstSize
operator|=
name|dmDeviceInfo
operator|->
name|firstBurstSize
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
operator|=
name|dmDeviceInfo
operator|->
name|devType_S_Rate
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|sasAddressHi
operator|)
argument_list|,
operator|&
operator|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|sasAddressLo
operator|)
argument_list|,
operator|&
operator|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satDeviceType
operator|=
name|dmDeviceInfo
operator|->
name|sataDeviceType
expr_stmt|;
if|if
condition|(
name|dmDeviceInfo
operator|->
name|sataDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||=
name|ATAPI_DEVICE_FLAG
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|agContext
operator|.
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* don't add and register initiator for T2D */
if|if
condition|(
operator|(
operator|(
operator|(
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|&
name|DEVICE_SSP_BIT
operator|)
operator|==
name|DEVICE_SSP_BIT
operator|)
operator|&&
operator|(
operator|(
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|&
name|DEVICE_SSP_BIT
operator|)
operator|!=
name|DEVICE_SSP_BIT
operator|)
operator|)
operator|||
operator|(
operator|(
operator|(
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|&
name|DEVICE_STP_BIT
operator|)
operator|==
name|DEVICE_STP_BIT
operator|)
operator|&&
operator|(
operator|(
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|&
name|DEVICE_SSP_BIT
operator|)
operator|!=
name|DEVICE_SSP_BIT
operator|)
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: initiator. no add and registration\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|agSASSubID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|agSASSubID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
ifdef|#
directive|ifdef
name|REMOVED
comment|//temp; setting MCN to tdsaAllShared->MCN
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||
operator|(
name|tdsaAllShared
operator|->
name|MCN
operator|<<
literal|16
operator|)
expr_stmt|;
comment|//end temp
endif|#
directive|endif
if|if
condition|(
name|tdsaAllShared
operator|->
name|sflag
condition|)
block|{
if|if
condition|(
operator|!
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmPortDeviceAdd: saRegisterNewDevice sflag %d\n"
operator|,
name|tdsaAllShared
operator|->
name|sflag
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||
name|TD_XFER_RDY_PRIORTY_DEVICE_FLAG
expr_stmt|;
block|}
block|}
name|saRegisterNewDevice
argument_list|(
comment|/* tddmPortDeviceAdd */
name|onePortContext
operator|->
name|agRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|onePortContext
operator|->
name|agPortContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|oneDeviceData
return|;
block|}
end_function

begin_comment
comment|/*   each call, add the device to the device list   typedef struct{   bit16 smpTimeout;   bit16 it_NexusTimeout;   bit16 firstBurstSize;   bit8  flag;   bit8  devType_S_Rate;   bit8  sasAddressHi[4];   bit8  sasAddressLo[4]; } dmDeviceInfo_t;   find oneExpDeviceData (expander device data) from dmExpDeviceInfo and  pass it to tddmPortDeviceAdd()  start here - change spec from bit32 to void   phyID = ((dmDeviceInfo->flag)& 0xFC)>> 2;  Initiators are not registered */
end_comment

begin_comment
comment|//start here
end_comment

begin_function
name|osGLOBAL
name|void
name|tddmReportDevice
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmPortContext_t
modifier|*
name|dmPortContext
parameter_list|,
name|dmDeviceInfo_t
modifier|*
name|dmDeviceInfo
parameter_list|,
comment|/* device */
name|dmDeviceInfo_t
modifier|*
name|dmExpDeviceInfo
parameter_list|,
comment|/* expander the device is attached to */
name|bit32
name|flag
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneExpDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|sasAddressHi
decl_stmt|,
name|sasAddressLo
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|localMCN
init|=
literal|0
decl_stmt|,
name|finalMCN
init|=
literal|0
decl_stmt|;
name|bit32
name|devMCN
init|=
literal|1
decl_stmt|;
name|bit32
name|DLR
init|=
literal|0xA
decl_stmt|;
name|bit32
name|option
decl_stmt|;
name|bit32
name|param
decl_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot_t
modifier|*
name|smRoot
decl_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|dmPortContext
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: onePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: device addrHi 0x%08x addrLo 0x%08x\n"
operator|,
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
operator|,
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmExpDeviceInfo
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: attached expander addrHi 0x%08x addrLo 0x%08x\n"
operator|,
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmExpDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
operator|,
name|TD_GET_SAS_ADDRESSLO
argument_list|(
name|dmExpDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: No attached expander\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* initiators only (e.g. SPC or SPCv) are discarded */
if|if
condition|(
operator|(
name|dmDeviceInfo
operator|->
name|target_ssp_stp_smp
operator|==
literal|0
operator|)
operator|&&
operator|(
name|DEVICE_IS_SSP_INITIATOR
argument_list|(
name|dmDeviceInfo
argument_list|)
operator|||
name|DEVICE_IS_STP_INITIATOR
argument_list|(
name|dmDeviceInfo
argument_list|)
operator|||
name|DEVICE_IS_SMP_INITIATOR
argument_list|(
name|dmDeviceInfo
argument_list|)
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tddmReportDevice: Initiators are not added\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tddmReportDevice: device addrHi 0x%08x addrLo 0x%08x\n"
operator|,
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
operator|,
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|flag
operator|==
name|dmDeviceArrival
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: arrival\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmExpDeviceInfo
operator|!=
name|agNULL
condition|)
block|{
name|sasAddressHi
operator|=
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmExpDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|sasAddressLo
operator|=
name|TD_GET_SAS_ADDRESSLO
argument_list|(
name|dmExpDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|oneExpDeviceData
operator|=
name|tddmPortSASDeviceFind
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasAddressLo
argument_list|,
name|sasAddressHi
argument_list|)
expr_stmt|;
block|}
name|tddmPortDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|dmDeviceInfo
argument_list|,
name|oneExpDeviceData
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
name|dmDeviceRemoval
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: removal\n"
operator|)
argument_list|)
expr_stmt|;
name|sasAddressHi
operator|=
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|sasAddressLo
operator|=
name|TD_GET_SAS_ADDRESSLO
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tddmPortSASDeviceFind
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasAddressLo
argument_list|,
name|sasAddressHi
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* invalidate device */
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: invalidating\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: agDevHandle %p\n"
operator|,
name|oneDeviceData
operator|->
name|agDevHandle
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|agDevHandle
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: agDevHandle->sdkData %p\n"
operator|,
name|oneDeviceData
operator|->
name|agDevHandle
operator|->
name|sdkData
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: agDevHandle->sdkData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|//to do; to be tested
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|&&
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: keeping\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: agDevHandle->sdkData is NULL. Error!!! \n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|//to do remove
ifdef|#
directive|ifdef
name|FDS_SM_WRONG
if|if
condition|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: smDeregisterDevice\n"
operator|)
argument_list|)
expr_stmt|;
name|smDeregisterDevice
argument_list|(
name|smRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
block|}
endif|#
directive|endif
block|}
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
name|dmDeviceNoChange
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: no change; do nothing \n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
name|sasAddressHi
operator|=
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|sasAddressLo
operator|=
name|TD_GET_SAS_ADDRESSLO
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tddmPortSASDeviceFind
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasAddressLo
argument_list|,
name|sasAddressHi
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
if|if
condition|(
operator|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
operator|&&
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agFALSE
condition|)
block|{
name|tdIDStart
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
name|dmDeviceMCNChange
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: dmDeviceMCNChange \n"
operator|)
argument_list|)
expr_stmt|;
name|localMCN
operator|=
name|tdsaFindLocalMCN
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|devMCN
operator|=
name|DEVINFO_GET_EXT_MCN
argument_list|(
name|dmDeviceInfo
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: devMCN 0x%08x localMCN 0x%08x\n"
operator|,
name|devMCN
operator|,
name|localMCN
operator|)
argument_list|)
expr_stmt|;
name|sasAddressHi
operator|=
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|sasAddressLo
operator|=
name|TD_GET_SAS_ADDRESSLO
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tddmPortSASDeviceFind
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasAddressLo
argument_list|,
name|sasAddressHi
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|oneDeviceData
operator|->
name|devMCN
operator|=
name|devMCN
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: sasAddrHi 0x%08x sasAddrLo 0x%08x\n"
operator|,
name|sasAddressHi
operator|,
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|finalMCN
operator|=
name|localMCN
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: directlyAttached, Final MCN 0x%08x\n"
operator|,
name|finalMCN
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|finalMCN
operator|=
name|MIN
argument_list|(
name|devMCN
argument_list|,
name|localMCN
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: Not directlyAttached, Final MCN 0x%08x\n"
operator|,
name|finalMCN
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
comment|/* saSetDeviceInfo to change MCN, using finalMCN */
name|option
operator|=
literal|8
expr_stmt|;
comment|/* setting only MCN 1000b */
name|param
operator|=
name|finalMCN
operator|<<
literal|24
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tddmReportDevice: option 0x%x param 0x%x MCN 0x%x\n"
operator|,
name|option
operator|,
name|param
operator|,
name|finalMCN
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceInfo
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|option
argument_list|,
name|param
argument_list|,
name|ossaSetDeviceInfoCB
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: oneDeviceData is not yet registered !!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|finalMCN
operator|=
name|finalMCN
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
name|dmDeviceRateChange
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: dmDeviceRateChange \n"
operator|)
argument_list|)
expr_stmt|;
name|sasAddressHi
operator|=
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|sasAddressLo
operator|=
name|TD_GET_SAS_ADDRESSLO
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tddmPortSASDeviceFind
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasAddressLo
argument_list|,
name|sasAddressHi
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
name|option
operator|=
literal|0x20
expr_stmt|;
comment|/* bit 5 */
name|DLR
operator|=
name|DEVINFO_GET_LINKRATE
argument_list|(
name|dmDeviceInfo
argument_list|)
expr_stmt|;
name|param
operator|=
name|DLR
operator|<<
literal|28
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: option 0x%x param 0x%x DLR 0x%x\n"
operator|,
name|option
operator|,
name|param
operator|,
name|DLR
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceInfo
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|option
argument_list|,
name|param
argument_list|,
name|ossaSetDeviceInfoCB
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: oneDeviceData is not yet registered !!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmReportDevice: unknown flag 0x%x, wrong\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tdsaUpdateMCN
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|localMCN
init|=
literal|0
decl_stmt|,
name|finalMCN
init|=
literal|0
decl_stmt|;
name|bit32
name|devMCN
init|=
literal|1
decl_stmt|;
name|bit32
name|option
decl_stmt|;
name|bit32
name|param
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaUpdateMCN: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaUpdateMCN: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaUpdateMCN: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaUpdateMCN: onePortContext is invalid\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|localMCN
operator|=
name|tdsaFindLocalMCN
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaUpdateMCN: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* update directly and behind expander device */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaUpdateMCN: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: sasAddrHi 0x%08x sasAddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|devMCN
operator|=
name|oneDeviceData
operator|->
name|devMCN
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: found directly attached\n"
operator|)
argument_list|)
expr_stmt|;
name|finalMCN
operator|=
name|localMCN
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: devMCN 0x%08x localMCN 0x%08x\n"
operator|,
name|devMCN
operator|,
name|localMCN
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: finalMCN 0x%08x\n"
operator|,
name|finalMCN
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|finalMCN
operator|!=
name|finalMCN
condition|)
block|{
comment|/* saSetDeviceInfo using finalMCN */
name|option
operator|=
literal|8
expr_stmt|;
comment|/* setting only MCN 1000b */
name|param
operator|=
name|finalMCN
operator|<<
literal|24
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: option 0x%x param 0x%x MCN 0x%x\n"
operator|,
name|option
operator|,
name|param
operator|,
name|finalMCN
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceInfo
argument_list|(
name|oneDeviceData
operator|->
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|option
argument_list|,
name|param
argument_list|,
name|ossaSetDeviceInfoCB
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|finalMCN
operator|=
name|finalMCN
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: found behind expander device\n"
operator|)
argument_list|)
expr_stmt|;
name|finalMCN
operator|=
name|MIN
argument_list|(
name|localMCN
argument_list|,
name|devMCN
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: devMCN 0x%08x localMCN 0x%08x\n"
operator|,
name|devMCN
operator|,
name|localMCN
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: finalMCN 0x%08x\n"
operator|,
name|finalMCN
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|finalMCN
operator|!=
name|finalMCN
condition|)
block|{
comment|/* saSetDeviceInfo using finalMCN */
name|option
operator|=
literal|8
expr_stmt|;
comment|/* setting only MCN 1000b */
name|param
operator|=
name|finalMCN
operator|<<
literal|24
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: option 0x%x param 0x%x MCN 0x%x\n"
operator|,
name|option
operator|,
name|param
operator|,
name|finalMCN
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceInfo
argument_list|(
name|oneDeviceData
operator|->
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|option
argument_list|,
name|param
argument_list|,
name|ossaSetDeviceInfoCB
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|finalMCN
operator|=
name|finalMCN
expr_stmt|;
block|}
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: different portcontext; oneDeviceData->tdPortContext pid %d oneportcontext pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaUpdateMCN: different portcontext; oneDeviceData->tdPortContext pid NULL oneportcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
comment|/* while */
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|bit8
name|tddmSATADeviceTypeDecode
parameter_list|(
name|bit8
modifier|*
name|pSignature
parameter_list|)
block|{
return|return
operator|(
name|bit8
operator|)
name|tdssSATADeviceTypeDecode
argument_list|(
name|pSignature
argument_list|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tddmSingleThreadedEnter
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|bit32
name|syncLockId
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|bit32
name|offset
init|=
literal|0
decl_stmt|;
name|TI_DBG7
argument_list|(
operator|(
literal|"tddmSingleThreadedEnter: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmSingleThreadedEnter: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmSingleThreadedEnter: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmSingleThreadedEnter: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|offset
operator|=
name|tdsaAllShared
operator|->
name|MaxNumLLLocks
operator|+
name|tdsaAllShared
operator|->
name|MaxNumOSLocks
operator|+
name|TD_MAX_LOCKS
expr_stmt|;
name|ostiSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|syncLockId
operator|+
name|offset
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tddmSingleThreadedLeave
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|bit32
name|syncLockId
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|bit32
name|offset
init|=
literal|0
decl_stmt|;
name|TI_DBG7
argument_list|(
operator|(
literal|"tddmSingleThreadedLeave: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmSingleThreadedLeave: tdsaRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmSingleThreadedLeave: tdsaAllShared is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiRoot
operator|=
name|tdsaAllShared
operator|->
name|agRootOsDataForInt
operator|.
name|tiRoot
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tddmSingleThreadedLeave: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|offset
operator|=
name|tdsaAllShared
operator|->
name|MaxNumLLLocks
operator|+
name|tdsaAllShared
operator|->
name|MaxNumOSLocks
operator|+
name|TD_MAX_LOCKS
expr_stmt|;
name|ostiSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|syncLockId
operator|+
name|offset
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tddmGetTransportParam
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|char
modifier|*
name|key
parameter_list|,
name|char
modifier|*
name|subkey1
parameter_list|,
name|char
modifier|*
name|subkey2
parameter_list|,
name|char
modifier|*
name|subkey3
parameter_list|,
name|char
modifier|*
name|subkey4
parameter_list|,
name|char
modifier|*
name|subkey5
parameter_list|,
name|char
modifier|*
name|valueName
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|bit32
name|bufferLen
parameter_list|,
name|bit32
modifier|*
name|lenReceived
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|tiError
decl_stmt|;
name|TI_DBG7
argument_list|(
operator|(
literal|"tddmGetTransportParam: start\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ostiGetTransportParam
argument_list|(
name|agNULL
argument_list|,
name|key
argument_list|,
name|subkey1
argument_list|,
name|subkey2
argument_list|,
name|subkey3
argument_list|,
name|subkey4
argument_list|,
name|subkey5
argument_list|,
name|valueName
argument_list|,
name|buffer
argument_list|,
name|bufferLen
argument_list|,
name|lenReceived
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FDS_DM */
end_comment

end_unit


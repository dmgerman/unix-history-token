begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  *  * This file contains TB misc. functions  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_comment
comment|/***************************************************************************** *! \brief tiINIIOAbort * *  Purpose:  This function is called to abort an I/O request previously started *             by a call to tiINIIOStart() or tiINIIOStartDif() . * *  \param  tiRoot:          Pointer to initiator driver/port instance. *  \param  taskTag:         Pointer to the associated task to be aborted * *  \return:  * *          tiSuccess:     I/O request successfully initiated.  *          tiBusy:        No resources available, try again later. *          tiIONoDevice:  Invalid device handle. *          tiError:       Other errors that prevent the I/O request to be *                         started. * *****************************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_comment
comment|/*TBD: INITIATOR SPECIFIC API in tiapi.h (TP)*/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINIIOAbort
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|taskTag
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|bit32
name|sasStatus
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot_t
modifier|*
name|smRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|ToBeAbortedtdIORequestBody
decl_stmt|;
name|smIORequest_t
modifier|*
name|ToBeAborted
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIIOAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|taskTag
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbort: taskTag is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|taskTag
operator|->
name|tdData
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbort: DeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIIOAbort: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* for hotplug */
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|registered
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbort: NO Device did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbort: device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbort: device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbort: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbort: ostiAllocMemory returned NULL tdAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
comment|/* setting callback */
name|tdAbortIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOAbortedHandler
expr_stmt|;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/* remember IO to be aborted */
name|tdAbortIORequestBody
operator|->
name|tiIOToBeAbortedRequest
operator|=
name|taskTag
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SAS_DEVICE
condition|)
block|{
name|sasStatus
operator|=
name|saSSPAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
literal|0
comment|/* flag */
argument_list|,
name|agIORequest
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sasStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
return|return
name|tiError
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIIOAbort: calling satIOAbort() oneDeviceData=%p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
expr_stmt|;
if|if
condition|(
name|taskTag
operator|!=
name|agNULL
condition|)
block|{
name|ToBeAbortedtdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|taskTag
operator|->
name|tdData
expr_stmt|;
name|ToBeAborted
operator|=
operator|&
operator|(
name|ToBeAbortedtdIORequestBody
operator|->
name|smIORequest
operator|)
expr_stmt|;
name|status
operator|=
name|smIOAbort
argument_list|(
name|smRoot
argument_list|,
name|ToBeAborted
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbort: taskTag is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
else|#
directive|else
ifdef|#
directive|ifdef
name|SATA_ENABLE
name|status
operator|=
name|satIOAbort
argument_list|(
name|tiRoot
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|status
return|;
endif|#
directive|endif
comment|/* else FDS_SM */
block|}
else|else
block|{
return|return
name|tiError
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tiINIIOAbortAll
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|smRoot_t
modifier|*
name|smRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbortAll: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbortAll: tiDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbortAll: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* for hotplug */
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|registered
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbortAll: NO Device did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbortAll: device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbortAll: device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
if|if
condition|(
name|agRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbortAll: agRoot is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* this is processed in ossaSSPAbortCB, ossaSATAAbortCB, ossaSMPAbortCB */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbortAll: already pending!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiBusy
return|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agTRUE
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FDS_SM
if|if
condition|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|status
operator|=
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIIOAbortAll: calling smIOAbortAll\n"
operator|)
argument_list|)
expr_stmt|;
name|smDeviceHandle
operator|=
operator|(
name|smDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
expr_stmt|;
name|smDeviceHandle
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
name|status
operator|=
name|smIOAbortAll
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOAbortAll: unknow device type!!! 0x%x\n"
operator|,
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
else|#
directive|else
name|status
operator|=
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INITIATOR_DRIVER	*/
end_comment

begin_comment
comment|/***************************************************************************** *! \brief tdsaAbortAll * *  Purpose:  This function is called to abort an all pending I/O request on a *            device * *  \param  tiRoot:          Pointer to initiator driver/port instance. *  \param  agRoot:          Pointer to chip/driver Instance. *  \param  oneDeviceData:   Pointer to the device * *  \return:  * *          None * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaAbortAll
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|bit32
name|status
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaAbortAll: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaAbortAll: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaAbortAll: ostiAllocMemory returned NULL tdAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
comment|/* setting callback but not used later */
name|tdAbortIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|agNULL
expr_stmt|;
comment|//tdAbortIORequestBody->IOCompletionFunc = itdssIOAbortedHandler;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
operator|(
name|tiDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
if|if
condition|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
comment|/* SSPAbort */
name|status
operator|=
name|saSSPAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
comment|//0,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|1
argument_list|,
comment|/* abort all */
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
comment|/* SATAAbort*/
if|if
condition|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaAbortAll: saSATAAbort\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|1
argument_list|,
comment|/* abort all */
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaAbortAll: saSATAAbort IDDeviceValid\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
comment|//0,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|1
argument_list|,
comment|/* abort all */
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
comment|/* SMPAbort*/
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaAbortAll: saSMPAbort \n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|saSMPAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
comment|//0,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|1
argument_list|,
comment|/* abort all */
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaAbortAll: unknown device type!!! 0x%x\n"
operator|,
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaAbortAll: failed status=%d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|//failed to send abort command, we need to free the memory
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tiCOMReset * *  Purpose:  This function is called to trigger soft or hard reset * *  \param  tiRoot:          Pointer to initiator driver/port instance. *  \param  option:          Options * *  \return:  * *          None * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tiCOMReset
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|option
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
ifdef|#
directive|ifdef
name|TI_GETFOR_ONRESET
name|agsaControllerStatus_t
name|controllerStatus
decl_stmt|;
name|agsaForensicData_t
name|forensicData
decl_stmt|;
name|bit32
name|once
init|=
literal|1
decl_stmt|;
name|bit32
name|status
decl_stmt|;
endif|#
directive|endif
comment|/* TI_GETFOR_ONRESET */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMReset: start option 0x%x\n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|resetCount
operator|++
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMReset: reset count %d\n"
operator|,
name|tdsaAllShared
operator|->
name|resetCount
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|flags
operator|.
name|resetInProgress
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMReset : Reset is already in progress : \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* don't do anything : just return */
return|return;
block|}
name|tdsaAllShared
operator|->
name|flags
operator|.
name|resetInProgress
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|TI_GETFOR_ONRESET
name|saGetControllerStatus
argument_list|(
name|agRoot
argument_list|,
operator|&
name|controllerStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|controllerStatus
operator|.
name|fatalErrorInfo
operator|.
name|errorInfo1
condition|)
block|{
name|bit8
modifier|*
name|DirectData
init|=
operator|(
name|bit8
operator|*
operator|)
name|tdsaAllShared
operator|->
name|FatalErrorData
decl_stmt|;
name|forensicData
operator|.
name|DataType
operator|=
name|TYPE_FATAL
expr_stmt|;
name|forensicData
operator|.
name|dataBuf
operator|.
name|directLen
operator|=
operator|(
literal|8
operator|*
literal|1024
operator|)
expr_stmt|;
name|forensicData
operator|.
name|dataBuf
operator|.
name|directOffset
operator|=
literal|0
expr_stmt|;
comment|/* current offset */
name|forensicData
operator|.
name|dataBuf
operator|.
name|readLen
operator|=
literal|0
expr_stmt|;
comment|/* Data read */
name|getmoreData
label|:
name|forensicData
operator|.
name|dataBuf
operator|.
name|directData
operator|=
name|DirectData
expr_stmt|;
name|status
operator|=
name|saGetForensicData
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
name|forensicData
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMReset:status %d readLen 0x%x directLen 0x%x directOffset 0x%x\n"
operator|,
name|status
operator|,
name|forensicData
operator|.
name|dataBuf
operator|.
name|readLen
operator|,
name|forensicData
operator|.
name|dataBuf
operator|.
name|directLen
operator|,
name|forensicData
operator|.
name|dataBuf
operator|.
name|directOffset
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|forensicData
operator|.
name|dataBuf
operator|.
name|readLen
operator|==
name|forensicData
operator|.
name|dataBuf
operator|.
name|directLen
operator|&&
operator|!
name|status
operator|&&
name|once
condition|)
block|{
name|DirectData
operator|+=
name|forensicData
operator|.
name|dataBuf
operator|.
name|readLen
expr_stmt|;
goto|goto
name|getmoreData
goto|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMReset:saGetForensicData type %d read 0x%x bytes\n"
operator|,
name|forensicData
operator|.
name|DataType
operator|,
name|forensicData
operator|.
name|dataBuf
operator|.
name|directOffset
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* TI_GETFOR_ONRESET */
if|if
condition|(
name|option
operator|==
name|tiSoftReset
condition|)
block|{
comment|/* soft reset */
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMReset: soft reset\n"
operator|)
argument_list|)
expr_stmt|;
name|saHwReset
argument_list|(
name|agRoot
argument_list|,
name|AGSA_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|saHwReset
argument_list|(
name|agRoot
argument_list|,
name|AGSA_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* hard reset */
name|saHwReset
argument_list|(
name|agRoot
argument_list|,
name|AGSA_CHIP_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \biref tiINIReportErrorToEventLog  *  *  Purpose: This function is called to report errors that needs to be logged  *           into event log.  *  *  \param tiRoot:      Pointer to initiator specific root data structure  for this  *                      instance of the driver.  *  \param agEventData: Event data structure.  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_function
name|osGLOBAL
name|bit32
name|tiINIReportErrorToEventLog
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiEVTData_t
modifier|*
name|agEventData
parameter_list|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIReportErrorToEventLog: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INITIATOR_DRIVER */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaReenableInterrupts  *    *  *  Purpose: This routine is called to enable interrupt  *  *    *  \param  agRoot:               Pointer to chip/driver Instance.  *  \param  outboundChannelNum:   Zero-base channel number  *  *   *  \return None.  *  *  \note - The scope is shared target and initiator.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|ossaReenableInterrupts
end_ifndef

begin_function
name|osGLOBAL
name|void
name|ossaReenableInterrupts
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|outboundChannelNum
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
decl_stmt|;
name|ostiInterruptEnable
argument_list|(
name|osData
operator|->
name|tiRoot
argument_list|,
name|outboundChannelNum
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* 1. initiator    send task management    call saSSPAbort()  2. Target    call saSSPAbort()  */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief tiINITaskManagement * * Purpose:  This routine is called to explicitly ask the Transport Dependent *           Layer to issue a Task Management command to a device. * *  \param tiRoot:         Pointer to driver instance *  \param tiDeviveHandle: Pointer to the device handle for this session. *  \param task:           SAM-2 task management request. *  \param lun:            Pointer to the SCSI-3 LUN information *                         when applicable. Set to zero when not applicable. *  \param taskTag:        Pointer to the associated task where the task *                         management command is to be applied. Set to agNULL *                         if not applicable for the specific Task Management *                         task. *  \param currentTaskTag: The current context or task tag for this task. This *                         task tag will be passed back in ostiInitiatorEvent() *                         when this task management is completed. * *  \return: *         tiSuccess     TM request successfully initiated. *         tiBusy        No resources available, try again later. *         tiIONoDevice  Invalid device handle. *         tiError       Other errors that prevent the TM request to be started. * *****************************************************************************/
end_comment

begin_comment
comment|/*    warm reset->smp phy control(hard reset) or saLocalPhyControl(AGSA_PHY_HARD_RESET)    */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_function
name|osGLOBAL
name|bit32
name|tiINITaskManagement
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|bit32
name|task
parameter_list|,
name|tiLUN_t
modifier|*
name|lun
parameter_list|,
name|tiIORequest_t
modifier|*
name|taskTag
parameter_list|,
comment|/* being aborted one */
name|tiIORequest_t
modifier|*
name|currentTaskTag
comment|/* task management itself */
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|bit32
name|notImplemented
init|=
name|agFALSE
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|TMtdIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
comment|/* task management itself */
name|agsaIORequest_t
modifier|*
name|agTMRequest
init|=
name|agNULL
decl_stmt|;
comment|/* IO being task managed */
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSSPScsiTaskMgntReq_t
modifier|*
name|agSSPTaskMgntRequest
decl_stmt|;
name|bit32
name|saStatus
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot_t
modifier|*
name|smRoot
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smIORequest_t
modifier|*
name|ToBeAborted
init|=
name|agNULL
decl_stmt|;
name|smIORequest_t
modifier|*
name|TaskManagement
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|ToBeAbortedtdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|SMTMtdIORequestBody
decl_stmt|;
name|void
modifier|*
name|SMosMemHandle
decl_stmt|;
name|bit32
name|SMPhysUpper32
decl_stmt|;
name|bit32
name|SMPhysLower32
decl_stmt|;
name|bit32
name|SMmemAllocStatus
decl_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITaskManagement: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* just for testing only */
ifdef|#
directive|ifdef
name|REMOVED
comment|//start temp
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: tiDeviceHandle=%p DeviceData is NULL\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
comment|//end temp
comment|// just for testing
if|if
condition|(
name|task
operator|==
name|AG_LOGICAL_UNIT_RESET
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: failing LUN RESET for testing\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|task
condition|)
block|{
case|case
name|AG_ABORT_TASK
case|:
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINITaskManagement: ABORT_TASK\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AG_ABORT_TASK_SET
case|:
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINITaskManagement: ABORT_TASK_SET\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AG_CLEAR_ACA
case|:
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINITaskManagement: CLEAR_ACA\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AG_CLEAR_TASK_SET
case|:
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINITaskManagement: CLEAR_TASK_SET\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AG_LOGICAL_UNIT_RESET
case|:
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINITaskManagement: LOGICAL_UNIT_RESET\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AG_TARGET_WARM_RESET
case|:
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINITaskManagement: TARGET_WARM_RESET\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AG_QUERY_TASK
case|:
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINITaskManagement: QUERY_TASK\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: notImplemented 0x%0x !!!\n"
operator|,
name|task
operator|)
argument_list|)
expr_stmt|;
name|notImplemented
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|notImplemented
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: not implemented 0x%0x !!!\n"
operator|,
name|task
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: tiDeviceHandle=%p DeviceData is NULL\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiIONoDevice
return|;
block|}
comment|/* for hotplug */
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|registered
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: NO Device did %d Addr 0x%08x:0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiIONoDevice
return|;
block|}
comment|/* 1. call tiINIOAbort()       2. call tdssTaskXmit()   */
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SAS_DEVICE
condition|)
block|{
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: SAS Device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*        WARM_RESET is experimental code.        Needs more testing and debugging     */
if|if
condition|(
name|task
operator|==
name|AG_TARGET_WARM_RESET
condition|)
block|{
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|currentTaskTag
operator|->
name|tdData
operator|=
name|tdsaDeviceData
expr_stmt|;
name|agContext
operator|=
operator|&
operator|(
name|tdsaDeviceData
operator|->
name|agDeviceResetContext
operator|)
expr_stmt|;
name|agContext
operator|->
name|osData
operator|=
name|currentTaskTag
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITaskManagement: did %d device reset for SAS\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_IN_RECOVERY
argument_list|)
expr_stmt|;
comment|/* warm reset by saLocalPhyControl or SMP PHY control */
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITaskManagement: device reset directly attached\n"
operator|)
argument_list|)
expr_stmt|;
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITaskManagement: device reset expander attached\n"
operator|)
argument_list|)
expr_stmt|;
name|saStatus
operator|=
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|currentTaskTag
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|saStatus
return|;
block|}
block|}
else|else
block|{
comment|/* task management */
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINITaskManagement: making task management frame \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 1. create task management frame          2. sends it using "saSSPStart()"       */
comment|/* Allocate memory for task management */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|TMtdIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|TMtdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: ostiAllocMemory returned NULL TMIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* initialize */
name|osti_memset
argument_list|(
name|TMtdIORequestBody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup task management structure */
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|CurrentTaskTag
operator|=
name|currentTaskTag
expr_stmt|;
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|TaskTag
operator|=
name|taskTag
expr_stmt|;
comment|/* let's initialize tdIOrequestBody */
comment|/* initialize jump table */
comment|/* direct callback for task management */
name|TMtdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssTaskCompleted
expr_stmt|;
comment|/* to be removed */
comment|/* TMtdIORequestBody->IOCompletionFunc = itdssIOCompleted; */
comment|/* initialize tiDevhandle */
name|TMtdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize tiIORequest */
name|TMtdIORequestBody
operator|->
name|tiIORequest
operator|=
name|currentTaskTag
expr_stmt|;
comment|/* save context if we need to abort later */
name|currentTaskTag
operator|->
name|tdData
operator|=
name|TMtdIORequestBody
expr_stmt|;
comment|/* initialize agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|TMtdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|TMtdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SA takes care of this */
comment|/* request type */
name|agRequestType
operator|=
name|AGSA_SSP_TASK_MGNT_REQ
expr_stmt|;
name|TMtdIORequestBody
operator|->
name|agRequestType
operator|=
name|AGSA_SSP_TASK_MGNT_REQ
expr_stmt|;
comment|/*         initialize         tdIORequestBody_t tdIORequestBody -> agSASRequestBody       */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|TMtdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPTaskMgntRequest
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspTaskMgntReq
operator|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITaskManagement: did %d LUN reset for SAS\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* fill up LUN field */
if|if
condition|(
name|lun
operator|==
name|agNULL
condition|)
block|{
name|osti_memset
argument_list|(
name|agSSPTaskMgntRequest
operator|->
name|lun
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|osti_memcpy
argument_list|(
name|agSSPTaskMgntRequest
operator|->
name|lun
argument_list|,
name|lun
operator|->
name|lun
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
comment|/* default: unconditionally set device state to SA_DS_IN_RECOVERY          bit1 (DS) bit0 (ADS)          bit1: 1 bit0: 0       */
name|agSSPTaskMgntRequest
operator|->
name|tmOption
operator|=
literal|2
expr_stmt|;
comment|/* sets taskMgntFunction field */
switch|switch
condition|(
name|task
condition|)
block|{
case|case
name|AG_ABORT_TASK
case|:
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|=
name|AGSA_ABORT_TASK
expr_stmt|;
comment|/* For abort task management, unconditionally set device state to SA_DS_IN_RECOVERY            and if can't find, set device state to SA_DS_IN_RECOVERY            bit1 (DS) bit0 (ADS)            bit1: 1; bit0: 1         */
name|agSSPTaskMgntRequest
operator|->
name|tmOption
operator|=
literal|3
expr_stmt|;
break|break;
case|case
name|AG_ABORT_TASK_SET
case|:
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|=
name|AGSA_ABORT_TASK_SET
expr_stmt|;
break|break;
case|case
name|AG_CLEAR_ACA
case|:
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|=
name|AGSA_CLEAR_ACA
expr_stmt|;
break|break;
case|case
name|AG_CLEAR_TASK_SET
case|:
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|=
name|AGSA_CLEAR_TASK_SET
expr_stmt|;
break|break;
case|case
name|AG_LOGICAL_UNIT_RESET
case|:
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|=
name|AGSA_LOGICAL_UNIT_RESET
expr_stmt|;
break|break;
case|case
name|AG_QUERY_TASK
case|:
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|=
name|AGSA_QUERY_TASK
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: notImplemented task\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|task
operator|==
name|AGSA_ABORT_TASK
operator|||
name|task
operator|==
name|AGSA_QUERY_TASK
condition|)
block|{
comment|/* set agTMRequest, which is IO being task managed */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|taskTag
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* to be aborted IO has been completed. */
comment|/* free up allocated memory */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: IO has been completed\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|tiIONoDevice
return|;
block|}
else|else
block|{
name|agTMRequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*           For LUN RESET, WARM_RESET, ABORT_TASK_SET, CLEAR_ACA and CLEAR_TASK_SET           no tag to be managed.           Therefore, set it to zero.         */
name|agSSPTaskMgntRequest
operator|->
name|tagOfTaskToBeManaged
operator|=
literal|0
expr_stmt|;
name|agTMRequest
operator|=
name|agNULL
expr_stmt|;
block|}
name|TDLIST_INIT_HDR
argument_list|(
operator|&
name|TMtdIORequestBody
operator|->
name|EsglPageList
argument_list|)
expr_stmt|;
comment|/* debuggging */
if|if
condition|(
name|TMtdIORequestBody
operator|->
name|IOCompletionFunc
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: Error!!!!! IOCompletionFunc is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
comment|/* task management itself */
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
comment|/* task management itself */
name|agTMRequest
argument_list|,
comment|/* io to be aborted if exits */
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|Initiator
operator|->
name|NumIOsActive
operator|++
expr_stmt|;
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: saSSPStart failed 0x%x\n"
operator|,
name|saStatus
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
else|else
block|{
comment|/* AGSA_RC_BUSY */
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* end of sas device */
ifdef|#
directive|ifdef
name|FDS_SM
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
name|agsaContext_t
modifier|*
name|agContext
init|=
name|agNULL
decl_stmt|;
comment|/* save the task tag in tdsaDeviceData_t structure, for handling PORT_RESET_COMPLETE hw event */
name|agContext
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|agDeviceResetContext
operator|)
expr_stmt|;
name|agContext
operator|->
name|osData
operator|=
name|currentTaskTag
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
comment|/* for directly attached SATA, do localphycontrol for LUN and target reset, not smTaskManagement*/
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
operator|&&
operator|(
name|task
operator|==
name|AG_LOGICAL_UNIT_RESET
operator|||
name|task
operator|==
name|AG_TARGET_WARM_RESET
operator|)
condition|)
block|{
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|currentTaskTag
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
if|if
condition|(
name|task
operator|==
name|AG_LOGICAL_UNIT_RESET
condition|)
block|{
if|if
condition|(
operator|(
name|lun
operator|->
name|lun
index|[
literal|0
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|1
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|2
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|3
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|4
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|5
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|6
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|7
index|]
operator|)
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: *** REJECT *** LUN not zero, tiDeviceHandle=%p\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
block|}
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_IN_RECOVERY
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|smRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
expr_stmt|;
name|smDeviceHandle
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: FDS_SM SATA Device\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|taskTag
operator|!=
name|agNULL
condition|)
block|{
name|ToBeAbortedtdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|taskTag
operator|->
name|tdData
expr_stmt|;
name|ToBeAborted
operator|=
operator|&
operator|(
name|ToBeAbortedtdIORequestBody
operator|->
name|smIORequest
operator|)
expr_stmt|;
block|}
name|SMmemAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|SMosMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|SMTMtdIORequestBody
argument_list|,
operator|&
name|SMPhysUpper32
argument_list|,
operator|&
name|SMPhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|SMmemAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: ostiAllocMemory failed... loc 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|SMTMtdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: ostiAllocMemory returned NULL TMIORequestBody loc 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* initialize */
name|osti_memset
argument_list|(
name|SMTMtdIORequestBody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup task management structure */
name|SMTMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|SMosMemHandle
expr_stmt|;
name|SMTMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|CurrentTaskTag
operator|=
name|currentTaskTag
expr_stmt|;
name|SMTMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|TaskTag
operator|=
name|taskTag
expr_stmt|;
comment|/* initialize tiDevhandle */
name|SMTMtdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize tiIORequest */
name|SMTMtdIORequestBody
operator|->
name|tiIORequest
operator|=
name|currentTaskTag
expr_stmt|;
comment|/* save context if we need to abort later */
name|currentTaskTag
operator|->
name|tdData
operator|=
name|SMTMtdIORequestBody
expr_stmt|;
name|TaskManagement
operator|=
operator|&
operator|(
name|SMTMtdIORequestBody
operator|->
name|smIORequest
operator|)
expr_stmt|;
name|TaskManagement
operator|->
name|tdData
operator|=
name|SMTMtdIORequestBody
expr_stmt|;
name|TaskManagement
operator|->
name|smData
operator|=
operator|&
name|SMTMtdIORequestBody
operator|->
name|smIORequestBody
expr_stmt|;
name|tiStatus
operator|=
name|smTaskManagement
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|task
argument_list|,
operator|(
name|smLUN_t
operator|*
operator|)
name|lun
argument_list|,
name|ToBeAborted
argument_list|,
name|TaskManagement
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiStatus
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: smTaskManagement failed... loc 2\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|SMTMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* else */
block|}
else|#
directive|else
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: not FDS_SM SATA Device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       WARM_RESET is experimental       Needs more testing and debugging       Soft reset for SATA as LUN RESET tends not to work.        Let's do hard reset     */
if|if
condition|(
name|task
operator|==
name|AG_LOGICAL_UNIT_RESET
operator|||
name|task
operator|==
name|AG_TARGET_WARM_RESET
condition|)
block|{
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITaskManagement: did %d LUN reset or device reset for SATA\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|satDevData
operator|=
operator|&
name|tdsaDeviceData
operator|->
name|satDevData
expr_stmt|;
name|currentTaskTag
operator|->
name|tdData
operator|=
name|tdsaDeviceData
expr_stmt|;
name|agContext
operator|=
operator|&
operator|(
name|tdsaDeviceData
operator|->
name|agDeviceResetContext
operator|)
expr_stmt|;
name|agContext
operator|->
name|osData
operator|=
name|currentTaskTag
expr_stmt|;
if|if
condition|(
name|task
operator|==
name|AG_LOGICAL_UNIT_RESET
condition|)
block|{
if|if
condition|(
operator|(
name|lun
operator|->
name|lun
index|[
literal|0
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|1
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|2
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|3
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|4
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|5
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|6
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|7
index|]
operator|)
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: *** REJECT *** LUN not zero, tiDeviceHandle=%p\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/*           * Check if there is other TM request pending           */
if|if
condition|(
name|satDevData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: *** REJECT *** other TM pending, tiDeviceHandle=%p\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
block|}
name|satDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
name|satDevData
operator|->
name|satAbortAfterReset
operator|=
name|agFALSE
expr_stmt|;
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_IN_RECOVERY
argument_list|)
expr_stmt|;
comment|/*         warm reset by saLocalPhyControl or SMP PHY control         */
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: LUN reset or device reset directly attached\n"
operator|)
argument_list|)
expr_stmt|;
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: LUN reset or device reset expander attached\n"
operator|)
argument_list|)
expr_stmt|;
name|saStatus
operator|=
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|currentTaskTag
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|saStatus
return|;
block|}
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITaskManagement: calling satTM().\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocation tdIORequestBody and pass it to satTM() */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|TMtdIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: ostiAllocMemory failed... loc 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|TMtdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITaskManagement: ostiAllocMemory returned NULL TMIORequestBody loc 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* initialize */
name|osti_memset
argument_list|(
name|TMtdIORequestBody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup task management structure */
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|CurrentTaskTag
operator|=
name|currentTaskTag
expr_stmt|;
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|TaskTag
operator|=
name|taskTag
expr_stmt|;
comment|/* initialize tiDevhandle */
name|TMtdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize tiIORequest */
name|TMtdIORequestBody
operator|->
name|tiIORequest
operator|=
name|currentTaskTag
expr_stmt|;
comment|/* save context if we need to abort later */
name|currentTaskTag
operator|->
name|tdData
operator|=
name|TMtdIORequestBody
expr_stmt|;
comment|/* initialize agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|TMtdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|TMtdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SA takes care of this */
ifdef|#
directive|ifdef
name|SATA_ENABLE
name|tiStatus
operator|=
name|satTM
argument_list|(
name|tiRoot
argument_list|,
name|tiDeviceHandle
argument_list|,
name|task
argument_list|,
name|lun
argument_list|,
name|taskTag
argument_list|,
name|currentTaskTag
argument_list|,
name|TMtdIORequestBody
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
endif|#
directive|endif
comment|/* FDS_SM else*/
return|return
name|tiStatus
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INITIATOR_DRIVER */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PASSTHROUGH
end_ifdef

begin_function
name|osGLOBAL
name|bit32
name|tiCOMPassthroughCmndStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPassthroughRequest_t
modifier|*
name|tiPassthroughRequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiPassthroughCmnd_t
modifier|*
name|tiPassthroughCmnd
parameter_list|,
name|void
modifier|*
name|tiPassthroughBody
parameter_list|,
name|tiPortalContext_t
modifier|*
name|tiportalContext
parameter_list|,
name|ostiPassthroughCmndEvent_t
name|agEventCB
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|tdPassthroughCmndBody_t
modifier|*
name|tdPTCmndBody
decl_stmt|;
name|tdssSMPRequestBody_t
modifier|*
name|tdssSMPRequestBody
decl_stmt|;
name|agsaSMPFrame_t
modifier|*
name|agSMPFrame
decl_stmt|;
name|agsaSSPVSFrame_t
modifier|*
name|agSSPVendorFrame
decl_stmt|;
comment|/* RMC */
name|bit32
name|SMPFn
decl_stmt|,
name|SMPFnResult
decl_stmt|,
name|SMPFrameLen
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|bit32
name|saStatus
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|tdsaPortStartInfo_t
modifier|*
name|tdsaPortStartInfo
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|tdsaPortContext
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: onedevicedata %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
name|tdPTCmndBody
operator|=
operator|(
name|tdPassthroughCmndBody_t
operator|*
operator|)
name|tiPassthroughBody
expr_stmt|;
if|if
condition|(
name|tiPassthroughCmnd
operator|->
name|passthroughCmnd
operator|!=
name|tiSMPCmnd
operator|||
name|tiPassthroughCmnd
operator|->
name|passthroughCmnd
operator|!=
name|tiRMCCmnd
condition|)
block|{
return|return
name|tiNotSupported
return|;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
operator|&&
name|tiPassthroughCmnd
operator|->
name|passthroughCmnd
operator|!=
name|tiSMPCmnd
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: tiDeviceHandle=%p DeviceData is NULL\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiIONoDevice
return|;
block|}
comment|/* starting IO with SAS device */
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SAS_DEVICE
condition|)
block|{
if|if
condition|(
name|tiPassthroughCmnd
operator|->
name|passthroughCmnd
operator|==
name|tiSMPCmnd
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: SMP\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|tdsaPortStartInfo
operator|=
operator|(
name|tdsaPortStartInfo_t
operator|*
operator|)
name|tiportalContext
operator|->
name|tdData
expr_stmt|;
name|tdsaPortContext
operator|=
name|tdsaPortStartInfo
operator|->
name|portContext
expr_stmt|;
name|agRoot
operator|=
name|tdsaPortContext
operator|->
name|agRoot
expr_stmt|;
block|}
else|else
block|{
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
block|}
name|tdssSMPRequestBody
operator|=
operator|&
operator|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|SMPBody
operator|)
expr_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdssSMPRequestBody
operator|->
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSMPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|smpFrame
operator|)
expr_stmt|;
comment|/* saves callback function */
name|tdPTCmndBody
operator|->
name|EventCB
operator|=
name|agEventCB
expr_stmt|;
comment|/* initialize command type  */
name|tdPTCmndBody
operator|->
name|tiPassthroughCmndType
operator|=
name|tiSMPCmnd
expr_stmt|;
comment|/* initialize tipassthroughrequest  */
name|tdPTCmndBody
operator|->
name|tiPassthroughRequest
operator|=
name|tiPassthroughRequest
expr_stmt|;
name|tiPassthroughRequest
operator|->
name|tdData
operator|=
name|tdPTCmndBody
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdPTCmndBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* fill in SMP header */
name|agSMPFrame
operator|->
name|frameHeader
operator|.
name|smpFrameType
operator|=
name|tiPassthroughCmnd
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|SMPHeader
operator|.
name|smpFrameType
expr_stmt|;
name|agSMPFrame
operator|->
name|frameHeader
operator|.
name|smpFunction
operator|=
name|tiPassthroughCmnd
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|SMPHeader
operator|.
name|smpFunction
expr_stmt|;
name|agSMPFrame
operator|->
name|frameHeader
operator|.
name|smpFunctionResult
operator|=
name|tiPassthroughCmnd
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|SMPHeader
operator|.
name|smpFunctionResult
expr_stmt|;
name|agSMPFrame
operator|->
name|frameHeader
operator|.
name|smpReserved
operator|=
name|tiPassthroughCmnd
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|SMPHeader
operator|.
name|smpReserved
expr_stmt|;
if|if
condition|(
name|tiPassthroughCmnd
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SMP_INIT_REQ
expr_stmt|;
block|}
else|else
block|{
name|agRequestType
operator|=
name|AGSA_SMP_TGT_RESPONSE
expr_stmt|;
comment|/* this is only for SMP target */
name|agSMPFrame
operator|->
name|phyId
operator|=
name|tiPassthroughCmnd
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|phyID
expr_stmt|;
block|}
comment|/* fill in payload */
comment|/* assumption: SMP payload is in tisgl1 */
name|agSMPFrame
operator|->
name|frameAddrUpper32
operator|=
name|tiPassthroughCmnd
operator|->
name|tiSgl
operator|.
name|upper
expr_stmt|;
name|agSMPFrame
operator|->
name|frameAddrLower32
operator|=
name|tiPassthroughCmnd
operator|->
name|tiSgl
operator|.
name|lower
expr_stmt|;
comment|/* This length excluding SMP header (4 bytes) and CRC field */
name|agSMPFrame
operator|->
name|frameLen
operator|=
name|tiPassthroughCmnd
operator|->
name|tiSgl
operator|.
name|len
expr_stmt|;
comment|/* initialize agIORequest */
comment|/*         Compare:         tdIORequestBody        = (tdIORequestBody_t *)agIORequest->osData;       */
name|agIORequest
operator|=
operator|&
operator|(
name|tdssSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdPTCmndBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/* not work yet because of high priority q */
name|saStatus
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: saSMPStart failed\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
else|else
block|{
comment|/* AGSA_RC_BUSY */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: saSMPStart busy\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
return|return
name|tiStatus
return|;
ifdef|#
directive|ifdef
name|TO_DO
comment|/* fill in SMP header */
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|agSMPFrame
operator|->
name|frameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP REQUEST */
name|agRequestType
operator|=
name|AGSA_SMP_INIT_REQ
expr_stmt|;
block|}
else|else
block|{
comment|/* SMP target */
name|agSMPFrame
operator|->
name|frameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_RESPONSE
expr_stmt|;
comment|/* SMP RESPONSE */
name|agRequestType
operator|=
name|AGSA_SMP_TGT_RESPONSE
expr_stmt|;
switch|switch
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|SMPFnResult
condition|)
block|{
case|case
name|tiSMPFunctionAccepted
case|:
name|SMPFnResult
operator|=
name|SMP_FUNCTION_ACCEPTED
expr_stmt|;
break|break;
case|case
name|tiUnknownSMPFunction
case|:
name|SMPFnResult
operator|=
name|UNKNOWN_SMP_FUNCTION
expr_stmt|;
break|break;
case|case
name|tiSMPFunctionFailed
case|:
name|SMPFnResult
operator|=
name|SMP_FUNCTION_FAILED
expr_stmt|;
break|break;
case|case
name|tiInvalidRequestFrameLength
case|:
name|SMPFnResult
operator|=
name|INVALID_REQUEST_FRAME_LENGTH
expr_stmt|;
break|break;
case|case
name|tiPhyDoesNotExist
case|:
name|SMPFnResult
operator|=
name|PHY_DOES_NOT_EXIST
expr_stmt|;
break|break;
case|case
name|tiIndexDoesNotExist
case|:
name|SMPFnResult
operator|=
name|INDEX_DOES_NOT_EXIST
expr_stmt|;
break|break;
case|case
name|tiPhyDoesNotSupportSATA
case|:
name|SMPFnResult
operator|=
name|PHY_DOES_NOT_SUPPORT_SATA
expr_stmt|;
break|break;
case|case
name|tiUnknownPhyOperation
case|:
name|SMPFnResult
operator|=
name|UNKNOWN_PHY_OPERATION
expr_stmt|;
break|break;
case|case
name|tiUnknownPhyTestFunction
case|:
name|SMPFnResult
operator|=
name|UNKNOWN_PHY_TEST_FUNCTION
expr_stmt|;
break|break;
case|case
name|tiPhyTestFunctionInProgress
case|:
name|SMPFnResult
operator|=
name|PHY_TEST_FUNCTION_IN_PROGRESS
expr_stmt|;
break|break;
case|case
name|tiPhyVacant
case|:
name|SMPFnResult
operator|=
name|PHY_VACANT
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: unknown SMP function result %d\n"
operator|,
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|SMPFnResult
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|agSMPFrame
operator|->
name|frameHeader
operator|.
name|smpFunctionResult
operator|=
name|SMPFnResult
expr_stmt|;
block|}
comment|/* common */
switch|switch
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|SMPFn
condition|)
block|{
case|case
name|tiGeneral
case|:
name|SMPFn
operator|=
name|SMP_REPORT_GENERAL
expr_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|SMPFrameLen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|SMPFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|tiManufacturerInfo
case|:
name|SMPFn
operator|=
name|SMP_REPORT_MANUFACTURE_INFORMATION
expr_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|SMPFrameLen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|SMPFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportManufactureInfo_t
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|tiDiscover
case|:
name|SMPFn
operator|=
name|SMP_DISCOVER
expr_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|SMPFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|smpReqDiscover_t
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SMPFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|tiReportPhyErrLog
case|:
name|SMPFn
operator|=
name|SMP_REPORT_PHY_ERROR_LOG
expr_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|SMPFrameLen
operator|=
literal|8
expr_stmt|;
block|}
else|else
block|{
name|SMPFrameLen
operator|=
literal|24
expr_stmt|;
block|}
break|break;
case|case
name|tiReportPhySATA
case|:
name|SMPFn
operator|=
name|SMP_REPORT_PHY_SATA
expr_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|SMPFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|SmpReqReportPhySata_t
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SMPFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|SmpRespReportPhySata_t
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|tiReportRteInfo
case|:
name|SMPFn
operator|=
name|SMP_REPORT_ROUTING_INFORMATION
expr_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|SMPFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|SmpReqReportRouteTable_t
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SMPFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|SmpRespReportRouteTable_t
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|tiConfigureRteInfo
case|:
name|SMPFn
operator|=
name|SMP_CONFIGURE_ROUTING_INFORMATION
expr_stmt|;
empty_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|SMPFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|SmpReqConfigureRouteInformation_t
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SMPFrameLen
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|tiPhyCtrl
case|:
name|SMPFn
operator|=
name|SMP_PHY_CONTROL
expr_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|SMPFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|SmpReqPhyControl_t
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SMPFrameLen
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|tiPhyTestFn
case|:
name|SMPFn
operator|=
name|SMP_PHY_TEST_FUNCTION
expr_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|SMPFrameLen
operator|=
literal|36
expr_stmt|;
block|}
else|else
block|{
name|SMPFrameLen
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|tiPMC
case|:
name|SMPFn
operator|=
name|SMP_PMC_SPECIFIC
expr_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|IT
operator|==
name|SMP_INITIATOR
condition|)
block|{
name|SMPFrameLen
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|SMPFrameLen
operator|=
literal|0
expr_stmt|;
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: unknown SMP function %d\n"
operator|,
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|SMPFn
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|agSMPFrame
operator|->
name|frameHeader
operator|.
name|smpFunction
operator|=
name|SMPFn
expr_stmt|;
comment|/* assumption: SMP payload is in tisgl1 */
name|agSMPFrame
operator|->
name|frameAddrUpper32
operator|=
name|tdPTCmndBody
operator|->
name|tiSgl
operator|.
name|upper
expr_stmt|;
name|agSMPFrame
operator|->
name|frameAddrLower32
operator|=
name|tdPTCmndBody
operator|->
name|tiSgl
operator|.
name|lower
expr_stmt|;
comment|/* This length excluding SMP header (4 bytes) and CRC field */
name|agSMPFrame
operator|->
name|frameLen
operator|=
name|SMPFrameLen
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|tiPassthroughCmnd
operator|->
name|passthroughCmnd
operator|==
name|tiRMCCmnd
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: RMC\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: unknown protocol %d\n"
operator|,
name|tiPassthroughCmnd
operator|->
name|passthroughCmnd
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: error !!! no SATA support\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndStart: error !!! unknown devietype %d\n"
operator|,
name|oneDeviceData
operator|->
name|DeviceType
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tiCOMPassthroughCmndAbort
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPassthroughRequest_t
modifier|*
name|taskTag
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|tdPassthroughCmndBody_t
modifier|*
name|tdPTCmndBody
init|=
name|agNULL
decl_stmt|;
name|tdssSMPRequestBody_t
modifier|*
name|tdssSMPRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|bit32
name|saStatus
decl_stmt|,
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|tdPTCmndBody
operator|=
operator|(
name|tdPassthroughCmndBody_t
operator|*
operator|)
name|taskTag
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|tdPTCmndBody
operator|->
name|tiPassthroughCmndType
operator|==
name|tiSMPCmnd
condition|)
block|{
name|tdssSMPRequestBody
operator|=
operator|&
operator|(
name|tdPTCmndBody
operator|->
name|protocol
operator|.
name|SMP
operator|.
name|SMPBody
operator|)
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|tdssSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|saStatus
operator|=
name|saSMPAbort
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndAbort: saSMPAbort failed\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
else|else
block|{
comment|/* AGSA_RC_BUSY */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndAbort: saSMPAbort busy\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
return|return
name|tiStatus
return|;
block|}
elseif|else
if|if
condition|(
name|tdPTCmndBody
operator|->
name|tiPassthroughCmndType
operator|==
name|tiRMCCmnd
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndAbort: RMC passthrough command type, not yet\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMPassthroughCmndAbort: unknown passthrough command type %d\n"
operator|,
name|tdPTCmndBody
operator|->
name|tiPassthroughCmndType
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tiINIPassthroughCmndRemoteAbort
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiPassthroughRequest_t
modifier|*
name|taskTag
parameter_list|,
name|tiPassthroughRequest_t
modifier|*
name|currentTaskTag
parameter_list|,
name|tiPortalContext_t
modifier|*
name|tiportalContext
parameter_list|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIPassthroughCmndRemoteAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     for SMP, nothing. Can't abot remotely   */
return|return
name|tiSuccess
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PASSTHROUGH */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief tiCOMShutDown * *  Purpose: This function is called to shutdown the initiator and/or target *           operation. Following the completion of this call, the state is *           equivalent to the state prior to tiCOMInit() * *  \param tiRoot:  Pointer to root data structure. * *  \return     None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tiCOMShutDown
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
comment|// #define  TI_GETFOR_ONSHUTDOWN
ifdef|#
directive|ifdef
name|TI_GETFOR_ONSHUTDOWN
name|agsaForensicData_t
name|forensicData
decl_stmt|;
name|bit32
name|once
init|=
literal|1
decl_stmt|;
name|bit32
name|status
decl_stmt|;
endif|#
directive|endif
comment|/* TI_GETFOR_ONSHUTDOWN */
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMShutDown: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
comment|/*     1. free up cardID     2. call saHwShutdown()     3. tdInitEsgl(tiRoot);     4. tdsaResetComMemFlags(tiRoot)     5. ostiPortEvent()   */
name|tdsaFreeCardID
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|CardID
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TI_GETFOR_ONSHUTDOWN
name|forensicData
operator|.
name|DataType
operator|=
name|TYPE_NON_FATAL
expr_stmt|;
name|forensicData
operator|.
name|dataBuf
operator|.
name|directLen
operator|=
operator|(
literal|8
operator|*
literal|1024
operator|)
expr_stmt|;
name|forensicData
operator|.
name|dataBuf
operator|.
name|directOffset
operator|=
literal|0
expr_stmt|;
comment|/* current offset */
name|forensicData
operator|.
name|dataBuf
operator|.
name|directData
operator|=
name|agNULL
expr_stmt|;
name|forensicData
operator|.
name|dataBuf
operator|.
name|readLen
operator|=
literal|0
expr_stmt|;
comment|/* Data read */
name|getmoreData
label|:
name|status
operator|=
name|saGetForensicData
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
name|forensicData
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMShutDown:readLen 0x%x directLen 0x%x directOffset 0x%x\n"
operator|,
name|forensicData
operator|.
name|dataBuf
operator|.
name|readLen
operator|,
name|forensicData
operator|.
name|dataBuf
operator|.
name|directLen
operator|,
name|forensicData
operator|.
name|dataBuf
operator|.
name|directOffset
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|forensicData
operator|.
name|dataBuf
operator|.
name|readLen
operator|==
name|forensicData
operator|.
name|dataBuf
operator|.
name|directLen
operator|&&
operator|!
name|status
operator|&&
name|once
condition|)
block|{
goto|goto
name|getmoreData
goto|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMShutDown:saGetForensicData type %d read 0x%x bytes\n"
operator|,
name|forensicData
operator|.
name|DataType
operator|,
name|forensicData
operator|.
name|dataBuf
operator|.
name|directOffset
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* TI_GETFOR_ONSHUTDOWN */
name|saHwShutdown
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
comment|/* resets all the relevant flags */
name|tdsaResetComMemFlags
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
comment|/*    * send an event to the oslayer    */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortShutdown
argument_list|,
name|tiSuccess
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_function
name|osGLOBAL
name|void
name|tiINITimerTick
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
comment|/*     no timer is used in SAS TD layer.     Therefore, this function is null.   */
comment|//  TI_DBG2(("tiINITimerTick: start\n"));
comment|/*itdsaProcessTimers(tiRoot);*/
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaDisableInterrupts  *    *  *  Purpose: This routine is called to disable interrupt  *  *    *  \param  agRoot:               Pointer to chip/driver Instance.  *  \param  outboundChannelNum:   Zero-base channel number  *  *   *  \return None.  *  *  \note - The scope is shared target and initiator.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|ossaDisableInterrupts
end_ifndef

begin_function
name|osGLOBAL
name|void
name|ossaDisableInterrupts
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|outboundChannelNum
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
decl_stmt|;
name|ostiInterruptDisable
argument_list|(
name|osData
operator|->
name|tiRoot
argument_list|,
name|outboundChannelNum
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|osGLOBAL
name|void
name|tiCOMFrameReadBlock
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|agFrame
parameter_list|,
name|bit32
name|FrameOffset
parameter_list|,
name|void
modifier|*
name|FrameBuffer
parameter_list|,
name|bit32
name|FrameBufLen
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMFrameReadBlock: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMFrameReadBlock: start\n"
operator|)
argument_list|)
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrame
argument_list|,
name|FrameOffset
argument_list|,
name|FrameBuffer
argument_list|,
name|FrameBufLen
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tiINITransportRecovery * * Purpose:  This routine is called to explicitly ask the Transport Dependent *           Layer to initiate the recovery for the transport/protocol specific *           error for a specific device connection. * *  \param   tiRoot:         Pointer to driver instance *  \param   tiDeviveHandle: Pointer to the device handle for this session. * *  \return: None * * *****************************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_function
name|osGLOBAL
name|void
name|tiINITransportRecovery
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tiPortalContext_t
modifier|*
name|tiPortalContext
init|=
name|agNULL
decl_stmt|;
name|tiIORequest_t
modifier|*
name|currentTaskTag
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITransportRecovery: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITransportRecovery: tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITransportRecovery: oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for hotplug */
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|registered
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITransportRecovery: NO Device did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITransportRecovery: device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITransportRecovery: device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITransportRecovery: onePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiPortalContext
operator|=
name|onePortContext
operator|->
name|tiPortalContext
expr_stmt|;
name|currentTaskTag
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|TransportRecoveryIO
operator|)
expr_stmt|;
name|currentTaskTag
operator|->
name|osData
operator|=
name|agNULL
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SAS_DEVICE
condition|)
block|{
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|currentTaskTag
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
name|agContext
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|agDeviceResetContext
operator|)
expr_stmt|;
name|agContext
operator|->
name|osData
operator|=
name|currentTaskTag
expr_stmt|;
name|oneDeviceData
operator|->
name|TRflag
operator|=
name|agTRUE
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITransportRecovery: SAS device\n"
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_IN_RECOVERY
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITransportRecovery: saLocalPhyControl\n"
operator|)
argument_list|)
expr_stmt|;
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeTransportRecovery
argument_list|,
name|tiRecStarted
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITransportRecovery: device reset expander attached\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|currentTaskTag
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeTransportRecovery
argument_list|,
name|tiRecStarted
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|currentTaskTag
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
name|agContext
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|agDeviceResetContext
operator|)
expr_stmt|;
name|agContext
operator|->
name|osData
operator|=
name|currentTaskTag
expr_stmt|;
name|oneDeviceData
operator|->
name|TRflag
operator|=
name|agTRUE
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITransportRecovery: SATA device\n"
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_IN_RECOVERY
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITransportRecovery: saLocalPhyControl\n"
operator|)
argument_list|)
expr_stmt|;
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_LINK_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeTransportRecovery
argument_list|,
name|tiRecStarted
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINITransportRecovery: device reset expander attached\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_LINK_RESET
argument_list|,
name|currentTaskTag
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeTransportRecovery
argument_list|,
name|tiRecStarted
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINITransportRecovery: wrong device type %d\n"
operator|,
name|oneDeviceData
operator|->
name|DeviceType
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|&&
name|defined
argument_list|(
name|TARGET_DRIVER
argument_list|)
end_if

begin_comment
comment|/***************************************************************************** *! \brief  tdsaPhyControlSend * *  Purpose:  This function sends Phy Control to a device. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   phyId: Phy Identifier. *  \param   queueNumber: bits 0-15:  inbound queue number. *                        bits 16-31: outbound queue number. * *  \return: *           Status * *   \note: * *****************************************************************************/
end_comment

begin_comment
comment|/* phyop of interest SMP_PHY_CONTROL_HARD_RESET or SMP_PHY_CONTROL_CLEAR_AFFILIATION if CurrentTaskTag == agNULL, clear affiliation if CurrentTaskTag != agNULL, PHY_CONTROL (device reset)  */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaPhyControlSend
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
comment|/* taget disk */
name|bit8
name|phyOp
parameter_list|,
name|tiIORequest_t
modifier|*
name|CurrentTaskTag
parameter_list|,
name|bit32
name|queueNumber
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief  tdsaPhyControlSend * *  Purpose:  This function sends Phy Control to a device. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   phyId: Phy Identifier. *  \param   queueNumber: bits 0-15:  inbound queue number. *                        bits 16-31: outbound queue number. * *  \return: *           Status * *   \note: * *****************************************************************************/
end_comment

begin_comment
comment|/* phyop of interest SMP_PHY_CONTROL_HARD_RESET or SMP_PHY_CONTROL_CLEAR_AFFILIATION if CurrentTaskTag == agNULL, clear affiliation if CurrentTaskTag != agNULL, PHY_CONTROL (device reset)  */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaPhyControlSend
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
comment|/* taget disk */
name|bit8
name|phyOp
parameter_list|,
name|tiIORequest_t
modifier|*
name|CurrentTaskTag
parameter_list|,
name|bit32
name|queueNumber
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief  tdsaPhyControlSend * *  Purpose:  This function sends Phy Control to a device. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   phyId: Phy Identifier. *  \param   queueNumber: bits 0-15:  inbound queue number. *                        bits 16-31: outbound queue number. * *  \return: *           Status * *   \note: * *****************************************************************************/
end_comment

begin_comment
comment|/* phyop of interest SMP_PHY_CONTROL_HARD_RESET or SMP_PHY_CONTROL_CLEAR_AFFILIATION if CurrentTaskTag == agNULL, clear affiliation if CurrentTaskTag != agNULL, PHY_CONTROL (device reset)  */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaPhyControlSend
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
comment|/* taget disk */
name|bit8
name|phyOp
parameter_list|,
name|tiIORequest_t
modifier|*
name|CurrentTaskTag
parameter_list|,
name|bit32
name|queueNumber
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneExpDeviceData
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|smpReqPhyControl_t
name|smpPhyControlReq
decl_stmt|;
name|bit8
name|phyID
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlSend: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
name|oneExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
name|phyID
operator|=
name|oneDeviceData
operator|->
name|phyID
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyControlSend: Error!!! deivce is directly attached\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyControlSend: Error!!! portcontext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|oneExpDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyControlSend: Error!!! expander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|phyOp
operator|==
name|SMP_PHY_CONTROL_HARD_RESET
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlSend: SMP_PHY_CONTROL_HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phyOp
operator|==
name|SMP_PHY_CONTROL_LINK_RESET
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlSend: SMP_PHY_CONTROL_LINK_RESET\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phyOp
operator|==
name|SMP_PHY_CONTROL_CLEAR_AFFILIATION
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlSend: SMP_PHY_CONTROL_CLEAR_AFFILIATION\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlSend: target device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlSend: target device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlSend: expander AddrHi 0x%08x\n"
operator|,
name|oneExpDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlSend: expander AddrLo 0x%08x\n"
operator|,
name|oneExpDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlSend: did %d expander did %d phyid %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneExpDeviceData
operator|->
name|id
operator|,
name|phyID
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|smpPhyControlReq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqPhyControl_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* fill in SMP payload */
name|smpPhyControlReq
operator|.
name|phyIdentifier
operator|=
name|phyID
expr_stmt|;
name|smpPhyControlReq
operator|.
name|phyOperation
operator|=
name|phyOp
expr_stmt|;
name|status
operator|=
name|tdSMPStart
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneExpDeviceData
argument_list|,
name|SMP_PHY_CONTROL
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|smpPhyControlReq
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqPhyControl_t
argument_list|)
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|CurrentTaskTag
argument_list|,
name|queueNumber
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *! \brief  tdsaPhyControlFailureRespRcvd * *  Purpose:  This function processes the failure of Phy Control response. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   agRoot: Pointer to chip/driver Instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   frameHeader: Pointer to SMP frame header. *  \param   frameHandle: A Handle used to refer to the response frame * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaPhyControlFailureRespRcvd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdssSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|,
name|tiIORequest_t
modifier|*
name|CurrentTaskTag
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|||
name|defined
argument_list|(
name|TD_DEBUG_ENABLE
argument_list|)
name|tdsaDeviceData_t
modifier|*
name|TargetDeviceData
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satDeviceData_t
modifier|*
name|pSatDevData
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
comment|//  agsaDevHandle_t       *agDevHandle = agNULL;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyControlFailureRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlFailureRespRcvd: expander device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlFailureRespRcvd: expander device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CurrentTaskTag
operator|!=
name|agNULL
condition|)
block|{
comment|/* This was set in tiINITaskmanagement() */
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|||
name|defined
argument_list|(
name|TD_DEBUG_ENABLE
argument_list|)
name|TargetDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|CurrentTaskTag
operator|->
name|tdData
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|pSatDevData
operator|=
operator|(
name|satDeviceData_t
operator|*
operator|)
operator|&
operator|(
name|TargetDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
endif|#
directive|endif
comment|//    agDevHandle = TargetDeviceData->agDevHandle;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPhyControlFailureRespRcvd: target AddrHi 0x%08x\n"
operator|,
name|TargetDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPhyControlFailureRespRcvd: target AddrLo 0x%08x\n"
operator|,
name|TargetDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPhyControlFailureRespRcvd: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPhyControlFailureRespRcvd: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
if|if
condition|(
name|CurrentTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: callback to OS layer with failure\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TargetDeviceData
operator|->
name|TRflag
operator|==
name|agTRUE
condition|)
block|{
name|TargetDeviceData
operator|->
name|TRflag
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|TargetDeviceData
operator|->
name|tdPortContext
operator|->
name|tiPortalContext
argument_list|,
operator|&
operator|(
name|TargetDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|tiIntrEventTypeTransportRecovery
argument_list|,
name|tiRecFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaPhyControlRespRcvd * *  Purpose:  This function processes Phy Control response. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   agRoot: Pointer to chip/driver Instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   frameHeader: Pointer to SMP frame header. *  \param   frameHandle: A Handle used to refer to the response frame * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaPhyControlRespRcvd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdssSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|,
name|tiIORequest_t
modifier|*
name|CurrentTaskTag
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|||
name|defined
argument_list|(
name|TD_DEBUG_ENABLE
argument_list|)
name|tdsaDeviceData_t
modifier|*
name|TargetDeviceData
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|satDeviceData_t
modifier|*
name|pSatDevData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: expander device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: expander device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CurrentTaskTag
operator|!=
name|agNULL
condition|)
block|{
comment|/* This was set in tiINITaskmanagement() */
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|||
name|defined
argument_list|(
name|TD_DEBUG_ENABLE
argument_list|)
name|TargetDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|CurrentTaskTag
operator|->
name|tdData
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|pSatDevData
operator|=
operator|(
name|satDeviceData_t
operator|*
operator|)
operator|&
operator|(
name|TargetDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
name|agDevHandle
operator|=
name|TargetDeviceData
operator|->
name|agDevHandle
expr_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: target AddrHi 0x%08x\n"
operator|,
name|TargetDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: target AddrLo 0x%08x\n"
operator|,
name|TargetDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* no payload */
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: SMP success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* warm reset or clear affiliation is done         call ostiInitiatorEvent()     */
if|if
condition|(
name|CurrentTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: callback to OS layer with success\n"
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|TargetDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|TargetDeviceData
operator|->
name|TRflag
operator|==
name|agTRUE
condition|)
block|{
name|TargetDeviceData
operator|->
name|TRflag
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|TargetDeviceData
operator|->
name|tdPortContext
operator|->
name|tiPortalContext
argument_list|,
operator|&
operator|(
name|TargetDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|tiIntrEventTypeTransportRecovery
argument_list|,
name|tiRecOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agDevHandle
operator|=
name|TargetDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: wrong, agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMOK
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: SMP failure; result %d\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
comment|/* warm reset or clear affiliation is done     */
if|if
condition|(
name|CurrentTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyControlRespRcvd: callback to OS layer with failure\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TargetDeviceData
operator|->
name|TRflag
operator|==
name|agTRUE
condition|)
block|{
name|TargetDeviceData
operator|->
name|TRflag
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|TargetDeviceData
operator|->
name|tdPortContext
operator|->
name|tiPortalContext
argument_list|,
operator|&
operator|(
name|TargetDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|tiIntrEventTypeTransportRecovery
argument_list|,
name|tiRecFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief ttdsaAbortAll * *  Purpose:  This function is called to abort an all pending I/O request on a *            device * *  \param  tiRoot:          Pointer to initiator driver/port instance. *  \param  agRoot:          Pointer to chip/driver Instance. *  \param  oneDeviceData:   Pointer to the device * *  \return:  * *          None * *****************************************************************************/
end_comment

begin_comment
comment|/*   for abort itself,   should we allocate tdAbortIORequestBody or get one from ttdsaXchg_t?   Currently, we allocate tdAbortIORequestBody. */
end_comment

begin_function
name|osGLOBAL
name|void
name|ttdsaAbortAll
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaAbortAll: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaAbortAll: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaAbortAll: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaAbortAll: ostiAllocMemory returned NULL tdAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
comment|/* setting callback */
comment|/* not needed; it is already set to be ossaSSPAbortCB() */
name|tdAbortIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|ttdssIOAbortedHandler
expr_stmt|;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
operator|(
name|tiDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/* SSPAbort */
name|saSSPAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|1
argument_list|,
comment|/* abort all */
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TARGET_DRIVER */
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDeregisterDevicesInPort
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeregisterDevicesInPort: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeregisterDevicesInPort: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDeregisterDevicesInPort: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|&&
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeregisterDevicesInPort: keeping\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDeregisterDevicesInPort: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************** for debugging only ***************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaPrintSwConfig
parameter_list|(
name|agsaSwConfig_t
modifier|*
name|SwConfig
parameter_list|)
block|{
if|if
condition|(
name|SwConfig
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaPrintSwConfig: SwConfig is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"SwConfig->maxActiveIOs %d\n"
operator|,
name|SwConfig
operator|->
name|maxActiveIOs
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"SwConfig->smpReqTimeout %d\n"
operator|,
name|SwConfig
operator|->
name|smpReqTimeout
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tdsaPrintHwConfig
parameter_list|(
name|agsaHwConfig_t
modifier|*
name|HwConfig
parameter_list|)
block|{
if|if
condition|(
name|HwConfig
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaPrintHwConfig: HwConfig is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"HwConfig->phyCount %d\n"
operator|,
name|HwConfig
operator|->
name|phyCount
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tdssPrintSASIdentify
parameter_list|(
name|agsaSASIdentify_t
modifier|*
name|id
parameter_list|)
block|{
if|if
condition|(
name|id
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPrintSASIdentify: ID is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"SASID->sspTargetPort %d\n"
operator|,
name|SA_IDFRM_IS_SSP_TARGET
argument_list|(
name|id
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"SASID->stpTargetPort %d\n"
operator|,
name|SA_IDFRM_IS_STP_TARGET
argument_list|(
name|id
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"SASID->smpTargetPort %d\n"
operator|,
name|SA_IDFRM_IS_SMP_TARGET
argument_list|(
name|id
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"SASID->sspInitiatorPort %d\n"
operator|,
name|SA_IDFRM_IS_SSP_INITIATOR
argument_list|(
name|id
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"SASID->stpInitiatorPort %d\n"
operator|,
name|SA_IDFRM_IS_STP_INITIATOR
argument_list|(
name|id
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"SASID->smpInitiatorPort %d\n"
operator|,
name|SA_IDFRM_IS_SMP_INITIATOR
argument_list|(
name|id
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"SASID->deviceType %d\n"
operator|,
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
name|id
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"SASID->sasAddressHi 0x%x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
name|id
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"SASID->sasAddressLo 0x%x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
name|id
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"SASID->phyIdentifier 0x%x\n"
operator|,
name|id
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tdsaInitTimerHandler
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|timerData
parameter_list|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaInitTimerHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*   type: 1 portcontext 2 devicedata   flag: 1 FreeLink 2 MainLink */
end_comment

begin_function
name|osGLOBAL
name|void
name|print_tdlist_flink
parameter_list|(
name|tdList_t
modifier|*
name|hdr
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|tdList_t
modifier|*
name|hdr_tmp1
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdsaPortContext_t
modifier|*
name|ele1
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REMOVED
name|tdsaDeviceData_t
modifier|*
name|ele2
decl_stmt|;
endif|#
directive|endif
name|hdr_tmp1
operator|=
name|hdr
expr_stmt|;
if|if
condition|(
name|type
operator|==
literal|1
operator|&&
name|flag
operator|==
literal|1
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"PortContext and FreeLink\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|!=
literal|1
operator|&&
name|flag
operator|==
literal|1
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"DeviceData and FreeLink\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
literal|1
operator|&&
name|flag
operator|!=
literal|1
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"PortContext and MainLink\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"DeviceData and MainLink\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|==
literal|1
condition|)
block|{
do|do
block|{
comment|/* data structure type variable = (data structure type, file name, header of the tdList) */
if|if
condition|(
name|flag
operator|==
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|ele1
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|FreeLink
argument_list|,
name|hdr_tmp1
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|ele1
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|hdr_tmp1
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"flist ele %d\n"
operator|,
name|ele1
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"flist ele %p\n"
operator|,
name|ele1
operator|)
argument_list|)
expr_stmt|;
name|hdr_tmp1
operator|=
name|hdr_tmp1
operator|->
name|flink
expr_stmt|;
block|}
do|while
condition|(
name|hdr_tmp1
operator|!=
name|hdr
condition|)
do|;
block|}
else|else
block|{
do|do
block|{
comment|/* data structure type variable = (data structure type, file name, header of the tdList) */
ifdef|#
directive|ifdef
name|REMOVED
if|if
condition|(
name|flag
operator|==
literal|1
condition|)
block|{
name|ele2
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|FreeLink
argument_list|,
name|hdr_tmp1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ele2
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|hdr_tmp1
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"flist ele %d\n"
operator|,
name|ele2
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"flist ele %p\n"
operator|,
name|ele2
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|hdr_tmp1
operator|=
name|hdr_tmp1
operator|->
name|flink
expr_stmt|;
block|}
do|while
condition|(
name|hdr_tmp1
operator|!=
name|hdr
condition|)
do|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* not verified yet. 6/15/2005 */
end_comment

begin_function
name|osGLOBAL
name|void
name|print_tdlist_blink
parameter_list|(
name|tdList_t
modifier|*
name|hdr
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|tdList_t
modifier|*
name|hdr_tmp1
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|tdsaPortContext_t
modifier|*
name|ele1
decl_stmt|;
endif|#
directive|endif
name|hdr_tmp1
operator|=
name|hdr
expr_stmt|;
do|do
block|{
comment|/* data structure type variable = (data structure type, file name, header of the tdList) */
ifdef|#
directive|ifdef
name|REMOVED
if|if
condition|(
name|flag
operator|==
literal|1
condition|)
block|{
name|ele1
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|FreeLink
argument_list|,
name|hdr_tmp1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ele1
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|hdr_tmp1
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"blist ele %d\n"
operator|,
name|ele1
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|hdr_tmp1
operator|=
name|hdr_tmp1
operator|->
name|blink
expr_stmt|;
block|}
do|while
condition|(
name|hdr_tmp1
operator|!=
name|hdr
condition|)
do|;
block|}
end_function

begin_comment
comment|/** hexidecimal dump */
end_comment

begin_function
name|void
name|tdhexdump
parameter_list|(
specifier|const
name|char
modifier|*
name|ptitle
parameter_list|,
name|bit8
modifier|*
name|pbuf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"%s - hexdump(len=%d):\n"
operator|,
name|ptitle
operator|,
operator|(
name|int
operator|)
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pbuf
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"pbuf is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
control|)
block|{
if|if
condition|(
name|len
operator|-
name|i
operator|>
literal|4
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|" 0x%02x, 0x%02x, 0x%02x, 0x%02x,\n"
operator|,
name|pbuf
index|[
name|i
index|]
operator|,
name|pbuf
index|[
name|i
operator|+
literal|1
index|]
operator|,
name|pbuf
index|[
name|i
operator|+
literal|2
index|]
operator|,
name|pbuf
index|[
name|i
operator|+
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|i
operator|+=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|" 0x%02x,"
operator|,
name|pbuf
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tdsaSingleThreadedEnter
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|bit32
name|queueId
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tiroot
init|=
name|agNULL
decl_stmt|;
name|bit32
name|offset
init|=
literal|0
decl_stmt|;
name|TD_ASSERT
argument_list|(
name|ptiRoot
argument_list|,
literal|"ptiRoot"
argument_list|)
expr_stmt|;
name|tiroot
operator|=
name|ptiRoot
operator|->
name|tdData
expr_stmt|;
name|offset
operator|=
name|tiroot
operator|->
name|tdsaAllShared
operator|.
name|MaxNumLLLocks
operator|+
name|tiroot
operator|->
name|tdsaAllShared
operator|.
name|MaxNumOSLocks
expr_stmt|;
name|ostiSingleThreadedEnter
argument_list|(
name|ptiRoot
argument_list|,
name|queueId
operator|+
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tdsaSingleThreadedLeave
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|bit32
name|queueId
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tiroot
init|=
name|agNULL
decl_stmt|;
name|bit32
name|offset
init|=
literal|0
decl_stmt|;
name|TD_ASSERT
argument_list|(
name|ptiRoot
argument_list|,
literal|"ptiRoot"
argument_list|)
expr_stmt|;
name|tiroot
operator|=
name|ptiRoot
operator|->
name|tdData
expr_stmt|;
name|offset
operator|=
name|tiroot
operator|->
name|tdsaAllShared
operator|.
name|MaxNumLLLocks
operator|+
name|tiroot
operator|->
name|tdsaAllShared
operator|.
name|MaxNumOSLocks
expr_stmt|;
name|ostiSingleThreadedLeave
argument_list|(
name|ptiRoot
argument_list|,
name|queueId
operator|+
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PERF_COUNT
end_ifdef

begin_function
name|void
name|tdsaEnter
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|int
name|io
parameter_list|)
block|{
name|ostiEnter
argument_list|(
name|ptiRoot
argument_list|,
literal|1
argument_list|,
name|io
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tdsaLeave
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|int
name|io
parameter_list|)
block|{
name|ostiLeave
argument_list|(
name|ptiRoot
argument_list|,
literal|1
argument_list|,
name|io
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


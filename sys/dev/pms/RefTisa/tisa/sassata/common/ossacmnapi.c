begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  *  *  * This file contains CB functions used by lower layer in SAS/SATA TD layer  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|ECHO_TESTING
end_ifdef

begin_comment
comment|/* temporary to test saEchoCommand() */
end_comment

begin_decl_stmt
specifier|extern
name|bit8
name|gEcho
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
end_if

begin_decl_stmt
specifier|extern
name|bit32
name|gLLDebugLevel
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/mpidebug.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|siTraceFileID
end_ifdef

begin_undef
undef|#
directive|undef
name|siTraceFileID
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|siTraceFileID
value|'R'
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   functions that are common to SAS and SATA */
end_comment

begin_function
name|FORCEINLINE
name|void
name|ossaCacheInvalidate
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|void
modifier|*
name|osMemHandle
parameter_list|,
name|void
modifier|*
name|virtPtr
parameter_list|,
name|bit32
name|length
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaCacheInvalidate: start\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiCacheInvalidate
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
name|virtPtr
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|FORCEINLINE
name|void
name|ossaCacheFlush
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|void
modifier|*
name|osMemHandle
parameter_list|,
name|void
modifier|*
name|virtPtr
parameter_list|,
name|bit32
name|length
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaCacheFlush: start\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiCacheFlush
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
name|virtPtr
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|FORCEINLINE
name|void
name|ossaCachePreFlush
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|void
modifier|*
name|osMemHandle
parameter_list|,
name|void
modifier|*
name|virtPtr
parameter_list|,
name|bit32
name|length
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaCachePreFlush: start\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiCachePreFlush
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
name|virtPtr
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief ossaDeviceHandleAccept * *  Purpose:  This function is called by lower layer to inform TD layer of *            a new SAS device arrival. Used only at the target * * *  \param   agRoot         Pointer to chip/driver Instance. *  \param   agDevHandle    Pointer to the device handle of the device *  \param   agDevInfo      Pointer to the device info structure *  \param   agPortContext  Pointer to a port context * *  \return: *          OSSA_RC_REJECT  A device is accpeted *          OSSA_RC_ACCEPT  A device is rejected * *  \note -  For details, refer to SAS/SATA Low-Level API Specification * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|ossaDeviceHandleAccept
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|agsaSASDeviceInfo_t
modifier|*
name|agDevInfo
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|bit32
modifier|*
name|hostAssignedDeviceId
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tiPortalContext_t
modifier|*
name|tiPortalContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaSASSubID_t
name|agSASSubID
decl_stmt|;
name|bit32
name|option
decl_stmt|;
name|bit32
name|param
decl_stmt|;
comment|/*     at target only     by default TD layer accpets all devices   */
comment|/*     at this point,     by LINK_UP event tdsaPortContext should have been created   */
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Y0"
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: start hostAssignedDeviceId 0x%X\n"
operator|,
operator|*
name|hostAssignedDeviceId
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: NULL agsaPortContext; wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Y0"
argument_list|)
expr_stmt|;
return|return
name|OSSA_RC_REJECT
return|;
block|}
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: NULL oneportcontext; wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"Y0"
argument_list|)
expr_stmt|;
return|return
name|OSSA_RC_REJECT
return|;
block|}
name|tiPortalContext
operator|=
operator|(
name|tiPortalContext_t
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
expr_stmt|;
if|if
condition|(
name|tiPortalContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: NULL tiPortalContext; wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"Y0"
argument_list|)
expr_stmt|;
return|return
name|OSSA_RC_REJECT
return|;
block|}
comment|/*     add the device to device list     cf) OSSA_DISCOVER_FOUND_DEVICE   */
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: sasAddressHi 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|agDevInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: sasAddressLo 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|agDevInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: device type  0x%x\n"
operator|,
name|DEVINFO_GET_DEVICETTYPE
argument_list|(
operator|&
name|agDevInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: phys %d\n"
operator|,
name|agDevInfo
operator|->
name|numOfPhys
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DEVINFO_GET_DEVICETTYPE
argument_list|(
operator|&
name|agDevInfo
operator|->
name|commonDevInfo
argument_list|)
operator|==
name|SAS_END_DEVICE
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: SAS_END_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DEVINFO_GET_DEVICETTYPE
argument_list|(
operator|&
name|agDevInfo
operator|->
name|commonDevInfo
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: SAS_EDGE_EXPANDER_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* SAS_FANOUT_EXPANDER_DEVICE */
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: SAS_FANOUT_EXPANDER_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|agSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|agDevInfo
operator|->
name|commonDevInfo
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|agDevInfo
operator|->
name|commonDevInfo
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|agDevInfo
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|agDevInfo
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|tdssAddSASToSharedcontext
argument_list|(
name|onePortContext
argument_list|,
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
operator|&
name|agSASSubID
argument_list|,
name|agTRUE
argument_list|,
literal|0xFF
argument_list|,
name|TD_OPERATION_TARGET
argument_list|)
expr_stmt|;
comment|/* at this point devicedata for new device exists */
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: NULL oneDeviceData; wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|OSSA_RC_REJECT
return|;
block|}
name|oneDeviceData
operator|->
name|registered
operator|=
name|agTRUE
expr_stmt|;
name|tiDeviceHandle
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: NULL tiDeviceHandle; wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"Y0"
argument_list|)
expr_stmt|;
return|return
name|OSSA_RC_REJECT
return|;
block|}
comment|/* setting MCN in agsaDeviceInfo_t*/
name|agDevInfo
operator|->
name|commonDevInfo
operator|.
name|flag
operator|=
name|agDevInfo
operator|->
name|commonDevInfo
operator|.
name|flag
operator||
operator|(
name|tdsaAllShared
operator|->
name|MCN
operator|<<
literal|16
operator|)
expr_stmt|;
comment|/* increment RegisteredDevNums */
name|onePortContext
operator|->
name|RegisteredDevNums
operator|++
expr_stmt|;
operator|*
name|hostAssignedDeviceId
operator||=
literal|0xBEEF0000
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: Now hostAssignedDeviceId 0x%X\n"
operator|,
operator|*
name|hostAssignedDeviceId
operator|)
argument_list|)
expr_stmt|;
comment|/* no login in SAS */
comment|/*     osGLOBAL bit32 ostiTargetEvent (                         tiRoot_t          *tiRoot,                         tiPortalContext_t *portalContext,                         tiDeviceHandle_t  *tiDeviceHandle,                         tiTgtEventType_t  eventType,                         bit32             eventStatus,                         void              *parm                         );   */
name|ostiTargetEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiTgtEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
comment|/* set MCN and initiator role bit using saSetDeviceInfo */
name|option
operator|=
literal|24
expr_stmt|;
comment|/* setting MCN and initiator role 1 1000b*/
name|param
operator|=
operator|(
literal|1
operator|<<
literal|18
operator|)
operator||
operator|(
name|tdsaAllShared
operator|->
name|MCN
operator|<<
literal|24
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceHandleAccept: option 0x%x param 0x%x MCN 0x%x\n"
operator|,
name|option
operator|,
name|param
operator|,
name|tdsaAllShared
operator|->
name|MCN
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceInfo
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|option
argument_list|,
name|param
argument_list|,
name|ossaSetDeviceInfoCB
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"Y0"
argument_list|)
expr_stmt|;
return|return
name|OSSA_RC_ACCEPT
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* this function is not used in case of Initiator */
return|return
name|OSSA_RC_ACCEPT
return|;
endif|#
directive|endif
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief ossaDiscoverSasCB * *  Purpose:  This function is called by lower layer to inform TD layer of *            SAS discovery results * * *  \param   agRoot         Pointer to chip/driver Instance. *  \param   agPortContext  Pointer to the port context of TD and Lower layer *  \param   event          event type *  \param   pParm1         Pointer to data associated with event *  \param   pParm2         Pointer to data associated with event * *  \return: none * *  \note -  For details, refer to SAS/SATA Low-Level API Specification * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaDiscoverSasCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|bit32
name|event
parameter_list|,
name|void
modifier|*
name|pParm1
parameter_list|,
name|void
modifier|*
name|pParm2
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
name|osData
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|agsaSASDeviceInfo_t
modifier|*
name|agDeviceInfo
init|=
name|agNULL
decl_stmt|;
name|tiPortalContext_t
modifier|*
name|tiPortalContext
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaSASSubID_t
name|agSASSubID
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Y1"
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: NULL agsaPortContext; wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
name|tiPortalContext
operator|=
operator|(
name|tiPortalContext_t
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
expr_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|OSSA_DISCOVER_STARTED
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: STARTED pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/*       invalidate all devices in current device list     */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: loop sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: loop sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: did %d is invalidated \n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* temporary solution: only for sata direct attached */
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_STARTED
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_FOUND_DEVICE
case|:
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: $$$$$ FOUND_DEVICE pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
operator|(
name|agsaDevHandle_t
operator|*
operator|)
name|pParm1
expr_stmt|;
name|agDeviceInfo
operator|=
operator|(
name|agsaSASDeviceInfo_t
operator|*
operator|)
name|pParm2
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: sasAddressHi 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|agDeviceInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: sasAddressLo 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|agDeviceInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: device type  0x%x\n"
operator|,
name|DEVINFO_GET_DEVICETTYPE
argument_list|(
operator|&
name|agDeviceInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: phys %d\n"
operator|,
name|agDeviceInfo
operator|->
name|numOfPhys
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* Add only target devices; do not add expander device */
if|if
condition|(
name|DEVINFO_GET_DEVICETTYPE
argument_list|(
operator|&
name|agDeviceInfo
operator|->
name|commonDevInfo
argument_list|)
operator|==
name|SAS_END_DEVICE
condition|)
block|{
name|agSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|agDeviceInfo
operator|->
name|commonDevInfo
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|agDeviceInfo
operator|->
name|commonDevInfo
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|agDeviceInfo
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|agDeviceInfo
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: adding ....\n"
operator|)
argument_list|)
expr_stmt|;
name|tdssAddSASToSharedcontext
argument_list|(
name|onePortContext
argument_list|,
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
operator|&
name|agSASSubID
argument_list|,
name|agTRUE
argument_list|,
name|agDeviceInfo
operator|->
name|phyIdentifier
argument_list|,
name|TD_OPERATION_INITIATOR
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: $$$$$ not end device. not adding....\n"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|OSSA_DISCOVER_REMOVED_DEVICE
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: REMOVED_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
operator|(
name|agsaDevHandle_t
operator|*
operator|)
name|pParm1
expr_stmt|;
name|agDeviceInfo
operator|=
operator|(
name|agsaSASDeviceInfo_t
operator|*
operator|)
name|pParm2
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: sasAddressHi 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|agDeviceInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: sasAddressLo 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|agDeviceInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: phys %d\n"
operator|,
name|agDeviceInfo
operator|->
name|numOfPhys
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: onePortContext->id %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: Wrong. DevHandle->osData is NULL but is being removed\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdssRemoveSASFromSharedcontext
argument_list|(
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|agRoot
argument_list|)
expr_stmt|;
name|agDevHandle
operator|->
name|osData
operator|=
name|agNULL
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceRemoval
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|OSSA_DISCOVER_COMPLETE
case|:
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: SAS COMPLETE pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/*       note:       SAS discovery must be called before SATA discovery       "onePortContext->DiscoveryState = ITD_DSTATE_COMPLETED" is       in ossaDiscoverSataCB not in ossaDiscoverSasCB when SATA_ENABLE     */
ifndef|#
directive|ifndef
name|SATA_ENABLE
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_COMPLETED
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: COMPLETE pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SATA_ENABLE
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: calling SATA discovery\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Continue with SATA discovery */
name|saDiscover
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|AG_SA_DISCOVERY_TYPE_SATA
argument_list|,
name|onePortContext
operator|->
name|discoveryOptions
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* SATA not enable */
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* for debugging */
comment|/* dump device list */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: did %d valid %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* letting OS layer know discovery has been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SATA_ENABLE */
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ABORT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT_ERROR_1
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ERROR 1\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT_ERROR_2
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ERROR 2\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT_ERROR_3
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ERROR 3\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT_ERROR_4
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ERROR 4\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT_ERROR_5
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ERROR 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT_ERROR_6
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ERROR 6\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT_ERROR_7
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ERROR 7\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT_ERROR_8
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ERROR 8\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT_ERROR_9
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ERROR 9\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDiscoverSasCB: ERROR default event 0x%x\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
comment|/* letting OS layer know discovery has not been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* end of switch */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Y1"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// #ifdef INITIATOR_DRIVER
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaLogTrace0
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|traceCode
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ossaLogTrace1
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|traceCode
parameter_list|,
name|bit32
name|value1
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ossaLogTrace2
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|traceCode
parameter_list|,
name|bit32
name|value1
parameter_list|,
name|bit32
name|value2
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ossaLogTrace3
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|traceCode
parameter_list|,
name|bit32
name|value1
parameter_list|,
name|bit32
name|value2
parameter_list|,
name|bit32
name|value3
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ossaLogTrace4
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|traceCode
parameter_list|,
name|bit32
name|value1
parameter_list|,
name|bit32
name|value2
parameter_list|,
name|bit32
name|value3
parameter_list|,
name|bit32
name|value4
parameter_list|)
block|{
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief ossaHwCB * *  Purpose:  This function is called by lower layer to inform TD layer of *            HW related results * *  \param   agRoot         Pointer to chip/driver Instance. *  \param   agPortContext  Pointer to the port context of TD and Lower layer *  \param   event          event type *  \param   eventParm1     event-specific parameter *  \param   eventParm2     event-specific parameter *  \param   eventParm3     event-specific parameter of pointer type * *  \return: none * *  \note -  For details, refer to SAS/SATA Low-Level API Specification * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaHwCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|bit32
name|event
parameter_list|,
name|bit32
name|eventParm1
parameter_list|,
name|void
modifier|*
name|eventParm2
parameter_list|,
name|void
modifier|*
name|eventParm3
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
name|osData
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
init|=
name|agNULL
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|agsaSASIdentify_t
modifier|*
name|IDframe
init|=
name|agNULL
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdsaSASSubID_t
name|agSASSubID
decl_stmt|;
endif|#
directive|endif
name|bit32
name|PhyID
decl_stmt|;
name|bit32
name|PhyStatus
decl_stmt|;
name|bit32
name|LinkRate
decl_stmt|;
name|bit32
name|PortState
decl_stmt|;
name|bit32
name|HwAckSatus
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
comment|// #ifdef INITIATOR_DRIVER
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|agsaFisRegDeviceToHost_t
modifier|*
name|RegD2H
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REMOVED
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
endif|#
directive|endif
name|agsaHWEventEncrypt_t
modifier|*
name|pEncryptCBData
decl_stmt|;
name|agsaEncryptInfo_t
modifier|*
name|pEncryptInfo
decl_stmt|;
name|agsaHWEventMode_t
modifier|*
name|pModeEvent
decl_stmt|;
name|tiEncryptPort_t
name|encryptEventData
decl_stmt|;
name|tiEncryptInfo_t
name|encryptInfo
decl_stmt|;
name|bit32
modifier|*
name|pModePage
decl_stmt|;
name|bit32
name|securityMode
decl_stmt|;
name|bit32
name|cipherMode
decl_stmt|;
name|bit32
name|encryptStatus
decl_stmt|;
name|bit32
name|securitySetModeStatus
decl_stmt|;
name|bit32
name|securityModeStatus
decl_stmt|;
comment|// #endif /* INITIATOR_DRIVER */
name|agsaPhyErrCountersPage_t
modifier|*
name|agPhyErrCountersPage
decl_stmt|;
name|agsaEventSource_t
name|eventSource
decl_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|dmRoot_t
modifier|*
name|dmRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
decl_stmt|;
name|dmPortContext_t
modifier|*
name|dmPortContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|DM_RC_FAILURE
decl_stmt|;
name|dmPortInfo_t
name|dmPortInfo
decl_stmt|;
comment|//  bit32                    discStatus = dmDiscInProgress;
endif|#
directive|endif
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext %p event 0x%x eventParm1 0x%x eventParm2 %p eventParm3 %p\n"
operator|,
name|agPortContext
operator|,
name|event
operator|,
name|eventParm1
operator|,
name|eventParm2
operator|,
name|eventParm3
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|OSSA_HW_EVENT_SAS_PHY_UP
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|LinkRate
operator|=
name|TD_GET_LINK_RATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
name|agNULL
expr_stmt|;
name|IDframe
operator|=
operator|(
name|agsaSASIdentify_t
operator|*
operator|)
name|eventParm3
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: Phy%d SAS link Up\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext null, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaHwCB: agDevHandle null by design change\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IDframe
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: IDframe null, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* debugging only */
if|if
condition|(
name|LinkRate
operator|==
literal|0x01
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: SAS Link Rate is 1.5 Gbps PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LinkRate
operator|==
literal|0x02
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: SAS Link Rate is 3.0 Gbps PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LinkRate
operator|==
literal|0x04
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: SAS Link Rate is 6.0 Gbps PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LinkRate
operator|==
literal|0x08
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: SAS Link Rate is 12.0 Gbps PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with SAS link up\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
comment|/* if */
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: PhyID %d tdsaAllShared %p\n"
operator|,
name|PhyID
operator|,
name|tdsaAllShared
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: NULL portalcontext\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: NOT NULL portalcontext\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IDframe
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: IDFrame is NULL; SATA !!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaHwCB: IDframe->sasAddressHi 0x%08x \n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
name|IDframe
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaHwCB: IDframe->sasAddressLo 0x%08x \n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
name|IDframe
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*         setting tdsaPortContext fields         take the head from the FreeLink of tdsaPortContext_t         then modify it         then put it in MainLink of tdsaPortContext_t       */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
condition|)
block|{
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|PortContextList
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|FreeLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: onePortContext %p\n"
operator|,
name|onePortContext
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: onePortContext is NULL in allocation, wrong!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* sets fields of tdsaportcontext */
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_NOT_STARTED
expr_stmt|;
name|onePortContext
operator|->
name|discoveryOptions
operator|=
name|AG_SA_DISCOVERY_OPTION_FULL_START
expr_stmt|;
endif|#
directive|endif
name|onePortContext
operator|->
name|PhyIDList
index|[
name|PhyID
index|]
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|IDframe
operator|==
name|agNULL
condition|)
block|{
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|onePortContext
operator|->
name|sasRemoteAddressLo
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|onePortContext
operator|->
name|directAttatchedSAS
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
name|IDframe
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|sasRemoteAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
name|IDframe
argument_list|)
expr_stmt|;
comment|/* Create ID frame and storing ID frame */
name|osti_memcpy
argument_list|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
argument_list|,
name|IDframe
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASIdentify_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"ossaHWCB: sasIDframe"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASIdentify_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
name|IDframe
argument_list|)
operator|==
name|SAS_END_DEVICE
condition|)
block|{
name|onePortContext
operator|->
name|directAttatchedSAS
operator|=
name|agTRUE
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FDS_DM
if|if
condition|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
name|IDframe
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|||
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
name|IDframe
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
name|onePortContext
operator|->
name|UseDM
operator|=
name|agTRUE
expr_stmt|;
block|}
endif|#
directive|endif
block|}
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|SASID
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|SASID
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|tiPortalContext
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
expr_stmt|;
name|onePortContext
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|onePortContext
operator|->
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|=
name|onePortContext
expr_stmt|;
name|agPortContext
operator|->
name|osData
operator|=
name|onePortContext
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|LinkRate
operator|==
literal|0x01
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_1_5G
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|LinkRate
operator|==
literal|0x02
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_3_0G
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|LinkRate
operator|==
literal|0x04
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_6_0G
expr_stmt|;
block|}
else|else
comment|/* (LinkRate == 0x08) */
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_12_0G
expr_stmt|;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|dmPortContext
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|dmPortContext
operator|)
expr_stmt|;
name|dmPortContext
operator|->
name|tdData
operator|=
name|onePortContext
expr_stmt|;
comment|/* set up dmPortInfo_t */
name|PORTINFO_PUT_SAS_REMOTE_ADDRESSLO
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasRemoteAddressLo
argument_list|)
expr_stmt|;
name|PORTINFO_PUT_SAS_REMOTE_ADDRESSHI
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasRemoteAddressHi
argument_list|)
expr_stmt|;
name|PORTINFO_PUT_SAS_LOCAL_ADDRESSLO
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressLo
argument_list|)
expr_stmt|;
name|PORTINFO_PUT_SAS_LOCAL_ADDRESSHI
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressHi
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: phy %d hi 0x%x lo 0x%x\n"
operator|,
name|PhyID
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|SASID
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: LocalAddrHi 0x%08x LocaAddrLo 0x%08x\n"
operator|,
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|,
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|)
argument_list|)
expr_stmt|;
name|dmPortInfo
operator|.
name|flag
operator|=
name|onePortContext
operator|->
name|LinkRate
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|UseDM
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: calling dmCreatePort\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|dmCreatePort
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
operator|&
name|dmPortInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|DM_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: dmCreatePort failed!!! 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"\nossaHwCB: Attention!!! no more free PortContext.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* for debugging only */
name|print_tdlist_flink
argument_list|(
operator|&
operator|(
name|tdsaPortContext
operator|->
name|FreeLink
operator|)
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|print_tdlist_flink
argument_list|(
operator|&
operator|(
name|tdsaPortContext
operator|->
name|MainLink
operator|)
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|print_tdlist_flink
argument_list|(
operator|&
operator|(
name|tdsaDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|print_tdlist_flink
argument_list|(
operator|&
operator|(
name|tdsaDeviceData
operator|->
name|MainLink
operator|)
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* for debugging */
name|PortContextList
operator|=
name|tdsaPortContext
operator|->
name|MainLink
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaPortContext
operator|->
name|MainLink
operator|)
condition|)
block|{
name|twoPortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: in while portContext ID %d\n"
operator|,
name|twoPortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: in while PortContext %p\n"
operator|,
name|twoPortContext
operator|)
argument_list|)
expr_stmt|;
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* add agDevHandle */
if|if
condition|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
name|IDframe
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|agSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
name|IDframe
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
name|IDframe
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|IDframe
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|IDframe
operator|->
name|target_ssp_stp_smp
expr_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: adding ....\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* uses only SASIDframe not agsaSASDeviceInfo_t */
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdssAddSASToSharedcontext
argument_list|(
name|onePortContext
argument_list|,
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
comment|/* agNULL */
operator|&
name|agSASSubID
argument_list|,
name|agTRUE
argument_list|,
operator|(
name|bit8
operator|)
name|PhyID
argument_list|,
name|TD_OPERATION_INITIATOR
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_DM
if|if
condition|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
name|IDframe
argument_list|)
operator|==
name|SAS_END_DEVICE
operator|&&
name|SA_IDFRM_IS_SSP_TARGET
argument_list|(
name|IDframe
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: NOTIFY_ENABLE_SPINUP PhyID %d \n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_NOTIFY_SPINUP
condition|;
name|i
operator|++
control|)
block|{
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|PhyID
argument_list|,
name|AGSA_PHY_NOTIFY_ENABLE_SPINUP
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* update MCN */
name|tdsaUpdateMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: target, link up PhyID 0x%x\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"ossaHwCB: $$$$$ not end device. not adding....\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|saPortControl
argument_list|(
name|agRoot
argument_list|,
comment|/* AGSA_PORT_SET_PORT_RECOVERY_TIME */
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agPortContext
argument_list|,
name|AGSA_PORT_SET_PORT_RECOVERY_TIME
argument_list|,
name|tdsaAllShared
operator|->
name|portTMO
argument_list|,
comment|//PORT_RECOVERY_TIMEOUT
literal|0
argument_list|)
expr_stmt|;
comment|/* setting SAS PORT RESET TMO and SATA PORT RESET TMO*/
if|if
condition|(
name|tIsSPCV12G
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|saPortControl
argument_list|(
name|agRoot
argument_list|,
comment|/* AGSA_PORT_SET_PORT_RESET_TIME */
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agPortContext
argument_list|,
name|AGSA_PORT_SET_PORT_RESET_TIME
argument_list|,
name|SAS_12G_PORT_RESET_TMO
argument_list|,
comment|// 800 ms
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|saPortControl
argument_list|(
name|agRoot
argument_list|,
comment|/* AGSA_PORT_SET_PORT_RESET_TIME */
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agPortContext
argument_list|,
name|AGSA_PORT_SET_PORT_RESET_TIME
argument_list|,
name|SAS_PORT_RESET_TMO
argument_list|,
comment|// 300 ms
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*         an existing portcontext         to be tested       */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: SAS existing portcontext returned\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: onePortContext is NULL, wrong!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
comment|/* port has been invalidated; needs to be allocated */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: SAS allocating port context\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
condition|)
block|{
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|PortContextList
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|FreeLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: allocating pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: allocating onePortContext %p\n"
operator|,
name|onePortContext
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: onePortContext is NULL in allocation, wrong!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* sets fields of tdsaportcontext */
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_NOT_STARTED
expr_stmt|;
name|onePortContext
operator|->
name|discoveryOptions
operator|=
name|AG_SA_DISCOVERY_OPTION_FULL_START
expr_stmt|;
endif|#
directive|endif
name|onePortContext
operator|->
name|PhyIDList
index|[
name|PhyID
index|]
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|IDframe
operator|==
name|agNULL
condition|)
block|{
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|onePortContext
operator|->
name|sasRemoteAddressLo
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|onePortContext
operator|->
name|directAttatchedSAS
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
name|IDframe
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|sasRemoteAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
name|IDframe
argument_list|)
expr_stmt|;
comment|/* Create ID frame and storing ID frame */
name|osti_memcpy
argument_list|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
argument_list|,
name|IDframe
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASIdentify_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"ossaHWCB: sasIDframe"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASIdentify_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
name|IDframe
argument_list|)
operator|==
name|SAS_END_DEVICE
condition|)
block|{
name|onePortContext
operator|->
name|directAttatchedSAS
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|SASID
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|SASID
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|tiPortalContext
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
expr_stmt|;
name|onePortContext
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|onePortContext
operator|->
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|=
name|onePortContext
expr_stmt|;
name|agPortContext
operator|->
name|osData
operator|=
name|onePortContext
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|LinkRate
operator|==
literal|0x01
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_1_5G
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|LinkRate
operator|==
literal|0x02
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_3_0G
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|LinkRate
operator|==
literal|0x04
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_6_0G
expr_stmt|;
block|}
else|else
comment|/* (LinkRate == 0x08) */
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_12_0G
expr_stmt|;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"\nossaHwCB: Attention!!! no more free PortContext.\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* invalidated port */
else|else
block|{
comment|/* already alloacated */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: SAS already allocated port context\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: wrong!!!  null tdsaPortContext list\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: wrong !!! No corressponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: existing pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: existing allshared pid is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: existing allshared pid %d\n"
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* updates PhyID belong to a port */
name|onePortContext
operator|->
name|PhyIDList
index|[
name|PhyID
index|]
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
if|if
condition|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
name|IDframe
argument_list|)
operator|==
name|SAS_END_DEVICE
operator|&&
name|SA_IDFRM_IS_SSP_TARGET
argument_list|(
name|IDframe
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: NOTIFY_ENABLE_SPINUP PhyID %d \n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_NOTIFY_SPINUP
condition|;
name|i
operator|++
control|)
block|{
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|PhyID
argument_list|,
name|AGSA_PHY_NOTIFY_ENABLE_SPINUP
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* update MCN */
name|tdsaUpdateMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|onePortContext
operator|->
name|SeenLinkUp
operator|=
name|agTRUE
expr_stmt|;
block|}
comment|/* else, old portcontext */
break|break;
block|}
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
case|case
name|OSSA_HW_EVENT_SATA_PHY_UP
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|LinkRate
operator|=
name|TD_GET_LINK_RATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
name|agNULL
expr_stmt|;
name|RegD2H
operator|=
operator|(
name|agsaFisRegDeviceToHost_t
operator|*
operator|)
name|eventParm3
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: Phy%d SATA link Up\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaHwCB: agDevHandle null by design change\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|RegD2H
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: RegD2H null, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'g'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: agDevHandle %p\n"
operator|,
name|agDevHandle
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"ossaHWCB RegD2H"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|RegD2H
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegDeviceToHost_t
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: Sector Count %d\n"
operator|,
name|RegD2H
operator|->
name|d
operator|.
name|sectorCount
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: LBA LOW %d\n"
operator|,
name|RegD2H
operator|->
name|d
operator|.
name|lbaLow
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: LBA MID  %d\n"
operator|,
name|RegD2H
operator|->
name|d
operator|.
name|lbaMid
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: LBA HIGH  %d\n"
operator|,
name|RegD2H
operator|->
name|d
operator|.
name|lbaHigh
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: DEVICE  %d\n"
operator|,
name|RegD2H
operator|->
name|d
operator|.
name|device
operator|)
argument_list|)
expr_stmt|;
comment|/* debugging only */
if|if
condition|(
name|LinkRate
operator|==
literal|0x01
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: SATA Link Rate is 1.5 Gbps PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LinkRate
operator|==
literal|0x02
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: SATA Link Rate is 3.0 Gbps PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LinkRate
operator|==
literal|0x04
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: SATA Link Rate is 6.0 Gbps PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LinkRate
operator|==
literal|0x08
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: SATA Link Rate is 12.0 Gbps PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with SATA link up\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'h'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
comment|/* if */
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: PhyID %d tdsaAllShared %p\n"
operator|,
name|PhyID
operator|,
name|tdsaAllShared
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
condition|)
block|{
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|PortContextList
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|FreeLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: onePortContext %p\n"
operator|,
name|onePortContext
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: onePortContext is NULL in allocation, wrong!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* sets fields of tdsaportcontext */
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_NOT_STARTED
expr_stmt|;
name|onePortContext
operator|->
name|discoveryOptions
operator|=
name|AG_SA_DISCOVERY_OPTION_FULL_START
expr_stmt|;
name|onePortContext
operator|->
name|PhyIDList
index|[
name|PhyID
index|]
operator|=
name|agTRUE
expr_stmt|;
comment|/* NO sas address for SATA */
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|onePortContext
operator|->
name|sasRemoteAddressLo
operator|=
literal|0xFFFFFFFF
expr_stmt|;
comment|/* copying the signature */
name|onePortContext
operator|->
name|remoteSignature
index|[
literal|0
index|]
operator|=
name|RegD2H
operator|->
name|d
operator|.
name|sectorCount
expr_stmt|;
name|onePortContext
operator|->
name|remoteSignature
index|[
literal|1
index|]
operator|=
name|RegD2H
operator|->
name|d
operator|.
name|lbaLow
expr_stmt|;
name|onePortContext
operator|->
name|remoteSignature
index|[
literal|2
index|]
operator|=
name|RegD2H
operator|->
name|d
operator|.
name|lbaMid
expr_stmt|;
name|onePortContext
operator|->
name|remoteSignature
index|[
literal|3
index|]
operator|=
name|RegD2H
operator|->
name|d
operator|.
name|lbaHigh
expr_stmt|;
name|onePortContext
operator|->
name|remoteSignature
index|[
literal|4
index|]
operator|=
name|RegD2H
operator|->
name|d
operator|.
name|device
expr_stmt|;
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|SASID
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|SASID
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|tiPortalContext
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
expr_stmt|;
name|onePortContext
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|onePortContext
operator|->
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|=
name|onePortContext
expr_stmt|;
name|agPortContext
operator|->
name|osData
operator|=
name|onePortContext
expr_stmt|;
name|onePortContext
operator|->
name|nativeSATAMode
operator|=
name|agTRUE
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|LinkRate
operator|==
literal|0x01
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_1_5G
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|LinkRate
operator|==
literal|0x02
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_3_0G
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|LinkRate
operator|==
literal|0x04
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_6_0G
expr_stmt|;
block|}
else|else
comment|/* (LinkRate == 0x08) */
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_12_0G
expr_stmt|;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"\nossaHwCB: Attention!!! no more free PortContext.\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'i'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|SATA_ENABLE
comment|/* tdssAddSATAToSharedcontext() sends identify device data to find out the uniqueness of          target. In identify device data CB fn (satAddSATAIDDevCB()),          tiPortLinkUp and tiPortDiscoveryReady happen       */
name|tdssAddSATAToSharedcontext
argument_list|(
name|onePortContext
argument_list|,
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
comment|/* agNULL */
name|agNULL
argument_list|,
name|agTRUE
argument_list|,
operator|(
name|bit8
operator|)
name|PhyID
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* setting SAS PORT RESET TMO and SATA PORT RESET TMO*/
name|saPortControl
argument_list|(
name|agRoot
argument_list|,
comment|/* AGSA_PORT_SET_PORT_RESET_TIME */
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agPortContext
argument_list|,
name|AGSA_PORT_SET_PORT_RESET_TIME
argument_list|,
literal|0
argument_list|,
name|SATA_PORT_RESET_TMO
comment|// 8000 ms
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*         an existing portcontext         to be tested       */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: SATA existing portcontext returned. need testing\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
comment|/* for debugging only */
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
comment|/* port has been invalidated; needs to be allocated */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: SATA allocating port context\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* already alloacated */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong!!! SATA already allocated port context\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'j'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
condition|)
block|{
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|PortContextList
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|FreeLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: onePortContext %p\n"
operator|,
name|onePortContext
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: onePortContext is NULL in allocation, wrong!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* sets fields of tdsaportcontext */
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_NOT_STARTED
expr_stmt|;
name|onePortContext
operator|->
name|discoveryOptions
operator|=
name|AG_SA_DISCOVERY_OPTION_FULL_START
expr_stmt|;
name|onePortContext
operator|->
name|PhyIDList
index|[
name|PhyID
index|]
operator|=
name|agTRUE
expr_stmt|;
comment|/* NO sas address for SATA */
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|onePortContext
operator|->
name|sasRemoteAddressLo
operator|=
literal|0xFFFFFFFF
expr_stmt|;
comment|/* copying the signature */
name|onePortContext
operator|->
name|remoteSignature
index|[
literal|0
index|]
operator|=
name|RegD2H
operator|->
name|d
operator|.
name|sectorCount
expr_stmt|;
name|onePortContext
operator|->
name|remoteSignature
index|[
literal|1
index|]
operator|=
name|RegD2H
operator|->
name|d
operator|.
name|lbaLow
expr_stmt|;
name|onePortContext
operator|->
name|remoteSignature
index|[
literal|2
index|]
operator|=
name|RegD2H
operator|->
name|d
operator|.
name|lbaMid
expr_stmt|;
name|onePortContext
operator|->
name|remoteSignature
index|[
literal|3
index|]
operator|=
name|RegD2H
operator|->
name|d
operator|.
name|lbaHigh
expr_stmt|;
name|onePortContext
operator|->
name|remoteSignature
index|[
literal|4
index|]
operator|=
name|RegD2H
operator|->
name|d
operator|.
name|device
expr_stmt|;
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|SASID
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|SASID
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|tiPortalContext
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
expr_stmt|;
name|onePortContext
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|onePortContext
operator|->
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|=
name|onePortContext
expr_stmt|;
name|agPortContext
operator|->
name|osData
operator|=
name|onePortContext
expr_stmt|;
name|onePortContext
operator|->
name|nativeSATAMode
operator|=
name|agTRUE
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|LinkRate
operator|==
literal|0x01
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_1_5G
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|LinkRate
operator|==
literal|0x02
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_3_0G
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|LinkRate
operator|==
literal|0x04
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_6_0G
expr_stmt|;
block|}
else|else
comment|/* (LinkRate == 0x08) */
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_12_0G
expr_stmt|;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"\nossaHwCB: Attention!!! no more free PortContext.\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'k'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*hotplug */
ifdef|#
directive|ifdef
name|SATA_ENABLE
name|tdssAddSATAToSharedcontext
argument_list|(
name|onePortContext
argument_list|,
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
comment|/* agNULL */
name|agNULL
argument_list|,
name|agTRUE
argument_list|,
operator|(
name|bit8
operator|)
name|PhyID
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* end hotplug */
block|}
break|break;
block|}
endif|#
directive|endif
case|case
name|OSSA_HW_EVENT_SATA_SPINUP_HOLD
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: spinup hold PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_DOWN
case|:
block|{
name|bit32
name|AllPhyDown
init|=
name|agTRUE
decl_stmt|;
comment|/* 4/15/08 spec */
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|LinkRate
operator|=
name|TD_GET_LINK_RATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: Phy%d link Down\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext null, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'l'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
comment|/* if */
comment|/* PortContext must exit at this point */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: NULL portalcontext. Error. Can't be NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaHwCB: NOT NULL portalcontext\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: wrong !!! No corressponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'m'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
name|onePortContext
operator|->
name|PhyIDList
index|[
name|PhyID
index|]
operator|=
name|agFALSE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaHwCB: Phy %d is still up\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|AllPhyDown
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
block|}
comment|/* last phy belong to the portcontext */
if|if
condition|(
name|AllPhyDown
operator|==
name|agTRUE
condition|)
block|{
ifdef|#
directive|ifdef
name|NOT_YET
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: calling tiPortLinkDown\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkDown
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_VALID
condition|)
block|{
comment|/* do nothing */
comment|/* no ack for every phy down */
ifdef|#
directive|ifdef
name|FDS_DM
comment|/* update MCN for all devices belong to this port */
name|tdsaUpdateMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_LOSTCOMM
condition|)
block|{
comment|/*          1. Mark the port as invalid and stop the io for that port and its device          No ack here. Otherwise, port will be released by FW.         */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: phy Down and OSSA_PORT_LOSTCOMM\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* save eventSource related information in tdsaAllShared */
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|=
name|agTRUE
expr_stmt|;
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|.
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_PHY_DOWN
expr_stmt|;
comment|/* phy ID */
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|.
name|param
operator|=
name|PhyID
expr_stmt|;
comment|/* phy ID */
name|onePortContext
operator|->
name|eventPhyID
operator|=
name|PhyID
expr_stmt|;
comment|/* to stop IO's */
name|onePortContext
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_IN_RESET
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: phy Down and OSSA_PORT_IN_RESET\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* save eventSource related information in tdsaAllShared */
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|=
name|agTRUE
expr_stmt|;
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|.
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_PHY_DOWN
expr_stmt|;
comment|/* phy ID */
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|.
name|param
operator|=
name|PhyID
expr_stmt|;
comment|/* phy ID */
name|onePortContext
operator|->
name|eventPhyID
operator|=
name|PhyID
expr_stmt|;
comment|/* to stop IO's */
name|onePortContext
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Last phy Down and port invalid OSSA_PORT_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*           invalidate port           then, saHwEventAck() in ossaDeregisterDeviceHandleCB()         */
comment|/* save eventSource related information in tdsaAllShared */
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|=
name|agTRUE
expr_stmt|;
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|.
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_PHY_DOWN
expr_stmt|;
comment|/* phy ID */
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|.
name|param
operator|=
name|PhyID
expr_stmt|;
comment|/* phy ID */
name|onePortContext
operator|->
name|eventPhyID
operator|=
name|PhyID
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* notifying link down (all links belonging to a port are down) */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortStopped
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkDown
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdssReportRemovals
argument_list|(
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|ttdssReportRemovals
argument_list|(
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* find a PhyID and reset for portContext in tdssSASShared */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|portContext
operator|=
name|agNULL
expr_stmt|;
block|}
block|}
comment|/* portcontext is removed from MainLink to FreeLink in tdssReportRemovals or        ossaDeregisterDeviceHandleCB      */
block|}
comment|/* OSSA_PORT_INVALID */
else|else
block|{
comment|/* other newly defined port state */
comment|/* do nothing */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: portstate 0x%x\n"
operator|,
name|PortState
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* big else */
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_START_STATUS
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PhyStatus
operator|=
name|TD_GET_PHY_STATUS
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_START_STATUS\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PhyStatus
operator|==
literal|0x00
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_START_STATUS, SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|PhyStatus
operator|==
literal|0x01
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_START_STATUS, INVALID_PHY\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|PhyStatus
operator|==
literal|0x02
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_START_STATUS, PHY_NOT_DISABLED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_START_STATUS, OTHER_FAILURE %d\n"
operator|,
name|PhyStatus
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_STOP_STATUS
case|:
block|{
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PhyStatus
operator|=
name|TD_GET_PHY_STATUS
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_STOP_STATUS\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PhyStatus
operator|==
literal|0x00
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_STOP_STATUS, SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
name|agContext
operator|=
operator|(
name|agsaContext_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agContext
operator|->
name|osData
expr_stmt|;
empty_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: onePortContext is null, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|onePortContext
operator|->
name|PhyIDList
index|[
name|PhyID
index|]
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
comment|/* invalid port */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_PORT_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|=
name|NO_ACK
expr_stmt|;
name|onePortContext
operator|->
name|eventPhyID
operator|=
name|PhyID
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* notifying link down (all links belonging to a port are down) */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortStopped
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkDown
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdssReportRemovals
argument_list|(
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|ttdssReportRemovals
argument_list|(
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* find a PhyID and reset for portContext in tdssSASShared */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|portContext
operator|=
name|agNULL
expr_stmt|;
block|}
block|}
comment|/* portcontext is removed from MainLink to FreeLink in tdssReportRemovals or        ossaDeregisterDeviceHandleCB      */
block|}
comment|/* invalid port */
block|}
elseif|else
if|if
condition|(
name|PhyStatus
operator|==
literal|0x01
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_STOP_STATUS, INVALID_PHY\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|PhyStatus
operator|==
literal|0x02
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_STOP_STATUS, DEVICES_ATTACHED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|PhyStatus
operator|==
literal|0x03
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_STOP_STATUS, OTHER_FAILURE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|PhyStatus
operator|==
literal|0x04
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_STOP_STATUS, PHY_NOT_DISABLED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_STOP_STATUS, Unknown %d\n"
operator|,
name|PhyStatus
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_RESET_START
case|:
block|{
name|bit32
name|new_status
init|=
name|TD_GET_RESET_STATUS
argument_list|(
name|eventParm1
argument_list|)
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: RESET_START, status %d\n"
operator|,
name|new_status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|tdsaAllShared
operator|->
name|flags
operator|.
name|resetInProgress
operator|=
name|agTRUE
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: RESET_START, SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|new_status
operator|==
name|OSSA_FAILURE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: RESET_START, FAILURE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: RESET_START, PENDING\n"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_RESET_COMPLETE
case|:
block|{
name|bit32
name|new_status
init|=
name|TD_GET_RESET_STATUS
argument_list|(
name|eventParm1
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|SOFT_RESET_TEST
name|DbgPrint
argument_list|(
literal|"Reset Complete\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_RESET_COMPLETE, status %d\n"
operator|,
name|new_status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
comment|/* remove all portcontext and devices */
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdssRemoveSASSATAFromSharedcontextByReset
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|tdsaAllShared
operator|->
name|flags
operator|.
name|resetInProgress
operator|=
name|agFALSE
expr_stmt|;
comment|/*         a callback notifying reset completion       */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortResetComplete
argument_list|,
name|tiSuccess
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*         a callback notifying reset completion       */
name|tdsaAllShared
operator|->
name|flags
operator|.
name|resetInProgress
operator|=
name|agFALSE
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortResetComplete
argument_list|,
name|tiError
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_INBOUND_CRC
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|agPhyErrCountersPage
operator|=
operator|(
name|agsaPhyErrCountersPage_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_INBOUND_CRC from PhyID %d; to be tested\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with OSSA_HW_EVENT_PHY_ERR_INBOUND_CRC\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'n'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPhyErrCountersPage
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_INBOUND_CRC from PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: iDw %d rDE %d cV %d lS %d rP %d iCRC %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|invalidDword
operator|,
name|agPhyErrCountersPage
operator|->
name|runningDisparityError
operator|,
name|agPhyErrCountersPage
operator|->
name|codeViolation
operator|,
name|agPhyErrCountersPage
operator|->
name|lossOfDwordSynch
operator|,
name|agPhyErrCountersPage
operator|->
name|phyResetProblem
operator|,
name|agPhyErrCountersPage
operator|->
name|inboundCRCError
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_INBOUND_CRC: Error!!!  eventParm2 is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* saHwEventAck() */
name|eventSource
operator|.
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|eventSource
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_PHY_ERR_INBOUND_CRC
expr_stmt|;
comment|/* phy ID */
name|eventSource
operator|.
name|param
operator|=
name|PhyID
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
operator|&
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'o'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_HW_EVENT_PORT_INVALID
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: PORT_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext is NULL, wrong.\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'p'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: NOT NULL osDATA\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*         put the old portcontext back to free list       */
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* notifying link down (all links belonging to a port are down) */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortStopped
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* INITIATOR_DRIVER */
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkDown
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*TARGET_DRIVER  */
comment|/* find the device belonging to the port and remove it from the device list */
comment|//tdssRemoveSASSATAFromSharedcontext(agRoot, tdsaDeviceData, onePortContext);
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* reset the fields of portcontext */
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_NOT_STARTED
expr_stmt|;
name|tdssReportRemovals
argument_list|(
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discoveryOptions
operator|=
name|AG_SA_DISCOVERY_OPTION_FULL_START
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryRdyGiven
operator|=
name|agFALSE
expr_stmt|;
name|onePortContext
operator|->
name|SeenLinkUp
operator|=
name|agFALSE
expr_stmt|;
endif|#
directive|endif
comment|/* INITIATOR_DRIVER */
comment|/* for hotplug */
comment|/* find a PhyID and reset for portContext in tdssSASShared */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|portContext
operator|=
name|agNULL
expr_stmt|;
block|}
block|}
comment|/* reset PhyIDList in portcontext */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|//      onePortContext->tiPortalContext = agNULL;
comment|//      onePortContext->agRoot = agNULL;
name|onePortContext
operator|->
name|agPortContext
operator|=
name|agNULL
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaHwCB: pid %d count %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|Count
operator|)
argument_list|)
expr_stmt|;
comment|/* resets the number of devices in onePortContext */
name|onePortContext
operator|->
name|Count
operator|=
literal|0
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|=
literal|0
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agFALSE
expr_stmt|;
comment|/*         put all devices belonging to the onePortContext         back to the free link       */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaPortContext
operator|->
name|FreeLink
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: NULL osDATA: wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaHwCB: PORT_INVALID end\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* REMOVED */
case|case
name|OSSA_HW_EVENT_BROADCAST_CHANGE
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_CHANGE from PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with  BROADCAST_CHANGE\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'q'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* saHwEventAck() */
name|eventSource
operator|.
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|eventSource
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_BROADCAST_CHANGE
expr_stmt|;
comment|/* phy ID */
name|eventSource
operator|.
name|param
operator|=
name|PhyID
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
operator|&
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaHwCB: calling saHwEventAck\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'r'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tIsSPC12SATA
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_CHANGE received for SATA Controller\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*      * incremental discovery is to be tested and debugged further      */
comment|/* just for testing discovery abort */
ifdef|#
directive|ifdef
name|FDS_DM_NO
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
comment|/* this case happens when broadcase is received first before the link up */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext is NULL. Do nothing.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|!=
name|agNULL
condition|)
block|{
name|dmRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
name|dmPortContext
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|dmPortContext
operator|)
expr_stmt|;
name|dmQueryDiscovery
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|)
expr_stmt|;
comment|//      dmDiscover(dmRoot, dmPortContext, DM_DISCOVERY_OPTION_ABORT);
if|#
directive|if
literal|1
if|if
condition|(
name|onePortContext
operator|->
name|DMDiscoveryState
operator|==
name|dmDiscInProgress
condition|)
block|{
name|dmDiscover
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|DM_DISCOVERY_OPTION_ABORT
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* 1 */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DMDiscoveryState
operator|==
name|dmDiscCompleted
operator|||
name|onePortContext
operator|->
name|DMDiscoveryState
operator|==
name|dmDiscAborted
operator|||
name|onePortContext
operator|->
name|DMDiscoveryState
operator|==
name|dmDiscAbortInvalid
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_CHANGE; calling dmNotifyBC and does incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|dmNotifyBC
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|OSSA_HW_EVENT_BROADCAST_CHANGE
argument_list|)
expr_stmt|;
name|dmDiscover
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: pid %d BROADCAST_CHANGE; updating SeenBC. calling dmNotifyBC\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|dmNotifyBC
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|OSSA_HW_EVENT_BROADCAST_CHANGE
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_CHANGE NULL osDATA wrong !!! \n"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FDS_DM_NO */
ifdef|#
directive|ifdef
name|FDS_DM
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
comment|/* this case happens when broadcase is received first before the link up */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext is NULL. Do nothing.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|!=
name|agNULL
condition|)
block|{
name|dmRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
name|dmPortContext
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|dmPortContext
operator|)
expr_stmt|;
name|dmQueryDiscovery
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DMDiscoveryState
operator|==
name|dmDiscCompleted
operator|||
name|onePortContext
operator|->
name|DMDiscoveryState
operator|==
name|dmDiscAborted
operator|||
name|onePortContext
operator|->
name|DMDiscoveryState
operator|==
name|dmDiscAbortInvalid
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_CHANGE; calling dmNotifyBC and does incremental discovery, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_STARTED
expr_stmt|;
name|dmNotifyBC
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|OSSA_HW_EVENT_BROADCAST_CHANGE
argument_list|)
expr_stmt|;
name|dmDiscover
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|DMDiscoveryState
operator|==
name|dmDiscFailed
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: dmDiscFailed; pid %d BROADCAST_CHANGE; updating SeenBC. calling dmNotifyBC\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscFailNSeenBC
operator|=
name|agTRUE
expr_stmt|;
name|dmNotifyBC
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|OSSA_HW_EVENT_BROADCAST_CHANGE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: pid %d BROADCAST_CHANGE; updating SeenBC. calling dmNotifyBC\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|dmNotifyBC
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|OSSA_HW_EVENT_BROADCAST_CHANGE
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_CHANGE NULL osDATA wrong !!! \n"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FDS_DM */
ifdef|#
directive|ifdef
name|FDS_DM_WORKED
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
comment|/* this case happens when broadcase is received first before the link up */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext is NULL. Do nothing.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|!=
name|agNULL
condition|)
block|{
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: calling dmNotifyBC\n"
operator|)
argument_list|)
expr_stmt|;
name|dmRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
expr_stmt|;
name|dmPortContext
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|dmPortContext
operator|)
expr_stmt|;
name|dmNotifyBC
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|OSSA_HW_EVENT_BROADCAST_CHANGE
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FDS_DM_WORKED */
ifndef|#
directive|ifndef
name|FDS_DM
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
comment|/* this case happens when broadcase is received first before the link up */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext is NULL. Do nothing.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|!=
name|agNULL
condition|)
block|{
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|ITD_DSTATE_COMPLETED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_CHANGE; does incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_NOT_STARTED
expr_stmt|;
name|onePortContext
operator|->
name|discoveryOptions
operator|=
name|AG_SA_DISCOVERY_OPTION_INCREMENTAL_START
expr_stmt|;
comment|/* processed broadcast change */
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agFALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DISCOVER
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
operator|&&
name|onePortContext
operator|->
name|discovery
operator|.
name|ResetTriggerred
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: tdsaBCTimer\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaBCTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|TDSA_DISCOVERY_TYPE_SAS
argument_list|,
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
name|saDiscover
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|AG_SA_DISCOVERY_TYPE_SAS
argument_list|,
name|onePortContext
operator|->
name|discoveryOptions
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: pid %d BROADCAST_CHANGE; updating SeenBC. Do nothing.\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_CHANGE NULL osDATA wrong !!! \n"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
comment|/* ifndef FDS_DM */
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PORT_RECOVERY_TIMER_TMO
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
comment|/*       1. tear town the portcontext just like link down last phy down       2. ack       port state must be invalid     */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PORT_RECOVERY_TIMER_TMO\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'s'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
name|TD_ASSERT
argument_list|(
name|agPortContext
argument_list|,
literal|"agPortContext"
argument_list|)
expr_stmt|;
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
comment|/* if */
comment|/* PortContext must exit at this point */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: NULL portalcontext. Error. Can't be NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: tiPortStopped pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* notifying link down (all links belonging to a port are down) */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortStopped
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkDown
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdssReportRemovals
argument_list|(
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|ttdssReportRemovals
argument_list|(
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* find a PhyID and reset for portContext in tdssSASShared */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|portContext
operator|=
name|agNULL
expr_stmt|;
block|}
block|}
comment|/* portcontext is removed from MainLink to FreeLink in tdssReportRemovals or          ossaDeregisterDeviceHandleCB        */
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PORT_RESET_TIMER_TMO
case|:
block|{
comment|/*        clean up     */
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PORT_RESET_TIMER_TMO\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'t'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext is NULL, error\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'u'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
comment|/* if */
comment|/* PortContext must exit at this point */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: NULL portalcontext. Error. Can't be NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: pid %d tiPortStopped\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* notifying link down (all links belonging to a port are down) */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortStopped
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkDown
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdssReportRemovals
argument_list|(
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TARGET_DRIVER
name|ttdssReportRemovals
argument_list|(
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* find a PhyID and reset for portContext in tdssSASShared */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|portContext
operator|=
name|agNULL
expr_stmt|;
block|}
block|}
comment|/* portcontext is removed from MainLink to FreeLink in tdssReportRemovals or          ossaDeregisterDeviceHandleCB        */
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PORT_RESET_COMPLETE
case|:
block|{
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tiIORequest_t
modifier|*
name|currentTaskTag
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REMOVED
name|smRoot_t
modifier|*
name|smRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
decl_stmt|;
endif|#
directive|endif
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|IDframe
operator|=
operator|(
name|agsaSASIdentify_t
operator|*
operator|)
name|eventParm3
expr_stmt|;
comment|/* completes for Lun Reset and Target reset for directly attached SATA */
comment|/* completes for Target reset for directly attached SAS */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PORT_RESET_COMPLETE, phyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
comment|/* error check */
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'v'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext null, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'w'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: agPortContext->osData null, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'x'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* find a corresponding portcontext */
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: oneportContext is NULL; wrong??????\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: oneportContext %p pid %d\n"
operator|,
name|onePortContext
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
ifdef|#
directive|ifdef
name|REMOVED
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
condition|)
block|{
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|onePortContext
condition|)
block|{
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
comment|/* while */
if|if
condition|(
name|found
operator|==
name|agTRUE
condition|)
block|{
comment|/* applied to only SATA devices */
if|if
condition|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|FDS_SM
name|tdIDStart
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
else|#
directive|else
name|tdssRetrySATAID
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: no onedevicedata found!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* completed TM */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|phyID
operator|==
name|PhyID
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: found the onePortContext and oneDeviceData!!\n"
operator|)
argument_list|)
expr_stmt|;
name|currentTaskTag
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|oneDeviceData
operator|->
name|agDeviceResetContext
operator|.
name|osData
expr_stmt|;
if|if
condition|(
name|currentTaskTag
operator|!=
name|agNULL
condition|)
block|{
comment|/* applied to only SATA devices */
if|if
condition|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|tdIORequestBody_t
modifier|*
name|SMTMtdIORequestBody
init|=
name|agNULL
decl_stmt|;
name|SMTMtdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|currentTaskTag
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|SMTMtdIORequestBody
operator|!=
name|agNULL
condition|)
block|{
comment|/* free the SMTMtdIORequestBody memory allocated in tiINITaskManagement function */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|SMTMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: SATA device but SMTMtdIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* set device state to DS_OPERATIONAL */
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
comment|/* notify OS layer to complete the TMF IO */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMOK
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: currentTaskTag is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
else|else
block|{
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_BROADCAST_ASYNCH_EVENT
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_BROADCAST_ASYNCH_EVENT\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tIsSPC12SATA
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_ASYNCH_EVENT received for SATA Controller\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Error!!! agPortContext is NULL %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'y'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Error!!! onePortContext is NULL %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'z'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|tiPortalContext
operator|!=
name|agNULL
condition|)
block|{
if|#
directive|if
literal|0
block|ostiInitiatorEvent(                          tiRoot,                          onePortContext->tiPortalContext,                          agNULL,                          tiIntrEventTypeDeviceChange,                          OSSA_HW_EVENT_BROADCAST_ASYNCH_EVENT,                          agNULL                          );
endif|#
directive|endif
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Error!!! onePortContext->tiPortalContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'A'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PORT_RECOVER
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Error!!! agPortContext is NULL %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'B'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
name|LinkRate
operator|=
name|TD_GET_LINK_RATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
name|agNULL
expr_stmt|;
name|IDframe
operator|=
operator|(
name|agsaSASIdentify_t
operator|*
operator|)
name|eventParm3
expr_stmt|;
comment|/*       1. this is like link up       2. handle the phyID       3. no trigger discovery (broadcast change will do this later)       port state must be valid     */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PORT_RECOVER, phyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'C'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPortContext
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
comment|/* if */
comment|/* PortContext must exit at this point */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: NULL portalcontext. Error. Can't be NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|PhyIDList
index|[
name|PhyID
index|]
operator|=
name|agTRUE
expr_stmt|;
name|onePortContext
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|=
name|onePortContext
expr_stmt|;
name|onePortContext
operator|->
name|tiPortalContext
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
expr_stmt|;
name|onePortContext
operator|->
name|PortRecoverPhyID
operator|=
name|PhyID
expr_stmt|;
if|if
condition|(
name|LinkRate
operator|==
literal|0x01
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_1_5G
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|LinkRate
operator|==
literal|0x02
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_3_0G
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|LinkRate
operator|==
literal|0x04
condition|)
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_6_0G
expr_stmt|;
block|}
else|else
comment|/* (LinkRate == 0x08) */
block|{
name|onePortContext
operator|->
name|LinkRate
operator|=
name|SAS_CONNECTION_RATE_12_0G
expr_stmt|;
block|}
if|if
condition|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
argument_list|)
operator|==
name|SAS_END_DEVICE
operator|&&
name|SA_IDFRM_IS_SSP_TARGET
argument_list|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PORT_RECOVER, sending spinup on phyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_NOTIFY_SPINUP
condition|;
name|i
operator|++
control|)
block|{
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|PhyID
argument_list|,
name|AGSA_PHY_NOTIFY_ENABLE_SPINUP
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* transient period between link up and link down/port recovery */
if|if
condition|(
name|onePortContext
operator|->
name|Transient
operator|==
name|agTRUE
operator|&&
name|onePortContext
operator|->
name|RegisteredDevNums
operator|==
literal|0
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PORT_RECOVER transient period"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
name|IDframe
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|agSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
name|IDframe
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
name|IDframe
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|IDframe
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|IDframe
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|tdssAddSASToSharedcontext
argument_list|(
name|onePortContext
argument_list|,
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
comment|/* agNULL */
operator|&
name|agSASSubID
argument_list|,
name|agTRUE
argument_list|,
operator|(
name|bit8
operator|)
name|PhyID
argument_list|,
name|TD_OPERATION_INITIATOR
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|onePortContext
operator|->
name|Transient
operator|=
name|agFALSE
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_BROADCAST_SES
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_SES  from PhyID %d; to be tested\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tIsSPC12SATA
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_SES received for SATA Controller\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with  BROADCAST_SES\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'D'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*        let os layer read payload     */
break|break;
block|}
case|case
name|OSSA_HW_EVENT_BROADCAST_EXP
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_EXP from PhyID %d; to be tested\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tIsSPC12SATA
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: BROADCAST_EXP received for SATA Controller\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with  BROADCAST_EXP\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'E'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* to-do:        let os layer read payload     */
break|break;
block|}
case|case
name|OSSA_HW_EVENT_HARD_RESET_RECEIVED
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: HARD_RESET_RECEIVED from PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_VALID
operator|&&
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: calling saPortControl and OSSA_PORT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
name|saPortControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agPortContext
argument_list|,
name|AGSA_PORT_HARD_RESET
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_3RDPARTY_RESET
operator|&&
operator|(
name|tIsSPCV12or6G
argument_list|(
name|agRoot
argument_list|)
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: calling saPortControl and OSSA_PORT_3RDPARTY_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|saPortControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agPortContext
argument_list|,
name|AGSA_PORT_HARD_RESET
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* PortState == OSSA_PORT_INVALID */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Error. Port state is invalid\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: calling saLocalPhyControl on phyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|PhyID
argument_list|,
name|AGSA_PHY_LINK_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_MALFUNCTION
case|:
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaFatalErrorInfo_t
modifier|*
name|FatalError
init|=
operator|(
name|agsaFatalErrorInfo_t
operator|*
operator|)
name|eventParm2
decl_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_MALFUNCTION \n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: errorInfo0 %8X errorInfo1 %8X\n"
operator|,
name|FatalError
operator|->
name|errorInfo0
operator|,
name|FatalError
operator|->
name|errorInfo1
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: errorInfo2 %8X errorInfo3 %8X\n"
operator|,
name|FatalError
operator|->
name|errorInfo2
operator|,
name|FatalError
operator|->
name|errorInfo3
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: regDumpBusBaseNum0 %8X regDumpOffset0 %8X regDumpLen0 %8X\n"
operator|,
name|FatalError
operator|->
name|regDumpBusBaseNum0
operator|,
name|FatalError
operator|->
name|regDumpOffset0
operator|,
name|FatalError
operator|->
name|regDumpLen0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: regDumpBusBaseNum1 %8X regDumpOffset1 %8X regDumpLen1 %8X\n"
operator|,
name|FatalError
operator|->
name|regDumpBusBaseNum1
operator|,
name|FatalError
operator|->
name|regDumpOffset1
operator|,
name|FatalError
operator|->
name|regDumpLen1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eventParm1
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: fatal error\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* port panic */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortPanic
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: non-fatal error \n"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_ID_FRAME_TIMEOUT
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_ID_FRAME_TIMEOUT from PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with  OSSA_HW_EVENT_ID_FRAME_TIMEOUT\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'F'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_INVALID_DWORD
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|agPhyErrCountersPage
operator|=
operator|(
name|agsaPhyErrCountersPage_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_INVALID_DWORD\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with  OSSA_HW_EVENT_PHY_ERR_INVALID_DWORD\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'G'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPhyErrCountersPage
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_INVALID_DWORD from PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: invalidDword %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|invalidDword
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_INVALID_DWORD: Error!!!  eventParm2 is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* saHwEventAck() */
name|eventSource
operator|.
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|eventSource
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_PHY_ERR_INVALID_DWORD
expr_stmt|;
comment|/* phy ID */
name|eventSource
operator|.
name|param
operator|=
name|PhyID
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
operator|&
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'H'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_DISPARITY_ERROR
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|agPhyErrCountersPage
operator|=
operator|(
name|agsaPhyErrCountersPage_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_DISPARITY_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with  OSSA_HW_EVENT_PHY_ERR_DISPARITY_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'I'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPhyErrCountersPage
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_DISPARITY_ERROR from PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: runningDisparityError %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|runningDisparityError
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_DISPARITY_ERROR: Error!!!  eventParm2 is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* saHwEventAck() */
name|eventSource
operator|.
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|eventSource
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_PHY_ERR_DISPARITY_ERROR
expr_stmt|;
comment|/* phy ID */
name|eventSource
operator|.
name|param
operator|=
name|PhyID
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
operator|&
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'J'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_CODE_VIOLATION
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|agPhyErrCountersPage
operator|=
operator|(
name|agsaPhyErrCountersPage_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_CODE_VIOLATION\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with  OSSA_HW_EVENT_PHY_ERR_CODE_VIOLATION\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'K'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPhyErrCountersPage
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_CODE_VIOLATION from PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: codeViolation %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|codeViolation
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_CODE_VIOLATION: Error!!!  eventParm2 is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* saHwEventAck() */
name|eventSource
operator|.
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|eventSource
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_PHY_ERR_CODE_VIOLATION
expr_stmt|;
comment|/* phy ID */
name|eventSource
operator|.
name|param
operator|=
name|PhyID
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
operator|&
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'L'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_HW_EVENT_LINK_ERR_CODE_VIOLATION1
case|:
block|{
name|PhyID
operator|=
name|eventParm1
operator|&
literal|0xFF
expr_stmt|;
name|agPhyErrCountersPage
operator|=
operator|(
name|agsaPhyErrCountersPage_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
if|if
condition|(
name|agPhyErrCountersPage
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_LINK_ERR_CODE_VIOLATION1 from PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: invalidDword %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|invalidDword
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: runningDisparityError %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|runningDisparityError
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: codeViolation %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|codeViolation
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: lostOfDwordSynch %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|lossOfDwordSynch
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: phyResetProblem %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|phyResetProblem
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: inboundCRCError %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|inboundCRCError
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_LINK_ERR_CODE_VIOLATION1: Error!!!  eventParm2 is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* REMOVED */
case|case
name|OSSA_HW_EVENT_PHY_ERR_LOSS_OF_DWORD_SYNCH
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|agPhyErrCountersPage
operator|=
operator|(
name|agsaPhyErrCountersPage_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_LOSS_OF_DWORD_SYNCH\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with  OSSA_HW_EVENT_PHY_ERR_LOSS_OF_DWORD_SYNCH\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'M'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPhyErrCountersPage
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_LOSS_OF_DWORD_SYNCH from PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: lostOfDwordSynch %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|lossOfDwordSynch
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_LOSS_OF_DWORD_SYNCH: Error!!!  eventParm2 is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* saHwEventAck() */
name|eventSource
operator|.
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|eventSource
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_PHY_ERR_LOSS_OF_DWORD_SYNCH
expr_stmt|;
comment|/* phy ID */
name|eventSource
operator|.
name|param
operator|=
name|PhyID
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
operator|&
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'N'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_PHY_RESET_FAILED
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|agPhyErrCountersPage
operator|=
operator|(
name|agsaPhyErrCountersPage_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_PHY_RESET_FAILED\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Wrong port state with  OSSA_HW_EVENT_PHY_ERR_PHY_RESET_FAILED\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'O'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agPhyErrCountersPage
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_PHY_RESET_FAILED from PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: phyResetProblem %d\n"
operator|,
name|agPhyErrCountersPage
operator|->
name|phyResetProblem
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_ERR_PHY_RESET_FAILED: Error!!!  eventParm2 is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* saHwEventAck() */
name|eventSource
operator|.
name|agPortContext
operator|=
name|agPortContext
expr_stmt|;
name|eventSource
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_PHY_ERR_PHY_RESET_FAILED
expr_stmt|;
comment|/* phy ID */
name|eventSource
operator|.
name|param
operator|=
name|PhyID
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
operator|&
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'P'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
block|}
comment|// #ifdef INITIATOR_DRIVER
case|case
name|OSSA_HW_EVENT_ENCRYPTION
case|:
block|{
name|pEncryptCBData
operator|=
operator|(
name|agsaHWEventEncrypt_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_ENCRYPTION: encryptOperation 0x%x\n"
operator|,
name|pEncryptCBData
operator|->
name|encryptOperation
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: event 0x%x eventParm1 0x%x eventParm2 %p eventParm3 %p\n"
operator|,
name|event
operator|,
name|eventParm1
operator|,
name|eventParm2
operator|,
name|eventParm3
operator|)
argument_list|)
expr_stmt|;
comment|/*      * All events and status need to be translated from      * SAS specific values to TISA specific values. This      * is effectively a NOP, but the OS layer won't want to      * look for SAS values.      */
if|if
condition|(
name|pEncryptCBData
operator|->
name|encryptOperation
operator|==
name|OSSA_HW_ENCRYPT_KEK_UPDATE_AND_STORE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_ENCRYPT_KEK_UPDATE_AND_STORE\n"
operator|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptKekStore
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pEncryptCBData
operator|->
name|encryptOperation
operator|==
name|OSSA_HW_ENCRYPT_KEK_UPDATE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB:OSSA_HW_ENCRYPT_KEK_UPDATE \n"
operator|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptKekAdd
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pEncryptCBData
operator|->
name|encryptOperation
operator|==
name|OSSA_HW_ENCRYPT_KEK_INVALIDTE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB:OSSA_HW_ENCRYPT_KEK_INVALIDTE \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* none */
block|}
elseif|else
if|if
condition|(
name|pEncryptCBData
operator|->
name|encryptOperation
operator|==
name|OSSA_HW_ENCRYPT_DEK_UPDATE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_ENCRYPT_DEK_UPDATE\n"
operator|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptDekAdd
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pEncryptCBData
operator|->
name|encryptOperation
operator|==
name|OSSA_HW_ENCRYPT_DEK_INVALIDTE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_ENCRYPT_DEK_INVALIDTE\n"
operator|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptDekInvalidate
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pEncryptCBData
operator|->
name|encryptOperation
operator|==
name|OSSA_HW_ENCRYPT_OPERATOR_MANAGEMENT
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_ENCRYPT_OPERATOR_MANAGEMENT\n"
operator|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptOperatorManagement
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pEncryptCBData
operator|->
name|encryptOperation
operator|==
name|OSSA_HW_ENCRYPT_TEST_EXECUTE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_ENCRYPT_TEST_EXECUTE\n"
operator|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptSelfTest
expr_stmt|;
name|encryptEventData
operator|.
name|subEvent
operator|=
name|pEncryptCBData
operator|->
name|eq
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: unknown encryptOperation 0x%x\n"
operator|,
name|pEncryptCBData
operator|->
name|encryptOperation
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pEncryptCBData
operator|->
name|status
operator|!=
name|OSSA_SUCCESS
condition|)
block|{
name|encryptStatus
operator|=
name|tiError
expr_stmt|;
comment|/* prints out status and error qualifier */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: encrypt response status 0x%x error qualifier 0x%x\n"
operator|,
name|pEncryptCBData
operator|->
name|status
operator|,
name|pEncryptCBData
operator|->
name|eq
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|encryptStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
if|if
condition|(
name|pEncryptCBData
operator|->
name|encryptOperation
operator|==
name|OSSA_HW_ENCRYPT_KEK_UPDATE_AND_STORE
operator|||
name|pEncryptCBData
operator|->
name|encryptOperation
operator|==
name|OSSA_HW_ENCRYPT_KEK_UPDATE
condition|)
block|{
comment|/* returning new KEK index */
name|encryptEventData
operator|.
name|pData
operator|=
name|pEncryptCBData
operator|->
name|handle
expr_stmt|;
block|}
else|else
block|{
comment|/* returning current KEK index or DEK index */
name|encryptEventData
operator|.
name|pData
operator|=
name|pEncryptCBData
operator|->
name|param
expr_stmt|;
block|}
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiEncryptOperation
argument_list|,
name|encryptStatus
argument_list|,
operator|&
name|encryptEventData
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_SECURITY_MODE
case|:
block|{
name|securitySetModeStatus
operator|=
name|eventParm1
expr_stmt|;
name|pEncryptInfo
operator|=
operator|(
name|agsaEncryptInfo_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_SECURITY_MODE\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|securitySetModeStatus
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|securityModeStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
else|else
block|{
name|securityModeStatus
operator|=
name|tiError
expr_stmt|;
block|}
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptSetMode
expr_stmt|;
comment|/* process status to fill in subevent */
comment|/* See PM 4.26.12.6 */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: pEncryptInfo->status 0x%x\n"
operator|,
name|pEncryptInfo
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pEncryptInfo
operator|->
name|status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|encryptEventData
operator|.
name|subEvent
operator|=
name|tiNVRAMSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pEncryptInfo
operator|->
name|status
operator|==
literal|0x24
condition|)
block|{
name|encryptEventData
operator|.
name|subEvent
operator|=
name|tiNVRAMNotFound
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pEncryptInfo
operator|->
name|status
operator|==
literal|0x05
operator|||
name|pEncryptInfo
operator|->
name|status
operator|==
literal|0x20
operator|||
name|pEncryptInfo
operator|->
name|status
operator|==
literal|0x21
condition|)
block|{
name|encryptEventData
operator|.
name|subEvent
operator|=
name|tiNVRAMAccessTimeout
expr_stmt|;
block|}
else|else
block|{
name|encryptEventData
operator|.
name|subEvent
operator|=
name|tiNVRAMWriteFail
expr_stmt|;
block|}
name|encryptEventData
operator|.
name|pData
operator|=
name|agNULL
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiEncryptOperation
argument_list|,
name|securityModeStatus
argument_list|,
operator|&
name|encryptEventData
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_MODE
case|:
block|{
name|pModeEvent
operator|=
operator|(
name|agsaHWEventMode_t
operator|*
operator|)
name|eventParm2
expr_stmt|;
name|pModePage
operator|=
operator|(
name|bit32
operator|*
operator|)
name|pModeEvent
operator|->
name|modePage
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_MODE modePageOperation 0x%x status 0x%x modePageLen 0x%x\n"
operator|,
name|pModeEvent
operator|->
name|modePageOperation
operator|,
name|pModeEvent
operator|->
name|status
operator|,
name|pModeEvent
operator|->
name|modePageLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pModeEvent
operator|->
name|modePageOperation
operator|==
name|agsaModePageSet
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_MODE page code 0x%x error qualifier 0x%x\n"
operator|,
operator|(
name|eventParm1
operator|&
literal|0xFF
operator|)
operator|,
operator|(
name|eventParm1
operator|>>
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiModePageOperation
argument_list|,
name|pModeEvent
operator|->
name|status
argument_list|,
name|eventParm2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pModeEvent
operator|->
name|modePageOperation
operator|==
name|agsaModePageGet
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_MODE error qualifier 0x%x\n"
operator|,
name|eventParm1
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
operator|*
name|pModePage
operator|)
operator|&
literal|0xFF
condition|)
block|{
case|case
name|AGSA_ENCRYPTION_GENERAL_CONFIG_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: AGSA_ENCRYPTION_GENERAL_CONFIG_PAGE 0x%x %p\n"
operator|,
name|pModeEvent
operator|->
name|status
operator|,
name|eventParm2
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB:modePageOperation 0x%x status 0x%x modePageLen 0x%x modePage %p context %p\n"
operator|,
name|pModeEvent
operator|->
name|modePageOperation
operator|,
name|pModeEvent
operator|->
name|status
operator|,
name|pModeEvent
operator|->
name|modePageLen
operator|,
name|pModeEvent
operator|->
name|modePage
operator|,
name|pModeEvent
operator|->
name|context
operator|)
argument_list|)
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiModePageOperation
argument_list|,
name|pModeEvent
operator|->
name|status
argument_list|,
name|eventParm2
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_ENCRYPTION_DEK_CONFIG_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: AGSA_ENCRYPTION_DEK_CONFIG_PAGE 0x%x %p\n"
operator|,
name|pModeEvent
operator|->
name|status
operator|,
name|eventParm2
operator|)
argument_list|)
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiModePageOperation
argument_list|,
name|pModeEvent
operator|->
name|status
argument_list|,
name|eventParm2
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_ENCRYPTION_HMAC_CONFIG_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: AGSA_ENCRYPTION_HMAC_CONFIG_PAGE 0x%x %p\n"
operator|,
name|pModeEvent
operator|->
name|status
operator|,
name|eventParm2
operator|)
argument_list|)
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiModePageOperation
argument_list|,
name|pModeEvent
operator|->
name|status
argument_list|,
name|eventParm2
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_ENCRYPTION_CONTROL_PARM_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: AGSA_ENCRYPTION_CONTROL_PARM_PAGE 0x%x %p\n"
operator|,
name|pModeEvent
operator|->
name|status
operator|,
name|eventParm2
operator|)
argument_list|)
expr_stmt|;
comment|/*          * This page is directly related to tiCOMEncryptGetInfo() and          * will be translated into a tiEncrytOperation for the OS layer.          */
comment|/* Fill out tiEncryptInfo_t */
name|securityMode
operator|=
operator|*
name|pModePage
operator|&
literal|0x0F00
operator|>>
literal|8
expr_stmt|;
name|cipherMode
operator|=
operator|*
name|pModePage
operator|&
literal|0xF000
operator|>>
literal|12
expr_stmt|;
if|if
condition|(
name|securityMode
operator|==
name|agsaEncryptSMA
condition|)
block|{
name|encryptInfo
operator|.
name|securityCipherMode
operator|=
name|TI_ENCRYPT_SEC_MODE_A
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|securityMode
operator|==
name|agsaEncryptSMB
condition|)
block|{
name|encryptInfo
operator|.
name|securityCipherMode
operator|=
name|TI_ENCRYPT_SEC_MODE_B
expr_stmt|;
block|}
else|else
block|{
name|encryptInfo
operator|.
name|securityCipherMode
operator|=
name|TI_ENCRYPT_SEC_MODE_FACT_INIT
expr_stmt|;
block|}
if|if
condition|(
name|cipherMode
operator|==
name|agsaEncryptCipherModeECB
condition|)
block|{
name|encryptInfo
operator|.
name|securityCipherMode
operator||=
name|TI_ENCRYPT_ATTRIB_CIPHER_ECB
expr_stmt|;
block|}
if|if
condition|(
name|cipherMode
operator|==
name|agsaEncryptCipherModeXTS
condition|)
block|{
name|encryptInfo
operator|.
name|securityCipherMode
operator||=
name|TI_ENCRYPT_ATTRIB_CIPHER_XTS
expr_stmt|;
block|}
comment|/* How will subEvents be tracked? */
name|encryptInfo
operator|.
name|status
operator|=
literal|0
expr_stmt|;
name|encryptInfo
operator|.
name|sectorSize
index|[
literal|0
index|]
operator|=
literal|512
expr_stmt|;
comment|/* DIF is allowed on 512 BPS SATA drives */
name|encryptInfo
operator|.
name|sectorSize
index|[
literal|1
index|]
operator|=
literal|520
expr_stmt|;
name|encryptInfo
operator|.
name|sectorSize
index|[
literal|2
index|]
operator|=
literal|528
expr_stmt|;
name|encryptInfo
operator|.
name|sectorSize
index|[
literal|3
index|]
operator|=
literal|4104
expr_stmt|;
name|encryptInfo
operator|.
name|sectorSize
index|[
literal|4
index|]
operator|=
literal|4168
expr_stmt|;
name|encryptInfo
operator|.
name|sectorSize
index|[
literal|5
index|]
operator|=
literal|4232
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptGetInfo
expr_stmt|;
name|encryptEventData
operator|.
name|subEvent
operator|=
literal|0
expr_stmt|;
name|encryptEventData
operator|.
name|pData
operator|=
operator|&
name|encryptInfo
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiEncryptOperation
argument_list|,
name|pModeEvent
operator|->
name|status
argument_list|,
operator|&
name|encryptEventData
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_SAS_PROTOCOL_TIMER_CONFIG_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: AGSA_SAS_PROTOCOL_TIMER_CONFIG_PAGE 0x%x %p\n"
operator|,
name|pModeEvent
operator|->
name|status
operator|,
name|eventParm2
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IOCTL_INTERRUPT_TIME_CONFIG
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiModePageOperation
argument_list|,
name|pModeEvent
operator|->
name|status
argument_list|,
name|eventParm2
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IOCTL_INTERRUPT_TIME_CONFIG */
comment|/*ostiPortEvent(tiRoot,                     tiModePageOperation,                     pModeEvent->status,&encryptEventData);*/
break|break;
case|case
name|AGSA_INTERRUPT_CONFIGURATION_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: AGSA_INTERRUPT_CONFIGURATION_PAGE 0x%x %p\n"
operator|,
name|pModeEvent
operator|->
name|status
operator|,
name|eventParm2
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IOCTL_INTERRUPT_TIME_CONFIG
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiModePageOperation
argument_list|,
name|pModeEvent
operator|->
name|status
argument_list|,
name|eventParm2
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IOCTL_INTERRUPT_TIME_CONFIG */
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Unknown Mode Event %x\n"
operator|,
operator|*
name|pModePage
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: Unknown modePageOperation %x\n"
operator|,
name|pModeEvent
operator|->
name|modePageOperation
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
comment|// #endif  /* INITIATOR_DRIVER */
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_HW_EVENT_PHY_UNRECOVERABLE_ERROR
case|:
block|{
name|PhyID
operator|=
name|TD_GET_PHY_ID
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|PortState
operator|=
name|TD_GET_PORT_STATE
argument_list|(
name|eventParm1
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_PHY_UNRECOVERABLE_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PortState
operator|==
name|OSSA_PORT_INVALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: INVALID port state\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: VALID port state\n"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* REMOVED */
case|case
name|OSSA_HW_EVENT_OPEN_RETRY_BACKOFF_THR_ADJUSTED
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: OSSA_HW_EVENT_OPEN_RETRY_BACKOFF_THR_ADJUSTED\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwCB: default error (0x%X)!!!!!\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'R'
argument_list|,
literal|"Y2"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ossaPortControlCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|bit32
name|portOperation
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaPortControlCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Y3"
argument_list|)
expr_stmt|;
if|if
condition|(
name|portOperation
operator|==
name|AGSA_PORT_SET_SMP_PHY_WIDTH
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaPortControlCB: portOperation AGSA_PORT_SET_SMP_PHY_WIDTH\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|portOperation
operator|==
name|AGSA_PORT_SET_PORT_RECOVERY_TIME
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaPortControlCB: portOperation AGSA_PORT_SET_PORT_RECOVERY_TIME\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|portOperation
operator|==
name|AGSA_PORT_IO_ABORT
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaPortControlCB: portOperation AGSA_PORT_IO_ABORT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* code is here because disocvery failed        deregister all targets. Then, later call discovery if broacast is seen in ossaDeregisterDeviceHandleCB.     */
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaPortControlCB: onePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* qqqqq deregister all devices */
name|tdsaDeregisterDevicesInPort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|portOperation
operator|==
name|AGSA_PORT_SET_PORT_RESET_TIME
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaPortControlCB: portOperation AGSA_PORT_SET_PORT_RESET_TIME\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|portOperation
operator|==
name|AGSA_PORT_HARD_RESET
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaPortControlCB: portOperation AGSA_PORT_HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|portOperation
operator|==
name|AGSA_PORT_CLEAN_UP
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaPortControlCB: portOperation AGSA_PORT_CLEAN_UP\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|portOperation
operator|==
name|AGSA_STOP_PORT_RECOVERY_TIMER
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaPortControlCB: portOperation AGSA_STOP_PORT_RECOVERY_TIMER\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaPortControlCB: undefined portOperation %d\n"
operator|,
name|portOperation
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaPortControlCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Y3"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  ossaHwRegRead * *  Purpose: This routine is called to read a 32-bit value from the PCI *           registers of the controller * *  \param  agRoot:       Pointer to chip/driver Instance. *  \param  regOffset:    Byte offset to chip register from which to read a 32-bit *                        value. * *  \return:             32-bit value. * *  \note - The scope is shared target and initiator. * *****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|bit32
name|ossaHwRegRead
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|regOffset
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
decl_stmt|;
name|bit32
name|return_value
decl_stmt|;
name|return_value
operator|=
name|ostiChipReadBit32
argument_list|(
name|osData
operator|->
name|tiRoot
argument_list|,
name|regOffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTrace
argument_list|(
name|hpDBG_REGISTERS
argument_list|,
literal|"RR"
argument_list|,
name|regOffset
argument_list|)
expr_stmt|;
comment|/* TP:RR regOffset */
name|smTrace
argument_list|(
name|hpDBG_REGISTERS
argument_list|,
literal|"RV"
argument_list|,
name|return_value
argument_list|)
expr_stmt|;
comment|/* TP:RV value read */
block|}
return|return
operator|(
name|return_value
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  ossaHwRegWrite * *  Purpose: This routine is called to write a 32-bit value to the PCI *           registers of the controller. * *  \param   agRoot:     Pointer to chip/driver Instance. *  \param   regOffset:  Byte offset to chip register to which chipIOValue is *                       written. *  \param   regValue:   32-bit value to write at chipIOOffset in host byte order. * *  \return:             None. * *  \note - The scope is shared target and initiator. * *****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|void
name|ossaHwRegWrite
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|regOffset
parameter_list|,
name|bit32
name|regValue
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
decl_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTrace
argument_list|(
name|hpDBG_REGISTERS
argument_list|,
literal|"RW"
argument_list|,
name|regOffset
argument_list|)
expr_stmt|;
comment|/* TP:RW regOffset */
name|smTrace
argument_list|(
name|hpDBG_REGISTERS
argument_list|,
literal|"VW"
argument_list|,
name|regValue
argument_list|)
expr_stmt|;
comment|/* TP:VW value written */
block|}
name|ostiChipWriteBit32
argument_list|(
name|osData
operator|->
name|tiRoot
argument_list|,
name|regOffset
argument_list|,
name|regValue
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  ossaHwRegReadExt * *  Purpose: This routine is called to read a 32-bit value from a bus-specific *           mapped registers of the controller * *  \param  agRoot:       Pointer to chip/driver Instance. *  \param  regOffset:    Byte offset to chip register from which to read a 32-bit *                        value. * *  \return:             32-bit value. * *  \note - The scope is shared target and initiator. * *****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|bit32
name|ossaHwRegReadExt
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|busBaseNumber
parameter_list|,
name|bit32
name|regOffset
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
decl_stmt|;
name|bit32
name|return_value
decl_stmt|;
name|return_value
operator|=
name|ostiChipReadBit32Ext
argument_list|(
name|osData
operator|->
name|tiRoot
argument_list|,
name|busBaseNumber
argument_list|,
name|regOffset
argument_list|)
expr_stmt|;
comment|/* TI_DBG4(("#_R: 0x%x:0x%x=0x%x\n",busBaseNumber,regOffset,return_value)); */
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTrace
argument_list|(
name|hpDBG_REGISTERS
argument_list|,
literal|"EB"
argument_list|,
name|busBaseNumber
argument_list|)
expr_stmt|;
comment|/* TP:EB EX read busBaseNumber */
name|smTrace
argument_list|(
name|hpDBG_REGISTERS
argument_list|,
literal|"EO"
argument_list|,
name|regOffset
argument_list|)
expr_stmt|;
comment|/* TP:EO regOffset */
name|smTrace
argument_list|(
name|hpDBG_REGISTERS
argument_list|,
literal|"ER"
argument_list|,
name|return_value
argument_list|)
expr_stmt|;
comment|/* TP:ER value read */
block|}
return|return
operator|(
name|return_value
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ossaPCI_TRIGGER
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
decl_stmt|;
name|ostiPCI_TRIGGER
argument_list|(
name|osData
operator|->
name|tiRoot
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  ossaHwRegWriteExt * *  Purpose: This routine is called to write a 32-bit value to a bus specific *           mapped registers of the controller. * *  \param   agRoot:     Pointer to chip/driver Instance. *  \param   regOffset:  Byte offset to chip register to which chipIOValue is *                       written. *  \param   regValue:   32-bit value to write at chipIOOffset in host byte order. * *  \return:             None. * *  \note - The scope is shared target and initiator. * *****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|void
name|ossaHwRegWriteExt
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|busBaseNumber
parameter_list|,
name|bit32
name|regOffset
parameter_list|,
name|bit32
name|regValue
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
decl_stmt|;
name|ostiChipWriteBit32Ext
argument_list|(
name|osData
operator|->
name|tiRoot
argument_list|,
name|busBaseNumber
argument_list|,
name|regOffset
argument_list|,
name|regValue
argument_list|)
expr_stmt|;
comment|/*  TI_DBG4(("#_W: 0x%x:0x%x=0x%x\n",busBaseNumber,regOffset,regValue)); */
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTrace
argument_list|(
name|hpDBG_REGISTERS
argument_list|,
literal|"Eb"
argument_list|,
name|busBaseNumber
argument_list|)
expr_stmt|;
comment|/* TP:Eb Ex Write busBaseNumber */
name|smTrace
argument_list|(
name|hpDBG_REGISTERS
argument_list|,
literal|"Eo"
argument_list|,
name|regOffset
argument_list|)
expr_stmt|;
comment|/* TP:Eo regOffset */
name|smTrace
argument_list|(
name|hpDBG_REGISTERS
argument_list|,
literal|"Ew"
argument_list|,
name|regValue
argument_list|)
expr_stmt|;
comment|/* TP:Ew value written  regValue*/
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|ossaHwRegReadConfig32
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|regOffset
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
decl_stmt|;
name|bit32
name|to_ret
decl_stmt|;
name|to_ret
operator|=
name|ostiChipConfigReadBit32
argument_list|(
name|osData
operator|->
name|tiRoot
argument_list|,
name|regOffset
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaHwRegReadConfig32: regOffset 0x%x returns 0x%x\n"
operator|,
name|regOffset
operator|,
name|to_ret
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|to_ret
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|TD_INT_COALESCE
end_ifdef

begin_function
name|void
name|ossaIntCoalesceInitCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIntCoalesceContext_t
modifier|*
name|agIntCoContext
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
name|osData
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIntCoalesceContext_t
modifier|*
name|tiIntCoalesceCxt
decl_stmt|;
name|tdsaIntCoalesceContext_t
modifier|*
name|tdsaIntCoalCxt
decl_stmt|;
name|tdsaIntCoalesceContext_t
modifier|*
name|tdsaIntCoalCxtHead
init|=
operator|(
name|tdsaIntCoalesceContext_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|IntCoalesce
decl_stmt|;
empty_stmt|;
name|bit32
name|tiStatus
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaIntCoalesceInitCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaIntCoalCxt
operator|=
operator|(
name|tdsaIntCoalesceContext_t
operator|*
operator|)
name|agIntCoContext
operator|->
name|osData
expr_stmt|;
name|tiIntCoalesceCxt
operator|=
name|tdsaIntCoalCxt
operator|->
name|tiIntCoalesceCxt
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|AGSA_RC_SUCCESS
case|:
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
break|break;
case|case
name|AGSA_RC_BUSY
case|:
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
break|break;
case|case
name|AGSA_RC_FAILURE
case|:
name|tiStatus
operator|=
name|tiError
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaIntCoalesceInitCB: unknown status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiError
expr_stmt|;
break|break;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaIntCoalesceInitCB: status %d\n"
operator|,
name|tiStatus
operator|)
argument_list|)
expr_stmt|;
comment|/* enqueue tdsaIntCoalCxt to freelink */
name|tdsaIntCoalCxt
operator|->
name|tiIntCoalesceCxt
operator|=
name|agNULL
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaIntCoalesceInitCB: id %d\n"
operator|,
name|tdsaIntCoalCxt
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_INTCOAL_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|tdsaIntCoalCxt
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|tdsaIntCoalCxt
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaIntCoalCxtHead
operator|->
name|FreeLink
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_INTCOAL_LOCK
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OS_INT_COALESCE
name|ostiInitiatorIntCoalesceInitCB
argument_list|(
name|tiRoot
argument_list|,
name|tiIntCoalesceCxt
argument_list|,
name|tiStatus
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaIntCoalesceInitCB: return end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TD_INT_COALESCE */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSingleThreadedEnter  *  *  * Purpose: This routine is called to ensure that only a single thread of  *          the given port instance executes code in the region protected by  *          this function.  *  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   syncLockId    to be explained.  *  *  *  \return None.  *  *  \note - The scope is shared target and initiator.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|void
name|ossaSingleThreadedEnter
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|syncLockId
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|pOsData
init|=
name|agNULL
decl_stmt|;
name|tiRoot_t
modifier|*
name|ptiRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
name|agNULL
decl_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
argument_list|,
literal|"agRoot"
argument_list|)
expr_stmt|;
name|pOsData
operator|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|pOsData
argument_list|,
literal|"pOsData"
argument_list|)
expr_stmt|;
name|ptiRoot
operator|=
name|pOsData
operator|->
name|tiRoot
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|ptiRoot
argument_list|,
literal|"ptiRoot"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
name|pOsData
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
argument_list|,
literal|"tdsaAllShared"
argument_list|)
expr_stmt|;
name|ostiSingleThreadedEnter
argument_list|(
name|ptiRoot
argument_list|,
name|syncLockId
operator|+
name|tdsaAllShared
operator|->
name|MaxNumOSLocks
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSingleThreadedLeave  *  *  *  Purpose: This routine is called to leave a critical region of code  *           previously protected by a call to osSingleThreadedEnter()  *  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   syncLockId    to be explained.  *  *  *  \return None.  *  *  \note - The scope is shared target and initiator.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|void
name|ossaSingleThreadedLeave
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|syncLockId
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|pOsData
init|=
name|agNULL
decl_stmt|;
name|tiRoot_t
modifier|*
name|ptiRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
name|agNULL
decl_stmt|;
name|TD_ASSERT
argument_list|(
name|agRoot
argument_list|,
literal|"agRoot"
argument_list|)
expr_stmt|;
name|pOsData
operator|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|pOsData
argument_list|,
literal|"pOsData"
argument_list|)
expr_stmt|;
name|ptiRoot
operator|=
name|pOsData
operator|->
name|tiRoot
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|ptiRoot
argument_list|,
literal|"ptiRoot"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
name|pOsData
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
argument_list|,
literal|"tdsaAllShared"
argument_list|)
expr_stmt|;
name|ostiSingleThreadedLeave
argument_list|(
name|ptiRoot
argument_list|,
name|syncLockId
operator|+
name|tdsaAllShared
operator|->
name|MaxNumOSLocks
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PERF_COUNT
end_ifdef

begin_function
name|osGLOBAL
name|void
name|ossaEnter
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|int
name|io
parameter_list|)
block|{
name|ostiEnter
argument_list|(
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
operator|)
operator|->
name|tiRoot
argument_list|,
literal|0
argument_list|,
name|io
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ossaLeave
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|int
name|io
parameter_list|)
block|{
name|ostiLeave
argument_list|(
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
operator|)
operator|->
name|tiRoot
argument_list|,
literal|0
argument_list|,
name|io
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|osGLOBAL
name|void
name|ossaSSPIoctlCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit16
name|sspTag
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSSPInitiatorRequest_t
modifier|*
name|agSSPFrame
init|=
name|agNULL
decl_stmt|;
name|bit8
name|scsiOpcode
init|=
literal|0
decl_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspInitiatorReq
operator|)
expr_stmt|;
name|scsiOpcode
operator|=
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|0
index|]
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPIoctlCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPIoctlCompleted: Success status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPIoctlCompleted: Status 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|scsiOpcode
condition|)
block|{
case|case
name|REPORT_LUN_OPCODE
case|:
name|ostiNumOfLUNIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|agIOStatus
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPIoctlCompleted: Unsupported SCSI command Response  0x%x\n"
operator|,
name|scsiOpcode
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yi"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ossaSMPIoctlCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPIoctlCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPIoctlCompleted: Success status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPIoctlCompleted: Status 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiSendSMPIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|agIOStatus
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yi"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSMPCompleted  *  *  *  Purpose: This routine is called by lower layer to indicate the completion of  *           SMP request  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agIORequest   Pointer to SMP request handle  *  \param   agIOStatus    Status  *  \param   agFrameHeader:Pointer to SMP frame header.  *  \param   agIOInfoLen   IO information length assoicated with the IO  *  \param   agFrameHandle A Handle used to refer to the response frame  *  *  *  \return None.  *  *  \note - The scope is shared target and initiator.  *          For details, refer to SAS/SATA Low-Level API Specification  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSMPCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PASSTHROUGH
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdPassthroughCmndBody_t
modifier|*
name|tdPTCmndBody
init|=
operator|(
name|tdPassthroughCmndBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiPassthroughError
decl_stmt|;
name|bit8
name|SMPframe
index|[
name|agIOInfoLen
operator|+
sizeof|sizeof
argument_list|(
name|agsaSMPFrameHeader_t
argument_list|)
index|]
decl_stmt|;
name|bit8
name|SMPpayload
index|[
name|agIOInfoLen
index|]
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPCompleted: start and passthrough\n"
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* not PASSTHROUGH */
name|tdssSMPRequestBody_t
modifier|*
name|pSMPRequestBody
init|=
operator|(
name|tdssSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* end not PASSTHROUGH */
name|TDSA_OUT_ENTER
argument_list|(
operator|(
name|tiRoot_t
operator|*
operator|)
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
operator|)
operator|->
name|tiRoot
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Y4"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PASSTHROUGH
if|if
condition|(
name|tdPTCmndBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCompleted: tdPTCmndBody is NULL \n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Y4"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
if|if
condition|(
name|tdPTCmndBody
operator|->
name|EventCB
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCompleted: tdPTCmndBody->EventCB is NULL \n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"Y4"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiPassthroughSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|tiStatus
operator|=
name|tiPassthroughAborted
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiPassthroughError
expr_stmt|;
block|}
name|osti_memset
argument_list|(
name|SMPpayload
argument_list|,
literal|0
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|SMPframe
argument_list|,
literal|0
argument_list|,
name|agIOInfoLen
operator|+
sizeof|sizeof
argument_list|(
name|agsaSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* combine the header and payload */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
operator|&
name|SMPpayload
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|SMPframe
argument_list|,
name|agFrameHeader
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|SMPframe
operator|+
sizeof|sizeof
argument_list|(
name|agsaSMPFrameHeader_t
argument_list|)
argument_list|,
name|SMPpayload
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
name|tdPTCmndBody
operator|->
name|EventCB
argument_list|(
name|tiRoot
argument_list|,
name|tdPTCmndBody
operator|->
name|tiPassthroughRequest
argument_list|,
name|tiStatus
argument_list|,
name|SMPframe
argument_list|,
name|agIOInfoLen
operator|+
sizeof|sizeof
argument_list|(
name|agsaSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* not PASSTHROUGH */
comment|/*     At initiator, passing SMP to TD layer, itdssSMPCompleted(), which does nothing.     At target, passing SMP to TD layer, ttdsaSMPCompleted()   */
comment|/*      how to use agFrameHandle, when saFrameReadBlock() is used   */
comment|/* SPC can't be SMP target */
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSMPRequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCompleted: pSMPRequestBody is NULL \n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"Y4"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
if|if
condition|(
name|pSMPRequestBody
operator|->
name|SMPCompletionFunc
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCompleted: pSMPRequestBody->SMPCompletionFunc is NULL \n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"Y4"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* debugging */
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPCompleted: agIOrequest %p\n"
operator|,
name|agIORequest
operator|->
name|osData
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPCompleted: sizeof(tdIORequestBody_t) %d 0x%x\n"
operator|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
operator|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPCompleted: SMPRequestbody %p\n"
operator|,
name|pSMPRequestBody
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPCompleted: calling callback fn\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPCompleted: callback fn %p\n"
operator|,
name|pSMPRequestBody
operator|->
name|SMPCompletionFunc
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* TD_INTERNAL_DEBUG */
comment|/*     if initiator, calling itdssSMPCompleted() in itdcb.c     if target,    calling ttdsaSMPCompleted() in ttdsmp.c   */
name|pSMPRequestBody
operator|->
name|SMPCompletionFunc
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Not PASSTHROUGH */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"Y4"
argument_list|)
expr_stmt|;
name|ext
label|:
name|TDSA_OUT_LEAVE
argument_list|(
operator|(
name|tiRoot_t
operator|*
operator|)
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
operator|)
operator|->
name|tiRoot
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ossaSMPReqReceived
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|bit32
name|phyId
parameter_list|)
block|{
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Y5"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Y5"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSMPCAMCompleted  *  *  *  Purpose: This routine is called by lower layer to indicate the completion of  *           SMP request  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agIORequest   Pointer to SMP request handle  *  \param   agIOStatus    Status  *  \param   agIOInfoLen   IO information length assoicated with the IO  *  \param   agFrameHandle A Handle used to refer to the response frame  *  *  *  \return None.  *  *  \note - The scope is shared target and initiator.  *          For details, refer to SAS/SATA Low-Level API Specification  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSMPCAMCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdSMPRequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|context
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tiSMPStatus_t
name|status
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|bit32
modifier|*
name|SMPpayload
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: agIOInfoLen %d\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|agIORequest
operator|->
name|osData
condition|)
block|{
name|TD_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|"ossaSMPCAMCompleted agIORequest->osData"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
name|tdSMPRequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|tdSMPRequestBody
operator|->
name|tiIORequest
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: tdIORequestBody->tiIORequest->osData is null, wrong\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/* allocating agIORequest for SMP Payload itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|SMPpayload
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
name|agIOInfoLen
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
if|if
condition|(
name|SMPpayload
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: ostiAllocMemory returned NULL SMPpayload\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: Success status\n"
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|SMPpayload
argument_list|,
literal|0
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: after memset\n"
operator|)
argument_list|)
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|SMPpayload
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: after read \n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiSMPSuccess
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: SMP Aborted status\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiSMPAborted
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: failed status=%d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|//failed to send smp command, we need to free the memory
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: SMP failed status\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiSMPFailed
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPCAMCompleted: failed status=%d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|//failed to send smp command, we need to free the memory
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorSMPCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|agIOInfoLen
argument_list|,
name|SMPpayload
argument_list|,
name|context
argument_list|)
expr_stmt|;
name|ext
label|:
name|TDSA_OUT_LEAVE
argument_list|(
operator|(
name|tiRoot_t
operator|*
operator|)
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
operator|)
operator|->
name|tiRoot
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSMPReqReceived  *  *  *  Purpose: This routine is called by lower layer to indicate the reception of  *           SMP request  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agDevHandle   Pointer to the device handle of the device  *  \param   agFrameHandle A Handle used to refer to the response frame  *  *  *  \return None.  *  *  \note - The scope is target only  *          For details, refer to SAS/SATA Low-Level API Specification  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSMPReqReceived
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|bit32
name|agFrameLength
parameter_list|,
name|bit32
name|phyId
parameter_list|)
block|{
name|bit8
name|smpHeader
index|[
literal|4
index|]
decl_stmt|;
name|agsaSMPFrameHeader_t
modifier|*
name|agFrameHeader
decl_stmt|;
ifdef|#
directive|ifdef
name|PASSTHROUGH
comment|/* call the registered function(parameter in tiTGTPassthroughCmndRegister() by target */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|Target
init|=
operator|(
name|ttdsaTgt_t
operator|*
operator|)
name|osData
operator|->
name|ttdsaTgt
decl_stmt|;
name|bit8
name|SMPframe
index|[
name|agIOInfoLen
operator|+
sizeof|sizeof
argument_list|(
name|agsaSMPFrameHeader_t
argument_list|)
index|]
decl_stmt|;
name|bit8
name|SMPpayload
index|[
name|agIOInfoLen
index|]
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPReqReceived: start and passthrough\n"
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|SMPpayload
argument_list|,
literal|0
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|SMPframe
argument_list|,
literal|0
argument_list|,
name|agIOInfoLen
operator|+
sizeof|sizeof
argument_list|(
name|agsaSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* combine smp header and payload */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
operator|&
name|SMPpayload
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|SMPframe
argument_list|,
name|agFrameHeader
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|SMPframe
operator|+
sizeof|sizeof
argument_list|(
name|agsaSMPFrameHeader_t
argument_list|)
argument_list|,
name|SMPpayload
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
name|Target
operator|->
name|PasthroughCB
argument_list|(
name|tiRoot
argument_list|,
name|tiSASATA
argument_list|,
name|tiSMP
argument_list|,
name|tiSMPResponse
argument_list|,
name|SMPframe
argument_list|,
name|agIOInfoLen
operator|+
sizeof|sizeof
argument_list|(
name|agsaSMPFrameHeader_t
argument_list|)
argument_list|,
name|phyId
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/*     agDevHandle_t->osData points to tdssDeviceData_t    */
name|tdsaDeviceData_t
modifier|*
name|pDeviceData
init|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
decl_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|agFrameHeader
operator|=
operator|(
name|agsaSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPReqReceived: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* tdtypes.h, calling  ttdsaSMPReqReceived in ttdsmp.c */
name|pDeviceData
operator|->
name|pJumpTable
operator|->
name|pSMPReqReceived
argument_list|(
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
name|agFrameHeader
argument_list|,
name|agFrameHandle
argument_list|,
name|agFrameLength
argument_list|,
name|phyId
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSSPCompleted  *  *  *  Purpose: This routine is called by lower layer to indicate the completion of  *           SSP request  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agIORequest   Pointer to SMP request handle  *  \param   agIOStatus    Status  *  \param   agIOInfoLen   IO information length assoicated with the IO  *  \param   agFrameHandle A Handle used to refer to the response frame  *  *  *  \return None.  *  *  \note - The scope is shared target and initiator.  *          For details, refer to SAS/SATA Low-Level API Specification  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|void
name|ossaSSPCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit16
name|sspTag
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdIORequestBody_t
modifier|*
name|pIORequestBody
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|TDSA_OUT_ENTER
argument_list|(
operator|(
name|tiRoot_t
operator|*
operator|)
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
operator|)
operator|->
name|tiRoot
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2L"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|agIORequest
operator|->
name|osData
condition|)
block|{
name|TD_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|"ossaSSPCompleted agIORequest->osData"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2L"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
name|pIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSSPCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPCompleted: pIORequestBody is NULL \n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2L"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
if|if
condition|(
name|pIORequestBody
operator|->
name|IOCompletionFunc
operator|==
name|agNULL
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tiDeviceHandle
operator|=
name|pIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPCompleted: IOCompletionFunc is NULL \n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPCompleted: did %d \n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2L"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/*      if initiator, calling itdssIOCompleted() in itdcb.c      if initiator, calling itdssTaskCompleted in itdcb.c      if target,    calling ttdsaIOCompleted() in ttdio.c    */
name|pIORequestBody
operator|->
name|IOCompletionFunc
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"2L"
argument_list|)
expr_stmt|;
name|ext
label|:
name|TDSA_OUT_LEAVE
argument_list|(
operator|(
name|tiRoot_t
operator|*
operator|)
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
operator|)
operator|->
name|tiRoot
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|FAST_IO_TEST
end_ifdef

begin_function
name|GLOBAL
name|void
name|ossaFastSSPCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|cbArg
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit16
name|sspTag
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|agsaFastCBBuf_t
modifier|*
name|safb
init|=
operator|(
name|agsaFastCBBuf_t
operator|*
operator|)
name|cbArg
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|scsi_status
decl_stmt|;
name|bit32
name|data_status
decl_stmt|;
name|bit32
name|respLen
decl_stmt|;
name|bit8
name|respData
index|[
literal|128
index|]
decl_stmt|;
name|bit32
name|senseLen
decl_stmt|;
name|agsaSSPResponseInfoUnit_t
name|agSSPRespIU
decl_stmt|;
name|TDSA_OUT_ENTER
argument_list|(
operator|(
name|tiRoot_t
operator|*
operator|)
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
operator|)
operator|->
name|tiRoot
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Y6"
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSSPCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|safb
operator|->
name|cb
operator|==
name|agNULL
operator|||
name|safb
operator|->
name|cbArg
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFastSSPCompleted: pIORequestBody is NULL \n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Y6"
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_SUCCESS
case|:
comment|/* ~ itdssIOSuccessHandler */
if|if
condition|(
operator|(
name|agIOInfoLen
operator|<
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|)
condition|)
block|{
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|OSSA_IO_SUCCESS
operator|,
literal|0
operator|)
expr_stmt|;
break|break;
block|}
comment|/* reads agsaSSPResponseInfoUnit_t */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|agSSPRespIU
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|)
expr_stmt|;
name|data_status
operator|=
name|SA_SSPRESP_GET_DATAPRES
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|scsi_status
operator|=
name|agSSPRespIU
operator|.
name|status
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: scsi_status %d\n"
operator|,
name|scsi_status
operator|)
argument_list|)
expr_stmt|;
comment|/* endianess is invovled here */
name|senseLen
operator|=
name|SA_SSPRESP_GET_SENSEDATALEN
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|respLen
operator|=
name|SA_SSPRESP_GET_RESPONSEDATALEN
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: scsi status=0x%x, senselen=0x%x resplen "
literal|"0x%x\n"
operator|,
name|scsi_status
operator|,
name|senseLen
operator|,
name|respLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|<
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|+
name|senseLen
operator|+
name|respLen
condition|)
block|{
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOFailed
operator|,
name|tiDetailOtherError
operator|)
expr_stmt|;
break|break;
block|}
comment|/* reads response data */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|,
name|respData
argument_list|,
name|respLen
argument_list|)
expr_stmt|;
comment|/* reads sense data */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|+
name|respLen
argument_list|,
name|safb
operator|->
name|pSenseData
argument_list|,
name|senseLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_status
operator|==
literal|0
condition|)
block|{
comment|/* NO_DATA */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaFastSSPCompleted: no data\n"
operator|)
argument_list|)
expr_stmt|;
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOSuccess
operator|,
name|scsi_status
operator|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|data_status
operator|==
literal|1
condition|)
block|{
comment|/* RESPONSE_DATA */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFastSSPCompleted: response data \n"
operator|)
argument_list|)
expr_stmt|;
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOSuccess
operator|,
literal|0
operator|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|data_status
operator|==
literal|2
condition|)
block|{
name|tiSenseData_t
name|senseData
decl_stmt|;
comment|/* SENSE_DATA */
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: sense data \n"
operator|)
argument_list|)
expr_stmt|;
name|senseData
operator|.
name|senseData
operator|=
name|safb
operator|->
name|pSenseData
expr_stmt|;
name|senseData
operator|.
name|senseLen
operator|=
name|MIN
argument_list|(
operator|*
operator|(
name|safb
operator|->
name|senseLen
operator|)
argument_list|,
name|senseLen
argument_list|)
expr_stmt|;
comment|/* when ASC = 0x04 - Log Unit Not Ready,            and ASCQ = 0x11 - Enable Spinup Required:            call saLocalPhyControl to notify spinup */
if|if
condition|(
operator|(
operator|(
name|char
operator|*
operator|)
name|safb
operator|->
name|pSenseData
operator|)
index|[
literal|12
index|]
operator|==
literal|0x04
operator|&&
operator|(
operator|(
name|char
operator|*
operator|)
name|safb
operator|->
name|pSenseData
operator|)
index|[
literal|13
index|]
operator|==
literal|0x11
condition|)
block|{
name|int
name|i
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaFastSSPCompleted: sending notfify spinup\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|safb
operator|->
name|oneDeviceData
operator|)
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_NOTIFY_SPINUP
condition|;
name|i
operator|++
control|)
block|{
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
operator|(
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|safb
operator|->
name|oneDeviceData
operator|)
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_NOTIFY_ENABLE_SPINUP
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|*
operator|(
name|safb
operator|->
name|senseLen
operator|)
operator|>
name|senseData
operator|.
name|senseLen
condition|)
operator|*
operator|(
name|safb
operator|->
name|senseLen
operator|)
operator|=
name|senseData
operator|.
name|senseLen
expr_stmt|;
comment|//       memcpy((void *)safb->pSenseData, senseData.senseData, safb->senseLen);
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOSuccess
operator|,
name|scsi_status
operator|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|data_status
operator|==
literal|3
condition|)
block|{
comment|/* RESERVED */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFastSSPCompleted: reserved wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOFailed
operator|,
name|scsi_status
operator|)
expr_stmt|;
break|break;
block|}
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_OVERFLOW
case|:
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOOverRun
operator|,
name|agIOInfoLen
operator|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* REMOVED */
case|case
name|OSSA_IO_UNDERFLOW
case|:
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOUnderRun
operator|,
name|agIOInfoLen
operator|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORTED
case|:
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOFailed
operator|,
name|tiDetailAborted
operator|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORT_RESET
case|:
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOFailed
operator|,
name|tiDetailAbortReset
operator|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_NO_DEVICE
case|:
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOFailed
operator|,
name|tiDetailNoLogin
operator|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_NON_OPERATIONAL
case|:
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|safb
operator|->
name|oneDeviceData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|saSetDeviceState
argument_list|(
name|oneDeviceData
operator|->
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
comment|/* fall through */
block|}
default|default:
operator|(
operator|(
name|ostiFastSSPCb_t
operator|)
name|safb
operator|->
name|cb
operator|)
operator|(
name|tiRoot
operator|,
name|safb
operator|->
name|cbArg
operator|,
name|tiIOFailed
operator|,
name|tiDetailOtherError
operator|)
expr_stmt|;
break|break;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"Y6"
argument_list|)
expr_stmt|;
name|ext
label|:
name|TDSA_OUT_LEAVE
argument_list|(
operator|(
name|tiRoot_t
operator|*
operator|)
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
operator|)
operator|->
name|tiRoot
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* ossaFastSSPCompleted */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSSPReqReceived  *  *  *  Purpose: This routine is called by lower layer to indicate the reception of  *           SMP request  *  *  \param   agRoot:         Pointer to chip/driver Instance.  *  \param   agDevHandle     Pointer to the device handle of the device  *  \param   agFrameHandle   A Handle used to refer to the response frame  *  \param   agInitiatorTag  the initiator tag  *  \param   agFrameType     SSP frame type  *  *  \return none.  *  *  \note - The scope is target only  *          For details, refer to SAS/SATA Low-Level API Specification  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSSPReqReceived
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|bit16
name|agInitiatorTag
parameter_list|,
name|bit32
name|parameter
parameter_list|,
name|bit32
name|agFrameLen
parameter_list|)
block|{
comment|/*     at target only     uses jumptable, not callback   */
comment|/*     agDevHandle_t->osData points to tdssDeviceData_t   */
name|tdsaDeviceData_t
modifier|*
name|pDeviceData
init|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Y7"
argument_list|)
expr_stmt|;
comment|/* tdtypes.h, calling  ttdsaSSPReqReceived() in ttdio.c */
name|pDeviceData
operator|->
name|pJumpTable
operator|->
name|pSSPReqReceived
argument_list|(
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
name|agFrameHandle
argument_list|,
name|agInitiatorTag
argument_list|,
name|parameter
argument_list|,
name|agFrameLen
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Y7"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaStallThread  *  *  *  Purpose: This routine is called to stall this thread for a number of  *           microseconds.  *  *  *  \param  agRoot:       Pointer to chip/driver Instance.  *  \param   microseconds: Micro second to stall.  *  *  *  \return None.  *  *  \note - The scope is shared target and initiator.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaStallThread
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|microseconds
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|pOsData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|osData
operator|)
decl_stmt|;
name|ostiStallThread
argument_list|(
name|pOsData
operator|->
name|tiRoot
argument_list|,
name|microseconds
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  ossaSSPEvent * *   This routine is called to notify the OS Layer of an event associated with *   SAS port or SAS device * *  \param   agRoot:         Handles for this instance of SAS/SATA hardware *  \param   agIORequest     Pointer to IO request *  \param   event:          event type *  \param   agIOInfoLen:    not in use *  \param   agFrameHandle:  not in use * *  \return: none * *****************************************************************************/
end_comment

begin_comment
comment|/* in case of CMD ACK_NAK timeout, send query task */
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSSPEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|event
parameter_list|,
name|bit16
name|sspTag
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
comment|/*  bit32                       intContext = osData->IntContext; */
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|TMtdIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agTMIORequest
init|=
name|agNULL
decl_stmt|;
comment|/* task management itself */
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSSPScsiTaskMgntReq_t
modifier|*
name|agSSPTaskMgntRequest
decl_stmt|;
name|bit32
name|saStatus
decl_stmt|;
name|bit32
name|agIORequestType
decl_stmt|;
comment|/* type of IO recevied */
name|tiIORequest_t
modifier|*
name|taskTag
decl_stmt|;
comment|/* being task managed one */
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REMOVED
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
decl_stmt|;
endif|#
directive|endif
name|agsaDifDetails_t
name|agDifDetails
decl_stmt|;
name|bit8
name|framePayload
index|[
literal|256
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|bit16
name|frameOffset
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|bit16
name|frameLen
init|=
literal|0
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaSSPEvent: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Y9"
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_ERROR_CMD_ISSUE_ACK_NAK_TIMEOUT
operator|||
name|event
operator|==
name|OSSA_IO_XFER_ERROR_BREAK
operator|||
name|event
operator|==
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
condition|)
block|{
comment|/* IO being task managed(the original IO) depending on event */
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|taskTag
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REMOVED
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|agIORequestType
operator|=
name|tdIORequestBody
operator|->
name|agRequestType
expr_stmt|;
comment|/* error checking; only command is expected here */
if|if
condition|(
name|agIORequestType
operator|==
name|AGSA_REQ_TYPE_UNKNOWN
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: incorrect frame 0x%x. Should be command\n"
operator|,
name|agIORequestType
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Y9"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Allocate memory for query task management */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|TMtdIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"Y9"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|TMtdIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: ostiAllocMemory returned NULL TMIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"Y9"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* setup task management structure */
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
comment|/* TD generates Query Task not OS layer */
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|CurrentTaskTag
operator|=
name|agNULL
expr_stmt|;
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|TaskTag
operator|=
name|taskTag
expr_stmt|;
comment|/* initialize callback function */
name|TMtdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssQueryTaskCompleted
expr_stmt|;
comment|/* initialize tiDevhandle */
name|TMtdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
comment|/* initialize agIORequest */
name|agTMIORequest
operator|=
operator|&
operator|(
name|TMtdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agTMIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|TMtdIORequestBody
expr_stmt|;
name|agTMIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/* request type */
name|agRequestType
operator|=
name|AGSA_SSP_TASK_MGNT_REQ
expr_stmt|;
name|TMtdIORequestBody
operator|->
name|agRequestType
operator|=
name|AGSA_SSP_TASK_MGNT_REQ
expr_stmt|;
comment|/*       initialize       tdIORequestBody_t tdIORequestBody -> agSASRequestBody     */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|TMtdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPTaskMgntRequest
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspTaskMgntReq
operator|)
expr_stmt|;
comment|/* fill up LUN field */
name|osti_memset
argument_list|(
name|agSSPTaskMgntRequest
operator|->
name|lun
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* sets taskMgntFunction field */
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|=
name|AGSA_QUERY_TASK
expr_stmt|;
comment|/* debugging */
if|if
condition|(
name|TMtdIORequestBody
operator|->
name|IOCompletionFunc
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: Error !!! IOCompletionFunc is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* send query task management */
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|agRoot
argument_list|,
name|agTMIORequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
name|agIORequest
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: saSSPStart failed\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|REMOVED
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_ABORTED\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|tdAbortIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_NOT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
name|tdAbortIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_CMD_FRAME_ISSUED
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_XFER_CMD_FRAME_ISSUED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_ERROR_OFFSET_MISMATCH
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_XFER_ERROR_OFFSET_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OVERFLOW
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_OVERFLOW\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     ??? can't call; missing agIOInfoLen     ostiInitiatorIOCompleted (                               tiRoot,                               tdIORequestBody->tiIORequest,                               tiIOOverRun,                               agIOInfoLen,                               agNULL,                               intContext                               );      */
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_ERROR_XFER_RDY_OVERRUN
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: OSSA_IO_XFER_ERROR_XFER_RDY_OVERRUN\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_MISMATCH
operator|||
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
operator|||
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
operator|||
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: DIF related, event 0x%x\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
comment|/* process DIF detail information */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: agIOInfoLen %d\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agParam
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: agParam is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOInfoLen
operator|<
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: wrong agIOInfoLen!!! agIOInfoLen %d sizeof(agsaDifDetails_t) %d\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* reads agsaDifDetails_t */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|agDifDetails
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|frameOffset
operator|=
operator|(
name|agDifDetails
operator|.
name|ErrBoffsetEDataLen
operator|&
literal|0xFFFF
operator|)
expr_stmt|;
endif|#
directive|endif
name|frameLen
operator|=
call|(
name|bit16
call|)
argument_list|(
operator|(
name|agDifDetails
operator|.
name|ErrBoffsetEDataLen
operator|&
literal|0xFFFF0000
operator|)
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: UpperLBA 0x%08x LowerLBA 0x%08x\n"
operator|,
name|agDifDetails
operator|.
name|UpperLBA
operator|,
name|agDifDetails
operator|.
name|LowerLBA
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: SASAddrHI 0x%08x SASAddrLO 0x%08x\n"
operator|,
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|agDifDetails
operator|.
name|sasAddressHi
argument_list|)
operator|,
name|TD_GET_SAS_ADDRESSLO
argument_list|(
name|agDifDetails
operator|.
name|sasAddressLo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: DIF error mask 0x%x Device ID 0x%x\n"
operator|,
operator|(
name|agDifDetails
operator|.
name|DIFErrDevID
operator|)
operator|&
literal|0xFF
operator|,
operator|(
name|agDifDetails
operator|.
name|DIFErrDevID
operator|&
literal|0xFFFF0000
operator|)
operator|>>
literal|16
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|frameLen
operator|!=
literal|0
operator|&&
name|frameLen
operator|<=
literal|256
condition|)
block|{
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
argument_list|,
name|framePayload
argument_list|,
name|frameLen
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"ossaSSPEvent frame"
argument_list|,
name|framePayload
argument_list|,
name|frameLen
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: other event 0x%x\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"Y9"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_function
name|osGLOBAL
name|void
name|ossaSATAIDAbortCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAIDAbortCB: start flag %d status %d\n"
operator|,
name|flag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|tdAbortIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
comment|/*    triggered by tdIDStartTimerCB   */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_function
name|osGLOBAL
name|void
name|ossaSSPAbortCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tiIORequest_t
modifier|*
name|taskTag
init|=
name|agNULL
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Ya"
argument_list|)
expr_stmt|;
name|tdAbortIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: tdAbortIORequestBody is NULL warning!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|flag
operator|==
literal|2
condition|)
block|{
comment|/* abort per port */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: abort per port\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|1
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: abort all\n"
operator|)
argument_list|)
expr_stmt|;
name|tiDeviceHandle
operator|=
operator|(
name|tiDeviceHandle_t
operator|*
operator|)
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: tiDeviceHandle is NULL warning!!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: oneDeviceData is NULL warning!!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NOT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NO_DEVICE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortInProgress
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_IN_PROGRESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_ABORT_IN_PROGRESS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortInProgress
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_DELAYED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_ABORT_DELAYED\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortDelayed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: other status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortInProgress
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|0
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: abort one\n"
operator|)
argument_list|)
expr_stmt|;
name|taskTag
operator|=
name|tdAbortIORequestBody
operator|->
name|tiIOToBeAbortedRequest
expr_stmt|;
if|if
condition|(
name|taskTag
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: taskTag is NULL; triggered by itdssQueryTaskCompleted\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|taskTag
operator|!=
name|agNULL
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortOK
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NOT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|taskTag
operator|!=
name|agNULL
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortFailed
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NO_DEVICE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|taskTag
operator|!=
name|agNULL
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortInProgress
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_IN_PROGRESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_ABORT_IN_PROGRESS\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|taskTag
operator|!=
name|agNULL
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortInProgress
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_DELAYED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_ABORT_DELAYED\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|taskTag
operator|!=
name|agNULL
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortDelayed
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: other status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|taskTag
operator|!=
name|agNULL
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortFailed
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: wrong flag %d\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Ya"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_function
name|osGLOBAL
name|void
name|ossaSSPAbortCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaSSPAbortCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdAbortIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|flag
operator|==
literal|2
condition|)
block|{
comment|/* abort per port */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: abort per port\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|1
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: abort all\n"
operator|)
argument_list|)
expr_stmt|;
name|tiDeviceHandle
operator|=
operator|(
name|tiDeviceHandle_t
operator|*
operator|)
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NOT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NO_DEVICE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_IN_PROGRESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_ABORT_IN_PROGRESS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_DELAYED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_ABORT_DELAYED\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: other status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|0
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: abort one\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NOT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NO_DEVICE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_IN_PROGRESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_ABORT_IN_PROGRESS\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_DELAYED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: OSSA_IO_ABORT_DELAYED\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: other status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPAbortCB: wrong flag %d\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaLocalPhyControlCB  *  *  *  Purpose: This routine is called by lower layer to indicate the status of  *           phy operations  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   phyId         Phy id  *  \param   phyOperation  Operation to be done on the phy  *  \param   status        Phy operation specific completion status  *  \param   parm          Additional parameter, phy operation and status specific  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaLocalPhyControlCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|phyId
parameter_list|,
name|bit32
name|phyOperation
parameter_list|,
name|bit32
name|status
parameter_list|,
name|void
modifier|*
name|parm
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|REMVOED
name|agsaPhyErrCounters_t
modifier|*
name|agPhyErrCounters
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tiIORequest_t
modifier|*
name|currentTaskTag
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|TargetDeviceData
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContextDevice
decl_stmt|;
endif|#
directive|endif
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yb"
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: start phyID %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: phyOperation %d status 0x%x\n"
operator|,
name|phyOperation
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|phyOperation
condition|)
block|{
case|case
name|AGSA_PHY_LINK_RESET
case|:
comment|/* fall through */
case|case
name|AGSA_PHY_HARD_RESET
case|:
if|if
condition|(
name|phyOperation
operator|==
name|AGSA_PHY_LINK_RESET
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: AGSA_PHY_LINK_RESET, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: AGSA_PHY_HARD_RESET, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
if|if
condition|(
name|agContext
operator|!=
name|agNULL
condition|)
block|{
name|currentTaskTag
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|agContext
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
if|if
condition|(
name|currentTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: callback to OS layer with success\n"
operator|)
argument_list|)
expr_stmt|;
name|TargetDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|currentTaskTag
operator|->
name|tdData
expr_stmt|;
name|pSatDevData
operator|=
operator|(
name|satDeviceData_t
operator|*
operator|)
operator|&
operator|(
name|TargetDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
name|agDevHandle
operator|=
name|TargetDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
if|if
condition|(
name|TargetDeviceData
operator|->
name|TRflag
operator|==
name|agTRUE
condition|)
block|{
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|TargetDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
name|TargetDeviceData
operator|->
name|TRflag
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|TargetDeviceData
operator|->
name|tdPortContext
operator|->
name|tiPortalContext
argument_list|,
operator|&
operator|(
name|TargetDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|tiIntrEventTypeTransportRecovery
argument_list|,
name|tiRecOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agDevHandle
operator|=
name|TargetDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: wrong, agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* move this to OSSA_HW_EVENT_PORT_RESET_COMPLETE in ossaHwCB() */
name|agContextDevice
operator|=
operator|&
operator|(
name|TargetDeviceData
operator|->
name|agDeviceResetContext
operator|)
expr_stmt|;
name|agContextDevice
operator|->
name|osData
operator|=
name|currentTaskTag
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMOK
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|currentTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: callback to OS layer with failure\n"
operator|)
argument_list|)
expr_stmt|;
name|TargetDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|currentTaskTag
operator|->
name|tdData
expr_stmt|;
name|pSatDevData
operator|=
operator|(
name|satDeviceData_t
operator|*
operator|)
operator|&
operator|(
name|TargetDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TargetDeviceData
operator|->
name|TRflag
operator|==
name|agTRUE
condition|)
block|{
name|TargetDeviceData
operator|->
name|TRflag
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|TargetDeviceData
operator|->
name|tdPortContext
operator|->
name|tiPortalContext
argument_list|,
operator|&
operator|(
name|TargetDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|tiIntrEventTypeTransportRecovery
argument_list|,
name|tiRecFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
endif|#
directive|endif
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|AGSA_PHY_GET_ERROR_COUNTS
case|:
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: AGSA_PHY_GET_ERROR_COUNTS, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|parm
operator|!=
name|agNULL
condition|)
block|{
name|agPhyErrCounters
operator|=
operator|(
name|agsaPhyErrCounters_t
operator|*
operator|)
name|parm
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: invalidDword %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|invalidDword
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: runningDisparityError %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|runningDisparityError
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: lostOfDwordSynch %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|lossOfDwordSynch
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: phyResetProblem %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|phyResetProblem
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: elasticityBufferOverflow %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|elasticityBufferOverflow
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: receivedErrorPrimitive %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|receivedErrorPrimitive
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|AGSA_PHY_CLEAR_ERROR_COUNTS
case|:
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: AGSA_PHY_CLEAR_ERROR_COUNTS, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|AGSA_PHY_NOTIFY_ENABLE_SPINUP
case|:
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: AGSA_PHY_NOTIFY_ENABLE_SPINUP, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_PHY_BROADCAST_ASYNCH_EVENT
case|:
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: AGSA_PHY_BROADCAST_ASYNCH_EVENT, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tIsSPC12SATA
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: BROADCAST_ASYNCH_EVENT received for SATA Controller\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|AGSA_PHY_COMINIT_OOB
case|:
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: AGSA_PHY_COMINIT_OOB, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: UNKNOWN default case. phyOperation %d status 0x%x\n"
operator|,
name|phyOperation
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yb"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|ossaGetPhyProfileCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|ppc
parameter_list|,
name|bit32
name|phyID
parameter_list|,
name|void
modifier|*
name|parm
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
ifdef|#
directive|ifdef
name|CCFLAGS_PHYCONTROL_COUNTS
name|agsaPhyAnalogSettingsPage_t
modifier|*
name|analog
decl_stmt|;
endif|#
directive|endif
comment|/* CCFLAGS_PHYCONTROL_COUNTS   */
name|tdPhyCount_t
modifier|*
name|PhyBlob
init|=
name|agNULL
decl_stmt|;
name|agsaPhyBWCountersPage_t
modifier|*
name|agBWCounters
decl_stmt|;
name|agsaPhyErrCountersPage_t
modifier|*
name|agPhyErrCounters
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: agContext %p parm %p\n"
operator|,
name|agContext
operator|,
name|parm
operator|)
argument_list|)
expr_stmt|;
comment|/*   if(  tdsaAllShared->tdFWControlEx.inProgress )   {     tdsaAllShared->tdFWControlEx.inProgress = 0;     PhyBlob = (tdPhyCount_t  *)tdsaAllShared->tdFWControlEx.usrAddr;   } */
switch|switch
condition|(
name|ppc
condition|)
block|{
case|case
name|AGSA_SAS_PHY_BW_COUNTERS_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: AGSA_SAS_PHY_BW_COUNTERS_PAGE, status 0x%x phyID %d\n"
operator|,
name|status
operator|,
name|phyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|parm
operator|!=
name|agNULL
condition|)
block|{
name|agBWCounters
operator|=
operator|(
name|agsaPhyBWCountersPage_t
operator|*
operator|)
name|parm
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: RX %d TX %d\n"
operator|,
name|agBWCounters
operator|->
name|RXBWCounter
operator|,
name|agBWCounters
operator|->
name|TXBWCounter
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|PhyBlob
operator|!=
name|agNULL
condition|)
block|{
name|PhyBlob
operator|->
name|InvalidDword
operator|=
literal|0
expr_stmt|;
name|PhyBlob
operator|->
name|runningDisparityError
operator|=
literal|0
expr_stmt|;
name|PhyBlob
operator|->
name|codeViolation
operator|=
literal|0
expr_stmt|;
name|PhyBlob
operator|->
name|phyResetProblem
operator|=
literal|0
expr_stmt|;
name|PhyBlob
operator|->
name|inboundCRCError
operator|=
literal|0
expr_stmt|;
name|PhyBlob
operator|->
name|BW_rx
operator|=
name|agBWCounters
operator|->
name|RXBWCounter
expr_stmt|;
name|PhyBlob
operator|->
name|BW_tx
operator|=
name|agBWCounters
operator|->
name|TXBWCounter
expr_stmt|;
block|}
block|}
break|break;
case|case
name|AGSA_SAS_PHY_ERR_COUNTERS_PAGE
case|:
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
condition|)
block|{
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|PhyBlob
operator|=
operator|(
name|tdPhyCount_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: AGSA_SAS_PHY_ERR_COUNTERS_PAGE, status 0x%x phyID %d\n"
operator|,
name|status
operator|,
name|phyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|parm
operator|!=
name|agNULL
condition|)
block|{
name|agPhyErrCounters
operator|=
operator|(
name|agsaPhyErrCountersPage_t
operator|*
operator|)
name|parm
expr_stmt|;
if|if
condition|(
name|PhyBlob
operator|!=
name|agNULL
condition|)
block|{
name|PhyBlob
operator|->
name|InvalidDword
operator|=
name|agPhyErrCounters
operator|->
name|invalidDword
expr_stmt|;
name|PhyBlob
operator|->
name|runningDisparityError
operator|=
name|agPhyErrCounters
operator|->
name|runningDisparityError
expr_stmt|;
name|PhyBlob
operator|->
name|LossOfSyncDW
operator|=
name|agPhyErrCounters
operator|->
name|lossOfDwordSynch
expr_stmt|;
name|PhyBlob
operator|->
name|codeViolation
operator|=
name|agPhyErrCounters
operator|->
name|codeViolation
expr_stmt|;
name|PhyBlob
operator|->
name|phyResetProblem
operator|=
name|agPhyErrCounters
operator|->
name|phyResetProblem
expr_stmt|;
name|PhyBlob
operator|->
name|inboundCRCError
operator|=
name|agPhyErrCounters
operator|->
name|inboundCRCError
expr_stmt|;
name|PhyBlob
operator|->
name|BW_rx
operator|=
literal|0
expr_stmt|;
name|PhyBlob
operator|->
name|BW_tx
operator|=
literal|0
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: invalidDword          %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|invalidDword
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: runningDisparityError %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|runningDisparityError
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: lostOfDwordSynch      %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|lossOfDwordSynch
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: phyResetProblem       %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|phyResetProblem
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: inboundCRCError       %d\n"
operator|,
name|agPhyErrCounters
operator|->
name|inboundCRCError
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|AGSA_SAS_PHY_ERR_COUNTERS_CLR_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: AGSA_SAS_PHY_ERR_COUNTERS_CLR_PAGE status 0x%x phyID %d\n"
operator|,
name|status
operator|,
name|phyID
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB:AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE status 0x%x phyID %d\n"
operator|,
name|status
operator|,
name|phyID
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CCFLAGS_PHYCONTROL_COUNTS
if|if
condition|(
name|parm
operator|!=
name|agNULL
condition|)
block|{
name|analog
operator|=
operator|(
name|agsaPhyAnalogSettingsPage_t
operator|*
operator|)
name|parm
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x\n"
operator|,
name|analog
operator|->
name|Dword0
operator|,
name|analog
operator|->
name|Dword1
operator|,
name|analog
operator|->
name|Dword2
operator|,
name|analog
operator|->
name|Dword3
operator|,
name|analog
operator|->
name|Dword4
operator|,
name|analog
operator|->
name|Dword5
operator|,
name|analog
operator|->
name|Dword6
operator|,
name|analog
operator|->
name|Dword7
operator|,
name|analog
operator|->
name|Dword8
operator|,
name|analog
operator|->
name|Dword9
operator|)
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|analog
index|[
name|phyID
index|]
operator|.
name|spaRegister0
operator|=
name|analog
operator|->
name|Dword0
expr_stmt|;
name|tdsaAllShared
operator|->
name|analog
index|[
name|phyID
index|]
operator|.
name|spaRegister1
operator|=
name|analog
operator|->
name|Dword1
expr_stmt|;
name|tdsaAllShared
operator|->
name|analog
index|[
name|phyID
index|]
operator|.
name|spaRegister2
operator|=
name|analog
operator|->
name|Dword2
expr_stmt|;
name|tdsaAllShared
operator|->
name|analog
index|[
name|phyID
index|]
operator|.
name|spaRegister3
operator|=
name|analog
operator|->
name|Dword3
expr_stmt|;
name|tdsaAllShared
operator|->
name|analog
index|[
name|phyID
index|]
operator|.
name|spaRegister4
operator|=
name|analog
operator|->
name|Dword4
expr_stmt|;
name|saSetPhyProfile
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|)
argument_list|,
name|AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaPhyAnalogSetupRegisters_t
argument_list|)
argument_list|,
operator|&
name|tdsaAllShared
operator|->
name|analog
index|[
name|phyID
index|]
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CCFLAGS_PHYCONTROL_COUNTS   */
break|break;
case|case
name|AGSA_SAS_PHY_OPEN_REJECT_RETRY_BACKOFF_THRESHOLD_PAGE
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB:AGSA_SAS_PHY_OPEN_REJECT_RETRY_BACKOFF_THRESHOLD_PAGE status 0x%x phyID %d\n"
operator|,
name|status
operator|,
name|phyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|parm
operator|!=
name|agNULL
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaSASPhyOpenRejectRetryBackOffThresholdPage_t
modifier|*
name|Backoff
init|=
operator|(
name|agsaSASPhyOpenRejectRetryBackOffThresholdPage_t
operator|*
operator|)
name|parm
decl_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: DW0 0x%X DW1 0x%X DW2 0x%X DW3 0x%X\n"
operator|,
name|Backoff
operator|->
name|Dword0
operator|,
name|Backoff
operator|->
name|Dword1
operator|,
name|Backoff
operator|->
name|Dword2
operator|,
name|Backoff
operator|->
name|Dword3
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|AGSA_SAS_PHY_GENERAL_STATUS_PAGE
case|:
block|{
name|agsaSASPhyGeneralStatusPage_t
modifier|*
name|GenStatus
init|=
name|NULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: AGSA_SAS_PHY_GENERAL_STATUS_PAGE status 0x%x phyID %d\n"
operator|,
name|status
operator|,
name|phyID
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|parm
operator|!=
name|agNULL
condition|)
block|{
name|GenStatus
operator|=
operator|(
name|agsaSASPhyGeneralStatusPage_t
operator|*
operator|)
name|parm
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: "
literal|"AGSA_SAS_PHY_GENERAL_STATUS_PAGE status %d DW0 0x%x DW1 0x%x\n"
operator|,
name|status
operator|,
name|GenStatus
operator|->
name|Dword0
operator|,
name|GenStatus
operator|->
name|Dword1
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiGetPhyGeneralStatusRsp
argument_list|(
name|tiRoot
argument_list|,
name|GenStatus
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
comment|//      break;
return|return ;
block|}
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetPhyProfileCB: UNKNOWN default case. phyOperation %d status 0x%x\n"
operator|,
name|ppc
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ostiGetPhyProfileIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|ossaSetPhyProfileCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|ppc
parameter_list|,
name|bit32
name|phyID
parameter_list|,
name|void
modifier|*
name|parm
parameter_list|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetPhyProfileCB:agContext %p status 0x%x ppc %d phyID %d parm %p\n"
operator|,
name|agContext
operator|,
name|status
operator|,
name|ppc
operator|,
name|phyID
operator|,
name|parm
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGetDeviceHandlesCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saGetDeviceHandles()  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agContext:    Context of the get device handle request originally passed into  *                         saGetDeviceHandles().  *  \param   agPortContext:Pointer to this instance of a port context  *  \param   agDev:        Array containing pointers to the device handles   *  \param   validDevs     Number of valid device handles  *  *  *  \return None.  *  *  \note - The scope is shared target and initiator.  *          For details, refer to SAS/SATA Low-Level API Specification  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaGetDeviceHandlesCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDev
index|[]
parameter_list|,
name|bit32
name|validDevs
parameter_list|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceHandlesCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceHandlesCB: validDevs %d\n"
operator|,
name|validDevs
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yc"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TO_DO
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|validDevs
condition|;
name|i
operator|++
control|)
block|{
name|agDev
index|[
name|i
index|]
expr_stmt|;
block|}
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yc"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGetDeviceInfoCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saGetDeviceInfo()  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agDevHandle:  Handle of the device  *  \param   status:       status  *  \param   agInfo:       Pointer to the structure that describes device information  *  *  *  \return None.  *  *  \note - The scope is shared target and initiator.  *          For details, refer to SAS/SATA Low-Level API Specification  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaGetDeviceInfoCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|status
parameter_list|,
name|void
modifier|*
name|agInfo
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaDeviceInfo_t
modifier|*
name|agDeviceInfo
decl_stmt|;
name|agsaSASDeviceInfo_t
modifier|*
name|agSASDeviceInfo
decl_stmt|;
name|agsaSATADeviceInfo_t
modifier|*
name|agSATADeviceInfo
decl_stmt|;
endif|#
directive|endif
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yd"
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: start agContext %p\n"
operator|,
name|agContext
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|OSSA_DEV_INFO_INVALID_HANDLE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: OSSA_DEV_INFO_INVALID_HANDLE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*ostiGetDeviceInfoIOCTLRsp(tiRoot, status, agNULL);*/
break|break;
case|case
name|OSSA_DEV_INFO_NO_EXTENDED_INFO
case|:
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agDeviceInfo
operator|=
operator|(
name|agsaDeviceInfo_t
operator|*
operator|)
name|agInfo
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: OSSA_DEV_INFO_NO_EXTENDED_INFO\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: sasAddressHi 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: sasAddressLo 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: devType_S_Rate 0x%08x\n"
operator|,
name|agDeviceInfo
operator|->
name|devType_S_Rate
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: firstBurstSize 0x%08x\n"
operator|,
name|agDeviceInfo
operator|->
name|firstBurstSize
operator|)
argument_list|)
expr_stmt|;
comment|/*ostiPortEvent (tiRoot, tiGetDevInfo, tiSuccess,(void *)agContext );*/
comment|/*ostiGetDeviceInfoIOCTLRsp(tiRoot, status, agDeviceInfo);*/
break|break;
case|case
name|OSSA_DEV_INFO_SAS_EXTENDED_INFO
case|:
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agSASDeviceInfo
operator|=
operator|(
name|agsaSASDeviceInfo_t
operator|*
operator|)
name|agInfo
expr_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: OSSA_DEV_INFO_SAS_EXTENDED_INFO\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: sasAddressHi 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|agSASDeviceInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: sasAddressLo 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|agSASDeviceInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: initiator_ssp_stp_smp %d\n"
operator|,
name|agSASDeviceInfo
operator|->
name|initiator_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: target_ssp_stp_smp %d\n"
operator|,
name|agSASDeviceInfo
operator|->
name|target_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: numOfPhys %d\n"
operator|,
name|agSASDeviceInfo
operator|->
name|numOfPhys
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: phyIdentifier %d\n"
operator|,
name|agSASDeviceInfo
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DEV_INFO_SATA_EXTENDED_INFO
case|:
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agSATADeviceInfo
operator|=
operator|(
name|agsaSATADeviceInfo_t
operator|*
operator|)
name|agInfo
expr_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: OSSA_DEV_INFO_SATA_EXTENDED_INFO\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: sasAddressHi 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|agSATADeviceInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: sasAddressLo 0x%08x\n"
operator|,
name|SA_DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|agSATADeviceInfo
operator|->
name|commonDevInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: connection %d\n"
operator|,
name|agSATADeviceInfo
operator|->
name|connection
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: portMultiplierField %d\n"
operator|,
name|agSATADeviceInfo
operator|->
name|portMultiplierField
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: stpPhyIdentifier %d\n"
operator|,
name|agSATADeviceInfo
operator|->
name|stpPhyIdentifier
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdhexdump
argument_list|(
literal|"ossaGetDeviceInfoCB: signature"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|agSATADeviceInfo
operator|->
name|signature
argument_list|,
literal|8
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetDeviceInfoCB: error default case, status is %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yd"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaDeviceRegistrationCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saRegisterNewDevice()  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agContext:    Context of the get device handle request originally  *                         passed into saRegisterNewDevice().  *  \param   status:       status  *  \param   agDevHandle:  Pointer to the assigned device handle for the  *                         registered device.  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaDeviceRegistrationCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|deviceID
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|Indenom
init|=
name|tdsaAllShared
operator|->
name|QueueConfig
operator|.
name|numInboundQueues
decl_stmt|;
name|bit32
name|Outdenom
init|=
name|tdsaAllShared
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agContext
operator|->
name|osData
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|oneDeviceData
operator|->
name|tdPortContext
decl_stmt|;
name|tiPortalContext_t
modifier|*
name|tiPortalContext
init|=
name|onePortContext
operator|->
name|tiPortalContext
decl_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|dmRoot_t
modifier|*
name|dmRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
decl_stmt|;
name|dmPortContext_t
modifier|*
name|dmPortContext
init|=
operator|&
operator|(
name|onePortContext
operator|->
name|dmPortContext
operator|)
decl_stmt|;
name|dmDeviceInfo_t
name|dmDeviceInfo
decl_stmt|;
name|bit32
name|DMstatus
init|=
name|DM_RC_FAILURE
decl_stmt|;
name|bit16
name|ext
init|=
literal|0
decl_stmt|;
name|bit32
name|expanderType
init|=
literal|1
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|FDS_DM
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|FDS_SM
argument_list|)
name|bit32
name|IDstatus
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot_t
modifier|*
name|smRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
decl_stmt|;
name|bit32
name|SMstatus
init|=
name|SM_RC_FAILURE
decl_stmt|;
endif|#
directive|endif
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Ye"
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: start status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: did 0x%x\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: deviceID 0x%x\n"
operator|,
name|deviceID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: agDevHandle %p %p %p\n"
operator|,
name|agDevHandle
operator|,
name|agDevHandle
operator|->
name|osData
operator|,
name|agDevHandle
operator|->
name|sdkData
operator|)
argument_list|)
expr_stmt|;
comment|/* transient period caused by tdssReportRemovals(), device was in the middle     of registration but port is invalidated   */
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_DEFAULT_DEVICE
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: transient, calling saDeregisterDeviceHandle, did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
name|agDevHandle
operator|->
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
if|if
condition|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agFALSE
condition|)
block|{
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_FAILURE_PORT_NOT_VALID_STATE
operator|||
name|status
operator|==
name|OSSA_ERR_PORT_STATE_NOT_VALID
condition|)
block|{
comment|/* do nothing */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: transient, do nothing did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: agDevHandle is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|OSSA_SUCCESS
case|:
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: success\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: Success did %d FW did 0x%x\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|deviceID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: Success pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: agDevHandle is NULL, wrong!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
name|agDevHandle
operator|->
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|InQID
operator|=
name|oneDeviceData
operator|->
name|id
operator|%
name|Indenom
expr_stmt|;
name|oneDeviceData
operator|->
name|OutQID
operator|=
name|oneDeviceData
operator|->
name|id
operator|%
name|Outdenom
expr_stmt|;
name|onePortContext
operator|->
name|RegisteredDevNums
operator|++
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: direct %d STP target %d target_ssp_stp_smp %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|,
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: pid %d registeredNumDevice %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|RegisteredDevNums
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: pid %d Count %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|Count
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
comment|/* if device is an expander, register it to DM */
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: calling dmRegisterDevice\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* set up dmDeviceInfo */
name|osti_memset
argument_list|(
operator|&
name|dmDeviceInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dmDeviceInfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSLO
argument_list|(
operator|&
name|dmDeviceInfo
argument_list|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSHI
argument_list|(
operator|&
name|dmDeviceInfo
argument_list|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
argument_list|)
expr_stmt|;
name|dmDeviceInfo
operator|.
name|initiator_ssp_stp_smp
operator|=
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|dmDeviceInfo
operator|.
name|target_ssp_stp_smp
operator|=
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|dmDeviceInfo
operator|.
name|devType_S_Rate
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
comment|/* setting SMP bit */
name|ext
operator|=
call|(
name|bit16
call|)
argument_list|(
name|ext
operator||
literal|0x100
argument_list|)
expr_stmt|;
name|expanderType
operator|=
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
argument_list|)
expr_stmt|;
name|ext
operator|=
call|(
name|bit16
call|)
argument_list|(
name|ext
operator||
operator|(
name|expanderType
operator|<<
literal|9
operator|)
argument_list|)
expr_stmt|;
comment|/* setting MCN field to 0xF */
name|ext
operator|=
call|(
name|bit16
call|)
argument_list|(
name|ext
operator||
call|(
name|bit16
call|)
argument_list|(
literal|0xF
operator|<<
literal|11
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: directlyAttached ext 0x%x\n"
operator|,
name|ext
operator|)
argument_list|)
expr_stmt|;
name|dmDeviceInfo
operator|.
name|ext
operator|=
name|ext
expr_stmt|;
block|}
name|DMstatus
operator|=
name|dmRegisterDevice
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
operator|&
name|dmDeviceInfo
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMstatus
operator|!=
name|DM_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: dmRegisterDevice failed!!! 0x%x\n"
operator|,
name|DMstatus
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
comment|/* FDS_DM */
ifdef|#
directive|ifdef
name|FDS_SM
comment|/* if device is SATA, register it to SM */
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: calling smRegisterDevice\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|SMstatus
operator|=
name|smRegisterDevice
argument_list|(
name|smRoot
argument_list|,
name|agDevHandle
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
argument_list|,
name|agNULL
argument_list|,
operator|(
name|bit32
operator|)
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satDeviceType
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|ExpDevice
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: oneDeviceData->ExpDevice NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|ExpDevice
operator|->
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: oneDeviceData->ExpDevice->agDevHandle NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SMstatus
operator|=
name|smRegisterDevice
argument_list|(
name|smRoot
argument_list|,
name|agDevHandle
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
argument_list|,
name|oneDeviceData
operator|->
name|ExpDevice
operator|->
name|agDevHandle
argument_list|,
operator|(
name|bit32
operator|)
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satDeviceType
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SMstatus
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: smRegisterDevice failed!!! 0x%x\n"
operator|,
name|DMstatus
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
comment|/* FDS_SM */
comment|/* special case for directly attached targets */
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: directly attached did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SAS_DEVICE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: SAS target\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PortRecoverPhyID
operator|!=
literal|0xFF
condition|)
block|{
name|oneDeviceData
operator|->
name|phyID
operator|=
operator|(
name|bit8
operator|)
name|onePortContext
operator|->
name|PortRecoverPhyID
expr_stmt|;
name|onePortContext
operator|->
name|PortRecoverPhyID
operator|=
literal|0xFF
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: PortRecoverPhyID %d\n"
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* link up and discovery ready event */
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryRdyGiven
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: link up and discovery ready\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: phyID %d pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: tiPortalContext %p\n"
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: onePortContext->tiPortalContext %p\n"
operator|,
name|onePortContext
operator|->
name|tiPortalContext
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryRdyGiven
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|!=
name|ITD_DSTATE_NOT_STARTED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: wrong discovery state 0x%x\n"
operator|,
name|onePortContext
operator|->
name|DiscoveryState
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: abort call\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* abort all followed by deregistration of sas target */
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: SATA target\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agFALSE
condition|)
block|{
ifdef|#
directive|ifdef
name|FDS_SM
comment|/* send identify device data */
name|tdIDStart
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* send identify device data */
name|tdssSubAddSATAToSharedcontext
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: abort call\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* abort all followed by deregistration of sas target */
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
comment|/* behind the expander */
block|{
if|#
directive|if
name|defined
argument_list|(
name|FDS_DM
argument_list|)
operator|&&
name|defined
argument_list|(
name|FDS_SM
argument_list|)
comment|/* send ID to SATA targets          needs go allocate tdIORequestBody_t for smIORequest       */
if|if
condition|(
operator|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
operator|&&
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agFALSE
condition|)
block|{
name|tdIDStart
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
elif|#
directive|elif
name|defined
argument_list|(
name|FDS_DM
argument_list|)
comment|/* worked with DM */
if|if
condition|(
operator|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
operator|&&
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agFALSE
condition|)
block|{
name|IDstatus
operator|=
name|tdsaDiscoveryStartIDDev
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
if|if
condition|(
name|IDstatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* identify device data is not valid */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: fail or busy %d\n"
operator|,
name|IDstatus
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
comment|/* after discovery is finished */
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|ITD_DSTATE_COMPLETED
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: calling new device arrival\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
comment|/* in case registration is finished after discovery is finished */
ifdef|#
directive|ifdef
name|AGTIAPI_CTL
if|if
condition|(
name|tdsaAllShared
operator|->
name|SASConnectTimeLimit
condition|)
name|tdsaCTLSet
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
operator|&&
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agTRUE
condition|)
block|{
comment|/* in case registration is finished after discovery is finished */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|OSSA_FAILURE_OUT_OF_RESOURCE
case|:
comment|/* fall through */
case|case
name|OSSA_ERR_DEVICE_HANDLE_UNAVAILABLE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: OSSA_FAILURE_OUT_OF_RESOURCE or OSSA_ERR_DEVICE_HANDLE_UNAVAILABLE\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
break|break;
case|case
name|OSSA_FAILURE_DEVICE_ALREADY_REGISTERED
case|:
comment|/* fall through */
case|case
name|OSSA_ERR_DEVICE_ALREADY_REGISTERED
case|:
comment|/* do nothing */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: OSSA_FAILURE_DEVICE_ALREADY_REGISTERED or OSSA_ERR_DEVICE_ALREADY_REGISTERED\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_FAILURE_INVALID_PHY_ID
case|:
comment|/* fall through */
case|case
name|OSSA_ERR_PHY_ID_INVALID
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: OSSA_FAILURE_INVALID_PHY_ID or OSSA_ERR_PHY_ID_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
break|break;
case|case
name|OSSA_FAILURE_PHY_ID_ALREADY_REGISTERED
case|:
comment|/* fall through */
case|case
name|OSSA_ERR_PHY_ID_ALREADY_REGISTERED
case|:
comment|/* do nothing */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: OSSA_FAILURE_PHY_ID_ALREADY_REGISTERED or OSSA_ERR_PHY_ID_ALREADY_REGISTERED\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_FAILURE_PORT_ID_OUT_OF_RANGE
case|:
comment|/* fall through */
case|case
name|OSSA_ERR_PORT_INVALID
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: OSSA_FAILURE_PORT_ID_OUT_OF_RANGE or OSSA_ERR_PORT_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
break|break;
case|case
name|OSSA_FAILURE_PORT_NOT_VALID_STATE
case|:
comment|/* fall through */
case|case
name|OSSA_ERR_PORT_STATE_NOT_VALID
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: OSSA_FAILURE_PORT_NOT_VALID_STATE or OSSA_ERR_PORT_STATE_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: did %d pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
comment|/* transient period between link up and link down/port recovery */
name|onePortContext
operator|->
name|Transient
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: retries regisration\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
comment|//temp; setting MCN to tdsaAllShared->MCN
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||
operator|(
name|tdsaAllShared
operator|->
name|MCN
operator|<<
literal|16
operator|)
expr_stmt|;
comment|//end temp
endif|#
directive|endif
name|saRegisterNewDevice
argument_list|(
comment|/* ossaDeviceRegistrationCB */
name|agRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|onePortContext
operator|->
name|agPortContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
operator|&&
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: directly attached SATA, put back into free list\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDeviceDataReInit
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|OSSA_FAILURE_DEVICE_TYPE_NOT_VALID
case|:
comment|/* fall through */
case|case
name|OSSA_ERR_DEVICE_TYPE_NOT_VALID
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: OSSA_FAILURE_DEVICE_TYPE_NOT_VALID or OSSA_ERR_DEVICE_TYPE_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceRegistrationCB: wrong. default status is %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Ye"
argument_list|)
expr_stmt|;
return|return;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaDeregisterDeviceHandleCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saDeregisterDeviceHandle()  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agDevHandle:  Pointer to the assigned device handle for the  *                         registered device.  *  \param   status:       status  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaDeregisterDeviceHandleCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|agsaEventSource_t
modifier|*
name|eventSource
decl_stmt|;
name|bit32
name|HwAckSatus
decl_stmt|;
name|bit32
name|PhyID
decl_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|dmRoot_t
modifier|*
name|dmRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
decl_stmt|;
name|dmPortContext_t
modifier|*
name|dmPortContext
init|=
name|agNULL
decl_stmt|;
name|dmPortInfo_t
name|dmPortInfo
decl_stmt|;
name|bit32
name|DMstatus
init|=
name|DM_RC_FAILURE
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot_t
modifier|*
name|smRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
decl_stmt|;
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yf"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_ERR_DEVICE_HANDLE_INVALID
condition|)
block|{
comment|/* there is no device handle to process */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: OSSA_ERR_DEVICE_HANDLE_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|dmPortContext
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|dmPortContext
operator|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_DEFAULT_DEVICE
operator|&&
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: transient did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: pid %d registeredNumDevice %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|RegisteredDevNums
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|OSSA_SUCCESS
case|:
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: Success\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: onePortContext is NULL, wrong!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* port is going down */
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_DEFAULT_DEVICE
operator|)
condition|)
block|{
comment|/* remove oneDevice from MainLink */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: delete from MainLink\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
if|if
condition|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: did %d calling smDeregisterDevice\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smDeregisterDevice
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|tdsaDeviceDataReInit
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
comment|/* for portcontext */
name|PhyID
operator|=
name|onePortContext
operator|->
name|eventPhyID
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|RegisteredDevNums
operator|--
expr_stmt|;
comment|/*         check if valid in tdsaAllShared and the last registered device in a portcontext;         if so, call saHwEventAck()        */
if|if
condition|(
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|==
name|agTRUE
operator|&&
name|onePortContext
operator|->
name|RegisteredDevNums
operator|==
literal|0
operator|&&
name|PhyID
operator|!=
literal|0xFF
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: calling saHwEventAck\n"
operator|)
argument_list|)
expr_stmt|;
name|eventSource
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|)
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* toggle */
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|=
name|agFALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
if|if
condition|(
name|onePortContext
operator|->
name|UseDM
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: calling dmDestroyPort\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* setup dmPortInfo */
name|PORTINFO_PUT_SAS_REMOTE_ADDRESSLO
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasRemoteAddressLo
argument_list|)
expr_stmt|;
name|PORTINFO_PUT_SAS_REMOTE_ADDRESSHI
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasRemoteAddressHi
argument_list|)
expr_stmt|;
name|PORTINFO_PUT_SAS_LOCAL_ADDRESSLO
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressLo
argument_list|)
expr_stmt|;
name|PORTINFO_PUT_SAS_LOCAL_ADDRESSHI
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressHi
argument_list|)
expr_stmt|;
name|DMstatus
operator|=
name|dmDestroyPort
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
operator|&
name|dmPortInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMstatus
operator|!=
name|DM_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: dmDestroyPort failed!!! 0x%x\n"
operator|,
name|DMstatus
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|tdsaPortContextReInit
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
comment|/*           put all devices belonging to the onePortContext           back to the free link         */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|==
name|NO_ACK
operator|&&
name|onePortContext
operator|->
name|RegisteredDevNums
operator|==
literal|0
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: NO ACK case\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
if|if
condition|(
name|onePortContext
operator|->
name|UseDM
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: calling dmDestroyPort\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* setup dmPortInfo */
name|PORTINFO_PUT_SAS_REMOTE_ADDRESSLO
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasRemoteAddressLo
argument_list|)
expr_stmt|;
name|PORTINFO_PUT_SAS_REMOTE_ADDRESSHI
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasRemoteAddressHi
argument_list|)
expr_stmt|;
name|PORTINFO_PUT_SAS_LOCAL_ADDRESSLO
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressLo
argument_list|)
expr_stmt|;
name|PORTINFO_PUT_SAS_LOCAL_ADDRESSHI
argument_list|(
operator|&
name|dmPortInfo
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressHi
argument_list|)
expr_stmt|;
name|DMstatus
operator|=
name|dmDestroyPort
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
operator|&
name|dmPortInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMstatus
operator|!=
name|DM_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: dmDestroyPort failed!!! 0x%x\n"
operator|,
name|DMstatus
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|tdsaPortContextReInit
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
comment|/*           put all devices belonging to the onePortContext           back to the free link         */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|PhyID
operator|<
name|TD_MAX_NUM_PHYS
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: pid %d eventvalid %d registeredNumDevice %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|,
name|onePortContext
operator|->
name|RegisteredDevNums
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: pid %d registeredNumDevice %d wrong phyid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|RegisteredDevNums
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|PhyID
operator|=
name|onePortContext
operator|->
name|eventPhyID
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: PhyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|RegisteredDevNums
operator|--
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|smDeregisterDevice
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/*         check if valid in tdsaAllShared and the last registered device in a portcontext;         if so, call saHwEventAck()       */
if|if
condition|(
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|==
name|agTRUE
operator|&&
name|onePortContext
operator|->
name|RegisteredDevNums
operator|==
literal|0
operator|&&
name|PhyID
operator|!=
literal|0xFF
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: calling saHwEventAck\n"
operator|)
argument_list|)
expr_stmt|;
name|eventSource
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|)
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* toggle */
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|=
name|agFALSE
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|RegisteredDevNums
operator|==
literal|1
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: all devices have been deregistered except directly attached EXP\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* qqqqq If broadcast has been seen, call incremental discovery*/
if|if
condition|(
name|onePortContext
operator|->
name|DiscFailNSeenBC
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: calling dmDiscover, incremental, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|dmDiscover
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscFailNSeenBC
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: not calling dmDiscover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* qqqqq needs to change discovery state to onePortContext->DMDiscoveryState == dmDiscCompleted              in dmQueryDiscovery              change the discovery state from dmDiscFailed to dmDiscCompleted           */
name|dmResetFailedDiscovery
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
else|else
block|{
if|if
condition|(
name|PhyID
operator|<
name|TD_MAX_NUM_PHYS
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: pid %d eventvalid %d registeredNumDevice %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|,
name|onePortContext
operator|->
name|RegisteredDevNums
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: pid %d registeredNumDevice %d wrong phyid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|RegisteredDevNums
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
case|case
name|OSSA_INVALID_HANDLE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: OSSA_INVALID_HANDLE\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_FAILURE_DEVICE_DIRECT_ATTACH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: OSSA_FAILURE_DEVICE_DIRECT_ATTACH\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|OSSA_ERR_DEVICE_HANDLE_INVALID
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: OSSA_ERR_DEVICE_HANDLE_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_ERR_DEVICE_BUSY
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: OSSA_ERR_DEVICE_BUSY\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeregisterDeviceHandleCB: unknown status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yf"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaDeviceHandleRemovedEvent  *  *  *  Purpose: This routine is called by lower layer to notify the device removal  *  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agDevHandle:  Pointer to the assigned device handle for the  *                         registered device.  *  \param   agPortContext:Pointer to this instance of port context.  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaDeviceHandleRemovedEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|NOT_YET
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
endif|#
directive|endif
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yg"
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceHandleRemovedEvent: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceHandleRemovedEvent: Wrong! oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yg"
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceHandleRemovedEvent: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDeviceHandleRemovedEvent: Wrong! onePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"Yg"
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaDeviceHandleRemovedEvent: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|RegisteredDevNums
operator|--
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceRemoval
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"Yg"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SPC_ENABLE_PROFILE
end_ifdef

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaFwProfileCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saFwProfile()  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agContext:    Context of the operation originally passed  *                         into saFwProfile()  *  \param   status:       status  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaFwProfileCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|len
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaFwProfileCB: start\n"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|AGSA_RC_SUCCESS
case|:
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaFwProfileCB: SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_RC_FAILURE
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwProfileCB: FAIL\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwProfileCB: !!! default, status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|ostiFWProfileIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|status
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaFwFlashUpdateCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saFwFlashUpdate()  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agContext:    Context of the operation originally passed  *                         into saFwFlashUpdate()  *  \param   status:       status  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaFwFlashUpdateCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yh"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|OSSA_FLASH_UPDATE_COMPLETE_PENDING_REBOOT
case|:
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_UPDATE_COMPLETE_PENDING_REBOOT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_FLASH_UPDATE_IN_PROGRESS
case|:
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_UPDATE_IN_PROGRESS\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_FLASH_UPDATE_HDR_ERR
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_UPDATE_HDR_ERR\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_FLASH_UPDATE_OFFSET_ERR
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_UPDATE_OFFSET_ERR\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_FLASH_UPDATE_CRC_ERR
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_UPDATE_CRC_ERR\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_FLASH_UPDATE_LENGTH_ERR
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_UPDATE_LENGTH_ERR\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_FLASH_UPDATE_HW_ERR
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_UPDATE_HW_ERR\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_FLASH_UPDATE_DNLD_NOT_SUPPORTED
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_UPDATE_DNLD_NOT_SUPPORTED\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_FLASH_UPDATE_DISABLED
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_UPDATE_DISABLED\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_FLASH_FWDNLD_DEVICE_UNSUPPORT
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_FWDNLD_DEVICE_UNSUPPORT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_FLASH_UPDATE_HMAC_ERR
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: OSSA_FLASH_UPDATE_HMAC_ERR\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFwFlashUpdateCB: !!! default, status 0x%X\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yh"
argument_list|)
expr_stmt|;
name|ostiCOMMgntIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|ossaFlashExtExecuteCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|command
parameter_list|,
name|agsaFlashExtResponse_t
modifier|*
name|agFlashExtRsp
parameter_list|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaFlashExtExecuteCB: command  0x%X status 0x%X\n"
operator|,
name|command
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGetNVMDResponseCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saGetNVMDCommand()  *  *  \param   agRoot:           Pointer to chip/driver Instance.  *  \param   agContext:        Context of the operation originally passed  *                             into saGetVPDCommand()  *  \param   status:           status  *  \param   indirectPayload:  The value passed in agsaNVMDData_t when  *                             calling saGetNVMDCommand()  *  \param   agInfoLen:        the length of VPD information  *  \param   agFrameHandle:    handler of VPD information  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaGetNVMDResponseCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit8
name|indirectPayload
parameter_list|,
name|bit32
name|agInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetNVMDResponseCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetNVMDResponseCB: agInfoLen %d\n"
operator|,
name|agInfoLen
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yi"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetNVMDResponseCB: Success status\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|indirectPayload
operator|==
literal|0
operator|&&
name|agInfoLen
operator|!=
literal|0
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetNVMDResponseCB: direct\n"
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"ossaGetNVMDResponseCB"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|agFrameHandle
argument_list|,
name|agInfoLen
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetNVMDResponseCB: Status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|indirectPayload
operator|==
literal|0
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetNVMDResponseCB: direct\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetNVMDResponseCB: indirect\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiGetNVMDIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yi"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSetNVMDResponseCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saSetNVMDCommand()  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agContext:    Context of the operation originally passed  *                         into saSetVPDCommand()  *  \param   status:       status  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSetNVMDResponseCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSetNVMDResponseCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yj"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSetNVMDResponseCB: success\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetNVMDResponseCB: fail or undefined staus %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiSetNVMDIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yj"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGetVPDResponseCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saGetVPDCommand()  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agContext:    Context of the operation originally passed  *                         into saGetVPDCommand()  *  \param   status:       status  *  \param   agInfoLen:    the length of VPD information  *  \param   agFrameHandle:handler of VPD information  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaGetVPDResponseCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit8
name|indirectMode
parameter_list|,
name|bit32
name|agInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
name|bit8
name|VPDData
index|[
literal|48
index|]
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetVPDResponseCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yk"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetVPDResponseCB: agInfoLen %d\n"
operator|,
name|agInfoLen
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|VPDData
argument_list|,
literal|0
argument_list|,
literal|48
argument_list|)
expr_stmt|;
comment|/* We can read only in case of Direct */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|VPDData
argument_list|,
name|agInfoLen
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"ossaGetVPDResponseCB"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|VPDData
argument_list|,
name|agInfoLen
argument_list|)
expr_stmt|;
comment|/*       callback osti....     */
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetVPDResponseCB: fail or undefined staus %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yk"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSetVPDResponseCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saSetVPDCommand()  *  *  \param   agRoot:       Pointer to chip/driver Instance.  *  \param   agContext:    Context of the operation originally passed  *                         into saSetVPDCommand()  *  \param   status:       status  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSetVPDResponseCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSetVPDResponseCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSetVPDResponseCB: success\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiCOMMgntVPDSetIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*       callback osti.....     */
ifdef|#
directive|ifdef
name|VPD_TESTING
comment|/* temporary to test saSetVPDCommand() and saGetVPDCommand */
name|tdsaVPDGet
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetVPDResponseCB: fail or undefined staus %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yl"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaEchoCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saEchoCommand()  *  *  \param   agRoot:        Pointer to chip/driver Instance.  *  \param   agContext:     Context of the operation originally passed  *                          into saEchoCommand()  *  \param   echoPayload:   Pointer to the echo payload  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaEchoCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|void
modifier|*
name|echoPayload
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|ECHO_TESTING
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit8
name|payload
index|[
literal|56
index|]
decl_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaEchoCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Ym"
argument_list|)
expr_stmt|;
comment|/* dumping received echo payload is 56 bytes */
name|tdhexdump
argument_list|(
literal|"ossaEchoCB: echoPayload"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|(
name|echoPayload
operator|)
argument_list|,
literal|56
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ECHO_TESTING
comment|/* temporary to test saEchoCommand() */
comment|/* new echo payload */
name|osti_memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|payload
index|[
literal|0
index|]
operator|=
name|gEcho
expr_stmt|;
name|payload
index|[
literal|55
index|]
operator|=
name|gEcho
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaEchoCB: gEcho %d\n"
operator|,
name|gEcho
operator|)
argument_list|)
expr_stmt|;
name|saEchoCommand
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|payload
argument_list|)
expr_stmt|;
if|if
condition|(
name|gEcho
operator|==
literal|0xFF
condition|)
block|{
name|gEcho
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|gEcho
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Ym"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGpioResponseCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saGpioEventSetup(), saGpioPinSetup(), saGpioRead(), or  *           saGpioWrite()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally passed  *                                in.  *  \param   status:              GPIO operation completion status  *  \param   gpioReadValue:       a bit map containing the corresponding  *                                value for each GPIO pin.  *  \param   gpioPinSetupInfo:    Pointer to agsaGpioPinSetupInfo_t structure  *                                describing the GPIO pin setup  *  \param   gpioEventSetupInfo   Pointer to agsaGpioEventSetupInfo_t structure  *                                describing the GPIO event setups  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaGpioResponseCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|gpioReadValue
parameter_list|,
name|agsaGpioPinSetupInfo_t
modifier|*
name|gpioPinSetupInfo
parameter_list|,
name|agsaGpioEventSetupInfo_t
modifier|*
name|gpioEventSetupInfo
parameter_list|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioResponseCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yn"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioResponseCB: Success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* printing gpioReadValue, agsaGpioPinSetupInfo_t and agsaGpioEventSetupInfo_t */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioResponseCB: gpioReadValue 0x%x\n"
operator|,
name|gpioReadValue
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioResponseCB: PinSetupInfo gpioInputEnabled 0x%x\n"
operator|,
name|gpioPinSetupInfo
operator|->
name|gpioInputEnabled
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioResponseCB: PinSetupInfo gpioTypePart1 0x%x\n"
operator|,
name|gpioPinSetupInfo
operator|->
name|gpioTypePart1
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioResponseCB: PinSetupInfo gpioTypePart2 0x%x\n"
operator|,
name|gpioPinSetupInfo
operator|->
name|gpioTypePart2
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioResponseCB: EventSetupInfo gpioEventLevel 0x%x\n"
operator|,
name|gpioEventSetupInfo
operator|->
name|gpioEventLevel
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioResponseCB: EventSetupInfo gpioEventRisingEdge 0x%x\n"
operator|,
name|gpioEventSetupInfo
operator|->
name|gpioEventRisingEdge
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioResponseCB: EventSetupInfo gpioEventFallingEdge 0x%x\n"
operator|,
name|gpioEventSetupInfo
operator|->
name|gpioEventFallingEdge
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGpioResponseCB: Failure\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yn"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGpioEvent  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saGpioEventSetup(), saGpioPinSetup(), saGpioRead(), or  *           saGpioWrite()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   gpioEvent:           a bit map that indicates which GPIO  *                                input pins have generated the event.  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaGpioEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|gpioEvent
parameter_list|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioEvent: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGpioEvent: gpioEvent 0x%x\n"
operator|,
name|gpioEvent
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yo"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yo"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSASDiagExecuteCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saSASDiagExecute()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally passed  *                                in.  *  \param   status:              Diagnostic operation completion status  *  \param   command:             SAS diagnostic command field in agsaSASDiagExecute_t  *                                structure passed in saSASDiagExecute().  *  \param   reportData:          Report Diagnostic Data  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSASDiagExecuteCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|command
parameter_list|,
name|bit32
name|reportData
parameter_list|)
block|{
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yq"
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSASDiagExecuteCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSASDiagExecuteCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSASDiagExecuteCB: command %d\n"
operator|,
name|command
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSASDiagExecuteCB: reportData %d\n"
operator|,
name|reportData
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yq"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSASDiagStartEndCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saSASDiagExecute()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally passed  *                                in.  *  \param   status:              Diagnostic operation completion status  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSASDiagStartEndCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSASDiagStartEndCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSASDiagStartEndCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yr"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yr"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaReconfigSASParamsCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saReconfigSASParams()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally passed  *                                in saReconfigSASParams().  *  \param   status:              saReconfigSASParams() completion status  *  \param   agSASConfig:         Pointer to the data structure agsaSASReconfig_t  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaReconfigSASParamsCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|agsaSASReconfig_t
modifier|*
name|agSASConfig
parameter_list|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaReconfigSASParamsCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|ossaPCIeDiagExecuteCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|command
parameter_list|,
name|agsaPCIeDiagResponse_t
modifier|*
name|resp
parameter_list|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaPCIeDiagExecuteCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaPCIeDiagExecuteCB: ERR_BLKH 0x%X\n"
operator|,
name|resp
operator|->
name|ERR_BLKH
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaPCIeDiagExecuteCB: ERR_BLKL 0x%X\n"
operator|,
name|resp
operator|->
name|ERR_BLKL
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaPCIeDiagExecuteCB: DWord8 0x%X\n"
operator|,
name|resp
operator|->
name|DWord8
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaPCIeDiagExecuteCB: DWord9 0x%X\n"
operator|,
name|resp
operator|->
name|DWord9
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaPCIeDiagExecuteCB: DWord10 0x%X\n"
operator|,
name|resp
operator|->
name|DWord10
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaPCIeDiagExecuteCB: DWord11 0x%X\n"
operator|,
name|resp
operator|->
name|DWord11
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaPCIeDiagExecuteCB: DIF_ERR 0x%X\n"
operator|,
name|resp
operator|->
name|DIF_ERR
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_function
name|GLOBAL
name|void
name|ossaSGpioCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|agsaSGpioReqResponse_t
modifier|*
name|pSgpioResponse
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSGpioCB:  smpFrameType: 0x%02x \n"
operator|,
name|pSgpioResponse
operator|->
name|smpFrameType
operator|)
argument_list|)
expr_stmt|;
comment|// printf("SS:ossaSGpioCB:  smpFrameType: 0x%02x \n", pSgpioResponse->smpFrameType);
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSGpioCB:  function: 0x%02x \n"
operator|,
name|pSgpioResponse
operator|->
name|function
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSGpioCB:  functionResult: 0x%02x \n"
operator|,
name|pSgpioResponse
operator|->
name|functionResult
operator|)
argument_list|)
expr_stmt|;
comment|//printf("SS:ossaSGpioCB:  functionResult: 0x%02x \n", pSgpioResponse->functionResult);
name|tdhexdump
argument_list|(
literal|"ossaSGpioCB Response"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pSgpioResponse
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSGpioReqResponse_t
argument_list|)
argument_list|)
expr_stmt|;
name|ostiSgpioIoctlRsp
argument_list|(
name|tiRoot
argument_list|,
name|pSgpioResponse
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* BIOS */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaLogDebugString  *  *  *  Purpose: This routine is called by lower layer to log.  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   level:               Detail of information desired.  *  \param   string:              Pointer to the character string.  *  \param   ptr1:                First pointer value.  *  \param   ptr2:                Second pointer value.  *  \param   value1:              First 32-bit value related to the specific information.  *  \param   value2:              Second 32-bit value related to the specific information.  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaLogDebugString
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|level
parameter_list|,
name|char
modifier|*
name|string
parameter_list|,
name|void
modifier|*
name|ptr1
parameter_list|,
name|void
modifier|*
name|ptr2
parameter_list|,
name|bit32
name|value1
parameter_list|,
name|bit32
name|value2
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|TIDEBUG_MSG
argument_list|(
name|gLLDebugLevel
argument_list|,
name|level
argument_list|,
operator|(
literal|"%s %p %p %d %d\n"
operator|,
name|string
operator|,
name|ptr1
operator|,
name|ptr2
operator|,
name|value1
operator|,
name|value2
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaHwEventAckCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saHwEventAck(()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally passed  *                                in.  *  \param   status:              Status  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaHwEventAckCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaHwEventAckCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Ys"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|tiSuccess
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaHwEventAckCB: SUCCESS status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwEventAckCB: FAIL status 0x%X\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwEventAckCB: invalid event status bit0 %d\n"
operator|,
name|status
operator|&
literal|0x01
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwEventAckCB: invalid phyid status bit1 %d\n"
operator|,
operator|(
name|status
operator|&
literal|0x02
operator|)
operator|>>
literal|1
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwEventAckCB: invalid portcontext status bit2 %d\n"
operator|,
operator|(
name|status
operator|&
literal|0x04
operator|)
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaHwEventAckCB: invalid param0 status bit3 %d\n"
operator|,
operator|(
name|status
operator|&
literal|0x08
operator|)
operator|>>
literal|3
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Ys"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGetTimeStampCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saGetTimeStamp()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally passed  *                                in.  *  \param   timeStampLower:      The controller lower 32-bit of internal time  *                                stamp associated with event log.  *  \param   timeStampUpper:      The controller upper 32-bit of internal time  *                                stamp associated with event log.  *  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaGetTimeStampCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|timeStampLower
parameter_list|,
name|bit32
name|timeStampUpper
parameter_list|)
block|{
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yt"
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaGetTimeStampCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaGetTimeStampCB: timeStampUpper 0x%x timeStampLower 0x%x\n"
operator|,
name|timeStampUpper
operator|,
name|timeStampLower
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yt"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSMPAbortCB  *  *  *  Purpose: This routine is called by lower layer to corresponding to  *           saSMPAbort()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agIORequest:         This is the agIORequest parameter passed in  *                                saSMPAbort()  *  \param   status:              Status of abort  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaSMPAbortCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPAbortCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPAbortCB: flag %d\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSMPAbortCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yu"
argument_list|)
expr_stmt|;
name|tdAbortIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: tdAbortIORequestBody is NULL warning!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|flag
operator|==
literal|2
condition|)
block|{
comment|/* abort per port */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPAbortCB: abort per port\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|1
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPAbortCB: abort all\n"
operator|)
argument_list|)
expr_stmt|;
name|tiDeviceHandle
operator|=
operator|(
name|tiDeviceHandle_t
operator|*
operator|)
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: tiDeviceHandle is NULL warning!!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: oneDeviceData is NULL warning!!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPAbortCB: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG3
argument_list|(
operator|(
literal|"ossaSMPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NOT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: OSSA_IO_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NO_DEVICE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_IN_PROGRESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: OSSA_IO_ABORT_IN_PROGRESS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_DELAYED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: OSSA_IO_ABORT_DELAYED\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: other status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|0
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPAbortCB: abort one\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSMPAbortCB: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NOT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: OSSA_IO_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NO_DEVICE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_IN_PROGRESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: OSSA_IO_ABORT_IN_PROGRESS\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_DELAYED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: OSSA_IO_ABORT_DELAYED\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: other status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: wrong flag %d\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yu"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGeneralEvent  *  *  *  Purpose: This is the event notification for debugging purposes sent to  *           inform the OS layer of some general error related to a specific  *           inbound operation.  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   status:              Status associated with this event  *  \param   msg:                 Pointer to controller specific command  *                                massage that caused the error  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaGeneralEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|status
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
modifier|*
name|msg
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGeneralEvent: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGeneralEvent: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGeneralEvent: *msg %X\n"
operator|,
operator|*
name|msg
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yv"
argument_list|)
expr_stmt|;
name|ostiGenEventIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yv"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|ossaGetForensicDataCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|agsaForensicData_t
modifier|*
name|forensicData
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|ostiGetForensicDataIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|status
argument_list|,
name|forensicData
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_function
name|GLOBAL
name|void
name|ossaGetIOErrorStatsCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|agsaIOErrorEventStats_t
modifier|*
name|stats
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|ostiGetIoErrorStatsIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|status
argument_list|,
name|stats
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
name|GLOBAL
name|void
name|ossaGetIOErrorStatsCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|agsaIOErrorEventStats_t
modifier|*
name|stats
parameter_list|)
block|{  }
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|GLOBAL
name|void
name|ossaGetIOEventStatsCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|agsaIOErrorEventStats_t
modifier|*
name|stats
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|ostiGetIoEventStatsIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|status
argument_list|,
name|stats
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGetRegisterDumpCB  *  *  *  Purpose: ossaGetRegisterDumpCB() is the response callback function  *           called by the LL Layer to indicate a response to  *           saGetRegisterDump()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally  *                                passed into saGetRegisterDump()  *  \param   status:              status  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaGetRegisterDumpCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaGetRegisterDumpCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaGetRegisterDumpCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Yw"
argument_list|)
expr_stmt|;
name|ostiRegDumpIOCTLRsp
argument_list|(
name|tiRoot
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Yw"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSetDeviceStateCB  *  *  *  Purpose: ossaSetDeviceStateCB() is the response callback function  *           called by the LL Layer to indicate a response to  *           saSetDeviceState()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally  *                                passed into saGetRegisterDump()  *  \param   agDevHandle          Pointer to the device handle of the device  *  \param   status:              status  *  \param   newDeviceState:      newly set device status  *  \param   previousDeviceState: old device status  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaSetDeviceStateCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|newDeviceState
parameter_list|,
name|bit32
name|previousDeviceState
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSetDeviceStateCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSetDeviceStateCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSetDeviceStateCB: newDeviceState %d\n"
operator|,
name|newDeviceState
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSetDeviceStateCB: previousDeviceState %d\n"
operator|,
name|previousDeviceState
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSetDeviceStateCB: agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetDeviceStateCB: wrong; oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSetDeviceStateCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGetDeviceStateCB  *  *  *  Purpose: ossaGetDeviceStateCB() is the response callback function  *           called by the LL Layer to indicate a response to  *           saGetDeviceState()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally  *                                passed into saGetRegisterDump()  *  \param   agDevHandle          Pointer to the device handle of the device  *  \param   status:              status  *  \param   deviceState:         device status  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaGetDeviceStateCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|deviceState
parameter_list|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaGetDeviceStateCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaGetDeviceStateCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaGetDeviceStateCB: deviceState %d\n"
operator|,
name|deviceState
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaIniSetDeviceInfoCB  *  *  *  Purpose: ossaIniSetDeviceInfoCB() is the response callback function  *           called by the LL Layer to indicate a response to  *           saSetDeviceInfo()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally  *                                passed into saSetDeviceInfo()  *  \param   agDevHandle          Pointer to the device handle of the device  *  \param   status:              status  *  \param   option:              option parameter passed in saSetDeviceInfo()  *  \param   param:               param parameter passed in saSetDeviceInfo()  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaIniSetDeviceInfoCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|option
parameter_list|,
name|bit32
name|param
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|bit32
name|saStatus
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|bit8
name|devType_S_Rate
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: option 0x%x\n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: param 0x%x\n"
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|OSSA_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: option 0x%x\n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: param 0x%x\n"
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|option
operator|==
literal|32
condition|)
comment|/* set connection rate */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: IO failure\n"
operator|)
argument_list|)
expr_stmt|;
name|agIORequest
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
name|agContext
operator|->
name|osData
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: wrong; oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* retry IOs */
if|if
condition|(
name|option
operator|==
literal|32
condition|)
comment|/* set connection rate */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: set connection rate option\n"
operator|)
argument_list|)
expr_stmt|;
name|agIORequest
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
name|agContext
operator|->
name|osData
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|devType_S_Rate
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
expr_stmt|;
name|devType_S_Rate
operator|=
operator|(
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator||
operator|(
name|param
operator|>>
literal|28
operator|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
operator|=
name|devType_S_Rate
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: new rate is 0x%x\n"
operator|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|tdIORequestBody
operator|->
name|agRequestType
argument_list|,
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: retried\n"
operator|)
argument_list|)
expr_stmt|;
name|Initiator
operator|->
name|NumIOsActive
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaIniSetDeviceInfoCB: retry failed\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaSetDeviceInfoCB  *  *  *  Purpose: ossaSetDeviceInfoCB() is the response callback function  *           called by the LL Layer to indicate a response to  *           saSetDeviceInfo()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally  *                                passed into saSetDeviceInfo()  *  \param   agDevHandle          Pointer to the device handle of the device  *  \param   status:              status  *  \param   option:              option parameter passed in saSetDeviceInfo()  *  \param   param:               param parameter passed in saSetDeviceInfo()  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaSetDeviceInfoCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|option
parameter_list|,
name|bit32
name|param
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSetDeviceInfoCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSetDeviceInfoCB: status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSetDeviceInfoCB: option 0x%x\n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSetDeviceInfoCB: param 0x%x\n"
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|OSSA_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetDeviceInfoCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetDeviceInfoCB: option 0x%x\n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetDeviceInfoCB: param 0x%x\n"
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSetDeviceInfoCB: agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetDeviceInfoCB: wrong; oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ossaSetDeviceInfoCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaGetDFEDataCB  *  *  *  Purpose: ossaGetDFEDataCB() is the response callback function  *           called by the LL Layer to indicate a response to  *           saGetDFEData()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally  *                                passed into saGetDFEData()  *  \param   status:              status  *  \param   agInfoLen:           length in bytes of DFE data captured and transferred  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaGetDFEDataCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|agInfoLen
parameter_list|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetDFEDataCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetDFEDataCB: status 0x%x agInfoLen 0x%x\n"
operator|,
name|status
operator|,
name|agInfoLen
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief ossaVhistCaptureCB  *  *  *  Purpose: ossaVhistCaptureCB() is the response callback function  *           called by the LL Layer to indicate a response to  *           saGetDFEData()  *  *  \param   agRoot:              Pointer to chip/driver Instance.  *  \param   agContext:           Context of the operation originally  *                                passed into ()  *  \param   status:              status  *  \param   len:           length in bytes of Vis data captured and transferred  *  *  \return None.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|void
name|ossaVhistCaptureCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|len
parameter_list|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaVhistCaptureCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaVhistCaptureCB: status 0x%x agInfoLen 0x%x\n"
operator|,
name|status
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|ossaOperatorManagementCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|eq
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tiEncryptPort_t
name|encryptEventData
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaOperatorManagementCB: status 0x%x eq 0x%x\n"
operator|,
name|status
operator|,
name|eq
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|encryptEventData
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tiEncryptPort_t
argument_list|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptOperatorManagement
expr_stmt|;
name|encryptEventData
operator|.
name|subEvent
operator|=
name|eq
expr_stmt|;
name|encryptEventData
operator|.
name|pData
operator|=
name|agNULL
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiEncryptOperation
argument_list|,
name|status
argument_list|,
operator|&
name|encryptEventData
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|ossaEncryptSelftestExecuteCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|type
parameter_list|,
name|bit32
name|length
parameter_list|,
name|void
modifier|*
name|TestResult
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tiEncryptPort_t
name|encryptEventData
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaEncryptSelftestExecuteCB: status 0x%x type 0x%x length 0x%x\n"
operator|,
name|status
operator|,
name|type
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|encryptEventData
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tiEncryptPort_t
argument_list|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptSelfTest
expr_stmt|;
name|encryptEventData
operator|.
name|subEvent
operator|=
name|type
expr_stmt|;
name|encryptEventData
operator|.
name|pData
operator|=
operator|(
name|void
operator|*
operator|)
name|TestResult
expr_stmt|;
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiEncryptOperation
argument_list|,
name|status
argument_list|,
operator|&
name|encryptEventData
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|ossaGetOperatorCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|option
parameter_list|,
name|bit32
name|num
parameter_list|,
name|bit32
name|role
parameter_list|,
name|agsaID_t
modifier|*
name|id
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tiEncryptPort_t
name|encryptEventData
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetOperatorCB: status 0x%x option 0x%x num 0x%x role 0x%x\n"
operator|,
name|status
operator|,
name|option
operator|,
name|num
operator|,
name|role
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetOperatorCB: agContext %p id %p\n"
operator|,
name|agContext
operator|,
name|id
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|encryptEventData
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tiEncryptPort_t
argument_list|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptGetOperator
expr_stmt|;
name|encryptEventData
operator|.
name|subEvent
operator|=
name|option
expr_stmt|;
name|encryptEventData
operator|.
name|pData
operator|=
name|agNULL
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|OSSA_IO_SUCCESS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetOperatorCB: OSSA_IO_SUCCESS option 0x%x\n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|option
operator|==
literal|1
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetOperatorCB: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|id
operator|->
name|ID
index|[
literal|0
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|1
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|2
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetOperatorCB: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|id
operator|->
name|ID
index|[
literal|4
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|5
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|6
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|7
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetOperatorCB: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|id
operator|->
name|ID
index|[
literal|8
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|9
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|10
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|11
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetOperatorCB: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|id
operator|->
name|ID
index|[
literal|12
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|13
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|14
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|15
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetOperatorCB: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|id
operator|->
name|ID
index|[
literal|16
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|17
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|18
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|19
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetOperatorCB: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|id
operator|->
name|ID
index|[
literal|20
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|21
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|22
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|23
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetOperatorCB: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|id
operator|->
name|ID
index|[
literal|24
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|25
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|26
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|27
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaGetOperatorCB: 0x%02x 0x%02x 0x%02x\n"
operator|,
name|id
operator|->
name|ID
index|[
literal|28
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|29
index|]
operator|,
name|id
operator|->
name|ID
index|[
literal|30
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|option
operator|==
literal|2
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetOperatorCB: number operators 0x%02x\n"
operator|,
name|num
operator|)
argument_list|)
expr_stmt|;
block|}
name|encryptEventData
operator|.
name|pData
operator|=
name|id
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ENC_ERR_UNSUPPORTED_OPTION
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetOperatorCB: OSSA_MPI_ENC_ERR_UNSUPPORTED_OPTION 0x%x\n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ENC_ERR_ID_TRANSFER_FAILURE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetOperatorCB: OSSA_MPI_ENC_ERR_ID_TRANSFER_FAILURE 0x%x\n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetOperatorCB: Unknown status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiEncryptOperation
argument_list|,
name|status
argument_list|,
operator|&
name|encryptEventData
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|ossaSetOperatorCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|eq
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tiEncryptPort_t
name|encryptEventData
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetOperatorCB: agContext %p status 0x%x eq 0x%x\n"
operator|,
name|agContext
operator|,
name|status
operator|,
name|eq
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|encryptEventData
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tiEncryptPort_t
argument_list|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|encryptEvent
operator|=
name|tiEncryptSetOperator
expr_stmt|;
name|encryptEventData
operator|.
name|subEvent
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|OSSA_IO_SUCCESS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetOperatorCB: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
name|encryptEventData
operator|.
name|pData
operator|=
name|agNULL
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ENC_ERR_CONTROLLER_NOT_IDLE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetOperatorCB: OSSA_MPI_ENC_ERR_CONTROLLER_NOT_IDLE\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ENC_OPERATOR_AUTH_FAILURE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetOperatorCB: OSSA_MPI_ENC_OPERATOR_AUTH_FAILURE error qualifier 0x%x\n"
operator|,
name|eq
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ENC_OPERATOR_OPERATOR_ALREADY_LOGGED_IN
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetOperatorCB: OSSA_MPI_ENC_OPERATOR_OPERATOR_ALREADY_LOGGED_IN\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ENC_OPERATOR_ILLEGAL_PARAMETER
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetOperatorCB: OSSA_MPI_ENC_OPERATOR_ILLEGAL_PARAMETER\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ENC_ERR_UNSUPPORTED_OPTION
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetOperatorCB: OSSA_MPI_ENC_ERR_UNSUPPORTED_OPTION\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ENC_ERR_ID_TRANSFER_FAILURE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSetOperatorCB: OSSA_MPI_ENC_ERR_ID_TRANSFER_FAILURE\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaGetOperatorCB: Unknown status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiEncryptOperation
argument_list|,
name|status
argument_list|,
operator|&
name|encryptEventData
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|ossaDIFEncryptionOffloadStartCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|status
parameter_list|,
name|agsaOffloadDifDetails_t
modifier|*
name|agsaOffloadDifDetails
parameter_list|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDIFEncryptionOffloadStartCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDIFEncryptionOffloadStartCB: status 0x%x agsaOffloadDifDetails=%p\n"
operator|,
name|status
operator|,
name|agsaOffloadDifDetails
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|ossaTimeStamp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
name|agNULL
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
name|agNULL
decl_stmt|;
if|if
condition|(
name|agRoot
condition|)
block|{
name|osData
operator|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
expr_stmt|;
block|}
if|if
condition|(
name|osData
condition|)
block|{
name|tiRoot
operator|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
expr_stmt|;
block|}
return|return
operator|(
name|ostiTimeStamp
argument_list|(
name|tiRoot
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit64
name|ossaTimeStamp64
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
name|agNULL
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
name|agNULL
decl_stmt|;
if|if
condition|(
name|agRoot
condition|)
block|{
name|osData
operator|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
expr_stmt|;
block|}
if|if
condition|(
name|osData
condition|)
block|{
name|tiRoot
operator|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
expr_stmt|;
block|}
return|return
operator|(
name|ostiTimeStamp64
argument_list|(
name|tiRoot
argument_list|)
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_function
name|osGLOBAL
name|void
name|tdIDStartTimer
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdIDTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TIMER_LOCK
argument_list|)
expr_stmt|;
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|tdIDTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|tdsaSetTimerRequest
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|tdIDTimer
argument_list|,
name|SATA_ID_DEVICE_DATA_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
argument_list|,
name|tdIDStartTimerCB
argument_list|,
name|smIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|tdsaAddTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|Initiator
operator|->
name|timerlist
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|tdIDTimer
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimer: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tdIDStartTimerCB
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|smIORequest_t
modifier|*
name|smIORequest
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smRoot_t
modifier|*
name|smRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|bit32
name|IDstatus
decl_stmt|;
comment|//#endif
comment|//#ifdef REMOVED
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
endif|#
directive|endif
comment|// REMOVED
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|status
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|timerData2
expr_stmt|;
name|smRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
endif|#
directive|endif
comment|// REMOVED
if|if
condition|(
name|smIORequest
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: smIORequest == agNULL !!!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: oneDeviceData == agNULL !!!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDPending
operator|==
name|agFALSE
operator|||
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agTRUE
condition|)
block|{
comment|/*the Identify Device command already normally completed, just return*/
return|return;
block|}
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|smIORequest
operator|->
name|tdData
expr_stmt|;
name|smDeviceHandle
operator|=
operator|(
name|smDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|tdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: tdIORequestBody == agNULL !!!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: smDeviceHandle == agNULL !!!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: onePortContext == agNULL !!!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/*    1. smIOabort()    2. in tdsmIDCompletedCB(), retry   */
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: invalid device\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|status
operator|=
name|smIOAbort
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|)
expr_stmt|;
else|#
directive|else
name|smIOAbort
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REMOVED
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: ostiAllocMemory failed...; can't retry ID data \n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: ostiAllocMemory returned NULL tdAbortIORequestBody; can't retry ID data\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
comment|/* setting callback but not used later */
name|tdAbortIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|agNULL
expr_stmt|;
comment|//tdAbortIORequestBody->IOCompletionFunc = itdssIOAbortedHandler;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
operator|(
name|tiDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|//#endif
comment|//#ifdef REMOVED
name|status
operator|=
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|1
argument_list|,
comment|/* abort all */
name|agNULL
argument_list|,
name|ossaSATAIDAbortCB
argument_list|)
expr_stmt|;
name|status
operator|=
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|0
argument_list|,
comment|/* abort one */
name|agIORequest
argument_list|,
name|ossaSATAIDAbortCB
argument_list|)
expr_stmt|;
comment|//#endif
comment|//#ifdef REMOVED
if|if
condition|(
name|status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: saSATAAbort failed; can't retry ID data\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: IDDeviceValid is valid, no need to retry\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdIORequestBody
operator|->
name|reTries
operator|<=
name|SM_RETRIES
condition|)
block|{
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|agNULL
expr_stmt|;
comment|/* not in use */
name|tdIORequestBody
operator|->
name|pid
operator|=
name|onePortContext
operator|->
name|id
expr_stmt|;
name|smIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
name|smIORequest
operator|->
name|smData
operator|=
operator|&
name|tdIORequestBody
operator|->
name|smIORequestBody
expr_stmt|;
name|smDeviceHandle
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
name|IDstatus
operator|=
name|smIDStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|IDstatus
operator|==
name|SM_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: being retried!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIDStartTimer
argument_list|(
name|tiRoot
argument_list|,
name|smIORequest
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* identify device data is not valid */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: smIDStart fail or busy %d!!!\n"
operator|,
name|IDstatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
name|smReportRemoval
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
comment|/* give up */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: retries are over!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdIDTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|tdIDTimer
argument_list|)
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SMNumOfID
operator|<=
literal|0
condition|)
comment|/* does SMP HARD RESET only upto one time */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: fail; sending HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SMNumOfID
operator|++
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* given up after one time of SMP HARD RESET; */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: fail; but giving up sending HARD_RESET!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|smReportRemovalDirect
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smReportRemoval
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
comment|// REMOVED
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStartTimerCB: end, smIOAbort status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// FDS_SM
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|FDS_DM
argument_list|)
operator|&&
name|defined
argument_list|(
name|FDS_SM
argument_list|)
end_if

begin_comment
comment|//start here
end_comment

begin_function
name|GLOBAL
name|void
name|tdIDStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|SMstatus
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|smIORequest_t
modifier|*
name|smIORequest
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStart: start, did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
operator|&&
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDPending
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdIDStart: in loop, did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* allocating tdIORequestBody */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
operator|||
name|tdIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStart: ostiAllocMemory failed... or ostiAllocMemory returned NULL tdIORequestBody!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
else|else
block|{
comment|/* initialize */
name|osti_memset
argument_list|(
name|tdIORequestBody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdIDStart: tdIORequestBody %p  tdIORequestBody->osMemHandle %p\n"
operator|,
name|tdIORequestBody
operator|,
name|tdIORequestBody
operator|->
name|osMemHandle
operator|)
argument_list|)
expr_stmt|;
comment|/* not in use */
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|agNULL
expr_stmt|;
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|agNULL
expr_stmt|;
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|agNULL
expr_stmt|;
comment|/* not in use */
name|tdIORequestBody
operator|->
name|pid
operator|=
name|onePortContext
operator|->
name|id
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|smIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|smIORequest
operator|)
expr_stmt|;
name|smIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
name|smIORequest
operator|->
name|smData
operator|=
operator|&
name|tdIORequestBody
operator|->
name|smIORequestBody
expr_stmt|;
name|smDeviceHandle
operator|=
operator|(
name|smDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
expr_stmt|;
name|smDeviceHandle
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdIDStart: smIORequest %p\n"
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|SMstatus
operator|=
name|smIDStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SMstatus
operator|==
name|SM_RC_SUCCESS
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdIDStart: successfully sent identify device data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Add the devicedata to the mainlink */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdIDStart: one case did %d \n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDPending
operator|=
name|agTRUE
expr_stmt|;
comment|/* start a timer */
name|tdIDStartTimer
argument_list|(
name|tiRoot
argument_list|,
name|smIORequest
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* failed to send  */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStart: smIDStart fail or busy %d\n"
operator|,
name|SMstatus
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStart: failed in sending identify device data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* put onedevicedata back to free list */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|smReportRemoval
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdIDStart: exit\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SALLSDK_OS_IOMB_LOG_ENABLE
end_ifdef

begin_function
name|GLOBAL
name|void
name|ossaLogIomb
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|queueNum
parameter_list|,
name|agBOOLEAN
name|isInbound
parameter_list|,
name|void
modifier|*
name|pMsg
parameter_list|,
name|bit32
name|msgLength
parameter_list|)
block|{
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SALLSDK_OS_IOMB_LOG_ENABLE */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|SATA_ENABLE
end_ifndef

begin_comment
comment|/*  * These callback routines are defined in ossasat.c which are included in the  * compilation if SATA_ENABLED is defined.  */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief ossaDiscoverSataCB * *  Purpose:  This function is called by lower layer to inform TD layer of *            STP/SATA discovery results * * *  \param   agRoot         Pointer to chip/driver Instance. *  \param   agPortContext  Pointer to the port context of TD and Lower layer *  \param   event          event type *  \param   pParm1         Pointer to data associated with event *  \param   pParm2         Pointer to data associated with event * *  \return: none * *  \note -  For details, refer to SAS/SATA Low-Level API Specification * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaDiscoverSataCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|bit32
name|event
parameter_list|,
name|void
modifier|*
name|pParm1
parameter_list|,
name|void
modifier|*
name|pParm2
parameter_list|)
block|{
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  ossaSATACompleted * *   This routine is called to complete a SATA request previously issued to the *    LL Layer in saSATAStart() * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaSATACompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|void
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|)
block|{
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  ossaSATAEvent * *   This routine is called to notify the OS Layer of an event associated with *   SATA port or SATA device * *  \param   agRoot:        Handles for this instance of SAS/SATA hardware *  \param   agIORequest:   Pointer to the LL I/O request context for this I/O. *  \param   agPortContext  Pointer to the port context of TD and Lower layer *  \param   agDevHandle:   Pointer to a device handle *  \param   event:         event type * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSATAEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|event
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|)
block|{
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  ossaSATADeviceResetCB * *   This routine is called to complete a SATA device reset request previously *   issued to the LL Layer in saSATADeviceReset(). * *  \param agRoot:      Handles for this instance of SAS/SATA hardware *  \param agDevHandle: Pointer to a device handle *  \param resetStatus: Reset status: *                      OSSA_SUCCESS: The reset operation completed successfully. *                      OSSA_FAILURE: The reset operation failed. *  \param resetparm:  Pointer to the Device-To-Host FIS received from the device. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSATADeviceResetCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|resetStatus
parameter_list|,
name|void
modifier|*
name|resetparm
parameter_list|)
block|{
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief ossaDiscoverSasCB * *  Purpose:  This function is called by lower layer to inform TD layer of *            SAS discovery results * * *  \param   agRoot         Pointer to chip/driver Instance. *  \param   agPortContext  Pointer to the port context of TD and Lower layer *  \param   event          event type *  \param   pParm1         Pointer to data associated with event *  \param   pParm2         Pointer to data associated with event * *  \return: none * *  \note -  For details, refer to SAS/SATA Low-Level API Specification * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaDiscoverSasCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|bit32
name|event
parameter_list|,
name|void
modifier|*
name|pParm1
parameter_list|,
name|void
modifier|*
name|pParm2
parameter_list|)
block|{
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  *  * This file contains Management IOCTL APIs  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/mpidebug.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdioctl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/sadefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/spcdefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/mpi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/sallist.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/satypes.h>
end_include

begin_define
define|#
directive|define
name|agFieldOffset
parameter_list|(
name|baseType
parameter_list|,
name|fieldName
parameter_list|)
define|\
comment|/*lint -e545 */
define|\
value|((bit32)((bitptr)(&(((baseType *)0)->fieldName)))) \  #ifdef SA_LL_API_TEST
end_define

begin_function_decl
name|osGLOBAL
name|bit32
name|tdLlApiTestIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SA_LL_API_TEST */
end_comment

begin_decl_stmt
specifier|extern
name|bit32
specifier|volatile
name|sgpioResponseSet
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|SPC_ENABLE_PROFILE
end_ifdef

begin_comment
comment|/***************************************************************************** * * tdipFWProfileIoctl * * Purpose:  This routine is called to process the FW Profile IOCTL function. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdipFWProfileIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|bit32
name|bufAddrUpper
init|=
literal|0
decl_stmt|;
name|bit32
name|bufAddrLower
init|=
literal|0
decl_stmt|;
name|tdFWProfile_t
modifier|*
name|fwProfile
decl_stmt|;
name|void
modifier|*
name|osMemHandle
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|buffer
init|=
name|agNULL
decl_stmt|;
name|agsaFwProfile_t
name|fwProfileInfo
init|=
block|{
literal|0
block|}
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
name|tdsaAllShared
operator|->
name|agRootInt
decl_stmt|;
name|fwProfile
operator|=
operator|(
name|tdFWProfile_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|fwProfileInfo
operator|.
name|processor
operator|=
name|fwProfile
operator|->
name|processor
expr_stmt|;
name|fwProfileInfo
operator|.
name|cmd
operator|=
name|fwProfile
operator|->
name|cmd
expr_stmt|;
name|fwProfileInfo
operator|.
name|len
operator|=
name|fwProfile
operator|->
name|len
expr_stmt|;
name|fwProfileInfo
operator|.
name|tcid
operator|=
name|fwProfile
operator|->
name|tcid
expr_stmt|;
if|if
condition|(
name|fwProfile
operator|->
name|cmd
operator|==
name|START_CODE_PROFILE
condition|)
block|{
name|fwProfileInfo
operator|.
name|codeStartAdd
operator|=
name|fwProfile
operator|->
name|codeStartAdd
expr_stmt|;
name|fwProfileInfo
operator|.
name|codeEndAdd
operator|=
name|fwProfile
operator|->
name|codeEndAdd
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fwProfile
operator|->
name|cmd
operator|==
name|STOP_TIMER_PROFILE
operator|)
operator|||
operator|(
name|fwProfile
operator|->
name|cmd
operator|==
name|STOP_CODE_PROFILE
operator|)
condition|)
block|{
if|if
condition|(
name|fwProfile
operator|->
name|len
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|buffer
argument_list|,
operator|&
name|bufAddrUpper
argument_list|,
operator|&
name|bufAddrLower
argument_list|,
literal|8
argument_list|,
name|fwProfile
operator|->
name|len
argument_list|,
name|agFALSE
argument_list|)
condition|)
block|{
return|return
name|IOCTL_CALL_FAIL
return|;
block|}
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
literal|0
argument_list|,
name|fwProfile
operator|->
name|len
argument_list|)
expr_stmt|;
block|}
name|fwProfileInfo
operator|.
name|agSgl
operator|.
name|sgLower
operator|=
name|bufAddrLower
expr_stmt|;
name|fwProfileInfo
operator|.
name|agSgl
operator|.
name|sgUpper
operator|=
name|bufAddrUpper
expr_stmt|;
name|fwProfileInfo
operator|.
name|agSgl
operator|.
name|len
operator|=
name|fwProfile
operator|->
name|len
expr_stmt|;
name|fwProfileInfo
operator|.
name|agSgl
operator|.
name|extReserved
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|virtAddr
operator|=
name|buffer
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|len
operator|=
name|fwProfile
operator|->
name|len
expr_stmt|;
block|}
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|tdFWProfile
operator|=
name|fwProfile
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|saFwProfile
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
operator|&
name|fwProfileInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
if|if
condition|(
operator|(
name|fwProfile
operator|->
name|cmd
operator|==
name|STOP_TIMER_PROFILE
operator|)
operator|||
operator|(
name|fwProfile
operator|->
name|cmd
operator|==
name|STOP_CODE_PROFILE
operator|)
condition|)
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
name|fwProfile
operator|->
name|len
argument_list|)
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
block|}
else|else
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** * * tdipFWControlIoctl * * Purpose:  This routine is called to process the FW control IOCTL function. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdipFWControlIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|bit32
name|status
init|=
name|IOCTL_CALL_PENDING
decl_stmt|;
name|bit32
name|bufAddrUpper
init|=
literal|0
decl_stmt|;
name|bit32
name|bufAddrLower
init|=
literal|0
decl_stmt|;
name|tdFWControl_t
modifier|*
name|fwControl
decl_stmt|;
name|void
modifier|*
name|osMemHandle
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|buffer
init|=
name|agNULL
decl_stmt|;
name|agsaUpdateFwFlash_t
name|flashUpdateInfo
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
name|tdsaAllShared
operator|->
name|agRootInt
decl_stmt|;
if|if
condition|(
name|agIOCTLPayload
operator|->
name|Length
operator|<
operator|(
name|agFieldOffset
argument_list|(
name|tiIOCTLPayload_t
argument_list|,
name|FunctionSpecificArea
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|tdFWControl_t
argument_list|)
operator|)
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
return|return
name|status
return|;
block|}
name|fwControl
operator|=
operator|(
name|tdFWControl_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|fwControl
operator|->
name|len
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|buffer
argument_list|,
operator|&
name|bufAddrUpper
argument_list|,
operator|&
name|bufAddrLower
argument_list|,
literal|8
argument_list|,
name|fwControl
operator|->
name|len
argument_list|,
name|agFALSE
argument_list|)
condition|)
return|return
name|IOCTL_CALL_FAIL
return|;
block|}
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
literal|0
argument_list|,
name|fwControl
operator|->
name|len
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
name|fwControl
operator|->
name|buffer
argument_list|,
name|fwControl
operator|->
name|len
argument_list|)
expr_stmt|;
name|flashUpdateInfo
operator|.
name|agSgl
operator|.
name|sgLower
operator|=
name|bufAddrLower
expr_stmt|;
name|flashUpdateInfo
operator|.
name|agSgl
operator|.
name|sgUpper
operator|=
name|bufAddrUpper
expr_stmt|;
name|flashUpdateInfo
operator|.
name|agSgl
operator|.
name|len
operator|=
name|fwControl
operator|->
name|len
expr_stmt|;
name|flashUpdateInfo
operator|.
name|agSgl
operator|.
name|extReserved
operator|=
literal|0
expr_stmt|;
name|flashUpdateInfo
operator|.
name|currentImageOffset
operator|=
name|fwControl
operator|->
name|offset
expr_stmt|;
name|flashUpdateInfo
operator|.
name|currentImageLen
operator|=
name|fwControl
operator|->
name|len
expr_stmt|;
name|flashUpdateInfo
operator|.
name|totalImageLen
operator|=
name|fwControl
operator|->
name|size
expr_stmt|;
switch|switch
condition|(
name|agIOCTLPayload
operator|->
name|MinorFunction
condition|)
block|{
case|case
name|IOCTL_MN_FW_DOWNLOAD_DATA
case|:
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdipFWControlIoctl: calling saFwFlashUpdate\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|tdFWControl
operator|=
name|fwControl
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|saFwFlashUpdate
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
operator|&
name|flashUpdateInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
name|fwControl
operator|->
name|retcode
operator|=
name|IOCTL_CALL_TIMEOUT
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
block|}
break|break;
block|}
default|default:
name|status
operator|=
name|IOCTL_CALL_INVALID_CODE
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdipFWControlIoctl: ERROR: Wrong IOCTL code %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|MinorFunction
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
name|fwControl
operator|->
name|len
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* end IOCTL switch */
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* tdipFWControlIoctl */
end_comment

begin_comment
comment|/***************************************************************************** * * tiCOMMgntIOCTL * * Purpose:  This routine is a TISA API for processing the PMC specific *           IOCTL function. * *           Each IOCTL function is identified by the IOCTL header *           specified in the data payload as the following: *           Field                 Description *           -----                 ----------- *           Signature             PMC IOCTL signature. *                                 #define PMC_IOCTL_SIGNATURE   0x1234 *           MajorFunction         Major function number. *           MinorFunction         Minor function number. *           Length                Length of this structure in bytes. *           Status                Return status for this IOCTL function. *           FunctionSpecificArea  Variable length function specific area. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. *   IOCTL_CALL_INVALID_DEVICE Invalid target or destination device. * * Note: *  Used ostiAllocMemory() OS layer callback function to allocate memory *  for DMA operaion. Then use ostiFreeMemory() to deallocate the memory. * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiCOMMgntIOCTL
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|bit32
name|status
init|=
name|IOCTL_CALL_INVALID_CODE
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
decl_stmt|;
name|bit32
name|EventLogLength
init|=
literal|0
decl_stmt|;
name|bit32
name|EventLogOption
decl_stmt|;
name|bit32
name|ReadLength
init|=
literal|0
decl_stmt|;
name|bit32
name|Offset
init|=
literal|0
decl_stmt|;
name|bit32
name|RequestLength
init|=
literal|0
decl_stmt|;
comment|/* user request on how much data to pass to application */
name|agsaContext_t
modifier|*
name|agContext
init|=
name|NULL
decl_stmt|;
name|bit8
modifier|*
name|loc
init|=
name|NULL
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: tiRoot %p agIOCTLPayload %p agParam1 %p agParam2 %p agParam3 %p\n"
operator|,
name|tiRoot
operator|,
name|agIOCTLPayload
operator|,
name|agParam1
operator|,
name|agParam2
operator|,
name|agParam3
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: Signature %X\ntiCOMMgntIOCTL: MajorFunction 0x%X\ntiCOMMgntIOCTL: MinorFunction 0x%X\ntiCOMMgntIOCTL: Length 0x%X\ntiCOMMgntIOCTL: Status 0x%X\ntiCOMMgntIOCTL: Reserved 0x%X\ntiCOMMgntIOCTL: FunctionSpecificArea 0x%X\n"
operator|,
name|agIOCTLPayload
operator|->
name|Signature
operator|,
name|agIOCTLPayload
operator|->
name|MajorFunction
operator|,
name|agIOCTLPayload
operator|->
name|MinorFunction
operator|,
name|agIOCTLPayload
operator|->
name|Length
operator|,
name|agIOCTLPayload
operator|->
name|Status
operator|,
name|agIOCTLPayload
operator|->
name|Reserved
operator|,
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* PMC IOCTL signatures matched ? */
if|if
condition|(
name|agIOCTLPayload
operator|->
name|Signature
operator|!=
name|PMC_IOCTL_SIGNATURE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL:agIOCTLPayload->Signature %x IOCTL_CALL_INVALID_CODE\n"
operator|,
name|agIOCTLPayload
operator|->
name|Signature
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_INVALID_CODE
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
switch|switch
condition|(
name|agIOCTLPayload
operator|->
name|MajorFunction
condition|)
block|{
comment|//TODO: make the card identification more robust. For now - just to keep going with FW download
ifdef|#
directive|ifdef
name|IOCTL_INTERRUPT_TIME_CONFIG
case|case
name|IOCTL_MJ_CARD_PARAMETER
case|:
block|{
switch|switch
condition|(
name|agIOCTLPayload
operator|->
name|MinorFunction
condition|)
block|{
case|case
name|IOCTL_MN_CARD_GET_INTERRUPT_CONFIG
case|:
block|{
name|agsaInterruptConfigPage_t
modifier|*
name|pInterruptConfig
init|=
operator|(
name|agsaInterruptConfigPage_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
decl_stmt|;
name|status
operator|=
name|saGetControllerConfig
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|,
name|AGSA_INTERRUPT_CONFIGURATION_PAGE
argument_list|,
name|pInterruptConfig
operator|->
name|vectorMask0
argument_list|,
name|pInterruptConfig
operator|->
name|vectorMask1
argument_list|,
name|agParam2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
block|}
else|else
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
block|}
break|break;
block|}
case|case
name|IOCTL_MN_CARD_GET_TIMER_CONFIG
case|:
name|status
operator|=
name|saGetControllerConfig
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|,
name|AGSA_SAS_PROTOCOL_TIMER_CONFIG_PAGE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|agParam2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
block|}
else|else
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
block|}
break|break;
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* IOCTL_INTERRUPT_TIME_CONFIG */
case|case
name|IOCTL_MJ_INI_DRIVER_IDENTIFY
case|:
block|{
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MJ_GET_DEVICE_LUN
case|:
name|status
operator|=
name|tdsaGetNumOfLUNIOCTL
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IOCTL_CALL_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
block|}
break|break;
case|case
name|IOCTL_MJ_SMP_REQUEST
case|:
name|status
operator|=
name|tdsaSendSMPIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
case|case
name|IOCTL_MJ_FW_CONTROL
case|:
block|{
comment|//ostiIOCTLClearSignal (tiRoot,&agParam1,&agParam2,&agParam3);
name|status
operator|=
name|tdipFWControlIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
comment|//#ifdef EVENT_LOG_INFO_TESTING
comment|/* Reserved field in tiIOCTLPayload_t is used as offset */
case|case
name|IOCTL_MJ_GET_EVENT_LOG1
case|:
block|{
switch|switch
condition|(
name|agIOCTLPayload
operator|->
name|MinorFunction
condition|)
block|{
case|case
name|IOCTL_MN_FW_GET_TRACE_BUFFER
case|:
block|{
name|agsaControllerEventLog_t
name|EventLog
decl_stmt|;
name|saGetControllerEventLogInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|EventLog
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_GET_EVENT_LOG1 Length %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|Length
operator|)
argument_list|)
expr_stmt|;
name|RequestLength
operator|=
name|agIOCTLPayload
operator|->
name|Length
expr_stmt|;
name|Offset
operator|=
name|agIOCTLPayload
operator|->
name|Reserved
expr_stmt|;
name|EventLogLength
operator|=
name|EventLog
operator|.
name|eventLog1
operator|.
name|totalLength
expr_stmt|;
name|EventLogOption
operator|=
name|EventLog
operator|.
name|eventLog1Option
expr_stmt|;
if|if
condition|(
name|EventLogLength
operator|<=
name|Offset
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: 1 out of range Requestlength %d Offset %d event log length %d\n"
operator|,
name|RequestLength
operator|,
name|Offset
operator|,
name|EventLogLength
operator|)
argument_list|)
expr_stmt|;
comment|// out of range
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NO_MORE_DATA
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Length
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|EventLogOption
operator|==
literal|0
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_FW_EVENTLOG_DISABLED
expr_stmt|;
block|}
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
return|return
name|status
return|;
block|}
name|ReadLength
operator|=
name|MIN
argument_list|(
name|EventLogLength
operator|-
name|Offset
argument_list|,
name|RequestLength
argument_list|)
expr_stmt|;
name|loc
operator|=
operator|(
name|bit8
operator|*
operator|)
name|EventLog
operator|.
name|eventLog1
operator|.
name|virtPtr
operator|+
name|Offset
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
operator|)
argument_list|,
name|loc
argument_list|,
name|ReadLength
argument_list|)
expr_stmt|;
comment|//   tdhexdump("IOCTL_MJ_GET_EVENT_LOG1 first 32bytes", (bit8 *)&(agIOCTLPayload->FunctionSpecificArea), 32);
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Length
operator|=
operator|(
name|bit16
operator|)
name|ReadLength
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MN_FW_GET_EVENT_FLASH_LOG1
case|:
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MN_FW_GET_EVENT_FLASH_LOG1\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaRegDumpGetIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
case|case
name|IOCTL_MJ_GET_EVENT_LOG2
case|:
block|{
switch|switch
condition|(
name|agIOCTLPayload
operator|->
name|MinorFunction
condition|)
block|{
case|case
name|IOCTL_MN_FW_GET_TRACE_BUFFER
case|:
block|{
name|agsaControllerEventLog_t
name|EventLog
decl_stmt|;
name|saGetControllerEventLogInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|EventLog
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_GET_EVENT_LOG2 Length %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|Length
operator|)
argument_list|)
expr_stmt|;
name|RequestLength
operator|=
name|agIOCTLPayload
operator|->
name|Length
expr_stmt|;
name|Offset
operator|=
name|agIOCTLPayload
operator|->
name|Reserved
expr_stmt|;
name|EventLogLength
operator|=
name|EventLog
operator|.
name|eventLog2
operator|.
name|totalLength
expr_stmt|;
name|EventLogOption
operator|=
name|EventLog
operator|.
name|eventLog2Option
expr_stmt|;
if|if
condition|(
name|EventLogLength
operator|<=
name|Offset
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: 2 out of range Requestlength %d Offset %d event log length %d\n"
operator|,
name|RequestLength
operator|,
name|Offset
operator|,
name|EventLogLength
operator|)
argument_list|)
expr_stmt|;
comment|/* out of range */
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NO_MORE_DATA
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Length
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|EventLogOption
operator|==
literal|0
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_FW_EVENTLOG_DISABLED
expr_stmt|;
block|}
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
return|return
name|status
return|;
block|}
name|ReadLength
operator|=
name|MIN
argument_list|(
name|EventLogLength
operator|-
name|Offset
argument_list|,
name|RequestLength
argument_list|)
expr_stmt|;
name|loc
operator|=
operator|(
name|bit8
operator|*
operator|)
name|EventLog
operator|.
name|eventLog2
operator|.
name|virtPtr
operator|+
name|Offset
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
operator|)
argument_list|,
name|loc
argument_list|,
name|ReadLength
argument_list|)
expr_stmt|;
comment|//    tdhexdump("IOCTL_MJ_GET_EVENT_LOG2 first 32bytes", (bit8 *)&(agIOCTLPayload->FunctionSpecificArea), 32);
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Length
operator|=
operator|(
name|bit16
operator|)
name|ReadLength
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MN_FW_GET_EVENT_FLASH_LOG2
case|:
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MN_FW_GET_EVENT_FLASH_LOG2\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaRegDumpGetIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
case|case
name|IOCTL_MJ_FW_INFO
case|:
block|{
name|agsaControllerInfo_t
name|ControllerInfo
decl_stmt|;
name|saGetControllerInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|ControllerInfo
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_FW_INFO Length %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|Length
operator|)
argument_list|)
expr_stmt|;
name|RequestLength
operator|=
name|agIOCTLPayload
operator|->
name|Length
expr_stmt|;
name|Offset
operator|=
name|agIOCTLPayload
operator|->
name|Reserved
expr_stmt|;
if|if
condition|(
name|RequestLength
operator|==
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_FW_INFO: No more Data!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* out of range */
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NO_MORE_DATA
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Length
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
return|return
name|status
return|;
block|}
name|osti_memcpy
argument_list|(
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
operator|)
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|ControllerInfo
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaControllerInfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL:IOCTL_MJ_FW_INFO ControllerInfo signature 0x%X\n"
operator|,
name|ControllerInfo
operator|.
name|signature
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL:IOCTL_MJ_FW_INFO ControllerInfo PCILinkRate 0x%X\n"
operator|,
name|ControllerInfo
operator|.
name|PCILinkRate
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL:IOCTL_MJ_FW_INFO ControllerInfo PCIWidth 0x%X\n"
operator|,
name|ControllerInfo
operator|.
name|PCIWidth
operator|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MJ_GET_FW_REV
case|:
block|{
name|agsaControllerInfo_t
name|ControllerInfo
decl_stmt|;
name|saGetControllerInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|ControllerInfo
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_GET_FW_REV Length %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|Length
operator|)
argument_list|)
expr_stmt|;
name|RequestLength
operator|=
name|agIOCTLPayload
operator|->
name|Length
expr_stmt|;
name|Offset
operator|=
name|agIOCTLPayload
operator|->
name|Reserved
expr_stmt|;
if|if
condition|(
name|RequestLength
operator|==
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_GET_FW_REV: No more Data!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* out of range */
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NO_MORE_DATA
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Length
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
return|return
name|status
return|;
block|}
name|osti_memcpy
argument_list|(
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
operator|)
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|ControllerInfo
operator|.
name|fwRevision
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|loc
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
operator|)
operator|+
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|loc
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|ControllerInfo
operator|.
name|sdkRevision
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|SPC_ENABLE_PROFILE
case|case
name|IOCTL_MJ_FW_PROFILE
case|:
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_FW_PROFILE\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdipFWProfileIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* SPC_ENABLE_PROFILE */
case|case
name|IOCTL_MJ_GET_CORE_DUMP
case|:
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_GET_CORE_DUMP\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|status
operator|=
name|tdsaRegDumpGetIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NOT_SUPPORTED
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
block|}
break|break;
block|}
comment|//#endif
case|case
name|IOCTL_MJ_NVMD_SET
case|:
block|{
name|bit8
name|nvmDev
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_NVMD_SET\n"
operator|)
argument_list|)
expr_stmt|;
name|nvmDev
operator|=
operator|(
name|bit8
operator|)
name|agIOCTLPayload
operator|->
name|Status
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|tdsaNVMDSetIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
operator|&
name|nvmDev
argument_list|)
expr_stmt|;
break|break;
block|}
if|#
directive|if
literal|0
block|case IOCTL_MJ_GPIO:    {     bit32 sVid =0;     TI_DBG6(("tiCOMMgntIOCTL: IOCTL_MJ_GPIO\n"));
comment|/* Get Subsystem vendor  */
block|sVid = ostiChipConfigReadBit32(tiRoot,0x2C);     sVid = sVid& 0xFFFF;
comment|/* GPIO is only intended for chip down design       * therefore it's only applies to 8H/SPCv product family       */
block|if(sVid == 0x9005)     return IOCTL_CALL_INVALID_DEVICE;          status = tdsaGpioSetup(tiRoot, agContext, agIOCTLPayload, agParam1, agParam2);     if(status == IOCTL_CALL_SUCCESS)           status = IOCTL_CALL_PENDING;
comment|/* Wait for response from the Controller */
block|else        return status;        break;   }
endif|#
directive|endif
case|case
name|IOCTL_MJ_SGPIO
case|:
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_SGPIO\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaSGpioIoctlSetup
argument_list|(
name|tiRoot
argument_list|,
name|agContext
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MJ_NVMD_GET
case|:
block|{
name|bit8
name|nvmDev
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_NVMD_GET\n"
operator|)
argument_list|)
expr_stmt|;
name|nvmDev
operator|=
operator|(
name|bit8
operator|)
name|agIOCTLPayload
operator|->
name|Status
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|tdsaNVMDGetIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
operator|&
name|nvmDev
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MJ_GET_FORENSIC_DATA
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_GET_FORENSIC_DATA\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaForensicDataGetIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MJ_GET_DEVICE_INFO
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_GET_DEVICE_INFO\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaDeviceInfoGetIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MJ_GET_IO_ERROR_STATISTIC
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_GET_IO_ERROR_STATISTIC\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaIoErrorStatisticGetIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MJ_GET_IO_EVENT_STATISTIC
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_GET_IO_EVENT_STATISTIC\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaIoEventStatisticGetIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MJ_SEND_BIST
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_SEND_BIST\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaSendBISTIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
if|#
directive|if
literal|0
block|case IOCTL_MJ_SET_OR_GET_REGISTER:   {     TI_DBG3(("tiCOMMgntIOCTL: IOCTL_MJ_SET_OR_GET_REGISTER\n"));     status = tdsaRegisterIoctl(tiRoot, agIOCTLPayload, agParam1, agParam2, agParam3);     break;   }
endif|#
directive|endif
case|case
name|IOCTL_MJ_PHY_DETAILS
case|:
block|{
name|PhyDetails_t
modifier|*
name|PhyDetails
init|=
operator|(
name|PhyDetails_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|bit8
modifier|*
name|sasAddressHi
decl_stmt|;
name|bit8
modifier|*
name|sasAddressLo
decl_stmt|;
name|bit8
name|sas_dev_type
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|tiIniGetDirectSataSasAddr
argument_list|(
name|tiRoot
argument_list|,
name|i
argument_list|,
operator|&
name|sasAddressHi
argument_list|,
operator|&
name|sasAddressLo
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|phyCount
condition|;
name|i
operator|++
control|)
block|{
name|PhyDetails
index|[
name|i
index|]
operator|.
name|attached_phy
operator|=
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|.
name|sasIdentify
operator|.
name|phyIdentifier
expr_stmt|;
comment|/* deice types  		 * SAS	   		 * 0x01 - Sas end device     		 * 0x02 - Expander device   		 * SATA  		 * 0x11 - Sata  		 * NO DEVICE 0x00  		 */
name|sas_dev_type
operator|=
operator|(
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|.
name|sasIdentify
operator|.
name|deviceType_addressFrameType
operator|&
literal|0x70
operator|)
operator|>>
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|.
name|status
operator|==
literal|1
operator|)
operator|&&
operator|(
name|sas_dev_type
operator|==
literal|0
operator|)
condition|)
block|{
comment|//status 1 - Phy Up
comment|//Sata phy
name|PhyDetails
index|[
name|i
index|]
operator|.
name|attached_dev_type
operator|=
name|SAS_PHY_SATA_DEVICE
expr_stmt|;
comment|//0x11 for sata end device
name|osti_memcpy
argument_list|(
operator|&
name|PhyDetails
index|[
name|i
index|]
operator|.
name|attached_sasAddressHi
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|PhyDetails
index|[
name|i
index|]
operator|.
name|attached_sasAddressLo
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|PhyDetails
index|[
name|i
index|]
operator|.
name|attached_sasAddressLo
index|[
literal|3
index|]
operator|+=
name|i
operator|+
literal|16
expr_stmt|;
block|}
else|else
block|{
name|PhyDetails
index|[
name|i
index|]
operator|.
name|attached_dev_type
operator|=
name|sas_dev_type
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|PhyDetails
index|[
name|i
index|]
operator|.
name|attached_sasAddressHi
argument_list|,
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|.
name|sasIdentify
operator|.
name|sasAddressHi
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|PhyDetails
index|[
name|i
index|]
operator|.
name|attached_sasAddressLo
argument_list|,
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|.
name|sasIdentify
operator|.
name|sasAddressLo
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|osti_memcpy
argument_list|(
operator|&
name|PhyDetails
index|[
name|i
index|]
operator|.
name|sasAddressLo
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|PhyDetails
index|[
name|i
index|]
operator|.
name|sasAddressHi
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|//    	osti_memcpy(&agIoctlPayload->FunctionSpecificArea,&PhyInfo, sizeof(agsaSGpioReqResponse_t));
comment|//	printk("Ioctl success\n");
return|return
name|IOCTL_CALL_SUCCESS
return|;
block|}
case|case
name|IOCTL_MJ_PHY_GENERAL_STATUS
case|:
block|{
name|agsaPhyGeneralState_t
modifier|*
name|PhyData
init|=
name|NULL
decl_stmt|;
name|bit32
name|ret
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|PhyData
operator|=
operator|(
name|agsaPhyGeneralState_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|PhyData
operator|->
name|Reserved2
operator|=
literal|0
expr_stmt|;
comment|/* Validate the length */
if|if
condition|(
name|agIOCTLPayload
operator|->
name|Length
operator|<
sizeof|sizeof
argument_list|(
name|agsaPhyGeneralState_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
break|break;
block|}
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
comment|//tdsaAllShared->tdFWControlEx.usrAddr = PhyData;
name|ret
operator|=
name|tdsaGetPhyGeneralStatusIoctl
argument_list|(
name|tiRoot
argument_list|,
name|PhyData
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|NULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|ret
operator|==
name|IOCTL_ERR_STATUS_NOT_SUPPORTED
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NOT_SUPPORTED
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
break|break;
block|}
comment|//status = IOCTL_CALL_PENDING;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
block|}
break|break;
if|#
directive|if
literal|1
case|case
name|IOCTL_MJ_GET_PHY_PROFILE
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: IOCTL_MJ_GET_PHY_PROFILE %p %p %p\n"
operator|,
name|agParam1
operator|,
name|agParam2
operator|,
name|agParam3
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaPhyProfileIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
case|case
name|IOCTL_MJ_LL_TRACING
case|:
block|{
name|void
modifier|*
name|stu
init|=
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
decl_stmt|;
switch|switch
condition|(
name|agIOCTLPayload
operator|->
name|MinorFunction
condition|)
block|{
case|case
name|IOCTL_MN_LL_RESET_TRACE_INDEX
case|:
block|{
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
name|TSTMTID_TRACE_BUFFER_RESET
modifier|*
name|llist
init|=
operator|(
name|TSTMTID_TRACE_BUFFER_RESET
operator|*
operator|)
name|stu
decl_stmt|;
name|hpTraceBufferParms_t
name|BufferParms
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdReturnIOCTL_Info: hpIOCTL_ResetTraceIndex\n"
operator|)
argument_list|)
expr_stmt|;
name|BufferParms
operator|.
name|TraceCompiled
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|TraceWrap
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|CurrentTraceIndexWrapCount
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|BufferSize
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|CurrentIndex
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|pTrace
operator|=
name|NULL
expr_stmt|;
name|BufferParms
operator|.
name|pTraceIndexWrapCount
operator|=
name|NULL
expr_stmt|;
name|BufferParms
operator|.
name|pTraceMask
operator|=
name|NULL
expr_stmt|;
name|BufferParms
operator|.
name|pCurrentTraceIndex
operator|=
name|NULL
expr_stmt|;
name|smTraceGetInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|BufferParms
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdReturnIOCTL_Info: pTrace                %p\n"
operator|,
name|BufferParms
operator|.
name|pTrace
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdReturnIOCTL_Info: pCurrentTraceIndex    %p %X\n"
operator|,
name|BufferParms
operator|.
name|pCurrentTraceIndex
operator|,
operator|*
name|BufferParms
operator|.
name|pCurrentTraceIndex
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdReturnIOCTL_Info: pTraceIndexWrapCount  %p %X\n"
operator|,
name|BufferParms
operator|.
name|pTraceIndexWrapCount
operator|,
operator|*
name|BufferParms
operator|.
name|pTraceIndexWrapCount
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdReturnIOCTL_Info: pTraceMask            %p %X\n"
operator|,
name|BufferParms
operator|.
name|pTraceMask
operator|,
operator|*
name|BufferParms
operator|.
name|pTraceMask
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|llist
operator|->
name|Flag
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|llist
operator|->
name|TraceMask
operator|!=
operator|*
name|BufferParms
operator|.
name|pTraceMask
condition|)
block|{
name|smTraceSetMask
argument_list|(
name|agRoot
argument_list|,
name|llist
operator|->
name|TraceMask
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|llist
operator|->
name|Reset
condition|)
block|{
operator|*
name|BufferParms
operator|.
name|pCurrentTraceIndex
operator|=
literal|0
expr_stmt|;
name|smResetTraceBuffer
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
operator|*
name|BufferParms
operator|.
name|pCurrentTraceIndex
operator|=
literal|0
expr_stmt|;
operator|*
name|BufferParms
operator|.
name|pTraceIndexWrapCount
operator|=
literal|0
expr_stmt|;
name|llist
operator|->
name|TraceMask
operator|=
operator|*
name|BufferParms
operator|.
name|pTraceMask
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SA_ENABLE_TRACE_FUNCTIONS  */
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
block|}
break|break;
case|case
name|IOCTL_MN_LL_GET_TRACE_BUFFER_INFO
case|:
block|{
name|hpTraceBufferParms_t
name|BufferParms
decl_stmt|;
name|TSTMTID_TRACE_BUFFER_INFO
modifier|*
name|llist
init|=
operator|(
name|TSTMTID_TRACE_BUFFER_INFO
operator|*
operator|)
name|stu
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdReturnIOCTL_Info: hpIOCTL_GetTraceBufferInfo\n"
operator|)
argument_list|)
expr_stmt|;
name|BufferParms
operator|.
name|TraceCompiled
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|TraceWrap
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|CurrentTraceIndexWrapCount
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|BufferSize
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|CurrentIndex
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|pTrace
operator|=
name|NULL
expr_stmt|;
name|BufferParms
operator|.
name|pTraceMask
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
name|smTraceGetInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|BufferParms
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_ENABLE_TRACE_FUNCTIONS not enabled */
name|llist
operator|->
name|TraceCompiled
operator|=
name|BufferParms
operator|.
name|TraceCompiled
expr_stmt|;
name|llist
operator|->
name|BufferSize
operator|=
name|BufferParms
operator|.
name|BufferSize
expr_stmt|;
name|llist
operator|->
name|CurrentIndex
operator|=
name|BufferParms
operator|.
name|CurrentIndex
expr_stmt|;
name|llist
operator|->
name|CurrentTraceIndexWrapCount
operator|=
name|BufferParms
operator|.
name|CurrentTraceIndexWrapCount
expr_stmt|;
name|llist
operator|->
name|TraceWrap
operator|=
name|BufferParms
operator|.
name|TraceWrap
expr_stmt|;
if|if
condition|(
name|BufferParms
operator|.
name|pTraceMask
operator|!=
name|NULL
condition|)
block|{
name|llist
operator|->
name|TraceMask
operator|=
operator|*
name|BufferParms
operator|.
name|pTraceMask
expr_stmt|;
block|}
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
block|}
break|break;
case|case
name|IOCTL_MN_LL_GET_TRACE_BUFFER
case|:
block|{
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
name|TSTMTID_TRACE_BUFFER_FETCH
modifier|*
name|llist
init|=
operator|(
name|TSTMTID_TRACE_BUFFER_FETCH
operator|*
operator|)
name|stu
decl_stmt|;
name|hpTraceBufferParms_t
name|BufferParms
decl_stmt|;
name|bit32
name|c
init|=
literal|0
decl_stmt|;
name|BufferParms
operator|.
name|TraceCompiled
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|TraceWrap
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|CurrentTraceIndexWrapCount
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|BufferSize
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|CurrentIndex
operator|=
literal|0
expr_stmt|;
name|BufferParms
operator|.
name|pTrace
operator|=
name|NULL
expr_stmt|;
name|smTraceGetInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|BufferParms
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdReturnIOCTL_Info: hpIOCTL_GetTraceBuffer\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|llist
operator|->
name|LowFence
operator|!=
name|LowFence32Bits
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|llist
operator|->
name|HighFence
operator|!=
name|HighFence32Bits
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|llist
operator|->
name|BufferOffsetBegin
operator|+
name|FetchBufferSIZE
operator|>
name|BufferParms
operator|.
name|BufferSize
condition|)
block|{         }
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|FetchBufferSIZE
condition|;
name|c
operator|++
control|)
block|{
name|llist
operator|->
name|Data
index|[
name|c
index|]
operator|=
operator|*
operator|(
name|BufferParms
operator|.
name|pTrace
operator|+
operator|(
name|c
operator|+
name|llist
operator|->
name|BufferOffsetBegin
operator|)
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SA_ENABLE_TRACE_FUNCTIONS not enabled */
block|}
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
break|break;
block|}
break|break;
block|}
ifdef|#
directive|ifdef
name|SA_LL_API_TEST
case|case
name|IOCTL_MJ_LL_API_TEST
case|:
block|{
name|status
operator|=
name|tdLlApiTestIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|agParam3
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* SA_LL_API_TEST */
case|case
name|IOCTL_MJ_MODE_CTL_PAGE
case|:
block|{
comment|/* The SPCv controller has some options accessed via mode pages */
name|tiEncryptDekConfigPage_t
modifier|*
name|pModePage
init|=
operator|(
name|tiEncryptDekConfigPage_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
decl_stmt|;
name|bit32
name|pageLength
init|=
literal|0
decl_stmt|;
name|bit32
name|pageCode
decl_stmt|;
name|bit32
name|modeOperation
decl_stmt|;
name|pageCode
operator|=
name|pModePage
operator|->
name|pageCode
operator|&
literal|0xFF
expr_stmt|;
name|modeOperation
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|agParam2
expr_stmt|;
switch|switch
condition|(
name|modeOperation
condition|)
block|{
case|case
name|tiModePageSet
case|:
switch|switch
condition|(
name|pageCode
condition|)
block|{
case|case
name|TI_ENCRYPTION_DEK_CONFIG_PAGE
case|:
name|pageLength
operator|=
sizeof|sizeof
argument_list|(
name|tiEncryptDekConfigPage_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|TI_ENCRYPTION_CONTROL_PARM_PAGE
case|:
name|pageLength
operator|=
sizeof|sizeof
argument_list|(
name|tiEncryptControlParamPage_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|TI_ENCRYPTION_GENERAL_CONFIG_PAGE
case|:
comment|/* Pages are currently unsupported */
name|pageLength
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|status
operator|=
name|saSetControllerConfig
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|,
name|pageCode
argument_list|,
name|pageLength
argument_list|,
name|pModePage
argument_list|,
operator|(
name|agsaContext_t
operator|*
operator|)
name|agIOCTLPayload
argument_list|)
expr_stmt|;
break|break;
case|case
name|tiModePageGet
case|:
name|status
operator|=
name|saGetControllerConfig
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|,
name|pageCode
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|agsaContext_t
operator|*
operator|)
name|agIOCTLPayload
argument_list|)
expr_stmt|;
break|break;
default|default:
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NOT_SUPPORTED
expr_stmt|;
block|}
block|}
break|break;
ifdef|#
directive|ifdef
name|PHY_RESTART_TEST
case|case
name|IOCTL_MJ_PORT_START
case|:
block|{
name|bit32
name|portID
decl_stmt|,
name|tiStatus
decl_stmt|;
name|bit32
modifier|*
name|data
init|=
operator|(
name|bit32
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
decl_stmt|;
name|portID
operator|=
operator|*
name|data
expr_stmt|;
name|tiStatus
operator|=
name|tiCOMPortStart
argument_list|(
name|tiRoot
argument_list|,
name|portID
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|tiPortalContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiStatus
operator|==
name|tiSuccess
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
block|}
else|else
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
block|}
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MJ_PORT_STOP
case|:
block|{
name|bit32
name|portID
decl_stmt|,
name|tiStatus
decl_stmt|;
name|bit32
modifier|*
name|data
init|=
operator|(
name|bit32
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
decl_stmt|;
name|portID
operator|=
operator|*
name|data
expr_stmt|;
name|tiStatus
operator|=
name|tiCOMPortStop
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|portID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiStatus
operator|==
name|tiSuccess
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
block|}
else|else
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
block|}
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
case|case
name|IOCTL_MJ_SEND_TMF
case|:
switch|switch
condition|(
name|agIOCTLPayload
operator|->
name|MinorFunction
condition|)
block|{
case|case
name|IOCTL_MN_TMF_DEVICE_RESET
case|:
name|status
operator|=
name|tdsaSendTMFIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|AG_TARGET_WARM_RESET
argument_list|)
expr_stmt|;
break|break;
case|case
name|IOCTL_MN_TMF_LUN_RESET
case|:
name|status
operator|=
name|tdsaSendTMFIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
name|AG_LOGICAL_UNIT_RESET
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|IOCTL_MJ_GET_DRIVER_VERSION
case|:
name|osti_sprintf
argument_list|(
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
argument_list|,
literal|"%s"
argument_list|,
name|AGTIAPI_DRIVER_VERSION
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
break|break;
default|default:
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NOT_SUPPORTED
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/***************************************************************************** * * tdsaGpioSetup  * * Purpose:  This routine is called to set Gpio parameters to the controller. * * Parameters: *   tiRoot:         Pointer to driver instance *   agsaContext_t : *   tiIOCTLPayload_t :  ioctl header with payload gpio info  *   agParam1,agParam2 :  Generic parameters * * Return: status * * *****************************************************************************/
end_comment

begin_comment
unit|osGLOBAL bit32 tdsaGpioSetup(                 tiRoot_t            *tiRoot,                 agsaContext_t       *agContext,                 tiIOCTLPayload_t    *agIOCTLPayload,                 void                *agParam1,                 void                *agParam2                 ) {    tdsaTimerRequest_t        *osIoctlTimer;   agsaGpioEventSetupInfo_t  *gpioEventSetupInfo;   agsaGpioWriteSetupInfo_t  *gpioWriteSetupInfo;   agsaGpioPinSetupInfo_t    *gpioPinSetupInfo;   tdsaRoot_t                *tdsaRoot = (tdsaRoot_t *) tiRoot->tdData;   tdsaContext_t             *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;   agsaRoot_t                *agRoot =&(tdsaAllShared->agRootInt);   bit32                     status = IOCTL_CALL_SUCCESS;    TI_DBG3(("tdsaGpioSetup: start\n"));    if(tiRoot == agNULL || agIOCTLPayload == agNULL )   return IOCTL_CALL_FAIL;    osIoctlTimer =&tdsaAllShared->osIoctlTimer;   tdsaInitTimerRequest(tiRoot, osIoctlTimer);   tdIoctlStartTimer(tiRoot, osIoctlTimer);
comment|/* Start the timout handler for both ioctl and controller response */
end_comment

begin_endif
unit|tdsaAllShared->tdFWControlEx.virtAddr = (bit8 *)osIoctlTimer;    tdsaAllShared->tdFWControlEx.usrAddr = (bit8 *)&agIOCTLPayload->FunctionSpecificArea[0];   tdsaAllShared->tdFWControlEx.param1 = agParam1;   tdsaAllShared->tdFWControlEx.param2 = agParam2;   tdsaAllShared->tdFWControlEx.payload = agIOCTLPayload;   tdsaAllShared->tdFWControlEx.inProgress = 1;      switch (agIOCTLPayload->MinorFunction)     {            case IOCTL_MN_GPIO_PINSETUP:      { 	 TI_DBG3(("tdsaGpioSetup: IOCTL_MN_GPIO_PINSETUP\n"));          gpioPinSetupInfo =(agsaGpioPinSetupInfo_t *)&agIOCTLPayload->FunctionSpecificArea[0];          status = saGpioPinSetup(agRoot, agContext, 0, gpioPinSetupInfo);           break;      }	       case IOCTL_MN_GPIO_EVENTSETUP:      { 	TI_DBG3(("tdsaGpioSetup: IOCTL_MN_GPIO_EVENTSETUP\n"));         gpioEventSetupInfo = (agsaGpioEventSetupInfo_t  *)&agIOCTLPayload->FunctionSpecificArea[0];         status = saGpioEventSetup(agRoot, agContext, 0, gpioEventSetupInfo);          break;      }    	      case IOCTL_MN_GPIO_READ:      { 	 TI_DBG3(("tdsaGpioSetup: IOCTL_MN_GPIO_READ\n"));          status = saGpioRead(agRoot, agContext, 0);          break;      }   	 	        case IOCTL_MN_GPIO_WRITE:      { 	 TI_DBG3(("tdsaGpioSetup: IOCTL_MN_GPIO_WRITE\n"));          gpioWriteSetupInfo = (agsaGpioWriteSetupInfo_t *)&agIOCTLPayload->FunctionSpecificArea[0];          status = saGpioWrite(agRoot, agContext, 0, gpioWriteSetupInfo->gpioWritemask, gpioWriteSetupInfo->gpioWriteVal);           break;      }            default :          return status;     }      if(status != AGSA_RC_SUCCESS)     {       status = IOCTL_CALL_FAIL;       agIOCTLPayload->Status = IOCTL_ERR_STATUS_INTERNAL_ERROR;        tdsaSingleThreadedEnter(tiRoot, TD_TIMER_LOCK);       if (osIoctlTimer->timerRunning == agTRUE)       {          tdsaSingleThreadedLeave(tiRoot, TD_TIMER_LOCK);          tdsaKillTimer(tiRoot, osIoctlTimer);                }else{          tdsaSingleThreadedLeave(tiRoot, TD_TIMER_LOCK);       }     }      TI_DBG3(("tdsaGpioPinSetup: End\n"));     return status;  }
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** * * ostiGetGpioIOCTLRsp * * Purpose:  This routine is called for Get Gpio IOCTL reaponse has been received. * * Parameters: *   tiRoot:         Pointer to driver instance *   payloadRsp:     Pointer to the FW download IOMB's payload. * * Return: none * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiGetGpioIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|gpioReadValue
parameter_list|,
name|agsaGpioPinSetupInfo_t
modifier|*
name|gpioPinSetupInfo
parameter_list|,
name|agsaGpioEventSetupInfo_t
modifier|*
name|gpioEventSetupInfo
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIoctlPayload
decl_stmt|;
name|agsaGpioReadInfo_t
modifier|*
name|gpioReadInfo
decl_stmt|;
name|tdsaTimerRequest_t
modifier|*
name|osIoctlTimer
decl_stmt|;
name|osIoctlTimer
operator|=
operator|(
name|tdsaTimerRequest_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ostiGetGpioIOCTLRsp: start, status = %d \n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|agIoctlPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
if|if
condition|(
name|agIoctlPayload
operator|==
name|agNULL
condition|)
block|{
return|return;
block|}
name|agIoctlPayload
operator|->
name|Status
operator|=
operator|(
name|bit16
operator|)
name|status
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IOCTL_CALL_TIMEOUT
operator|)
operator|&&
operator|(
name|osIoctlTimer
operator|!=
name|NULL
operator|)
condition|)
block|{
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|osIoctlTimer
operator|->
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TIMER_LOCK
argument_list|)
expr_stmt|;
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
name|osIoctlTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|agIoctlPayload
operator|->
name|Status
operator|=
operator|(
name|bit16
operator|)
name|status
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
operator|==
name|SUCCESS
condition|)
name|TI_DBG3
argument_list|(
operator|(
literal|" ostiGetGpioIOCTLRsp:Got GPIO response from OUTBuf"
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|agIoctlPayload
operator|->
name|MinorFunction
condition|)
block|{
case|case
name|IOCTL_MN_GPIO_PINSETUP
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|" ostiGetGpioIOCTLRsp:Got GPIO response for IOCTL_MN_GPIO_PINSETUP"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MN_GPIO_EVENTSETUP
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|" ostiGetGpioIOCTLRsp:Got GPIO response for IOCTL_MN_GPIO_EVENTSETUP"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MN_GPIO_WRITE
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|" ostiGetGpioIOCTLRsp:Got GPIO response for IOCTL_MN_GPIO_WRITE"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IOCTL_MN_GPIO_READ
case|:
block|{
name|gpioReadInfo
operator|=
operator|(
name|agsaGpioReadInfo_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
expr_stmt|;
name|gpioReadInfo
operator|->
name|gpioReadValue
operator|=
name|gpioReadValue
expr_stmt|;
name|gpioReadInfo
operator|->
name|gpioInputEnabled
operator|=
name|gpioPinSetupInfo
operator|->
name|gpioInputEnabled
expr_stmt|;
comment|/* GPIOIE */
name|gpioReadInfo
operator|->
name|gpioEventLevelChangePart1
operator|=
name|gpioPinSetupInfo
operator|->
name|gpioTypePart1
expr_stmt|;
comment|/* GPIEVCHANGE (pins 11-0) */
name|gpioReadInfo
operator|->
name|gpioEventLevelChangePart2
operator|=
name|gpioPinSetupInfo
operator|->
name|gpioTypePart2
expr_stmt|;
comment|/* GPIEVCHANGE (pins 23-20) */
name|gpioReadInfo
operator|->
name|gpioEventRisingEdgePart1
operator|=
literal|0xFFF
operator|&
name|gpioEventSetupInfo
operator|->
name|gpioEventRisingEdge
expr_stmt|;
comment|/* GPIEVRISE (pins 11-0) */
name|gpioReadInfo
operator|->
name|gpioEventRisingEdgePart2
operator|=
literal|0x00F00000
operator|&
operator|(
name|gpioEventSetupInfo
operator|->
name|gpioEventRisingEdge
operator|)
expr_stmt|;
comment|/* GPIEVRISE (pins 23-20) */
name|gpioReadInfo
operator|->
name|gpioEventFallingEdgePart1
operator|=
literal|0xFFF
operator|&
name|gpioEventSetupInfo
operator|->
name|gpioEventFallingEdge
expr_stmt|;
comment|/* GPIEVALL (pins 11-0) */
name|gpioReadInfo
operator|->
name|gpioEventFallingEdgePart2
operator|=
literal|0x00F00000
operator|&
name|gpioEventSetupInfo
operator|->
name|gpioEventFallingEdge
expr_stmt|;
comment|/* GPIEVALL (pins 23-20 */
break|break;
block|}
default|default :
break|break;
block|}
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
condition|)
block|{
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"ostiGetGpioIOCTLRsp: end \n"
operator|)
argument_list|)
expr_stmt|;
return|return ;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tdsaSGpioIoctlSetup  * * Purpose:  This routine is called to send SGPIO request to the controller. * * Parameters: *   tiRoot:             Pointer to driver instance *   agsaContext_t:      Context for this request *   tiIOCTLPayload_t:   ioctl header with payload sgpio info  *   agParam1,agParam2:  Generic parameters * * Return: status * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaSGpioIoctlSetup
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_FAIL
decl_stmt|;
name|agsaSGpioReqResponse_t
modifier|*
name|pSGpioReq
init|=
operator|(
name|agsaSGpioReqResponse_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSGpioIoctlSetup: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
do|do
block|{
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
operator|||
name|agIOCTLPayload
operator|==
name|agNULL
condition|)
block|{
break|break;
block|}
comment|/* Validate the length */
if|if
condition|(
name|agIOCTLPayload
operator|->
name|Length
operator|<
sizeof|sizeof
argument_list|(
name|agsaSGpioReqResponse_t
argument_list|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"Invalid length\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Validate the SMP Frame Type, Function and Register Type fields */
if|if
condition|(
operator|(
name|pSGpioReq
operator|->
name|smpFrameType
operator|!=
name|SMP_REQUEST
operator|)
operator|||
expr|\
operator|(
operator|(
name|pSGpioReq
operator|->
name|function
operator|!=
name|SMP_READ_GPIO_REGISTER
operator|)
operator|&&
operator|(
name|pSGpioReq
operator|->
name|function
operator|!=
name|SMP_WRITE_GPIO_REGISTER
operator|)
operator|)
operator|||
expr|\
operator|(
name|pSGpioReq
operator|->
name|registerType
operator|>
name|AGSA_SGPIO_GENERAL_PURPOSE_TRANSMIT_REG
operator|)
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"Invalid Parameter\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Specific validation for configuration register type */
if|if
condition|(
name|AGSA_SGPIO_CONFIG_REG
operator|==
name|pSGpioReq
operator|->
name|registerType
condition|)
block|{
if|if
condition|(
operator|(
name|pSGpioReq
operator|->
name|registerIndex
operator|>
literal|0x01
operator|)
operator|||
expr|\
operator|(
operator|(
literal|0x00
operator|==
name|pSGpioReq
operator|->
name|registerIndex
operator|)
operator|&&
operator|(
name|pSGpioReq
operator|->
name|registerCount
operator|>
literal|0x02
operator|)
operator|)
operator|||
expr|\
operator|(
operator|(
literal|0x01
operator|==
name|pSGpioReq
operator|->
name|registerIndex
operator|)
operator|&&
operator|(
name|pSGpioReq
operator|->
name|registerCount
operator|>
literal|0x01
operator|)
operator|)
condition|)
block|{
break|break;
block|}
block|}
comment|/* Use FW control place in shared structure to keep the necessary information */
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|saSgpio
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
literal|0
argument_list|,
name|pSGpioReq
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
break|break;
block|}
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaGpioPinSetup: End\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * ostiSgpioIoctlRsp * * Purpose:  This routine is called when a SGPIO IOCTL response is received. * * Parameters: *   tiRoot:         Pointer to driver instance *   pSgpioResponse: Pointer to the SGPIO response * * Return: none * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiSgpioIoctlRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaSGpioReqResponse_t
modifier|*
name|pSgpioResponse
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIoctlPayload
init|=
name|agNULL
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ostiSgpioIoctlRsp: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
condition|)
block|{
name|agIoctlPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
if|if
condition|(
name|agIoctlPayload
condition|)
block|{
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|NULL
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|agIoctlPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
argument_list|,
name|pSgpioResponse
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSGpioReqResponse_t
argument_list|)
argument_list|)
expr_stmt|;
name|agIoctlPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|sgpioResponseSet
operator|=
literal|1
expr_stmt|;
block|}
name|tdsaAllShared
operator|->
name|sgpioResponseSet
operator|=
literal|1
expr_stmt|;
comment|//Sunitha:Check if needed?
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"ostiSgpioIoctlRsp: end\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * ostiCOMMgntIOCTLRsp * * Purpose:  This routine is called when FW control IOCTL reaponse has been received. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:          Pointer to driver instance *   payloadRsp:     Pointer to the FW download IOMB's payload. * * Return: none * * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiCOMMgntIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiCOMMgntIOCTLRsp: status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|tdFWControl
operator|)
operator|->
name|retcode
operator|=
name|status
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|tdFWControl
operator|->
name|len
argument_list|)
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * ostiRegDumpIOCTLRsp * * Purpose:  This routine is called when Register Dump from flash IOCTL reaponse has been received. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:          Pointer to driver instance *   payloadRsp:     Pointer to the FW download IOMB's payload. * * Return: none * * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiRegDumpIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiRegDumpIOCTLRsp: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|//    (tdsaAllShared->tdFWControlEx.tdFWControl)->retcode = status;
name|osti_memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|)
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * ostiSetNVMDIOCTLRsp * * Purpose:  This routine is called for Set NVMD IOCTL reaponse has been received. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:          Pointer to driver instance *   payloadRsp:     Pointer to the FW download IOMB's payload. * * Return: none * * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiSetNVMDIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
decl_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
operator|(
name|bit16
operator|)
name|status
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiSetNVMDIOCTLRsp: start, status = %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|//    (tdsaAllShared->tdFWControlEx.tdFWControl)->retcode = status;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SPC_ENABLE_PROFILE
end_ifdef

begin_comment
comment|/***************************************************************************** * * ostiFWProfileIOCTLRsp * * Purpose:  This routine is called for Fw Profile IOCTL reaponse has been received. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:          Pointer to driver instance *   status: * * Return: none * * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiFWProfileIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|len
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdFWProfile_t
modifier|*
name|fwProfile
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiFWProfileIOCTLRsp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fwProfile
operator|=
operator|(
name|tdFWProfile_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|tdFWProfile
expr_stmt|;
comment|//    (tdsaAllShared->tdFWControlEx.tdFWControl)->retcode = status;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|fwProfile
operator|->
name|cmd
operator|==
name|STOP_TIMER_PROFILE
operator|)
operator|||
operator|(
name|fwProfile
operator|->
name|cmd
operator|==
name|STOP_CODE_PROFILE
operator|)
condition|)
block|{
name|osti_memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|fwProfile
operator|->
name|buffer
operator|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|virtAddr
operator|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
block|}
name|fwProfile
operator|->
name|status
operator|=
name|status
expr_stmt|;
name|fwProfile
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** * * ostiGetNVMDIOCTLRsp * * Purpose:  This routine is called for Get NVMD IOCTL reaponse has been received. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:          Pointer to driver instance *   payloadRsp:     Pointer to the FW download IOMB's payload. * * Return: none * * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiGetNVMDIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
decl_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
operator|(
name|bit16
operator|)
name|status
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetNVMDIOCTLRsp: start, status = %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|NvmdResponseSet
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|!=
name|agNULL
condition|)
block|{
name|osti_memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|)
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** * * ostiGetPhyProfileIOCTLRsp * * Purpose:  This routine is called for phy response has been received. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:          Pointer to driver instance *   payloadRsp:     Pointer to the IOMB's payload. * * Return: none * * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiGetPhyProfileIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
decl_stmt|;
name|tdPhyCount_t
modifier|*
name|PhyBlob
init|=
name|agNULL
decl_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
operator|(
name|bit16
operator|)
name|status
expr_stmt|;
name|PhyBlob
operator|=
operator|(
name|tdPhyCount_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|PhyBlob
condition|)
block|{
comment|//        PhyBlob->Phy |= 0x800;
if|if
condition|(
name|PhyBlob
operator|->
name|phyResetProblem
operator|==
literal|0
condition|)
block|{
name|PhyBlob
operator|->
name|phyResetProblem
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyProfileIOCTLRsp: PhyBlob->Phy                   0x%x\n"
operator|,
name|PhyBlob
operator|->
name|Phy
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyProfileIOCTLRsp: PhyBlob->BW_rx                 0x%x\n"
operator|,
name|PhyBlob
operator|->
name|BW_rx
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyProfileIOCTLRsp: PhyBlob->BW_tx                 0x%x\n"
operator|,
name|PhyBlob
operator|->
name|BW_tx
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyProfileIOCTLRsp: PhyBlob->InvalidDword          0x%x\n"
operator|,
name|PhyBlob
operator|->
name|InvalidDword
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyProfileIOCTLRsp: PhyBlob->runningDisparityError 0x%x\n"
operator|,
name|PhyBlob
operator|->
name|runningDisparityError
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyProfileIOCTLRsp: PhyBlob->codeViolation         0x%x\n"
operator|,
name|PhyBlob
operator|->
name|codeViolation
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyProfileIOCTLRsp: PhyBlob->phyResetProblem       0x%x\n"
operator|,
name|PhyBlob
operator|->
name|phyResetProblem
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyProfileIOCTLRsp: PhyBlob->inboundCRCError       0x%x\n"
operator|,
name|PhyBlob
operator|->
name|inboundCRCError
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyProfileIOCTLRsp: start, status = %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyProfileIOCTLRsp: start, len = %d %p %p\n"
operator|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|)
argument_list|)
expr_stmt|;
comment|//    osti_memcpy((void *)(tdsaAllShared->tdFWControlEx.usrAddr),
comment|//                (void *)(tdsaAllShared->tdFWControlEx.virtAddr),
comment|//                 tdsaAllShared->tdFWControlEx.len);
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * ostiGenEventIOCTLRsp * * Purpose:  This routine is called when General Event happened while waiting for IOCTL response. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:          Pointer to driver instance *   payloadRsp:     Pointer to the FW download IOMB's payload. * * Return: none * * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiGenEventIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGenEventIOCTLRsp: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
condition|)
comment|/*Free only if our IOCTL is in progress*/
block|{
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|tdFWControl
operator|)
operator|->
name|retcode
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SPC_ENABLE_PROFILE
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|inProgress
condition|)
block|{
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|payload
operator|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|virtAddr
operator|!=
name|NULL
condition|)
comment|/*Free only if our IOCTL is in progress*/
block|{
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|virtAddr
operator|=
name|NULL
expr_stmt|;
block|}
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWProfileEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/*SPC_ENABLE_PROFILE*/
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ostiGetDeviceInfoIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|,
name|void
modifier|*
name|param
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
init|=
name|agNULL
decl_stmt|;
name|tdDeviceInfoPayload_t
modifier|*
name|pTDDeviceInfo
init|=
name|agNULL
decl_stmt|;
name|agsaDeviceInfo_t
modifier|*
name|pSADeviceInfo
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetDeviceInfoIOCTLRsp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
name|pSADeviceInfo
operator|=
operator|(
name|agsaDeviceInfo_t
operator|*
operator|)
name|param
expr_stmt|;
name|pTDDeviceInfo
operator|=
operator|(
name|tdDeviceInfoPayload_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
if|if
condition|(
name|pSADeviceInfo
operator|!=
name|agNULL
condition|)
block|{
comment|/* fill the device information in IOCTL payload */
name|osti_memcpy
argument_list|(
operator|&
name|pTDDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressHi
argument_list|,
name|pSADeviceInfo
operator|->
name|sasAddressHi
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|pTDDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressLo
argument_list|,
name|pSADeviceInfo
operator|->
name|sasAddressLo
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|pTDDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressHi
operator|=
name|DMA_BEBIT32_TO_BIT32
argument_list|(
name|pTDDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressHi
argument_list|)
expr_stmt|;
name|pTDDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressLo
operator|=
name|DMA_BEBIT32_TO_BIT32
argument_list|(
name|pTDDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
name|pTDDeviceInfo
operator|->
name|devInfo
operator|.
name|deviceType
operator|=
operator|(
name|pSADeviceInfo
operator|->
name|devType_S_Rate
operator|&
literal|0x30
operator|)
operator|>>
literal|4
expr_stmt|;
name|pTDDeviceInfo
operator|->
name|devInfo
operator|.
name|linkRate
operator|=
name|pSADeviceInfo
operator|->
name|devType_S_Rate
operator|&
literal|0x0F
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
block|}
else|else
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INVALID_DEVICE
expr_stmt|;
block|}
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
condition|)
comment|/*Free only if our IOCTL is in progress*/
block|{
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_function
name|osGLOBAL
name|void
name|ostiGetIoErrorStatsIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|,
name|void
modifier|*
name|param
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
init|=
name|agNULL
decl_stmt|;
name|tdIoErrorStatisticPayload_t
modifier|*
name|pIoErrorPayload
init|=
name|agNULL
decl_stmt|;
name|agsaIOErrorEventStats_t
modifier|*
name|pIoErrorCount
init|=
name|agNULL
decl_stmt|;
name|OS_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|agsaIOErrorEventStats_t
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|tdIoErrorEventStatisticIOCTL_t
argument_list|)
argument_list|,
literal|"agsaIOErrorEventStats_t tdIoErrorEventStatisticIOCTL_t\n"
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetIoErrorStatsIOCTLRsp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
name|pIoErrorPayload
operator|=
operator|(
name|tdIoErrorStatisticPayload_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
name|pIoErrorCount
operator|=
operator|(
name|agsaIOErrorEventStats_t
operator|*
operator|)
name|param
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|pIoErrorPayload
operator|->
name|IoError
argument_list|,
name|pIoErrorCount
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaIOErrorEventStats_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*copy SCSI status and sense key count from OS layer to TD layer*/
name|osti_memcpy
argument_list|(
operator|&
name|pIoErrorPayload
operator|->
name|ScsiStatusCounter
argument_list|,
operator|&
name|Initiator
operator|->
name|ScsiStatusCounts
argument_list|,
sizeof|sizeof
argument_list|(
name|tdSCSIStatusCount_t
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|pIoErrorPayload
operator|->
name|SenseKeyCounter
argument_list|,
operator|&
name|Initiator
operator|->
name|SenseKeyCounter
argument_list|,
sizeof|sizeof
argument_list|(
name|tdSenseKeyCount_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pIoErrorPayload
operator|->
name|flag
condition|)
block|{
name|osti_memset
argument_list|(
operator|&
name|Initiator
operator|->
name|ScsiStatusCounts
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdSCSIStatusCount_t
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|Initiator
operator|->
name|SenseKeyCounter
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdSenseKeyCount_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INITIATOR_DRIVER */
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiGetIoEventStatsIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|,
name|void
modifier|*
name|param
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
init|=
name|agNULL
decl_stmt|;
name|tdIoEventStatisticPayload_t
modifier|*
name|pIoEventPayload
init|=
name|agNULL
decl_stmt|;
name|agsaIOErrorEventStats_t
modifier|*
name|pIoEventCount
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetIoEventStatsIOCTLRsp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
name|pIoEventPayload
operator|=
operator|(
name|tdIoEventStatisticPayload_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
name|pIoEventCount
operator|=
operator|(
name|agsaIOErrorEventStats_t
operator|*
operator|)
name|param
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|pIoEventPayload
operator|->
name|IoEvent
argument_list|,
name|pIoEventCount
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaIOErrorEventStats_t
argument_list|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ostiGetForensicDataIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|,
name|void
modifier|*
name|param
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
init|=
name|agNULL
decl_stmt|;
name|tdForensicDataPayload_t
modifier|*
name|pForensicDataPayload
init|=
name|agNULL
decl_stmt|;
name|agsaForensicData_t
modifier|*
name|pForensicData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ostiGetForensicDataIOCTLRsp: start, status = %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
name|pForensicDataPayload
operator|=
operator|(
name|tdForensicDataPayload_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
name|pForensicData
operator|=
operator|(
name|agsaForensicData_t
operator|*
operator|)
name|param
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|agIOCTLPayload
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|FORENSIC_DATA_TYPE_CHECK_FATAL
operator|==
name|pForensicData
operator|->
name|DataType
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
operator|(
name|bit16
operator|)
name|status
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
switch|switch
condition|(
name|pForensicData
operator|->
name|DataType
condition|)
block|{
case|case
name|FORENSIC_DATA_TYPE_NON_FATAL
case|:
case|case
name|FORENSIC_DATA_TYPE_FATAL
case|:
name|pForensicDataPayload
operator|->
name|dataBuffer
operator|.
name|directOffset
operator|=
name|pForensicData
operator|->
name|BufferType
operator|.
name|dataBuf
operator|.
name|directOffset
expr_stmt|;
name|pForensicDataPayload
operator|->
name|dataBuffer
operator|.
name|readLen
operator|=
name|pForensicData
operator|->
name|BufferType
operator|.
name|dataBuf
operator|.
name|readLen
expr_stmt|;
break|break;
case|case
name|FORENSIC_DATA_TYPE_GSM_SPACE
case|:
name|pForensicDataPayload
operator|->
name|gsmBuffer
operator|.
name|directOffset
operator|=
name|pForensicData
operator|->
name|BufferType
operator|.
name|gsmBuf
operator|.
name|directOffset
expr_stmt|;
name|pForensicDataPayload
operator|->
name|gsmBuffer
operator|.
name|readLen
operator|=
name|pForensicData
operator|->
name|BufferType
operator|.
name|gsmBuf
operator|.
name|readLen
expr_stmt|;
break|break;
case|case
name|FORENSIC_DATA_TYPE_QUEUE
case|:
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetForensicDataIOCTLRsp: forensic data type error %d\n"
operator|,
name|pForensicData
operator|->
name|DataType
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|IOCTL_ERROR_NO_FATAL_ERROR
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
operator|(
name|bit16
operator|)
name|status
expr_stmt|;
block|}
else|else
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
block|}
comment|/*Free only if our IOCTL is in progress*/
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"ostiGetForensicDataIOCTLRsp: Waiting for the signal \n"
operator|)
argument_list|)
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ostiGetForensicDataIOCTLRsp: Signal wait completed \n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tdsaRegDumpGetIoctl * * Purpose:  This routine is called to get Register Dump information. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaRegDumpGetIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
comment|//    agsaControllerStatus_t RegDump;
name|bit32
name|Offset
init|=
literal|0
decl_stmt|;
name|bit32
name|RequestLength
init|=
literal|0
decl_stmt|;
comment|/* user request on how much data to pass to application */
name|agsaRegDumpInfo_t
name|regDumpInfo
decl_stmt|;
name|void
modifier|*
name|buffer
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|osMemHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|bit32
name|CoreDumpLength
init|=
literal|16384
decl_stmt|;
comment|/* change it once data is available */
name|bit32
name|EventLogOffset
init|=
literal|65536
decl_stmt|;
comment|///saGetControllerStatus(agRoot,&RegDump);
comment|/* length of FSA as provided by application */
name|RequestLength
operator|=
name|agIOCTLPayload
operator|->
name|Length
expr_stmt|;
comment|///    FunctionSpecificOffset = 0; /* Offset into the FunctionSpecificArea of payload */
comment|/* offset into core dump that was passed from application */
name|Offset
operator|=
name|agIOCTLPayload
operator|->
name|Reserved
expr_stmt|;
if|if
condition|(
operator|(
name|CoreDumpLength
operator|<=
name|Offset
operator|)
operator|&&
operator|(
name|agIOCTLPayload
operator|->
name|MinorFunction
operator|!=
name|IOCTL_MN_FW_GET_EVENT_FLASH_LOG1
operator|)
operator|&&
operator|(
name|agIOCTLPayload
operator|->
name|MinorFunction
operator|!=
name|IOCTL_MN_FW_GET_EVENT_FLASH_LOG2
operator|)
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NO_MORE_DATA
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Length
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
return|return
name|status
return|;
block|}
name|regDumpInfo
operator|.
name|regDumpOffset
operator|=
name|Offset
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
comment|/* dump either aap1 or iop registers */
switch|switch
condition|(
name|agIOCTLPayload
operator|->
name|MinorFunction
condition|)
block|{
comment|/*Coredump*/
case|case
name|IOCTL_MN_FW_GET_CORE_DUMP_AAP1
case|:
comment|//CoreDumpBAROffset = RegDump.fatalErrorInfo.regDumpOffset0;    /* get this from mpi config table */
comment|//CoreDumpLength = RegDump.fatalErrorInfo.regDumpLen0;
comment|/*changes for added Call back*/
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|regDumpInfo
operator|.
name|regDumpSrc
operator|=
literal|0
expr_stmt|;
name|regDumpInfo
operator|.
name|regDumpNum
operator|=
literal|0
expr_stmt|;
name|regDumpInfo
operator|.
name|directLen
operator|=
name|RequestLength
expr_stmt|;
name|regDumpInfo
operator|.
name|directData
operator|=
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
comment|/*changes for added Call back*/
comment|//status = IOCTL_CALL_SUCCESS;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
break|break;
case|case
name|IOCTL_MN_FW_GET_CORE_DUMP_IOP
case|:
comment|//CoreDumpBAROffset = RegDump.fatalErrorInfo.regDumpOffset1;    /* get this from mpi config table */
comment|//CoreDumpLength = RegDump.fatalErrorInfo.regDumpLen1;
comment|/*changes for added Call back*/
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|regDumpInfo
operator|.
name|regDumpSrc
operator|=
literal|0
expr_stmt|;
name|regDumpInfo
operator|.
name|regDumpNum
operator|=
literal|1
expr_stmt|;
name|regDumpInfo
operator|.
name|directLen
operator|=
name|RequestLength
expr_stmt|;
name|regDumpInfo
operator|.
name|directData
operator|=
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
comment|/*changes for added Call back*/
comment|//status = IOCTL_CALL_SUCCESS;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
break|break;
case|case
name|IOCTL_MN_FW_GET_CORE_DUMP_FLASH_AAP1
case|:
name|regDumpInfo
operator|.
name|regDumpSrc
operator|=
literal|1
expr_stmt|;
name|regDumpInfo
operator|.
name|regDumpNum
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|RequestLength
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|buffer
argument_list|,
operator|&
operator|(
name|regDumpInfo
operator|.
name|indirectAddrUpper32
operator|)
argument_list|,
operator|&
operator|(
name|regDumpInfo
operator|.
name|indirectAddrLower32
operator|)
argument_list|,
literal|8
argument_list|,
name|RequestLength
argument_list|,
name|agFALSE
argument_list|)
condition|)
return|return
name|IOCTL_CALL_FAIL
return|;
block|}
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
literal|0
argument_list|,
name|RequestLength
argument_list|)
expr_stmt|;
name|regDumpInfo
operator|.
name|indirectLen
operator|=
name|RequestLength
expr_stmt|;
comment|// use FW control place in shared structure to keep the neccesary information
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|buffer
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
name|RequestLength
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
break|break;
case|case
name|IOCTL_MN_FW_GET_CORE_DUMP_FLASH_IOP
case|:
name|regDumpInfo
operator|.
name|regDumpSrc
operator|=
literal|1
expr_stmt|;
name|regDumpInfo
operator|.
name|regDumpNum
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|RequestLength
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|buffer
argument_list|,
operator|&
operator|(
name|regDumpInfo
operator|.
name|indirectAddrUpper32
operator|)
argument_list|,
operator|&
operator|(
name|regDumpInfo
operator|.
name|indirectAddrLower32
operator|)
argument_list|,
literal|8
argument_list|,
name|RequestLength
argument_list|,
name|agFALSE
argument_list|)
condition|)
return|return
name|IOCTL_CALL_FAIL
return|;
block|}
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
literal|0
argument_list|,
name|RequestLength
argument_list|)
expr_stmt|;
name|regDumpInfo
operator|.
name|indirectLen
operator|=
name|RequestLength
expr_stmt|;
comment|// use FW control place in shared structure to keep the neccesary information
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|buffer
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
name|RequestLength
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
break|break;
comment|/*EventLog from Flash*/
case|case
name|IOCTL_MN_FW_GET_EVENT_FLASH_LOG1
case|:
comment|//aap1 Eventlog
if|if
condition|(
name|CoreDumpLength
operator|+
name|EventLogOffset
operator|<=
name|Offset
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NO_MORE_DATA
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Length
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
return|return
name|status
return|;
block|}
name|regDumpInfo
operator|.
name|regDumpSrc
operator|=
literal|1
expr_stmt|;
name|regDumpInfo
operator|.
name|regDumpNum
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|RequestLength
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|buffer
argument_list|,
operator|&
operator|(
name|regDumpInfo
operator|.
name|indirectAddrUpper32
operator|)
argument_list|,
operator|&
operator|(
name|regDumpInfo
operator|.
name|indirectAddrLower32
operator|)
argument_list|,
literal|8
argument_list|,
name|RequestLength
argument_list|,
name|agFALSE
argument_list|)
condition|)
return|return
name|IOCTL_CALL_FAIL
return|;
block|}
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
literal|0
argument_list|,
name|RequestLength
argument_list|)
expr_stmt|;
name|regDumpInfo
operator|.
name|indirectLen
operator|=
name|RequestLength
expr_stmt|;
comment|// use FW control place in shared structure to keep the neccesary information
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|buffer
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
name|RequestLength
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
break|break;
case|case
name|IOCTL_MN_FW_GET_EVENT_FLASH_LOG2
case|:
comment|//iop Eventlog
if|if
condition|(
name|CoreDumpLength
operator|+
name|EventLogOffset
operator|<=
name|Offset
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NO_MORE_DATA
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Length
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
return|return
name|status
return|;
block|}
name|regDumpInfo
operator|.
name|regDumpSrc
operator|=
literal|1
expr_stmt|;
name|regDumpInfo
operator|.
name|regDumpNum
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|RequestLength
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|buffer
argument_list|,
operator|&
operator|(
name|regDumpInfo
operator|.
name|indirectAddrUpper32
operator|)
argument_list|,
operator|&
operator|(
name|regDumpInfo
operator|.
name|indirectAddrLower32
operator|)
argument_list|,
literal|8
argument_list|,
name|RequestLength
argument_list|,
name|agFALSE
argument_list|)
condition|)
return|return
name|IOCTL_CALL_FAIL
return|;
block|}
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
literal|0
argument_list|,
name|RequestLength
argument_list|)
expr_stmt|;
name|regDumpInfo
operator|.
name|indirectLen
operator|=
name|RequestLength
expr_stmt|;
comment|// use FW control place in shared structure to keep the neccesary information
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|buffer
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
name|RequestLength
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|IOCTL_CALL_INVALID_CODE
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: ERROR: Wrong IOCTL code %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|MinorFunction
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|saGetRegisterDump
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
operator|&
name|regDumpInfo
argument_list|)
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ostiCOMMgntVPDSetIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
comment|//    agsaRoot_t    *agRoot =&(tdsaAllShared->agRootInt);
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiCOMMgntVPDSetIOCTLRsp: start\n"
operator|)
argument_list|)
expr_stmt|;
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|tdFWControl
operator|)
operator|->
name|retcode
operator|=
name|status
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tdsaNVMDSetIoctl * * Purpose:  This routine is called to set Config. SEEPROM information. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaNVMDSetIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|bit32
name|RequestLength
init|=
literal|0
decl_stmt|;
name|bit32
name|bufAddrUpper
init|=
literal|0
decl_stmt|;
name|bit32
name|bufAddrLower
init|=
literal|0
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|void
modifier|*
name|buffer
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|osMemHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|agsaNVMDData_t
name|nvmdInfo
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaNVMDSetIoctl: start\n"
operator|)
argument_list|)
expr_stmt|;
name|RequestLength
operator|=
name|agIOCTLPayload
operator|->
name|Length
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|nvmdInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaNVMDData_t
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|agIOCTLPayload
operator|->
name|MinorFunction
condition|)
block|{
case|case
name|IOCTL_MN_NVMD_SET_CONFIG
case|:
comment|//nvmdInfo.NVMDevice = 1;
name|nvmdInfo
operator|.
name|NVMDevice
operator|=
operator|*
operator|(
operator|(
name|bit8
operator|*
operator|)
name|agParam3
operator|)
expr_stmt|;
name|nvmdInfo
operator|.
name|signature
operator|=
literal|0xFEDCBA98
expr_stmt|;
name|nvmdInfo
operator|.
name|dataOffsetAddress
operator|=
name|agIOCTLPayload
operator|->
name|Reserved
expr_stmt|;
name|nvmdInfo
operator|.
name|indirectPayload
operator|=
literal|1
expr_stmt|;
name|nvmdInfo
operator|.
name|indirectLen
operator|=
name|RequestLength
expr_stmt|;
if|if
condition|(
name|nvmdInfo
operator|.
name|NVMDevice
operator|==
literal|0
condition|)
block|{
name|nvmdInfo
operator|.
name|TWIDeviceAddress
operator|=
literal|0xa0
expr_stmt|;
name|nvmdInfo
operator|.
name|TWIBusNumber
operator|=
literal|0
expr_stmt|;
name|nvmdInfo
operator|.
name|TWIDevicePageSize
operator|=
literal|0
expr_stmt|;
name|nvmdInfo
operator|.
name|TWIDeviceAddressSize
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|RequestLength
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|buffer
argument_list|,
operator|&
name|bufAddrUpper
argument_list|,
operator|&
name|bufAddrLower
argument_list|,
literal|8
argument_list|,
name|RequestLength
argument_list|,
name|agFALSE
argument_list|)
condition|)
return|return
name|IOCTL_CALL_FAIL
return|;
block|}
else|else
block|{
return|return
name|IOCTL_CALL_FAIL
return|;
block|}
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
literal|0
argument_list|,
name|RequestLength
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
argument_list|,
name|RequestLength
argument_list|)
expr_stmt|;
name|nvmdInfo
operator|.
name|indirectAddrLower32
operator|=
name|bufAddrLower
expr_stmt|;
name|nvmdInfo
operator|.
name|indirectAddrUpper32
operator|=
name|bufAddrUpper
expr_stmt|;
comment|// use FW control place in shared structure to keep the neccesary information
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|buffer
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
name|RequestLength
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|IOCTL_CALL_INVALID_CODE
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaNVMDSetIoctl: ERROR: Wrong IOCTL code %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|MinorFunction
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|saSetNVMDCommand
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
operator|&
name|nvmdInfo
argument_list|)
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tdsaNVMDGetIoctl * * Purpose:  This routine is called to get Config. SEEPROM information. *           This function is used for both target and initiator. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaNVMDGetIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|void
modifier|*
name|buffer
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|osMemHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|agsaNVMDData_t
name|nvmdInfo
decl_stmt|;
name|bit32
name|Offset
init|=
literal|0
decl_stmt|;
name|bit32
name|RequestLength
init|=
literal|0
decl_stmt|;
name|bit32
name|ostiMemoryStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bit8
modifier|*
name|seepromBuffer
decl_stmt|;
name|bit8
modifier|*
name|phySettingsBuffer
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaNVMDGetIoctl: start\n"
operator|)
argument_list|)
expr_stmt|;
name|RequestLength
operator|=
name|agIOCTLPayload
operator|->
name|Length
expr_stmt|;
name|Offset
operator|=
name|agIOCTLPayload
operator|->
name|Reserved
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|nvmdInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaNVMDData_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* This condition is not valid for direct read so commenting */
comment|/*if(!tiIS_SPC(agRoot)) {      if( RequestLength<= Offset ) //4096-max seeprom size      {     	agIOCTLPayload->Status = IOCTL_ERR_STATUS_NO_MORE_DATA;     	agIOCTLPayload->Length = 0;     	status=IOCTL_CALL_SUCCESS;     	return status;      }   }*/
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
switch|switch
condition|(
name|agIOCTLPayload
operator|->
name|MinorFunction
condition|)
block|{
case|case
name|IOCTL_MN_NVMD_GET_CONFIG
case|:
comment|//   nvmdInfo.NVMDevice = 1;
name|nvmdInfo
operator|.
name|NVMDevice
operator|=
operator|*
operator|(
operator|(
name|bit8
operator|*
operator|)
name|agParam3
operator|)
expr_stmt|;
name|nvmdInfo
operator|.
name|signature
operator|=
literal|0xFEDCBA98
expr_stmt|;
name|nvmdInfo
operator|.
name|dataOffsetAddress
operator|=
name|Offset
expr_stmt|;
name|nvmdInfo
operator|.
name|indirectPayload
operator|=
literal|1
expr_stmt|;
name|nvmdInfo
operator|.
name|indirectLen
operator|=
name|RequestLength
expr_stmt|;
if|if
condition|(
name|nvmdInfo
operator|.
name|NVMDevice
operator|==
literal|0
condition|)
block|{
name|nvmdInfo
operator|.
name|TWIDeviceAddress
operator|=
literal|0xa0
expr_stmt|;
name|nvmdInfo
operator|.
name|TWIBusNumber
operator|=
literal|0
expr_stmt|;
name|nvmdInfo
operator|.
name|TWIDevicePageSize
operator|=
literal|0
expr_stmt|;
name|nvmdInfo
operator|.
name|TWIDeviceAddressSize
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|RequestLength
operator|!=
literal|0
condition|)
block|{
name|ostiMemoryStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|buffer
argument_list|,
operator|&
operator|(
name|nvmdInfo
operator|.
name|indirectAddrUpper32
operator|)
argument_list|,
operator|&
operator|(
name|nvmdInfo
operator|.
name|indirectAddrLower32
operator|)
argument_list|,
literal|8
argument_list|,
name|RequestLength
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ostiMemoryStatus
operator|!=
name|tiSuccess
operator|)
operator|&&
operator|(
name|buffer
operator|==
name|agNULL
operator|)
condition|)
return|return
name|IOCTL_CALL_FAIL
return|;
block|}
else|else
block|{
return|return
name|IOCTL_CALL_FAIL
return|;
block|}
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
literal|0
argument_list|,
name|RequestLength
argument_list|)
expr_stmt|;
comment|// use FW control place in shared structure to keep the neccesary information
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|buffer
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
name|RequestLength
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|IOCTL_CALL_INVALID_CODE
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiCOMMgntIOCTL: ERROR: Wrong IOCTL code %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|MinorFunction
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|tdsaAllShared
operator|->
name|NvmdResponseSet
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|saGetNVMDCommand
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
operator|&
name|nvmdInfo
argument_list|)
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Copy the SAS address */
if|if
condition|(
name|agParam1
operator|==
name|agNULL
condition|)
block|{
while|while
condition|(
operator|!
name|tdsaAllShared
operator|->
name|NvmdResponseSet
condition|)
block|{
comment|//	tiCOMDelayedInterruptHandler(tiRoot, 0, 1, tiNonInterruptContext);
block|}
if|if
condition|(
name|nvmdInfo
operator|.
name|NVMDevice
operator|==
literal|4
operator|||
name|nvmdInfo
operator|.
name|NVMDevice
operator|==
literal|1
condition|)
block|{
name|seepromBuffer
operator|=
name|buffer
expr_stmt|;
comment|/*Get Initiator SAS address*/
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|i
operator|=
name|ADAPTER_WWN_SPC_START_OFFSET
init|;
name|i
operator|<=
name|ADAPTER_WWN_SPC_END_OFFSET
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
name|j
index|]
operator|=
name|seepromBuffer
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|i
operator|=
name|ADAPTER_WWN_START_OFFSET
init|;
name|i
operator|<=
name|ADAPTER_WWN_END_OFFSET
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
name|j
index|]
operator|=
name|seepromBuffer
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
comment|/* Copy the Phy settings */
elseif|else
if|if
condition|(
name|nvmdInfo
operator|.
name|NVMDevice
operator|==
literal|6
condition|)
block|{
name|phySettingsBuffer
operator|=
name|buffer
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PHY_SETTINGS_LEN
condition|;
name|i
operator|++
control|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
name|i
index|]
operator|=
name|phySettingsBuffer
index|[
name|i
index|]
expr_stmt|;
block|}
name|tdsaAllShared
operator|->
name|NvmdResponseSet
operator|=
literal|0
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tdsaDeviceInfoGetIoctl * * Purpose:  This routine is called to get the specified device information. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaDeviceInfoGetIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdDeviceInfoPayload_t
modifier|*
name|pDeviceInfo
init|=
name|agNULL
decl_stmt|;
comment|/*agsaDevHandle_t  *agDevHandle = agNULL;*/
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|pDeviceInfo
operator|=
operator|(
name|tdDeviceInfoPayload_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDeviceInfoGetIoctl: %d:%3d:%d %p %p %p\n"
operator|,
operator|(
name|bit8
operator|)
name|pDeviceInfo
operator|->
name|PathId
operator|,
operator|(
name|bit8
operator|)
name|pDeviceInfo
operator|->
name|TargetId
operator|,
operator|(
name|bit8
operator|)
name|pDeviceInfo
operator|->
name|Lun
operator|,
name|agParam1
operator|,
name|agParam2
operator|,
name|agParam3
operator|)
argument_list|)
expr_stmt|;
name|tiDeviceHandle
operator|=
name|ostiMapToDevHandle
argument_list|(
name|tiRoot
argument_list|,
operator|(
name|bit8
operator|)
name|pDeviceInfo
operator|->
name|PathId
argument_list|,
operator|(
name|bit8
operator|)
name|pDeviceInfo
operator|->
name|TargetId
argument_list|,
operator|(
name|bit8
operator|)
name|pDeviceInfo
operator|->
name|Lun
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeviceInfoGetIoctl: tiDeviceHandle is NULL !!!! SCSI address = %d:%3d:%d\n"
operator|,
name|pDeviceInfo
operator|->
name|PathId
operator|,
name|pDeviceInfo
operator|->
name|TargetId
operator|,
name|pDeviceInfo
operator|->
name|Lun
operator|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INVALID_DEVICE
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
return|return
name|status
return|;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeviceInfoGetIoctl: tiDeviceHandle=%p DeviceData is NULL!!! SCSI address = %d:%3d:%d\n"
operator|,
name|tiDeviceHandle
operator|,
name|pDeviceInfo
operator|->
name|PathId
operator|,
name|pDeviceInfo
operator|->
name|TargetId
operator|,
name|pDeviceInfo
operator|->
name|Lun
operator|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INVALID_DEVICE
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* for hotplug */
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|registered
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeviceInfoGetIoctl: tiDeviceHandle=%p did %d DeviceData was removed!!! SCSI address = %d:%3d:%d\n"
operator|,
name|tiDeviceHandle
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|pDeviceInfo
operator|->
name|PathId
operator|,
name|pDeviceInfo
operator|->
name|TargetId
operator|,
name|pDeviceInfo
operator|->
name|Lun
operator|)
argument_list|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INVALID_DEVICE
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* fill the device information in IOCTL payload */
name|pDeviceInfo
operator|->
name|devInfo
operator|.
name|phyId
operator|=
name|oneDeviceData
operator|->
name|phyID
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|pDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressHi
argument_list|,
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|sasAddressHi
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|pDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressLo
argument_list|,
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|sasAddressLo
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|pDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressHi
operator|=
name|DMA_BEBIT32_TO_BIT32
argument_list|(
name|pDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressHi
argument_list|)
expr_stmt|;
name|pDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressLo
operator|=
name|DMA_BEBIT32_TO_BIT32
argument_list|(
name|pDeviceInfo
operator|->
name|devInfo
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
name|pDeviceInfo
operator|->
name|devInfo
operator|.
name|deviceType
operator|=
operator|(
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
operator|&
literal|0x30
operator|)
operator|>>
literal|4
expr_stmt|;
name|pDeviceInfo
operator|->
name|devInfo
operator|.
name|linkRate
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
operator|&
literal|0x0F
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDeviceInfoGetIoctl:IOCTL_CALL_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*saGetDeviceInfo(agRoot, agNULL, 0, 0, agDevHandle);*/
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tdsaIoErrorStatisticGetIoctl * * Purpose:  This routine is called to get the IO error statistic. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaIoErrorStatisticGetIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|tdIoErrorStatisticPayload_t
modifier|*
name|pIoErrorPayload
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|pIoErrorPayload
operator|=
operator|(
name|tdIoErrorStatisticPayload_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|agNULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|agNULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|saGetIOErrorStats
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|pIoErrorPayload
operator|->
name|flag
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tdsaIoEventStatisticGetIoctl * * Purpose:  This routine is called to get the IO event statistic. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaIoEventStatisticGetIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|tdIoEventStatisticPayload_t
modifier|*
name|pIoEventPayload
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|pIoEventPayload
operator|=
operator|(
name|tdIoEventStatisticPayload_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|agNULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|agNULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|saGetIOEventStats
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|pIoEventPayload
operator|->
name|flag
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tdsaRegisterIoctl * * Purpose:  This routine is called to get Forensic Data. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaRegisterIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
comment|//  agsaRoot_t                  *agRoot          =&(tdsaAllShared->agRootInt);
name|tdRegisterPayload_t
modifier|*
name|pRegisterPayload
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|pRegisterPayload
operator|=
operator|(
name|tdRegisterPayload_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|agNULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|agNULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaRegisterIoctl: Flag %d RegAddr 0x%x RegValue 0x%x\n"
operator|,
name|pRegisterPayload
operator|->
name|flag
operator|,
name|pRegisterPayload
operator|->
name|RegAddr
operator|,
name|pRegisterPayload
operator|->
name|RegValue
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRegisterPayload
operator|->
name|flag
condition|)
block|{
comment|/* set register */
name|ostiChipWriteBit32Ext
argument_list|(
name|tiRoot
argument_list|,
literal|0
argument_list|,
name|pRegisterPayload
operator|->
name|RegAddr
argument_list|,
name|pRegisterPayload
operator|->
name|RegValue
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* get register */
name|pRegisterPayload
operator|->
name|RegValue
operator|=
name|ostiChipReadBit32Ext
argument_list|(
name|tiRoot
argument_list|,
literal|0
argument_list|,
name|pRegisterPayload
operator|->
name|RegAddr
argument_list|)
expr_stmt|;
block|}
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tdsaGetPhyGeneralStatusIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaPhyGeneralState_t
modifier|*
name|PhyData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
decl_stmt|;
comment|//  agsaLLRoot_t	            *saRoot = (agsaLLRoot_t *)(agRoot->sdkData);
comment|//  bit8                      totalValidPhys;
name|bit32
name|status
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|bit32
name|i
init|=
literal|0
decl_stmt|;
name|agsaControllerInfo_t
name|ControllerInfo
decl_stmt|;
name|saGetControllerInfo
argument_list|(
name|agRoot
argument_list|,
operator|&
name|ControllerInfo
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaGetPhyGeneralStatusIoctl: start\n"
operator|)
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
name|tIsSPC
argument_list|(
name|agRoot
argument_list|)
operator|||
name|tIsSPCHIL
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|status
operator|=
name|IOCTL_ERR_STATUS_NOT_SUPPORTED
expr_stmt|;
break|break;
block|}
name|PhyData
operator|->
name|Reserved1
operator|=
name|ControllerInfo
operator|.
name|phyCount
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PhyData
operator|->
name|Reserved1
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|saGetPhyProfile
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|)
argument_list|,
name|AGSA_SAS_PHY_GENERAL_STATUS_PAGE
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
break|break;
block|}
block|}
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaGetPhyGeneralStatusIoctl: End\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * ostiGetPhyGeneralStatusRsp * * Purpose:  This routine is called when a PhyStatus IOCTL response is received. * * Parameters: *   tiRoot:         Pointer to driver instance *   agsaSASPhyGeneralStatusPage_t:   Status of the phy. *   bit32:          phyID * * Return: none * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiGetPhyGeneralStatusRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaSASPhyGeneralStatusPage_t
modifier|*
name|GenStatus
parameter_list|,
name|bit32
name|phyID
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIoctlPayload
init|=
name|agNULL
decl_stmt|;
name|agsaPhyGeneralState_t
modifier|*
name|pSetPhyStatusRes
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyGeneralStatusRsp: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
condition|)
block|{
name|agIoctlPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|agIoctlPayload
operator|)
operator|&&
operator|(
name|PMC_IOCTL_SIGNATURE
operator|==
name|agIoctlPayload
operator|->
name|Signature
operator|)
operator|&&
operator|(
name|IOCTL_MJ_PHY_GENERAL_STATUS
operator|==
name|agIoctlPayload
operator|->
name|MajorFunction
operator|)
condition|)
block|{
name|pSetPhyStatusRes
operator|=
operator|(
name|agsaPhyGeneralState_t
operator|*
operator|)
operator|&
name|agIoctlPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|pSetPhyStatusRes
operator|->
name|PhyGenData
index|[
name|phyID
index|]
argument_list|,
name|GenStatus
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASPhyGeneralStatusPage_t
argument_list|)
argument_list|)
expr_stmt|;
name|pSetPhyStatusRes
operator|->
name|Reserved2
operator|++
expr_stmt|;
if|if
condition|(
name|pSetPhyStatusRes
operator|->
name|Reserved1
operator|==
name|pSetPhyStatusRes
operator|->
name|Reserved2
condition|)
block|{
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|NULL
expr_stmt|;
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|agIoctlPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
block|}
block|}
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiGetPhyGeneralStatusRsp: end\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tdsaPhyProfileIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|void
modifier|*
name|buffer
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|osMemHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|bit32
name|retcode
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|bit32
name|RequestLength
init|=
name|agIOCTLPayload
operator|->
name|Length
decl_stmt|;
name|bit32
name|bufAddrUpper
init|=
literal|0
decl_stmt|;
name|bit32
name|bufAddrLower
init|=
literal|0
decl_stmt|;
name|tdPhyCount_t
modifier|*
name|PhyBlob
init|=
operator|(
name|tdPhyCount_t
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|buffer
argument_list|,
operator|&
name|bufAddrUpper
argument_list|,
operator|&
name|bufAddrLower
argument_list|,
name|RequestLength
argument_list|,
name|RequestLength
argument_list|,
name|agTRUE
argument_list|)
condition|)
return|return
name|IOCTL_CALL_FAIL
return|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|buffer
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
literal|32
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyProfileIoctl: MinorFunction %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|MinorFunction
operator|)
argument_list|)
expr_stmt|;
comment|//  PhyBlob->Phy |= 0x100;
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyProfileIoctl: SPC operation 0x%x PHY %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|MinorFunction
operator|,
name|PhyBlob
operator|->
name|Phy
operator|)
argument_list|)
expr_stmt|;
name|retcode
operator|=
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|PhyBlob
operator|->
name|Phy
argument_list|,
name|agIOCTLPayload
operator|->
name|MinorFunction
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPhyProfileIoctl: SPCv operation 0x%x PHY %d\n"
operator|,
name|agIOCTLPayload
operator|->
name|MinorFunction
operator|,
name|PhyBlob
operator|->
name|Phy
operator|)
argument_list|)
expr_stmt|;
name|retcode
operator|=
name|saGetPhyProfile
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agIOCTLPayload
operator|->
name|MinorFunction
argument_list|,
name|PhyBlob
operator|->
name|Phy
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
block|}
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPhyProfileIoctl: after\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tdsaForensicDataGetIoctl * * Purpose:  This routine is called to get Forensic Data. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaForensicDataGetIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|tdForensicDataPayload_t
modifier|*
name|pForensicDataPayload
init|=
name|agNULL
decl_stmt|;
name|agsaForensicData_t
name|ForensicData
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|pForensicDataPayload
operator|=
operator|(
name|tdForensicDataPayload_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|agNULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|agNULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|ForensicData
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaForensicData_t
argument_list|)
argument_list|)
expr_stmt|;
name|ForensicData
operator|.
name|DataType
operator|=
name|pForensicDataPayload
operator|->
name|DataType
expr_stmt|;
switch|switch
condition|(
name|ForensicData
operator|.
name|DataType
condition|)
block|{
case|case
name|FORENSIC_DATA_TYPE_NON_FATAL
case|:
case|case
name|FORENSIC_DATA_TYPE_FATAL
case|:
name|ForensicData
operator|.
name|BufferType
operator|.
name|dataBuf
operator|.
name|directLen
operator|=
name|pForensicDataPayload
operator|->
name|dataBuffer
operator|.
name|directLen
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|dataBuf
operator|.
name|directOffset
operator|=
name|pForensicDataPayload
operator|->
name|dataBuffer
operator|.
name|directOffset
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|dataBuf
operator|.
name|readLen
operator|=
name|pForensicDataPayload
operator|->
name|dataBuffer
operator|.
name|readLen
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|dataBuf
operator|.
name|directData
operator|=
operator|(
name|void
operator|*
operator|)
name|pForensicDataPayload
operator|->
name|dataBuffer
operator|.
name|directData
expr_stmt|;
break|break;
case|case
name|FORENSIC_DATA_TYPE_GSM_SPACE
case|:
name|ForensicData
operator|.
name|BufferType
operator|.
name|gsmBuf
operator|.
name|directLen
operator|=
name|pForensicDataPayload
operator|->
name|gsmBuffer
operator|.
name|directLen
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|gsmBuf
operator|.
name|directOffset
operator|=
name|pForensicDataPayload
operator|->
name|gsmBuffer
operator|.
name|directOffset
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|dataBuf
operator|.
name|readLen
operator|=
name|pForensicDataPayload
operator|->
name|gsmBuffer
operator|.
name|readLen
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|gsmBuf
operator|.
name|directData
operator|=
operator|(
name|void
operator|*
operator|)
name|pForensicDataPayload
operator|->
name|gsmBuffer
operator|.
name|directData
expr_stmt|;
break|break;
case|case
name|FORENSIC_DATA_TYPE_IB_QUEUE
case|:
name|ForensicData
operator|.
name|BufferType
operator|.
name|queueBuf
operator|.
name|directLen
operator|=
name|pForensicDataPayload
operator|->
name|queueBuffer
operator|.
name|directLen
expr_stmt|;
comment|//ForensicData.BufferType.queueBuf.queueType = pForensicDataPayload->queueBuffer.queueType;
name|ForensicData
operator|.
name|BufferType
operator|.
name|queueBuf
operator|.
name|queueType
operator|=
name|FORENSIC_DATA_TYPE_IB_QUEUE
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|queueBuf
operator|.
name|queueIndex
operator|=
name|pForensicDataPayload
operator|->
name|queueBuffer
operator|.
name|queueIndex
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|queueBuf
operator|.
name|directData
operator|=
operator|(
name|void
operator|*
operator|)
name|pForensicDataPayload
operator|->
name|queueBuffer
operator|.
name|directData
expr_stmt|;
break|break;
case|case
name|FORENSIC_DATA_TYPE_OB_QUEUE
case|:
name|ForensicData
operator|.
name|BufferType
operator|.
name|queueBuf
operator|.
name|directLen
operator|=
name|pForensicDataPayload
operator|->
name|queueBuffer
operator|.
name|directLen
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|queueBuf
operator|.
name|queueType
operator|=
name|FORENSIC_DATA_TYPE_OB_QUEUE
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|queueBuf
operator|.
name|queueIndex
operator|=
name|pForensicDataPayload
operator|->
name|queueBuffer
operator|.
name|queueIndex
expr_stmt|;
name|ForensicData
operator|.
name|BufferType
operator|.
name|queueBuf
operator|.
name|directData
operator|=
operator|(
name|void
operator|*
operator|)
name|pForensicDataPayload
operator|->
name|queueBuffer
operator|.
name|directData
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaGetForensicDataIoctl: forensic data type error %d\n"
operator|,
name|pForensicDataPayload
operator|->
name|DataType
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_INVALID_CODE
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|saGetForensicData
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ForensicData
argument_list|)
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tdsaSendSMPIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|void
modifier|*
name|reqBuffer
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|respBuffer
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|osMemHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
comment|//	bit32			Offset = 0;
comment|//	bit32			RequestLength = 0;
name|bit32
name|ostiMemoryStatus
init|=
literal|0
decl_stmt|;
name|smp_pass_through_req_t
modifier|*
name|smp_pass_through_req
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|devHandle
decl_stmt|;
name|agsaSMPFrame_t
name|agSMPFrame
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaSendSMPIoctl: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smp_pass_through_req
operator|=
operator|(
name|smp_pass_through_req_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|TI_DBG2
argument_list|(
operator|(
literal|"SAS Address[%d]:%x"
operator|,
name|i
operator|,
name|smp_pass_through_req
operator|->
name|exp_sas_addr
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"SAS Request Length:%d"
operator|,
name|smp_pass_through_req
operator|->
name|smp_req_len
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"SAS Response Length:%d"
operator|,
name|smp_pass_through_req
operator|->
name|smp_resp_len
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|smp_pass_through_req
operator|->
name|smp_req_len
condition|;
name|i
operator|++
control|)
name|TI_DBG2
argument_list|(
operator|(
literal|"SAS request + %d:%x"
operator|,
name|i
operator|,
name|smp_pass_through_req
operator|->
name|smp_req_resp
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|devHandle
operator|=
name|ostiGetDevHandleFromSasAddr
argument_list|(
name|tiRoot
argument_list|,
name|smp_pass_through_req
operator|->
name|exp_sas_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|devHandle
operator|==
name|NULL
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
return|return
name|status
return|;
block|}
comment|//agIOCTLPayload->Status = IOCTL_ERR_STATUS_OK;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_NOT_RESPONDING
expr_stmt|;
if|if
condition|(
operator|(
name|ostiMemoryStatus
operator|!=
name|tiSuccess
operator|)
operator|&&
operator|(
name|reqBuffer
operator|==
name|agNULL
operator|)
condition|)
return|return
name|IOCTL_CALL_FAIL
return|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param3
operator|=
name|osMemHandle
expr_stmt|;
name|agSMPFrame
operator|.
name|outFrameBuf
operator|=
name|smp_pass_through_req
operator|->
name|smp_req_resp
expr_stmt|;
name|agSMPFrame
operator|.
name|expectedRespLen
operator|=
name|smp_pass_through_req
operator|->
name|smp_resp_len
expr_stmt|;
name|agSMPFrame
operator|.
name|inFrameLen
operator|=
name|smp_pass_through_req
operator|->
name|smp_resp_len
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|smp_pass_through_req
operator|->
name|smp_req_len
operator|-
literal|8
operator|)
operator|&&
operator|!
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|agSMPFrame
operator|.
name|flag
operator|=
literal|1
expr_stmt|;
comment|// Direct request Indirect response
name|agSMPFrame
operator|.
name|outFrameLen
operator|=
name|smp_pass_through_req
operator|->
name|smp_req_len
operator|-
literal|4
expr_stmt|;
comment|//Exclude header
block|}
else|else
block|{
name|agSMPFrame
operator|.
name|flag
operator|=
literal|3
expr_stmt|;
comment|//Indirect request and Indirect response
name|ostiMemoryStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|reqBuffer
argument_list|,
operator|&
operator|(
name|agSMPFrame
operator|.
name|outFrameAddrUpper32
operator|)
argument_list|,
operator|&
operator|(
name|agSMPFrame
operator|.
name|outFrameAddrLower32
operator|)
argument_list|,
literal|8
argument_list|,
name|smp_pass_through_req
operator|->
name|smp_req_len
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param3
operator|=
name|osMemHandle
expr_stmt|;
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|agSMPFrame
operator|.
name|outFrameLen
operator|=
name|smp_pass_through_req
operator|->
name|smp_req_len
operator|-
literal|4
expr_stmt|;
comment|//Exclude crc
name|osti_memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|reqBuffer
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|smp_pass_through_req
operator|->
name|smp_req_resp
operator|)
argument_list|,
name|smp_pass_through_req
operator|->
name|smp_req_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agSMPFrame
operator|.
name|outFrameLen
operator|=
name|smp_pass_through_req
operator|->
name|smp_req_len
operator|-
literal|8
expr_stmt|;
comment|//Exclude header and crc
name|osti_memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|reqBuffer
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|smp_pass_through_req
operator|->
name|smp_req_resp
operator|+
literal|4
operator|)
argument_list|,
name|smp_pass_through_req
operator|->
name|smp_req_len
operator|-
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
name|ostiMemoryStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|respBuffer
argument_list|,
operator|&
operator|(
name|agSMPFrame
operator|.
name|inFrameAddrUpper32
operator|)
argument_list|,
operator|&
operator|(
name|agSMPFrame
operator|.
name|inFrameAddrLower32
operator|)
argument_list|,
literal|8
argument_list|,
name|smp_pass_through_req
operator|->
name|smp_resp_len
operator|+
literal|4
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ostiMemoryStatus
operator|!=
name|tiSuccess
operator|)
operator|&&
operator|(
name|respBuffer
operator|==
name|agNULL
operator|)
condition|)
return|return
name|IOCTL_CALL_FAIL
return|;
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|respBuffer
argument_list|,
literal|0
argument_list|,
name|smp_pass_through_req
operator|->
name|smp_resp_len
argument_list|)
expr_stmt|;
comment|// use FW control place in shared structure to keep the neccesary information
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|respBuffer
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smp_pass_through_req
operator|->
name|smp_req_resp
operator|+
name|smp_pass_through_req
operator|->
name|smp_req_len
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
name|smp_pass_through_req
operator|->
name|smp_resp_len
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|devHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|saSendSMPIoctl
argument_list|(
name|agRoot
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|0
argument_list|,
operator|&
name|agSMPFrame
argument_list|,
operator|&
name|ossaSMPIoctlCompleted
argument_list|)
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ostiSendSMPIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
decl_stmt|;
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
operator|(
name|bit16
operator|)
name|status
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiSendSMPIOCTLRsp: start, status = %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|//	if(tdsaAllShared->tdFWControlEx.param1 != agNULL)
comment|//	{
name|osti_memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|)
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
comment|//	}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param3
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
comment|//if(tdsaAllShared->tdFWControlEx.param1 != agNULL)
comment|//	{
name|ostiIOCTLComplete
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|//    }
block|}
end_function

begin_comment
comment|/***************************************************************************** * * tdsaSendBISTIoctl * * Purpose:  This routine is called to get Forensic Data. * * Parameters: *   tiRoot:         Pointer to driver instance *   agIOCTLPayload: Pointer to the IOCTL payload. *   agParam1:       Pointer to pass context handle for IOCTL DMA operation *   agParam2:       Pointer to pass context handle for IOCTL DMA operation *   agParam3:       Pointer to pass context handle for IOCTL DMA operation * * Return: * *   IOCTL_CALL_SUCCESS        The requested operation completed successfully. *   IOCTL_CALL_FAIL           Fail to complete the IOCTL request. *                             Detail error code is function specific and *                             defined by the specific IOCTL function. *   IOCTL_CALL_PENDING        This request is asynchronous and completed *                             in some other context. *   IOCTL_CALL_INVALID_CODE   This IOCTL function is not recognized. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaSendBISTIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|tdBistPayload_t
modifier|*
name|pBistPayload
decl_stmt|;
comment|//  bit32            length = 0;
comment|//  bit32            status = IOCTL_CALL_SUCCESS;
name|bit32
name|status
init|=
name|IOCTL_CALL_FAIL
decl_stmt|;
name|pBistPayload
operator|=
operator|(
name|tdBistPayload_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|agNULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|agNULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|usrAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSendBISTIoctl: Type %d Length %d Data %p\n"
operator|,
name|pBistPayload
operator|->
name|testType
operator|,
name|pBistPayload
operator|->
name|testLength
operator|,
name|pBistPayload
operator|->
name|testData
operator|)
argument_list|)
expr_stmt|;
comment|// pBistPayload->testtype = AGSA_BIST_TEST;
if|if
condition|(
name|pBistPayload
operator|->
name|testType
operator|==
name|AGSA_BIST_TEST
condition|)
block|{
if|if
condition|(
name|pBistPayload
operator|->
name|testLength
operator|!=
sizeof|sizeof
argument_list|(
name|agsaEncryptSelfTestBitMap_t
argument_list|)
condition|)
block|{
return|return
name|status
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|pBistPayload
operator|->
name|testType
operator|==
name|AGSA_SHA_TEST
condition|)
block|{
if|if
condition|(
name|pBistPayload
operator|->
name|testLength
operator|!=
sizeof|sizeof
argument_list|(
name|agsaEncryptSHATestDescriptor_t
argument_list|)
condition|)
block|{
return|return
name|status
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|pBistPayload
operator|->
name|testType
operator|==
name|AGSA_HMAC_TEST
condition|)
block|{
if|if
condition|(
name|pBistPayload
operator|->
name|testLength
operator|!=
sizeof|sizeof
argument_list|(
name|agsaEncryptHMACTestDescriptor_t
argument_list|)
condition|)
block|{
return|return
name|status
return|;
block|}
block|}
comment|/* GLOBAL bit32 saEncryptSelftestExecute(                         agsaRoot_t    *agRoot,                         agsaContext_t *agContext,                         bit32         queueNum,                         bit32         type,                         bit32         length,                         void          *TestDescriptor);  */
if|if
condition|(
name|saEncryptSelftestExecute
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|pBistPayload
operator|->
name|testType
argument_list|,
name|pBistPayload
operator|->
name|testLength
argument_list|,
name|pBistPayload
operator|->
name|testData
argument_list|)
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tdsaSendTMFIoctl
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|unsigned
name|long
name|resetType
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|tmf_pass_through_req_t
modifier|*
name|tmf_req
init|=
operator|(
name|tmf_pass_through_req_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
decl_stmt|;
if|#
directive|if
operator|!
operator|(
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|)
name|status
operator|=
name|ostiSendResetDeviceIoctl
argument_list|(
name|tiRoot
argument_list|,
name|agParam2
argument_list|,
name|tmf_req
operator|->
name|pathId
argument_list|,
name|tmf_req
operator|->
name|targetId
argument_list|,
name|tmf_req
operator|->
name|lun
argument_list|,
name|resetType
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"Status returned from ostiSendResetDeviceIoctl is %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IOCTL_CALL_SUCCESS
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|status
expr_stmt|;
return|return
name|status
return|;
block|}
name|status
operator|=
name|IOCTL_CALL_SUCCESS
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|VPD_TESTING
end_ifdef

begin_comment
comment|/* temporary to test saSetVPDCommand() and saGetVPDCommand */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaVPDSet
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|agsaVPD_t
name|VPDInfo
decl_stmt|;
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|bit32
name|bufAddrUpper
init|=
literal|0
decl_stmt|;
name|bit32
name|bufAddrLower
init|=
literal|0
decl_stmt|;
name|tdVPDControl_t
modifier|*
name|VPDControl
decl_stmt|;
name|void
modifier|*
name|osMemHandle
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|buffer
decl_stmt|;
name|bit32
name|timeCount
init|=
literal|0
decl_stmt|;
name|bit8
name|ioctlErr
init|=
literal|0
decl_stmt|;
name|bit8
name|VPDPayload
index|[
literal|32
index|]
decl_stmt|;
name|bit8
name|i
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaVPDSet: start\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|VPDPayload
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|VPDPayload
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|buffer
argument_list|,
operator|&
name|bufAddrUpper
argument_list|,
operator|&
name|bufAddrLower
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|VPDPayload
argument_list|)
argument_list|,
name|agFALSE
argument_list|)
condition|)
block|{
return|return
name|tiError
return|;
block|}
name|osti_memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|buffer
argument_list|,
name|VPDPayload
argument_list|,
sizeof|sizeof
argument_list|(
name|VPDPayload
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|VPDInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaVPD_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* direct mode worked */
comment|/* For now, only direct mode */
name|VPDInfo
operator|.
name|indirectMode
operator|=
literal|0
expr_stmt|;
comment|/* direct mode */
name|VPDInfo
operator|.
name|VPDDevice
operator|=
literal|1
expr_stmt|;
comment|/* SEEPROM-1 */
name|VPDInfo
operator|.
name|directLen
operator|=
operator|(
name|bit8
operator|)
sizeof|sizeof
argument_list|(
name|VPDPayload
argument_list|)
expr_stmt|;
name|VPDInfo
operator|.
name|VPDOffset
operator|=
literal|0
expr_stmt|;
name|VPDInfo
operator|.
name|directData
operator|=
name|buffer
expr_stmt|;
name|VPDInfo
operator|.
name|indirectAddrUpper32
operator|=
name|bufAddrUpper
expr_stmt|;
name|VPDInfo
operator|.
name|indirectAddrLower32
operator|=
name|bufAddrLower
expr_stmt|;
name|VPDInfo
operator|.
name|indirectLen
operator|=
sizeof|sizeof
argument_list|(
name|VPDPayload
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* indirect mode */
name|VPDInfo
operator|.
name|indirectMode
operator|=
literal|1
expr_stmt|;
comment|/* indirect mode */
name|VPDInfo
operator|.
name|VPDDevice
operator|=
literal|1
expr_stmt|;
comment|/* SEEPROM-1 */
name|VPDInfo
operator|.
name|directLen
operator|=
literal|0
expr_stmt|;
name|VPDInfo
operator|.
name|VPDOffset
operator|=
literal|0
expr_stmt|;
name|VPDInfo
operator|.
name|directData
operator|=
name|agNULL
expr_stmt|;
name|VPDInfo
operator|.
name|indirectAddrUpper32
operator|=
name|bufAddrUpper
expr_stmt|;
name|VPDInfo
operator|.
name|indirectAddrLower32
operator|=
name|bufAddrLower
expr_stmt|;
name|VPDInfo
operator|.
name|indirectLen
operator|=
sizeof|sizeof
argument_list|(
name|VPDPayload
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|buffer
operator|=
name|osMemHandle
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
comment|/* for testing only */
name|tdsaAllShared
operator|->
name|addrUpper
operator|=
name|bufAddrUpper
expr_stmt|;
name|tdsaAllShared
operator|->
name|addrLower
operator|=
name|bufAddrLower
expr_stmt|;
name|ret
operator|=
name|saSetVPDCommand
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
operator|&
name|VPDInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|tiSuccess
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|tiError
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|VPDPayload
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* temporary to test saSetVPDCommand() and saGetVPDCommand */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaVPDGet
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|agsaVPD_t
name|VPDInfo
decl_stmt|;
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaVPDGet: start\n"
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|VPDInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaVPD_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* direct mode worked */
name|VPDInfo
operator|.
name|indirectMode
operator|=
literal|0
expr_stmt|;
comment|/* direct mode */
name|VPDInfo
operator|.
name|VPDDevice
operator|=
literal|1
expr_stmt|;
comment|/* SEEPROM-1*/
name|VPDInfo
operator|.
name|directLen
operator|=
literal|32
expr_stmt|;
name|VPDInfo
operator|.
name|VPDOffset
operator|=
literal|0
expr_stmt|;
name|VPDInfo
operator|.
name|directData
operator|=
name|agNULL
expr_stmt|;
name|VPDInfo
operator|.
name|indirectAddrUpper32
operator|=
literal|0
expr_stmt|;
name|VPDInfo
operator|.
name|indirectAddrLower32
operator|=
literal|0
expr_stmt|;
name|VPDInfo
operator|.
name|indirectLen
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* worked; can't read VPD in ossaGetVPDResponseCB() because of indirect */
name|VPDInfo
operator|.
name|indirectMode
operator|=
literal|1
expr_stmt|;
comment|/* direct mode */
name|VPDInfo
operator|.
name|VPDDevice
operator|=
literal|1
expr_stmt|;
comment|/* SEEPROM-1*/
name|VPDInfo
operator|.
name|directLen
operator|=
literal|0
expr_stmt|;
name|VPDInfo
operator|.
name|VPDOffset
operator|=
literal|0
expr_stmt|;
name|VPDInfo
operator|.
name|directData
operator|=
name|agNULL
expr_stmt|;
name|VPDInfo
operator|.
name|indirectAddrUpper32
operator|=
name|tdsaAllShared
operator|->
name|addrUpper
expr_stmt|;
name|VPDInfo
operator|.
name|indirectAddrLower32
operator|=
name|tdsaAllShared
operator|->
name|addrLower
expr_stmt|;
name|VPDInfo
operator|.
name|indirectLen
operator|=
literal|32
expr_stmt|;
endif|#
directive|endif
name|ret
operator|=
name|saGetVPDCommand
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
operator|&
name|VPDInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|status
operator|=
name|tiSuccess
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|tiError
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** * * tdsaGetNumOfLUNIOCTL * * Purpose:  This routine is called to send Report LUN SSP command request. * * Parameters: *   tiRoot:         Pointer to driver instance *   tiIOCTLPayload_t:        Status of the Controller Reset. *   agParam1:        Void pointer to device extension *   agParam2:        Void pointer to SRB *   agParam3:        NULL * *   Return: status * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaGetNumOfLUNIOCTL
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|tdDeviceLUNInfoIOCTL_t
modifier|*
name|pDeviceLUNInfo
init|=
name|agNULL
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|devHandle
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|tiRequestBody
init|=
name|agNULL
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiIORequest
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetNumOfLUNIOCTL: Start\n"
operator|)
argument_list|)
expr_stmt|;
do|do
block|{
name|pDeviceLUNInfo
operator|=
operator|(
name|tdDeviceLUNInfoIOCTL_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
if|if
condition|(
name|agIOCTLPayload
operator|->
name|Length
operator|<
sizeof|sizeof
argument_list|(
name|tdDeviceLUNInfoIOCTL_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|pDeviceLUNInfo
operator|->
name|tiDeviceHandle
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
break|break;
block|}
name|devHandle
operator|=
operator|(
name|tiDeviceHandle_t
operator|*
operator|)
name|pDeviceLUNInfo
operator|->
name|tiDeviceHandle
expr_stmt|;
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_OK
expr_stmt|;
name|status
operator|=
name|ostiNumOfLUNIOCTLreq
argument_list|(
name|tiRoot
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|,
operator|&
name|tiRequestBody
argument_list|,
operator|&
name|tiIORequest
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
break|break;
block|}
name|status
operator|=
name|tiNumOfLunIOCTLreq
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|devHandle
argument_list|,
name|tiRequestBody
argument_list|,
name|agIOCTLPayload
argument_list|,
name|agParam1
argument_list|,
name|agParam2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
name|IOCTL_ERR_STATUS_INTERNAL_ERROR
expr_stmt|;
break|break;
block|}
comment|//	ostiIOCTLWaitForSignal (tiRoot, agParam1, agParam2, agParam3);
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaGetNumOfLUNIOCTL: End\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * * ostiNumOfLUNIOCTLRsp * * Purpose:  This routine is called when a Report LUN SSP command response id recieved. * * Parameters: *   tiRoot:         Pointer to driver instance *   bit32               status * * Return: none * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiNumOfLUNIOCTLRsp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
decl_stmt|;
name|tdDeviceLUNInfoIOCTL_t
modifier|*
name|pDeviceLUNInfo
init|=
name|NULL
decl_stmt|;
name|bit32
name|count
init|=
literal|0
decl_stmt|;
name|bit32
name|numOfLUN
init|=
literal|0
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiNumOfLUNIOCTLRsp: start, status = %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|==
literal|1
condition|)
block|{
name|agIOCTLPayload
operator|=
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|agIOCTLPayload
operator|)
operator|&&
operator|(
name|PMC_IOCTL_SIGNATURE
operator|==
name|agIOCTLPayload
operator|->
name|Signature
operator|)
operator|&&
operator|(
name|IOCTL_MJ_GET_DEVICE_LUN
operator|==
name|agIOCTLPayload
operator|->
name|MajorFunction
operator|)
condition|)
block|{
name|agIOCTLPayload
operator|->
name|Status
operator|=
operator|(
name|bit16
operator|)
name|status
expr_stmt|;
name|pDeviceLUNInfo
operator|=
operator|(
name|tdDeviceLUNInfoIOCTL_t
operator|*
operator|)
name|agIOCTLPayload
operator|->
name|FunctionSpecificArea
expr_stmt|;
name|numOfLUN
operator|=
operator|(
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
index|[
literal|0
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
operator||
expr|\
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
index|[
literal|3
index|]
operator|)
operator|)
expr_stmt|;
name|numOfLUN
operator|=
name|numOfLUN
operator|/
literal|8
expr_stmt|;
name|pDeviceLUNInfo
operator|->
name|numOfLun
operator|=
name|numOfLUN
expr_stmt|;
comment|//	  ostiFreeMemory(tiRoot,
comment|//                     tdsaAllShared->tdFWControlEx.virtAddr,
comment|//                     tdsaAllShared->tdFWControlEx.len);
comment|//    if(tdsaAllShared->tdFWControlEx.param1 != agNULL)
comment|//    {
name|ostiIOCTLSetSignal
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|NULL
expr_stmt|;
comment|//    }
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ostiNumOfLUNIOCTLRsp: End\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


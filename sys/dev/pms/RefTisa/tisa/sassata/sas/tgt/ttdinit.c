begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*******************************************************************************  *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  * $RCSfile: ttdinit.c,v $  *  * Copyright 2006 PMC-Sierra, Inc.  *  * $Author: vempatin $  * $Revision: 113679 $  * $Date: 2012-04-16 14:35:19 -0700 (Mon, 16 Apr 2012) $  *  * This file contains initiator IO related functions in TD layer  *  */
end_comment

begin_include
include|#
directive|include
file|<osenv.h>
end_include

begin_include
include|#
directive|include
file|<ostypes.h>
end_include

begin_include
include|#
directive|include
file|<osdebug.h>
end_include

begin_include
include|#
directive|include
file|<sa.h>
end_include

begin_include
include|#
directive|include
file|<saapi.h>
end_include

begin_include
include|#
directive|include
file|<saosapi.h>
end_include

begin_include
include|#
directive|include
file|<titypes.h>
end_include

begin_include
include|#
directive|include
file|<ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<tiapi.h>
end_include

begin_include
include|#
directive|include
file|<tiglobal.h>
end_include

begin_include
include|#
directive|include
file|<tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<osstring.h>
end_include

begin_include
include|#
directive|include
file|<tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<itddefs.h>
end_include

begin_include
include|#
directive|include
file|<itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|"ttdglobl.h"
end_include

begin_include
include|#
directive|include
file|"ttdtxchg.h"
end_include

begin_include
include|#
directive|include
file|"ttdtypes.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<tdproto.h>
end_include

begin_comment
comment|/* io trace only */
end_comment

begin_function_decl
specifier|extern
name|void
name|TDTraceInit
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* io trace only */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|ttdssInit
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiTargetResource_t
modifier|*
name|targetResource
parameter_list|,
name|tiTdSharedMem_t
modifier|*
name|tdSharedMem
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tiTargetMem_t
modifier|*
name|tgtMem
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|Target
decl_stmt|;
name|ttdssOperatingOption_t
modifier|*
name|OperatingOption
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|bit32
name|buffLen
decl_stmt|;
name|bit32
name|lenRecv
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pLastUsedChar
init|=
name|agNULL
decl_stmt|;
name|char
name|tmpBuffer
index|[
name|DEFAULT_KEY_BUFFER_SIZE
index|]
decl_stmt|;
name|char
name|globalStr
index|[]
init|=
literal|"OSParms"
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdssInit: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*      first set the values to Default values      Then, overwrite them using ostiGetTransportParam()      */
comment|/* to remove compiler warnings */
name|buffer
operator|=
operator|&
name|tmpBuffer
index|[
literal|0
index|]
expr_stmt|;
name|buffLen
operator|=
sizeof|sizeof
argument_list|(
name|tmpBuffer
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|tgtMem
operator|=
operator|&
name|targetResource
operator|->
name|targetMem
expr_stmt|;
comment|/*      * Cached mem for target Transport Dependent Layer main functionality      */
name|Target
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|virtPtr
expr_stmt|;
name|OperatingOption
operator|=
operator|&
name|Target
operator|->
name|OperatingOption
expr_stmt|;
comment|/*      * Get default parameters from the OS Specific area      * and reads parameters from the configuration file      */
name|ttdssGetOperatingOptionParams
argument_list|(
name|tiRoot
argument_list|,
name|OperatingOption
argument_list|)
expr_stmt|;
comment|/*      * Update TD operating options      */
name|OperatingOption
operator|->
name|UsecsPerTick
operator|=
name|targetResource
operator|->
name|targetOption
operator|.
name|usecsPerTick
expr_stmt|;
name|OperatingOption
operator|->
name|numXchgs
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|numElements
expr_stmt|;
if|if
condition|(
name|ttdsaXchgInit
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|Target
operator|->
name|ttdsaXchgData
argument_list|,
name|tgtMem
argument_list|,
name|OperatingOption
operator|->
name|numXchgs
argument_list|)
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdInit: ttdsaXchgInit failed\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* Get number of AutoGoodResponse entry */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"AutoGoodResponse"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tdsaRoot
operator|->
name|autoGoodRSP
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaRoot
operator|->
name|autoGoodRSP
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*   this combines ttdGetDefaultParams and ttdGetTargetParms   */
end_comment

begin_function
name|osGLOBAL
name|void
name|ttdssGetOperatingOptionParams
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|ttdssOperatingOption_t
modifier|*
name|OperatingOption
parameter_list|)
block|{
name|char
modifier|*
name|key
init|=
name|agNULL
decl_stmt|;
name|char
modifier|*
name|subkey1
init|=
name|agNULL
decl_stmt|;
name|char
modifier|*
name|subkey2
init|=
name|agNULL
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|bit32
name|buffLen
decl_stmt|;
name|bit32
name|lenRecv
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pLastUsedChar
init|=
name|agNULL
decl_stmt|;
name|char
name|tmpBuffer
index|[
name|DEFAULT_KEY_BUFFER_SIZE
index|]
decl_stmt|;
name|char
name|globalStr
index|[]
init|=
literal|"Global"
decl_stmt|;
name|char
name|iniParmsStr
index|[]
init|=
literal|"TargetParms"
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdssGetOperatingOptionParams: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*      first set the values to Default values      Then, overwrite them using ostiGetTransportParam()      */
comment|/* to remove compiler warnings */
name|pLastUsedChar
operator|=
name|pLastUsedChar
expr_stmt|;
name|lenRecv
operator|=
name|lenRecv
expr_stmt|;
name|subkey2
operator|=
name|subkey2
expr_stmt|;
name|subkey1
operator|=
name|subkey1
expr_stmt|;
name|key
operator|=
name|key
expr_stmt|;
name|buffer
operator|=
operator|&
name|tmpBuffer
index|[
literal|0
index|]
expr_stmt|;
name|buffLen
operator|=
sizeof|sizeof
argument_list|(
name|tmpBuffer
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
comment|/* in ttgglobl.h */
name|OperatingOption
operator|->
name|numXchgs
operator|=
name|DEFAULT_XCHGS
expr_stmt|;
name|OperatingOption
operator|->
name|UsecsPerTick
operator|=
name|DEFAULT_TGT_TIMER_TICK
expr_stmt|;
comment|/* 1 sec */
name|OperatingOption
operator|->
name|MaxTargets
operator|=
name|DEFAULT_MAX_TARGETS
expr_stmt|;
name|OperatingOption
operator|->
name|BlockSize
operator|=
name|DEFAULT_BLOCK_SIZE
expr_stmt|;
comment|/* defaults are overwritten in the following */
comment|/* Get number of exchanges */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|iniParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"NumberExchanges"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OperatingOption
operator|->
name|numXchgs
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OperatingOption
operator|->
name|numXchgs
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/* Get number of MaxTargets */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|iniParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"MaxTargets"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OperatingOption
operator|->
name|MaxTargets
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OperatingOption
operator|->
name|MaxTargets
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/* Get number of BlockSize */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|iniParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"BlockSize"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OperatingOption
operator|->
name|BlockSize
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OperatingOption
operator|->
name|BlockSize
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdssGetOperatingOptionParams: NumberExchanges %d UsecsPerTick %d MaxTargets %d BlockSize %d\n"
operator|,
name|OperatingOption
operator|->
name|numXchgs
operator|,
name|OperatingOption
operator|->
name|UsecsPerTick
operator|,
name|OperatingOption
operator|->
name|MaxTargets
operator|,
name|OperatingOption
operator|->
name|BlockSize
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* not yet */
end_comment

begin_function
name|osGLOBAL
name|void
name|ttdssGetResource
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiTargetResource_t
modifier|*
name|targetResource
parameter_list|)
block|{
name|tiTargetMem_t
modifier|*
name|tgtMem
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ttdssOperatingOption_t
name|OperatingOption
decl_stmt|;
name|bit32
name|xchgSize
decl_stmt|;
name|bit32
name|respSize
decl_stmt|;
name|bit32
name|smprespSize
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdssGetResource: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tgtMem
operator|=
operator|&
name|targetResource
operator|->
name|targetMem
expr_stmt|;
comment|/*     only 4 memory descriptors are used      */
name|tgtMem
operator|->
name|count
operator|=
literal|4
expr_stmt|;
comment|/* initiailization */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|tgtMem
operator|->
name|tdMem
index|[
name|i
index|]
operator|.
name|singleElementLength
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
name|i
index|]
operator|.
name|numElements
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
name|i
index|]
operator|.
name|totalLength
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
name|i
index|]
operator|.
name|alignment
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
name|i
index|]
operator|.
name|type
operator|=
name|TI_CACHED_MEM
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
name|i
index|]
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
name|i
index|]
operator|.
name|virtPtr
operator|=
name|agNULL
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
name|i
index|]
operator|.
name|osHandle
operator|=
name|agNULL
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
name|i
index|]
operator|.
name|physAddrUpper
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
name|i
index|]
operator|.
name|physAddrLower
operator|=
literal|0
expr_stmt|;
block|}
comment|/*      * Get default parameters from the OS Specific area      * and reads parameters from the configuration file      */
name|ttdssGetOperatingOptionParams
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|OperatingOption
argument_list|)
expr_stmt|;
comment|/* target */
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|singleElementLength
operator|=
sizeof|sizeof
argument_list|(
name|ttdsaTgt_t
argument_list|)
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|numElements
operator|=
literal|1
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|totalLength
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|singleElementLength
operator|*
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|numElements
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|TI_CACHED_MEM
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|virtPtr
operator|=
name|agNULL
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|osHandle
operator|=
name|agNULL
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|physAddrUpper
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|0
index|]
operator|.
name|physAddrLower
operator|=
literal|0
expr_stmt|;
comment|/*      * Cached memory for I/O exchange structures      */
name|xchgSize
operator|=
sizeof|sizeof
argument_list|(
name|ttdsaXchg_t
argument_list|)
expr_stmt|;
name|xchgSize
operator|=
name|AG_ALIGNSIZE
argument_list|(
name|xchgSize
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|singleElementLength
operator|=
name|xchgSize
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|numElements
operator|=
name|OperatingOption
operator|.
name|numXchgs
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|totalLength
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|singleElementLength
operator|*
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|numElements
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|TI_CACHED_MEM
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|virtPtr
operator|=
name|agNULL
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|osHandle
operator|=
name|agNULL
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|physAddrUpper
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|physAddrLower
operator|=
literal|0
expr_stmt|;
comment|/*      * Uncached memory for response buffer structures      */
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdssGetResource: sas_resp_t size 0x%x %d\n"
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|sas_resp_t
argument_list|)
operator|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|sas_resp_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|respSize
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|sas_resp_t
argument_list|)
operator|+
name|AG_WORD_ALIGN_ADD
operator|)
operator|&
name|AG_WORD_ALIGN_MASK
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdssGetResource: response size 0x%x %d\n"
operator|,
name|respSize
operator|,
name|respSize
operator|)
argument_list|)
expr_stmt|;
name|respSize
operator|=
name|AG_ALIGNSIZE
argument_list|(
name|respSize
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdssGetResource: response size 0x%x %d\n"
operator|,
name|respSize
operator|,
name|respSize
operator|)
argument_list|)
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|singleElementLength
operator|=
literal|0x1000
expr_stmt|;
comment|/* respSize; 0x1000;  */
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|numElements
operator|=
name|OperatingOption
operator|.
name|numXchgs
expr_stmt|;
comment|/* Same as num of xchg */
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|totalLength
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|singleElementLength
operator|*
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|numElements
expr_stmt|;
comment|/* 8;4;16;256;sizeof(void *); all worked */
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|alignment
operator|=
literal|16
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|type
operator|=
name|TI_DMA_MEM
expr_stmt|;
comment|/* uncached memory */
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|virtPtr
operator|=
name|agNULL
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|osHandle
operator|=
name|agNULL
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|physAddrUpper
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|physAddrLower
operator|=
literal|0
expr_stmt|;
comment|/*      * Uncached memory for SMP response buffer structures      */
name|smprespSize
operator|=
sizeof|sizeof
argument_list|(
name|smp_resp_t
argument_list|)
expr_stmt|;
name|smprespSize
operator|=
name|AG_ALIGNSIZE
argument_list|(
name|smprespSize
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdssGetResource: SMP response size 0x%x %d\n"
operator|,
name|smprespSize
operator|,
name|smprespSize
operator|)
argument_list|)
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|singleElementLength
operator|=
name|smprespSize
expr_stmt|;
comment|/*0x1000; smprespSize; */
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|numElements
operator|=
name|OperatingOption
operator|.
name|numXchgs
expr_stmt|;
comment|/* Same as num of xchg */
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|totalLength
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|singleElementLength
operator|*
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|numElements
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|alignment
operator|=
literal|16
expr_stmt|;
comment|/* 4; 256; 16; sizeof(void *); */
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|type
operator|=
name|TI_DMA_MEM
expr_stmt|;
comment|/* uncached memory */
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|virtPtr
operator|=
name|agNULL
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|osHandle
operator|=
name|agNULL
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|physAddrUpper
operator|=
literal|0
expr_stmt|;
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|physAddrLower
operator|=
literal|0
expr_stmt|;
name|targetResource
operator|->
name|targetOption
operator|.
name|usecsPerTick
operator|=
name|OperatingOption
operator|.
name|UsecsPerTick
expr_stmt|;
name|targetResource
operator|->
name|targetOption
operator|.
name|pageSize
operator|=
literal|0
expr_stmt|;
comment|/* not applicable to SAS/SATA */
name|targetResource
operator|->
name|targetOption
operator|.
name|numLgns
operator|=
literal|0
expr_stmt|;
comment|/* not applicable to SAS/SATA */
name|targetResource
operator|->
name|targetOption
operator|.
name|numSessions
operator|=
literal|0
expr_stmt|;
comment|/* not applicable to SAS/SATA */
name|targetResource
operator|->
name|targetOption
operator|.
name|numXchgs
operator|=
name|OperatingOption
operator|.
name|numXchgs
expr_stmt|;
comment|/*     This is not used in OS like Linux which supports dynamic memeory allocation     In short, this is for Windows      */
comment|/* Estimate dynamic DMA memory */
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicDmaMem
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicDmaMem
operator|.
name|numElements
operator|=
literal|128
expr_stmt|;
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicDmaMem
operator|.
name|singleElementLength
operator|=
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
expr_stmt|;
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicDmaMem
operator|.
name|totalLength
operator|=
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicDmaMem
operator|.
name|numElements
operator|*
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicDmaMem
operator|.
name|singleElementLength
expr_stmt|;
comment|/* Estimate dynamic cached memory */
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicCachedMem
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicCachedMem
operator|.
name|numElements
operator|=
literal|128
expr_stmt|;
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicCachedMem
operator|.
name|singleElementLength
operator|=
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
expr_stmt|;
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicCachedMem
operator|.
name|totalLength
operator|=
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicCachedMem
operator|.
name|numElements
operator|*
name|targetResource
operator|->
name|targetOption
operator|.
name|dynamicCachedMem
operator|.
name|singleElementLength
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* not in use */
end_comment

begin_function
name|osGLOBAL
name|void
name|ttdssGetTargetParams
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"ttdssGetTargetParams: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|agBOOLEAN
name|ttdsaXchgInit
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|ttdsaXchgData_t
modifier|*
name|ttdsaXchgData
parameter_list|,
name|tiTargetMem_t
modifier|*
name|tgtMem
parameter_list|,
name|bit32
name|maxNumXchgs
parameter_list|)
block|{
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
decl_stmt|;
name|bit32
name|i
decl_stmt|,
name|respLen
decl_stmt|;
name|bit8
modifier|*
name|virtualAddr
decl_stmt|;
name|bit32
name|phyAddrLower
decl_stmt|,
name|phyAddrUpper
decl_stmt|;
name|bit32
name|smprespLen
decl_stmt|;
name|bit32
name|smpphyAddrLower
decl_stmt|,
name|smpphyAddrUpper
decl_stmt|;
name|bit8
modifier|*
name|smpvirtualAddr
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgInit: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* io trace only */
name|TDTraceInit
argument_list|()
expr_stmt|;
comment|/* io trace only */
comment|/*      * Set and initialize some global exchange information      */
name|TDLIST_INIT_HDR
argument_list|(
operator|&
name|ttdsaXchgData
operator|->
name|xchgFreeList
argument_list|)
expr_stmt|;
name|TDLIST_INIT_HDR
argument_list|(
operator|&
name|ttdsaXchgData
operator|->
name|xchgBusyList
argument_list|)
expr_stmt|;
name|ttdsaXchgData
operator|->
name|maxNumXchgs
operator|=
name|maxNumXchgs
expr_stmt|;
comment|/* Initialize exchange and response buffer structures */
name|ttdsaXchg
operator|=
operator|(
name|ttdsaXchg_t
operator|*
operator|)
name|tgtMem
operator|->
name|tdMem
index|[
literal|1
index|]
operator|.
name|virtPtr
expr_stmt|;
comment|/* Initialize response buffer */
name|virtualAddr
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|virtPtr
expr_stmt|;
name|phyAddrUpper
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|phyAddrLower
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|physAddrLower
expr_stmt|;
name|respLen
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|2
index|]
operator|.
name|singleElementLength
expr_stmt|;
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
operator|=
name|virtualAddr
expr_stmt|;
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrUpper
operator|=
name|phyAddrUpper
expr_stmt|;
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrLower
operator|=
name|phyAddrLower
expr_stmt|;
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|=
name|respLen
expr_stmt|;
comment|/* Initialize SMP response buffer */
name|smpvirtualAddr
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|virtPtr
expr_stmt|;
name|smpphyAddrUpper
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|smpphyAddrLower
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|physAddrLower
expr_stmt|;
name|smprespLen
operator|=
name|tgtMem
operator|->
name|tdMem
index|[
literal|3
index|]
operator|.
name|singleElementLength
expr_stmt|;
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|virtAddr
operator|=
name|smpvirtualAddr
expr_stmt|;
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrUpper
operator|=
name|smpphyAddrUpper
expr_stmt|;
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrLower
operator|=
name|smpphyAddrLower
expr_stmt|;
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|length
operator|=
name|smprespLen
expr_stmt|;
comment|/* Initialization of callback and etc */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxNumXchgs
condition|;
name|i
operator|++
control|)
block|{
name|ttdsaXchg
operator|->
name|id
operator|=
name|i
expr_stmt|;
name|ttdsaXchg
operator|->
name|usedEsgl
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|io_found
operator|=
name|agTRUE
expr_stmt|;
name|ttdsaXchg
operator|->
name|DeviceData
operator|=
name|agNULL
expr_stmt|;
comment|/* callback for IO(ssp) and SMP */
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOCompletionFunc
operator|=
name|ttdsaIOCompleted
expr_stmt|;
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|SMPCompletionFunc
operator|=
name|ttdsaSMPCompleted
expr_stmt|;
name|TDLIST_INIT_ELEMENT
argument_list|(
operator|&
name|ttdsaXchg
operator|->
name|XchgLinks
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
operator|.
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|ttdsaXchg
expr_stmt|;
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|tiIORequest
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|tiIORequest
operator|)
expr_stmt|;
comment|/* Init the tdData portion of tiIORequest context for this exchange */
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|tiIORequest
operator|->
name|tdData
operator|=
name|ttdsaXchg
expr_stmt|;
comment|/* SMP */
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|agIORequest
operator|.
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|ttdsaXchg
expr_stmt|;
comment|/* ttdsaXchg->SMPRequestBody.agIORequest.osData = (void *)&ttdsaXchg->SMPRequestBody; */
comment|/*ttdsaXchg->SMPRequestBody.tiIORequest.tdData = (void *)&ttdsaXchg->SMPRequestBody; */
comment|/* Initialize the CDB and LUN addresses */
name|ttdsaXchg
operator|->
name|tiTgtScsiCmnd
operator|.
name|reqCDB
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|tiTgtScsiCmnd
operator|.
name|scsiLun
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|lun
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|index
operator|=
name|i
expr_stmt|;
name|ttdsaXchg
operator|->
name|respLen
operator|=
name|respLen
expr_stmt|;
comment|/* 100 */
name|ttdsaXchg
operator|->
name|smprespLen
operator|=
name|smprespLen
expr_stmt|;
comment|/* 100 */
name|ttdsaXchg
operator|->
name|TLR
operator|=
literal|0
expr_stmt|;
name|TD_XCHG_SET_STATE
argument_list|(
name|ttdsaXchg
argument_list|,
name|TD_XCHG_STATE_INACTIVE
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
name|ttdsaXchgLinkInit
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
comment|/* Save current response payload/buffer address */
name|virtualAddr
operator|=
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
expr_stmt|;
name|phyAddrLower
operator|=
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrLower
expr_stmt|;
name|smpvirtualAddr
operator|=
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|virtAddr
expr_stmt|;
name|smpphyAddrLower
operator|=
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrLower
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgInit: +1 before\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|maxNumXchgs
operator|-
literal|1
operator|)
condition|)
block|{
comment|/* at the last one */
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgInit: last one break\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Advance to next exchange */
name|ttdsaXchg
operator|=
name|ttdsaXchg
operator|+
literal|1
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgInit: +1 after\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Update response payload/buffer address */
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
operator|=
name|virtualAddr
operator|+
name|respLen
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgInit: pos 1\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrUpper
operator|=
name|phyAddrUpper
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgInit: pos 2\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrLower
operator|=
name|phyAddrLower
operator|+
name|respLen
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgInit: pos 3\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|=
name|respLen
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgInit: pos 4\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Update SMP response payload/buffer address */
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|virtAddr
operator|=
name|smpvirtualAddr
operator|+
name|smprespLen
expr_stmt|;
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrUpper
operator|=
name|smpphyAddrUpper
expr_stmt|;
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrLower
operator|=
name|smpphyAddrLower
operator|+
name|smprespLen
expr_stmt|;
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|length
operator|=
name|smprespLen
expr_stmt|;
block|}
comment|/* Reinitialize counters.      * This must be done at the end      */
name|TD_XCHG_CONTEXT_NO_USED
argument_list|(
name|tiRoot
argument_list|)
operator|=
literal|0
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_FREED
argument_list|(
name|tiRoot
argument_list|)
operator|=
literal|0
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_CMD_RCVD
argument_list|(
name|tiRoot
argument_list|)
operator|=
literal|0
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_START_IO
argument_list|(
name|tiRoot
argument_list|)
operator|=
literal|0
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_SEND_RSP
argument_list|(
name|tiRoot
argument_list|)
operator|=
literal|0
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_IO_COMPLETED
argument_list|(
name|tiRoot
argument_list|)
operator|=
literal|0
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgInit: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ttdsaXchgLinkInit
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|Target
init|=
operator|(
name|ttdsaTgt_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|ttdsaTgt
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|bit8
modifier|*
name|data
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgLinkInit: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgLinkInit: xchg %p\n"
operator|,
name|ttdsaXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgLinkInit: resp %p\n"
operator|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgLinkInit: smpresp %p\n"
operator|,
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|virtAddr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TD_XCHG_GET_STATE
argument_list|(
name|ttdsaXchg
argument_list|)
operator|==
name|TD_XCHG_STATE_ACTIVE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaXchgLinkInit: active xchg *****************; wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ttdsaXchg
operator|->
name|tag
operator|=
literal|0xFFFF
expr_stmt|;
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|agIORequest
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|ttdsaXchg
operator|->
name|statusSent
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|responseSent
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|readRspCollapsed
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|wrtRspCollapsed
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|pTMResp
operator|=
name|agNULL
expr_stmt|;
name|ttdsaXchg
operator|->
name|oustandingIos
operator|=
literal|0
expr_stmt|;
name|ttdsaXchg
operator|->
name|isAborting
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|oslayerAborting
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|isTMRequest
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|io_found
operator|=
name|agTRUE
expr_stmt|;
name|ttdsaXchg
operator|->
name|tiIOToBeAbortedRequest
operator|=
name|agNULL
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchgToBeAborted
operator|=
name|agNULL
expr_stmt|;
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
argument_list|,
literal|0
argument_list|,
name|ttdsaXchg
operator|->
name|respLen
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|virtAddr
argument_list|,
literal|0
argument_list|,
name|ttdsaXchg
operator|->
name|smprespLen
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|bit8
operator|*
operator|)
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ttdsaXchg
operator|->
name|respLen
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|data
index|[
name|i
index|]
operator|!=
literal|0
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"!! ttdsaXchgLinkInit: data[%d] 0x%x\n"
operator|,
name|i
operator|,
name|data
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|ttdsaXchg
operator|->
name|DeviceData
operator|=
name|agNULL
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgLinkInit: id %d\n"
operator|,
name|ttdsaXchg
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TD_XCHG_SET_STATE
argument_list|(
name|ttdsaXchg
argument_list|,
name|TD_XCHG_STATE_INACTIVE
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
name|ttdsaXchg
operator|->
name|XchgLinks
argument_list|,
operator|&
name|Target
operator|->
name|ttdsaXchgData
operator|.
name|xchgFreeList
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_FREED
argument_list|(
name|tiRoot
argument_list|)
operator|=
name|TD_XCHG_CONTEXT_NO_FREED
argument_list|(
name|tiRoot
argument_list|)
operator|+
literal|1
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgLinkInit: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*    before: ttdsaXchg is in xchgBusyList    after: ttdsaXchg is in xchgFreeList  */
end_comment

begin_function
name|osGLOBAL
name|void
name|ttdsaXchgFreeStruct
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|Target
init|=
operator|(
name|ttdsaTgt_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|ttdsaTgt
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|bit8
modifier|*
name|data
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgFreeStruct: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgFreeStruct: xchg %p\n"
operator|,
name|ttdsaXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgFreeStruct: resp %p\n"
operator|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgFreeStruct: smpresp %p\n"
operator|,
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|virtAddr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TD_XCHG_GET_STATE
argument_list|(
name|ttdsaXchg
argument_list|)
operator|==
name|TD_XCHG_STATE_INACTIVE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaXchgFreeStruct: INACTIVE xchg *****************, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ttdsaXchg
operator|->
name|tag
operator|=
literal|0xFFFF
expr_stmt|;
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|agIORequest
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|ttdsaXchg
operator|->
name|statusSent
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|responseSent
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|readRspCollapsed
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|wrtRspCollapsed
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|pTMResp
operator|=
name|agNULL
expr_stmt|;
name|ttdsaXchg
operator|->
name|oustandingIos
operator|=
literal|0
expr_stmt|;
name|ttdsaXchg
operator|->
name|isAborting
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|oslayerAborting
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|isTMRequest
operator|=
name|agFALSE
expr_stmt|;
name|ttdsaXchg
operator|->
name|io_found
operator|=
name|agTRUE
expr_stmt|;
name|ttdsaXchg
operator|->
name|tiIOToBeAbortedRequest
operator|=
name|agNULL
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchgToBeAborted
operator|=
name|agNULL
expr_stmt|;
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
argument_list|,
literal|0
argument_list|,
name|ttdsaXchg
operator|->
name|respLen
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|virtAddr
argument_list|,
literal|0
argument_list|,
name|ttdsaXchg
operator|->
name|smprespLen
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|bit8
operator|*
operator|)
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ttdsaXchg
operator|->
name|respLen
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|data
index|[
name|i
index|]
operator|!=
literal|0
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"!! ttdsaXchgFreeStruct: data[%d] 0x%x\n"
operator|,
name|i
operator|,
name|data
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|ttdsaXchg
operator|->
name|DeviceData
operator|=
name|agNULL
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgFreeStruct: id %d\n"
operator|,
name|ttdsaXchg
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|TD_XCHG_SET_STATE
argument_list|(
name|ttdsaXchg
argument_list|,
name|TD_XCHG_STATE_INACTIVE
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|ttdsaXchg
operator|->
name|XchgLinks
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
name|ttdsaXchg
operator|->
name|XchgLinks
argument_list|,
operator|&
name|Target
operator|->
name|ttdsaXchgData
operator|.
name|xchgFreeList
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_FREED
argument_list|(
name|tiRoot
argument_list|)
operator|=
name|TD_XCHG_CONTEXT_NO_FREED
argument_list|(
name|tiRoot
argument_list|)
operator|+
literal|1
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgFreeStruct: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*    before: ttdsaXchg is in xchgFreeList    after: ttdsaXchg is in xchgBusyList  */
end_comment

begin_function
name|osGLOBAL
name|ttdsaXchg_t
modifier|*
name|ttdsaXchgGetStruct
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|Target
init|=
operator|(
name|ttdsaTgt_t
operator|*
operator|)
name|osData
operator|->
name|ttdsaTgt
decl_stmt|;
name|tdList_t
modifier|*
name|Link
decl_stmt|;
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
init|=
name|agNULL
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"ttdsaXchgGetStruct: enter\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|Target
operator|->
name|ttdsaXchgData
operator|.
name|xchgFreeList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaXchgGetStruct: no free ttdsaXchgData\n"
operator|)
argument_list|)
expr_stmt|;
comment|//    ttdsaDumpallXchg(tiRoot);
return|return
name|agNULL
return|;
block|}
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|Link
argument_list|,
operator|&
name|Target
operator|->
name|ttdsaXchgData
operator|.
name|xchgFreeList
argument_list|)
expr_stmt|;
if|if
condition|(
name|Link
operator|==
name|agNULL
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaXchgGetStruct: Link NULL: PRBLM \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|ttdsaXchg
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|ttdsaXchg_t
argument_list|,
name|XchgLinks
argument_list|,
name|Link
argument_list|)
expr_stmt|;
if|if
condition|(
name|TD_XCHG_GET_STATE
argument_list|(
name|ttdsaXchg
argument_list|)
operator|==
name|TD_XCHG_STATE_ACTIVE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaXchgGetStruct: ACTIVE xchg *****************, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|ttdsaXchg
operator|->
name|XchgLinks
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
name|ttdsaXchg
operator|->
name|XchgLinks
argument_list|,
operator|&
name|Target
operator|->
name|ttdsaXchgData
operator|.
name|xchgFreeList
argument_list|)
expr_stmt|;
name|TD_XCHG_SET_STATE
argument_list|(
name|ttdsaXchg
argument_list|,
name|TD_XCHG_STATE_INACTIVE
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|ttdsaXchg
operator|->
name|XchgLinks
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
name|ttdsaXchg
operator|->
name|XchgLinks
argument_list|,
operator|&
name|Target
operator|->
name|ttdsaXchgData
operator|.
name|xchgBusyList
argument_list|)
expr_stmt|;
name|TD_XCHG_SET_STATE
argument_list|(
name|ttdsaXchg
argument_list|,
name|TD_XCHG_STATE_ACTIVE
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_USED
argument_list|(
name|tiRoot
argument_list|)
operator|=
name|TD_XCHG_CONTEXT_NO_USED
argument_list|(
name|tiRoot
argument_list|)
operator|+
literal|1
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ttdsaXchgGetStruct: id %d\n"
operator|,
name|ttdsaXchg
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|ttdsaXchg
return|;
block|}
end_function

begin_comment
comment|/* for debugging */
end_comment

begin_function
name|osGLOBAL
name|void
name|ttdsaDumpallXchg
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|Target
init|=
operator|(
name|ttdsaTgt_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|ttdsaTgt
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|tmpTarget
decl_stmt|;
name|tdList_t
modifier|*
name|XchgList
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|tmpTarget
operator|=
name|Target
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpTarget
operator|->
name|ttdsaXchgData
operator|.
name|xchgFreeList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaDumpallXchg: no FREE ttdsaXchgData\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|XchgList
operator|=
name|tmpTarget
operator|->
name|ttdsaXchgData
operator|.
name|xchgFreeList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|XchgList
operator|!=
operator|&
operator|(
name|tmpTarget
operator|->
name|ttdsaXchgData
operator|.
name|xchgFreeList
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|ttdsaXchg
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|ttdsaXchg_t
argument_list|,
name|XchgLinks
argument_list|,
name|XchgList
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaDumpallXchg: FREE id %d state %d\n"
operator|,
name|ttdsaXchg
operator|->
name|id
operator|,
name|TD_XCHG_GET_STATE
argument_list|(
name|ttdsaXchg
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|XchgList
operator|=
name|XchgList
operator|->
name|flink
expr_stmt|;
block|}
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpTarget
operator|->
name|ttdsaXchgData
operator|.
name|xchgBusyList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaDumpallXchg: no BUSY ttdsaXchgData\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_TGT_LOCK
argument_list|)
expr_stmt|;
name|XchgList
operator|=
name|tmpTarget
operator|->
name|ttdsaXchgData
operator|.
name|xchgBusyList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|XchgList
operator|!=
operator|&
operator|(
name|tmpTarget
operator|->
name|ttdsaXchgData
operator|.
name|xchgBusyList
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|ttdsaXchg
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|ttdsaXchg_t
argument_list|,
name|XchgLinks
argument_list|,
name|XchgList
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaDumpallXchg: BUSY id %d state %d\n"
operator|,
name|ttdsaXchg
operator|->
name|id
operator|,
name|TD_XCHG_GET_STATE
argument_list|(
name|ttdsaXchg
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|XchgList
operator|=
name|XchgList
operator|->
name|flink
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PASSTHROUGH
end_ifdef

begin_function
name|osGLOBAL
name|bit32
name|tiTGTPassthroughCmndRegister
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPortalContext_t
modifier|*
name|tiportalContext
parameter_list|,
name|tiPassthroughProtocol_t
name|tiProtocol
parameter_list|,
name|tiPassthroughSubProtocol_t
name|tiSubProtocol
parameter_list|,
name|tiPassthroughFrameType_t
name|tiFrameType
parameter_list|,
name|ostiProcessPassthroughCmnd_t
name|agPasthroughCB
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|Target
init|=
operator|(
name|ttdsaTgt_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|ttdsaTgt
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTPassthroughCmndRegister: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* error checking */
if|if
condition|(
name|tiProtocol
operator|!=
name|tiSASATA
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTPassthroughCmndRegister: not supported protocol %d\n"
operator|,
name|tiProtocol
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tiSubProtocol
operator|!=
name|tiSSP
operator|||
name|tiSubProtocol
operator|!=
name|tiSTP
operator|||
name|tiSubProtocol
operator|!=
name|tiSMP
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTPassthroughCmndRegister: not supported sub protocol %d\n"
operator|,
name|tiSubProtocol
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tiFrameType
operator|==
name|tiSMPResponse
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTPassthroughCmndRegister: SMP response frametype %d\n"
operator|)
argument_list|)
expr_stmt|;
name|Target
operator|->
name|PasthroughCB
operator|=
name|agPasthroughCB
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiFrameType
operator|==
name|tiSSPPMC
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTPassthroughCmndRegister: RMC response frametype %d\n"
operator|)
argument_list|)
expr_stmt|;
name|Target
operator|->
name|PasthroughCB
operator|=
name|agPasthroughCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTPassthroughCmndRegister: not supported frametype %d\n"
operator|,
name|tiFrameType
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


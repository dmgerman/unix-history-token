begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  * $RCSfile: ttdio.c,v $  *  * Copyright 2006 PMC-Sierra, Inc.  *  *  * This file contains initiator IO related functions in TD layer  *  */
end_comment

begin_include
include|#
directive|include
file|<osenv.h>
end_include

begin_include
include|#
directive|include
file|<ostypes.h>
end_include

begin_include
include|#
directive|include
file|<osdebug.h>
end_include

begin_include
include|#
directive|include
file|<sa.h>
end_include

begin_include
include|#
directive|include
file|<saapi.h>
end_include

begin_include
include|#
directive|include
file|<saosapi.h>
end_include

begin_include
include|#
directive|include
file|<titypes.h>
end_include

begin_include
include|#
directive|include
file|<ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<tiapi.h>
end_include

begin_include
include|#
directive|include
file|<tiglobal.h>
end_include

begin_include
include|#
directive|include
file|<tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<osstring.h>
end_include

begin_include
include|#
directive|include
file|<tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<itddefs.h>
end_include

begin_include
include|#
directive|include
file|<itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<ttdtxchg.h>
end_include

begin_include
include|#
directive|include
file|<ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<tdproto.h>
end_include

begin_comment
comment|/*  Start For trace only */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_function_decl
name|unsigned
name|__int64
name|GetHiResTimeStamp
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|TD_DEBUG_TRACE_ENABLE
end_undef

begin_define
define|#
directive|define
name|TD_DEBUG_IO_TRACE_BUFFER_MAX
value|1024
end_define

begin_typedef
typedef|typedef
struct|struct
name|TDDebugTraceEntry_s
block|{
name|bit64
name|Time
decl_stmt|;
name|ttdsaXchg_t
name|ttdsaXchg
decl_stmt|;
name|tdsaDeviceData_t
name|oneDeviceData
decl_stmt|;
block|}
name|TDDebugTraceEntry_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|TDDebugTrace_s
block|{
name|bit32
name|Idx
decl_stmt|;
name|bit32
name|pad
decl_stmt|;
name|TDDebugTraceEntry_t
name|Data
index|[
name|TD_DEBUG_IO_TRACE_BUFFER_MAX
index|]
decl_stmt|;
block|}
name|TDDebugTrace_t
typedef|;
end_typedef

begin_function_decl
name|void
name|TDTraceInit
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|TDTraceAdd
parameter_list|(
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|TD_DEBUG_TRACE_ENABLE
end_ifdef

begin_define
define|#
directive|define
name|TD_DEBUG_TRACE
parameter_list|(
name|ttdsaXchg
parameter_list|,
name|oneDeviceData
parameter_list|)
value|TDTraceAdd(ttdsaXchg, oneDeviceData)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|TD_DEBUG_TRACE
parameter_list|(
name|ttdsaXchg
parameter_list|,
name|oneDeviceData
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|TDDebugTrace_t
name|TraceData
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|TDTraceInit
parameter_list|(
name|void
parameter_list|)
block|{
name|osti_memset
argument_list|(
operator|&
name|TraceData
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TraceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|TDTraceAdd
parameter_list|(
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
specifier|static
name|bit32
name|TraceIdx
init|=
literal|0
decl_stmt|;
name|TraceData
operator|.
name|Idx
operator|=
name|TraceIdx
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|TraceData
operator|.
name|Data
index|[
name|TraceIdx
index|]
operator|.
name|Time
operator|=
name|GetHiResTimeStamp
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|osti_memcpy
argument_list|(
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|TraceData
operator|.
name|Data
index|[
name|TraceIdx
index|]
operator|.
name|ttdsaXchg
operator|)
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|ttdsaXchg
argument_list|,
sizeof|sizeof
argument_list|(
name|ttdsaXchg_t
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|TraceData
operator|.
name|Data
index|[
name|TraceIdx
index|]
operator|.
name|oneDeviceData
operator|)
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|oneDeviceData
argument_list|,
sizeof|sizeof
argument_list|(
name|tdsaDeviceData_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|TraceData
operator|.
name|Data
index|[
name|TraceIdx
index|]
operator|.
name|ttdsaXchg
operator|=
name|ttdsaXchg
expr_stmt|;
name|TraceData
operator|.
name|Data
index|[
name|TraceIdx
index|]
operator|.
name|oneDeviceData
operator|=
name|oneDeviceData
expr_stmt|;
endif|#
directive|endif
name|TraceIdx
operator|++
expr_stmt|;
if|if
condition|(
name|TraceIdx
operator|>=
name|TD_DEBUG_IO_TRACE_BUFFER_MAX
condition|)
block|{
name|TraceIdx
operator|=
literal|0
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  End For trace only */
end_comment

begin_function
name|osGLOBAL
name|void
name|ttdsaSSPReqReceived
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|bit32
name|agInitiatorTag
parameter_list|,
name|bit32
name|parameter
parameter_list|,
name|bit32
name|agFrameLen
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
decl_stmt|;
comment|/*  agsaSSPCmdInfoUnit_t   cmdIU; */
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|agFrameType
decl_stmt|,
name|TLR
decl_stmt|;
name|TD_XCHG_CONTEXT_NO_CMD_RCVD
argument_list|(
name|tiRoot
argument_list|)
operator|=
name|TD_XCHG_CONTEXT_NO_CMD_RCVD
argument_list|(
name|tiRoot
argument_list|)
operator|+
literal|1
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSSPReqReceived: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agFrameType
operator|=
name|TD_GET_FRAME_TYPE
argument_list|(
name|parameter
argument_list|)
expr_stmt|;
name|TLR
operator|=
name|TD_GET_TLR
argument_list|(
name|parameter
argument_list|)
expr_stmt|;
comment|/*note:     in ini, agDevHandle->osData =  tdsaDeviceData_t     is set in tdssAddDevicedataToSharedcontext()      in tdsaDeviceDataInit()     oneDeviceData->tiDeviceHandle.tdData has been initialized      */
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSSPReqReceived: no device data\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ttdsaXchg
operator|=
name|ttdsaXchgGetStruct
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttdsaXchg
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSSPReqReceived: no free xchg structures\n"
operator|)
argument_list|)
expr_stmt|;
comment|//    ttdsaDumpallXchg(tiRoot);
return|return;
block|}
if|if
condition|(
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|tiIORequest
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSSPReqReceived: tiIORequest is NULL\n"
operator|)
argument_list|)
expr_stmt|;
comment|//    ttdsaDumpallXchg(tiRoot);
return|return;
block|}
name|oneDeviceData
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
comment|/* saving the device */
name|ttdsaXchg
operator|->
name|DeviceData
operator|=
name|oneDeviceData
expr_stmt|;
name|ttdsaXchg
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|ttdsaXchg
operator|->
name|tiRoot
operator|=
name|tiRoot
expr_stmt|;
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* initiator tag */
name|ttdsaXchg
operator|->
name|tag
operator|=
operator|(
name|bit16
operator|)
name|agInitiatorTag
expr_stmt|;
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetReq
operator|.
name|agTag
operator|=
name|ttdsaXchg
operator|->
name|tag
expr_stmt|;
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetResponse
operator|.
name|agTag
operator|=
name|ttdsaXchg
operator|->
name|tag
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ttdsaSSPReqReceived: initiator tag 0x%x\n"
operator|,
name|agInitiatorTag
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agFrameType
operator|==
name|OSSA_FRAME_TYPE_SSP_CMD
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSSPReqReceived: CMD frame type\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* reads agsaSSPResponseInfoUnit_t */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|agSSPCmndIU
argument_list|,
name|agFrameLen
argument_list|)
expr_stmt|;
name|tdsaProcessCDB
argument_list|(
operator|&
name|ttdsaXchg
operator|->
name|agSSPCmndIU
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|FrameType
operator|=
name|SAS_CMND
expr_stmt|;
comment|/*          ** As the last thing we call the disk module to handle the SCSI CDB.          ** The disk module will call tiTGTIOStart to start a data phase.          */
comment|/* typedef struct        {        bit8      *reqCDB;        bit8      *scsiLun,        bit32     taskAttribute;        bi32      taskId;        bit32     crn;        } tiTargetScsiCmnd_t;          */
comment|/* what about reqCDB and scsiLun */
comment|/* coverting task attributes from SAS TISA */
switch|switch
condition|(
name|SA_SSPCMD_GET_TASKATTRIB
argument_list|(
operator|&
name|ttdsaXchg
operator|->
name|agSSPCmndIU
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|ttdsaXchg
operator|->
name|tiTgtScsiCmnd
operator|.
name|taskAttribute
operator|=
name|TASK_SIMPLE
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|ttdsaXchg
operator|->
name|tiTgtScsiCmnd
operator|.
name|taskAttribute
operator|=
name|TASK_HEAD_OF_QUEUE
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|ttdsaXchg
operator|->
name|tiTgtScsiCmnd
operator|.
name|taskAttribute
operator|=
name|TASK_ORDERED
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSSPReqReceived: reserved taskAttribute 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|efb_tp_taskAttribute
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|tiTgtScsiCmnd
operator|.
name|taskAttribute
operator|=
name|TASK_SIMPLE
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|ttdsaXchg
operator|->
name|tiTgtScsiCmnd
operator|.
name|taskAttribute
operator|=
name|TASK_ACA
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSSPReqReceived: unknown taskAttribute 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|efb_tp_taskAttribute
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|efb_tp_taskAttribute
operator|=
name|TASK_SIMPLE
expr_stmt|;
break|break;
block|}
name|ttdsaXchg
operator|->
name|tiTgtScsiCmnd
operator|.
name|taskId
operator|=
name|agInitiatorTag
expr_stmt|;
name|ttdsaXchg
operator|->
name|tiTgtScsiCmnd
operator|.
name|crn
operator|=
literal|0
expr_stmt|;
name|ttdsaXchg
operator|->
name|TLR
operator|=
name|TLR
expr_stmt|;
comment|/* call ostiProcessScsiReq */
name|ostiProcessScsiReq
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|tiTgtScsiCmnd
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|tiIORequest
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|tiDeviceHandle
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agFrameType
operator|==
name|OSSA_FRAME_TYPE_SSP_TASK
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSSPReqReceived: TM frame type\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       reads aagsaSSPScsiTaskMgntReq_t       including lun          */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|agTMIU
argument_list|,
name|agFrameLen
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|FrameType
operator|=
name|SAS_TM
expr_stmt|;
comment|/*       call task process mangement fn          */
name|ttdsaTMProcess
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSSPReqReceived: unknown frame type\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|dumpCDB
parameter_list|(
name|bit8
modifier|*
name|cdb
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"cdb[%d] 0x%x\n"
operator|,
name|i
operator|,
name|cdb
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tdsaProcessCDB
parameter_list|(
name|agsaSSPCmdInfoUnit_t
modifier|*
name|cmdIU
parameter_list|,
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|ttdsaXchg
operator|->
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|Target
init|=
operator|(
name|ttdsaTgt_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|ttdsaTgt
decl_stmt|;
name|bit8
name|group
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|CDB6_t
modifier|*
name|cdb6
decl_stmt|;
endif|#
directive|endif
name|CDB10_t
modifier|*
name|cdb10
decl_stmt|;
name|CDB12_t
modifier|*
name|cdb12
decl_stmt|;
name|CDB16_t
modifier|*
name|cdb16
decl_stmt|;
name|bit32
name|unknown
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|len
init|=
literal|0
decl_stmt|;
name|group
operator|=
name|cmdIU
operator|->
name|cdb
index|[
literal|0
index|]
operator|&
name|CDB_GRP_MASK
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: start\n"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmdIU
operator|->
name|cdb
index|[
literal|0
index|]
condition|)
block|{
case|case
name|SCSIOPC_REPORT_LUN
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: REPORT_LUN\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchType
operator|=
name|AGSA_SSP_TGT_READ_DATA
expr_stmt|;
break|break;
case|case
name|SCSIOPC_INQUIRY
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: INQUIRY\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchType
operator|=
name|AGSA_SSP_TGT_READ_DATA
expr_stmt|;
break|break;
case|case
name|SCSIOPC_TEST_UNIT_READY
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: TEST_UNIT_READY\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchType
operator|=
name|AGSA_SSP_TGT_READ_DATA
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_CAPACITY_10
case|:
case|case
name|SCSIOPC_READ_CAPACITY_16
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: READ CAPACITY\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchType
operator|=
name|AGSA_SSP_TGT_READ_DATA
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_6
case|:
comment|/* fall through */
case|case
name|SCSIOPC_READ_10
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: READ\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchType
operator|=
name|AGSA_SSP_TGT_READ_DATA
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_6
case|:
comment|/* fall through */
case|case
name|SCSIOPC_WRITE_10
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: WRITE\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchType
operator|=
name|AGSA_SSP_TGT_WRITE_DATA
expr_stmt|;
break|break;
case|case
name|SCSIOPC_MODE_SENSE_6
case|:
comment|/* fall through */
case|case
name|SCSIOPC_MODE_SENSE_10
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: MODE SENSE\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchType
operator|=
name|AGSA_SSP_TGT_READ_DATA
expr_stmt|;
break|break;
case|case
name|SCSIOPC_SYNCHRONIZE_CACHE_10
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: SCSIOPC_SYNCHRONIZE_CACHE_10\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchType
operator|=
name|AGSA_SSP_TGT_CMD_OR_TASK_RSP
expr_stmt|;
break|break;
case|case
name|SCSIOPC_REQUEST_SENSE
case|:
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaProcessCDB: SCSIOPC_REQUEST_SENSE\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchType
operator|=
name|AGSA_SSP_TGT_READ_DATA
expr_stmt|;
break|break;
default|default:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: UNKNOWN, cbd %d 0x%x\n"
operator|,
name|cmdIU
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|cmdIU
operator|->
name|cdb
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|XchType
operator|=
name|TargetUnknown
expr_stmt|;
break|break;
block|}
comment|/* parse datalen */
switch|switch
condition|(
name|group
condition|)
block|{
case|case
name|CDB_6BYTE
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: CDB 6 byte, not yet\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|cdb6
operator|=
operator|(
name|CDB6_t
operator|*
operator|)
operator|(
name|cmdIU
operator|->
name|cdb
operator|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: CDB len 0x%x\n"
operator|,
name|cdb6
operator|->
name|len
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDB_10BYTE1
case|:
comment|/* fall through */
case|case
name|CDB_10BYTE2
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: CDB 10 byte\n"
operator|)
argument_list|)
expr_stmt|;
name|cdb10
operator|=
operator|(
name|CDB10_t
operator|*
operator|)
operator|(
name|cmdIU
operator|->
name|cdb
operator|)
expr_stmt|;
name|OSSA_READ_BE_16
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|len
argument_list|,
name|cdb10
operator|->
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: CDB len 0x%x\n"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
name|dumpCDB
argument_list|(
name|cmdIU
operator|->
name|cdb
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDB_12BYTE
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: CDB 12 byte, not yet\n"
operator|)
argument_list|)
expr_stmt|;
name|cdb12
operator|=
operator|(
name|CDB12_t
operator|*
operator|)
operator|(
name|cmdIU
operator|->
name|cdb
operator|)
expr_stmt|;
name|OSSA_READ_BE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|len
argument_list|,
name|cdb12
operator|->
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: CDB len 0x%x\n"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDB_16BYTE
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: CDB 16 byte, not yet\n"
operator|)
argument_list|)
expr_stmt|;
name|cdb16
operator|=
operator|(
name|CDB16_t
operator|*
operator|)
operator|(
name|cmdIU
operator|->
name|cdb
operator|)
expr_stmt|;
name|OSSA_READ_BE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|len
argument_list|,
name|cdb16
operator|->
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: CDB len 0x%x\n"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaProcessCDB: unknow CDB, group %d 0x%x\n"
operator|,
name|group
operator|,
name|group
operator|)
argument_list|)
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
name|unknown
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cmdIU
operator|->
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_READ_6
operator|||
name|cmdIU
operator|->
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_READ_10
operator|||
name|cmdIU
operator|->
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_WRITE_6
operator|||
name|cmdIU
operator|->
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_WRITE_10
condition|)
block|{
name|ttdsaXchg
operator|->
name|dataLen
operator|=
name|len
operator|*
name|Target
operator|->
name|OperatingOption
operator|.
name|BlockSize
expr_stmt|;
block|}
else|else
block|{
name|ttdsaXchg
operator|->
name|dataLen
operator|=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|ttdsaXchg
operator|->
name|dataLen
operator|==
literal|0
operator|&&
name|unknown
operator|==
name|agFALSE
condition|)
block|{
comment|/* this is needed because of min operation in tiTGTIOstart() */
name|ttdsaXchg
operator|->
name|dataLen
operator|=
literal|0xffffffff
expr_stmt|;
block|}
comment|/*  TI_DBG4(("tdsaProcessCDB: datalen 0x%x %d\n", ttdsaXchg->dataLen, ttdsaXchg->dataLen)); */
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *  *  tiTGTIOStart  *  *  Purpose: This function is called by the target OS Specific Module to start  *           the next phase of a SCSI Request.  *  *  Parameters:  *   tiRoot:         Pointer to driver Instance.  *   tiIORequest:    Pointer to the I/O request context for this I/O.  *                   This context was initially passed to the OS Specific Module  *                   in ostiProcessScsiReq().  *   dataOffset:     Offset into the buffer space for this phase.  *   dataLength:     Length of data to move for this phase.  *   dataSGL:        Length/Address pair of where the data is. The SGL list is  *                   allocated and initialized by the OS Specific module.  *   sglVirtualAddr: The virtual address of the first element in agSgl1 when  *                   agSgl1 is used with the type tiSglList.  *                   This field is needed for the TD Layer.  *  *  Return:  *   tiSuccess:     I/O request successfully initiated.  *   tiBusy:        No resources available, try again later.  *   tiError:       Other errors that prevent the I/O request to be started.  *  *  Note:  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiTGTIOStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|bit32
name|dataOffset
parameter_list|,
name|bit32
name|dataLength
parameter_list|,
name|tiSgl_t
modifier|*
name|dataSGL
parameter_list|,
name|void
modifier|*
name|sglVirtualAddr
parameter_list|)
block|{
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
decl_stmt|;
name|agsaSSPTargetRequest_t
modifier|*
name|agSSPTargetReq
decl_stmt|;
name|bit32
name|tiStatus
decl_stmt|;
name|bit32
name|saStatus
decl_stmt|;
name|bit32
name|tdStatus
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: dataLength 0x%x %d\n"
operator|,
name|dataLength
operator|,
name|dataLength
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: dataOffset 0x%x %d\n"
operator|,
name|dataOffset
operator|,
name|dataOffset
operator|)
argument_list|)
expr_stmt|;
comment|/* save infor in ttdsaXchg */
name|ttdsaXchg
operator|=
operator|(
name|ttdsaXchg_t
operator|*
operator|)
name|tiIORequest
operator|->
name|tdData
expr_stmt|;
comment|/* check the state of port */
name|oneDeviceData
operator|=
name|ttdsaXchg
operator|->
name|DeviceData
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOStart: portcontext pid %d is invalid\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|agSSPTargetReq
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetReq
operator|)
expr_stmt|;
comment|/* fills in agsaSASRequestBody_t.agsaSSPTargetRequest_t */
name|agSSPTargetReq
operator|->
name|dataLength
operator|=
operator|(
name|bit32
operator|)
name|MIN
argument_list|(
name|dataLength
argument_list|,
name|ttdsaXchg
operator|->
name|dataLen
argument_list|)
expr_stmt|;
name|agSSPTargetReq
operator|->
name|offset
operator|=
name|dataOffset
expr_stmt|;
name|agSSPTargetReq
operator|->
name|agTag
operator|=
name|ttdsaXchg
operator|->
name|tag
expr_stmt|;
comment|/* SSPTargetReq->agTag has been set in ttdsaSSPReqReceived() */
comment|/* Process TLR */
if|if
condition|(
name|ttdsaXchg
operator|->
name|TLR
operator|==
literal|2
condition|)
block|{
comment|/* diable TLR */
name|agSSPTargetReq
operator|->
name|sspOption
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* enable TLR */
comment|/* bit5: 0 1 11 11 :bit0 */
name|agSSPTargetReq
operator|->
name|sspOption
operator|=
literal|0x1F
expr_stmt|;
block|}
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|TargetIOType
operator|.
name|RegIO
operator|.
name|sglVirtualAddr
operator|=
name|sglVirtualAddr
expr_stmt|;
if|if
condition|(
name|agSSPTargetReq
operator|->
name|dataLength
operator|!=
literal|0
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiTGTIOStart: pos 1\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|TargetIOType
operator|.
name|RegIO
operator|.
name|tiSgl1
operator|=
operator|*
name|dataSGL
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiTGTIOStart: pos 2\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|TargetIOType
operator|.
name|RegIO
operator|.
name|tiSgl1
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|TargetIOType
operator|.
name|RegIO
operator|.
name|tiSgl1
operator|.
name|type
operator|=
name|tiSgl
expr_stmt|;
comment|/* let's send response frame */
if|if
condition|(
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|!=
literal|0
condition|)
block|{
comment|/* senselen != 0, send respsonse */
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: send respsonse\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: resp.length 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|responseSent
operator|=
name|agTRUE
expr_stmt|;
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|IOResponse
operator|++
expr_stmt|;
name|TD_DEBUG_TRACE
argument_list|(
name|ttdsaXchg
argument_list|,
name|ttdsaXchg
operator|->
name|DeviceData
argument_list|)
expr_stmt|;
name|tdStatus
operator|=
name|ttdsaSendResp
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
return|return
name|tiSuccess
return|;
block|}
elseif|else
if|if
condition|(
name|tdStatus
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOStart: (ttdsaSendResp) sending not successful\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOStart: (ttdsaSendResp) sending busy\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiBusy
return|;
block|}
block|}
block|}
comment|/* sets SSPTargetReq->agSgl */
name|tiStatus
operator|=
name|ttdssIOPrepareSGL
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
argument_list|,
name|dataSGL
argument_list|,
name|NULL
argument_list|,
name|sglVirtualAddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOStart: ttdIOPrepareSGL did not return success\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: agroot %p ttdsaXchg %p\n"
operator|,
name|ttdsaXchg
operator|->
name|agRoot
operator|,
name|ttdsaXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: agDevHanlde %p\n"
operator|,
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|agDevHandle
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ttdsaXchg
operator|->
name|readRspCollapsed
operator|==
name|agTRUE
operator|)
operator|||
operator|(
name|ttdsaXchg
operator|->
name|wrtRspCollapsed
operator|==
name|agTRUE
operator|)
condition|)
block|{
comment|/* collapse good response with read  */
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: read rsp collapse\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: initiator tag 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_START_IO
argument_list|(
name|tiRoot
argument_list|)
operator|=
name|TD_XCHG_CONTEXT_NO_START_IO
argument_list|(
name|tiRoot
argument_list|)
operator|+
literal|1
expr_stmt|;
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|IOStart
operator|++
expr_stmt|;
name|TD_DEBUG_TRACE
argument_list|(
name|ttdsaXchg
argument_list|,
name|ttdsaXchg
operator|->
name|DeviceData
argument_list|)
expr_stmt|;
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|agDevHandle
argument_list|,
name|ttdsaXchg
operator|->
name|readRspCollapsed
condition|?
name|AGSA_SSP_TGT_READ_GOOD_RESP
else|:
name|AGSA_SSP_TGT_WRITE_GOOD_RESP
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: normal\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTIOStart: initiator tag 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_START_IO
argument_list|(
name|tiRoot
argument_list|)
operator|=
name|TD_XCHG_CONTEXT_NO_START_IO
argument_list|(
name|tiRoot
argument_list|)
operator|+
literal|1
expr_stmt|;
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|IOStart
operator|++
expr_stmt|;
name|TD_DEBUG_TRACE
argument_list|(
name|ttdsaXchg
argument_list|,
name|ttdsaXchg
operator|->
name|DeviceData
argument_list|)
expr_stmt|;
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
comment|/* agRoot, */
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|agDevHandle
argument_list|,
name|ttdsaXchg
operator|->
name|XchType
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
return|return
name|tiSuccess
return|;
block|}
elseif|else
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOStart: sending not successful\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOStart: sending busy\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiBusy
return|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|EDC_ENABLE
end_ifdef

begin_comment
comment|/*****************************************************************************  *  *  tiTGTIOStart  *  *  Purpose: This function is called by the target OS Specific Module to start  *           the next phase of a SCSI Request.  *  *  Parameters:  *   tiRoot:         Pointer to driver Instance.  *   tiIORequest:    Pointer to the I/O request context for this I/O.  *                   This context was initially passed to the OS Specific Module  *                   in ostiProcessScsiReq().  *   dataOffset:     Offset into the buffer space for this phase.  *   dataLength:     Length of data to move for this phase.  *   dataSGL:        Length/Address pair of where the data is. The SGL list is  *                   allocated and initialized by the OS Specific module.  *   sglVirtualAddr: The virtual address of the first element in agSgl1 when  *                   agSgl1 is used with the type tiSglList.  *                   This field is needed for the TD Layer.  *   difOption:      DIF option.  *  *  Return:  *   tiSuccess:     I/O request successfully initiated.  *   tiBusy:        No resources available, try again later.  *   tiError:       Other errors that prevent the I/O request to be started.  *  *  Note:  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiTGTIOStartDif
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|bit32
name|dataOffset
parameter_list|,
name|bit32
name|dataLength
parameter_list|,
name|tiSgl_t
modifier|*
name|dataSGL
parameter_list|,
name|void
modifier|*
name|sglVirtualAddr
parameter_list|,
name|tiDif_t
modifier|*
name|difOption
parameter_list|)
block|{
comment|/* This function was never used by SAS/SATA. Use tiTGTSuperIOStart() instead. */
return|return
name|tiBusy
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|osGLOBAL
name|bit32
name|ttdssIOPrepareSGL
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
parameter_list|,
name|tiSgl_t
modifier|*
name|tiSgl1
parameter_list|,
name|tiSgl_t
modifier|*
name|tiSgl2
parameter_list|,
name|void
modifier|*
name|sglVirtualAddr
parameter_list|)
block|{
name|agsaSgl_t
modifier|*
name|agSgl
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ttdssIOPrepareSGL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agSgl
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetReq
operator|.
name|agSgl
operator|)
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tiSgl1
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdssIOPrepareSGL: Error tiSgl1 is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|agSgl
operator|->
name|sgUpper
operator|=
name|tiSgl1
operator|->
name|upper
expr_stmt|;
name|agSgl
operator|->
name|sgLower
operator|=
name|tiSgl1
operator|->
name|lower
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
name|tiSgl1
operator|->
name|len
expr_stmt|;
name|agSgl
operator|->
name|extReserved
operator|=
name|tiSgl1
operator|->
name|type
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/* temp for debugging */
end_comment

begin_function
name|void
name|dumpresp
parameter_list|(
name|bit8
modifier|*
name|resp
parameter_list|,
name|bit32
name|len
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"resp[%d] 0x%x\n"
operator|,
name|i
operator|,
name|resp
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|ttdsaSendResp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|bit32
name|saStatus
decl_stmt|;
name|agsaSSPTargetResponse_t
modifier|*
name|agSSPTargetResp
decl_stmt|;
name|agRequestType
operator|=
name|AGSA_SSP_TGT_CMD_OR_TASK_RSP
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSendResp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSendResp: agroot %p ttdsaXchg %p\n"
operator|,
name|ttdsaXchg
operator|->
name|agRoot
operator|,
name|ttdsaXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSendResp:: agDevHanlde %p\n"
operator|,
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|agDevHandle
operator|)
argument_list|)
expr_stmt|;
comment|/* sas response */
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSendResp: len 0x%x \n"
operator|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSendResp: upper 0x%x \n"
operator|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrUpper
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSendResp: lower 0x%x \n"
operator|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrLower
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSendResp: initiator tag 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|agSSPTargetResp
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetResponse
operator|)
expr_stmt|;
name|agSSPTargetResp
operator|->
name|agTag
operator|=
name|ttdsaXchg
operator|->
name|tag
expr_stmt|;
name|agSSPTargetResp
operator|->
name|respBufLength
operator|=
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
expr_stmt|;
name|agSSPTargetResp
operator|->
name|respBufUpper
operator|=
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrUpper
expr_stmt|;
name|agSSPTargetResp
operator|->
name|respBufLower
operator|=
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrLower
expr_stmt|;
name|agSSPTargetResp
operator|->
name|respOption
operator|=
literal|3
expr_stmt|;
comment|/* Retry on both ACK/NAK timeout and NAK received */
comment|/* temporary solution for T2D Combo*/
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|&&
name|defined
argument_list|(
name|TARGET_DRIVER
argument_list|)
comment|/* nothing */
else|#
directive|else
if|if
condition|(
name|agSSPTargetResp
operator|->
name|respBufLength
operator|<=
name|AGSA_MAX_SSPPAYLOAD_VIA_SFO
condition|)
name|agSSPTargetResp
operator|->
name|frameBuf
operator|=
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
expr_stmt|;
else|else
name|agSSPTargetResp
operator|->
name|frameBuf
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
name|dumpresp
argument_list|(
operator|(
name|bit8
operator|*
operator|)
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
argument_list|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
argument_list|)
expr_stmt|;
name|TD_XCHG_CONTEXT_NO_SEND_RSP
argument_list|(
name|TD_GET_TIROOT
argument_list|(
name|agRoot
argument_list|)
argument_list|)
operator|=
name|TD_XCHG_CONTEXT_NO_SEND_RSP
argument_list|(
name|TD_GET_TIROOT
argument_list|(
name|agRoot
argument_list|)
argument_list|)
operator|+
literal|1
expr_stmt|;
name|oneDeviceData
operator|=
name|ttdsaXchg
operator|->
name|DeviceData
expr_stmt|;
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
comment|/* agRoot,*/
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|agDevHandle
argument_list|,
comment|/* agDevHandle, */
name|agRequestType
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaSendResp: sending successful\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSendResp: sending not successful\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSendResp: sending busy\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_BUSY
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ttdsaIOCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
init|=
operator|(
name|ttdsaXchg_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
decl_stmt|;
comment|/* done in ttdsaXchgInit() */
name|bit32
name|IOFailed
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|statusDetail
init|=
literal|0
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
endif|#
directive|endif
name|bit32
name|tdStatus
decl_stmt|;
name|bit32
name|saStatus
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaDifDetails_t
modifier|*
name|DifDetail
decl_stmt|;
endif|#
directive|endif
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaIOCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tiRoot
operator|=
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
operator|)
operator|->
name|tiRoot
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|DifDetail
operator|=
operator|(
name|agsaDifDetails_t
operator|*
operator|)
name|agFrameHandle
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: tiRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TD_XCHG_CONTEXT_NO_IO_COMPLETED
argument_list|(
name|tiRoot
argument_list|)
operator|=
name|TD_XCHG_CONTEXT_NO_IO_COMPLETED
argument_list|(
name|tiRoot
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|TD_XCHG_GET_STATE
argument_list|(
name|ttdsaXchg
argument_list|)
operator|!=
name|TD_XCHG_STATE_ACTIVE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: XCHG is not active *****************\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ttdsaXchg
operator|->
name|isTMRequest
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"ttdsaIOCompleted: COMMAND \n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ttdsaIOCompleted: ttdsaXchg %p\n"
operator|,
name|ttdsaXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ttdsaIOCompleted: ttdsaXchg->IORequestBody.EsglPageList %p\n"
operator|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|EsglPageList
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ttdsaIOCompleted: command initiator tag 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
comment|/* call tdsafreeesglpages only for xchg that used eslg */
if|if
condition|(
name|ttdsaXchg
operator|->
name|usedEsgl
operator|==
name|agTRUE
condition|)
block|{
name|tdsaFreeEsglPages
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|EsglPageList
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|usedEsgl
operator|=
name|agFALSE
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* successful case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"ttdsaIOCompleted: osIOSuccess\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ttdsaXchg
operator|->
name|readRspCollapsed
operator|==
name|agTRUE
operator|)
operator|||
operator|(
name|ttdsaXchg
operator|->
name|wrtRspCollapsed
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|ttdsaXchg
operator|->
name|responseSent
operator|=
name|agTRUE
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaIOCompleted: read rsp collapse\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ttdsaXchg
operator|->
name|statusSent
operator|==
name|agTRUE
condition|)
block|{
comment|/*           the response has already been set and ready           but has NOT been sent                  */
if|if
condition|(
name|ttdsaXchg
operator|->
name|responseSent
operator|==
name|agFALSE
condition|)
block|{
comment|/* let's send the response for IO */
name|TI_DBG6
argument_list|(
operator|(
literal|"ttdsaIOCompleted: sending response\n"
operator|)
argument_list|)
expr_stmt|;
name|TD_DEBUG_TRACE
argument_list|(
name|ttdsaXchg
argument_list|,
name|ttdsaXchg
operator|->
name|DeviceData
argument_list|)
expr_stmt|;
name|tdStatus
operator|=
name|ttdsaSendResp
argument_list|(
name|agRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdStatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: attention needed\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ttdsaXchg
operator|->
name|responseSent
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaIOCompleted: read rsp collapse and complete \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* the response has been sent */
name|TI_DBG6
argument_list|(
operator|(
literal|"ttdsaIOCompleted: already sent response, notify OS\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TD_XCHG_GET_STATE
argument_list|(
name|ttdsaXchg
argument_list|)
operator|==
name|TD_XCHG_STATE_INACTIVE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: wrong DEQUEUE_THIS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*                      * Notify the OS Specific Module, so it can free its resource.                      */
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaIOCompleted: calling ostiTargetIOCompleted\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiTargetIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|)
expr_stmt|;
comment|/* clean up resources */
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* sent */
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"ttdsaIOCompleted: osIOSuccess: nextphase\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* the response has not been set; still in data phase */
comment|/* we need to tell the disk module to start the next phase */
name|ostiNextDataPhase
argument_list|(
name|ttdsaXchg
operator|->
name|tiRoot
argument_list|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|tiIORequest
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
comment|/* success */
comment|/* handle error cases */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: DIF detail UpperLBA 0x%08x LowerLBA 0x%08x\n"
operator|,
name|DifDetail
operator|->
name|UpperLBA
operator|,
name|DifDetail
operator|->
name|LowerLBA
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_ABORTED
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: ABORTED\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIOFailed
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailAborted
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_OVERFLOW
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: OVERFLOW\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIOOverRun
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|OSSA_IO_UNDERFLOW
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: UNDERFLOW\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIOUnderRun
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORT_RESET
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: ABORT_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIOFailed
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailAbortReset
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIOEncryptError
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailDekKeyCacheMiss
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIOEncryptError
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailDekKeyCacheMiss
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIODifError
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailDifAppTagMismatch
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIODifError
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailDifRefTagMismatch
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIODifError
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailDifCrcMismatch
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|OSSA_IO_FAILED
case|:
comment|/* fall through */
case|case
name|OSSA_IO_NO_DEVICE
case|:
comment|/* fall through */
comment|//case OSSA_IO_NO_SUPPORT: /* fall through */       /*added to compile tgt_drv (TP)*/
case|case
name|OSSA_IO_LINK_FAILURE
case|:
comment|/* fall through */
case|case
name|OSSA_IO_PROG_ERROR
case|:
comment|/* fall through */
case|case
name|OSSA_IO_DS_NON_OPERATIONAL
case|:
comment|/* fall through */
case|case
name|OSSA_IO_DS_IN_RECOVERY
case|:
comment|/* fall through */
case|case
name|OSSA_IO_TM_TAG_NOT_FOUND
case|:
comment|/* fall through */
case|case
name|OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE
case|:
comment|/* fall through */
default|default:
name|status
operator|=
name|tiIOFailed
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailOtherError
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: Fail!!!!!!! agIOStatus=0x%x  agIOInfoLen=0x%x agOtherInfo=0x%x\n"
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|,
name|agOtherInfo
operator|)
argument_list|)
expr_stmt|;
comment|//      ttdsaDumpallXchg(tiRoot);
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: OSSA_IO_XFER_OPEN_RETRY_TIMEOUT ttdsaXchg->id 0x%x datalen 0x%x offset 0x%x agTag 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|id
operator|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetReq
operator|.
name|dataLength
operator|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetReq
operator|.
name|offset
operator|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetReq
operator|.
name|agTag
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: statusSent %d responseSent %d\n"
operator|,
name|ttdsaXchg
operator|->
name|statusSent
operator|,
name|ttdsaXchg
operator|->
name|responseSent
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
comment|/* switch */
if|if
condition|(
name|IOFailed
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|agIORequest
operator|->
name|sdkData
operator|==
name|agNULL
condition|)
block|{
name|tiIORequest_t
name|tiIORequest
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: ERROR ttdsaXchg=%p agIOStatus= 0x%x\n"
operator|,
name|ttdsaXchg
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"CDB= 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|0
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|1
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|2
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|3
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|4
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|5
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|6
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|7
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|8
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|9
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|10
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|11
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|12
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|13
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|14
index|]
operator|,
name|ttdsaXchg
operator|->
name|agSSPCmndIU
operator|.
name|cdb
index|[
literal|15
index|]
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TD_XCHG_GET_STATE
argument_list|(
name|ttdsaXchg
argument_list|)
operator|==
name|TD_XCHG_STATE_INACTIVE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: wrong DEQUEUE_THIS  1\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ttdsaXchg
operator|->
name|retries
operator|<=
name|OPEN_RETRY_RETRIES
operator|&&
name|agIOStatus
operator|==
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 1 loc retries on OSSA_IO_XFER_OPEN_RETRY_TIMEOUT\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|agOtherInfo
operator|&
literal|0x1
operator|)
operator|==
literal|1
condition|)
block|{
comment|/* repsonse phase */
name|TI_DBG2
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 0 loc response retry\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* repsonse retry */
name|saStatus
operator|=
name|ttdsaSendResp
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 0 loc retried\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 0 loc retry failed\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/*                              * because we are freeing up the exchange                              * we must let the oslayer know that                              * we are releasing the resources by                              * setting the tdData to NULL                              */
name|tiIORequest
operator|=
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|tiIORequest
expr_stmt|;
name|tiIORequest
operator|.
name|tdData
operator|=
name|agNULL
expr_stmt|;
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|)
expr_stmt|;
comment|/* clean up resources */
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ttdsaXchg
operator|->
name|readRspCollapsed
operator|==
name|agTRUE
operator|)
operator|||
operator|(
name|ttdsaXchg
operator|->
name|wrtRspCollapsed
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
comment|/* agRoot, */
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
argument_list|,
literal|0
argument_list|,
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|agDevHandle
argument_list|,
comment|/* agDevHandle, */
name|ttdsaXchg
operator|->
name|readRspCollapsed
condition|?
name|AGSA_SSP_TGT_READ_GOOD_RESP
else|:
name|AGSA_SSP_TGT_WRITE_GOOD_RESP
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 1 loc retried\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 1 loc retry failed\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/*                              * because we are freeing up the exchange                              * we must let the oslayer know that                              * we are releasing the resources by                              * setting the tdData to NULL                              */
name|tiIORequest
operator|=
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|tiIORequest
expr_stmt|;
name|tiIORequest
operator|.
name|tdData
operator|=
name|agNULL
expr_stmt|;
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|)
expr_stmt|;
comment|/* clean up resources */
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ttdsaXchg
operator|->
name|responseSent
operator|==
name|agFALSE
condition|)
block|{
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
comment|/* agRoot, */
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
argument_list|,
comment|/*agIORequest, */
literal|0
argument_list|,
comment|/* queue number */
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|agDevHandle
argument_list|,
comment|/* agDevHandle, */
name|ttdsaXchg
operator|->
name|XchType
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* repsonse retry */
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 2 loc reponse retry\n"
operator|)
argument_list|)
expr_stmt|;
name|saStatus
operator|=
name|ttdsaSendResp
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 2 loc retried\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 2 loc retry failed\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/*                              * because we are freeing up the exchange                              * we must let the oslayer know that                              * we are releasing the resources by                              * setting the tdData to NULL                              */
name|tiIORequest
operator|=
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|tiIORequest
expr_stmt|;
name|tiIORequest
operator|.
name|tdData
operator|=
name|agNULL
expr_stmt|;
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|)
expr_stmt|;
comment|/* clean up resources */
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|ttdsaXchg
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/*                      * because we are freeing up the exchange                      * we must let the oslayer know that                      * we are releasing the resources by                      * setting the tdData to NULL                      */
name|tiIORequest
operator|=
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|tiIORequest
expr_stmt|;
name|tiIORequest
operator|.
name|tdData
operator|=
name|agNULL
expr_stmt|;
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|)
expr_stmt|;
comment|/* clean up resources */
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* saData == agNULL */
else|else
block|{
name|tiIORequest_t
name|tiIORequest
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 2\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TD_XCHG_GET_STATE
argument_list|(
name|ttdsaXchg
argument_list|)
operator|==
name|TD_XCHG_STATE_INACTIVE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: wrong DEQUEUE_THIS  2\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ttdsaXchg
operator|->
name|retries
operator|<=
name|OPEN_RETRY_RETRIES
operator|&&
name|agIOStatus
operator|==
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 2 loc retries on OSSA_IO_XFER_OPEN_RETRY_TIMEOUT\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|agOtherInfo
operator|&
literal|0x1
operator|)
operator|==
literal|1
condition|)
block|{
comment|/* repsonse phase */
name|TI_DBG2
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 0 loc response retry\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* repsonse retry */
name|saStatus
operator|=
name|ttdsaSendResp
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 0 loc retried\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 0 loc retry failed\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/*                              * because we are freeing up the exchange                              * we must let the oslayer know that                              * we are releasing the resources by                              * setting the tdData to NULL                              */
name|tiIORequest
operator|=
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|tiIORequest
expr_stmt|;
name|tiIORequest
operator|.
name|tdData
operator|=
name|agNULL
expr_stmt|;
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|)
expr_stmt|;
comment|/* clean up resources */
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ttdsaXchg
operator|->
name|readRspCollapsed
operator|==
name|agTRUE
operator|)
operator|||
operator|(
name|ttdsaXchg
operator|->
name|wrtRspCollapsed
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
comment|/* agRoot, */
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
argument_list|,
comment|/* agIORequest, */
literal|0
argument_list|,
comment|/* queue number */
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|agDevHandle
argument_list|,
comment|/* agDevHandle, */
name|ttdsaXchg
operator|->
name|readRspCollapsed
condition|?
name|AGSA_SSP_TGT_READ_GOOD_RESP
else|:
name|AGSA_SSP_TGT_WRITE_GOOD_RESP
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 1 loc retried\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 1 loc retry failed\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/*                              * because we are freeing up the exchange                              * we must let the oslayer know that                              * we are releasing the resources by                              * setting the tdData to NULL                              */
name|tiIORequest
operator|=
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|tiIORequest
expr_stmt|;
name|tiIORequest
operator|.
name|tdData
operator|=
name|agNULL
expr_stmt|;
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|)
expr_stmt|;
comment|/* clean up resources */
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 2 loc ttdsaXchg->id 0x%x datalen 0x%x offset 0x%x agTag 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|id
operator|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetReq
operator|.
name|dataLength
operator|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetReq
operator|.
name|offset
operator|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetReq
operator|.
name|agTag
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttdsaXchg
operator|->
name|responseSent
operator|==
name|agFALSE
condition|)
block|{
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
comment|/* agRoot, */
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
argument_list|,
comment|/* agIORequest, */
literal|0
argument_list|,
comment|/* queue number */
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|agDevHandle
argument_list|,
comment|/* agDevHandle, */
name|ttdsaXchg
operator|->
name|XchType
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 2 loc response retry\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* repsonse retry */
name|saStatus
operator|=
name|ttdsaSendResp
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 2 loc retried\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: 2 loc retry failed\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/*                              * because we are freeing up the exchange                              * we must let the oslayer know that                              * we are releasing the resources by                              * setting the tdData to NULL                              */
name|tiIORequest
operator|=
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|tiIORequest
expr_stmt|;
name|tiIORequest
operator|.
name|tdData
operator|=
name|agNULL
expr_stmt|;
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|)
expr_stmt|;
comment|/* clean up resources */
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: retry is over\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
name|tiIORequest
operator|=
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|IOType
operator|.
name|TargetIO
operator|.
name|tiIORequest
expr_stmt|;
name|tiIORequest
operator|.
name|tdData
operator|=
name|agNULL
expr_stmt|;
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|)
expr_stmt|;
comment|/* clean up resources */
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* saData != agNULL */
block|}
comment|/* if (IOFailed == agTRUE) */
block|}
comment|/* not TMrequest */
else|else
comment|/* TMrequest */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: TM request\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: TM initiator tag 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_SUCCESS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: success\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIOSuccess
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORTED
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: ABORTED\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIOFailed
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailAborted
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORT_RESET
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaIOCompleted: ABORT_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiIOFailed
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailAbortReset
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_OVERFLOW
case|:
comment|/* fall through */
endif|#
directive|endif
case|case
name|OSSA_IO_UNDERFLOW
case|:
comment|/* fall through */
case|case
name|OSSA_IO_FAILED
case|:
comment|/* fall through */
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_NOT_VALID
case|:
comment|/* fall through */
endif|#
directive|endif
case|case
name|OSSA_IO_NO_DEVICE
case|:
comment|/* fall through */
comment|//case OSSA_IO_NO_SUPPORT: /* fall through */       /*added to compile tgt_drv (TP)*/
case|case
name|OSSA_IO_LINK_FAILURE
case|:
comment|/* fall through */
case|case
name|OSSA_IO_PROG_ERROR
case|:
comment|/* fall through */
case|case
name|OSSA_IO_DS_NON_OPERATIONAL
case|:
comment|/* fall through */
case|case
name|OSSA_IO_DS_IN_RECOVERY
case|:
comment|/* fall through */
case|case
name|OSSA_IO_TM_TAG_NOT_FOUND
case|:
comment|/* fall through */
case|case
name|OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE
case|:
comment|/* fall through */
default|default:
name|status
operator|=
name|tiIOFailed
expr_stmt|;
name|statusDetail
operator|=
name|tiDetailOtherError
expr_stmt|;
name|IOFailed
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
comment|/* switch */
comment|/* for not found IO, we don't call OS */
if|if
condition|(
name|ttdsaXchg
operator|->
name|io_found
operator|==
name|agTRUE
condition|)
block|{
name|ostiTargetTmCompleted
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|tiIORequest
argument_list|,
name|status
argument_list|,
name|statusDetail
argument_list|)
expr_stmt|;
block|}
comment|/* clean up resources */
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
comment|/* TM Request */
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ttdsaTMProcess
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|Target
init|=
operator|(
name|ttdsaTgt_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|ttdsaTgt
decl_stmt|;
name|agsaSSPScsiTaskMgntReq_t
modifier|*
name|agTMIU
decl_stmt|;
name|bit8
name|TMFun
decl_stmt|;
name|bit32
name|tiTMFun
decl_stmt|;
name|tiIORequest_t
modifier|*
name|reftiIORequest
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|IOList
decl_stmt|;
name|bit32
name|IOFound
init|=
name|agFALSE
decl_stmt|;
name|ttdsaXchg_t
modifier|*
name|tmp_ttdsaXchg
init|=
name|agNULL
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|(
name|agsaRoot_t
operator|*
operator|)
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIOAbortRequest
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: start\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|isTMRequest
operator|=
name|agTRUE
expr_stmt|;
name|agTMIU
operator|=
operator|(
name|agsaSSPScsiTaskMgntReq_t
operator|*
operator|)
operator|&
operator|(
name|ttdsaXchg
operator|->
name|agTMIU
operator|)
expr_stmt|;
name|TMFun
operator|=
name|agTMIU
operator|->
name|taskMgntFunction
expr_stmt|;
switch|switch
condition|(
name|TMFun
condition|)
block|{
case|case
name|AGSA_ABORT_TASK
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: ABORT_TASK\n"
operator|)
argument_list|)
expr_stmt|;
name|tiTMFun
operator|=
name|AG_ABORT_TASK
expr_stmt|;
break|break;
case|case
name|AGSA_ABORT_TASK_SET
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: ABORT_TASK_SET\n"
operator|)
argument_list|)
expr_stmt|;
name|tiTMFun
operator|=
name|AG_ABORT_TASK_SET
expr_stmt|;
break|break;
case|case
name|AGSA_CLEAR_TASK_SET
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: CLEAR_TASK_SET\n"
operator|)
argument_list|)
expr_stmt|;
name|tiTMFun
operator|=
name|AG_CLEAR_TASK_SET
expr_stmt|;
break|break;
case|case
name|AGSA_LOGICAL_UNIT_RESET
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: LOGICAL_UNIT_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|tiTMFun
operator|=
name|AG_LOGICAL_UNIT_RESET
expr_stmt|;
break|break;
case|case
name|AGSA_CLEAR_ACA
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: CLEAR_ACA\n"
operator|)
argument_list|)
expr_stmt|;
name|tiTMFun
operator|=
name|AG_CLEAR_ACA
expr_stmt|;
break|break;
case|case
name|AGSA_QUERY_TASK
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: QUERY_TASK\n"
operator|)
argument_list|)
expr_stmt|;
name|tiTMFun
operator|=
name|AG_QUERY_TASK
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: RESERVED TM 0x%x %d\n"
operator|,
name|TMFun
operator|,
name|TMFun
operator|)
argument_list|)
expr_stmt|;
name|tiTMFun
operator|=
literal|0xff
expr_stmt|;
comment|/* unknown task management request */
break|break;
block|}
comment|/*      * Give the OS Specific module to apply it's Task management policy.      */
comment|/*      osGLOBAL void ostiTaskManagement (                         tiRoot_t          *tiRoot,                         bit32             task,                         bit8              *scsiLun,                         tiIORequest_t     *refTiIORequest,                         tiIORequest_t     *tiTMRequest,                         tiDeviceHandle_t  *tiDeviceHandle);      */
if|if
condition|(
name|TMFun
operator|==
name|AGSA_ABORT_TASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: if abort task; to be tested \n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       needs to find a reftIIORequest and set it          */
name|IOList
operator|=
name|Target
operator|->
name|ttdsaXchgData
operator|.
name|xchgBusyList
operator|.
name|flink
expr_stmt|;
name|IOFound
operator|=
name|agFALSE
expr_stmt|;
comment|/* search through the current IOList */
while|while
condition|(
name|IOList
operator|!=
operator|&
name|Target
operator|->
name|ttdsaXchgData
operator|.
name|xchgBusyList
condition|)
block|{
name|tmp_ttdsaXchg
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|ttdsaXchg_t
argument_list|,
name|XchgLinks
argument_list|,
name|IOList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp_ttdsaXchg
operator|->
name|tag
operator|==
name|agTMIU
operator|->
name|tagOfTaskToBeManaged
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: tag 0x%x\n"
operator|,
name|tmp_ttdsaXchg
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|IOFound
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|IOList
operator|=
name|IOList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* while */
if|if
condition|(
name|IOFound
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: found \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* call saSSPAbort() */
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: loc 1\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* abort taskmanagement itself */
name|agIOAbortRequest
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
operator|&
operator|(
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
operator|)
expr_stmt|;
comment|/* IO to be aborted */
name|agIORequest
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
operator|&
operator|(
name|tmp_ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
operator|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tmp_ttdsaXchg
operator|->
name|DeviceData
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|agIORequest
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: agIORequest is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: agIORequest is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIORequest
operator|->
name|sdkData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: agIORequest->saData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: agIORequest->saData is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RPM_SOC
name|saSSPAbort
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|)
expr_stmt|;
else|#
directive|else
name|saSSPAbort
argument_list|(
name|agRoot
argument_list|,
name|agIOAbortRequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
literal|0
argument_list|,
name|agIORequest
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
block|}
comment|/* FOUND */
else|else
block|{
name|ttdsaXchg
operator|->
name|io_found
operator|=
name|agFALSE
expr_stmt|;
name|tiTGTSendTmResp
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|tiIORequest
argument_list|,
name|tiError
comment|/* this is FUNCTION_FAILED */
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: ABORT_TASK not found\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* ABORT_TASK */
comment|/*     reftiIORequest: referred IO request.     If found, not null. But not used in ramdisk      */
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaTMProcess: calling ostiTaskManagement\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiTaskManagement
argument_list|(
name|tiRoot
argument_list|,
name|tiTMFun
argument_list|,
name|ttdsaXchg
operator|->
name|agTMIU
operator|.
name|lun
argument_list|,
name|reftiIORequest
argument_list|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|tiIORequest
argument_list|,
operator|&
name|ttdsaXchg
operator|->
name|DeviceData
operator|->
name|tiDeviceHandle
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *  *  tiTGTIOAbort  *  *  Purpose: This function is called to abort an IO previously reported  *           to oslayer through ostiProcessRequest() function.  *  *  Parameters:  *   tiRoot:         Pointer to driver Instance.  *   tiIORequest:    Pointer to the I/O request context for this I/O.  *                   This context was initially passed to the OS Specific  *                   Module in ostiProcessScsiReq().  *  Return:  *   tiSuccess:      Abort request was successfully initiated  *   tiBusy:         No resources available, try again later  *   tiError:        Other errors that prevent the abort request from being  *                   started  *  Note:  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiTGTIOAbort
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|taskTag
parameter_list|)
block|{
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
decl_stmt|;
name|ttdsaXchg_t
modifier|*
name|ttdsaIOAbortXchg
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|(
name|agsaRoot_t
operator|*
operator|)
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIOAbortRequest
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|=
operator|(
name|ttdsaXchg_t
operator|*
operator|)
name|taskTag
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|ttdsaXchg
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbort: IOError 1 \n"
operator|)
argument_list|)
expr_stmt|;
comment|/*          * this exchange has already been freed.          * No need to free it          */
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
name|taskTag
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailAborted
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
operator|.
name|sdkData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbort: IOError 2 \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* We have not issued this IO to the salayer.          * Abort it right here.          */
if|if
condition|(
name|TD_XCHG_GET_STATE
argument_list|(
name|ttdsaXchg
argument_list|)
operator|==
name|TD_XCHG_STATE_INACTIVE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbort: wrong DEQUEUE_THIS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbort: IOError 3\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
name|taskTag
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailAborted
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbort: IOError 4\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchgFreeStruct
argument_list|(
name|ttdsaXchg
operator|->
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbort: IOError 5\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* to be tested */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbort: aborting; to be tested \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* abort io request itself */
name|ttdsaIOAbortXchg
operator|=
name|ttdsaXchgGetStruct
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttdsaIOAbortXchg
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbort: no free xchg structures\n"
operator|)
argument_list|)
expr_stmt|;
comment|//      ttdsaDumpallXchg(tiRoot);
return|return
name|tiError
return|;
block|}
name|ttdsaIOAbortXchg
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|ttdsaIOAbortXchg
operator|->
name|tiRoot
operator|=
name|tiRoot
expr_stmt|;
name|agIOAbortRequest
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
operator|)
expr_stmt|;
comment|/* remember IO to be aborted */
name|ttdsaIOAbortXchg
operator|->
name|tiIOToBeAbortedRequest
operator|=
name|taskTag
expr_stmt|;
name|ttdsaIOAbortXchg
operator|->
name|XchgToBeAborted
operator|=
name|ttdsaXchg
expr_stmt|;
comment|//    ttdsaIOAbortXchg->FrameType = SAS_TM;
comment|/* io is being aborted */
name|ttdsaXchg
operator|->
name|oslayerAborting
operator|=
name|agTRUE
expr_stmt|;
name|agIORequest
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
operator|&
operator|(
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|agIORequest
operator|)
expr_stmt|;
name|oneDeviceData
operator|=
name|ttdsaXchg
operator|->
name|DeviceData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbort: oneDeviceData is null; wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|ttdsaIOAbortXchg
operator|->
name|DeviceData
operator|=
name|oneDeviceData
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|RPM_SOC
name|saSSPAbort
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|)
expr_stmt|;
else|#
directive|else
name|saSSPAbort
argument_list|(
name|agRoot
argument_list|,
name|agIOAbortRequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
literal|0
argument_list|,
name|agIORequest
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tiTGTIOAbortAll
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiTGTIOAbortAll: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbortAll: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* for hotplug */
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|registered
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbortAll: NO Device did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbortAll: device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbortAll: device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
if|if
condition|(
name|agRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTIOAbortAll: agRoot is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* this is processed in ossaSSPAbortCB, ossaSATAAbortCB, ossaSMPAbortCB */
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agTRUE
expr_stmt|;
name|status
operator|=
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *  *  tiTGTSendTmResp  *  *  Purpose: This function is called to abort an IO previously reported  *           to oslayer through ostiProcessRequest() function.  *  *  Parameters:  *   tiRoot:         Pointer to driver Instance.  *   tiIORequest:    Pointer to the I/O request context for this I/O.  *                   This context was initially passed to the OS Specific  *                   Module in ostiProcessScsiReq().  *  Return:  *   tiSuccess:      Abort request was successfully initiated  *   tiBusy:         No resources available, try again later  *   tiError:        Other errors that prevent the abort request from being  *                   started  *  Note:  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiTGTSendTmResp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiTMRequest
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
decl_stmt|;
name|sas_resp_t
modifier|*
name|SASResp
decl_stmt|;
name|bit32
name|tdStatus
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: start 1\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|=
operator|(
name|ttdsaXchg_t
operator|*
operator|)
name|tiTMRequest
operator|->
name|tdData
expr_stmt|;
comment|/* set the response and send it */
comment|/* response status is 0 */
comment|/* status is TM status */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: start 2\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|=
operator|(
name|sas_resp_t
operator|*
operator|)
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: start 3\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttdsaXchg
operator|->
name|FrameType
operator|==
name|SAS_TM
condition|)
block|{
name|SASResp
operator|->
name|agResp
operator|.
name|status
operator|=
literal|0
expr_stmt|;
name|SASResp
operator|->
name|agResp
operator|.
name|dataPres
operator|=
name|RESPONSE_DATA
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|SASResp
operator|->
name|agResp
operator|.
name|responsedataLen
argument_list|,
literal|0
argument_list|,
name|RESPONSE_DATA_LEN
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|SASResp
operator|->
name|agResp
operator|.
name|senseDataLen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|tiSuccess
case|:
name|TI_DBG2
argument_list|(
operator|(
literal|"tiTGTSendTmResp: tiSuccess\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_SUCCEEDED
expr_stmt|;
break|break;
case|case
name|tiError
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: tiError\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_FAILED
expr_stmt|;
break|break;
case|case
name|tiBusy
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: tibusy\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_FAILED
expr_stmt|;
break|break;
case|case
name|tiIONoDevice
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: tiionodevicee\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_FAILED
expr_stmt|;
break|break;
case|case
name|tiMemoryTooLarge
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: timemorytoolarge\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_FAILED
expr_stmt|;
break|break;
case|case
name|tiMemoryNotAvail
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: timemorynotavail\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_FAILED
expr_stmt|;
break|break;
case|case
name|tiInvalidHandle
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: tiinvalidhandle\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_FAILED
expr_stmt|;
break|break;
case|case
name|tiNotSupported
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: tiNotsupported\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_NOT_SUPPORTED
expr_stmt|;
break|break;
case|case
name|tiReject
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: tireject\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_FAILED
expr_stmt|;
break|break;
case|case
name|tiIncorrectLun
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: tiincorrectlun\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_INCORRECT_LOGICAL_UNIT_NUMBER
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: default\n"
operator|)
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_FAILED
expr_stmt|;
break|break;
block|}
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|+
name|RESPONSE_DATA_LEN
expr_stmt|;
name|ttdsaXchg
operator|->
name|statusSent
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: not TM frame\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|tdStatus
operator|=
name|ttdsaSendResp
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: send success\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
elseif|else
if|if
condition|(
name|tdStatus
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: sending not successful\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: send busy\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiBusy
return|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
name|tiTGTSetResp
argument_list|(
name|tiRoot
argument_list|,
name|tiTMRequest
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REMOVED
if|if
condition|(
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: respsonse is set \n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: resp.length 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|responseSent
operator|=
name|agTRUE
expr_stmt|;
name|ttdsaSendResp
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no respsonse is set, direct call */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSendTmResp: direct call\n"
operator|)
argument_list|)
expr_stmt|;
name|tiTGTSetResp
argument_list|(
name|tiRoot
argument_list|,
name|tiTMRequest
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|->
name|responseSent
operator|=
name|agTRUE
expr_stmt|;
name|ttdsaSendResp
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
define|#
directive|define
name|TASK_MANAGEMENT_FUNCTION_COMPLETE
value|0x0
define|#
directive|define
name|INVALID_FRAME
value|0x2
define|#
directive|define
name|TASK_MANAGEMENT_FUNCTION_NOT_SUPPORTED
value|0x4
define|#
directive|define
name|TASK_MANAGEMENT_FUNCTION_FAILED
value|0x5
define|#
directive|define
name|TASK_MANAGEMENT_FUNCTION_SUCCEEDED
value|0x8
define|#
directive|define
name|INVALID_LOGICAL_UNIT_NUMBER
value|0x9
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*****************************************************************************  *  *  tiTGTSenseBufferGet  *  *  Purpose: This function is called to get the address of sense buffer from  *           the target specific Transport Dependent Layer.  *  *  Parameters:  *     tiRoot:        Pointer to driver/port instance.  *     tiIORequest:   I/O request context.  *     length:        Lenght in bytes of the sense buffer.  *  *  Return:  none  *  *  Note:  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
modifier|*
name|tiTGTSenseBufferGet
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|bit32
name|length
parameter_list|)
block|{
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
decl_stmt|;
name|ttdsaXchg
operator|=
operator|(
name|ttdsaXchg_t
operator|*
operator|)
name|tiIORequest
operator|->
name|tdData
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSenseBufferGet: start\n"
operator|)
argument_list|)
expr_stmt|;
name|OS_ASSERT
argument_list|(
operator|(
name|length
operator|<=
literal|64
operator|)
argument_list|,
literal|"length too big in tiTGTSenseBufferGet"
argument_list|)
expr_stmt|;
return|return
operator|&
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
index|[
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
index|]
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *  *  tiTGTSetResp  *  *  Purpose: This function is called when the target OS Specific Module is ready  *           to send a response with the next tiTGTIOStart()  *           function call. This function allows the TD Layer to setup its  *           portion of the status and mark it to be sent on the next  *           tiTGTIOStart() function call.  *  *  Parameters:  *   tiRoot:         Pointer to driver Instance.  *   tiIORequest:    Pointer to the I/O request context for this I/O.  *                   This context was initially passed to the OS Specific Module  *                   in ostiProcessScsiReq().  *   dataSentLength: How much data sent or received for this Request.  *   ScsiStatus:     Status for this SCSI command.  *   senseLength:    Length of sense data if any.  *  *  Return: none  *  *  Note:  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tiTGTSetResp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|bit32
name|dataSentLength
parameter_list|,
name|bit8
name|ScsiStatus
parameter_list|,
name|bit32
name|senseLength
parameter_list|)
block|{
comment|/* no call to saSSPStart() in this function */
comment|/*     response is normally for task management     sense is for command with error     need to know this is for TM or cmd      */
comment|/*   tiTGTSetResp(rdRoot->pTiRoot,                rdIORequest->tiIORequest,                dataSentLength,                ScsiStatus,                senseLength);         */
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|agsaSSPTargetResponse_t
modifier|*
name|agSSPTargetResp
decl_stmt|;
endif|#
directive|endif
name|sas_resp_t
modifier|*
name|SASResp
decl_stmt|;
name|bit32
name|TotalRespLen
init|=
literal|0
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: datelen %d senselen %d\n"
operator|,
name|dataSentLength
operator|,
name|senseLength
operator|)
argument_list|)
expr_stmt|;
name|ttdsaXchg
operator|=
operator|(
name|ttdsaXchg_t
operator|*
operator|)
name|tiIORequest
operator|->
name|tdData
expr_stmt|;
name|SASResp
operator|=
operator|(
name|sas_resp_t
operator|*
operator|)
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
expr_stmt|;
name|SASResp
operator|->
name|agResp
operator|.
name|status
operator|=
name|ScsiStatus
expr_stmt|;
if|if
condition|(
name|ttdsaXchg
operator|->
name|FrameType
operator|==
name|SAS_TM
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSetResp: TM\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|senseLength
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSetResp: non-zero sensedatalen for TM\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|SASResp
operator|->
name|agResp
operator|.
name|dataPres
operator|=
name|RESPONSE_DATA
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|SASResp
operator|->
name|agResp
operator|.
name|responsedataLen
argument_list|,
literal|0
argument_list|,
name|RESPONSE_DATA_LEN
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|SASResp
operator|->
name|agResp
operator|.
name|senseDataLen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SASResp
operator|->
name|RespData
index|[
literal|3
index|]
operator|=
name|AGSA_TASK_MANAGEMENT_FUNCTION_NOT_SUPPORTED
expr_stmt|;
name|TotalRespLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|+
name|RESPONSE_DATA_LEN
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|senseLength
operator|==
literal|0
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: CMND, no data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* good and no data present */
name|SASResp
operator|->
name|agResp
operator|.
name|dataPres
operator|=
name|NO_DATA
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|SASResp
operator|->
name|agResp
operator|.
name|responsedataLen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|SASResp
operator|->
name|agResp
operator|.
name|senseDataLen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TotalRespLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
expr_stmt|;
comment|/* collapse good response with READ */
if|if
condition|(
name|ttdsaXchg
operator|->
name|XchType
operator|==
name|AGSA_SSP_TGT_READ_DATA
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: read rsp collapse\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|->
name|autoGoodRSP
operator|&
name|READ_GOOD_RESPONSE
condition|)
name|ttdsaXchg
operator|->
name|readRspCollapsed
operator|=
name|agTRUE
expr_stmt|;
block|}
comment|/* collapse good response with WRITE */
if|if
condition|(
name|ttdsaXchg
operator|->
name|XchType
operator|==
name|AGSA_SSP_TGT_WRITE_DATA
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: write rsp collapse\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaRoot
operator|->
name|autoGoodRSP
operator|&
name|WRITE_GOOD_RESPONSE
condition|)
block|{
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|TI_TIROOT_TO_AGROOT
argument_list|(
name|tiRoot
argument_list|)
argument_list|)
condition|)
block|{
name|ttdsaXchg
operator|->
name|wrtRspCollapsed
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
name|ttdsaXchg
operator|->
name|wrtRspCollapsed
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: CMND, sense data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* bad and sense data */
name|SASResp
operator|->
name|agResp
operator|.
name|dataPres
operator|=
name|SENSE_DATA
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|SASResp
operator|->
name|agResp
operator|.
name|responsedataLen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|SASResp
operator|->
name|agResp
operator|.
name|senseDataLen
argument_list|,
literal|0
argument_list|,
name|senseLength
argument_list|)
expr_stmt|;
name|TotalRespLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|+
name|senseLength
expr_stmt|;
block|}
block|}
name|ttdsaXchg
operator|->
name|statusSent
operator|=
name|agTRUE
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: ttdsaXchg %p\n"
operator|,
name|ttdsaXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: TotalRespLen 0x%x \n"
operator|,
name|TotalRespLen
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: upper 0x%x \n"
operator|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrUpper
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: lower 0x%x \n"
operator|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|phyAddrLower
operator|)
argument_list|)
expr_stmt|;
comment|/* set the correct response length */
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|=
name|TotalRespLen
expr_stmt|;
name|dumpresp
argument_list|(
operator|(
name|bit8
operator|*
operator|)
name|ttdsaXchg
operator|->
name|resp
operator|.
name|virtAddr
argument_list|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
comment|/*     send TM reponse (which has only  response data not sense data here     since ramdisk does not call IOstart for this      */
if|if
condition|(
name|ttdsaXchg
operator|->
name|FrameType
operator|==
name|SAS_TM
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSetResp: respsonse is set \n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiTGTSetResp: resp.length 0x%x\n"
operator|,
name|ttdsaXchg
operator|->
name|resp
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
name|ttdsaSendResp
argument_list|(
name|ttdsaXchg
operator|->
name|agRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REMOVED
comment|/* sas response */
name|agSSPTargetResp
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetResponse
operator|)
expr_stmt|;
name|agSSPTargetResp
operator|->
name|agTag
operator|=
name|ttdsaXchg
operator|->
name|tag
expr_stmt|;
name|agSSPTargetResp
operator|->
name|respBufLength
operator|=
name|TotalRespLen
expr_stmt|;
name|agSSPTargetResp
operator|->
name|respBufUpper
operator|=
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetResponse
operator|.
name|respBufUpper
expr_stmt|;
name|agSSPTargetResp
operator|->
name|respBufLower
operator|=
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetResponse
operator|.
name|respBufLower
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: len 0x%x \n"
operator|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetResponse
operator|.
name|respBufLength
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: upper 0x%x \n"
operator|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetResponse
operator|.
name|respBufUpper
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTSetResp: lower 0x%x \n"
operator|,
name|ttdsaXchg
operator|->
name|IORequestBody
operator|.
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspTargetResponse
operator|.
name|respBufLower
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  *  tiTGTGetDeviceHandles  *  *  Purpose: This routine is called to to return the device handles for each  *           device currently available.  *  *  Parameters:  *     tiRoot:   Pointer to driver Instance.  *     agDev[]:  Array to receive pointers to the device handles.  *     maxDevs:  Number of device handles which will fit in array pointed  *               by agDev.  *  Return:  *    Number of device handle slots present (however, only maxDevs  *    are copied into tiDev[]) which may be greater than the number of  *    handles actually present.  *  *  Note:  *  ******************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiTGTGetDeviceHandles
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPortalContext_t
modifier|*
name|tiPortalContext
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDev
index|[]
parameter_list|,
name|bit32
name|maxDevs
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|ttdsaTgt_t
modifier|*
name|Target
init|=
operator|(
name|ttdsaTgt_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|ttdsaTgt
decl_stmt|;
name|bit32
name|deviceToReturn
decl_stmt|;
name|bit32
name|devicePresent
init|=
literal|0
decl_stmt|;
name|bit32
name|deviceIndex
init|=
literal|0
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceHandles: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Check boundary condition */
if|if
condition|(
name|maxDevs
operator|>
name|Target
operator|->
name|OperatingOption
operator|.
name|MaxTargets
condition|)
block|{
name|deviceToReturn
operator|=
name|Target
operator|->
name|OperatingOption
operator|.
name|MaxTargets
expr_stmt|;
block|}
else|else
block|{
name|deviceToReturn
operator|=
name|maxDevs
expr_stmt|;
block|}
comment|/* make sure tiPortalContext is valid */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|tiPortalContext
operator|==
name|tiPortalContext
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceHandles: found; oneportContext ID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceHandles: No corressponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* go through device list and returns them */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceHandles: pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceHandles: device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceHandles: device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceHandles: handle %p\n"
operator|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceHandles: valid deviceindex %d devicePresent %d\n"
operator|,
name|deviceIndex
operator|,
name|devicePresent
operator|)
argument_list|)
expr_stmt|;
name|tiDev
index|[
name|deviceIndex
index|]
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|devicePresent
operator|++
expr_stmt|;
block|}
else|else
block|{
name|tiDev
index|[
name|deviceIndex
index|]
operator|=
name|agNULL
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceHandles: not valid deviceindex %d devicePresent %d\n"
operator|,
name|deviceIndex
operator|,
name|devicePresent
operator|)
argument_list|)
expr_stmt|;
block|}
name|deviceIndex
operator|++
expr_stmt|;
if|if
condition|(
name|devicePresent
operator|>=
name|deviceToReturn
condition|)
block|{
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
return|return
name|devicePresent
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************  *  *  tiTGTGetDeviceInfo  *  *  Purpose: This routine is called to to return the device information for  *           specified device handle.  *  *  Parameters:  *     tiRoot:   Pointer to driver Instance.  *     tiDeviceHandle:  device handle associated with the device for which  *                      information is queried  *     tiDeviceInfo:    device information structure containing address and name.  *  *  Return:  *     tiSuccess: if the device handle is valid.  *     tiError  : if the device handle is not valid.  *  *  Note:  *  ******************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiTGTGetDeviceInfo
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiDeviceInfo_t
modifier|*
name|tiDeviceInfo
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceInfo: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceInfo: tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiTGTGetDeviceInfo: oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* filling in the link rate */
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
name|tiDeviceInfo
operator|->
name|info
operator|.
name|devType_S_Rate
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
expr_stmt|;
block|}
else|else
block|{
name|tiDeviceInfo
operator|->
name|info
operator|.
name|devType_S_Rate
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
operator|&
literal|0x0f
expr_stmt|;
block|}
comment|/* temp just returning local and remote SAS address; doesn't have a name */
name|tiDeviceInfo
operator|->
name|remoteName
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|sasRemoteAddressHi
operator|)
expr_stmt|;
name|tiDeviceInfo
operator|->
name|remoteAddress
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|sasRemoteAddressLo
operator|)
expr_stmt|;
name|tiDeviceInfo
operator|->
name|localName
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|sasLocalAddressHi
operator|)
expr_stmt|;
name|tiDeviceInfo
operator|->
name|localAddress
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|sasLocalAddressLo
operator|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief ttdssIOAbortedHandler  *  *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower  *            layer with agIOStatus = OSSA_IO_ABORTED  *  *  \param  agRoot:            pointer to port instance  *  \param  agIORequest:       pointer to I/O request  *  \param  agIOStatus:        I/O status given by LL layer  *  \param  agIOInfoLen:       lenth of complete SAS RESP frame  *  \param  agParam            A Handle used to refer to the response frame or handle  *                             of abort request  *  \param  agOtherInfo        Residual count  *  \return: None  *  *  *****************************************************************************/
end_comment

begin_comment
comment|/* see itdosIOCompleted() and itdinit.c and  itdIoAbortedHandler in itdio.c*/
end_comment

begin_function
name|osGLOBAL
name|void
name|ttdssIOAbortedHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOAbortedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_ABORTED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOAbortedHandler: incorrect agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiTargetIOError
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailAborted
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  * $RCSfile: ttdsmp.c,v $  *  * Copyright 2006 PMC-Sierra, Inc.  *  * $Author: hasungwo $  * $Revision: 112322 $  * $Date: 2012-01-04 19:23:42 -0800 (Wed, 04 Jan 2012) $  *  * This file contains initiator IO related functions in TD layer  *  */
end_comment

begin_include
include|#
directive|include
file|<osenv.h>
end_include

begin_include
include|#
directive|include
file|<ostypes.h>
end_include

begin_include
include|#
directive|include
file|<osdebug.h>
end_include

begin_include
include|#
directive|include
file|<sa.h>
end_include

begin_include
include|#
directive|include
file|<saapi.h>
end_include

begin_include
include|#
directive|include
file|<saosapi.h>
end_include

begin_include
include|#
directive|include
file|<titypes.h>
end_include

begin_include
include|#
directive|include
file|<ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<tiapi.h>
end_include

begin_include
include|#
directive|include
file|<tiglobal.h>
end_include

begin_include
include|#
directive|include
file|<tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<osstring.h>
end_include

begin_include
include|#
directive|include
file|<tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<itddefs.h>
end_include

begin_include
include|#
directive|include
file|<itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|"ttdglobl.h"
end_include

begin_include
include|#
directive|include
file|"ttdtxchg.h"
end_include

begin_include
include|#
directive|include
file|"ttdtypes.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<tdproto.h>
end_include

begin_function
name|osGLOBAL
name|void
name|ttdsaSMPCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
comment|//agsaSMPFrameHeader_t  *agFrameHeader, //(TP)
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
init|=
operator|(
name|ttdsaXchg_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
decl_stmt|;
comment|/* cf) ttdsaIOCompleted */
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSMPCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSMPCompleted: tiRoot is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ttdsaXchg
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSMPCompleted: ttdsaXchg is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ttdsaXchgFreeStruct
argument_list|(
name|tiRoot
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
comment|/* to-do: no callback to OS layer */
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ttdsaNotSupportRespSend
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
parameter_list|,
name|bit8
name|smpfn
parameter_list|)
block|{
name|bit32
name|agRequestType
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|agsaSMPFrame_t
modifier|*
name|agSMPFrame
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|bit8
name|SMPPayload
index|[
name|SMP_DIRECT_PAYLOAD_LIMIT
index|]
decl_stmt|;
comment|/*(TP)*/
name|tdssSMPFrameHeader_t
name|tdSMPFrameHeader
decl_stmt|;
comment|/*(TP)*/
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaNotSupportSend:\n"
operator|)
argument_list|)
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SMP_TGT_RESPONSE
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|agIORequest
operator|)
expr_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSMPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|smpFrame
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*(TP)*/
comment|/* smp header */
comment|/*(TP)*/
name|tdSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_RESPONSE
expr_stmt|;
comment|/* SMP response */
name|tdSMPFrameHeader
operator|.
name|smpFunction
operator|=
name|smpfn
expr_stmt|;
name|tdSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
name|UNKNOWN_SMP_FUNCTION
expr_stmt|;
comment|/* unknown smp */
name|tdSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0
expr_stmt|;
comment|/*old*/
comment|//agSMPFrame->frameHeader.smpFrameType = SMP_RESPONSE; /* SMP response */
comment|//agSMPFrame->frameHeader.smpFunction = smpfn;
comment|//agSMPFrame->frameHeader.smpFunctionResult = UNKNOWN_SMP_FUNCTION; /* unknown smp */
name|osti_memcpy
argument_list|(
name|SMPPayload
argument_list|,
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*TP)*/
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|SMPPayload
expr_stmt|;
comment|/*(TP)*/
name|agSMPFrame
operator|->
name|outFrameAddrUpper32
operator|=
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrUpper
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameAddrLower32
operator|=
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrLower
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
literal|0
expr_stmt|;
comment|/* no smp response payload */
comment|//agSMPFrame->phyId = ttdsaXchg->SMPphyId;
ifdef|#
directive|ifdef
name|RPM_SOC
comment|/* not work yet because of high priority q */
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
else|#
directive|else
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
comment|/* queue number */
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ttdsaDiscoverRespSend
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
parameter_list|)
block|{
name|bit32
name|agRequestType
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|agsaSMPFrame_t
modifier|*
name|agSMPFrame
decl_stmt|;
name|smpRespDiscover_t
modifier|*
name|Resp
decl_stmt|;
name|smp_resp_t
modifier|*
name|SMPResp
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|bit8
name|SMPPayload
index|[
name|SMP_DIRECT_PAYLOAD_LIMIT
index|]
decl_stmt|;
comment|/*(TP)*/
name|tdssSMPFrameHeader_t
name|tdSMPFrameHeader
decl_stmt|;
comment|/*(TP)*/
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaDiscoverRespSend:\n"
operator|)
argument_list|)
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SMP_TGT_RESPONSE
expr_stmt|;
name|SMPResp
operator|=
operator|(
name|smp_resp_t
operator|*
operator|)
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|virtAddr
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|agIORequest
operator|)
expr_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSMPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|smpFrame
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*(TP)*/
comment|/* smp header */
comment|/*(TP)*/
name|tdSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_RESPONSE
expr_stmt|;
comment|/* SMP response */
name|tdSMPFrameHeader
operator|.
name|smpFunction
operator|=
name|SMP_DISCOVER
expr_stmt|;
comment|/* discover */
name|tdSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
name|SMP_FUNCTION_ACCEPTED
expr_stmt|;
name|tdSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0
expr_stmt|;
comment|/*old*/
comment|//agSMPFrame->frameHeader.smpFrameType = SMP_RESPONSE; /* SMP response */
comment|//agSMPFrame->frameHeader.smpFunction = SMP_DISCOVER; /* discover */
comment|//agSMPFrame->frameHeader.smpFunctionResult = SMP_FUNCTION_ACCEPTED;
name|osti_memcpy
argument_list|(
name|SMPPayload
argument_list|,
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*TP)*/
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|SMPPayload
expr_stmt|;
comment|/*(TP)*/
name|agSMPFrame
operator|->
name|outFrameAddrUpper32
operator|=
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrUpper
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameAddrLower32
operator|=
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrLower
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
expr_stmt|;
comment|//agSMPFrame->phyId = ttdsaXchg->SMPphyId;
comment|/* smp response payload */
name|Resp
operator|=
operator|(
name|smpRespDiscover_t
operator|*
operator|)
operator|&
operator|(
name|SMPResp
operator|->
name|RespData
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
name|Resp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* temp, hardcode smp discover response */
comment|/* needs to read contents from ID frame */
comment|/* assumption: for now, attached to edge expander */
name|Resp
operator|->
name|phyIdentifier
operator|=
literal|0
expr_stmt|;
name|Resp
operator|->
name|attachedDeviceType
operator|=
name|SAS_EDGE_EXPANDER_DEVICE
expr_stmt|;
name|Resp
operator|->
name|negotiatedPhyLinkRate
operator|=
literal|0x9
expr_stmt|;
comment|/* enabled, 1.5G */
name|Resp
operator|->
name|attached_Ssp_Stp_Smp_Sata_Initiator
operator|=
literal|0
expr_stmt|;
name|Resp
operator|->
name|attached_SataPS_Ssp_Stp_Smp_Sata_Target
operator|=
literal|0x2
expr_stmt|;
comment|/* SMP target */
name|Resp
operator|->
name|sasAddressHi
index|[
literal|3
index|]
operator|=
literal|0x01
expr_stmt|;
name|Resp
operator|->
name|sasAddressHi
index|[
literal|2
index|]
operator|=
literal|0x02
expr_stmt|;
name|Resp
operator|->
name|sasAddressHi
index|[
literal|1
index|]
operator|=
literal|0x03
expr_stmt|;
name|Resp
operator|->
name|sasAddressHi
index|[
literal|0
index|]
operator|=
literal|0x04
expr_stmt|;
name|Resp
operator|->
name|sasAddressLo
index|[
literal|3
index|]
operator|=
literal|0x05
expr_stmt|;
name|Resp
operator|->
name|sasAddressLo
index|[
literal|2
index|]
operator|=
literal|0x06
expr_stmt|;
name|Resp
operator|->
name|sasAddressLo
index|[
literal|1
index|]
operator|=
literal|0x07
expr_stmt|;
name|Resp
operator|->
name|sasAddressLo
index|[
literal|0
index|]
operator|=
literal|0x08
expr_stmt|;
name|Resp
operator|->
name|attachedSasAddressHi
index|[
literal|3
index|]
operator|=
literal|0x01
expr_stmt|;
name|Resp
operator|->
name|attachedSasAddressHi
index|[
literal|2
index|]
operator|=
literal|0x01
expr_stmt|;
name|Resp
operator|->
name|attachedSasAddressHi
index|[
literal|1
index|]
operator|=
literal|0x01
expr_stmt|;
name|Resp
operator|->
name|attachedSasAddressHi
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
name|Resp
operator|->
name|attachedSasAddressLo
index|[
literal|3
index|]
operator|=
literal|0x02
expr_stmt|;
name|Resp
operator|->
name|attachedSasAddressLo
index|[
literal|2
index|]
operator|=
literal|0x02
expr_stmt|;
name|Resp
operator|->
name|attachedSasAddressLo
index|[
literal|1
index|]
operator|=
literal|0x02
expr_stmt|;
name|Resp
operator|->
name|attachedSasAddressLo
index|[
literal|0
index|]
operator|=
literal|0x02
expr_stmt|;
name|Resp
operator|->
name|attachedPhyIdentifier
operator|=
literal|0
expr_stmt|;
name|Resp
operator|->
name|programmedAndHardware_MinPhyLinkRate
operator|=
literal|0x8
expr_stmt|;
comment|/* not programmable and 1.5 G */
name|Resp
operator|->
name|programmedAndHardware_MaxPhyLinkRate
operator|=
literal|0x8
expr_stmt|;
comment|/* not programmable and 1.5 G */
name|Resp
operator|->
name|phyChangeCount
operator|=
literal|0
expr_stmt|;
comment|/* No broadcast(Change) received */
name|Resp
operator|->
name|virtualPhy_partialPathwayTimeout
operator|=
literal|0x7
expr_stmt|;
comment|/* no virutal phy and see spec 10.4.3.5, p 404 rev 7 */
name|Resp
operator|->
name|routingAttribute
operator|=
literal|0
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|Resp
operator|->
name|reserved13
argument_list|,
literal|0
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|Resp
operator|->
name|vendorSpecific
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RPM_SOC
comment|/* not work yet because of high priority q */
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
else|#
directive|else
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
comment|/* queue number */
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ttdsaReportGeneralRespSend
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
parameter_list|)
block|{
name|bit32
name|agRequestType
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|agsaSMPFrame_t
modifier|*
name|agSMPFrame
decl_stmt|;
name|smpRespReportGeneral_t
modifier|*
name|Resp
decl_stmt|;
name|smp_resp_t
modifier|*
name|SMPResp
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|bit8
name|SMPPayload
index|[
name|SMP_DIRECT_PAYLOAD_LIMIT
index|]
decl_stmt|;
comment|/*(TP)*/
name|tdssSMPFrameHeader_t
name|tdSMPFrameHeader
decl_stmt|;
comment|/*(TP)*/
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaReportGeneralRespSend:\n"
operator|)
argument_list|)
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SMP_TGT_RESPONSE
expr_stmt|;
name|SMPResp
operator|=
operator|(
name|smp_resp_t
operator|*
operator|)
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|virtAddr
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|agIORequest
operator|)
expr_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSMPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|smpFrame
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*(TP)*/
name|tdSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_RESPONSE
expr_stmt|;
comment|/* SMP response */
name|tdSMPFrameHeader
operator|.
name|smpFunction
operator|=
name|SMP_REPORT_GENERAL
expr_stmt|;
comment|/* report general */
name|tdSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
name|SMP_FUNCTION_ACCEPTED
expr_stmt|;
name|tdSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0
expr_stmt|;
comment|/*old*/
comment|//agSMPFrame->frameHeader.smpFrameType = SMP_RESPONSE; /* SMP response */
comment|//agSMPFrame->frameHeader.smpFunction = SMP_REPORT_GENERAL; /* report general */
comment|//agSMPFrame->frameHeader.smpFunctionResult = SMP_FUNCTION_ACCEPTED;
name|osti_memcpy
argument_list|(
name|SMPPayload
argument_list|,
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*(TP)*/
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|SMPPayload
expr_stmt|;
comment|/*(TP)*/
name|agSMPFrame
operator|->
name|outFrameAddrUpper32
operator|=
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrUpper
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameAddrLower32
operator|=
name|ttdsaXchg
operator|->
name|smpresp
operator|.
name|phyAddrLower
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
expr_stmt|;
comment|//agSMPFrame->phyId = ttdsaXchg->SMPphyId;
comment|/* smp response payload */
name|Resp
operator|=
operator|(
name|smpRespReportGeneral_t
operator|*
operator|)
operator|&
operator|(
name|SMPResp
operator|->
name|RespData
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
name|Resp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* temp, hardcode smp general response */
name|Resp
operator|->
name|expanderChangeCount16
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|Resp
operator|->
name|expanderRouteIndexes16
index|[
literal|0
index|]
operator|=
literal|2
expr_stmt|;
name|Resp
operator|->
name|numOfPhys
operator|=
literal|0x5
expr_stmt|;
comment|/* 0x1; */
name|Resp
operator|->
name|configuring_configurable
operator|=
literal|0
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"smp general response"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|Resp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RPM_SOC
comment|/* not work yet because of high priority q */
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
else|#
directive|else
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
comment|/* queue number */
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ttdsaSMPReqReceived
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|agsaSMPFrameHeader_t
modifier|*
name|agFrameHeader
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|bit32
name|agFrameLength
parameter_list|,
name|bit32
name|phyId
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|ttdsaXchg_t
modifier|*
name|ttdsaXchg
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSMPReqReceived: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSMPReqReceived: no device data\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ttdsaXchg
operator|=
name|ttdsaXchgGetStruct
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttdsaXchg
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSMPReqReceived: no free xchg structures\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
comment|/* saving the device */
name|ttdsaXchg
operator|->
name|DeviceData
operator|=
name|oneDeviceData
expr_stmt|;
name|ttdsaXchg
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|ttdsaXchg
operator|->
name|tiRoot
operator|=
name|tiRoot
expr_stmt|;
name|ttdsaXchg
operator|->
name|SMPRequestBody
operator|.
name|agIORequest
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|ttdsaXchg
operator|->
name|SMPphyId
operator|=
name|phyId
expr_stmt|;
switch|switch
condition|(
name|agFrameHeader
operator|->
name|smpFunction
condition|)
block|{
case|case
name|SMP_REPORT_GENERAL
case|:
block|{
comment|/* must spec p392, rev7*/
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSMPReqReceived: REPORT_GENERAL\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaReportGeneralRespSend
argument_list|(
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SMP_REPORT_MANUFACTURE_INFORMATION
case|:
block|{
comment|/* optional, spec p394, rev7*/
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSMPReqReceived: REPORT_MANUFACTURE_INFORMATION\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaNotSupportRespSend
argument_list|(
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
name|ttdsaXchg
argument_list|,
name|SMP_REPORT_MANUFACTURE_INFORMATION
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SMP_DISCOVER
case|:
block|{
comment|/* must, spec p398, rev7*/
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSMPReqReceived: DISCOVER\n"
operator|)
argument_list|)
expr_stmt|;
name|ttdsaDiscoverRespSend
argument_list|(
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
name|ttdsaXchg
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ttdsaSMPReqReceived: UKNOWN or not yet supported 0x%x\n"
operator|,
name|agFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
name|ttdsaNotSupportRespSend
argument_list|(
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
name|ttdsaXchg
argument_list|,
operator|(
name|bit8
operator|)
name|agFrameHeader
operator|->
name|smpFunction
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return;
block|}
end_function

end_unit


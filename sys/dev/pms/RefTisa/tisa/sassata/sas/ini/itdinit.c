begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  *  * This file contains initiator initialization functions  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_comment
comment|/***************************************************************************** *! \brief itdssGetResource * *  Purpose:  This function is called to determine the Transport  *            Dependent Layer internal resource requirement for the initiator *            side. * *  /param   tiRoot:            Pointer to driver/port instance. *  /param   initiatorResource: Pointer to initiator functionality memory and  *                              option requirement. * *  /return: None * *  /note - This function only return the memory requirement in the tiMem_t  *          structure in initiatorResource. It does not allocated memory, so the *          address fields in tiMem_t are not used. * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssGetResource
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiInitiatorResource_t
modifier|*
name|initiatorResource
parameter_list|)
block|{
name|itdssOperatingOption_t
name|OperatingOption
decl_stmt|;
name|tiInitiatorMem_t
modifier|*
name|iniMem
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|iniMem
operator|=
operator|&
name|initiatorResource
operator|->
name|initiatorMem
expr_stmt|;
name|iniMem
operator|->
name|count
operator|=
literal|1
expr_stmt|;
comment|/* Only 1 memory descriptors are used */
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssGetResource: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*  other than [0], nothing is used     *  tdCachedMem[0]: cached mem for initiator TD Layer main functionality :    *                  itdssIni_t    *  tdCachedMem[1-5]: is availalbe    */
comment|/*     * Get default parameters from the OS Specific area    * and reads parameters from the configuration file    */
name|itdssGetOperatingOptionParams
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|OperatingOption
argument_list|)
expr_stmt|;
comment|/*     * Cached mem for initiator Transport Dependent Layer main functionality     */
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|singleElementLength
operator|=
sizeof|sizeof
argument_list|(
name|itdsaIni_t
argument_list|)
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|numElements
operator|=
literal|1
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|totalLength
operator|=
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|singleElementLength
operator|*
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|numElements
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
comment|/* 4 bytes */
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|TI_CACHED_MEM
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|virtPtr
operator|=
name|agNULL
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|osHandle
operator|=
name|agNULL
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|physAddrUpper
operator|=
literal|0
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|physAddrLower
operator|=
literal|0
expr_stmt|;
comment|/*    * Not used mem structure. Initialize them.    */
for|for
control|(
name|i
operator|=
name|iniMem
operator|->
name|count
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
name|iniMem
operator|->
name|tdCachedMem
index|[
name|i
index|]
operator|.
name|singleElementLength
operator|=
literal|0
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
name|i
index|]
operator|.
name|numElements
operator|=
literal|0
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
name|i
index|]
operator|.
name|totalLength
operator|=
literal|0
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
name|i
index|]
operator|.
name|alignment
operator|=
literal|0
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
name|i
index|]
operator|.
name|type
operator|=
name|TI_CACHED_MEM
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
name|i
index|]
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
name|i
index|]
operator|.
name|virtPtr
operator|=
name|agNULL
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
name|i
index|]
operator|.
name|osHandle
operator|=
name|agNULL
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
name|i
index|]
operator|.
name|physAddrUpper
operator|=
literal|0
expr_stmt|;
name|iniMem
operator|->
name|tdCachedMem
index|[
name|i
index|]
operator|.
name|physAddrLower
operator|=
literal|0
expr_stmt|;
block|}
comment|/*     * Operating option of TISA    * fills in tiInitiatorOption     */
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|usecsPerTick
operator|=
name|OperatingOption
operator|.
name|UsecsPerTick
expr_stmt|;
comment|/* default value 1 sec*/
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|pageSize
operator|=
literal|0
expr_stmt|;
comment|/* initialization */
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|numElements
operator|=
literal|0
expr_stmt|;
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|singleElementLength
operator|=
literal|0
expr_stmt|;
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|totalLength
operator|=
literal|0
expr_stmt|;
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|alignment
operator|=
literal|0
expr_stmt|;
comment|/* initialization */
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicCachedMem
operator|.
name|numElements
operator|=
literal|0
expr_stmt|;
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicCachedMem
operator|.
name|singleElementLength
operator|=
literal|0
expr_stmt|;
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicCachedMem
operator|.
name|totalLength
operator|=
literal|0
expr_stmt|;
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicCachedMem
operator|.
name|alignment
operator|=
literal|0
expr_stmt|;
comment|/* This is not used in OS like Linux which supports dynamic memeory allocation      In short, this is for Windows, which does not support dynamic memory allocation */
comment|/* ostiallocmemory(..... ,agFALSE) is supported by the following code eg) sat.c      The memory is DMA capable(uncached)    */
ifdef|#
directive|ifdef
name|CCBUILD_EncryptionDriver
comment|/* extend the DMA memory for supporting two encryption DEK tables */
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|numElements
operator|=
literal|128
operator|+
name|DEK_MAX_TABLE_ENTRIES
operator|/
literal|2
expr_stmt|;
else|#
directive|else
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|numElements
operator|=
literal|128
expr_stmt|;
endif|#
directive|endif
comment|/* worked       initiatorResource->initiatorOption.dynamicDmaMem.singleElementLength  = sizeof(tdIORequestBody_t);   */
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|singleElementLength
operator|=
literal|512
expr_stmt|;
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|totalLength
operator|=
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|numElements
operator|*
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|singleElementLength
expr_stmt|;
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicDmaMem
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
comment|/* This is not used in OS like Linux which supports dynamic memeory allocation      In short, this is for Windows, which does not support dynamic memory allocation */
comment|/* ostiallocmemory(..... ,agTRUE) is supported by the following code eg) sat.c      The memory is DMA incapable(cached)    */
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicCachedMem
operator|.
name|numElements
operator|=
literal|1024
operator|+
literal|256
expr_stmt|;
comment|/* worked    initiatorResource->initiatorOption.dynamicCachedMem.singleElementLength = sizeof(tdIORequestBody_t);   initiatorResource->initiatorOption.dynamicCachedMem.singleElementLength = sizeof(tdssSMPRequestBody_t);   */
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicCachedMem
operator|.
name|singleElementLength
operator|=
literal|512
expr_stmt|;
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicCachedMem
operator|.
name|totalLength
operator|=
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicCachedMem
operator|.
name|numElements
operator|*
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicCachedMem
operator|.
name|singleElementLength
expr_stmt|;
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|dynamicCachedMem
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
comment|/*    * set the I/O request body size    */
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|ioRequestBodySize
operator|=
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssGetResource: sizeof(tdssSMPRequestBody_t) %d\n"
operator|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssGetResource: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  itdssGetOperatingOptionParams * *  Purpose: This function is called to get default parameters from the  *           OS Specific area. This function is called in the context of  *           tiCOMGetResource() and tiCOMInit(). * * *  \param  tiRoot:   Pointer to initiator driver/port instance. *  \param  option:   Pointer to the Transport Dependent options. * *  \return: None * *  \note - * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssGetOperatingOptionParams
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|itdssOperatingOption_t
modifier|*
name|OperatingOption
parameter_list|)
block|{
name|char
modifier|*
name|key
init|=
name|agNULL
decl_stmt|;
name|char
modifier|*
name|subkey1
init|=
name|agNULL
decl_stmt|;
name|char
modifier|*
name|subkey2
init|=
name|agNULL
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|bit32
name|buffLen
decl_stmt|;
name|bit32
name|lenRecv
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pLastUsedChar
init|=
name|agNULL
decl_stmt|;
name|char
name|tmpBuffer
index|[
name|DEFAULT_KEY_BUFFER_SIZE
index|]
decl_stmt|;
name|char
name|globalStr
index|[]
init|=
literal|"Global"
decl_stmt|;
name|char
name|iniParmsStr
index|[]
init|=
literal|"InitiatorParms"
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssGetOperatingOptionParams: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       first set the values to Default values      Then, overwrite them using ostiGetTransportParam()   */
comment|/* to remove compiler warnings */
name|pLastUsedChar
operator|=
name|pLastUsedChar
expr_stmt|;
name|lenRecv
operator|=
name|lenRecv
expr_stmt|;
name|subkey2
operator|=
name|subkey2
expr_stmt|;
name|subkey1
operator|=
name|subkey1
expr_stmt|;
name|key
operator|=
name|key
expr_stmt|;
name|buffer
operator|=
operator|&
name|tmpBuffer
index|[
literal|0
index|]
expr_stmt|;
name|buffLen
operator|=
sizeof|sizeof
argument_list|(
name|tmpBuffer
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
comment|/* default values */
name|OperatingOption
operator|->
name|MaxTargets
operator|=
name|DEFAULT_MAX_DEV
expr_stmt|;
comment|/* DEFAULT_MAX_TARGETS; */
comment|/* 256 */
name|OperatingOption
operator|->
name|UsecsPerTick
operator|=
name|DEFAULT_INI_TIMER_TICK
expr_stmt|;
comment|/* 1 sec */
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
comment|/* defaults are overwritten in the following */
comment|/* Get MaxTargets */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|iniParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"MaxTargets"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OperatingOption
operator|->
name|MaxTargets
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OperatingOption
operator|->
name|MaxTargets
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssGetOperatingOptionParams: MaxTargets  %d\n"
operator|,
name|OperatingOption
operator|->
name|MaxTargets
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
comment|/* get UsecsPerTick */
if|if
condition|(
operator|(
name|ostiGetTransportParam
argument_list|(
name|tiRoot
argument_list|,
name|globalStr
argument_list|,
name|iniParmsStr
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
literal|"UsecsPerTick"
argument_list|,
name|buffer
argument_list|,
name|buffLen
argument_list|,
operator|&
name|lenRecv
argument_list|)
operator|==
name|tiSuccess
operator|)
operator|&&
operator|(
name|lenRecv
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|osti_strncmp
argument_list|(
name|buffer
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OperatingOption
operator|->
name|UsecsPerTick
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OperatingOption
operator|->
name|UsecsPerTick
operator|=
name|osti_strtoul
argument_list|(
name|buffer
argument_list|,
operator|&
name|pLastUsedChar
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|buffLen
argument_list|)
expr_stmt|;
name|lenRecv
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  itdssInit * *  Purpose: This function is called to initialize the initiator specific  *           Transport Dependent Layer.  *           This function is not directly called by OS Specific module,  *           as it is internally called by tiCOMInit(). * *  /param tiRoot:            Pointer to driver/port instance. *  /param initiatorResource: Pointer to initiator functionality memory *                            and option requirement. *  /param tdSharedMem:       Pointer to cached memory required by the  *                            target/initiator shared functionality. * *  /return:  *   tiSuccess   OK *   others      not OK * *  /note - * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|itdssInit
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiInitiatorResource_t
modifier|*
name|initiatorResource
parameter_list|,
name|tiTdSharedMem_t
modifier|*
name|tdSharedMem
parameter_list|)
block|{
name|tiInitiatorMem_t
modifier|*
name|iniMem
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
decl_stmt|;
name|itdssOperatingOption_t
modifier|*
name|OperatingOption
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssInit: start\n"
operator|)
argument_list|)
expr_stmt|;
name|iniMem
operator|=
operator|&
name|initiatorResource
operator|->
name|initiatorMem
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
comment|/*     * Cached mem for initiator Transport Dependent Layer main functionality     */
name|Initiator
operator|=
name|iniMem
operator|->
name|tdCachedMem
index|[
literal|0
index|]
operator|.
name|virtPtr
expr_stmt|;
comment|/*     * Get default parameters from the OS Specific area     */
name|OperatingOption
operator|=
operator|&
name|Initiator
operator|->
name|OperatingOption
expr_stmt|;
comment|/*     * Get default parameters from the OS Specific area    * and reads parameters from the configuration file    */
name|itdssGetOperatingOptionParams
argument_list|(
name|tiRoot
argument_list|,
name|OperatingOption
argument_list|)
expr_stmt|;
comment|/*    * Update TD operating options with OS-layer-saved value    * Only UsecsPerTick is updated    */
name|OperatingOption
operator|->
name|UsecsPerTick
operator|=
name|initiatorResource
operator|->
name|initiatorOption
operator|.
name|usecsPerTick
expr_stmt|;
name|Initiator
operator|->
name|NumIOsActive
operator|=
literal|0
expr_stmt|;
comment|/*     *  tdCachedMem[0]: cached mem for initiator TD Layer main functionality :    *                   itdssIni_t    *  tdCachedMem[1-5]: not in use   */
comment|/* initialize the timerlist */
name|itdssInitTimers
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
comment|/* Initialize the tdsaAllShared, tdssSASShared pointers */
name|Initiator
operator|->
name|tdsaAllShared
operator|=
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssInit: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|tiSuccess
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief *  itdssInitTimers * *  Purpose: This function is called to initialize the timers *           for initiator * *  \param   tiRoot: pointer to the driver instance * *  \return: None * *  \note - * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssInitTimers
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
operator|(
name|tiRoot
operator|->
name|tdData
operator|)
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
comment|/* initialize the timerlist */
name|TDLIST_INIT_HDR
argument_list|(
operator|&
operator|(
name|Initiator
operator|->
name|timerlist
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


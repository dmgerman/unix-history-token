begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  *  * This file contains initiator IO related functions in TD layer  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_comment
comment|/***************************************************************************** *! \brief  tiINIIOStart * *   Purpose:  This routine is called to initiate a new SCSI request. * *  \param   tiRoot:           Pointer to initiator driver/port instance. *  \param   tiIORequest:      Pointer to the I/O request context for this I/O. *  \param   tiDeviceHandle:   Pointer to device handle for this I/O. *  \param   tiScsiRequest:    Pointer to the SCSI-3 I/O request and SGL list. *  \param   tiRequestBody:    Pointer to the OS Specific module allocated storage *                             to be used by the TD layer for executing this I/O. *  \param   interruptContext: The interrupt context within which this function *                       is called. *  \return: * *  tiSuccess:     I/O request successfully initiated. *  tiBusy:        No resources available, try again later. *  tiIONoDevice:  Invalid device handle. *  tiError:       Other errors that prevent the I/O request to be started. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINIIOStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|void
modifier|*
name|tiRequestBody
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|bit32
name|saStatus
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaSSPInitiatorRequest_t
modifier|*
name|agSSPInitiatorRequest
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
comment|/* only for debugging */
name|bit32
name|i
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SATA_ENABLE
ifndef|#
directive|ifndef
name|FDS_SM
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot_t
modifier|*
name|smRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
decl_stmt|;
name|smIORequest_t
modifier|*
name|smIORequest
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smSCSIRequest
decl_stmt|;
endif|#
directive|endif
name|TDSA_INP_ENTER
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart:: ******* tdsaRoot %p tdsaAllShared %p \n"
operator|,
name|tdsaRoot
operator|,
name|tdsaAllShared
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart: onedevicedata %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStart: tiDeviceHandle=%p DeviceData is NULL\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiIONoDevice
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/* for hotplug */
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|registered
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStart: tiDeviceHandle=%p did %d DeviceData was removed\n"
operator|,
name|tiDeviceHandle
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart: device AddrHi 0x%08x AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|// for debugging
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOForDebugging1Completed
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart: IOCompletionFunc %p\n"
operator|,
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiIONoDevice
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
if|#
directive|if
literal|1
if|if
condition|(
name|tiIORequest
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStart: tiIORequest->osData is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* starting IO with SAS device */
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SAS_DEVICE
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart: calling saSSPStart\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
comment|/* OS layer has tdlayer data structure pointer in        tdIORequestBody_t    tdIOReqBody;        in ccb_t in agtiapi.h     */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
comment|/* initialize */
name|osti_memset
argument_list|(
name|tdIORequestBody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* let's initialize tdIOrequestBody */
comment|/* initialize callback */
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOCompleted
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
comment|/* save context if we need to abort later */
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
comment|/* initialize expDataLength */
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|sglVirtualAddr
operator|=
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
comment|/* initializes "agsaSgl_t   agSgl" of "agsaDifSSPInitiatorRequest_t" */
name|tiStatus
operator|=
name|itdssIOPrepareSGL
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
argument_list|,
operator|&
name|tiScsiRequest
operator|->
name|agSgl1
argument_list|,
name|tiScsiRequest
operator|->
name|sglVirtualAddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStart: can't get SGL\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/* initialize agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/*       initialize       tdIORequestBody_t tdIORequestBody -> agSASRequestBody     */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPInitiatorRequest
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspInitiatorReq
operator|)
expr_stmt|;
name|agSSPInitiatorRequest
operator|->
name|flag
operator|=
literal|0
expr_stmt|;
comment|/* copy cdb bytes */
name|osti_memcpy
argument_list|(
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
argument_list|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* copy lun field */
name|osti_memcpy
argument_list|(
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|lun
argument_list|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|lun
operator|.
name|lun
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* setting the data length */
name|agSSPInitiatorRequest
operator|->
name|dataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart: tiScsiRequest->scsiCmnd.expDataLength %d\n"
operator|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
operator|)
argument_list|)
expr_stmt|;
name|agSSPInitiatorRequest
operator|->
name|firstBurstSize
operator|=
literal|0
expr_stmt|;
comment|/*       process taskattribute     */
if|if
condition|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|taskAttribute
operator|==
name|TASK_SIMPLE
condition|)
block|{
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator|=
operator|(
name|bit8
operator|)
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator||
name|TD_TASK_SIMPLE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|taskAttribute
operator|==
name|TASK_ORDERED
condition|)
block|{
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator|=
operator|(
name|bit8
operator|)
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator||
name|TD_TASK_ORDERED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|taskAttribute
operator|==
name|TASK_HEAD_OF_QUEUE
condition|)
block|{
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator|=
operator|(
name|bit8
operator|)
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator||
name|TD_TASK_HEAD_OF_QUEUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|taskAttribute
operator|==
name|TASK_ACA
condition|)
block|{
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator|=
operator|(
name|bit8
operator|)
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator||
name|TD_TASK_ACA
expr_stmt|;
block|}
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionIn
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SSP_INIT_READ
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart: READ\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionOut
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SSP_INIT_WRITE
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart: WRITE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agRequestType
operator|=
name|AGSA_REQ_TYPE_UNKNOWN
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStart: unknown data direction\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|agRequestType
operator|=
name|agRequestType
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart: device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStart: device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* for debugging */
if|if
condition|(
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStart: Error!!!! IOCompletionFunc is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|Initiator
operator|->
name|NumIOsActive
operator|++
expr_stmt|;
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
else|else
block|{
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiINIIOStart: saSSPStart busy\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
goto|goto
name|ext
goto|;
block|}
block|}
ifdef|#
directive|ifdef
name|FDS_SM
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINIIOStart: calling satIOStart\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINIIOStart: onedevicedata did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
comment|/* initialize */
name|osti_memset
argument_list|(
name|tdIORequestBody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
name|tdIORequestBody
operator|->
name|superIOFlag
operator|=
name|agFALSE
expr_stmt|;
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
name|smIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|smIORequest
operator|)
expr_stmt|;
name|smIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
name|smDeviceHandle
operator|=
operator|(
name|smDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
expr_stmt|;
name|smDeviceHandle
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
name|smSCSIRequest
operator|=
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|SM
operator|.
name|smSCSIRequest
operator|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|smSCSIRequest
argument_list|,
name|tiScsiRequest
argument_list|,
sizeof|sizeof
argument_list|(
name|smScsiInitiatorRequest_t
argument_list|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|smIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
comment|/* osGLOBAL bit32 smIOStart(           smRoot_t          *smRoot,           smIORequest_t         *smIORequest,           smDeviceHandle_t      *smDeviceHandle,           smScsiInitiatorRequest_t  *smSCSIRequest,           bit32             interruptContext          )       */
block|}
else|#
directive|else
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINIIOStart: calling satIOStart\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINIIOStart: onedevicedata did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SATA_ENABLE
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
comment|/* initialize */
name|osti_memset
argument_list|(
name|tdIORequestBody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOForDebugging2Completed
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
comment|/*      * Need to initialize all the fields within satIOContext except      * reqType and satCompleteCB which will be set in sat.c depending on cmd.      */
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|.
name|senseData
operator|=
name|agNULL
expr_stmt|;
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|.
name|senseLen
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|=
operator|&
name|oneDeviceData
operator|->
name|satDevData
expr_stmt|;
name|satIOContext
operator|->
name|pFis
operator|=
operator|&
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
expr_stmt|;
name|satIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|satIOContext
operator|->
name|pSense
operator|=
operator|&
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
expr_stmt|;
name|satIOContext
operator|->
name|pTiSenseData
operator|=
operator|&
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
expr_stmt|;
name|satIOContext
operator|->
name|pTiSenseData
operator|->
name|senseData
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
comment|/*    satIOContext->pSense = (scsiRspSense_t *)satIOContext->pTiSenseData->senseData; */
name|satIOContext
operator|->
name|tiRequestBody
operator|=
name|tiRequestBody
expr_stmt|;
name|satIOContext
operator|->
name|interruptContext
operator|=
name|interruptContext
expr_stmt|;
name|satIOContext
operator|->
name|ptiDeviceHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
name|satIOContext
operator|->
name|tiScsiXchg
operator|=
name|tiScsiRequest
expr_stmt|;
name|satIOContext
operator|->
name|satIntIoContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
comment|/*    satIOContext->tiIORequest      = tiIORequest; */
comment|/* save context if we need to abort later */
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
comment|/* followings are used only for internal IO */
name|satIOContext
operator|->
name|currentLBA
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
literal|0
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINIIOStart: pSatDevData=%p\n"
operator|,
name|satIOContext
operator|->
name|pSatDevData
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|satIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
endif|#
directive|endif
block|}
endif|#
directive|endif
comment|/* else of FDS_SM */
else|else
block|{
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOForDebugging3Completed
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStart: wrong unspported Device %d\n"
operator|,
name|oneDeviceData
operator|->
name|DeviceType
operator|)
argument_list|)
expr_stmt|;
comment|/*       error. unsupported IO      */
block|}
name|ext
label|:
name|TDSA_INP_LEAVE
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|FAST_IO_TEST
end_ifdef

begin_function
name|osGLOBAL
name|bit32
name|tiINIFastIOSend
parameter_list|(
name|void
modifier|*
name|ioh
parameter_list|)
block|{
name|bit32
name|saStatus
decl_stmt|,
name|tiStatus
decl_stmt|;
name|saStatus
operator|=
name|saFastSSPSend
argument_list|(
name|ioh
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
else|else
name|tiStatus
operator|=
name|tiError
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tiINIFastIOCancel
parameter_list|(
name|void
modifier|*
name|ioh
parameter_list|)
block|{
name|bit32
name|saStatus
decl_stmt|,
name|tiStatus
decl_stmt|;
name|saStatus
operator|=
name|saFastSSPCancel
argument_list|(
name|ioh
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
else|else
name|tiStatus
operator|=
name|tiError
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
modifier|*
name|tiINIFastIOPrepare
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|ioHandle
parameter_list|,
name|agsaFastCommand_t
modifier|*
name|fc
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|fc
operator|->
name|devHandle
decl_stmt|;
name|bit32
name|taskAttribute
init|=
name|fc
operator|->
name|taskAttribute
decl_stmt|;
name|void
modifier|*
name|ioh
init|=
name|ioHandle
decl_stmt|;
name|TDSA_INP_ENTER
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIFastIOPrepare: enter\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIFastIOPrepare: tiDeviceHandle=%p DeviceData is NULL\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
name|ioHandle
operator|=
literal|0
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIFastIOPrepare: onedevicedata %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
comment|/* starting IO with SAS device */
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|!=
name|TD_SAS_DEVICE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISuperIOSend: wrong Device %d\n"
operator|,
name|oneDeviceData
operator|->
name|DeviceType
operator|)
argument_list|)
expr_stmt|;
comment|/* error: unsupported IO */
name|ioHandle
operator|=
literal|0
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
name|fc
operator|->
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
name|NULL
operator|!=
name|fc
operator|->
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|fc
operator|->
name|devHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
name|NULL
operator|!=
name|fc
operator|->
name|devHandle
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|fc
operator|->
name|safb
operator|->
name|oneDeviceData
operator|=
name|oneDeviceData
expr_stmt|;
comment|/*     process taskattribute   */
switch|switch
condition|(
name|taskAttribute
condition|)
block|{
case|case
name|TASK_SIMPLE
case|:
name|fc
operator|->
name|taskAttribute
operator|=
name|TD_TASK_SIMPLE
expr_stmt|;
break|break;
case|case
name|TASK_ORDERED
case|:
name|fc
operator|->
name|taskAttribute
operator|=
name|TD_TASK_ORDERED
expr_stmt|;
break|break;
case|case
name|TASK_HEAD_OF_QUEUE
case|:
name|fc
operator|->
name|taskAttribute
operator|=
name|TD_TASK_HEAD_OF_QUEUE
expr_stmt|;
break|break;
case|case
name|TASK_ACA
case|:
name|fc
operator|->
name|taskAttribute
operator|=
name|TD_TASK_ACA
expr_stmt|;
break|break;
comment|/* compile out for "iniload" */
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIFastIOPrepare: data direction: %x\n"
operator|,
name|fc
operator|->
name|agRequestType
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIFastIOPrepare: device AddrHi/Lo 0x%08x / 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|fc
operator|->
name|queueNum
operator|=
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|ioHandle
operator|=
name|saFastSSPPrepare
argument_list|(
name|ioHandle
argument_list|,
name|fc
argument_list|,
name|ossaFastSSPCompleted
argument_list|,
name|fc
operator|->
name|safb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ioHandle
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIFastIOPrepare: saSuperSSPSend error\n"
operator|)
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|//goto ext;
block|}
name|ext
label|:
if|if
condition|(
name|ioh
operator|&&
operator|!
name|ioHandle
condition|)
block|{
name|saFastSSPCancel
argument_list|(
name|ioh
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIFastIOPrepare: leave\n"
operator|)
argument_list|)
expr_stmt|;
name|TDSA_INP_LEAVE
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
return|return
name|ioHandle
return|;
block|}
end_function

begin_comment
comment|/* tiINIFastIOPrepare */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** * *   tiINIIOStartDif * *   Purpose:  This routine is called to initiate a new SCSI request with *             DIF enable. * *   Parameters: *     tiRoot:           Pointer to initiator driver/port instance. *     tiIORequest:      Pointer to the I/O request context for this I/O. *     tiDeviceHandle:   Pointer to device handle for this I/O. *     tiScsiRequest:    Pointer to the SCSI-3 I/O request and SGL list. *     tiRequestBody:    Pointer to the OS Specific module allocated storage *                       to be used by the TD layer for executing this I/O. *     interruptContext: The interrupt context within which this function *                       is called. *     difOption:        DIF option. * *  Return: * *  tiSuccess:     I/O request successfully initiated. *  tiBusy:        No resources available, try again later. *  tiIONoDevice:  Invalid device handle. *  tiError:       Other errors that prevent the I/O request to be started. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINIIOStartDif
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|void
modifier|*
name|tiRequestBody
parameter_list|,
name|bit32
name|interruptContext
parameter_list|,
name|tiDif_t
modifier|*
name|difOption
parameter_list|)
block|{
comment|/* This function was never used by SAS/SATA. Use tiINISuperIOStart() instead. */
return|return
name|tiBusy
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** * *   tiINISuperIOStart * *   Purpose:  This routine is called to initiate a new SCSI request. * *   Parameters: *     tiRoot:           Pointer to initiator driver/port instance. *     tiIORequest:      Pointer to the I/O request context for this I/O. *     tiDeviceHandle:   Pointer to device handle for this I/O. *     tiScsiRequest:    Pointer to the SCSI-3 I/O request and SGL list. *     tiRequestBody:    Pointer to the OS Specific module allocated storage *                       to be used by the TD layer for executing this I/O. *     interruptContext: The interrupt context within which this function *                       is called. *  Return: * *  tiSuccess:     I/O request successfully initiated. *  tiBusy:        No resources available, try again later. *  tiIONoDevice:  Invalid device handle. *  tiError:       Other errors that prevent the I/O request to be started. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINISuperIOStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiSuperScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|void
modifier|*
name|tiRequestBody
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
name|agNULL
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSSPInitiatorRequest_t
modifier|*
name|agSSPInitiatorRequest
init|=
name|agNULL
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|bit32
name|saStatus
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|bit32
name|adjusted_length
init|=
literal|0
decl_stmt|;
name|bit32
name|agRequestType
init|=
literal|0
decl_stmt|;
name|agBOOLEAN
name|needPlusDataLenAdjustment
init|=
name|agFALSE
decl_stmt|;
name|agBOOLEAN
name|needMinusDataLenAdjustment
init|=
name|agFALSE
decl_stmt|;
ifdef|#
directive|ifdef
name|SATA_ENABLE
ifndef|#
directive|ifndef
name|FDS_SM
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot_t
modifier|*
name|smRoot
decl_stmt|;
name|smIORequest_t
modifier|*
name|smIORequest
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smSuperScsiInitiatorRequest_t
modifier|*
name|smSuperSCSIRequest
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CCBUILD_INDIRECT_CDB
name|agsaSSPInitiatorRequestIndirect_t
modifier|*
name|agSSPInitiatorIndRequest
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|TD_ASSERT
argument_list|(
name|tiRoot
argument_list|,
literal|"tiRoot"
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tiIORequest
argument_list|,
literal|"tiIORequest"
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tiDeviceHandle
argument_list|,
literal|"tiDeviceHandle"
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tiRequestBody
argument_list|,
literal|"tiRequestBody"
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tiRoot
operator|->
name|tdData
argument_list|,
literal|"tiRoot->tdData"
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tiDeviceHandle
argument_list|,
literal|"tiDeviceHandle"
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaRoot
argument_list|,
literal|"tdsaRoot"
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tdsaAllShared
argument_list|,
literal|"tdsaAllShared"
argument_list|)
expr_stmt|;
name|Initiator
operator|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|Initiator
argument_list|,
literal|"Initiator"
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|oneDeviceData
argument_list|,
literal|"oneDeviceData"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_SM
name|smRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|smRoot
operator|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|smRoot
argument_list|,
literal|"smRoot"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart:: ******* tdsaRoot %p tdsaAllShared %p \n"
operator|,
name|tdsaRoot
operator|,
name|tdsaAllShared
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: onedevicedata %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISuperIOStart: tiDeviceHandle=%p DeviceData is NULL\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiIONoDevice
return|;
block|}
comment|/* for hotplug */
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|registered
operator|!=
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISuperIOStart: tiDeviceHandle=%p did %d DeviceData was removed\n"
operator|,
name|tiDeviceHandle
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: device AddrHi 0x%08x AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|// for debugging
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOForDebugging1Completed
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: IOCompletionFunc %p\n"
operator|,
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiIONoDevice
return|;
block|}
ifdef|#
directive|ifdef
name|DBG
if|if
condition|(
name|tiIORequest
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISuperIOStart: tiIORequest->osData is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
endif|#
directive|endif
comment|/* starting IO with SAS device */
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SAS_DEVICE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINISuperIOStart: calling saSSPStart\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
comment|/* OS layer has tdlayer data structure pointer in tdIORequestBody_t  tdIOReqBody; in ccb_t in agtiapi.h */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
comment|/* initialize */
comment|/*the tdIORequestBody has been initialized in HwBuildIo routine */
comment|/*osti_memset(tdIORequestBody, 0, sizeof(tdIORequestBody_t));*/
comment|/* let's initialize tdIOrequestBody */
comment|/* initialize callback */
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOCompleted
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
comment|/* save context if we need to abort later */
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
comment|/* initialize expDataLength */
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|sglVirtualAddr
operator|=
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
comment|/* initialize agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequestBody
expr_stmt|;
comment|/* initialize tdIORequestBody_t tdIORequestBody -> agSASRequestBody */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPInitiatorRequest
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspInitiatorReq
operator|)
expr_stmt|;
name|agSSPInitiatorRequest
operator|->
name|flag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tiScsiRequest
operator|->
name|flags
operator|&
name|TI_SCSI_INITIATOR_ENCRYPT
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINISuperIOStart: TI_SCSI_INITIATOR_ENCRYPT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*  Copy all of the relevant encrypt information */
name|agSSPInitiatorRequest
operator|->
name|flag
operator||=
name|AGSA_SAS_ENABLE_ENCRYPTION
expr_stmt|;
name|TD_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|tiEncrypt_t
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|agsaEncrypt_t
argument_list|)
argument_list|,
literal|"sizeof(tiEncrypt_t) == sizeof(agsaEncrypt_t)"
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|agSSPInitiatorRequest
operator|->
name|encrypt
argument_list|,
operator|&
name|tiScsiRequest
operator|->
name|Encrypt
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaEncrypt_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|tiScsiRequest
operator|->
name|flags
operator|&
name|TI_SCSI_INITIATOR_DIF
operator|)
operator|&&
operator|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_READ_10
operator|||
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_WRITE_10
operator|||
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_WRITE_6
operator|||
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_READ_6
operator|||
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_READ_12
operator|||
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_WRITE_12
operator|||
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_WRITE_16
operator|||
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_READ_16
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINISuperIOStart: TI_SCSI_INITIATOR_DIF\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Copy all of the relevant DIF information */
name|agSSPInitiatorRequest
operator|->
name|flag
operator||=
name|AGSA_SAS_ENABLE_DIF
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|agSSPInitiatorRequest
operator|->
name|dif
argument_list|,
operator|&
name|tiScsiRequest
operator|->
name|Dif
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDif_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check if need to adjust dataLength. */
switch|switch
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
condition|)
block|{
case|case
name|tiDirectionOut
case|:
comment|/* Write/Outbound */
break|break;
case|case
name|tiDirectionIn
case|:
comment|/* Read/Inbound */
if|if
condition|(
operator|(
name|agSSPInitiatorRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_ACTION_FLAG_MASK
operator|)
operator|==
name|DIF_INSERT
condition|)
block|{
name|needPlusDataLenAdjustment
operator|=
name|agTRUE
expr_stmt|;
block|}
break|break;
block|}
comment|/* Set SGL data len XXX This code needs to support more sector sizes */
comment|/* Length adjustment for PCIe DMA only not SAS */
if|if
condition|(
name|needPlusDataLenAdjustment
operator|==
name|agTRUE
condition|)
block|{
name|adjusted_length
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
name|adjusted_length
operator|+=
operator|(
name|adjusted_length
operator|/
literal|512
operator|)
operator|*
literal|8
expr_stmt|;
name|agSSPInitiatorRequest
operator|->
name|dataLength
operator|=
name|adjusted_length
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|needMinusDataLenAdjustment
operator|==
name|agTRUE
condition|)
block|{
name|adjusted_length
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
name|adjusted_length
operator|-=
operator|(
name|adjusted_length
operator|/
literal|520
operator|)
operator|*
literal|8
expr_stmt|;
name|agSSPInitiatorRequest
operator|->
name|dataLength
operator|=
name|adjusted_length
expr_stmt|;
block|}
else|else
block|{
comment|/* setting the data length */
name|agSSPInitiatorRequest
operator|->
name|dataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
comment|/* initializes "agsaSgl_t   agSgl" of "agsaDifSSPInitiatorRequest_t" */
name|tiStatus
operator|=
name|itdssIOPrepareSGL
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
argument_list|,
operator|&
name|tiScsiRequest
operator|->
name|agSgl1
argument_list|,
name|tiScsiRequest
operator|->
name|sglVirtualAddr
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINISuperIOStart:TI_SCSI_INITIATOR_DIF needMinusDataLenAdjustment %d needPlusDataLenAdjustment %d difAction %X\n"
operator|,
name|needMinusDataLenAdjustment
operator|,
name|needPlusDataLenAdjustment
operator|,
name|agSSPInitiatorRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_ACTION_FLAG_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* setting the data length */
name|agSSPInitiatorRequest
operator|->
name|dataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
comment|/* initializes "agsaSgl_t   agSgl" of "agsaSSPInitiatorRequest_t" */
name|tiStatus
operator|=
name|itdssIOPrepareSGL
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
argument_list|,
operator|&
name|tiScsiRequest
operator|->
name|agSgl1
argument_list|,
name|tiScsiRequest
operator|->
name|sglVirtualAddr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tiStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISuperIOStart: can't get SGL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: tiScsiRequest->scsiCmnd.expDataLength %d\n"
operator|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
operator|)
argument_list|)
expr_stmt|;
comment|/* process taskattribute */
if|if
condition|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|taskAttribute
operator|==
name|TASK_SIMPLE
condition|)
block|{
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator|=
operator|(
name|bit8
operator|)
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator||
name|TD_TASK_SIMPLE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|taskAttribute
operator|==
name|TASK_ORDERED
condition|)
block|{
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator|=
operator|(
name|bit8
operator|)
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator||
name|TD_TASK_ORDERED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|taskAttribute
operator|==
name|TASK_HEAD_OF_QUEUE
condition|)
block|{
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator|=
operator|(
name|bit8
operator|)
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator||
name|TD_TASK_HEAD_OF_QUEUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|taskAttribute
operator|==
name|TASK_ACA
condition|)
block|{
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator|=
operator|(
name|bit8
operator|)
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator||
name|TD_TASK_ACA
expr_stmt|;
block|}
comment|/* copy cdb bytes */
name|osti_memcpy
argument_list|(
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
argument_list|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* copy lun field */
name|osti_memcpy
argument_list|(
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|lun
argument_list|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|lun
operator|.
name|lun
argument_list|,
literal|8
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CCBUILD_INDIRECT_CDB
comment|/* check the Indirect CDB flag */
if|if
condition|(
name|tiScsiRequest
operator|->
name|flags
operator|&
name|TI_SCSI_INITIATOR_INDIRECT_CDB
condition|)
block|{
comment|/* Indirect CDB */
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionIn
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SSP_INIT_READ_INDIRECT
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: Indirect READ\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionOut
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SSP_INIT_WRITE_INDIRECT
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: Indirect WRITE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agRequestType
operator|=
name|AGSA_REQ_TYPE_UNKNOWN
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISuperIOStart: unknown data direction\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|agSSPInitiatorIndRequest
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspInitiatorReqIndirect
operator|)
expr_stmt|;
comment|/* copy the constructed SSPIU info to indirect SSPIU buffer */
name|osti_memcpy
argument_list|(
name|tiScsiRequest
operator|->
name|IndCDBBuffer
argument_list|,
operator|&
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPCmdInfoUnit_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* initialize the indirect CDB buffer address and length */
name|agSSPInitiatorIndRequest
operator|->
name|sspInitiatorReqAddrLower32
operator|=
name|tiScsiRequest
operator|->
name|IndCDBLowAddr
expr_stmt|;
name|agSSPInitiatorIndRequest
operator|->
name|sspInitiatorReqAddrUpper32
operator|=
name|tiScsiRequest
operator|->
name|IndCDBHighAddr
expr_stmt|;
name|agSSPInitiatorIndRequest
operator|->
name|sspInitiatorReqLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaSSPCmdInfoUnit_t
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
comment|//CCBUILD_INDIRECT_CDB
block|{
comment|/* Direct CDB */
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionIn
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SSP_INIT_READ
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: READ\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionOut
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SSP_INIT_WRITE
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: WRITE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agRequestType
operator|=
name|AGSA_REQ_TYPE_UNKNOWN
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISuperIOStart: unknown data direction\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|tdIORequestBody
operator|->
name|agRequestType
operator|=
name|agRequestType
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISuperIOStart: device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DBG
comment|/* for debugging */
if|if
condition|(
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISuperIOStart: Error!!!! IOCompletionFunc is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
endif|#
directive|endif
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|Initiator
operator|->
name|NumIOsActive
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
else|else
block|{
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"tiINISuperIOStart: saSSPStart busy\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
name|tiStatus
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|FDS_SM
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINISuperIOStart: calling satIOStart\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINISuperIOStart: onedevicedata did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINISuperIOStart: SATA sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINISuperIOStart: SATA sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
comment|/* initialize */
comment|/* the tdIORequestBody has been initialized by Storport in SRB Extension */
comment|/*osti_memset(tdIORequestBody, 0, sizeof(tdIORequestBody_t));*/
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
name|tdIORequestBody
operator|->
name|superIOFlag
operator|=
name|agTRUE
expr_stmt|;
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
name|smIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|smIORequest
operator|)
expr_stmt|;
name|smIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
name|smIORequest
operator|->
name|smData
operator|=
operator|&
name|tdIORequestBody
operator|->
name|smIORequestBody
expr_stmt|;
name|smDeviceHandle
operator|=
operator|(
name|smDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|smDeviceHandle
operator|)
expr_stmt|;
name|smDeviceHandle
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
name|smSuperSCSIRequest
operator|=
operator|(
name|smSuperScsiInitiatorRequest_t
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|SM
operator|.
name|smSuperSCSIRequest
operator|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|smSuperSCSIRequest
argument_list|,
name|tiScsiRequest
argument_list|,
sizeof|sizeof
argument_list|(
name|smSuperScsiInitiatorRequest_t
argument_list|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|smSuperIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSuperSCSIRequest
argument_list|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
argument_list|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINISuperIOStart: calling satIOStart\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINISuperIOStart: onedevicedata did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SATA_ENABLE
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
comment|/* initialize */
name|osti_memset
argument_list|(
name|tdIORequestBody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOForDebugging2Completed
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
comment|/*      * Need to initialize all the fields within satIOContext except      * reqType and satCompleteCB which will be set in sat.c depending on cmd.      */
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|.
name|senseData
operator|=
name|agNULL
expr_stmt|;
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|.
name|senseLen
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|=
operator|&
name|oneDeviceData
operator|->
name|satDevData
expr_stmt|;
name|satIOContext
operator|->
name|pFis
operator|=
operator|&
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
expr_stmt|;
name|satIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|satIOContext
operator|->
name|pSense
operator|=
operator|&
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
expr_stmt|;
name|satIOContext
operator|->
name|pTiSenseData
operator|=
operator|&
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
expr_stmt|;
name|satIOContext
operator|->
name|pTiSenseData
operator|->
name|senseData
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
comment|/*    satIOContext->pSense = (scsiRspSense_t *)satIOContext->pTiSenseData->senseData; */
name|satIOContext
operator|->
name|tiRequestBody
operator|=
name|tiRequestBody
expr_stmt|;
name|satIOContext
operator|->
name|interruptContext
operator|=
name|interruptContext
expr_stmt|;
name|satIOContext
operator|->
name|ptiDeviceHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/*      This code uses a kludge for the tiScsiXchg. Many subroutines in the SATA code      require a tiScsiInitiatorRequest. Since it would be a lot of work to replicate      those functions for a tiSuperScsiInitiatorRequest, we will use a short cut.      The standard pointer will be passed, but the superIOFlag marks the real type of the structure.     */
name|satIOContext
operator|->
name|tiScsiXchg
operator|=
name|tiScsiRequest
expr_stmt|;
name|satIOContext
operator|->
name|superIOFlag
operator|=
name|agTRUE
expr_stmt|;
name|satIOContext
operator|->
name|satIntIoContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
comment|/*    satIOContext->tiIORequest      = tiIORequest; */
comment|/* save context if we need to abort later */
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
comment|/* followings are used only for internal IO */
name|satIOContext
operator|->
name|currentLBA
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
literal|0
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tiINISuperIOStart: pSatDevData=%p\n"
operator|,
name|satIOContext
operator|->
name|pSatDevData
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|satIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|satIOContext
operator|->
name|tiScsiXchg
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
endif|#
directive|endif
block|}
endif|#
directive|endif
comment|/* else of FDS_SM */
else|else
block|{
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOForDebugging3Completed
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISuperIOStart: wrong unspported Device %d\n"
operator|,
name|oneDeviceData
operator|->
name|DeviceType
operator|)
argument_list|)
expr_stmt|;
comment|/*       error. unsupported IO      */
block|}
return|return
name|tiStatus
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tiINISMPStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiSMPFrame_t
modifier|*
name|tiSMPFrame
parameter_list|,
name|void
modifier|*
name|tiSMPBody
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdSMPRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSMPFrame_t
modifier|*
name|agSMPFrame
init|=
name|agNULL
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|bit32
name|saStatus
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|bit32
name|queueNum
decl_stmt|;
name|TDSA_INP_ENTER
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISMPStart: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISMPStart: onedevicedata %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISMPStart: tiDeviceHandle %p\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISMPStart: tiDeviceHandle=%p Expander DeviceData is NULL\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tiIORequest
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISMPStart: tiIORequest->osData is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|tdSMPRequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiSMPBody
expr_stmt|;
name|tdSMPRequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdSMPRequestBody
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|tdSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdSMPRequestBody
expr_stmt|;
name|agRequestBody
operator|=
operator|&
operator|(
name|tdSMPRequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSMPFrame
operator|=
operator|&
operator|(
name|agRequestBody
operator|->
name|smpFrame
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISMPStart: Target Device is not SMP device\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tiSMPFrame
operator|->
name|flag
operator|==
literal|0
condition|)
comment|// define DIRECT SMP at td layer?
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINISMPStart: Direct SMP\n"
operator|)
argument_list|)
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|tiSMPFrame
operator|->
name|outFrameBuf
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
name|tiSMPFrame
operator|->
name|outFrameLen
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"tiINISMPStart agSMPFrame"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|agSMPFrame
operator|->
name|outFrameBuf
argument_list|,
name|agSMPFrame
operator|->
name|outFrameLen
argument_list|)
expr_stmt|;
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
name|tiSMPFrame
operator|->
name|expectedRespLen
expr_stmt|;
name|agSMPFrame
operator|->
name|inFrameLen
operator|=
literal|0
expr_stmt|;
name|agSMPFrame
operator|->
name|flag
operator|=
name|tiSMPFrame
operator|->
name|flag
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SMP_INIT_REQ
expr_stmt|;
name|queueNum
operator|=
literal|0
expr_stmt|;
name|saStatus
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|queueNum
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agRequestBody
argument_list|,
operator|&
name|ossaSMPCAMCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISMPStart: saSSPStart busy\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISMPStart: saSSPStart error\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
name|tiStatus
return|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINISMPStart: Indirect SMP! Not supported yet\n"
operator|)
argument_list|)
expr_stmt|;
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
name|tiStatus
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|TD_INT_COALESCE
end_ifdef

begin_function
name|osGLOBAL
name|bit32
name|tiINIIOStartIntCoalesce
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|void
modifier|*
name|tiRequestBody
parameter_list|,
name|bit32
name|interruptContext
parameter_list|,
name|tiIntCoalesceContext_t
modifier|*
name|tiIntCoalesceCxt
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|bit32
name|saStatus
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaSSPInitiatorRequest_t
modifier|*
name|agSSPInitiatorRequest
decl_stmt|;
name|tdsaIntCoalesceContext_t
modifier|*
name|tdsaIntCoalCxt
decl_stmt|;
name|agsaIntCoalesceContext_t
modifier|*
name|agIntCoalCxt
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: onedevicedata %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: tiDeviceHandle=%p DeviceData is NULL\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiIONoDevice
return|;
block|}
comment|/* starting IO with SAS device */
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SAS_DEVICE
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: calling saSSPStart\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
comment|/* OS layer has tdlayer data structure pointer in        tdIORequestBody_t    tdIOReqBody;        in ccb_t in agtiapi.h     */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
comment|/* let's initialize tdIOrequestBody */
comment|/* initialize callback */
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOCompleted
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
comment|/* save context if we need to abort later */
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
comment|/* initialize expDataLength */
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
comment|/* initializes "agsaSgl_t   agSgl" of "agsaDifSSPInitiatorRequest_t" */
name|tiStatus
operator|=
name|itdssIOPrepareSGL
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
argument_list|,
operator|&
name|tiScsiRequest
operator|->
name|agSgl1
argument_list|,
name|tiScsiRequest
operator|->
name|sglVirtualAddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: can't get SGL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
comment|/* initialize agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/*       initialize       tdIORequestBody_t tdIORequestBody -> agSASRequestBody     */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPInitiatorRequest
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspInitiatorReq
operator|)
expr_stmt|;
comment|/* copy cdb bytes */
name|osti_memcpy
argument_list|(
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
argument_list|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* copy lun field */
name|osti_memcpy
argument_list|(
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|lun
argument_list|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|lun
operator|.
name|lun
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* setting the data length */
name|agSSPInitiatorRequest
operator|->
name|dataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: tiScsiRequest->scsiCmnd.expDataLength %d\n"
operator|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
operator|)
argument_list|)
expr_stmt|;
name|agSSPInitiatorRequest
operator|->
name|firstBurstSize
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionIn
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SSP_INIT_READ
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: READ\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionOut
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SSP_INIT_WRITE
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: WRITE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agRequestType
operator|=
name|AGSA_REQ_TYPE_UNKNOWN
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: unknown data direction\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|agRequestType
operator|=
name|agRequestType
expr_stmt|;
name|tdsaIntCoalCxt
operator|=
operator|(
name|tdsaIntCoalesceContext_t
operator|*
operator|)
name|tiIntCoalesceCxt
operator|->
name|tdData
expr_stmt|;
name|agIntCoalCxt
operator|=
operator|&
operator|(
name|tdsaIntCoalCxt
operator|->
name|agIntCoalCxt
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|LL_INT_COALESCE
name|saStatus
operator|=
name|saSSPStartIntCoalesce
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIntCoalCxt
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|Initiator
operator|->
name|NumIOsActive
operator|++
expr_stmt|;
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: saSSPStart failed\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
name|tiStatus
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
comment|/*       satIOStart() -> saSATAStartIntCoalesce()     */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: SATA not supported yet\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesce: wrong unspported Device %d\n"
operator|,
name|oneDeviceData
operator|->
name|DeviceType
operator|)
argument_list|)
expr_stmt|;
comment|/*       error. unsupported IO      */
block|}
return|return
name|tiStatus
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tiINIIOStartIntCoalesceDif
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|void
modifier|*
name|tiRequestBody
parameter_list|,
name|bit32
name|interruptContext
parameter_list|,
name|tiIntCoalesceContext_t
modifier|*
name|tiIntCoalesceCxt
parameter_list|,
name|tiDif_t
modifier|*
name|difOption
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaDifSSPRequestBody_t
modifier|*
name|agEdcSSPRequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|bit32
name|saStatus
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaDifSSPInitiatorRequest_t
modifier|*
name|agEdcSSPInitiatorRequest
decl_stmt|;
name|agsaDif_t
modifier|*
name|agEdc
decl_stmt|;
name|bit32
name|agUpdateMask
init|=
literal|0
decl_stmt|;
name|bit32
name|agVerifyMask
init|=
literal|0
decl_stmt|;
name|tdsaIntCoalesceContext_t
modifier|*
name|tdsaIntCoalCxt
decl_stmt|;
name|agsaIntCoalesceContext_t
modifier|*
name|agIntCoalCxt
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: onedevicedata %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: tiDeviceHandle=%p DeviceData is NULL\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiIONoDevice
return|;
block|}
comment|/* starting IO with SAS device */
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SAS_DEVICE
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: calling saSSPStart\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
comment|/* OS layer has tdlayer data structure pointer in        tdIORequestBody_t    tdIOReqBody;        in ccb_t in agtiapi.h     */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
comment|/* let's initialize tdIOrequestBody */
comment|/* initialize callback */
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOCompleted
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
comment|/* save context if we need to abort later */
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
comment|/* initialize expDataLength */
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
comment|/* initializes "agsaSgl_t   agSgl" of "agsaDifSSPInitiatorRequest_t" */
name|tiStatus
operator|=
name|itdssIOPrepareSGL
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
argument_list|,
operator|&
name|tiScsiRequest
operator|->
name|agSgl1
argument_list|,
name|tiScsiRequest
operator|->
name|sglVirtualAddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: can't get SGL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
comment|/* initialize agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/*       initialize       tdIORequestBody_t tdIORequestBody -> agSASRequestBody     */
name|agEdcSSPRequestBody
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agEdcSSPRequestBody
operator|)
expr_stmt|;
name|agEdcSSPInitiatorRequest
operator|=
operator|&
operator|(
name|agEdcSSPRequestBody
operator|->
name|edcSSPInitiatorReq
operator|)
expr_stmt|;
comment|/* copy cdb bytes */
name|osti_memcpy
argument_list|(
name|agEdcSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
argument_list|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* copy lun field */
name|osti_memcpy
argument_list|(
name|agEdcSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|lun
argument_list|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|lun
operator|.
name|lun
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* setting the data length */
name|agEdcSSPInitiatorRequest
operator|->
name|dataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: tiScsiRequest->scsiCmnd.expDataLength %d\n"
operator|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
operator|)
argument_list|)
expr_stmt|;
name|agEdcSSPInitiatorRequest
operator|->
name|firstBurstSize
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionIn
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SSP_INIT_READ
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: READ difAction %X\n"
operator|,
name|difOption
operator|->
name|difAction
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionOut
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SSP_INIT_WRITE
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: WRITE difAction %X\n"
operator|,
name|difOption
operator|->
name|difAction
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agRequestType
operator|=
name|AGSA_REQ_TYPE_UNKNOWN
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: unknown data direction\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|agRequestType
operator|=
name|agRequestType
expr_stmt|;
comment|/* process interrupt coalesce context */
name|tdsaIntCoalCxt
operator|=
operator|(
name|tdsaIntCoalesceContext_t
operator|*
operator|)
name|tiIntCoalesceCxt
operator|->
name|tdData
expr_stmt|;
name|agIntCoalCxt
operator|=
operator|&
operator|(
name|tdsaIntCoalCxt
operator|->
name|agIntCoalCxt
operator|)
expr_stmt|;
comment|/* process DIF */
name|agEdc
operator|=
operator|&
operator|(
name|agEdcSSPInitiatorRequest
operator|->
name|edc
operator|)
expr_stmt|;
name|osti_memset
argument_list|(
name|agEdc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDif_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setting edcFlag */
if|if
condition|(
name|difOption
operator|->
name|enableBlockCount
condition|)
block|{
comment|/* enables block count; bit5 */
name|agEdc
operator|->
name|edcFlag
operator|=
name|agEdc
operator|->
name|edcFlag
operator||
literal|0x20
expr_stmt|;
comment|/* 0010 0000 */
block|}
if|if
condition|(
name|difOption
operator|->
name|enableCrc
condition|)
block|{
comment|/* enables CRC verification; bit6 */
name|agEdc
operator|->
name|edcFlag
operator|=
name|agEdc
operator|->
name|edcFlag
operator||
literal|0x40
expr_stmt|;
comment|/* 0100 0000 */
block|}
if|if
condition|(
name|difOption
operator|->
name|enableIOSeed
condition|)
block|{            }
if|if
condition|(
name|difOption
operator|->
name|difAction
operator|==
name|DIF_INSERT
condition|)
block|{
comment|/* bit 0 - 2; 000 */
name|agEdc
operator|->
name|edcFlag
operator|=
name|agEdc
operator|->
name|edcFlag
operator|&
literal|0xFFFFFFF8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|difOption
operator|->
name|difAction
operator|==
name|DIF_VERIFY_FORWARD
condition|)
block|{
comment|/* bit 0 - 2; 001 */
name|agEdc
operator|->
name|edcFlag
operator|=
name|agEdc
operator|->
name|edcFlag
operator||
literal|0x01
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|difOption
operator|->
name|difAction
operator|==
name|DIF_VERIFY_DELETE
condition|)
block|{
comment|/* bit 0 - 2; 010 */
name|agEdc
operator|->
name|edcFlag
operator|=
name|agEdc
operator|->
name|edcFlag
operator||
literal|0x02
expr_stmt|;
block|}
else|else
block|{
comment|/* DIF_VERIFY_REPLACE */
comment|/* bit 0 - 2; 011 */
name|agEdc
operator|->
name|edcFlag
operator|=
name|agEdc
operator|->
name|edcFlag
operator||
literal|0x04
expr_stmt|;
block|}
comment|/* set Update Mask; bit 16-21 */
name|agUpdateMask
operator|=
operator|(
name|difOption
operator|->
name|tagUpdateMask
operator|)
operator|&
literal|0x3F
expr_stmt|;
comment|/* 0011 1111 */
name|agUpdateMask
operator|=
name|agUpdateMask
operator|<<
literal|16
expr_stmt|;
name|agEdc
operator|->
name|edcFlag
operator|=
name|agEdc
operator|->
name|edcFlag
operator||
name|agUpdateMask
expr_stmt|;
comment|/* set Verify Mask bit 24-29 */
name|agVerifyMask
operator|=
operator|(
name|difOption
operator|->
name|tagVerifyMask
operator|)
operator|&
literal|0x3F
expr_stmt|;
comment|/* 0011 1111 */
name|agVerifyMask
operator|=
name|agVerifyMask
operator|<<
literal|24
expr_stmt|;
name|agEdc
operator|->
name|edcFlag
operator|=
name|agEdc
operator|->
name|edcFlag
operator||
name|agVerifyMask
expr_stmt|;
name|agEdc
operator|->
name|appTag
operator|=
name|difOption
operator|->
name|udtArray
index|[
literal|0
index|]
expr_stmt|;
name|agEdc
operator|->
name|appTag
operator|=
operator|(
name|agEdc
operator|->
name|appTag
operator|<<
literal|8
operator|)
operator||
name|difOption
operator|->
name|udtArray
index|[
literal|1
index|]
expr_stmt|;
name|agEdc
operator|->
name|lbaReferenceTag
operator|=
name|difOption
operator|->
name|udtArray
index|[
literal|2
index|]
expr_stmt|;
name|agEdc
operator|->
name|lbaReferenceTag
operator|=
operator|(
name|agEdc
operator|->
name|lbaReferenceTag
operator|<<
literal|8
operator|)
operator||
name|difOption
operator|->
name|udtArray
index|[
literal|3
index|]
expr_stmt|;
name|agEdc
operator|->
name|lbaReferenceTag
operator|=
operator|(
name|agEdc
operator|->
name|lbaReferenceTag
operator|<<
literal|8
operator|)
operator||
name|difOption
operator|->
name|udtArray
index|[
literal|4
index|]
expr_stmt|;
name|agEdc
operator|->
name|lbaReferenceTag
operator|=
operator|(
name|agEdc
operator|->
name|lbaReferenceTag
operator|<<
literal|8
operator|)
operator||
name|difOption
operator|->
name|udtArray
index|[
literal|5
index|]
expr_stmt|;
comment|/* currently TISA supports only 512 logical block size */
name|agEdc
operator|->
name|lbSize
operator|=
literal|512
expr_stmt|;
ifdef|#
directive|ifdef
name|LL_INT_COALESCE
name|saStatus
operator|=
name|saSSPStartIntCoalesceEdc
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIntCoalCxt
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agEdcSSPRequestBody
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|Initiator
operator|->
name|NumIOsActive
operator|++
expr_stmt|;
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: saSSPStart failed\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
block|}
return|return
name|tiStatus
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
comment|/*       satIOStart() -> saSATAStartIntCoalesceEdc()     */
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: SATA not supported yet\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIOStartIntCoalesceDif: wrong unspported Device %d\n"
operator|,
name|oneDeviceData
operator|->
name|DeviceType
operator|)
argument_list|)
expr_stmt|;
comment|/*       error. unsupported IO      */
block|}
return|return
name|tiStatus
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tiINIIntCoalesceInit
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIntCoalesceContext_t
modifier|*
name|tiIntCoalesceCxt
parameter_list|,
name|bit32
name|count
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaIntCoalesceContext_t
modifier|*
name|tdsaIntCoalCxtHead
init|=
operator|(
name|tdsaIntCoalesceContext_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|IntCoalesce
decl_stmt|;
name|tdsaIntCoalesceContext_t
modifier|*
name|tdsaIntCoalCxt
decl_stmt|;
name|agsaIntCoalesceContext_t
modifier|*
name|agIntCoalCxt
decl_stmt|;
name|tdList_t
modifier|*
name|tdsaIntCoalCxtList
init|=
name|agNULL
decl_stmt|;
name|bit32
name|tiStatus
init|=
name|tiError
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIntCoalesceInit: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_INTCOAL_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaIntCoalCxtHead
operator|->
name|FreeLink
operator|)
argument_list|)
condition|)
block|{
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|tdsaIntCoalCxtList
argument_list|,
operator|&
operator|(
name|tdsaIntCoalCxtHead
operator|->
name|FreeLink
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_INTCOAL_LOCK
argument_list|)
expr_stmt|;
name|tdsaIntCoalCxt
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaIntCoalesceContext_t
argument_list|,
name|FreeLink
argument_list|,
name|tdsaIntCoalCxtList
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIntCoalesceInit: id %d\n"
operator|,
name|tdsaIntCoalCxt
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|agIntCoalCxt
operator|=
operator|&
operator|(
name|tdsaIntCoalCxt
operator|->
name|agIntCoalCxt
operator|)
expr_stmt|;
name|tdsaIntCoalCxt
operator|->
name|tiIntCoalesceCxt
operator|=
name|tiIntCoalesceCxt
expr_stmt|;
name|tiIntCoalesceCxt
operator|->
name|tdData
operator|=
name|tdsaIntCoalCxt
expr_stmt|;
name|agIntCoalCxt
operator|->
name|osData
operator|=
name|tdsaIntCoalCxt
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_INTCOAL_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|tdsaIntCoalCxt
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaIntCoalCxtHead
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_INTCOAL_LOCK
argument_list|)
expr_stmt|;
comment|/*       note: currently asynchronously call is assumed. In other words,       "ossaIntCoalesceInitCB()" -> "ostiInitiatorCoalesceInitCB()" are used     */
ifdef|#
directive|ifdef
name|LL_INT_COALESCE
name|tiStatus
operator|=
name|saIntCoalesceInit
argument_list|(
name|agRoot
argument_list|,
name|agIntCoalCxt
argument_list|,
name|count
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIIntCoalesceInit: status %d\n"
operator|,
name|tiStatus
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_INTCOAL_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIIntCoalesceInit: no more interrupt coalesce context; return fail\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiStatus
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TD_INT_COALESCE */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief itdssIOPrepareSGL * *  Purpose:  This function is called to translate TISA SGL information to the *            LL layer SGL. * *  \param    tiRoot:         Pointer to initiator driver/port instance. *  \param    IORequestBody:  TD layer request body for the I/O. *  \param    tiSgl1:         First TISA SGL info. *  \param    sglVirtualAddr: The virtual address of the first element in *                            tiSgl1 when tiSgl1 is used with the type tiSglList. * *  \return: * *  tiSuccess:     SGL initialized successfully. *  tiError:       Failed to initialize SGL. * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|FORCEINLINE
name|bit32
name|itdssIOPrepareSGL
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
parameter_list|,
name|tiSgl_t
modifier|*
name|tiSgl1
parameter_list|,
name|void
modifier|*
name|sglVirtualAddr
parameter_list|)
block|{
name|agsaSgl_t
modifier|*
name|agSgl
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssIOPrepareSGL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agSgl
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|.
name|sspInitiatorReq
operator|.
name|agSgl
operator|)
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tiSgl1
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOPrepareSGL: Error tiSgl1 is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|==
literal|0
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssIOPrepareSGL: expDataLength is 0\n"
operator|)
argument_list|)
expr_stmt|;
name|agSgl
operator|->
name|sgUpper
operator|=
literal|0
expr_stmt|;
name|agSgl
operator|->
name|sgLower
operator|=
literal|0
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|CLEAR_ESGL_EXTEND
argument_list|(
name|agSgl
operator|->
name|extReserved
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|agSgl
operator|->
name|sgUpper
operator|=
name|tiSgl1
operator|->
name|upper
expr_stmt|;
name|agSgl
operator|->
name|sgLower
operator|=
name|tiSgl1
operator|->
name|lower
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
name|tiSgl1
operator|->
name|len
expr_stmt|;
name|agSgl
operator|->
name|extReserved
operator|=
name|tiSgl1
operator|->
name|type
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|tiNumOfLunIOCTLreq
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|void
modifier|*
name|tiRequestBody
parameter_list|,
name|tiIOCTLPayload_t
modifier|*
name|agIOCTLPayload
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
decl_stmt|;
name|void
modifier|*
name|respBuffer
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|osMemHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ostiMemoryStatus
init|=
literal|0
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaSSPInitiatorRequest_t
modifier|*
name|agSSPFrame
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|IOCTL_CALL_SUCCESS
decl_stmt|;
name|bit32
name|agRequestType
init|=
literal|0
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
do|do
block|{
if|if
condition|(
operator|(
name|tiIORequest
operator|==
name|agNULL
operator|)
operator|||
operator|(
name|tiRequestBody
operator|==
name|agNULL
operator|)
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
break|break;
block|}
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
if|if
condition|(
name|tdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
break|break;
block|}
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
comment|/* save context if we need to abort later */
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequestBody
expr_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspInitiatorReq
operator|)
expr_stmt|;
name|ostiMemoryStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|respBuffer
argument_list|,
operator|&
operator|(
name|agSSPFrame
operator|->
name|agSgl
operator|.
name|sgUpper
operator|)
argument_list|,
operator|&
operator|(
name|agSSPFrame
operator|->
name|agSgl
operator|.
name|sgLower
operator|)
argument_list|,
literal|8
argument_list|,
name|REPORT_LUN_LEN
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ostiMemoryStatus
operator|!=
name|tiSuccess
operator|)
operator|&&
operator|(
name|respBuffer
operator|==
name|agNULL
operator|)
condition|)
block|{
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
break|break;
block|}
name|osti_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|respBuffer
argument_list|,
literal|0
argument_list|,
name|REPORT_LUN_LEN
argument_list|)
expr_stmt|;
comment|// use FW control place in shared structure to keep the neccesary information
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
operator|=
name|respBuffer
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
operator|=
name|REPORT_LUN_LEN
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param1
operator|=
name|agParam1
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|param2
operator|=
name|agParam2
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|agIOCTLPayload
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|1
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SSP_INIT_READ
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_PENDING
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
operator|(
name|tiDeviceHandle
operator|->
name|tdData
operator|)
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|0
index|]
operator|=
name|REPORT_LUN_OPCODE
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|1
index|]
operator|=
literal|0x0
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|2
index|]
operator|=
literal|0x0
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|3
index|]
operator|=
literal|0x0
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|4
index|]
operator|=
literal|0x0
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|5
index|]
operator|=
literal|0x0
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|6
index|]
operator|=
literal|0x0
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|7
index|]
operator|=
literal|0x0
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|8
index|]
operator|=
literal|0x0
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|9
index|]
operator|=
name|REPORT_LUN_LEN
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|10
index|]
operator|=
literal|0x0
expr_stmt|;
name|agSSPFrame
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|11
index|]
operator|=
literal|0x0
expr_stmt|;
name|agSSPFrame
operator|->
name|dataLength
operator|=
name|REPORT_LUN_LEN
expr_stmt|;
name|agSSPFrame
operator|->
name|agSgl
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
name|agsaSSPCmdInfoUnit_t
argument_list|)
expr_stmt|;
name|status
operator|=
name|saSSPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPIoctlCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|virtAddr
argument_list|,
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|len
argument_list|)
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|payload
operator|=
name|NULL
expr_stmt|;
name|tdsaAllShared
operator|->
name|tdFWControlEx
operator|.
name|inProgress
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|IOCTL_CALL_FAIL
expr_stmt|;
block|}
block|}
do|while
condition|(
literal|0
condition|)
do|;
return|return
name|status
return|;
block|}
end_function

end_unit


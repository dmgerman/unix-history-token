begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  * This file contains initiator discover related functions  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_comment
comment|/***************************************************************************** *! \brief  tiINIDiscoverTargets * *  Purpose:  This function is called to send a transport dependent discovery *            request. An implicit login will be started following the *            completion of discovery. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   portalContext: Pointer to the portal context instance. *  \param   option: This is a bit field option on how the session is to be *                   created *  \return: *           tiSuccess    Discovery initiated. *           tiBusy       Discovery could not be initiated at this time. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINIDiscoverTargets
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPortalContext_t
modifier|*
name|portalContext
parameter_list|,
name|bit32
name|option
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|dmRoot_t
modifier|*
name|dmRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
decl_stmt|;
name|dmPortContext_t
modifier|*
name|dmPortContext
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
comment|/*    this function is called after LINK_UP by ossaHWCB()    Therefore, tdsaportcontext is ready at this point   */
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a right tdsaPortContext using tiPortalContext      then, check the status of tdsaPortContext      then, if status is right, start the discovery   */
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: portalContext %p\n"
operator|,
name|portalContext
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: No tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
comment|/* find a right portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
if|if
condition|(
name|PortContextList
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: PortContextList is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: onePortContext is NULL, PortContextList = %p\n"
operator|,
name|PortContextList
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|tiPortalContext
operator|==
name|portalContext
operator|&&
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: found; oneportContext ID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: No corresponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|ITD_DSTATE_NOT_STARTED
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: calling Discovery\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* start SAS discovery */
ifdef|#
directive|ifdef
name|FDS_DM
if|if
condition|(
name|onePortContext
operator|->
name|UseDM
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: calling dmDiscover, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_STARTED
expr_stmt|;
name|dmPortContext
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|dmPortContext
operator|)
expr_stmt|;
name|dmDiscover
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|DM_DISCOVERY_OPTION_FULL_START
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* complete discovery */
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_COMPLETED
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|portalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|#
directive|else
ifdef|#
directive|ifdef
name|TD_DISCOVER
name|tdsaDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|AG_SA_DISCOVERY_TYPE_SAS
argument_list|,
name|TDSA_DISCOVERY_OPTION_FULL_START
argument_list|)
expr_stmt|;
else|#
directive|else
name|saDiscover
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
operator|->
name|agPortContext
argument_list|,
name|AG_SA_DISCOVERY_TYPE_SAS
argument_list|,
name|onePortContext
operator|->
name|discoveryOptions
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* FDS_DM */
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIDiscoverTargets: Discovery has started or incorrect initialization; state %d pid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|DiscoveryState
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tiINIGetDeviceHandles * *  Purpose: This routine is called to to return the device handles for each *           device currently available. * *  \param  tiRoot:   Pointer to driver Instance. *  \param  tiPortalContext: Pointer to the portal context instance. *  \param  agDev[]:  Array to receive pointers to the device handles. *  \param  maxDevs:  Number of device handles which will fit in array pointed *                    by agDev. *  \return: *    Number of device handle slots present (however, only maxDevs *    are copied into tiDev[]) which may be greater than the number of *    handles actually present. In short, returns the number of devices that *    were found. * *  \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINIGetDeviceHandles
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPortalContext_t
modifier|*
name|tiPortalContext
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDev
index|[]
parameter_list|,
name|bit32
name|maxDevs
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|bit32
name|FoundDevices
init|=
literal|0
decl_stmt|;
name|bit32
name|DeviceIndex
init|=
literal|0
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_DM
name|dmRoot_t
modifier|*
name|dmRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
decl_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: tiPortalContext %p\n"
operator|,
name|tiPortalContext
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxDevs
operator|==
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: maxDevs is 0\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: first, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: No available tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: second, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
comment|/* find a corresponding portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
continue|continue;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|tiPortalContext
operator|==
name|tiPortalContext
operator|&&
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: found; oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: First, No corresponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: third, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: Second, No corressponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: fourth, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: Third, tdsaPortContext is invalid, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: fifth, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|ITD_DSTATE_COMPLETED
operator|&&
name|onePortContext
operator|->
name|DMDiscoveryState
operator|==
name|dmDiscFailed
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: forth, discovery failed, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: sixth, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|!=
name|ITD_DSTATE_COMPLETED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: discovery not completed\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: sixth, returning DISCOVERY_IN_PROGRESS, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|forcedOK
operator|=
name|agTRUE
expr_stmt|;
return|return
name|DISCOVERY_IN_PROGRESS
return|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|tdsaUpdateMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
comment|/*      From the device list, returns only valid devices   */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|DeviceListList
argument_list|,
literal|"DeviceListList NULL"
argument_list|)
expr_stmt|;
if|if
condition|(
name|DeviceListList
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: DeviceListList == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: seventh, returning not found, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
while|while
condition|(
operator|(
name|DeviceIndex
operator|<
name|maxDevs
operator|)
operator|&&
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|pSatDevData
operator|=
operator|(
name|satDeviceData_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: device %p satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: device %p satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: device AddrHi 0x%08x AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: handle %p\n"
operator|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|onePortContext
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: different port\n"
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|SATA_ENABLE
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|&&
operator|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|&&
operator|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: SSP DeviceIndex %d tiDeviceHandle %p\n"
operator|,
name|DeviceIndex
operator|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
operator|)
argument_list|)
expr_stmt|;
name|tiDev
index|[
name|DeviceIndex
index|]
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|FoundDevices
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
operator|&&
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: SATA DeviceIndex %d tiDeviceHandle %p\n"
operator|,
name|DeviceIndex
operator|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
operator|)
argument_list|)
expr_stmt|;
name|tiDev
index|[
name|DeviceIndex
index|]
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|FoundDevices
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: skip case !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: valid %d SSP target %d STP target %d SATA device %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|,
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: oneDeviceData->satDevData.IDDeviceValid %d\n"
operator|,
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: registered %d right port %d \n"
operator|,
name|oneDeviceData
operator|->
name|registered
operator|,
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: oneDeviceData->tdPortContext %p onePortContext %p\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|,
name|onePortContext
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: valid FoundDevices %d\n"
operator|,
name|FoundDevices
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: agDevHandle %p\n"
operator|,
name|oneDeviceData
operator|->
name|agDevHandle
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: valid %d SSP target %d STP target %d SATA device %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|,
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: registered %d right port %d \n"
operator|,
name|oneDeviceData
operator|->
name|registered
operator|,
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: oneDeviceData->tdPortContext %p onePortContext %p\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|,
name|onePortContext
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceIndex
operator|++
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* else */
block|}
if|if
condition|(
name|DeviceIndex
operator|>
name|maxDevs
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: DeviceIndex(%d)>= maxDevs(%d)\n"
operator|,
name|DeviceIndex
operator|,
name|maxDevs
operator|)
argument_list|)
expr_stmt|;
name|FoundDevices
operator|=
name|maxDevs
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: returning %d found devices, pid %d\n"
operator|,
name|FoundDevices
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|FoundDevices
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tiINIGetDeviceHandlesForWinIOCTL * *  Purpose: This routine is called to to return the device handles for each *           device currently available, this routine is only for Win IOCTL to display SAS topology. * *  \param  tiRoot:   Pointer to driver Instance. *  \param  tiPortalContext: Pointer to the portal context instance. *  \param  agDev[]:  Array to receive pointers to the device handles. *  \param  maxDevs:  Number of device handles which will fit in array pointed *                    by agDev. *  \return: *    Number of device handle slots present (however, only maxDevs *    are copied into tiDev[]) which may be greater than the number of *    handles actually present. In short, returns the number of devices that *    were found. * *  \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINIGetDeviceHandlesForWinIOCTL
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPortalContext_t
modifier|*
name|tiPortalContext
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDev
index|[]
parameter_list|,
name|bit32
name|maxDevs
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|bit32
name|FoundDevices
init|=
literal|0
decl_stmt|;
name|bit32
name|DeviceIndex
init|=
literal|0
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FDS_DM
name|dmRoot_t
modifier|*
name|dmRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|dmRoot
operator|)
decl_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: tiPortalContext %p\n"
operator|,
name|tiPortalContext
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxDevs
operator|==
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: maxDevs is 0\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: first, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: No available tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: second, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
comment|/* find a corresponding portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
continue|continue;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|tiPortalContext
operator|==
name|tiPortalContext
operator|&&
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: found; oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: First, No corresponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: third, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: Second, No corressponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: fourth, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: Third, tdsaPortContext is invalid, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: fifth, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|ITD_DSTATE_COMPLETED
operator|&&
name|onePortContext
operator|->
name|DMDiscoveryState
operator|==
name|dmDiscFailed
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: forth, discovery failed, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: sixth, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|!=
name|ITD_DSTATE_COMPLETED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: discovery not completed\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: sixth, returning DISCOVERY_IN_PROGRESS, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|forcedOK
operator|=
name|agTRUE
expr_stmt|;
return|return
name|DISCOVERY_IN_PROGRESS
return|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FDS_DM
name|tdsaUpdateMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* nullify all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxDevs
condition|;
name|i
operator|++
control|)
block|{
name|tiDev
index|[
name|i
index|]
operator|=
name|agNULL
expr_stmt|;
block|}
comment|/*      From the device list, returns only valid devices   */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|DeviceListList
argument_list|,
literal|"DeviceListList NULL"
argument_list|)
expr_stmt|;
if|if
condition|(
name|DeviceListList
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: DeviceListList == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: seventh, returning not found, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
while|while
condition|(
operator|(
name|DeviceIndex
operator|<
name|maxDevs
operator|)
operator|&&
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandles: OneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|pSatDevData
operator|=
operator|(
name|satDeviceData_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: device %p satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: device %p satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: device AddrHi 0x%08x AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: handle %p\n"
operator|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|onePortContext
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: different port\n"
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|SATA_ENABLE
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|&&
operator|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|&&
operator|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: SSP DeviceIndex %d tiDeviceHandle %p\n"
operator|,
name|DeviceIndex
operator|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
operator|)
argument_list|)
expr_stmt|;
name|tiDev
index|[
name|DeviceIndex
index|]
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|DeviceIndex
operator|++
expr_stmt|;
name|FoundDevices
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
operator|&&
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: SATA DeviceIndex %d tiDeviceHandle %p\n"
operator|,
name|DeviceIndex
operator|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
operator|)
argument_list|)
expr_stmt|;
name|tiDev
index|[
name|DeviceIndex
index|]
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|DeviceIndex
operator|++
expr_stmt|;
name|FoundDevices
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: SMP DeviceIndex %d tiDeviceHandle %p\n"
operator|,
name|DeviceIndex
operator|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
operator|)
argument_list|)
expr_stmt|;
name|tiDev
index|[
name|DeviceIndex
index|]
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|DeviceIndex
operator|++
expr_stmt|;
name|FoundDevices
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: skip case !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: valid %d SSP target %d STP target %d SATA device %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|,
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: oneDeviceData->satDevData.IDDeviceValid %d\n"
operator|,
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: registered %d right port %d \n"
operator|,
name|oneDeviceData
operator|->
name|registered
operator|,
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: oneDeviceData->tdPortContext %p onePortContext %p\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|,
name|onePortContext
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: valid FoundDevices %d\n"
operator|,
name|FoundDevices
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: agDevHandle %p\n"
operator|,
name|oneDeviceData
operator|->
name|agDevHandle
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: valid %d SSP target %d STP target %d SATA device %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|,
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: registered %d right port %d \n"
operator|,
name|oneDeviceData
operator|->
name|registered
operator|,
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: oneDeviceData->tdPortContext %p onePortContext %p\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|,
name|onePortContext
operator|)
argument_list|)
expr_stmt|;
block|}
comment|//DeviceIndex++;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* else */
block|}
if|if
condition|(
name|DeviceIndex
operator|>
name|maxDevs
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: DeviceIndex(%d)>= maxDevs(%d)\n"
operator|,
name|DeviceIndex
operator|,
name|maxDevs
operator|)
argument_list|)
expr_stmt|;
name|FoundDevices
operator|=
name|maxDevs
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceHandlesForWinIOCTL: returning %d found devices, pid %d\n"
operator|,
name|FoundDevices
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|FoundDevices
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tiINIGetDeviceInfo * *  Purpose: This routine is called by the OS Layer find out *           the name associated with the device and where *           it is mapped (address1 and address2). * *  \param  tiRoot:          Pointer to driver Instance. *  \param  tiDeviceHandle:  device handle associated with the device *  \param  tiDeviceInfo:    pointer to structure where the information *                           needs to be copied. *  \return: *          tiSuccess - successful *          tiInvalidHandle - device handle passed is not a valid handle. * *  \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINIGetDeviceInfo
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiDeviceInfo_t
modifier|*
name|tiDeviceInfo
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
init|=
name|agNULL
decl_stmt|;
name|bit8
name|id_limit
index|[
literal|5
index|]
decl_stmt|;
name|bit8
name|SN_id_limit
index|[
literal|25
index|]
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetDeviceInfo: start \n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetDeviceInfo: tiDeviceHandle NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiInvalidHandle
return|;
block|}
if|if
condition|(
name|tiDeviceHandle
operator|->
name|tdData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetDeviceInfo: ^^^^^^^^^ tiDeviceHandle->tdData NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiInvalidHandle
return|;
block|}
else|else
block|{
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
operator|(
name|tiDeviceHandle
operator|->
name|tdData
operator|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetDeviceInfo: ^^^^^^^^^ tiDeviceHandle->tdData NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetDeviceInfo: ^^^^^^^^^ oneDeviceData NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiInvalidHandle
return|;
block|}
comment|/* filling in the link rate */
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
name|tiDeviceInfo
operator|->
name|info
operator|.
name|devType_S_Rate
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
expr_stmt|;
block|}
else|else
block|{
name|tiDeviceInfo
operator|->
name|info
operator|.
name|devType_S_Rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
block|}
comment|/* just returning local and remote SAS address; doesn't have a name for SATA device, returns identify device data */
if|if
condition|(
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|osti_memset
argument_list|(
operator|&
name|id_limit
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|id_limit
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|SN_id_limit
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|SN_id_limit
argument_list|)
argument_list|)
expr_stmt|;
comment|/* SATA signature 0xABCD */
name|id_limit
index|[
literal|0
index|]
operator|=
literal|0xA
expr_stmt|;
name|id_limit
index|[
literal|1
index|]
operator|=
literal|0xB
expr_stmt|;
name|id_limit
index|[
literal|2
index|]
operator|=
literal|0xC
expr_stmt|;
name|id_limit
index|[
literal|3
index|]
operator|=
literal|0xD
expr_stmt|;
name|pSatDevData
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
name|id_limit
index|[
literal|4
index|]
operator|=
operator|(
name|bit8
operator|)
name|pSatDevData
operator|->
name|satNCQMaxIO
expr_stmt|;
block|}
else|else
block|{
comment|/* no NCQ */
name|id_limit
index|[
literal|4
index|]
operator|=
literal|1
expr_stmt|;
block|}
name|osti_memcpy
argument_list|(
operator|&
name|SN_id_limit
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|.
name|serialNumber
operator|)
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|SN_id_limit
index|[
literal|20
index|]
operator|)
argument_list|,
operator|&
name|id_limit
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|SN_id_limit
argument_list|,
name|SN_id_limit
argument_list|,
literal|25
argument_list|)
expr_stmt|;
comment|/* serialNumber, 20 bytes + ABCD + NCQ LENGTH ; modelNumber, 40 bytes */
comment|//  tiDeviceInfo->remoteName    = (char *)&(oneDeviceData->satDevData.satIdentifyData.serialNumber);
name|tiDeviceInfo
operator|->
name|remoteName
operator|=
operator|(
name|char
operator|*
operator|)
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|SN_id_limit
expr_stmt|;
name|tiDeviceInfo
operator|->
name|remoteAddress
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|.
name|modelNumber
operator|)
expr_stmt|;
comment|//    TI_DBG1(("tiINIGetDeviceInfo: SATA device remote hi 0x%08x lo 0x%08x\n", oneDeviceData->tdPortContext->sasRemoteAddressHi, oneDeviceData->tdPortContext->sasRemoteAddressLo));
comment|//    tdhexdump("tiINIGetDeviceInfo remotename", (bit8 *)&(oneDeviceData->satDevData.satIdentifyData.serialNumber), 20);
comment|//    tdhexdump("tiINIGetDeviceInfo new name", (bit8 *)&(SN_id_limit), sizeof(SN_id_limit));
comment|//    tdhexdump("tiINIGetDeviceInfo remoteaddress", (bit8 *)&(oneDeviceData->satDevData.satIdentifyData.modelNumber),40);
name|tiDeviceInfo
operator|->
name|osAddress1
operator|=
literal|25
expr_stmt|;
name|tiDeviceInfo
operator|->
name|osAddress2
operator|=
literal|40
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
comment|/* serialNumber, 20 bytes; modelNumber, 40 bytes */
name|tiDeviceInfo
operator|->
name|remoteName
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|.
name|serialNumber
operator|)
expr_stmt|;
name|tiDeviceInfo
operator|->
name|remoteAddress
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|.
name|modelNumber
operator|)
expr_stmt|;
comment|//    TI_DBG1(("tiINIGetDeviceInfo: SATA device remote hi 0x%08x lo 0x%08x\n", oneDeviceData->tdPortContext->sasRemoteAddressHi, oneDeviceData->tdPortContext->sasRemoteAddressLo));
comment|//    tdhexdump("tiINIGetDeviceInfo remotename", (bit8 *)&(oneDeviceData->satDevData.satIdentifyData.serialNumber), 20);
comment|//    tdhexdump("tiINIGetDeviceInfo remoteaddress", (bit8 *)&(oneDeviceData->satDevData.satIdentifyData.modelNumber),40);
name|tiDeviceInfo
operator|->
name|osAddress1
operator|=
literal|20
expr_stmt|;
name|tiDeviceInfo
operator|->
name|osAddress2
operator|=
literal|40
expr_stmt|;
block|}
else|else
block|{
name|tiDeviceInfo
operator|->
name|remoteName
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
expr_stmt|;
name|tiDeviceInfo
operator|->
name|remoteAddress
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceInfo: SAS device remote hi 0x%08x lo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|sasRemoteAddressHi
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|sasRemoteAddressLo
operator|)
argument_list|)
expr_stmt|;
name|tiDeviceInfo
operator|->
name|osAddress1
operator|=
literal|4
expr_stmt|;
name|tiDeviceInfo
operator|->
name|osAddress2
operator|=
literal|4
expr_stmt|;
block|}
name|tiDeviceInfo
operator|->
name|localName
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|sasLocalAddressHi
operator|)
expr_stmt|;
name|tiDeviceInfo
operator|->
name|localAddress
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|sasLocalAddressLo
operator|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetDeviceInfo: local hi 0x%08x lo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|sasLocalAddressHi
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|sasLocalAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetDeviceInfo: Error! oneDeviceData->agDevHandle is NULL"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
else|else
block|{
name|saGetDeviceInfo
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tiINILogin * *  Purpose: This function is called to request that the Transport Dependent *           Layer initiates login for a specific target. * *  \param tiRoot:          Pointer to driver Instance. *  \param tiDeviceHandle:  Pointer to a target device handle discovered *                          following the discovery. * *  \return: *        tiSuccess       Login initiated. *        tiError         Login failed. *        tiBusy          Login can not be initiated at this time. *        tiNotSupported  This API is currently not supported by this *                        Transport Layer * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINILogin
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINILogin: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiNotSupported
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tiINILogout * *  Purpose: This function is called to request that the Transport Dependent *           Layer initiates logout for a specific target from the previously *           successful login through tiINILogin() call. * *  \param   tiRoot      :  Pointer to the OS Specific module allocated tiRoot_t *                          instance. *  \param tiDeviceHandle:  Pointer to a target device handle. * *  \return: *         tiSuccess       Logout initiated. *         tiError         Logout failed. *         tiBusy          Logout can not be initiated at this time. *         tiNotSupported  This API is currently not supported by this *                         Transport Layer * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINILogout
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINILogout: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiNotSupported
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tiINIGetExpander * * *  \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tiINIGetExpander
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPortalContext_t
modifier|*
name|tiPortalContext
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDev
parameter_list|,
name|tiDeviceHandle_t
modifier|*
modifier|*
name|tiExp
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneTargetDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneExpanderDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|oneTargetDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDev
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneTargetDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpander: oneTargetDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpander: No available tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpander: second, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
comment|/* find a corresponding portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetExpander: oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|tiPortalContext
operator|==
name|tiPortalContext
operator|&&
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetExpander: found; oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpander: First, No corresponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpander: third, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpander: Second, No corressponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpander: fourth, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpander: Third, tdsaPortContext is invalid, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpander: fifth, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|onePortContext
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetExpander: different port\n"
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|==
name|oneTargetDeviceData
condition|)
block|{
name|oneExpanderDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
if|if
condition|(
name|oneExpanderDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpander: oneExpanderDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
operator|*
name|tiExp
operator|=
operator|&
operator|(
name|oneExpanderDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
return|return
name|tiError
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tiIniGetDirectSataSasAddr
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|phyId
parameter_list|,
name|bit8
modifier|*
modifier|*
name|sasAddressHi
parameter_list|,
name|bit8
modifier|*
modifier|*
name|sasAddressLo
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
name|tdsaAllShared
operator|->
name|agRootInt
decl_stmt|;
name|tiIOCTLPayload_wwn_t
name|agIoctlPayload
decl_stmt|;
name|bit8
name|nvmDev
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|int
name|i
decl_stmt|;
name|agIoctlPayload
operator|.
name|Length
operator|=
literal|4096
expr_stmt|;
name|agIoctlPayload
operator|.
name|Reserved
operator|=
literal|0
expr_stmt|;
name|agIoctlPayload
operator|.
name|MinorFunction
operator|=
name|IOCTL_MN_NVMD_GET_CONFIG
expr_stmt|;
name|agIoctlPayload
operator|.
name|MajorFunction
operator|=
name|IOCTL_MJ_NVMD_GET
expr_stmt|;
name|tiCOMDelayedInterruptHandler
argument_list|(
name|tiRoot
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|tiNonInterruptContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|nvmDev
operator|=
literal|4
expr_stmt|;
name|status
operator|=
name|tdsaNVMDGetIoctl
argument_list|(
name|tiRoot
argument_list|,
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|&
name|agIoctlPayload
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
operator|&
name|nvmDev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nvmDev
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|tdsaNVMDGetIoctl
argument_list|(
name|tiRoot
argument_list|,
operator|(
name|tiIOCTLPayload_t
operator|*
operator|)
operator|&
name|agIoctlPayload
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
operator|&
name|nvmDev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|IOCTL_CALL_FAIL
condition|)
block|{
if|#
directive|if
operator|!
operator|(
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|)
name|printk
argument_list|(
literal|"Error getting Adapter WWN\n"
argument_list|)
expr_stmt|;
else|#
directive|else
name|printf
argument_list|(
literal|"Error getting Adapter WWN\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
operator|*
operator|(
name|bit32
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
operator|)
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
operator|&
name|agIoctlPayload
operator|.
name|FunctionSpecificArea
index|[
literal|0
index|]
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
operator|)
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
operator|&
name|agIoctlPayload
operator|.
name|FunctionSpecificArea
index|[
literal|4
index|]
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"SAS AddressHi is 0x%x\n"
operator|,
operator|*
operator|(
name|bit32
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
operator|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"SAS AddressLo is 0x%x\n"
operator|,
operator|*
operator|(
name|bit32
operator|*
operator|)
operator|(
name|tdsaAllShared
operator|->
name|Ports
index|[
name|i
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|sasAddressHi
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|phyId
index|]
operator|.
name|SASID
operator|.
name|sasAddressHi
expr_stmt|;
operator|*
name|sasAddressLo
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|phyId
index|]
operator|.
name|SASID
operator|.
name|sasAddressLo
expr_stmt|;
block|}
end_function

begin_function
name|osGLOBAL
name|tiDeviceHandle_t
modifier|*
name|tiINIGetExpDeviceHandleBySasAddress
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiPortalContext_t
modifier|*
name|tiPortalContext
parameter_list|,
name|bit32
name|sas_addr_hi
parameter_list|,
name|bit32
name|sas_addr_lo
parameter_list|,
name|bit32
name|maxDevs
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
comment|//bit32             i;
comment|//bit32             FoundDevices = 0;
name|bit32
name|DeviceIndex
init|=
literal|0
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: tiPortalContext %p\n"
operator|,
name|tiPortalContext
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxDevs
operator|==
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: maxDevs is 0\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: No available tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: second, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
comment|/* find a corresponding portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
if|if
condition|(
name|PortContextList
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: PortContextList is NULL!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: onePortContext is NULL!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|tiPortalContext
operator|==
name|tiPortalContext
operator|&&
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: found; oneportContext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|PortContextList
operator|!=
name|agNULL
condition|)
block|{
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: First, No corresponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: third, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
return|return
name|agNULL
return|;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: Second, No corressponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: fourth, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* nullify all device handles */
return|return
name|agNULL
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: Third, tdsaPortContext is invalid, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: fifth, returning 0\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* to do: check maxdev and length of Mainlink */
comment|/*       From the device list, returns only valid devices   */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
if|if
condition|(
name|DeviceListList
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: DeviceListList == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: seventh, returning not found, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
while|while
condition|(
operator|(
name|DeviceIndex
operator|<
name|maxDevs
operator|)
operator|&&
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: oneDeviceData is NULL!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: handle %p\n"
operator|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|onePortContext
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: different port\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DeviceListList
operator|!=
name|agNULL
condition|)
block|{
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|&&
operator|(
operator|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
operator|||
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|sas_addr_lo
operator|&&
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|sas_addr_hi
condition|)
block|{
comment|//TI_DBG3(("tiINIGetExpDeviceHandleBySasAddress: valid FoundDevices %d\n", FoundDevices));
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: agDevHandle %p\n"
operator|,
name|oneDeviceData
operator|->
name|agDevHandle
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tiINIGetExpDeviceHandleBySasAddress: Matched sas address:  low %x and high %x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
return|return
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
return|;
block|}
block|}
name|DeviceIndex
operator|++
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* else */
block|}
return|return
name|agNULL
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|TD_DISCOVER
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDiscover * *  Purpose:  This function is called to trigger topology discovery within a *            portcontext. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   type: Type of discovery. It can be SAS or SATA. *  \param   option: discovery option. It can be Full or Incremental discovery. * *  \return: *           tiSuccess    Discovery initiated. *           tiError      Discovery could not be initiated at this time. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaDiscover
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|type
parameter_list|,
name|bit32
name|option
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|tiError
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscover: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscover: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
switch|switch
condition|(
name|option
condition|)
block|{
case|case
name|TDSA_DISCOVERY_OPTION_FULL_START
case|:
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscover: full\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|=
name|TDSA_DISCOVERY_OPTION_FULL_START
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|TDSA_DISCOVERY_TYPE_SAS
condition|)
block|{
name|ret
operator|=
name|tdsaSASFullDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SATA_ENABLE
elseif|else
if|if
condition|(
name|type
operator|==
name|TDSA_DISCOVERY_TYPE_SATA
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_SAS_DONE
condition|)
block|{
name|ret
operator|=
name|tdsaSATAFullDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
break|break;
case|case
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
case|:
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscover: incremental\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|=
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|TDSA_DISCOVERY_TYPE_SAS
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscover: incremental SAS\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|tdsaSASIncrementalDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SATA_ENABLE
elseif|else
if|if
condition|(
name|type
operator|==
name|TDSA_DISCOVERY_TYPE_SATA
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_SAS_DONE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscover: incremental SATA\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|tdsaSATAIncrementalDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
break|break;
case|case
name|TDSA_DISCOVERY_OPTION_ABORT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscover: abort\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|ret
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscover: fail, error 0x%x\n"
operator|,
name|ret
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASFullDiscover * *  Purpose:  This function is called to trigger full SAS topology discovery *            within a portcontext. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. * *  \return: *           tiSuccess    Discovery initiated. *           tiError      Discovery could not be initiated at this time. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaSASFullDiscover
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bit8
name|portMaxRate
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASFullDiscover: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASFullDiscover: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/*     1. abort all IO; may need a new LL API since TD does not queue IO's     2. initializes(or invalidate) devices belonging to the port     3. onePortContext->DiscoveryState == ITD_DSTATE_STARTED     4. add directly connected one; if directed-SAS, spin-up     5. tdsaSASUpStreamDiscoverStart(agRoot, pPort, pDevice)   */
comment|/*     invalidate all devices belonging to the portcontext except direct attached SAS/SATA   */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASFullDiscover: STARTED loop id %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASFullDiscover: STARTED loop sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASFullDiscover: STARTED loop sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|&&
operator|(
name|onePortContext
operator|->
name|nativeSATAMode
operator|==
name|agFALSE
operator|&&
name|onePortContext
operator|->
name|directAttatchedSAS
operator|==
name|agFALSE
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASFullDiscover: invalidate\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|processed
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASFullDiscover: not invalidate\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* no changes */
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_STARTED
expr_stmt|;
comment|/* nativeSATAMode is set in ossaHwCB() in link up */
if|if
condition|(
name|onePortContext
operator|->
name|nativeSATAMode
operator|==
name|agFALSE
condition|)
comment|/* default: SAS and SAS/SATA mode */
block|{
if|if
condition|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
argument_list|)
operator|==
name|SAS_END_DEVICE
operator|&&
name|SA_IDFRM_IS_SSP_TARGET
argument_list|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|TD_MAX_NUM_NOTIFY_SPINUP
condition|;
name|j
operator|++
control|)
block|{
name|saLocalPhyControl
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|)
argument_list|,
name|i
argument_list|,
name|AGSA_PHY_NOTIFY_ENABLE_SPINUP
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
block|}
comment|/*       add the device       1. add device in TD layer       2. call saRegisterNewDevice       3. update agDevHandle in ossaDeviceRegistrationCB()     */
name|portMaxRate
operator|=
name|onePortContext
operator|->
name|LinkRate
expr_stmt|;
name|oneDeviceData
operator|=
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|onePortContext
operator|->
name|sasIDframe
argument_list|,
name|agFALSE
argument_list|,
name|portMaxRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|agNULL
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
comment|/*           set the timer and wait till the device(directly attached. eg Expander) to be registered.          Then, in tdsaDeviceRegistrationTimerCB(), tdsaSASUpStreamDiscoverStart() is called         */
name|tdsaDeviceRegistrationTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSASUpStreamDiscoverStart
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|REMOVED
comment|// temp testing code
name|tdsaReportManInfoSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|//end temp testing code
endif|#
directive|endif
block|}
else|else
comment|/* SATAOnlyMode*/
block|{
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiSuccess
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASUpStreamDiscoverStart * *  Purpose:  This function is called to trigger upstream traverse in topology *            within a portcontext. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASUpStreamDiscoverStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverStart: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverStart: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     1. update discovery state to UP_STREAM     2. if (expander) add it     3. tdsaSASUpStreamDiscovering    */
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_UP_STREAM
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
condition|)
block|{
name|oneExpander
operator|=
name|tdssSASDiscoveringExpanderAlloc
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
comment|/* (2.2.1) Add to discovering list */
name|tdssSASDiscoveringExpanderAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverStart: failed to allocate expander or discovey aborted\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|tdsaSASUpStreamDiscovering
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASUpStreamDiscovering * *  Purpose:  For each expander in the expander list, this function sends SMP to *            find information for discovery and calls *            tdsaSASDownStreamDiscoverStart() function. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASUpStreamDiscovering
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|oneNextExpander
init|=
name|agNULL
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscovering: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscovering: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     1. find the next expander     2. if (there is next expander) send report general with saSMPStart        else tdsaSASDownStreamDiscoverStart    */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscovering: should be the end\n"
operator|)
argument_list|)
expr_stmt|;
name|oneNextExpander
operator|=
name|agNULL
expr_stmt|;
block|}
else|else
block|{
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|ExpanderList
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
name|oneNextExpander
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_HEAD
argument_list|(
operator|&
operator|(
name|oneNextExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaSASUpStreamDiscovering: dequeue head\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscovering: expander id %d\n"
operator|,
name|oneNextExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneNextExpander
operator|!=
name|agNULL
condition|)
block|{
name|tdsaReportGeneralSend
argument_list|(
name|tiRoot
argument_list|,
name|oneNextExpander
operator|->
name|tdDevice
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscovering: No more expander list\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDownStreamDiscoverStart
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASDownStreamDiscoverStart * *  Purpose:  This function is called to trigger downstream traverse in topology *            within a portcontext. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASDownStreamDiscoverStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|UpStreamExpander
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverStart: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverStart: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     1. update discover state     2. if (expander is root) add it        else just add it     3. tdsaSASDownStreamDiscovering    */
comment|/* set discovery status */
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_DOWN_STREAM
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverStart: pPort=%p pDevice=%p\n"
operator|,
name|onePortContext
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
comment|/* If it's an expander */
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
condition|)
block|{
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|tdExpander
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|tdUpStreamExpander
expr_stmt|;
comment|/* If the two expanders are the root of two edge sets; sub-to-sub */
if|if
condition|(
operator|(
name|UpStreamExpander
operator|!=
name|agNULL
operator|)
operator|&&
operator|(
name|UpStreamExpander
operator|->
name|tdUpStreamExpander
operator|==
name|oneExpander
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverStart: Root found pExpander=%p pUpStreamExpander=%p\n"
operator|,
name|oneExpander
operator|,
name|UpStreamExpander
operator|)
argument_list|)
expr_stmt|;
comment|//Saves the root expander
name|onePortContext
operator|->
name|discovery
operator|.
name|RootExp
operator|=
name|oneExpander
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverStart: Root exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverStart: Root exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* reset up stream inform for pExpander */
name|oneExpander
operator|->
name|tdUpStreamExpander
operator|=
name|agNULL
expr_stmt|;
comment|/* Add the pExpander to discovering list */
name|tdssSASDiscoveringExpanderAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* reset up stream inform for oneExpander */
name|UpStreamExpander
operator|->
name|tdUpStreamExpander
operator|=
name|agNULL
expr_stmt|;
comment|/* Add the UpStreamExpander to discovering list */
name|tdssSASDiscoveringExpanderAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|UpStreamExpander
argument_list|)
expr_stmt|;
block|}
comment|/* If the two expanders are not the root of two edge sets. eg) one root */
else|else
block|{
comment|//Saves the root expander
name|onePortContext
operator|->
name|discovery
operator|.
name|RootExp
operator|=
name|oneExpander
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverStart: NO Root pExpander=%p\n"
operator|,
name|oneExpander
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverStart: Root exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverStart: Root exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* (2.2.2.1) Add the pExpander to discovering list */
name|tdssSASDiscoveringExpanderAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Continue down stream discovering */
name|tdsaSASDownStreamDiscovering
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASDownStreamDiscovering * *  Purpose:  For each expander in the expander list, this function sends SMP to *            find information for discovery and calls *            tdsaSASDownStreamDiscoverStart() function. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASDownStreamDiscovering
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaExpander_t
modifier|*
name|NextExpander
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: pPort=%p  pDevice=%p\n"
operator|,
name|onePortContext
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: should be the end\n"
operator|)
argument_list|)
expr_stmt|;
name|NextExpander
operator|=
name|agNULL
expr_stmt|;
block|}
else|else
block|{
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|ExpanderList
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
empty_stmt|;
name|NextExpander
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_HEAD
argument_list|(
operator|&
operator|(
name|NextExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
empty_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaSASDownStreamDiscovering: dequeue head\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: expander id %d\n"
operator|,
name|NextExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* If there is an expander for continue discoving */
if|if
condition|(
name|NextExpander
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: Found pNextExpander=%p\n, discoveryStatus=0x%x"
operator|,
name|NextExpander
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
condition|)
block|{
comment|/* If the discovery status is DISCOVERY_DOWN_STREAM */
case|case
name|DISCOVERY_DOWN_STREAM
case|:
comment|/* Send report general for the next expander */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: DownStream pNextExpander->pDevice=%p\n"
operator|,
name|NextExpander
operator|->
name|tdDevice
operator|)
argument_list|)
expr_stmt|;
name|tdsaReportGeneralSend
argument_list|(
name|tiRoot
argument_list|,
name|NextExpander
operator|->
name|tdDevice
argument_list|)
expr_stmt|;
break|break;
comment|/* If the discovery status is DISCOVERY_CONFIG_ROUTING */
case|case
name|DISCOVERY_CONFIG_ROUTING
case|:
case|case
name|DISCOVERY_REPORT_PHY_SATA
case|:
comment|/* set discovery status */
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_DOWN_STREAM
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: pPort->discovery.status=DISCOVERY_CONFIG_ROUTING, nake it DOWN_STREAM\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* If not the last phy */
if|if
condition|(
name|NextExpander
operator|->
name|discoveringPhyId
operator|<
name|NextExpander
operator|->
name|tdDevice
operator|->
name|numOfPhys
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: pNextExpander->discoveringPhyId=0x%x pNextExpander->pDevice->numOfPhys=0x%x.  Send More Discover\n"
operator|,
name|NextExpander
operator|->
name|discoveringPhyId
operator|,
name|NextExpander
operator|->
name|tdDevice
operator|->
name|numOfPhys
operator|)
argument_list|)
expr_stmt|;
comment|/* Send discover for the next expander */
name|tdsaDiscoverSend
argument_list|(
name|tiRoot
argument_list|,
name|NextExpander
operator|->
name|tdDevice
argument_list|)
expr_stmt|;
block|}
comment|/* If it's the last phy */
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: Last Phy, remove expander%p  start DownStream=%p\n"
operator|,
name|NextExpander
operator|,
name|NextExpander
operator|->
name|tdDevice
operator|)
argument_list|)
expr_stmt|;
name|tdssSASDiscoveringExpanderRemove
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|NextExpander
argument_list|)
expr_stmt|;
name|tdsaSASDownStreamDiscovering
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|NextExpander
operator|->
name|tdDevice
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: *** Unknown pPort->discovery.status=0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If no expander for continue discoving */
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscovering: No more expander DONE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* discover done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiSuccess
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaCleanAllExp * *  Purpose:  This function cleans up expander data structures after discovery *            is complete. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaCleanAllExp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|tmpOnePortContext
init|=
name|onePortContext
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaCleanAllExp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaCleanAllExp: before all clean up\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllFreeExp
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
comment|/* clean up UpdiscoveringExpanderList*/
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaCleanAllExp: clean discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaCleanAllExp: exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaCleanAllExp: exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* putting back to the free pool */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|tempExpander
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|tempExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|freeExpanderList
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
comment|//      ExpanderList = ExpanderList->flink;
block|}
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaCleanAllExp: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* reset UpdiscoveringExpanderList */
name|TDLIST_INIT_HDR
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|UpdiscoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaCleanAllExp: after all clean up\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllFreeExp
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaFreeAllExp * *  Purpose:  This function frees up expander data structures as a part of *            soft reset. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaFreeAllExp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|tmpOnePortContext
init|=
name|onePortContext
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaFreeAllExp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaFreeAllExp: before all clean up\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllFreeExp
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
comment|/* clean up UpdiscoveringExpanderList*/
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaFreeAllExp: clean discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaFreeAllExp: exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaFreeAllExp: exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* putting back to the free pool */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|tempExpander
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|tempExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|freeExpanderList
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
comment|//      ExpanderList = ExpanderList->flink;
block|}
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssSASDiscoveringExpander tdsaFreeAllExp: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* reset UpdiscoveringExpanderList */
name|TDLIST_INIT_HDR
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|UpdiscoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaResetValidDeviceData * *  Purpose:  This function resets valid and valid2 field for discovered devices *            in the device list. This is used only in incremental discovery. * *  \param   agRoot        :  Pointer to chip/driver Instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaResetValidDeviceData
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaResetValidDeviceData: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaResetValidDeviceData: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|oneDeviceData
operator|->
name|valid2
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaResetValidDeviceData: valid %d valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdssReportChanges * *  Purpose:  This function goes throuhg device list and finds out whether *            a device is removed and newly added. Based on the findings, *            this function notifies OS layer of the change. * *  \param   agRoot        :  Pointer to chip/driver Instance. *  \param   onePortContext: Pointer to the portal context instance. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssReportChanges
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|added
init|=
name|agFALSE
decl_stmt|,
name|removed
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportChanges: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportChanges: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssReportChanges: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssReportChanges: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssReportChanges: right portcontext\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssReportChanges: same\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* reset valid bit */
name|oneDeviceData
operator|->
name|valid
operator|=
name|oneDeviceData
operator|->
name|valid2
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agFALSE
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssReportChanges: removed\n"
operator|)
argument_list|)
expr_stmt|;
name|removed
operator|=
name|agTRUE
expr_stmt|;
comment|/* reset valid bit */
name|oneDeviceData
operator|->
name|valid
operator|=
name|oneDeviceData
operator|->
name|valid2
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
comment|/* reset NumOfFCA */
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|NumOfFCA
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
condition|)
block|{
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportChanges: calling saDeregisterDeviceHandle, did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
comment|/* don't remove device from the device list. May screw up ordering of report */
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssReportChanges: added\n"
operator|)
argument_list|)
expr_stmt|;
name|added
operator|=
name|agTRUE
expr_stmt|;
comment|/* reset valid bit */
name|oneDeviceData
operator|->
name|valid
operator|=
name|oneDeviceData
operator|->
name|valid2
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdssReportChanges: else\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportChanges: different portcontext\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* arrival or removal at once */
if|if
condition|(
name|added
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssReportChanges: added at the end\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AGTIAPI_CTL
if|if
condition|(
name|tdsaAllShared
operator|->
name|SASConnectTimeLimit
condition|)
name|tdsaCTLSet
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|removed
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssReportChanges: removed at the end\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceRemoval
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|forcedOK
operator|==
name|agTRUE
operator|&&
name|added
operator|==
name|agFALSE
operator|&&
name|removed
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportChanges: missed chance to report. forced to report OK\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|forcedOK
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|added
operator|==
name|agFALSE
operator|&&
name|removed
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssReportChanges: the same\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdssReportRemovals * *  Purpose:  This function goes through device list and removes all devices *            belong to the portcontext. This function also deregiters those *            devices. This function is called in case of incremental discovery *            failure. * *  \param   agRoot        :  Pointer to chip/driver Instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssReportRemovals
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|removed
init|=
name|agFALSE
decl_stmt|;
name|agsaEventSource_t
modifier|*
name|eventSource
decl_stmt|;
name|bit32
name|PhyID
decl_stmt|;
name|bit32
name|HwAckSatus
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* in case nothing was registered */
name|PhyID
operator|=
name|onePortContext
operator|->
name|eventPhyID
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|==
name|agTRUE
operator|&&
name|onePortContext
operator|->
name|RegisteredDevNums
operator|==
literal|0
operator|&&
name|PhyID
operator|!=
literal|0xFF
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: calling saHwEventAck\n"
operator|)
argument_list|)
expr_stmt|;
name|eventSource
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|Source
operator|)
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
name|eventSource
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportRemovals: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* toggle */
name|tdsaAllShared
operator|->
name|eventSource
index|[
name|PhyID
index|]
operator|.
name|EventValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
comment|/* put device belonging to the port to freedevice list */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
condition|)
block|{
name|osti_memset
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
block|}
else|else
block|{
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
comment|/* while */
name|tdsaPortContextReInit
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
comment|/*         put all devices belonging to the onePortContext         back to the free link        */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreePortContextList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportRemovals: 1st empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
comment|/* needs to clean up devices which were not removed in ossaDeregisterDeviceHandleCB() since port was in valid (discovery error) */
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportRemovals: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: 1st loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: valid %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: directlyAttached %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: registered %d\n"
operator|,
name|oneDeviceData
operator|->
name|registered
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|&&
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
comment|/* remove oneDevice from MainLink */
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: delete from MainLink\n"
operator|)
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|tdsaDeviceDataReInit
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|//save agDevHandle and tdPortContext
name|oneDeviceData
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
comment|/* while */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportRemovals: 2nd empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportRemovals: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: valid %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: directlyAttached %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: registered %d\n"
operator|,
name|oneDeviceData
operator|->
name|registered
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: right portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: removing\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* notify only reported devices to OS layer*/
if|if
condition|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|removed
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
condition|)
block|{
comment|/* all targets except expanders */
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: calling tdsaAbortAll\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
comment|/* expanders */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportRemovals: calling saDeregisterDeviceHandle, did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* reset valid bit */
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
comment|/* reset NumOfFCA */
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|NumOfFCA
operator|=
literal|0
expr_stmt|;
block|}
comment|/* called by port invalid case */
if|if
condition|(
name|flag
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|agNULL
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportRemovals: nulling-out tdPortContext; oneDeviceData did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
comment|/* removed */
comment|/* directly attached SATA -> always remove it */
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
operator|&&
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportRemovals: device did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceLis
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
break|break;
block|}
block|}
else|else
block|{
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* REMOVED */
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: different portcontext; oneDeviceData->tdPortContext pid %d oneportcontext pid %d oneDeviceData did %d\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssReportRemovals: different portcontext; oneDeviceData->tdPortContext pid NULL oneportcontext pid %d oneDeviceData did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
if|if
condition|(
name|removed
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssReportRemovals: removed at the end\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceRemoval
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* big else */
return|return;
block|}
end_function

begin_comment
comment|/*   changes valid and valid2 based on discovery type */
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssInternalRemovals
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssInternalRemovals: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssInternalRemovals: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: valid %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: directlyAttached %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: registered %d\n"
operator|,
name|oneDeviceData
operator|->
name|registered
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: right portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: full discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: different portcontext; oneDeviceData->tdPortContext pid %d oneportcontext pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdssInternalRemovals: different portcontext; oneDeviceData->tdPortContext pid NULL oneportcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/* resets all valid and valid2 */
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssDiscoveryErrorRemovals
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: valid %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: directlyAttached %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: registered %d\n"
operator|,
name|oneDeviceData
operator|->
name|registered
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: right portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
comment|/* reset NumOfFCA */
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|NumOfFCA
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
condition|)
block|{
comment|/* all targets other than expanders */
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: calling tdsaAbortAll\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
comment|/* expanders */
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: calling saDeregisterDeviceHandle\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: different portcontext; oneDeviceData->tdPortContext pid %d oneportcontext pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdssDiscoveryErrorRemovals: different portcontext; oneDeviceData->tdPortContext pid NULL oneportcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASDiscoverAbort * *  Purpose:  This function aborts on-going discovery. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_comment
comment|/* this called when discovery is aborted    aborted by whom */
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASDiscoverAbort
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaSASDiscoverAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaSASDiscoverAbort: pPort=%p  DONE\n"
operator|,
name|onePortContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaSASDiscoverAbort: DiscoveryState %d\n"
operator|,
name|onePortContext
operator|->
name|DiscoveryState
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_COMPLETED
expr_stmt|;
comment|/* clean up expanders data strucures; move to free exp when device is cleaned */
name|tdsaCleanAllExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
comment|/* unregister devices */
name|tdssReportRemovals
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|AGTIAPI_CTL
end_ifdef

begin_function_decl
name|STATIC
name|void
name|tdsaCTLNextDevice
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdIORequest_t
modifier|*
name|tdIORequest
parameter_list|,
name|tdList_t
modifier|*
name|DeviceList
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|STATIC
name|void
name|tdsaCTLIOCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit16
name|sspTag
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
operator|(
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
operator|)
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequest_t
modifier|*
name|tdIORequest
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tdIORequest
operator|=
operator|(
name|tdIORequest_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|tdIORequestBody
operator|=
operator|&
name|tdIORequest
operator|->
name|tdIORequestBody
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaCTLIOCompleted: stat x%x len %d id %d\n"
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|//if ((agIOStatus == OSSA_IO_SUCCESS)&& (agIOInfoLen == 0))
comment|/* SCSI command was completed OK, this is the normal path. */
if|if
condition|(
name|agIOInfoLen
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaCTLIOCompleted: SASDevAddr 0x%x / 0x%x PhyId 0x%x WARN "
literal|"setting CTL\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"tdsaCTLIOCompleted: response"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|agParam
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
block|}
name|tdsaCTLNextDevice
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
operator|->
name|tdPortContext
argument_list|,
name|tdIORequest
argument_list|,
name|oneDeviceData
operator|->
name|MainLink
operator|.
name|flink
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* tdsaCTLIOCompleted */
end_comment

begin_function
name|STATIC
name|int
name|tdsaCTLModeSelect
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tdIORequest_t
modifier|*
name|tdIORequest
parameter_list|)
block|{
name|tiIORequest_t
modifier|*
name|tiIORequest
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|tiStatus
decl_stmt|;
name|bit32
name|saStatus
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaSSPInitiatorRequest_t
modifier|*
name|agSSPInitiatorRequest
decl_stmt|;
name|unsigned
name|char
modifier|*
name|virtAddr
decl_stmt|;
name|tiSgl_t
name|agSgl
decl_stmt|;
specifier|static
name|unsigned
name|char
name|cdb
index|[
literal|6
index|]
init|=
block|{
name|MODE_SELECT
block|,
name|PAGE_FORMAT
block|,
literal|0
block|,
literal|0
block|,
name|DR_MODE_PG_SZ
block|}
decl_stmt|;
name|virtAddr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|tdIORequest
operator|->
name|virtAddr
expr_stmt|;
name|virtAddr
index|[
literal|0
index|]
operator|=
name|DR_MODE_PG_CODE
expr_stmt|;
comment|/* Disconnect-Reconnect mode page code */
name|virtAddr
index|[
literal|1
index|]
operator|=
name|DR_MODE_PG_LENGTH
expr_stmt|;
comment|/* DR Mode pg length */
name|virtAddr
index|[
literal|8
index|]
operator|=
name|tdsaAllShared
operator|->
name|SASConnectTimeLimit
operator|>>
literal|8
expr_stmt|;
name|virtAddr
index|[
literal|9
index|]
operator|=
name|tdsaAllShared
operator|->
name|SASConnectTimeLimit
operator|&
literal|0xff
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaCTLModeSelect: id %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|tiIORequest
operator|=
operator|&
name|tdIORequest
operator|->
name|tiIORequest
expr_stmt|;
name|tdIORequestBody
operator|=
operator|&
name|tdIORequest
operator|->
name|tdIORequestBody
expr_stmt|;
comment|//tdIORequestBody->IOCompletionFunc = tdsaCTLIOCompleted;//itdssIOCompleted;
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
name|DR_MODE_PG_SZ
expr_stmt|;
name|agIORequest
operator|=
operator|&
name|tdIORequestBody
operator|->
name|agIORequest
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPInitiatorRequest
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspInitiatorReq
operator|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
argument_list|,
name|cdb
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|agSSPInitiatorRequest
operator|->
name|dataLength
operator|=
name|DR_MODE_PG_SZ
expr_stmt|;
name|agSSPInitiatorRequest
operator|->
name|firstBurstSize
operator|=
literal|0
expr_stmt|;
name|tdIORequestBody
operator|->
name|agRequestType
operator|=
name|AGSA_SSP_INIT_WRITE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|agSgl
operator|.
name|lower
operator|=
name|BIT32_TO_LEBIT32
argument_list|(
name|tdIORequest
operator|->
name|physLower32
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|BITS_PER_LONG
operator|>
literal|32
operator|)
name|agSgl
operator|.
name|upper
operator|=
name|BIT32_TO_LEBIT32
argument_list|(
name|tdIORequest
operator|->
name|physUpper32
argument_list|)
expr_stmt|;
else|#
directive|else
name|agSgl1
operator|.
name|upper
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|agSgl
operator|.
name|type
operator|=
name|BIT32_TO_LEBIT32
argument_list|(
name|tiSgl
argument_list|)
expr_stmt|;
name|agSgl
operator|.
name|len
operator|=
name|BIT32_TO_LEBIT32
argument_list|(
name|DR_MODE_PG_SZ
argument_list|)
expr_stmt|;
comment|/* initializes "agsaSgl_t   agSgl" of "agsaDifSSPInitiatorRequest_t" */
name|tiStatus
operator|=
name|itdssIOPrepareSGL
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
argument_list|,
operator|&
name|agSgl
argument_list|,
name|tdIORequest
operator|->
name|virtAddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaCTLModeSelect: can't get SGL\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequest
operator|->
name|osMemHandle2
argument_list|,
name|DR_MODE_PG_SZ
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequest
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tdIORequest
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|AGSA_SSP_INIT_WRITE
argument_list|,
name|agSASRequestBody
argument_list|,
name|agNULL
argument_list|,
operator|&
name|tdsaCTLIOCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tiStatus
operator|=
name|tiSuccess
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaCTLModeSelect: saSSPStart OK\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|tiStatus
operator|=
name|tiBusy
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaCTLModeSelect: saSSPStart busy\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tiStatus
operator|=
name|tiError
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdsaCTLModeSelect: saSSPStart Error\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdsaCTLNextDevice
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
operator|->
name|tdPortContext
argument_list|,
name|tdIORequest
argument_list|,
name|oneDeviceData
operator|->
name|MainLink
operator|.
name|flink
argument_list|)
expr_stmt|;
block|}
return|return
name|tiStatus
return|;
block|}
end_function

begin_comment
comment|/* tdsaCTLModeSelect */
end_comment

begin_function
name|STATIC
name|void
name|tdsaCTLNextDevice
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdIORequest_t
modifier|*
name|tdIORequest
parameter_list|,
name|tdList_t
modifier|*
name|DeviceList
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tiIntrEventType_t
name|eventType
decl_stmt|;
name|bit32
name|eventStatus
decl_stmt|;
name|int
name|rc
decl_stmt|;
comment|/*    * From the device list, returns only valid devices    */
for|for
control|(
init|;
name|DeviceList
operator|&&
name|DeviceList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|;
name|DeviceList
operator|=
name|DeviceList
operator|->
name|flink
control|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceList
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaCTLNextDevice: devHandle %p\n"
operator|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|onePortContext
condition|)
continue|continue;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|discovered
operator|==
name|agFALSE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|&&
operator|!
name|DEVICE_IS_SSP_INITIATOR
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|oneDeviceData
operator|->
name|discovered
operator|=
name|agTRUE
expr_stmt|;
name|rc
operator|=
name|tdsaCTLModeSelect
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|tiDeviceHandle
argument_list|,
name|tdIORequest
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaCTLNextDevice: ModeSelect ret %d\n"
operator|,
name|rc
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaCTLNextDevice: no more devices found\n"
operator|)
argument_list|)
expr_stmt|;
name|eventType
operator|=
name|tdIORequest
operator|->
name|eventType
expr_stmt|;
name|eventStatus
operator|=
name|tdIORequest
operator|->
name|eventStatus
expr_stmt|;
comment|/* no more devices, free the memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequest
operator|->
name|osMemHandle2
argument_list|,
name|DR_MODE_PG_SZ
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequest
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tdIORequest
argument_list|)
argument_list|)
expr_stmt|;
comment|/* send Discovery Done event */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|eventType
argument_list|,
name|eventStatus
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* tdsaCTLNextDevice */
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaCTLSet
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tiIntrEventType_t
name|eventType
parameter_list|,
name|bit32
name|eventStatus
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequest_t
modifier|*
name|tdIORequest
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiIORequest
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|bit32
name|physUpper32
decl_stmt|;
name|bit32
name|physLower32
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaCTLSet: tiPortalContext pid %d etyp %x stat %x\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|eventType
operator|,
name|eventStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|!=
name|ITD_DSTATE_COMPLETED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaCTLSet: discovery not completed\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* use the same memory for all valid devices */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdIORequest
argument_list|,
operator|&
name|physUpper32
argument_list|,
operator|&
name|physLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tdIORequest
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
operator|||
name|tdIORequest
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaCTLSet: ostiAllocMemory failed\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
comment|// tiError;
block|}
name|osti_memset
argument_list|(
name|tdIORequest
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tdIORequest
argument_list|)
argument_list|)
expr_stmt|;
name|tdIORequest
operator|->
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|tdIORequest
operator|->
name|eventType
operator|=
name|eventType
expr_stmt|;
name|tdIORequest
operator|->
name|eventStatus
operator|=
name|eventStatus
expr_stmt|;
name|tiIORequest
operator|=
operator|&
name|tdIORequest
operator|->
name|tiIORequest
expr_stmt|;
name|tdIORequestBody
operator|=
operator|&
name|tdIORequest
operator|->
name|tdIORequestBody
expr_stmt|;
comment|/* save context if we need to abort later */
name|tiIORequest
operator|->
name|tdData
operator|=
name|tdIORequestBody
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|NULL
expr_stmt|;
comment|//itdssIOCompleted;
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
literal|16
expr_stmt|;
name|tdIORequestBody
operator|->
name|agIORequest
operator|.
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequest
expr_stmt|;
comment|//tdIORequestBody;
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|tdIORequest
operator|->
name|osMemHandle2
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdIORequest
operator|->
name|virtAddr
argument_list|,
operator|&
name|tdIORequest
operator|->
name|physUpper32
argument_list|,
operator|&
name|tdIORequest
operator|->
name|physLower32
argument_list|,
literal|8
argument_list|,
name|DR_MODE_PG_SZ
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
operator|||
name|tdIORequest
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaCTLSet: ostiAllocMemory noncached failed\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequest
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tdIORequest
argument_list|)
argument_list|)
expr_stmt|;
return|return;
comment|// tiError;
block|}
name|osti_memset
argument_list|(
name|tdIORequest
operator|->
name|virtAddr
argument_list|,
literal|0
argument_list|,
name|DR_MODE_PG_SZ
argument_list|)
expr_stmt|;
name|tdsaCTLNextDevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tdIORequest
argument_list|,
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* tdsaCTLSet*/
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASDiscoverDone * *  Purpose:  This function called to finish up SAS discovery. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASDiscoverDone
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|SATA_ENABLE
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: pPort=%p  DONE\n"
operator|,
name|onePortContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* Set discovery status */
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_SAS_DONE
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* debugging only */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: BEFORE\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|tdsaDumpAllUpExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* clean up expanders data strucures; move to free exp when device is cleaned */
name|tdsaCleanAllExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* debugging only */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: AFTER\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|tdsaDumpAllUpExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* call back to notify discovery is done */
comment|/* SATA is NOT enbled */
ifndef|#
directive|ifndef
name|SATA_ENABLE
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: broadcast change; discover again\n"
operator|)
argument_list|)
expr_stmt|;
name|tdssInternalRemovals
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
comment|/* processed broadcast change */
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
operator|&&
name|onePortContext
operator|->
name|discovery
operator|.
name|ResetTriggerred
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: tdsaBCTimer\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaBCTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|TDSA_DISCOVERY_TYPE_SAS
argument_list|,
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_COMPLETED
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_FULL_START
condition|)
block|{
if|if
condition|(
name|flag
operator|==
name|tiSuccess
condition|)
block|{
ifdef|#
directive|ifdef
name|AGTIAPI_CTL
if|if
condition|(
name|tdsaAllShared
operator|->
name|SASConnectTimeLimit
condition|)
name|tdsaCTLSet
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscOK
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: discovery failed\n"
operator|)
argument_list|)
expr_stmt|;
name|tdssDiscoveryErrorRemovals
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|flag
operator|==
name|tiSuccess
condition|)
block|{
name|tdssReportChanges
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdssReportRemovals
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|TBD
comment|/* ACKing BC */
name|tdsaAckBC
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SATA_ENABLE
if|if
condition|(
name|flag
operator|==
name|tiSuccess
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: calling SATA discovery\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*        tdsaSATAFullDiscover() or tdsaincrementalDiscover()        call sata discover        when sata discover is done, call ostiInitiatorEvent     */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: calling FULL SATA discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|AG_SA_DISCOVERY_TYPE_SATA
argument_list|,
name|TDSA_DISCOVERY_OPTION_FULL_START
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: calling INCREMENTAL SATA discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|AG_SA_DISCOVERY_TYPE_SATA
argument_list|,
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* error case */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDiscoverDone: Error; clean up\n"
operator|)
argument_list|)
expr_stmt|;
name|tdssDiscoveryErrorRemovals
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agFALSE
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_COMPLETED
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return;
block|}
end_function

begin_comment
comment|//temp only for testing
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaReportManInfoSend
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaReportManInfoSend: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdSMPStart
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_REPORT_MANUFACTURE_INFORMATION
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tdsaReportManInfoRespRcvd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdssSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaReportManInfoRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaReportManInfoRespRcvd: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaReportManInfoRespRcvd: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaReportManInfoRespRcvd: SMP accepted\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportManInfoRespRcvd: SMP NOT accepted; fn result 0x%x\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaReportManInfoRespRcvd: discovery retries %d\n"
operator|,
name|discovery
operator|->
name|retries
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|retries
operator|>=
name|DISCOVERY_RETRIES
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportManInfoRespRcvd: retries are over\n"
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/* failed the discovery */
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportManInfoRespRcvd: keep retrying\n"
operator|)
argument_list|)
expr_stmt|;
comment|// start timer
name|tdsaDiscoveryTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|//end temp only for testing
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  tdsaReportGeneralSend * *  Purpose:  This function sends Report General SMP to a device. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneDeviceData: Pointer to the device data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaReportGeneralSend
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportGeneralSend: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdSMPStart
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_REPORT_GENERAL
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaReportGeneralRespRcvd * *  Purpose:  This function processes Report General response. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   agRoot: Pointer to chip/driver Instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   frameHeader: Pointer to SMP frame header. *  \param   frameHandle: A Handle used to refer to the response frame * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaReportGeneralRespRcvd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdssSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|smpRespReportGeneral_t
name|tdSMPReportGeneralResp
decl_stmt|;
name|smpRespReportGeneral_t
modifier|*
name|ptdSMPReportGeneralResp
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|bit32
name|i
decl_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|tdssSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
decl_stmt|;
name|tdSMPRequestBody
operator|=
operator|(
name|tdssSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportGeneralRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportGeneralRespRcvd: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportGeneralRespRcvd: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|ptdSMPReportGeneralResp
operator|=
operator|&
name|tdSMPReportGeneralResp
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|tdSMPReportGeneralResp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|frameHandle
argument_list|,
literal|4
argument_list|,
name|ptdSMPReportGeneralResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResp
argument_list|,
literal|4
argument_list|,
name|ptdSMPReportGeneralResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|//tdhexdump("tdsaReportGeneralRespRcvd", (bit8 *)ptdSMPReportGeneralResp, sizeof(smpRespReportGeneral_t));
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportGeneralRespRcvd: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|oneDeviceData
operator|->
name|numOfPhys
operator|=
operator|(
name|bit8
operator|)
name|ptdSMPReportGeneralResp
operator|->
name|numOfPhys
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|tdExpander
expr_stmt|;
name|oneExpander
operator|->
name|routingIndex
operator|=
operator|(
name|bit16
operator|)
name|REPORT_GENERAL_GET_ROUTEINDEXES
argument_list|(
name|ptdSMPReportGeneralResp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|;
name|i
operator|++
control|)
block|{
name|oneExpander
operator|->
name|currentIndex
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
name|oneExpander
operator|->
name|configReserved
operator|=
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|configRouteTable
operator|=
name|REPORT_GENERAL_IS_CONFIGURABLE
argument_list|(
name|ptdSMPReportGeneralResp
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|configuring
operator|=
name|REPORT_GENERAL_IS_CONFIGURING
argument_list|(
name|ptdSMPReportGeneralResp
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportGeneralRespRcvd: oneExpander=%p numberofPhys=0x%x RoutingIndex=0x%x\n"
operator|,
name|oneExpander
operator|,
name|oneDeviceData
operator|->
name|numOfPhys
operator|,
name|oneExpander
operator|->
name|routingIndex
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportGeneralRespRcvd: configRouteTable=%d configuring=%d\n"
operator|,
name|oneExpander
operator|->
name|configRouteTable
operator|,
name|oneExpander
operator|->
name|configuring
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|->
name|configuring
operator|==
literal|1
condition|)
block|{
name|discovery
operator|->
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|retries
operator|>=
name|DISCOVERY_RETRIES
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportGeneralRespRcvd: retries are over\n"
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/* failed the discovery */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportGeneralRespRcvd: keep retrying\n"
operator|)
argument_list|)
expr_stmt|;
comment|// start timer for sending ReportGeneral
name|tdsaDiscoveryTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|discovery
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
name|tdsaDiscoverSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportGeneralRespRcvd: SMP failed; fn result 0x%x; stopping discovery\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDiscoverSend * *  Purpose:  This function sends Discovery SMP to a device. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneDeviceData: Pointer to the device data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDiscoverSend
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|smpReqDiscover_t
name|smpDiscoverReq
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverSend: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverSend: device %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|tdExpander
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverSend: phyID 0x%x\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|smpDiscoverReq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|smpDiscoverReq
operator|.
name|reserved1
operator|=
literal|0
expr_stmt|;
name|smpDiscoverReq
operator|.
name|reserved2
operator|=
literal|0
expr_stmt|;
name|smpDiscoverReq
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|smpDiscoverReq
operator|.
name|reserved3
operator|=
literal|0
expr_stmt|;
name|tdSMPStart
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_DISCOVER
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|smpDiscoverReq
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqDiscover_t
argument_list|)
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDiscoverRespRcvd * *  Purpose:  This function processes Discovery response. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   agRoot: Pointer to chip/driver Instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   frameHeader: Pointer to SMP frame header. *  \param   frameHandle: A Handle used to refer to the response frame * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDiscoverRespRcvd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdssSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|smpRespDiscover_t
modifier|*
name|ptdSMPDiscoverResp
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|tdssSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
decl_stmt|;
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverRespRcvd: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverRespRcvd: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|tdExpander
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|tdSMPRequestBody
operator|=
operator|(
name|tdssSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverRespRcvd: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|ptdSMPDiscoverResp
operator|=
operator|&
operator|(
name|discovery
operator|->
name|SMPDiscoverResp
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|frameHandle
argument_list|,
literal|4
argument_list|,
name|ptdSMPDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResp
argument_list|,
literal|4
argument_list|,
name|ptdSMPDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|//tdhexdump("tdsaDiscoverRespRcvd", (bit8 *)ptdSMPDiscoverResp, sizeof(smpRespDiscover_t));
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|tdsaSASUpStreamDiscoverExpanderPhy
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|ptdSMPDiscoverResp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|tdsaSASDownStreamDiscoverExpanderPhy
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|ptdSMPDiscoverResp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_CONFIG_ROUTING
condition|)
block|{
comment|/* not done with configuring routing          1. set the timer          2. on timer expiration, call tdsaSASDownStreamDiscoverExpanderPhy()       */
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaDiscoverRespRcvd: still configuring routing; setting timer\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaDiscoverRespRcvd: onePortContext %p oneDeviceData %p ptdSMPDiscoverResp %p\n"
operator|,
name|onePortContext
operator|,
name|oneDeviceData
operator|,
name|ptdSMPDiscoverResp
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"tdsaDiscoverRespRcvd"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|ptdSMPDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdsaConfigureRouteTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|ptdSMPDiscoverResp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* nothing */
block|}
block|}
elseif|else
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|PHY_VACANT
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverRespRcvd: smpFunctionResult is PHY_VACANT, phyid %d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|tdsaSASUpStreamDiscoverExpanderPhySkip
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|tdsaSASDownStreamDiscoverExpanderPhySkip
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_CONFIG_ROUTING
condition|)
block|{
comment|/* not done with configuring routing          1. set the timer          2. on timer expiration, call tdsaSASDownStreamDiscoverExpanderPhy()       */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverRespRcvd: still configuring routing; setting timer\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverRespRcvd: onePortContext %p oneDeviceData %p ptdSMPDiscoverResp %p\n"
operator|,
name|onePortContext
operator|,
name|oneDeviceData
operator|,
name|ptdSMPDiscoverResp
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"tdsaDiscoverRespRcvd"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|ptdSMPDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdsaConfigureRouteTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|ptdSMPDiscoverResp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverRespRcvd: Discovery Error SMP function return result error=%x\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASUpStreamDiscoverExpanderPhy * *  Purpose:  This function actully does upstream traverse and finds out detailed *            information about topology. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneExpander: Pointer to the expander data. *  \param   pDiscoverResp: Pointer to the Discovery SMP respsonse. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASUpStreamDiscoverExpanderPhy
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|smpRespDiscover_t
modifier|*
name|pDiscoverResp
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|AttachedDevice
init|=
name|agNULL
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|AttachedExpander
decl_stmt|;
name|agsaSASIdentify_t
name|sasIdentify
decl_stmt|;
name|bit8
name|connectionRate
decl_stmt|;
name|bit32
name|attachedSasHi
decl_stmt|,
name|attachedSasLo
decl_stmt|;
name|tdsaSASSubID_t
name|agSASSubID
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|tdDevice
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: Phy #%d of SAS %08x-%08x\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   Attached device: %s\n"
operator|,
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|0
condition|?
literal|"No Device"
else|:
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|1
condition|?
literal|"End Device"
else|:
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|2
condition|?
literal|"Edge Expander"
else|:
literal|"Fanout Expander"
operator|)
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"   SAS address    : %08x-%08x\n"
operator|,
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
operator|,
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   SSP Target     : %d\n"
operator|,
name|DISCRSP_IS_SSP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   STP Target     : %d\n"
operator|,
name|DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   SMP Target     : %d\n"
operator|,
name|DISCRSP_IS_SMP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   SATA DEVICE    : %d\n"
operator|,
name|DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   SSP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_SSP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   STP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_STP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   SMP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   Phy ID         : %d\n"
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   Attached Phy ID: %d\n"
operator|,
name|pDiscoverResp
operator|->
name|attachedPhyIdentifier
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* end for debugging */
comment|/* for debugging */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|!=
name|pDiscoverResp
operator|->
name|phyIdentifier
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: !!! Incorrect SMP response !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: Request PhyID #%d Response PhyID #%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"NO_DEVICE"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* saving routing attribute for non self-configuring expanders */
name|oneExpander
operator|->
name|routingAttribute
index|[
name|pDiscoverResp
operator|->
name|phyIdentifier
index|]
operator|=
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
comment|/* for debugging */
comment|//  dumpRoutingAttributes(tiRoot, oneExpander, pDiscoverResp->phyIdentifier);
if|if
condition|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: SA_SAS_DEV_TYPE_FANOUT_EXPANDER\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: **** Topology Error subtractive routing on fanout expander device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery error */
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
comment|/* (2.1.3) discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: SA_SAS_DEV_TYPE_EDGE_EXPANDER\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
comment|/* Setup sasIdentify for the attached device */
name|sasIdentify
operator|.
name|phyIdentifier
operator|=
name|pDiscoverResp
operator|->
name|phyIdentifier
expr_stmt|;
name|sasIdentify
operator|.
name|deviceType_addressFrameType
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pDiscoverResp
operator|->
name|attachedDeviceType
operator|&
literal|0x70
argument_list|)
expr_stmt|;
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_Ssp_Stp_Smp_Sata_Initiator
expr_stmt|;
name|sasIdentify
operator|.
name|target_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_SataPS_Ssp_Stp_Smp_Sata_Target
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressHi
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressHi
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressLo
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressLo
expr_stmt|;
comment|/* incremental discovery */
name|agSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
expr_stmt|;
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|target_ssp_stp_smp
expr_stmt|;
name|attachedSasHi
operator|=
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
name|attachedSasLo
operator|=
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
comment|/* If the phy has subtractive routing attribute */
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: SA_SAS_ROUTING_SUBTRACTIVE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup upstream phys */
name|tdsaSASExpanderUpStreamPhyAdd
argument_list|(
name|tiRoot
argument_list|,
name|oneExpander
argument_list|,
operator|(
name|bit8
operator|)
name|pDiscoverResp
operator|->
name|attachedPhyIdentifier
argument_list|)
expr_stmt|;
comment|/* If the expander already has an upsteam device set up */
if|if
condition|(
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|==
name|agTRUE
condition|)
block|{
comment|/* If the sas address doesn't match */
if|if
condition|(
operator|(
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressHi
operator|!=
name|attachedSasHi
operator|)
operator|||
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressLo
operator|!=
name|attachedSasLo
operator|)
operator|)
operator|&&
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|||
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: **** Topology Error subtractive routing error - inconsistent SAS address\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* call back to notify discovery error */
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
comment|/* discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Setup SAS address for up stream device */
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|=
name|agTRUE
expr_stmt|;
name|oneExpander
operator|->
name|upStreamSASAddressHi
operator|=
name|attachedSasHi
expr_stmt|;
name|oneExpander
operator|->
name|upStreamSASAddressLo
operator|=
name|attachedSasLo
expr_stmt|;
if|if
condition|(
operator|(
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|!=
name|attachedSasHi
operator|)
operator|||
operator|(
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|!=
name|attachedSasLo
operator|)
condition|)
block|{
comment|/* Find the device from the discovered list */
name|AttachedDevice
operator|=
name|tdsaPortSASDeviceFind
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|attachedSasLo
argument_list|,
name|attachedSasHi
argument_list|)
expr_stmt|;
comment|/* If the device has been discovered before */
if|if
condition|(
name|AttachedDevice
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: Seen This Device Before\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* If attached device is an edge expander */
if|if
condition|(
name|AttachedDevice
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
comment|/* The attached device is an expander */
name|AttachedExpander
operator|=
name|AttachedDevice
operator|->
name|tdExpander
expr_stmt|;
comment|/* If the two expanders are the root of the two edge expander sets */
if|if
condition|(
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressHi
operator|==
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|&&
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressLo
operator|==
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* Setup upstream expander for the pExpander */
name|oneExpander
operator|->
name|tdUpStreamExpander
operator|=
name|AttachedExpander
expr_stmt|;
block|}
comment|/* If the two expanders are not the root of the two edge expander sets */
else|else
block|{
comment|/* TODO: loop found, discovery error, callback */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: **** Topology Error loop detection\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
comment|/* discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If attached device is not an edge expander */
else|else
block|{
comment|/*TODO: should not happen, ASSERT */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy, *** Attached Device is not Edge. Confused!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If the device has not been discovered before */
else|else
block|{
comment|/* Add the device */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: New device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* read minimum rate from the configuration                  onePortContext->LinkRate is SPC's local link rate               */
name|connectionRate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|onePortContext
operator|->
name|LinkRate
argument_list|,
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"siSASUpStreamDiscoverExpanderPhy: link rate 0x%x\n"
operator|,
name|onePortContext
operator|->
name|LinkRate
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"siSASUpStreamDiscoverExpanderPhy: negotiatedPhyLinkRate 0x%x\n"
operator|,
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"siSASUpStreamDiscoverExpanderPhy: connectionRate 0x%x\n"
operator|,
name|connectionRate
operator|)
argument_list|)
expr_stmt|;
comment|//hhhhhhhh
if|if
condition|(
name|DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
comment|/* incremental discovery */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|tdsaFindRegNValid
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|agSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* incremental discovery */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|tdsaFindRegNValid
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|agSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* If the device is added successfully */
if|if
condition|(
name|AttachedDevice
operator|!=
name|agNULL
condition|)
block|{
comment|/* (3.1.2.3.2.3.2.1) callback about new device */
if|if
condition|(
name|DISCRSP_IS_SSP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SSP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: Found SSP/SMP SAS %08x-%08x\n"
operator|,
name|attachedSasHi
operator|,
name|attachedSasLo
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: Found a SAS STP device.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* If the attached device is an expander */
if|if
condition|(
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
condition|)
block|{
comment|/* Allocate an expander data structure */
name|AttachedExpander
operator|=
name|tdssSASDiscoveringExpanderAlloc
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedDevice
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: Found expander=%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* If allocate successfully */
if|if
condition|(
name|AttachedExpander
operator|!=
name|agNULL
condition|)
block|{
comment|/* Add the pAttachedExpander to discovering list */
name|tdssSASDiscoveringExpanderAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|)
expr_stmt|;
comment|/* Setup upstream expander for the pExpander */
name|oneExpander
operator|->
name|tdUpStreamExpander
operator|=
name|AttachedExpander
expr_stmt|;
block|}
comment|/* If failed to allocate */
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy, Failed to allocate expander data structure\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If the attached device is an end device */
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: Found end device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* LP2006-05-26 added upstream device to the newly found device */
name|AttachedDevice
operator|->
name|tdExpander
operator|=
name|oneExpander
expr_stmt|;
name|oneExpander
operator|->
name|tdUpStreamExpander
operator|=
name|agNULL
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy, Failed to add a device\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
comment|/* substractive routing */
block|}
block|}
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: DISCOVERY_UP_STREAM find more ...\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|tdsaDiscoverSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: DISCOVERY_UP_STREAM last phy continue upstream..\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|tdssSASDiscoveringExpanderRemove
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue upstream discovering */
name|tdsaSASUpStreamDiscovering
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: onePortContext->discovery.status not in DISCOVERY_UP_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhy: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// for debugging only
end_comment

begin_function
name|osGLOBAL
name|tdsaExpander_t
modifier|*
name|tdsaFindUpStreamConfigurableExp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|tdsaExpander_t
modifier|*
name|ret
init|=
name|agNULL
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|UpsreamExpander
init|=
name|oneExpander
operator|->
name|tdUpStreamExpander
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindUpStreamConfigurableExp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindUpStreamConfigurableExp: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindUpStreamConfigurableExp: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|UpsreamExpander
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindUpStreamConfigurableExp: NO upsream expander\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|UpsreamExpander
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindUpStreamConfigurableExp: exp addrHi 0x%08x\n"
operator|,
name|UpsreamExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindUpStreamConfigurableExp: exp addrLo 0x%08x\n"
operator|,
name|UpsreamExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|UpsreamExpander
operator|=
name|UpsreamExpander
operator|->
name|tdUpStreamExpander
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASUpStreamDiscoverExpanderPhySkip * *  Purpose:  This function skips a phy which returned PHY_VACANT in SMP *            response in upstream * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneExpander: Pointer to the expander data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASUpStreamDiscoverExpanderPhySkip
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhySkip: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|tdDevice
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhySkip: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhySkip: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhySkip: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|tdsaDiscoverSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhySkip: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|tdssSASDiscoveringExpanderRemove
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue upstream discovering */
name|tdsaSASUpStreamDiscovering
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhySkip: onePortContext->discovery.status not in DISCOVERY_UP_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASUpStreamDiscoverExpanderPhySkip: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// for debugging only
end_comment

begin_function
name|osGLOBAL
name|tdsaExpander_t
modifier|*
name|tdsaFindDownStreamConfigurableExp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|tdsaExpander_t
modifier|*
name|ret
init|=
name|agNULL
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|DownsreamExpander
init|=
name|oneExpander
operator|->
name|tdCurrentDownStreamExpander
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindDownStreamConfigurableExp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindDownStreamConfigurableExp: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindDownStreamConfigurableExp: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DownsreamExpander
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindDownStreamConfigurableExp: NO downsream expander\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|DownsreamExpander
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindDownStreamConfigurableExp: exp addrHi 0x%08x\n"
operator|,
name|DownsreamExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindDownStreamConfigurableExp: exp addrLo 0x%08x\n"
operator|,
name|DownsreamExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DownsreamExpander
operator|=
name|DownsreamExpander
operator|->
name|tdCurrentDownStreamExpander
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|// for debugging only
end_comment

begin_function
name|osGLOBAL
name|void
name|dumpRoutingAttributes
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|bit8
name|phyID
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"dumpRoutingAttributes: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"dumpRoutingAttributes: phyID %d\n"
operator|,
name|phyID
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"dumpRoutingAttributes: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"dumpRoutingAttributes: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
operator|(
operator|(
name|bit32
operator|)
name|phyID
operator|+
literal|1
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"dumpRoutingAttributes: index %d routing attribute %d\n"
operator|,
name|i
operator|,
name|oneExpander
operator|->
name|routingAttribute
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDumpAllExp * *  Purpose:  This function prints out all expanders seen by discovery. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneExpander: Pointer to the expander data. * *  \return: *           None * *   \note: For debugging only * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDumpAllExp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
if|#
directive|if
literal|0
comment|/* for debugging only */
block|tdList_t          *ExpanderList;   tdsaExpander_t    *tempExpander;   tdsaExpander_t    *UpsreamExpander;   tdsaExpander_t    *DownsreamExpander;   tdsaPortContext_t *tmpOnePortContext = onePortContext;    TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: start\n"));   TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: onePortcontext %p oneExpander %p\n", onePortContext, oneExpander));
comment|/* debugging */
block|tdsaSingleThreadedEnter(tiRoot, TD_DISC_LOCK);   if (TDLIST_EMPTY(&(tmpOnePortContext->discovery.discoveringExpanderList)))   {     tdsaSingleThreadedLeave(tiRoot, TD_DISC_LOCK);     TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: empty discoveringExpanderList\n"));     return;   }   else   {     tdsaSingleThreadedLeave(tiRoot, TD_DISC_LOCK);   }   ExpanderList = tmpOnePortContext->discovery.discoveringExpanderList.flink;   while (ExpanderList !=&(tmpOnePortContext->discovery.discoveringExpanderList))   {     tempExpander = TDLIST_OBJECT_BASE(tdsaExpander_t, linkNode, ExpanderList);     UpsreamExpander = tempExpander->tdUpStreamExpander;     DownsreamExpander = tempExpander->tdCurrentDownStreamExpander;     TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: expander id %d\n", tempExpander->id));     TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: exp addrHi 0x%08x\n", tempExpander->tdDevice->SASAddressID.sasAddressHi));     TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: exp addrLo 0x%08x\n", tempExpander->tdDevice->SASAddressID.sasAddressLo));     if (UpsreamExpander)     {       TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: Up exp addrHi 0x%08x\n", UpsreamExpander->tdDevice->SASAddressID.sasAddressHi));       TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: Up exp addrLo 0x%08x\n", UpsreamExpander->tdDevice->SASAddressID.sasAddressLo));     }     else     {       TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: No Upstream expander\n"));     }     if (DownsreamExpander)     {       TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: Down exp addrHi 0x%08x\n", DownsreamExpander->tdDevice->SASAddressID.sasAddressHi));       TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: Down exp addrLo 0x%08x\n", DownsreamExpander->tdDevice->SASAddressID.sasAddressLo));     }     else     {       TI_DBG3(("tdssSASDiscoveringExpander tdsaDumpAllExp: No Downstream expander\n"));     }      ExpanderList = ExpanderList->flink;   }
endif|#
directive|endif
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDumpAllUpExp * *  Purpose:  This function prints out all upstream expanders seen by discovery. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneExpander: Pointer to the expander data. * *  \return: *           None * *   \note: For debugging only * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDumpAllUpExp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDumpAllFreeExp * *  Purpose:  This function prints out all free expanders. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \return: *           None * *   \note: For debugging only * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDumpAllFreeExp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDuplicateConfigSASAddr * *  Purpose:  This function finds whether SAS address has added to the routing *            table of expander or not. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneExpander: Pointer to the expander data. *  \param   configSASAddressHi: Upper 4 byte of SAS address. *  \param   configSASAddressLo: Lower 4 byte of SAS address. * *  \return: *           agTRUE  No need to add configSASAddress. *           agFALSE Need to add configSASAddress. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaDuplicateConfigSASAddr
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|bit32
name|configSASAddressHi
parameter_list|,
name|bit32
name|configSASAddressLo
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
name|bit32
name|ret
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: NULL expander\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
if|if
condition|(
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|configSASAddressHi
operator|&&
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|configSASAddressLo
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: unnecessary\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: configsasAddressHi 0x%08x\n"
operator|,
name|configSASAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: configsasAddressLo 0x%08x\n"
operator|,
name|configSASAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: configSASAddrTableIndex %d\n"
operator|,
name|oneExpander
operator|->
name|configSASAddrTableIndex
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|configSASAddrTableIndex
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|configSASAddressHiTable
index|[
name|i
index|]
operator|==
name|configSASAddressHi
operator|&&
name|oneExpander
operator|->
name|configSASAddressLoTable
index|[
name|i
index|]
operator|==
name|configSASAddressLo
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: FOUND!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
comment|/* new one; let's add it */
if|if
condition|(
name|ret
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: adding configSAS Addr!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDuplicateConfigSASAddr: configSASAddrTableIndex %d\n"
operator|,
name|oneExpander
operator|->
name|configSASAddrTableIndex
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|configSASAddressHiTable
index|[
name|oneExpander
operator|->
name|configSASAddrTableIndex
index|]
operator|=
name|configSASAddressHi
expr_stmt|;
name|oneExpander
operator|->
name|configSASAddressLoTable
index|[
name|oneExpander
operator|->
name|configSASAddrTableIndex
index|]
operator|=
name|configSASAddressLo
expr_stmt|;
name|oneExpander
operator|->
name|configSASAddrTableIndex
operator|++
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaFindConfigurableExp * *  Purpose:  This function finds whether there is a configurable expander in *            the upstream expander list. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneExpander: Pointer to the expander data. * *  \return: *           agTRUE  There is configurable expander. *           agFALSE There is not configurable expander. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|tdsaExpander_t
modifier|*
name|tdsaFindConfigurableExp
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|tdsaExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|tmpOnePortContext
init|=
name|onePortContext
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|ret
init|=
name|agNULL
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindConfigurableExp: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindConfigurableExp: NULL expander\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindConfigurableExp: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindConfigurableExp: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindConfigurableExp: empty UpdiscoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DISC_LOCK
argument_list|)
expr_stmt|;
block|}
name|tempExpander
operator|=
name|oneExpander
operator|->
name|tdUpStreamExpander
expr_stmt|;
while|while
condition|(
name|tempExpander
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindConfigurableExp: loop exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindConfigurableExp: loop exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempExpander
operator|->
name|configRouteTable
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindConfigurableExp: found configurable expander\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|tempExpander
expr_stmt|;
break|break;
block|}
name|tempExpander
operator|=
name|tempExpander
operator|->
name|tdUpStreamExpander
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASDownStreamDiscoverExpanderPhy * *  Purpose:  This function actully does downstream traverse and finds out detailed *            information about topology. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneExpander: Pointer to the expander data. *  \param   pDiscoverResp: Pointer to the Discovery SMP respsonse. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASDownStreamDiscoverExpanderPhy
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|smpRespDiscover_t
modifier|*
name|pDiscoverResp
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|UpStreamExpander
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|AttachedDevice
init|=
name|agNULL
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|AttachedExpander
decl_stmt|;
name|agsaSASIdentify_t
name|sasIdentify
decl_stmt|;
name|bit8
name|connectionRate
decl_stmt|;
name|bit32
name|attachedSasHi
decl_stmt|,
name|attachedSasLo
decl_stmt|;
name|tdsaSASSubID_t
name|agSASSubID
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|ConfigurableExpander
init|=
name|agNULL
decl_stmt|;
name|bit32
name|dupConfigSASAddr
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|configSASAddressHi
decl_stmt|;
name|bit32
name|configSASAddressLo
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|tiRoot
argument_list|,
literal|"(tdsaSASDownStreamDiscoverExpanderPhy) agRoot NULL"
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|onePortContext
argument_list|,
literal|"(tdsaSASDownStreamDiscoverExpanderPhy) pPort NULL"
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|oneExpander
argument_list|,
literal|"(tdsaSASDownStreamDiscoverExpanderPhy) pExpander NULL"
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|pDiscoverResp
argument_list|,
literal|"(tdsaSASDownStreamDiscoverExpanderPhy) pDiscoverResp NULL"
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: onePortContxt=%p  oneExpander=%p  oneDeviceData=%p\n"
operator|,
name|onePortContext
operator|,
name|oneExpander
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdsaDumpAllExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|tdsaFindUpStreamConfigurableExp
argument_list|(
name|tiRoot
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|tdsaFindDownStreamConfigurableExp
argument_list|(
name|tiRoot
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (1) Find the device structure of the expander */
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|tdDevice
expr_stmt|;
name|TD_ASSERT
argument_list|(
name|oneDeviceData
argument_list|,
literal|"(tdsaSASDownStreamDiscoverExpanderPhy) pDevice NULL"
argument_list|)
expr_stmt|;
comment|/* for debugging */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: Phy #%d of SAS %08x-%08x\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   Attached device: %s\n"
operator|,
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|0
condition|?
literal|"No Device"
else|:
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|1
condition|?
literal|"End Device"
else|:
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|2
condition|?
literal|"Edge Expander"
else|:
literal|"Fanout Expander"
operator|)
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* for debugging */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|!=
name|pDiscoverResp
operator|->
name|phyIdentifier
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: !!! Incorrect SMP response !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: Request PhyID #%d Response PhyID #%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"NO_DEVICE"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* debugging only */
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_NO_DEVICE
condition|)
block|{
name|tdhexdump
argument_list|(
literal|"NO_DEVICE"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"   SAS address    : %08x-%08x\n"
operator|,
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
operator|,
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   SSP Target     : %d\n"
operator|,
name|DISCRSP_IS_SSP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   STP Target     : %d\n"
operator|,
name|DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   SMP Target     : %d\n"
operator|,
name|DISCRSP_IS_SMP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   SATA DEVICE    : %d\n"
operator|,
name|DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   SSP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_SSP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   STP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_STP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   SMP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   Phy ID         : %d\n"
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"   Attached Phy ID: %d\n"
operator|,
name|pDiscoverResp
operator|->
name|attachedPhyIdentifier
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* end for debugging */
comment|/* saving routing attribute for non self-configuring expanders */
name|oneExpander
operator|->
name|routingAttribute
index|[
name|pDiscoverResp
operator|->
name|phyIdentifier
index|]
operator|=
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
comment|/* for debugging */
comment|//  dumpRoutingAttributes(tiRoot, oneExpander, pDiscoverResp->phyIdentifier);
name|oneExpander
operator|->
name|discoverSMPAllowed
operator|=
name|agTRUE
expr_stmt|;
comment|/* If a device is attached */
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
comment|/* Setup sasIdentify for the attached device */
name|sasIdentify
operator|.
name|phyIdentifier
operator|=
name|pDiscoverResp
operator|->
name|phyIdentifier
expr_stmt|;
name|sasIdentify
operator|.
name|deviceType_addressFrameType
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pDiscoverResp
operator|->
name|attachedDeviceType
operator|&
literal|0x70
argument_list|)
expr_stmt|;
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_Ssp_Stp_Smp_Sata_Initiator
expr_stmt|;
name|sasIdentify
operator|.
name|target_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_SataPS_Ssp_Stp_Smp_Sata_Target
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressHi
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressHi
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressLo
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressLo
expr_stmt|;
comment|/* incremental discovery */
name|agSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
expr_stmt|;
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|target_ssp_stp_smp
expr_stmt|;
name|attachedSasHi
operator|=
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
name|attachedSasLo
operator|=
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
comment|/* If it's a direct routing */
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_DIRECT
condition|)
block|{
comment|/* If the attached device is an expander */
if|if
condition|(
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: **** Topology Error direct routing can't connect to expander\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* If the expander's attached device is not myself */
if|if
condition|(
operator|(
name|attachedSasHi
operator|!=
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|)
operator|||
operator|(
name|attachedSasLo
operator|!=
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|)
condition|)
block|{
comment|/* Find the attached device from discovered list */
name|AttachedDevice
operator|=
name|tdsaPortSASDeviceFind
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|attachedSasLo
argument_list|,
name|attachedSasHi
argument_list|)
expr_stmt|;
comment|/* If the device has not been discovered before */
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
comment|//11
block|{
comment|/* If the phy has subtractive routing attribute */
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
operator|&&
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|||
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: **** Topology Error subtractive routing error - inconsistent SAS address\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
comment|/* discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Add the device */
comment|/* read minimum rate from the configuration              onePortContext->LinkRate is SPC's local link rate           */
name|connectionRate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|onePortContext
operator|->
name|LinkRate
argument_list|,
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: link rate 0x%x\n"
operator|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: negotiatedPhyLinkRate 0x%x\n"
operator|,
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: connectionRate 0x%x\n"
operator|,
name|connectionRate
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|tdsaFindRegNValid
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|agSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|tdsaFindRegNValid
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|agSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: newDevice  pDevice=%p\n"
operator|,
name|AttachedDevice
operator|)
argument_list|)
expr_stmt|;
comment|/* If the device is added successfully */
if|if
condition|(
name|AttachedDevice
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|SA_IDFRM_IS_SSP_TARGET
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SMP_TARGET
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SSP_INITIATOR
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SMP_INITIATOR
argument_list|(
operator|&
name|sasIdentify
argument_list|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: Report a new SAS device !!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SA_IDFRM_IS_STP_TARGET
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SATA_DEVICE
argument_list|(
operator|&
name|sasIdentify
argument_list|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: Found an STP or SATA device.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: Found Other type of device.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* LP2006-05-26 added upstream device to the newly found device */
name|AttachedDevice
operator|->
name|tdExpander
operator|=
name|oneExpander
expr_stmt|;
comment|/* If the phy has table routing attribute */
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_TABLE
condition|)
block|{
comment|/* If the attached device is a fan out expander */
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: **** Topology Error two table routing phys are connected\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
comment|/* discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
comment|/* Allocate an expander data structure */
name|AttachedExpander
operator|=
name|tdssSASDiscoveringExpanderAlloc
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedDevice
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: Found a EDGE exp device.%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* If allocate successfully */
if|if
condition|(
name|AttachedExpander
operator|!=
name|agNULL
condition|)
block|{
comment|/* set up downstream information on configurable expander */
if|if
condition|(
name|oneExpander
operator|->
name|configRouteTable
condition|)
block|{
name|tdsaSASExpanderDownStreamPhyAdd
argument_list|(
name|tiRoot
argument_list|,
name|oneExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
block|}
comment|/* Setup upstream information */
name|tdsaSASExpanderUpStreamPhyAdd
argument_list|(
name|tiRoot
argument_list|,
name|AttachedExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|hasUpStreamDevice
operator|=
name|agTRUE
expr_stmt|;
name|AttachedExpander
operator|->
name|upStreamSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|upStreamSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|tdUpStreamExpander
operator|=
name|oneExpander
expr_stmt|;
comment|/* (2.3.2.2.2.2.2.2.2) Add the pAttachedExpander to discovering list */
name|tdssSASDiscoveringExpanderAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|)
expr_stmt|;
block|}
comment|/* If failed to allocate */
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy, Failed to allocate expander data structure\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*  discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* If status is still DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: 1st before\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllUpExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|tdUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|tdsaFindConfigurableExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
condition|)
block|{
if|if
condition|(
operator|(
name|ConfigurableExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|&&
operator|(
name|ConfigurableExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* directly attached between oneExpander and ConfigurableExpander */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: 1st before loc 1\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
expr_stmt|;
name|configSASAddressLo
operator|=
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: 1st before loc 2\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* if !ConfigurableExpander */
name|dupConfigSASAddr
operator|=
name|tdsaDuplicateConfigSASAddr
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: 1st q123\n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|->
name|tdCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|tdsaFindCurrentDownStreamPhyIndex
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|tdReturnginExpander
operator|=
name|oneExpander
expr_stmt|;
name|tdsaSASRoutingEntryAdd
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/*  If fail to add the device */
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy, Failed to add a device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*  discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* If the device has been discovered before */
else|else
comment|/* haha discovered before */
block|{
comment|/* If the phy has subtractive routing attribute */
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
condition|)
block|{
comment|/* If the expander doesn't have up stream device */
if|if
condition|(
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|==
name|agFALSE
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: **** Topology Error loop, or end device connects to two expanders\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
comment|/* discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
comment|/* If the expander has up stream device */
else|else
block|{
comment|/* If sas address doesn't match */
if|if
condition|(
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressHi
operator|!=
name|attachedSasHi
operator|)
operator|||
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressLo
operator|!=
name|attachedSasLo
operator|)
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: **** Topology Error two subtractive phys\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
comment|/* discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* If the phy has table routing attribute */
elseif|else
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_TABLE
condition|)
block|{
comment|/* If the attached device is a fan out expander */
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
comment|/* (2.3.3.2.1.1) TODO: discovery error, callback */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: **** Topology Error fan out expander to routing table phy\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
comment|/* discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
comment|/* If the attached device is an edge expander */
elseif|else
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
comment|/* Setup up stream inform */
name|AttachedExpander
operator|=
name|AttachedDevice
operator|->
name|tdExpander
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: Found edge expander=%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|//hhhhhh
comment|/* If the attached expander has up stream device */
if|if
condition|(
name|AttachedExpander
operator|->
name|hasUpStreamDevice
operator|==
name|agTRUE
condition|)
block|{
comment|/* compare the sas address */
if|if
condition|(
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressHi
operator|!=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|||
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressLo
operator|!=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: **** Topology Error two table routing phys connected (1)\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
comment|/* discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: Add edge expander=%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* set up downstream information on configurable expander */
if|if
condition|(
name|oneExpander
operator|->
name|configRouteTable
condition|)
block|{
name|tdsaSASExpanderDownStreamPhyAdd
argument_list|(
name|tiRoot
argument_list|,
name|oneExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
block|}
comment|/* haha */
name|tdsaSASExpanderUpStreamPhyAdd
argument_list|(
name|tiRoot
argument_list|,
name|AttachedExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
comment|/* Add the pAttachedExpander to discovering list */
name|tdssSASDiscoveringExpanderAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If the attached expander doesn't have up stream device */
else|else
block|{
comment|/* TODO: discovery error, callback */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: **** Topology Error two table routing phys connected (2)\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
comment|/* discovery done */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* for else if (DISCRSP_GET_ROUTINGATTRIB(pDiscoverResp) == SAS_ROUTING_TABLE) */
comment|/* do this regradless of sub or table */
comment|/* If status is still DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: 2nd before\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllUpExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|tdUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|tdsaFindConfigurableExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
condition|)
block|{
if|if
condition|(
operator|(
name|ConfigurableExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|&&
operator|(
name|ConfigurableExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* directly attached between oneExpander and ConfigurableExpander */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: 2nd before loc 1\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
expr_stmt|;
name|configSASAddressLo
operator|=
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: 2nd before loc 2\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* if !ConfigurableExpander */
name|dupConfigSASAddr
operator|=
name|tdsaDuplicateConfigSASAddr
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: 2nd q123 \n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|->
name|tdCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|tdsaFindCurrentDownStreamPhyIndex
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|tdReturnginExpander
operator|=
name|oneExpander
expr_stmt|;
name|tdsaSASRoutingEntryAdd
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* if (onePortContext->discovery.status == DISCOVERY_DOWN_STREAM) */
comment|/* incremental discovery */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
condition|)
block|{
name|connectionRate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|onePortContext
operator|->
name|LinkRate
argument_list|,
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: incremental SATA_STP\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: incremental SAS\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* else; existing devce */
block|}
comment|/* not attached to myself */
comment|/* If the attached device is myself */
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: Found Self\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: 3rd before\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDumpAllUpExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|tdUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|tdsaFindConfigurableExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|dupConfigSASAddr
operator|=
name|tdsaDuplicateConfigSASAddr
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressHi
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: 3rd q123 Setup routing table\n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|->
name|tdCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|tdsaFindCurrentDownStreamPhyIndex
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|tdReturnginExpander
operator|=
name|oneExpander
expr_stmt|;
name|tdsaSASRoutingEntryAdd
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressHi
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressLo
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* If no device is attached */
else|else
block|{   }
comment|/* Increment the discovering phy id */
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
comment|/* If the discovery status is DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
comment|/* If not the last phy */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|tdsaDiscoverSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
comment|/* If the last phy */
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|tdssSASDiscoveringExpanderRemove
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue downstream discovering */
name|tdsaSASDownStreamDiscovering
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: onePortContext->discovery.status not in DISCOVERY_DOWN_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhy: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASDownStreamDiscoverExpanderPhySkip * *  Purpose:  This function skips a phy which returned PHY_VACANT in SMP *            response in downstream * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneExpander: Pointer to the expander data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASDownStreamDiscoverExpanderPhySkip
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhySkip: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|tdDevice
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhySkip: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhySkip: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* Increment the discovering phy id */
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
comment|/* If the discovery status is DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
comment|/* If not the last phy */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhySkip: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|tdsaDiscoverSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
comment|/* If the last phy */
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhySkip: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|tdssSASDiscoveringExpanderRemove
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue downstream discovering */
name|tdsaSASDownStreamDiscovering
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhySkip: onePortContext->discovery.status not in DISCOVERY_DOWN_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASDownStreamDiscoverExpanderPhySkip: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASRoutingEntryAdd * *  Purpose:  This function adds a routing entry in the configurable expander. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneExpander: Pointer to the expander data. *  \param   phyId: Phy identifier. *  \param   configSASAddressHi: Upper 4 byte of SAS address. *  \param   configSASAddressLo: Lower 4 byte of SAS address. * *  \return: *           agTRUE   Routing entry is added successfully *           agFALSE  Routing entry is not added successfully * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaSASRoutingEntryAdd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|bit32
name|phyId
parameter_list|,
name|bit32
name|configSASAddressHi
parameter_list|,
name|bit32
name|configSASAddressLo
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|agTRUE
decl_stmt|;
name|smpReqConfigureRouteInformation_t
name|confRoutingInfo
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASRoutingEntryAdd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASRoutingEntryAdd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASRoutingEntryAdd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASRoutingEntryAdd: phyid %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
comment|/* needs to compare the location of oneExpander and configSASAddress      add only if      oneExpander           |      configSASaddress    */
if|if
condition|(
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|configSASAddressHi
operator|&&
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|configSASAddressLo
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASRoutingEntryAdd: unnecessary\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|oneExpander
operator|->
name|routingAttribute
index|[
name|phyId
index|]
operator|!=
name|SAS_ROUTING_TABLE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASRoutingEntryAdd: not table routing, routing is %d\n"
operator|,
name|oneExpander
operator|->
name|routingAttribute
index|[
name|phyId
index|]
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|agRoot
operator|=
name|oneExpander
operator|->
name|tdDevice
operator|->
name|agRoot
expr_stmt|;
name|onePortContext
operator|=
name|oneExpander
operator|->
name|tdDevice
operator|->
name|tdPortContext
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_CONFIG_ROUTING
expr_stmt|;
comment|/* reset smpReqConfigureRouteInformation_t */
name|osti_memset
argument_list|(
operator|&
name|confRoutingInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqConfigureRouteInformation_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|->
name|currentIndex
index|[
name|phyId
index|]
operator|<
name|oneExpander
operator|->
name|routingIndex
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASRoutingEntryAdd: adding sasAddressHi 0x%08x\n"
operator|,
name|configSASAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASRoutingEntryAdd: adding sasAddressLo 0x%08x\n"
operator|,
name|configSASAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASRoutingEntryAdd: phyid %d currentIndex[phyid] %d\n"
operator|,
name|phyId
operator|,
name|oneExpander
operator|->
name|currentIndex
index|[
name|phyId
index|]
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|configSASAddressHi
operator|=
name|configSASAddressHi
expr_stmt|;
name|oneExpander
operator|->
name|configSASAddressLo
operator|=
name|configSASAddressLo
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved1
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved1
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|OSSA_WRITE_BE_16
argument_list|(
name|agRoot
argument_list|,
name|confRoutingInfo
operator|.
name|expanderRouteIndex
argument_list|,
literal|0
argument_list|,
operator|(
name|oneExpander
operator|->
name|currentIndex
index|[
name|phyId
index|]
operator|)
argument_list|)
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved2
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|phyIdentifier
operator|=
operator|(
name|bit8
operator|)
name|phyId
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved3
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved3
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|disabledBit_reserved4
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved5
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved5
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved5
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|confRoutingInfo
operator|.
name|routedSasAddressHi
argument_list|,
literal|0
argument_list|,
name|configSASAddressHi
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|confRoutingInfo
operator|.
name|routedSasAddressLo
argument_list|,
literal|0
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|confRoutingInfo
operator|.
name|reserved6
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|tdSMPStart
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneExpander
operator|->
name|tdDevice
argument_list|,
name|SMP_CONFIGURE_ROUTING_INFORMATION
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|confRoutingInfo
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqConfigureRouteInformation_t
argument_list|)
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|currentIndex
index|[
name|phyId
index|]
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASRoutingEntryAdd: Discovery Error routing index overflow for currentIndex=%d, routingIndex=%d\n"
operator|,
name|oneExpander
operator|->
name|currentIndex
index|[
name|phyId
index|]
operator|,
name|oneExpander
operator|->
name|routingIndex
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
name|ret
operator|=
name|agFALSE
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaConfigRoutingInfoRespRcvd * *  Purpose:  This function processes Configure Routing Information response. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   agRoot: Pointer to chip/driver Instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   frameHeader: Pointer to SMP frame header. *  \param   frameHandle: A Handle used to refer to the response frame * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_comment
comment|/* needs to traverse only upstream not downstream */
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaConfigRoutingInfoRespRcvd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdssSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|tdsaExpander_t
modifier|*
name|oneExpander
init|=
name|oneDeviceData
operator|->
name|tdExpander
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|UpStreamExpander
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|DownStreamExpander
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|ReturningExpander
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|ConfigurableExpander
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|ReturningExpanderDeviceData
decl_stmt|;
name|bit32
name|dupConfigSASAddr
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
operator|||
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|PHY_VACANT
condition|)
block|{
name|DownStreamExpander
operator|=
name|oneExpander
operator|->
name|tdCurrentDownStreamExpander
expr_stmt|;
if|if
condition|(
name|DownStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|++
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: DownStreamExpander->currentUpStreamPhyIndex %d\n"
operator|,
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: DownStreamExpander->numOfUpStreamPhys %d\n"
operator|,
name|DownStreamExpander
operator|->
name|numOfUpStreamPhys
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: DownStreamExpander addrHi 0x%08x\n"
operator|,
name|DownStreamExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: DownStreamExpander addrLo 0x%08x\n"
operator|,
name|DownStreamExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
name|oneExpander
operator|->
name|currentDownStreamPhyIndex
operator|++
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: oneExpander->currentDownStreamPhyIndex %d oneExpander->numOfDownStreamPhys %d\n"
operator|,
name|oneExpander
operator|->
name|currentDownStreamPhyIndex
operator|,
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DownStreamExpander
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|<
name|DownStreamExpander
operator|->
name|numOfUpStreamPhys
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: first if\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: DownStreamExpander->currentUpStreamPhyIndex %d\n"
operator|,
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: DownStreamExpander->upStreamPhys[] %d\n"
operator|,
name|DownStreamExpander
operator|->
name|upStreamPhys
index|[
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
index|]
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASRoutingEntryAdd
argument_list|(
name|tiRoot
argument_list|,
name|oneExpander
argument_list|,
name|DownStreamExpander
operator|->
name|upStreamPhys
index|[
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
index|]
argument_list|,
name|oneExpander
operator|->
name|configSASAddressHi
argument_list|,
name|oneExpander
operator|->
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* traversing up till discovery Root onePortContext->discovery.RootExp */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: else\n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|tdUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|tdsaFindConfigurableExp
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
if|if
condition|(
name|UpStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: UpStreamExpander addrHi 0x%08x\n"
operator|,
name|UpStreamExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: UpStreamExpander addrLo 0x%08x\n"
operator|,
name|UpStreamExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|dupConfigSASAddr
operator|=
name|tdsaDuplicateConfigSASAddr
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|oneExpander
operator|->
name|configSASAddressHi
argument_list|,
name|oneExpander
operator|->
name|configSASAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|!=
name|agNULL
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: else if\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: ConfigurableExpander addrHi 0x%08x\n"
operator|,
name|ConfigurableExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: ConfigurableExpander addrLo 0x%08x\n"
operator|,
name|ConfigurableExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|->
name|tdCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|tdsaFindCurrentDownStreamPhyIndex
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|tdReturnginExpander
operator|=
name|oneExpander
operator|->
name|tdReturnginExpander
expr_stmt|;
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|=
literal|0
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: ConfigurableExpander->currentDownStreamPhyIndex %d\n"
operator|,
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: ConfigurableExpander->downStreamPhys[] %d\n"
operator|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASRoutingEntryAdd
argument_list|(
name|tiRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|oneExpander
operator|->
name|configSASAddressHi
argument_list|,
name|oneExpander
operator|->
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* going back to where it was */
comment|/* ConfigRoutingInfo is done for a target */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: $$$$$$ my change $$$$$ \n"
operator|)
argument_list|)
expr_stmt|;
name|ReturningExpander
operator|=
name|oneExpander
operator|->
name|tdReturnginExpander
expr_stmt|;
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|=
literal|0
expr_stmt|;
comment|/* debugging */
if|if
condition|(
name|ReturningExpander
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: ReturningExpander addrHi 0x%08x\n"
operator|,
name|ReturningExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: ReturningExpander addrLo 0x%08x\n"
operator|,
name|ReturningExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|ReturningExpanderDeviceData
operator|=
name|ReturningExpander
operator|->
name|tdDevice
expr_stmt|;
comment|/* No longer in DISCOVERY_CONFIG_ROUTING */
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_DOWN_STREAM
expr_stmt|;
comment|/* If not the last phy */
if|if
condition|(
name|ReturningExpander
operator|->
name|discoveringPhyId
operator|<
name|ReturningExpanderDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
comment|/* needs to send only one Discovery not multiple times */
if|if
condition|(
name|ReturningExpander
operator|->
name|discoverSMPAllowed
operator|==
name|agTRUE
condition|)
block|{
name|tdsaDiscoverSend
argument_list|(
name|tiRoot
argument_list|,
name|ReturningExpanderDeviceData
argument_list|)
expr_stmt|;
block|}
name|ReturningExpander
operator|->
name|discoverSMPAllowed
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* If the last phy */
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
name|ReturningExpander
operator|->
name|discoverSMPAllowed
operator|=
name|agTRUE
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|tdssSASDiscoveringExpanderRemove
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|ReturningExpander
argument_list|)
expr_stmt|;
comment|/* continue downstream discovering */
name|tdsaSASDownStreamDiscovering
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|ReturningExpanderDeviceData
argument_list|)
expr_stmt|;
comment|//DownStreamExpander
block|}
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: ReturningExpander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: UpStreamExpander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigRoutingInfoRespRcvd: Discovery Error SMP function return result error=%x\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaReportPhySataSend * *  Purpose:  This function sends Report Phy SATA to a device. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   phyId: Phy Identifier. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaReportPhySataSend
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|bit8
name|phyId
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|smpReqReportPhySata_t
name|smpReportPhySataReq
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportPhySataSend: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|tdExpander
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportPhySataSend: Error!!! portcontext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportPhySataSend: Error!!! expander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportPhySataSend: device %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportPhySataSend: phyid %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|tdDeviceToProcess
operator|=
name|oneDeviceData
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|smpReportPhySataReq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqReportPhySata_t
argument_list|)
argument_list|)
expr_stmt|;
name|smpReportPhySataReq
operator|.
name|phyIdentifier
operator|=
name|phyId
expr_stmt|;
name|tdSMPStart
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneExpander
operator|->
name|tdDevice
argument_list|,
name|SMP_REPORT_PHY_SATA
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|smpReportPhySataReq
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqReportPhySata_t
argument_list|)
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaReportPhySataRcvd * *  Purpose:  This function processes Report Phy SATA response. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   agRoot: Pointer to chip/driver Instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   frameHeader: Pointer to SMP frame header. *  \param   frameHandle: A Handle used to refer to the response frame * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaReportPhySataRcvd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdssSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|smpRespReportPhySata_t
name|SMPreportPhySataResp
decl_stmt|;
name|smpRespReportPhySata_t
modifier|*
name|pSMPReportPhySataResp
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|oneExpander
init|=
name|oneDeviceData
operator|->
name|tdExpander
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|agsaFisRegDeviceToHost_t
modifier|*
name|fis
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|SataDevice
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|tdssSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
decl_stmt|;
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportPhySataRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportPhySataRcvd: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportPhySataRcvd: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|tdSMPRequestBody
operator|=
operator|(
name|tdssSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
endif|#
directive|endif
comment|/* get the current sata device hanlde stored in the expander structure */
name|SataDevice
operator|=
name|oneExpander
operator|->
name|tdDeviceToProcess
expr_stmt|;
name|pSMPReportPhySataResp
operator|=
operator|&
name|SMPreportPhySataResp
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|frameHandle
argument_list|,
literal|4
argument_list|,
name|pSMPReportPhySataResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResp
argument_list|,
literal|4
argument_list|,
name|pSMPReportPhySataResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|//tdhexdump("tdsaReportPhySataRcvd", (bit8 *)pSMPReportPhySataResp, sizeof(smpRespReportPhySata_t));
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportPhySataRcvd: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|SataDevice
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaReportPhySataRcvd: SataDevice is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
operator|||
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|PHY_VACANT
condition|)
block|{
name|fis
operator|=
operator|(
name|agsaFisRegDeviceToHost_t
operator|*
operator|)
operator|&
name|SMPreportPhySataResp
operator|.
name|regDevToHostFis
expr_stmt|;
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|fisType
operator|==
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
comment|/* save signature */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportPhySataRcvd: saves the signature\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* saves signature */
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|0
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|sectorCount
expr_stmt|;
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|1
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaLow
expr_stmt|;
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|2
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaMid
expr_stmt|;
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|3
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaHigh
expr_stmt|;
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|4
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|device
expr_stmt|;
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportPhySataRcvd: SATA Signature = %02x %02x %02x %02x %02x\n"
operator|,
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|0
index|]
operator|,
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|1
index|]
operator|,
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|2
index|]
operator|,
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|3
index|]
operator|,
name|SataDevice
operator|->
name|satDevData
operator|.
name|satSignature
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/*         no longer, discovery sends sata identify device command         tdsaSATAIdentifyDeviceCmdSend(tiRoot, SataDevice);       */
name|SataDevice
operator|=
name|tdsaFindRightDevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|SataDevice
argument_list|)
expr_stmt|;
name|tdsaDiscoveringStpSATADevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|SataDevice
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportPhySataRcvd: getting next stp bride\n"
operator|)
argument_list|)
expr_stmt|;
name|SataDevice
operator|=
name|tdsaFindRightDevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|SataDevice
argument_list|)
expr_stmt|;
name|tdsaDiscoveringStpSATADevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|SataDevice
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaReportPhySataRcvd: siReportPhySataRcvd SMP function return result %x\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASExpanderUpStreamPhyAdd * *  Purpose:  This function adds upstream expander to a specfic phy. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneExpander: Pointer to the expander data. *  \param   phyId: Phy Identifier. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASExpanderUpStreamPhyAdd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|bit8
name|phyId
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
name|bit32
name|hasSet
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderUpStreamPhyAdd: start, phyid %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderUpStreamPhyAdd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderUpStreamPhyAdd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderUpStreamPhyAdd: phyid %d  numOfUpStreamPhys %d\n"
operator|,
name|phyId
operator|,
name|oneExpander
operator|->
name|numOfUpStreamPhys
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|numOfUpStreamPhys
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|upStreamPhys
index|[
name|i
index|]
operator|==
name|phyId
condition|)
block|{
name|hasSet
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|hasSet
operator|==
name|agFALSE
condition|)
block|{
name|oneExpander
operator|->
name|upStreamPhys
index|[
name|oneExpander
operator|->
name|numOfUpStreamPhys
operator|++
index|]
operator|=
name|phyId
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderUpStreamPhyAdd: AFTER phyid %d  numOfUpStreamPhys %d\n"
operator|,
name|phyId
operator|,
name|oneExpander
operator|->
name|numOfUpStreamPhys
operator|)
argument_list|)
expr_stmt|;
comment|/* for debugging */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|numOfUpStreamPhys
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderUpStreamPhyAdd: index %d upstream[index] %d\n"
operator|,
name|i
operator|,
name|oneExpander
operator|->
name|upStreamPhys
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*   just add phys in downstream in configurable expnader */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASExpanderDownStreamPhyAdd * *  Purpose:  This function adds downstream expander to a specfic phy. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneExpander: Pointer to the expander data. *  \param   phyId: Phy Identifier. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSASExpanderDownStreamPhyAdd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|bit8
name|phyId
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
name|bit32
name|hasSet
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderDownStreamPhyAdd: start, phyid %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderDownStreamPhyAdd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderDownStreamPhyAdd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderDownStreamPhyAdd: phyid %d  numOfDownStreamPhys %d\n"
operator|,
name|phyId
operator|,
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|numOfDownStreamPhys
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|downStreamPhys
index|[
name|i
index|]
operator|==
name|phyId
condition|)
block|{
name|hasSet
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|hasSet
operator|==
name|agFALSE
condition|)
block|{
name|oneExpander
operator|->
name|downStreamPhys
index|[
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|++
index|]
operator|=
name|phyId
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderDownStreamPhyAdd: AFTER phyid %d  numOfDownStreamPhys %d\n"
operator|,
name|phyId
operator|,
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|)
argument_list|)
expr_stmt|;
comment|/* for debugging */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|numOfDownStreamPhys
condition|;
name|i
operator|++
control|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASExpanderDownStreamPhyAdd: index %d downstream[index] %d\n"
operator|,
name|i
operator|,
name|oneExpander
operator|->
name|downStreamPhys
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* oneExpander is the configurable expander of interest    phyId is the first phyID in upStreamPhys[0] of downExpander */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  tdsaFindCurrentDownStreamPhyIndex * *  Purpose:  This function finds CurrentDownStreamPhyIndex from a configurable *            expander. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   oneExpander: Pointer to the configuralbe expander data. * *  \return: *           CurrentDownStreamPhyIndex * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit16
name|tdsaFindCurrentDownStreamPhyIndex
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|tdsaExpander_t
modifier|*
name|DownStreamExpander
decl_stmt|;
name|bit16
name|index
init|=
literal|0
decl_stmt|;
name|bit16
name|i
decl_stmt|;
name|bit8
name|phyId
init|=
literal|0
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindCurrentDownStreamPhyIndex: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindCurrentDownStreamPhyIndex: wrong!!! oneExpander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|DownStreamExpander
operator|=
name|oneExpander
operator|->
name|tdCurrentDownStreamExpander
expr_stmt|;
if|if
condition|(
name|DownStreamExpander
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindCurrentDownStreamPhyIndex: wrong!!! DownStreamExpander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindCurrentDownStreamPhyIndex: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindCurrentDownStreamPhyIndex: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindCurrentDownStreamPhyIndex: downstream exp addrHi 0x%08x\n"
operator|,
name|DownStreamExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindCurrentDownStreamPhyIndex: downstream exp addrLo 0x%08x\n"
operator|,
name|DownStreamExpander
operator|->
name|tdDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindCurrentDownStreamPhyIndex: numOfDownStreamPhys %d\n"
operator|,
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|)
argument_list|)
expr_stmt|;
name|phyId
operator|=
name|DownStreamExpander
operator|->
name|upStreamPhys
index|[
literal|0
index|]
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindCurrentDownStreamPhyIndex: phyId %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|numOfDownStreamPhys
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|downStreamPhys
index|[
name|i
index|]
operator|==
name|phyId
condition|)
block|{
name|index
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindCurrentDownStreamPhyIndex: index %d\n"
operator|,
name|index
operator|)
argument_list|)
expr_stmt|;
return|return
name|index
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaPortSASDeviceFind * *  Purpose:  Given SAS address, this function finds a device with that SAS address *            in the device list. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   sasAddrLo: Lower 4 byte of SAS address. *  \param   sasAddrHi: Upper 4 byte of SAS address. * *  \return: *           agNULL  When no device found *           Pointer to device   When device is found * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|tdsaDeviceData_t
modifier|*
name|tdsaPortSASDeviceFind
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|sasAddrLo
parameter_list|,
name|bit32
name|sasAddrHi
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|,
modifier|*
name|RetDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceFind: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|tiRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|onePortContext
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceFind: Full discovery\n"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|sasAddrHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|sasAddrLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceFind: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceFind: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceFind: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|RetDeviceData
operator|=
name|oneDeviceData
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* incremental discovery */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceFind: Incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|sasAddrHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|sasAddrLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceFind: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceFind: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceFind: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|RetDeviceData
operator|=
name|oneDeviceData
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
return|return
name|RetDeviceData
return|;
block|}
end_function

begin_comment
comment|/* include both sas and stp-sata targets*/
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  tdsaPortSASDeviceAdd * *  Purpose:  This function adds the SAS device to the device list. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   sasIdentify: SAS identify address frame. *  \param   sasInitiator: SAS initiator. *  \param   connectionRate: Connection Rate. *  \param   itNexusTimeout: IT NEXUS timeout value. *  \param   firstBurstSize: First Burst Size. *  \param   deviceType: Device Type. * *  \return: *           Pointer to device data. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|tdsaDeviceData_t
modifier|*
name|tdsaPortSASDeviceAdd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|agsaSASIdentify_t
name|sasIdentify
parameter_list|,
name|bit32
name|sasInitiator
parameter_list|,
name|bit8
name|connectionRate
parameter_list|,
name|bit32
name|itNexusTimeout
parameter_list|,
name|bit32
name|firstBurstSize
parameter_list|,
name|bit32
name|deviceType
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneExpDeviceData
parameter_list|,
name|bit8
name|phyID
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit8
name|dev_s_rate
init|=
literal|0
decl_stmt|;
name|bit8
name|sasorsata
init|=
literal|1
decl_stmt|;
comment|//  bit8              devicetype;
name|tdsaSASSubID_t
name|agSASSubID
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneAttachedExpDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: connectionRate %d\n"
operator|,
name|connectionRate
operator|)
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
expr_stmt|;
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|target_ssp_stp_smp
expr_stmt|;
comment|/* old device and already registered to LL; added by link-up event */
if|if
condition|(
name|agFALSE
operator|==
name|tdssNewSASorNot
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|agSASSubID
argument_list|)
condition|)
block|{
comment|/* old device and already registered to LL; added by link-up event */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: OLD qqqq initiator_ssp_stp_smp %d target_ssp_stp_smp %d\n"
operator|,
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|,
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
comment|/* find the old device */
name|oneDeviceData
operator|=
name|tdssNewAddSASToSharedcontext
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|agSASSubID
argument_list|,
name|oneExpDeviceData
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: no more device!!! oneDeviceData is null\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* If a device is allocated */
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|sasIdentify
operator|=
name|sasIdentify
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* parse sasIDframe to fill in agDeviceInfo */
name|DEVINFO_PUT_SMPTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|DEFAULT_SMP_TIMEOUT
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_ITNEXUSTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|itNexusTimeout
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FBS
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|firstBurstSize
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FLAG
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|=
call|(
name|bit8
call|)
argument_list|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
operator|&
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
comment|/* adjusting connectionRate */
name|oneAttachedExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
if|if
condition|(
name|oneAttachedExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|connectionRate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|connectionRate
argument_list|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: 1st connectionRate 0x%x  DEVINFO_GET_LINKRATE(&oneAttachedExpDeviceData->agDeviceInfo) 0x%x\n"
operator|,
name|connectionRate
operator|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: 1st oneAttachedExpDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Device Type, SAS or SATA, connection rate; bit7 --- bit0 */
name|sasorsata
operator|=
operator|(
name|bit8
operator|)
name|deviceType
expr_stmt|;
comment|/* sTSDK spec device typ */
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
operator|(
name|sasorsata
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
name|connectionRate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_DEV_S_RATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|dev_s_rate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
name|oneDeviceData
return|;
block|}
comment|/* old device */
comment|/* new device */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: NEW qqqq initiator_ssp_stp_smp %d target_ssp_stp_smp %d\n"
operator|,
name|agSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|,
name|agSASSubID
operator|.
name|target_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate a new device and set the valid bit */
name|oneDeviceData
operator|=
name|tdssNewAddSASToSharedcontext
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|agSASSubID
argument_list|,
name|oneExpDeviceData
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: no more device!!! oneDeviceData is null\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* If a device is allocated */
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|sasIdentify
operator|=
name|sasIdentify
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* parse sasIDframe to fill in agDeviceInfo */
name|DEVINFO_PUT_SMPTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|DEFAULT_SMP_TIMEOUT
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_ITNEXUSTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|itNexusTimeout
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FBS
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|firstBurstSize
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FLAG
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|=
call|(
name|bit8
call|)
argument_list|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
operator|&
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
comment|/* adjusting connectionRate */
name|oneAttachedExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
if|if
condition|(
name|oneAttachedExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|connectionRate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|connectionRate
argument_list|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: 2nd connectionRate 0x%x  DEVINFO_GET_LINKRATE(&oneAttachedExpDeviceData->agDeviceInfo) 0x%x\n"
operator|,
name|connectionRate
operator|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: 2nd oneAttachedExpDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Device Type, SAS or SATA, connection rate; bit7 --- bit0 */
name|sasorsata
operator|=
operator|(
name|bit8
operator|)
name|deviceType
expr_stmt|;
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
operator|(
name|sasorsata
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
name|connectionRate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_DEV_S_RATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|dev_s_rate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* don't add and register initiator for T2D */
if|if
condition|(
operator|(
operator|(
operator|(
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
operator|&
name|DEVICE_SSP_BIT
operator|)
operator|==
name|DEVICE_SSP_BIT
operator|)
operator|&&
operator|(
operator|(
name|sasIdentify
operator|.
name|target_ssp_stp_smp
operator|&
name|DEVICE_SSP_BIT
operator|)
operator|!=
name|DEVICE_SSP_BIT
operator|)
operator|)
operator|||
operator|(
operator|(
operator|(
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
operator|&
name|DEVICE_STP_BIT
operator|)
operator|==
name|DEVICE_STP_BIT
operator|)
operator|&&
operator|(
operator|(
name|sasIdentify
operator|.
name|target_ssp_stp_smp
operator|&
name|DEVICE_SSP_BIT
operator|)
operator|!=
name|DEVICE_SSP_BIT
operator|)
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: initiator. no add and registration\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPortSASDeviceAdd: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|saRegisterNewDevice
argument_list|(
comment|/* tdsaPortSASDeviceAdd  */
name|onePortContext
operator|->
name|agRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|onePortContext
operator|->
name|agPortContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|oneDeviceData
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDiscoveryResetProcessed * *  Purpose:  This function called to reset "processed flag" of device belong to *            a specified port. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDiscoveryResetProcessed
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaDiscoveryResetProcessed: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* reinitialize the device data belonging to this portcontext */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaDiscoveryResetProcessed: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaDiscoveryResetProcessed: resetting procssed flag\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|processed
operator|=
name|agFALSE
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSATADiscoverDone * *  Purpose:  This function called to finish up SATA discovery. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   flag: status of discovery (success or failure). * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSATADiscoverDone
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATADiscoverDone: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaDiscoveryResetProcessed
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATADiscoverDone: broadcast change; discover again\n"
operator|)
argument_list|)
expr_stmt|;
name|tdssInternalRemovals
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
comment|/* processed broadcast change */
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
operator|&&
name|onePortContext
operator|->
name|discovery
operator|.
name|ResetTriggerred
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSATADiscoverDone: tdsaBCTimer\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaBCTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|TDSA_DISCOVERY_TYPE_SAS
argument_list|,
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_COMPLETED
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_FULL_START
condition|)
block|{
if|if
condition|(
name|flag
operator|==
name|tiSuccess
condition|)
block|{
ifdef|#
directive|ifdef
name|AGTIAPI_CTL
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|&
operator|(
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
operator|)
operator|->
name|tdsaAllShared
decl_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|SASConnectTimeLimit
condition|)
name|tdsaCTLSet
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscOK
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSATADiscoverDone: Error; clean up\n"
operator|)
argument_list|)
expr_stmt|;
name|tdssDiscoveryErrorRemovals
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|flag
operator|==
name|tiSuccess
condition|)
block|{
name|tdssReportChanges
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdssReportRemovals
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|TBD
comment|/* ACKing BC */
name|tdsaAckBC
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tdsaAckBC
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|TBD
comment|/* not yet */
name|agsaEventSource_t
name|eventSource
index|[
name|TD_MAX_NUM_PHYS
index|]
decl_stmt|;
name|bit32
name|HwAckSatus
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|int
name|i
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaAckBC: start\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|BCPhyID
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
comment|/* saHwEventAck() */
name|eventSource
index|[
name|i
index|]
operator|.
name|agPortContext
operator|=
name|onePortContext
operator|->
name|agPortContext
expr_stmt|;
name|eventSource
index|[
name|i
index|]
operator|.
name|event
operator|=
name|OSSA_HW_EVENT_BROADCAST_CHANGE
expr_stmt|;
comment|/* phy ID */
name|eventSource
index|[
name|i
index|]
operator|.
name|param
operator|=
name|i
expr_stmt|;
name|HwAckSatus
operator|=
name|saHwEventAck
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* agContext */
literal|0
argument_list|,
operator|&
name|eventSource
index|[
name|i
index|]
argument_list|,
comment|/* agsaEventSource_t */
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaAckBC: calling saHwEventAck\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HwAckSatus
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaAckBC: failing in saHwEventAck; status %d\n"
operator|,
name|HwAckSatus
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|onePortContext
operator|->
name|BCPhyID
index|[
name|i
index|]
operator|=
name|agFALSE
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SATA_ENABLE
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSATAFullDiscover * *  Purpose:  This function is called to trigger full SATA topology discovery *            within a portcontext. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. * *  \return: *           tiSuccess    Discovery initiated. *           tiError      Discovery could not be initiated at this time. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaSATAFullDiscover
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|tiSuccess
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|deviceType
decl_stmt|;
name|bit8
name|phyRate
init|=
name|SAS_CONNECTION_RATE_3_0G
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
comment|//  tdsaDeviceData_t      *tdsaDeviceData  = (tdsaDeviceData_t *)tdsaAllShared->DeviceMem;
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAFullDiscover: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSATAFullDiscover: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|phyRate
operator|=
name|onePortContext
operator|->
name|LinkRate
expr_stmt|;
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
name|tdsaDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
comment|/*  If port is SATA mode */
comment|/*     Native SATA mode is decided in ossaHWCB() SAS_LINK_UP or SATA_LINK_UP    */
if|if
condition|(
name|onePortContext
operator|->
name|nativeSATAMode
operator|==
name|agTRUE
condition|)
block|{
comment|/* Decode device type */
name|deviceType
operator|=
name|tdssSATADeviceTypeDecode
argument_list|(
name|onePortContext
operator|->
name|remoteSignature
argument_list|)
expr_stmt|;
comment|/* Create a device descriptor for the SATA device attached to the port */
if|if
condition|(
name|deviceType
operator|==
name|SATA_PM_DEVICE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAFullDiscover: Found a PM device\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tdsaPortSATADeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|agNULL
argument_list|,
name|onePortContext
operator|->
name|remoteSignature
argument_list|,
name|agTRUE
argument_list|,
literal|0xF
argument_list|,
name|phyRate
argument_list|,
name|agNULL
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* already added in ossahwcb() in SATA link up */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAFullDiscover: Found a DIRECT SATA device\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process for different device type */
switch|switch
condition|(
name|deviceType
condition|)
block|{
comment|/* if it's PM */
case|case
name|SATA_PM_DEVICE
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAFullDiscover: Process a PM device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* For each port of the PM */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SATA_MAX_PM_PORTS
condition|;
name|i
operator|++
control|)
block|{
comment|/* Read the signature */
comment|/* Decode the device type */
comment|/* Create device descriptor */
comment|/* Callback with the discovered devices */
block|}
break|break;
block|}
comment|/* if it's ATA device */
case|case
name|SATA_ATA_DEVICE
case|:
case|case
name|SATA_ATAPI_DEVICE
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAFullDiscover: Process an ATA device. Sending Identify Device cmd\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* to-check: for this direct attached one, already added and do nothing */
comment|/* no longer, discovery sends sata identify device command */
comment|//tdsaSATAIdentifyDeviceCmdSend(tiRoot, oneDeviceData);
name|tdsaSATADiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiSuccess
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Other devices */
default|default:
block|{
comment|/* callback */
name|TI_DBG3
argument_list|(
operator|(
literal|"siSATAFullDiscover: Process OTHER SATA device. Just report the device\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* If port is SAS mode */
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAFullDiscover: Discovering attached STP devices  starts....\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tdsaFindRightDevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tdsaDeviceData
argument_list|)
expr_stmt|;
name|tdsaDiscoveringStpSATADevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* adding only direct attached SATA such as PM   Other directly attached SATA device such as disk is reported by ossahwcb() in link up   used in sata native mode   */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  tdsaPortSATADeviceAdd * *  Purpose:  This function adds the SATA device to the device list. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneSTPBridge: STP bridge. *  \param   Signature: SATA signature. *  \param   pm: Port Multiplier. *  \param   pmField: Port Multiplier field. *  \param   connectionRate: Connection Rate. * *  \return: *           Pointer to device data. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|tdsaDeviceData_t
modifier|*
name|tdsaPortSATADeviceAdd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneSTPBridge
parameter_list|,
name|bit8
modifier|*
name|Signature
parameter_list|,
name|bit8
name|pm
parameter_list|,
name|bit8
name|pmField
parameter_list|,
name|bit8
name|connectionRate
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneExpDeviceData
parameter_list|,
name|bit8
name|phyID
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|onePortContext
operator|->
name|agRoot
decl_stmt|;
name|bit8
name|dev_s_rate
init|=
literal|0
decl_stmt|;
name|bit8
name|sasorsata
init|=
name|SATA_DEVICE_TYPE
decl_stmt|;
comment|//  bit8                  devicetype = 0;
name|bit8
name|flag
init|=
literal|0
decl_stmt|;
name|bit8
name|TLR
init|=
literal|0
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneAttachedExpDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSATADeviceAdd: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|TD_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|tiRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|onePortContext
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|Signature
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tdssNewAddSATAToSharedcontext
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|onePortContext
argument_list|,
name|agNULL
argument_list|,
name|Signature
argument_list|,
name|pm
argument_list|,
name|pmField
argument_list|,
name|connectionRate
argument_list|,
name|oneExpDeviceData
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPortSATADeviceAdd: no more device!!! oneDeviceData is null\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|flag
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|phyID
operator|<<
literal|4
operator|)
operator||
name|TLR
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SMPTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|DEFAULT_SMP_TIMEOUT
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_ITNEXUSTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|0xFFF
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FBS
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FLAG
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|flag
argument_list|)
expr_stmt|;
comment|/* adjusting connectionRate */
name|oneAttachedExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
if|if
condition|(
name|oneAttachedExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|connectionRate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|connectionRate
argument_list|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSATADeviceAdd: 1st connectionRate 0x%x  DEVINFO_GET_LINKRATE(&oneAttachedExpDeviceData->agDeviceInfo) 0x%x\n"
operator|,
name|connectionRate
operator|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaPortSATADeviceAdd: 1st oneAttachedExpDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Device Type, SAS or SATA, connection rate; bit7 --- bit0*/
comment|//   dev_s_rate = dev_s_rate | (devicetype<< 6);
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
operator|(
name|sasorsata
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
name|connectionRate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_DEV_S_RATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|dev_s_rate
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|sasAddressHi
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|sasAddressLo
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaPortSATADeviceAdd: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaPortSATADeviceAdd: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|saRegisterNewDevice
argument_list|(
comment|/* tdsaPortSATADeviceAdd */
name|onePortContext
operator|->
name|agRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|onePortContext
operator|->
name|agPortContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
name|oneDeviceData
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *! \brief  tdsaFindRightDevice * *  Purpose:  This function returns device-to-be processed. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   tdsaDeviceData: Pointer to the starting device data. * *  \return: *           Pointer to device data. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|tdsaDeviceData_t
modifier|*
name|tdsaFindRightDevice
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
parameter_list|)
block|{
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindHeadDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|tdsaDeviceData
operator|->
name|MainLink
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaDeviceData
operator|->
name|MainLink
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRightDevice: did %d STP %d SATA %d \n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|,
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|tdsaDeviceData
operator|->
name|MainLink
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaDeviceData
operator|->
name|MainLink
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|processed
operator|==
name|agFALSE
operator|)
operator|&&
operator|(
name|SA_IDFRM_IS_STP_TARGET
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SATA_DEVICE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindRightDevice: pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|processed
operator|=
name|agTRUE
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agTRUE
condition|)
block|{
return|return
name|oneDeviceData
return|;
block|}
else|else
block|{
return|return
name|agNULL
return|;
block|}
block|}
end_function

begin_comment
comment|// tdsaDeviceData is head of list
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDiscoveringStpSATADevice * *  Purpose:  For each device in the device list, this function peforms *            SATA discovery. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the heade of device list. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDiscoveringStpSATADevice
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
comment|//  tdsaDeviceData_t      *tdsaDeviceData  = (tdsaDeviceData_t *)tdsaAllShared->DeviceMem;
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveringStpSATADevice: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
name|tdsaDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveringStpSATADevice: Found STP-SATA Device=%p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|SA_IDFRM_IS_SATA_DEVICE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_STP_TARGET
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
operator|&&
operator|(
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_FULL_START
operator|&&
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|||
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
operator|&&
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|tdPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
comment|/* if found an STP bridges */
comment|/* in order to get sata signature and etc */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveringStpSATADevice: sending report phy sata\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaReportPhySataSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|oneDeviceData
operator|->
name|sasIdentify
operator|.
name|phyIdentifier
argument_list|)
expr_stmt|;
comment|//send ID in every discovery? No
if|if
condition|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveringStpSATADevice: sending identify device data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* all internal */
name|status
operator|=
name|tdsaDiscoveryStartIDDev
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* identify device data is not valid */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveringStpSATADevice: fail or busy %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaDiscoveringStpSATADevice: moving to the next\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tdsaFindRightDevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tdsaDeviceData
argument_list|)
expr_stmt|;
name|tdsaDiscoveringStpSATADevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* otherwise, there is no more SATA device found */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveringStpSATADevice: No More Device; SATA discovery finished\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSATADiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiSuccess
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSASIncrementalDiscover * *  Purpose:  This function is called to trigger incremental SAS topology discovery *            within a portcontext. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. * *  \return: *           tiSuccess    Discovery initiated. *           tiError      Discovery could not be initiated at this time. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaSASIncrementalDiscover
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bit8
name|portMaxRate
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSASIncrementalDiscover: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSASIncrementalDiscover: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_STARTED
expr_stmt|;
comment|/* nativeSATAMode is set in ossaHwCB() in link up */
if|if
condition|(
name|onePortContext
operator|->
name|nativeSATAMode
operator|==
name|agFALSE
condition|)
comment|/* default: SAS and SAS/SATA mode */
block|{
if|if
condition|(
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
argument_list|)
operator|==
name|SAS_END_DEVICE
operator|&&
name|SA_IDFRM_IS_SSP_TARGET
argument_list|(
operator|&
name|onePortContext
operator|->
name|sasIDframe
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|TD_MAX_NUM_NOTIFY_SPINUP
condition|;
name|j
operator|++
control|)
block|{
name|saLocalPhyControl
argument_list|(
name|onePortContext
operator|->
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|)
argument_list|,
name|i
argument_list|,
name|AGSA_PHY_NOTIFY_ENABLE_SPINUP
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
block|}
comment|/*       add the device       1. add device in TD layer       2. call saRegisterNewDevice       3. update agDevHandle in ossaDeviceRegistrationCB()     */
name|portMaxRate
operator|=
name|onePortContext
operator|->
name|LinkRate
expr_stmt|;
name|oneDeviceData
operator|=
name|tdsaPortSASDeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|onePortContext
operator|->
name|sasIDframe
argument_list|,
name|agFALSE
argument_list|,
name|portMaxRate
argument_list|,
name|IT_NEXUS_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|agNULL
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
comment|/*           set the timer and wait till the device(directly attached. eg Expander) to be registered.           Then, in tdsaDeviceRegistrationTimerCB(), tdsaSASUpStreamDiscoverStart() is called         */
name|tdsaDeviceRegistrationTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSASUpStreamDiscoverStart
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
comment|/* SATAOnlyMode*/
block|{
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiSuccess
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SATA_ENABLE
end_ifdef

begin_comment
comment|/* For the sake of completness; this is the same as  tdsaSATAFullDiscover*/
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSATAIncrementalDiscover * *  Purpose:  This function is called to trigger incremental SATA topology discovery *            within a portcontext. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. * *  \return: *           tiSuccess    Discovery initiated. *           tiError      Discovery could not be initiated at this time. * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdsaSATAIncrementalDiscover
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|tiSuccess
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|deviceType
decl_stmt|;
name|bit8
name|phyRate
init|=
name|SAS_CONNECTION_RATE_3_0G
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
comment|//  tdsaDeviceData_t      *tdsaDeviceData  = (tdsaDeviceData_t *)tdsaAllShared->DeviceMem;
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAIncrementalDiscover: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSATAIncrementalDiscover: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
name|tdsaDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
comment|/*  If port is SATA mode */
comment|/*     Native SATA mode is decided in ossaHWCB() SAS_LINK_UP or SATA_LINK_UP    */
if|if
condition|(
name|onePortContext
operator|->
name|nativeSATAMode
operator|==
name|agTRUE
condition|)
block|{
comment|/* Decode device type */
name|deviceType
operator|=
name|tdssSATADeviceTypeDecode
argument_list|(
name|onePortContext
operator|->
name|remoteSignature
argument_list|)
expr_stmt|;
comment|/* Create a device descriptor for the SATA device attached to the port */
if|if
condition|(
name|deviceType
operator|==
name|SATA_PM_DEVICE
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAIncrementalDiscover: Found a PM device\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tdsaPortSATADeviceAdd
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|agNULL
argument_list|,
name|onePortContext
operator|->
name|remoteSignature
argument_list|,
name|agTRUE
argument_list|,
literal|0xF
argument_list|,
name|phyRate
argument_list|,
name|agNULL
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* already added in ossahwcb() in SATA link up */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAIncrementalDiscover: Found a DIRECT SATA device\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process for different device type */
switch|switch
condition|(
name|deviceType
condition|)
block|{
comment|/* if it's PM */
case|case
name|SATA_PM_DEVICE
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAIncrementalDiscover: Process a PM device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* For each port of the PM */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SATA_MAX_PM_PORTS
condition|;
name|i
operator|++
control|)
block|{
comment|/* Read the signature */
comment|/* Decode the device type */
comment|/* Create device descriptor */
comment|/* Callback with the discovered devices */
block|}
break|break;
block|}
comment|/* if it's ATA device */
case|case
name|SATA_ATA_DEVICE
case|:
case|case
name|SATA_ATAPI_DEVICE
case|:
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAIncrementalDiscover: Process an ATA device. Sending Identify Device cmd\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* to-check: for this direct attached one, already added and do nothing */
comment|/* no longer, discovery sends sata identify device command */
comment|//tdsaSATAIdentifyDeviceCmdSend(tiRoot, oneDeviceData);
name|tdsaSATADiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiSuccess
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Other devices */
default|default:
block|{
comment|/* callback */
name|TI_DBG3
argument_list|(
operator|(
literal|"siSATAIncrementalDiscover: Process OTHER SATA device. Just report the device\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* If port is SAS mode */
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaSATAIncrementalDiscover: Discovering attached STP devices  starts....\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tdsaFindRightDevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tdsaDeviceData
argument_list|)
expr_stmt|;
name|tdsaDiscoveringStpSATADevice
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/********************  SMP *******************************/
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  tdSMPStart * *  Purpose:  This function sends SMP request. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   agRoot: Pointer to chip/driver Instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   functionCode: SMP function code. *  \param   pSmpBody: Pointer to SMP payload. *  \param   smpBodySize: Size of SMP request without SMP header. *  \param   agRequestType: SPC-specfic request type * *  \return: *           tiSuccess  SMP is sent successfully *           tiError    SMP is not sent successfully * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|tdSMPStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|bit32
name|functionCode
parameter_list|,
name|bit8
modifier|*
name|pSmpBody
parameter_list|,
comment|/* smp payload itself w/o first 4 bytes(header) */
name|bit32
name|smpBodySize
parameter_list|,
comment|/* smp payload size w/o first 4 bytes(header) */
name|bit32
name|agRequestType
parameter_list|,
name|tiIORequest_t
modifier|*
name|CurrentTaskTag
parameter_list|,
name|bit32
name|queueNumber
parameter_list|)
block|{
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|bit32
name|expectedRspLen
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
endif|#
directive|endif
name|tdssSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|agsaSMPFrame_t
modifier|*
name|agSMPFrame
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|tdssSMPFrameHeader_t
name|tdSMPFrameHeader
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|void
modifier|*
name|IndirectSMPReqosMemHandle
decl_stmt|;
name|bit32
name|IndirectSMPReqPhysUpper32
decl_stmt|;
name|bit32
name|IndirectSMPReqPhysLower32
decl_stmt|;
name|bit32
name|IndirectSMPReqmemAllocStatus
decl_stmt|;
name|bit8
modifier|*
name|IndirectSMPReq
decl_stmt|;
name|void
modifier|*
name|IndirectSMPResposMemHandle
decl_stmt|;
name|bit32
name|IndirectSMPRespPhysUpper32
decl_stmt|;
name|bit32
name|IndirectSMPRespPhysLower32
decl_stmt|;
name|bit32
name|IndirectSMPRespmemAllocStatus
decl_stmt|;
name|bit8
modifier|*
name|IndirectSMPResp
decl_stmt|;
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: oneDeviceData %p\n"
operator|,
name|oneDeviceData
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: sasAddressHi 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: sasAddressLo 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: 2nd sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: 2nd sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdSMPStart: Wrong!!! onePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdSMPRequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdSMPStart: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tdSMPRequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdSMPStart: ostiAllocMemory returned NULL tdSMPRequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* saves mem handle for freeing later */
name|tdSMPRequestBody
operator|->
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
comment|/* saves tdsaDeviceData */
name|tdSMPRequestBody
operator|->
name|tdDevice
operator|=
name|oneDeviceData
expr_stmt|;
comment|/* saving port id */
name|tdSMPRequestBody
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
comment|/* save the callback funtion */
name|tdSMPRequestBody
operator|->
name|SMPCompletionFunc
operator|=
name|itdssSMPCompleted
expr_stmt|;
comment|/* in itdcb.c */
comment|/* for simulate warm target reset */
name|tdSMPRequestBody
operator|->
name|CurrentTaskTag
operator|=
name|CurrentTaskTag
expr_stmt|;
comment|/* initializes the number of SMP retries */
name|tdSMPRequestBody
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* debugging */
name|TI_DBG4
argument_list|(
operator|(
literal|"tdSMPStart: SMPRequestbody %p\n"
operator|,
name|tdSMPRequestBody
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"tdSMPStart: callback fn %p\n"
operator|,
name|tdSMPRequestBody
operator|->
name|SMPCompletionFunc
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|agIORequest
operator|=
operator|&
operator|(
name|tdSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdSMPRequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SALL takes care of this */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdSMPRequestBody
operator|->
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSMPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|smpFrame
operator|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: agIORequest %p\n"
operator|,
name|agIORequest
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: SMPRequestbody %p\n"
operator|,
name|tdSMPRequestBody
operator|)
argument_list|)
expr_stmt|;
comment|/*     depending on functionCode, set expectedRspLen in smp   */
switch|switch
condition|(
name|functionCode
condition|)
block|{
case|case
name|SMP_REPORT_GENERAL
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_MANUFACTURE_INFORMATION
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportManufactureInfo_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_DISCOVER
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_PHY_ERROR_LOG
case|:
name|expectedRspLen
operator|=
literal|32
operator|-
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_PHY_SATA
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_ROUTING_INFORMATION
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportRouteTable_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_CONFIGURE_ROUTING_INFORMATION
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_PHY_CONTROL
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_PHY_TEST_FUNCTION
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_PMC_SPECIFIC
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
name|expectedRspLen
operator|=
literal|0
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdSMPStart: error!!! undefined or unused smp function code 0x%x\n"
operator|,
name|functionCode
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tiIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DIRECT_SMP
comment|/* direct SMP with 48 or less payload */
if|if
condition|(
operator|(
name|smpBodySize
operator|+
literal|4
operator|)
operator|<=
name|SMP_DIRECT_PAYLOAD_LIMIT
condition|)
comment|/* 48 */
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: DIRECT smp payload\n"
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|tdSMPRequestBody
operator|->
name|smpPayload
argument_list|,
literal|0
argument_list|,
name|SMP_DIRECT_PAYLOAD_LIMIT
argument_list|)
expr_stmt|;
comment|/* SMP header */
name|tdSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|tdSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|functionCode
expr_stmt|;
name|tdSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0
expr_stmt|;
name|tdSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0
expr_stmt|;
name|osti_memcpy
argument_list|(
name|tdSMPRequestBody
operator|->
name|smpPayload
argument_list|,
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|//    osti_memcpy((tdSMPRequestBody->smpPayload)+4, pSmpBody, smpBodySize);
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|tdSMPRequestBody
operator|->
name|smpPayload
index|[
literal|4
index|]
operator|)
argument_list|,
name|pSmpBody
argument_list|,
name|smpBodySize
argument_list|)
expr_stmt|;
comment|/* direct SMP payload eg) REPORT_GENERAL, DISCOVER etc */
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|tdSMPRequestBody
operator|->
name|smpPayload
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
name|smpBodySize
operator|+
literal|4
expr_stmt|;
comment|/* without last 4 byte crc */
comment|/* to specify DIRECT SMP response */
name|agSMPFrame
operator|->
name|inFrameLen
operator|=
literal|0
expr_stmt|;
comment|/* temporary solution for T2D Combo*/
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|&&
name|defined
argument_list|(
name|TARGET_DRIVER
argument_list|)
comment|/* force smp repsonse to be direct */
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
name|expectedRspLen
expr_stmt|;
endif|#
directive|endif
comment|//    tdhexdump("tdSMPStart", (bit8*)agSMPFrame->outFrameBuf, agSMPFrame->outFrameLen);
comment|//    tdhexdump("tdSMPStart new", (bit8*)tdSMPRequestBody->smpPayload, agSMPFrame->outFrameLen);
comment|//    tdhexdump("tdSMPStart - tdSMPRequestBody", (bit8*)tdSMPRequestBody, sizeof(tdssSMPRequestBody_t));
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: INDIRECT smp payload\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* indirect SMP */
comment|/* allocate Direct SMP request payload */
name|IndirectSMPReqmemAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|IndirectSMPReqosMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|IndirectSMPReq
argument_list|,
operator|&
name|IndirectSMPReqPhysUpper32
argument_list|,
operator|&
name|IndirectSMPReqPhysLower32
argument_list|,
literal|8
argument_list|,
name|smpBodySize
operator|+
literal|4
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|IndirectSMPReqmemAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdSMPStart: ostiAllocMemory failed for indirect SMP request...\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|IndirectSMPReq
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdSMPStart: ostiAllocMemory returned NULL IndirectSMPReq\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* allocate indirect SMP response payload */
name|IndirectSMPRespmemAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|IndirectSMPResposMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|IndirectSMPResp
argument_list|,
operator|&
name|IndirectSMPRespPhysUpper32
argument_list|,
operator|&
name|IndirectSMPRespPhysLower32
argument_list|,
literal|8
argument_list|,
name|expectedRspLen
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|IndirectSMPRespmemAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdSMPStart: ostiAllocMemory failed for indirect SMP reponse...\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|IndirectSMPResp
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdSMPStart: ostiAllocMemory returned NULL IndirectSMPResp\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* saves mem handle for freeing later */
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
operator|=
name|IndirectSMPReqosMemHandle
expr_stmt|;
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
operator|=
name|IndirectSMPResposMemHandle
expr_stmt|;
comment|/* saves Indirect SMP request/repsonse pointer and length for free them later */
name|tdSMPRequestBody
operator|->
name|IndirectSMPReq
operator|=
name|IndirectSMPReq
expr_stmt|;
name|tdSMPRequestBody
operator|->
name|IndirectSMPResp
operator|=
name|IndirectSMPResp
expr_stmt|;
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
operator|=
name|smpBodySize
operator|+
literal|4
expr_stmt|;
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
operator|=
name|expectedRspLen
expr_stmt|;
comment|/* fill in indirect SMP request fields */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: INDIRECT smp payload\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* SMP request and response initialization */
name|osti_memset
argument_list|(
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|IndirectSMPReq
argument_list|,
literal|0
argument_list|,
name|smpBodySize
operator|+
literal|4
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|IndirectSMPResp
argument_list|,
literal|0
argument_list|,
name|expectedRspLen
argument_list|)
expr_stmt|;
comment|/* SMP request header */
name|tdSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|tdSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|functionCode
expr_stmt|;
name|tdSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0
expr_stmt|;
name|tdSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0
expr_stmt|;
name|osti_memcpy
argument_list|(
name|IndirectSMPReq
argument_list|,
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|IndirectSMPReq
operator|+
literal|4
argument_list|,
name|pSmpBody
argument_list|,
name|smpBodySize
argument_list|)
expr_stmt|;
comment|/* Indirect SMP request */
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|agNULL
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameAddrUpper32
operator|=
name|IndirectSMPReqPhysUpper32
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameAddrLower32
operator|=
name|IndirectSMPReqPhysLower32
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
name|smpBodySize
operator|+
literal|4
expr_stmt|;
comment|/* without last 4 byte crc */
comment|/* Indirect SMP response */
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
name|expectedRspLen
expr_stmt|;
name|agSMPFrame
operator|->
name|inFrameLen
operator|=
name|expectedRspLen
expr_stmt|;
comment|/* without last 4 byte crc */
name|agSMPFrame
operator|->
name|inFrameAddrUpper32
operator|=
name|IndirectSMPRespPhysUpper32
expr_stmt|;
name|agSMPFrame
operator|->
name|inFrameAddrLower32
operator|=
name|IndirectSMPRespPhysLower32
expr_stmt|;
endif|#
directive|endif
block|}
else|else
comment|/* SPCv controller */
block|{
comment|/* only direct mode for both request and response */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdSMPStart: DIRECT smp payload\n"
operator|)
argument_list|)
expr_stmt|;
name|agSMPFrame
operator|->
name|flag
operator|=
literal|0
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|tdSMPRequestBody
operator|->
name|smpPayload
argument_list|,
literal|0
argument_list|,
name|SMP_DIRECT_PAYLOAD_LIMIT
argument_list|)
expr_stmt|;
comment|/* SMP header */
name|tdSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|tdSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|functionCode
expr_stmt|;
name|tdSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0
expr_stmt|;
name|tdSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0
expr_stmt|;
name|osti_memcpy
argument_list|(
name|tdSMPRequestBody
operator|->
name|smpPayload
argument_list|,
operator|&
name|tdSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|//    osti_memcpy((tdSMPRequestBody->smpPayload)+4, pSmpBody, smpBodySize);
name|osti_memcpy
argument_list|(
operator|&
operator|(
name|tdSMPRequestBody
operator|->
name|smpPayload
index|[
literal|4
index|]
operator|)
argument_list|,
name|pSmpBody
argument_list|,
name|smpBodySize
argument_list|)
expr_stmt|;
comment|/* direct SMP payload eg) REPORT_GENERAL, DISCOVER etc */
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|tdSMPRequestBody
operator|->
name|smpPayload
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
name|smpBodySize
operator|+
literal|4
expr_stmt|;
comment|/* without last 4 byte crc */
comment|/* to specify DIRECT SMP response */
name|agSMPFrame
operator|->
name|inFrameLen
operator|=
literal|0
expr_stmt|;
comment|/* temporary solution for T2D Combo*/
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|&&
name|defined
argument_list|(
name|TARGET_DRIVER
argument_list|)
comment|/* force smp repsonse to be direct */
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
name|expectedRspLen
expr_stmt|;
endif|#
directive|endif
comment|//    tdhexdump("tdSMPStart", (bit8*)agSMPFrame->outFrameBuf, agSMPFrame->outFrameLen);
comment|//    tdhexdump("tdSMPStart new", (bit8*)tdSMPRequestBody->smpPayload, agSMPFrame->outFrameLen);
comment|//    tdhexdump("tdSMPStart - tdSMPRequestBody", (bit8*)tdSMPRequestBody, sizeof(tdssSMPRequestBody_t));
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdSMPStart: !!! agDevHandle is NULL !!! \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|tdSMPRequestBody
operator|->
name|queueNumber
operator|=
name|queueNumber
expr_stmt|;
name|status
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|queueNumber
argument_list|,
comment|//tdsaAllShared->SMPQNum, //tdsaRotateQnumber(tiRoot, oneDeviceData),
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
comment|/* start SMP timer */
if|if
condition|(
name|functionCode
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|functionCode
operator|==
name|SMP_DISCOVER
operator|||
name|functionCode
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|functionCode
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|tdsaDiscoverySMPTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|functionCode
argument_list|,
name|tdSMPRequestBody
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
comment|/* set timer */
if|if
condition|(
name|functionCode
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|functionCode
operator|==
name|SMP_DISCOVER
operator|||
name|functionCode
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|functionCode
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* only for discovery related SMPs*/
name|tdsaSMPBusyTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPRequestBody
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
elseif|else
if|if
condition|(
name|functionCode
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|tiBusy
return|;
block|}
else|else
block|{
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|tiBusy
return|;
block|}
block|}
else|else
comment|/* AGSA_RC_FAILURE */
block|{
comment|/* discovery failure or task management failure */
if|if
condition|(
name|functionCode
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|functionCode
operator|==
name|SMP_DISCOVER
operator|||
name|functionCode
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|functionCode
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief  tdsaFindLocalLinkRate * *  Purpose:  This function finds local link rate. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   tdsaPortStartInfo: Pointer to the port start information. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit8
name|tdsaFindLocalLinkRate
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortStartInfo_t
modifier|*
name|tdsaPortStartInfo
parameter_list|)
block|{
name|bit8
name|ans
init|=
name|SAS_CONNECTION_RATE_3_0G
decl_stmt|;
comment|/* default */
name|bit32
name|phyProperties
decl_stmt|;
name|phyProperties
operator|=
name|tdsaPortStartInfo
operator|->
name|agPhyConfig
operator|.
name|phyProperties
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindLocalLinkRate: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phyProperties
operator|&
literal|0x4
condition|)
block|{
name|ans
operator|=
name|SAS_CONNECTION_RATE_6_0G
expr_stmt|;
block|}
if|if
condition|(
name|phyProperties
operator|&
literal|0x2
condition|)
block|{
name|ans
operator|=
name|SAS_CONNECTION_RATE_3_0G
expr_stmt|;
block|}
if|if
condition|(
name|phyProperties
operator|&
literal|0x1
condition|)
block|{
name|ans
operator|=
name|SAS_CONNECTION_RATE_1_5G
expr_stmt|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaFindLocalLinkRate: ans 0x%x\n"
operator|,
name|ans
operator|)
argument_list|)
expr_stmt|;
return|return
name|ans
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *! \brief  tdsaConfigureRouteTimer * *  Purpose:  This function sets timers for configuring routing of discovery and *            its callback function. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneExpander: Pointer to the expander. *  \param   ptdSMPDiscoverResp: Pointer to SMP discover repsonse data. * *  \return: *           None * *   \note: called by tdsaDiscoverRespRcvd() * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaConfigureRouteTimer
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|smpRespDiscover_t
modifier|*
name|ptdSMPDiscoverResp
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimer: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimer: onePortContext %p oneExpander %p ptdSMPDiscoverResp %p\n"
operator|,
name|onePortContext
operator|,
name|oneExpander
operator|,
name|ptdSMPDiscoverResp
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimer: discovery %p \n"
operator|,
name|discovery
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimer:  pid %d configureRouteRetries %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|discovery
operator|->
name|configureRouteRetries
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimer: discovery->status %d\n"
operator|,
name|discovery
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|configureRouteTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimer: UsecsPerTick %d\n"
operator|,
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimer: Timervalue %d\n"
operator|,
name|CONFIGURE_ROUTE_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|tdsaSetTimerRequest
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|,
name|CONFIGURE_ROUTE_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
argument_list|,
name|tdsaConfigureRouteTimerCB
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
argument_list|,
operator|(
name|void
operator|*
operator|)
name|oneExpander
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ptdSMPDiscoverResp
argument_list|)
expr_stmt|;
name|tdsaAddTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|Initiator
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaConfigureRouteTimerCB * *  Purpose:  This function is callback function for tdsaConfigureRouteTimer. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   timerData1: Pointer to timer-related data structure *  \param   timerData2: Pointer to timer-related data structure *  \param   timerData3: Pointer to timer-related data structure * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaConfigureRouteTimerCB
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|smpRespDiscover_t
modifier|*
name|ptdSMPDiscoverResp
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|oneExpander
operator|=
operator|(
name|tdsaExpander_t
operator|*
operator|)
name|timerData2
expr_stmt|;
name|ptdSMPDiscoverResp
operator|=
operator|(
name|smpRespDiscover_t
operator|*
operator|)
name|timerData3
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimerCB: onePortContext %p oneExpander %p ptdSMPDiscoverResp %p\n"
operator|,
name|onePortContext
operator|,
name|oneExpander
operator|,
name|ptdSMPDiscoverResp
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimerCB: discovery %p\n"
operator|,
name|discovery
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimerCB: pid %d configureRouteRetries %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|discovery
operator|->
name|configureRouteRetries
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimerCB: discovery.status %d\n"
operator|,
name|discovery
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|configureRouteRetries
operator|++
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|configureRouteRetries
operator|>=
name|DISCOVERY_RETRIES
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimerCB: retries are over\n"
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|configureRouteRetries
operator|=
literal|0
expr_stmt|;
comment|/* failed the discovery */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|configureRouteTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimerCB: proceed by calling tdsaSASDownStreamDiscoverExpanderPhy\n"
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"tdsaConfigureRouteTimerCB"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|ptdSMPDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|configureRouteRetries
operator|=
literal|0
expr_stmt|;
name|tdsaSASDownStreamDiscoverExpanderPhy
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|ptdSMPDiscoverResp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaConfigureRouteTimerCB: setting timer again\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* set the timer again */
name|tdsaSetTimerRequest
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|,
name|CONFIGURE_ROUTE_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
argument_list|,
name|tdsaConfigureRouteTimerCB
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
argument_list|,
operator|(
name|void
operator|*
operator|)
name|oneExpander
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ptdSMPDiscoverResp
argument_list|)
expr_stmt|;
name|tdsaAddTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|Initiator
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|)
expr_stmt|;
block|}
comment|//  tdsaReportGeneralSend(tiRoot, oneDeviceData);
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDiscoveryTimer * *  Purpose:  This function sets timers for discovery and its callback *            function. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDiscoveryTimer
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryTimer: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|discoveryTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|discoveryTimer
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryTimer: UsecsPerTick %d\n"
operator|,
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryTimer: Timervalue %d\n"
operator|,
name|DISCOVERY_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|tdsaSetTimerRequest
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|discoveryTimer
argument_list|,
name|DISCOVERY_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
argument_list|,
name|tdsaDiscoveryTimerCB
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|tdsaAddTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|Initiator
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|discoveryTimer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDiscoveryTimerCB * *  Purpose:  This function is callback function for discovery timer. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   timerData1: Pointer to timer-related data structure *  \param   timerData2: Pointer to timer-related data structure *  \param   timerData3: Pointer to timer-related data structure * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDiscoveryTimerCB
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryTimerCB: resumes discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaReportGeneralSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDeviceRegistrationTimer * *  Purpose:  This function sets timers for device registration in discovery * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. *  \return: *           None * *   \note: called by tdsaSASFullDiscover() or tdsaSASIncrementalDiscover() *          or tdsaDeviceRegistrationTimerCB() * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDeviceRegistrationTimer
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeviceRegistrationTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeviceRegistrationTimer: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|deviceRegistrationTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|deviceRegistrationTimer
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeviceRegistrationTimer: UsecsPerTick %d\n"
operator|,
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeviceRegistrationTimer: Timervalue %d\n"
operator|,
name|DEVICE_REGISTRATION_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|tdsaSetTimerRequest
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|deviceRegistrationTimer
argument_list|,
name|DEVICE_REGISTRATION_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
argument_list|,
name|tdsaDeviceRegistrationTimerCB
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|tdsaAddTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|Initiator
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|deviceRegistrationTimer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDeviceRegistrationTimerCB * *  Purpose:  This function is callback function for tdsaDeviceRegistrationTimer. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   timerData1: Pointer to timer-related data structure *  \param   timerData2: Pointer to timer-related data structure *  \param   timerData3: Pointer to timer-related data structure * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDeviceRegistrationTimerCB
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeviceRegistrationTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|timerData2
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
name|discovery
operator|->
name|deviceRetistrationRetries
operator|++
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|deviceRetistrationRetries
operator|>=
name|DISCOVERY_RETRIES
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeviceRegistrationTimerCB: retries are over\n"
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|deviceRetistrationRetries
operator|=
literal|0
expr_stmt|;
comment|/* failed the discovery */
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|deviceRegistrationTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|deviceRegistrationTimer
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDeviceRegistrationTimerCB: keep retrying\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* start timer for device registration */
name|tdsaDeviceRegistrationTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* go ahead; continue the discovery */
name|discovery
operator|->
name|deviceRetistrationRetries
operator|=
literal|0
expr_stmt|;
name|tdsaSASUpStreamDiscoverStart
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSMPBusyTimer * *  Purpose:  This function sets timers for busy of saSMPStart. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   tdSMPRequestBody: Pointer to the SMP request body. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSMPBusyTimer
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdssSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSMPBusyTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSMPBusyTimer: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|SMPBusyTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|)
expr_stmt|;
block|}
name|tdsaSetTimerRequest
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|,
name|SMP_BUSY_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
argument_list|,
name|tdsaSMPBusyTimerCB
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPRequestBody
argument_list|)
expr_stmt|;
name|tdsaAddTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|Initiator
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSMPBusyTimerCB * *  Purpose:  This function is callback function for SMP busy timer. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   timerData1: Pointer to timer-related data structure *  \param   timerData2: Pointer to timer-related data structure *  \param   timerData3: Pointer to timer-related data structure * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSMPBusyTimerCB
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tdssSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|bit32
name|status
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSMPBusyTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|timerData2
expr_stmt|;
name|tdSMPRequestBody
operator|=
operator|(
name|tdssSMPRequestBody_t
operator|*
operator|)
name|timerData3
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|tdSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdSMPRequestBody
operator|->
name|agSASRequestBody
operator|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|discovery
operator|->
name|SMPRetries
operator|++
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|SMPRetries
operator|<
name|SMP_BUSY_RETRIES
condition|)
block|{
name|status
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|tdsaAllShared
operator|->
name|SMPQNum
argument_list|,
comment|//tdsaRotateQnumber(tiRoot, oneDeviceData),
name|agDevHandle
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|discovery
operator|->
name|SMPRetries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|SMPBusyTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|discovery
operator|->
name|SMPRetries
operator|=
literal|0
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|SMPBusyTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|)
expr_stmt|;
block|}
block|}
else|else
comment|/* AGSA_RC_BUSY */
block|{
if|if
condition|(
name|discovery
operator|->
name|SMPRetries
operator|>=
name|SMP_BUSY_RETRIES
condition|)
block|{
comment|/* done with retris; give up */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSMPBusyTimerCB: retries are over\n"
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|SMPRetries
operator|=
literal|0
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|SMPBusyTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* keep retrying */
name|tdsaSMPBusyTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPRequestBody
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaBCTimer * *  Purpose:  This function sets timers for sending ID device data only for *            directly attached SATA device. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   tdSMPRequestBody: Pointer to the SMP request body. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaBCTimer
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaBCTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|BCTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|BCTimer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|tdsaSetTimerRequest
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|BCTimer
argument_list|,
name|BC_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
argument_list|,
name|tdsaBCTimerCB
argument_list|,
name|onePortContext
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|tdsaAddTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|Initiator
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|BCTimer
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaBCTimerCB * *  Purpose:  This function is callback function for SATA ID device data. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   timerData1: Pointer to timer-related data structure *  \param   timerData2: Pointer to timer-related data structure *  \param   timerData3: Pointer to timer-related data structure * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaBCTimerCB
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaBCTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|discovery
operator|->
name|ResetTriggerred
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|tdsaDiscover
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|TDSA_DISCOVERY_TYPE_SAS
argument_list|,
name|TDSA_DISCOVERY_OPTION_INCREMENTAL_START
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|discovery
operator|->
name|BCTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|BCTimer
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDiscoverySMPTimer * *  Purpose:  This function sets timers for sending discovery-related SMP * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   functionCode: SMP function. *  \param   tdSMPRequestBody: Pointer to the SMP request body. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDiscoverySMPTimer
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|functionCode
parameter_list|,
comment|/* smp function code */
name|tdssSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverySMPTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverySMPTimer: pid %d SMPFn 0x%x\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|functionCode
operator|)
argument_list|)
expr_stmt|;
comment|/* start the SMP timer which works as SMP application timer */
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|DiscoverySMPTimer
argument_list|)
expr_stmt|;
block|}
name|tdsaSetTimerRequest
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|DiscoverySMPTimer
argument_list|,
name|SMP_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
argument_list|,
name|tdsaDiscoverySMPTimerCB
argument_list|,
name|onePortContext
argument_list|,
name|tdSMPRequestBody
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|tdsaAddTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|Initiator
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|DiscoverySMPTimer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDiscoverySMPTimerCB * *  Purpose:  This function is callback function for tdsaDiscoverySMPTimer. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   timerData1: Pointer to timer-related data structure *  \param   timerData2: Pointer to timer-related data structure *  \param   timerData3: Pointer to timer-related data structure * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaDiscoverySMPTimerCB
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|bit8
name|SMPFunction
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|tdssSMPFrameHeader_t
modifier|*
name|tdSMPFrameHeader
decl_stmt|;
name|bit8
name|smpHeader
index|[
literal|4
index|]
decl_stmt|;
endif|#
directive|endif
name|tdssSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
decl_stmt|;
name|tdsaDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agToBeAbortIORequest
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverySMPTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* no retry      if discovery related SMP, fail the discovery      else ....      be sure to abort SMP   */
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|tdSMPRequestBody
operator|=
operator|(
name|tdssSMPRequestBody_t
operator|*
operator|)
name|timerData2
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|oneDeviceData
operator|=
name|tdSMPRequestBody
operator|->
name|tdDevice
expr_stmt|;
name|agToBeAbortIORequest
operator|=
operator|&
operator|(
name|tdSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|SMPFunction
operator|=
name|tdSMPRequestBody
operator|->
name|smpPayload
index|[
literal|1
index|]
expr_stmt|;
else|#
directive|else
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResp
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tdSMPFrameHeader
operator|=
operator|(
name|tdssSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
name|SMPFunction
operator|=
name|tdSMPFrameHeader
operator|->
name|smpFunction
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverySMPTimerCB: SMP function 0x%x\n"
operator|,
name|SMPFunction
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|discovery
operator|->
name|DiscoverySMPTimer
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|SMPFunction
condition|)
block|{
case|case
name|SMP_REPORT_GENERAL
case|:
comment|/* fall through */
case|case
name|SMP_DISCOVER
case|:
comment|/* fall through */
case|case
name|SMP_CONFIGURE_ROUTING_INFORMATION
case|:
comment|/* fall through */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverySMPTimerCB: failing discovery, SMP function 0x%x\n"
operator|,
name|SMPFunction
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
return|return;
case|case
name|SMP_REPORT_PHY_SATA
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverySMPTimerCB: failing discovery, SMP function SMP_REPORT_PHY_SATA\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSATADiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* do nothing */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverySMPTimerCB: Error!!!! not allowed case\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|==
name|agTRUE
condition|)
block|{
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverySMPTimerCB: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverySMPTimerCB: ostiAllocMemory returned NULL tdAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
comment|/* setting callback */
name|tdAbortIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOAbortedHandler
expr_stmt|;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
operator|(
name|tiDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/* SMPAbort - abort one */
name|saSMPAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|0
argument_list|,
comment|/* abort one */
name|agToBeAbortIORequest
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSATAIDDeviceTimer * *  Purpose:  This function sets timers for sending ID device data only for *            directly attached SATA device. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   onePortContext: Pointer to the portal context instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   tdSMPRequestBody: Pointer to the SMP request body. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSATAIDDeviceTimer
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSATAIDDeviceTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SATAIDDeviceTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|SATAIDDeviceTimer
argument_list|)
expr_stmt|;
block|}
name|tdsaSetTimerRequest
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|SATAIDDeviceTimer
argument_list|,
name|SATA_ID_DEVICE_DATA_TIMER_VALUE
operator|/
name|Initiator
operator|->
name|OperatingOption
operator|.
name|UsecsPerTick
argument_list|,
name|tdsaSATAIDDeviceTimerCB
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|tdsaAddTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|Initiator
operator|->
name|timerlist
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|SATAIDDeviceTimer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaSATAIDDeviceTimerCB * *  Purpose:  This function is callback function for SATA ID device data. * *  \param   tiRoot: Pointer to the OS Specific module allocated tiRoot_t *                   instance. *  \param   timerData1: Pointer to timer-related data structure *  \param   timerData2: Pointer to timer-related data structure *  \param   timerData3: Pointer to timer-related data structure * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdsaSATAIDDeviceTimerCB
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaSATAIDDeviceTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|timerData1
expr_stmt|;
comment|/* send identify device data */
name|tdssSubAddSATAToSharedcontext
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SATAIDDeviceTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|SATAIDDeviceTimer
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TD_DISCOVER */
end_comment

end_unit


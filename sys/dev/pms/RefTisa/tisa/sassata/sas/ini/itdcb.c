begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* ** *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE ** ********************************************************************************/
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/** \file  *  * This file contains initiator CB functions  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_comment
comment|/***************************************************************************** *!  \brief  itdssTaskCompleted * *  Purpose: This routine is called to complete an task management request *           previously issued to the LL Layer. All task management completes with *           this function except query task management. * *   \param  agRoot:         Pointer to driver Instance. *   \param  agIORequest:    Pointer to the I/O Request data structure for *                           this I/O. *   \param  agIOStatus:     Status of I/O just completed. *   \param  agIOInfoLen:    Length of the I/O information associated with this *                           I/O request *   \param   agParam        A Handle used to refer to the response frame or handle *                           of abort request *   \param  agOtherInfo        Residual count *   \return:                None * *   \note - This is a initiator specific function called by the jump table. * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssTaskCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tiIORequest_t
modifier|*
name|taskTag
init|=
name|agNULL
decl_stmt|,
modifier|*
name|currentTaskTag
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|TMtdIORequestBody
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|AborttdIORequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agTaskedIORequest
decl_stmt|;
name|agsaSSPResponseInfoUnit_t
name|agSSPRespIU
decl_stmt|;
name|bit8
name|respData
index|[
literal|128
index|]
decl_stmt|;
name|bit32
name|respLen
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|data_status
decl_stmt|;
endif|#
directive|endif
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSSPScsiTaskMgntReq_t
modifier|*
name|agSSPTaskMgntRequest
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|bit32
name|abortOrquery
init|=
name|agTRUE
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssTaskCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
comment|/* check the agIOStatus */
name|currentTaskTag
operator|=
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|CurrentTaskTag
expr_stmt|;
if|if
condition|(
name|currentTaskTag
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: currentTaskTag is NULL \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* as the currentTaskTag is agNULL, shall not call ostiInitiatorEvent */
if|#
directive|if
literal|0
block|ostiInitiatorEvent( tiRoot,                         NULL,                         NULL,                         tiIntrEventTypeTaskManagement,                         tiTMFailed,                         currentTaskTag );
endif|#
directive|endif
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: agIOStatus failed and tiTMFailed\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_TM_TAG_NOT_FOUND
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: agIOStatus OSSA_IO_TM_TAG_NOT_FOUND\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: agIOStatus OSSA_IO_ABORTED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* parse the task management response */
comment|/* reads agsaSSPResponseInfoUnit_t */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|agSSPRespIU
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|data_status
operator|=
name|SA_SSPRESP_GET_DATAPRES
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|respLen
operator|=
name|SA_SSPRESP_GET_RESPONSEDATALEN
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssTaskCompleted: dataPres %d. should be 1\n"
operator|,
name|data_status
operator|)
argument_list|)
expr_stmt|;
comment|/* reads response data */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|,
name|respData
argument_list|,
name|respLen
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssTaskCompleted: res code %d. should be 0\n"
operator|,
name|respData
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|taskTag
operator|=
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|TaskTag
expr_stmt|;
if|if
condition|(
name|taskTag
operator|==
name|agNULL
condition|)
block|{
comment|/* other than Abort Task or Query Task */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: taskTag is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|abortOrquery
operator|=
name|agFALSE
expr_stmt|;
name|TMtdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|currentTaskTag
operator|->
name|tdData
expr_stmt|;
block|}
else|else
block|{
comment|/* Abort Task or Query Task */
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssTaskCompleted: taskTag is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|abortOrquery
operator|=
name|agTRUE
expr_stmt|;
name|TMtdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|currentTaskTag
operator|->
name|tdData
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssTaskCompleted: TMtdIORequestBody %p\n"
operator|,
name|TMtdIORequestBody
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TMtdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: TMtdIORequestBody is NULL \n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agIOInfoLen
operator|==
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: agIOInfoLen is zero, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|agSASRequestBody
operator|=
operator|(
name|agsaSASRequestBody_t
operator|*
operator|)
operator|&
operator|(
name|TMtdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPTaskMgntRequest
operator|=
operator|(
name|agsaSSPScsiTaskMgntReq_t
operator|*
operator|)
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspTaskMgntReq
operator|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssTaskCompleted: agSSPTaskMgntRequest->taskMgntFunction 0x%x\n"
operator|,
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|==
name|AGSA_ABORT_TASK
operator|||
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|==
name|AGSA_QUERY_TASK
operator|)
operator|&&
name|abortOrquery
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: incorrect tasktag, first\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|==
name|AGSA_ABORT_TASK_SET
operator|||
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|==
name|AGSA_CLEAR_TASK_SET
operator|||
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|==
name|AGSA_LOGICAL_UNIT_RESET
operator|||
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|==
name|AGSA_CLEAR_ACA
operator|)
operator|&&
name|abortOrquery
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: incorrect tasktag, second\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|==
name|AGSA_ABORT_TASK
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssTaskCompleted: calling saSSPAbort()\n"
operator|)
argument_list|)
expr_stmt|;
name|AborttdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|taskTag
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|AborttdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: wrong, AborttdIORequestBody is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiDeviceHandle
operator|=
name|AborttdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: wrong, oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: wrong, agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|agTaskedIORequest
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
operator|&
operator|(
name|AborttdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
if|if
condition|(
name|agTaskedIORequest
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: agTaskedIORequest is NULL \n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: ostiAllocMemory returned NULL tdAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* setting callback */
name|tdAbortIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOAbortedHandler
expr_stmt|;
comment|/* setting to NULL because the local abort is triggered by TD layer */
name|tdAbortIORequestBody
operator|->
name|tiIOToBeAbortedRequest
operator|=
name|agNULL
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
name|status
operator|=
name|saSSPAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
literal|0
argument_list|,
name|agTaskedIORequest
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: saSSPAbort failed agIOInfoLen is zero, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*     parse the response and based on the parse,     set the flag   */
if|if
condition|(
name|respData
index|[
literal|3
index|]
operator|==
name|AGSA_TASK_MANAGEMENT_FUNCTION_COMPLETE
operator|||
name|respData
index|[
literal|3
index|]
operator|==
name|AGSA_TASK_MANAGEMENT_FUNCTION_SUCCEEDED
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssTaskCompleted: tiTMOK\n"
operator|)
argument_list|)
expr_stmt|;
name|tiDeviceHandle
operator|=
name|TMtdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: wrong, oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: wrong, agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssTaskCompleted: setting Device state to SA_DS_OPERATIONAL\n"
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMOK
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssTaskCompleted: tiTMFailed\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
block|}
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_comment
comment|/***************************************************************************** *!  \brief  itdssQueryTaskCompleted * *  Purpose: This routine is called to complete an query task management request *           previously issued to the LL Layer. * *   \param  agRoot:         Pointer to driver Instance. *   \param  agIORequest:    Pointer to the I/O Request data structure for *                           this I/O. *   \param  agIOStatus:     Status of I/O just completed. *   \param  agIOInfoLen:    Length of the I/O information associated with this *                           I/O request *   \param   agParam        A Handle used to refer to the response frame or handle *                           of abort request * *   \return:                None * *   \note - This is a initiator specific function called by the jump table. * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssQueryTaskCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tiIORequest_t
modifier|*
name|taskTag
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
name|agNULL
decl_stmt|;
comment|/* query task */
name|tdIORequestBody_t
modifier|*
name|TMtdIORequestBody
init|=
name|agNULL
decl_stmt|;
comment|/* IO being query tasked */
name|agsaIORequest_t
modifier|*
name|agTaskedIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaSSPResponseInfoUnit_t
name|agSSPRespIU
decl_stmt|;
name|bit8
name|respData
index|[
literal|128
index|]
decl_stmt|;
name|bit32
name|respLen
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|data_status
decl_stmt|;
endif|#
directive|endif
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSSPScsiTaskMgntReq_t
modifier|*
name|agSSPTaskMgntRequest
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
init|=
name|agNULL
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssQueryTaskComplted: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* query task management IORequestBody */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
comment|/* OS's tiIORequest for this query taks, which is agNULL */
comment|//currentTaskTag = tdIORequestBody->IOType.InitiatorTMIO.CurrentTaskTag;
comment|/*     currentTaskTag is agNULL for query task since it is generated by     TD layer   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskComplted: agIOStatus failed and tiTMFailed\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* parse the task management response */
comment|/* reads agsaSSPResponseInfoUnit_t */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|agSSPRespIU
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|data_status
operator|=
name|SA_SSPRESP_GET_DATAPRES
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|respLen
operator|=
name|SA_SSPRESP_GET_RESPONSEDATALEN
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: dataPres %d. should be 1\n"
operator|,
name|data_status
operator|)
argument_list|)
expr_stmt|;
comment|/* reads response data */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|,
name|respData
argument_list|,
name|respLen
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: res code %d. should be 0\n"
operator|,
name|respData
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* IO being query tasked */
name|taskTag
operator|=
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|TaskTag
expr_stmt|;
if|if
condition|(
name|taskTag
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskComplted: taskTag is NULL \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* request body of IO being query tasked  */
name|TMtdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|taskTag
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|TMtdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskComplted: TMtdIORequestBody is NULL \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|agTaskedIORequest
operator|=
operator|&
operator|(
name|TMtdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
if|if
condition|(
name|agTaskedIORequest
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskComplted: agTaskedIORequest is NULL \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agIOInfoLen
operator|==
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: agIOInfoLen is zero, wrong\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* this is query task itself */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPTaskMgntRequest
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspTaskMgntReq
operator|)
expr_stmt|;
if|if
condition|(
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|==
name|AGSA_QUERY_TASK
condition|)
block|{
comment|/*       process response for query task       For query task, response code must be either       TASK MANAGEMENT FUNCTION COMPLETE or TASK MANAGEMENT FUNCTION SUCCEEDED by       SAM        1. If TASK MANAGEMENT FUNCTION SUCCEEDE, do nothing        2. If TASK MANAGEMENT FUNCTION COMPLETE and IO is not completed,       retry by saSSPAbort()     */
if|if
condition|(
name|respData
index|[
literal|3
index|]
operator|==
name|AGSA_TASK_MANAGEMENT_FUNCTION_SUCCEEDED
condition|)
block|{
comment|/* OK; IO is being process at the target; do nothing */
block|}
elseif|else
if|if
condition|(
name|respData
index|[
literal|3
index|]
operator|==
name|AGSA_TASK_MANAGEMENT_FUNCTION_COMPLETE
condition|)
block|{
name|tiDeviceHandle
operator|=
name|TMtdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: wrong, oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: wrong, agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* if IO is not completed, retry IO by saSSPAbort() */
if|if
condition|(
name|TMtdIORequestBody
operator|->
name|ioCompleted
operator|!=
name|agTRUE
condition|)
block|{
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: ostiAllocMemory returned NULL tdAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|tdAbortIORequestBody
operator|->
name|tiIOToBeAbortedRequest
operator|=
name|agNULL
expr_stmt|;
comment|/* setting callback */
name|tdAbortIORequestBody
operator|->
name|IOCompletionFunc
operator|=
name|itdssIOAbortedHandler
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: issuing saSSPAbort()\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|saSSPAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
literal|0
argument_list|,
name|agTaskedIORequest
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: saSSPAbort failed agIOInfoLen is zero, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskComplted: not expected response 0x%x\n"
operator|,
name|respData
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssQueryTaskCompleted: not expected task management fn %d\n"
operator|,
name|agSSPTaskMgntRequest
operator|->
name|taskMgntFunction
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* free up allocated memory */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *!  \brief  itssdosIOCompleted * *  Purpose: This routine is called to complete an I/O request previously *           issued to the LL Layer in saSSPStart(). * *   \param  agRoot:       Pointer to driver Instance. *   \param  agIORequest:  Pointer to the I/O Request data structure for *                         this I/O. *   \param  agIOStatus:   Status of I/O just completed. *   \param  agIOInfoLen:  Length of the I/O information associated with this *                         I/O request *   \param   agParam      A Handle used to refer to the response frame or handle *                         of abort request *  \param  agOtherInfo    Residual count *   \return:              None * *   \note - This is a initiator specific function called by the jump table. * *****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|void
name|itdssIOCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|osData
operator|->
name|itdsaIni
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSSPInitiatorRequest_t
modifier|*
name|agSSPInitiatorRequest
init|=
name|agNULL
decl_stmt|;
name|agsaSSPResponseInfoUnit_t
name|agSSPRespIU
decl_stmt|;
name|bit32
name|scsi_status
init|=
literal|0
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssIOCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssIOCompleted: agIOInfoLen %d\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|TD_ASSERT
argument_list|(
operator|(
name|NULL
operator|!=
name|tdIORequestBody
operator|)
argument_list|,
literal|"itdssIOCompleted:tdIORequestBody NULL"
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|tdIORequestBody
condition|)
comment|// handle windows assert case
block|{
return|return;
block|}
name|Initiator
operator|->
name|NumIOsActive
operator|--
expr_stmt|;
ifdef|#
directive|ifdef
name|DBG
if|if
condition|(
name|tdIORequestBody
operator|->
name|ioCompleted
operator|==
name|agTRUE
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
endif|#
directive|endif
comment|/*TD_DEBUG_ENABLE*/
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: Error!!!!!! double completion\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: did %d \n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*TD_DEBUG_ENABLE*/
block|}
if|if
condition|(
name|Initiator
operator|->
name|NumIOsActive
operator|==
literal|0
condition|)
block|{
comment|/* so far, no timer assocaicated here */
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssIOCompleted: no acitve IO's. Kill timers\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tdIORequestBody
operator|->
name|tiIORequest
operator|->
name|osData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: pos 1; "
literal|"tdIORequestBody->tiIORequest->osData is null, wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/*DBG*/
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* Process completion for debugging, printing cbd */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSSPInitiatorRequest
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|sspInitiatorReq
operator|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssIOCompleted: CDB 0x%x\n"
operator|,
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* no respsonse or sense data; data has been processed */
if|if
condition|(
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|)
operator|&&
operator|(
name|agIOInfoLen
operator|==
literal|0
operator|)
condition|)
block|{
comment|// if this is a standard Inquiry command, notify Stoport to set the
comment|// device queue depth to maximize oustanding IO
if|if
condition|(
operator|(
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_INQUIRY
operator|)
operator|&&
operator|(
operator|(
name|agSSPInitiatorRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|1
index|]
operator|&
literal|0x01
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
name|bit32
name|qdepth
init|=
literal|32
decl_stmt|;
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
condition|)
block|{
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SAS_DEVICE
condition|)
block|{
name|qdepth
operator|=
name|MAX_OUTSTANDING_IO_PER_LUN
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
condition|)
block|{
name|qdepth
operator|=
literal|63
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ostiSetDeviceQueueDepth
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|MAX_OUTSTANDING_IO_PER_LUN
argument_list|)
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: failed to call "
literal|"ostiSetDeviceQueueDepth() Q=%d !!!\n"
operator|,
name|qdepth
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOCompleted: set ostiSetDeviceQueueDepth() Q=%d\n"
operator|,
name|qdepth
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|// SCSI command was completed OK, this is the normal path. Now call the
comment|// OS Specific module about this completion.
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssIOCompleted: SUCCESS but data returned \n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssIOCompleted: agIOStatus SUCCESS but data returned 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdIORequestBody
condition|)
block|{
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
condition|)
block|{
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
block|}
block|}
name|osti_memset
argument_list|(
operator|&
name|agSSPRespIU
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|)
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|agSSPRespIU
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|)
expr_stmt|;
name|scsi_status
operator|=
name|agSSPRespIU
operator|.
name|status
expr_stmt|;
switch|switch
condition|(
name|scsi_status
condition|)
block|{
case|case
name|SCSI_STAT_GOOD
case|:
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_GOOD %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|GoodStatus
operator|)
argument_list|)
expr_stmt|;
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|GoodStatus
operator|++
expr_stmt|;
break|break;
case|case
name|SCSI_STAT_CHECK_CONDITION
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_CHECK_CONDITION %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|CheckCondition
operator|)
argument_list|)
expr_stmt|;
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|CheckCondition
operator|++
expr_stmt|;
break|break;
case|case
name|SCSI_STAT_BUSY
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_BUSY %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|BusyStatus
operator|)
argument_list|)
expr_stmt|;
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|BusyStatus
operator|++
expr_stmt|;
break|break;
case|case
name|SCSI_STAT_RESV_CONFLICT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_RESV_CONFLICT %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ResvConflict
operator|)
argument_list|)
expr_stmt|;
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ResvConflict
operator|++
expr_stmt|;
break|break;
case|case
name|SCSI_STAT_TASK_SET_FULL
case|:
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|TaskSetFull
operator|++
expr_stmt|;
comment|//agIOStatus =  OSSA_IO_FAILED;
comment|//agOtherInfo = tiDetailBusy;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_TASK_SET_FULL %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|TaskSetFull
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_STAT_ACA_ACTIVE
case|:
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|AcaActive
operator|++
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_ACA_ACTIVE %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|AcaActive
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_STAT_TASK_ABORTED
case|:
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|TaskAborted
operator|++
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_TASK_ABORTED %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|TaskAborted
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_STAT_CONDITION_MET
case|:
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ConditionMet
operator|++
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_CONDITION_MET %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ConditionMet
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_STAT_INTERMEDIATE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_INTERMEDIATE %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ObsoleteStatus
operator|)
argument_list|)
expr_stmt|;
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ObsoleteStatus
operator|++
expr_stmt|;
break|break;
case|case
name|SCSI_STAT_INTER_CONDIT_MET
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_INTER_CONDIT_MET %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ObsoleteStatus
operator|)
argument_list|)
expr_stmt|;
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ObsoleteStatus
operator|++
expr_stmt|;
break|break;
case|case
name|SCSI_STAT_COMMANDTERMINATED
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: SCSI_STAT_COMMANDTERMINATED %d\n"
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ObsoleteStatus
operator|)
argument_list|)
expr_stmt|;
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ObsoleteStatus
operator|++
expr_stmt|;
break|break;
default|default:
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ObsoleteStatus
operator|++
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: Unknown scsi_status %d 0x%x\n"
operator|,
name|scsi_status
operator|,
name|Initiator
operator|->
name|ScsiStatusCounts
operator|.
name|ObsoleteStatus
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_SUCCESS
case|:
name|itdssIOSuccessHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORTED
case|:
name|itdssIOAbortedHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_UNDERFLOW
case|:
name|itdssIOUnderFlowHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_FAILED
case|:
name|itdssIOFailedHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORT_RESET
case|:
name|itdssIOAbortResetHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_NO_DEVICE
case|:
name|itdssIONoDeviceHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_BREAK
case|:
name|itdssXferErrorBreakHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
case|:
name|itdssXferErrorPhyNotReadyHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
case|:
name|itdssOpenCnxErrorProtocolNotSupprotedHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
case|:
name|itdssOpenCnxErrorZoneViolationHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
case|:
name|itdssOpenCnxErrorBreakHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
case|:
name|itdssOpenCnxErrorITNexusLossHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
case|:
name|itdssOpenCnxErrorBadDestinationHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
case|:
name|itdssOpenCnxErrorConnectionRateNotSupportedHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
case|:
name|itdssOpenCnxErrorWrongDestinationHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
case|:
name|itdssOpenCnxErrorUnknownErrorHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_NAK_RECEIVED
case|:
name|itdssXferErrorNAKReceivedHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_ACK_NAK_TIMEOUT
case|:
name|itdssXferErrorACKNAKTimeoutHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_DMA
case|:
name|itdssXferErrorDMAHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_OFFSET_MISMATCH
case|:
name|itdssXferErrorOffsetMismatchHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
case|:
name|itdssXferOpenRetryTimeoutHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_PORT_IN_RESET
case|:
name|itdssPortInResetHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_NON_OPERATIONAL
case|:
name|itdssDsNonOperationalHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_IN_RECOVERY
case|:
name|itdssDsInRecoveryHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_TM_TAG_NOT_FOUND
case|:
name|itdssTmTagNotFoundHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_SSP_EXT_IU_ZERO_LEN_ERROR
case|:
name|itdssSSPExtIUZeroLenHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_UNEXPECTED_PHASE
case|:
name|itdssXferErrorUnexpectedPhaseHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
comment|//new
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
case|:
name|itdssXferOpenRetryBackoffThresholdReachedHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
case|:
name|itdssOpenCnxErrorItNexusLossOpenTmoHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
case|:
name|itdssOpenCnxErrorItNexusLossNoDestHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
case|:
name|itdssOpenCnxErrorItNexusLossOpenCollideHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
case|:
name|itdssOpenCnxErrorItNexusLossOpenPathwayBlockedHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
comment|// encryption IO error handling
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
case|:
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
case|:
case|case
name|OSSA_IO_XFR_ERROR_CIPHER_MODE_INVALID
case|:
case|case
name|OSSA_IO_XFR_ERROR_DEK_IV_MISMATCH
case|:
case|case
name|OSSA_IO_XFR_ERROR_DEK_RAM_INTERFACE_ERROR
case|:
case|case
name|OSSA_IO_XFR_ERROR_INTERNAL_RAM
case|:
case|case
name|OSSA_IO_XFR_ERROR_DEK_INDEX_OUT_OF_BOUNDS
case|:
name|itdssEncryptionHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
comment|/* DIF IO error handling */
case|case
name|OSSA_IO_XFR_ERROR_DIF_MISMATCH
case|:
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
name|itdssDifHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE
case|:
name|itdssIOResourceUnavailableHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_IO_RQE_BUSY_FULL
case|:
name|itdssIORQEBusyFullHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_INVALID_SSP_RSP_FRAME
case|:
name|itdssXferErrorInvalidSSPRspFrameHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERR_EOB_DATA_OVERRUN
case|:
name|itdssXferErrorEOBDataOverrunHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_OPEN_PREEMPTED
case|:
name|itdssOpenCnxErrorOpenPreemptedHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOCompleted: Unknown agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|itdssIODefaultHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|agOtherInfo
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|TD_DISCOVER
end_ifdef

begin_comment
comment|/***************************************************************************** *!  \brief  itdssSMPCompleted * *  Purpose: This routine is called to complete an SMP request previously *           issued to the LL Layer in saSMPStart(). * *   \param  agRoot:         Pointer to driver Instance. *   \param  agIORequest:    Pointer to the I/O Request data structure for *                           this I/O. *   \param  agIOStatus:     Status of I/O just completed. *   \param  agIOInfoLen:    Length of the I/O information associated with this *                           I/O request *   \param   agFrameHandle  A Handle used to refer to the response frame * *   \return:                None * *   \note - This is a initiator specific function called by the jump table. * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssSMPCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
endif|#
directive|endif
name|tdssSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|agsaSMPFrame_t
modifier|*
name|agSMPFrame
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|CurrentTaskTag
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|oldonePortContext
decl_stmt|;
name|smpReqPhyControl_t
modifier|*
name|smpPhyControlReq
decl_stmt|;
name|bit8
name|smpHeader
index|[
literal|4
index|]
decl_stmt|;
name|tdssSMPFrameHeader_t
modifier|*
name|tdSMPFrameHeader
decl_stmt|;
name|bit8
modifier|*
name|tdSMPPayload
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|bit32
name|status
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|tdssSMPFrameHeader_t
modifier|*
name|tdRequestSMPFrameHeader
decl_stmt|;
name|bit8
name|smpRequestHeader
index|[
literal|4
index|]
decl_stmt|;
endif|#
directive|endif
name|bit8
name|SMPRequestFunction
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"itdssSMPCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdSMPRequestBody
operator|=
operator|(
name|tdssSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|CurrentTaskTag
operator|=
name|tdSMPRequestBody
operator|->
name|CurrentTaskTag
expr_stmt|;
name|oneDeviceData
operator|=
name|tdSMPRequestBody
operator|->
name|tdDevice
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|tdSMPRequestBody
operator|->
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSMPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|smpFrame
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|SMPRequestFunction
operator|=
name|tdSMPRequestBody
operator|->
name|smpPayload
index|[
literal|1
index|]
expr_stmt|;
else|#
directive|else
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResp
argument_list|,
literal|0
argument_list|,
name|smpRequestHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tdRequestSMPFrameHeader
operator|=
operator|(
name|tdssSMPFrameHeader_t
operator|*
operator|)
name|smpRequestHeader
expr_stmt|;
name|SMPRequestFunction
operator|=
name|tdRequestSMPFrameHeader
operator|->
name|smpFunction
expr_stmt|;
endif|#
directive|endif
name|TI_DBG3
argument_list|(
operator|(
literal|"itdssSMPCompleted: agIORequest %p\n"
operator|,
name|agIORequest
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"itdssSMPCompleted: SMPRequestbody %p\n"
operator|,
name|tdSMPRequestBody
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"itdssSMPCompleted: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: Wrong!!! onePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|oldonePortContext
operator|=
name|tdSMPRequestBody
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|oldonePortContext
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"itdssSMPCompleted: old pid %d\n"
operator|,
name|oldonePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: Wrong!!! oldonePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
comment|/* decrement the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|--
expr_stmt|;
comment|/* for port invalid case;      full discovery -> full discovery; incremental discovery -> full discovery    */
if|if
condition|(
name|onePortContext
operator|!=
name|oldonePortContext
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: portcontext has changed!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* stop SMP timer */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* clean up expanders data strucures; move to free exp when device is cleaned */
name|tdsaCleanAllExp
argument_list|(
name|tiRoot
argument_list|,
name|oldonePortContext
argument_list|)
expr_stmt|;
comment|/* remove devices */
name|tdssInternalRemovals
argument_list|(
name|oldonePortContext
operator|->
name|agRoot
argument_list|,
name|oldonePortContext
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* stop SMP timer */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|==
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverAbort
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: not yet abort; non zero pendingSMP %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* stop SMP timer */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tdsaKillTimer
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* the host as of 4/16/08 does not use indirect SMP. So, check only OSSA_IO_SUCCESS status*/
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|//tdhexdump("itdssSMPCompleted", (bit8*)agFrameHandle, agIOInfoLen);
comment|/* parsing SMP payload */
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|#
directive|else
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResp
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|tdSMPFrameHeader
operator|=
operator|(
name|tdssSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
comment|/* SMP function dependent payload */
switch|switch
condition|(
name|tdSMPFrameHeader
operator|->
name|smpFunction
condition|)
block|{
case|case
name|SMP_REPORT_GENERAL
case|:
name|TI_DBG3
argument_list|(
operator|(
literal|"itdssSMPCompleted: report general\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
operator|+
literal|4
operator|&&
name|tdSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|tdsaReportGeneralRespRcvd
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_DISCOVER
case|:
name|TI_DBG3
argument_list|(
operator|(
literal|"itdssSMPCompleted: discover\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
operator|+
literal|4
operator|&&
name|tdSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|tdsaDiscoverRespRcvd
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_PHY_SATA
case|:
name|TI_DBG3
argument_list|(
operator|(
literal|"itdssSMPCompleted: report phy sata\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
operator|+
literal|4
operator|&&
name|tdSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|tdsaSATADiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|tdsaReportPhySataRcvd
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_CONFIGURE_ROUTING_INFORMATION
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: configure routing information\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
literal|4
operator|&&
name|tdSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
literal|4
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|tdsaConfigRoutingInfoRespRcvd
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_PHY_CONTROL
case|:
name|TI_DBG3
argument_list|(
operator|(
literal|"itdssSMPCompleted: phy control\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
literal|4
operator|&&
name|tdSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
comment|/*zero length is expected */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
literal|4
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|tdsaPhyControlRespRcvd
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
comment|//temp for testing
case|case
name|SMP_REPORT_MANUFACTURE_INFORMATION
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: REPORT_MANUFACTURE_INFORMATION\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
sizeof|sizeof
argument_list|(
name|smpRespReportManufactureInfo_t
argument_list|)
operator|+
literal|4
operator|&&
name|tdSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
comment|/*zero length is expected */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
literal|4
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|tdsaReportManInfoRespRcvd
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
comment|//end temp for testing
endif|#
directive|endif
case|case
name|SMP_REPORT_ROUTING_INFORMATION
case|:
case|case
name|SMP_REPORT_PHY_ERROR_LOG
case|:
case|case
name|SMP_PHY_TEST_FUNCTION
case|:
case|case
name|SMP_REPORT_MANUFACTURE_INFORMATION
case|:
case|case
name|SMP_READ_GPIO_REGISTER
case|:
case|case
name|SMP_WRITE_GPIO_REGISTER
case|:
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: wrong SMP function 0x%x\n"
operator|,
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: smpFrameType 0x%x\n"
operator|,
name|tdSMPFrameHeader
operator|->
name|smpFrameType
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: smpFunctionResult 0x%x\n"
operator|,
name|tdSMPFrameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: smpReserved 0x%x\n"
operator|,
name|tdSMPFrameHeader
operator|->
name|smpReserved
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"itdssSMPCompleted: SMP payload"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|agFrameHandle
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_INVALID_LENGTH
condition|)
block|{
comment|/* no retry this case */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: OSSA_IO_ABORTED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ERROR_INTERNAL_SMP_RESOURCE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: OSSA_IO_ERROR_INTERNAL_SMP_RESOURCE\n"
operator|)
argument_list|)
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tdSMPFrameHeader
operator|=
operator|(
name|tdssSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
name|status
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|tdSMPRequestBody
operator|->
name|queueNumber
argument_list|,
comment|//tdsaAllShared->SMPQNum, //tdsaRotateQnumber(tiRoot, oneDeviceData),
name|agDevHandle
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
comment|/* increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* start discovery-related SMP timer */
name|tdsaDiscoverySMPTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|tdSMPFrameHeader
operator|->
name|smpFunction
argument_list|)
argument_list|,
name|tdSMPRequestBody
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
if|if
condition|(
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|tdsaSMPBusyTimer
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPRequestBody
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* For taskmanagement SMP, let's fail task management failure */
name|tdsaPhyControlFailureRespRcvd
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
else|else
block|{       }
block|}
else|else
comment|/* AGSA_RC_FAILURE */
block|{
if|if
condition|(
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* task management failure */
name|tdsaPhyControlFailureRespRcvd
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|tdSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
else|else
block|{       }
block|}
block|}
else|else
block|{
if|if
condition|(
name|tdSMPRequestBody
operator|->
name|retries
operator|<
name|SMP_RETRIES
condition|)
comment|/* 5 */
block|{
comment|/* retry the SMP again */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: failed! but retries %d agIOStatus 0x%x %d agIOInfoLen %d\n"
operator|,
name|tdSMPRequestBody
operator|->
name|retries
operator|,
name|agIOStatus
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdSMPRequestBody
operator|->
name|queueNumber
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|tdSMPRequestBody
operator|->
name|queueNumber
argument_list|,
comment|//tdsaAllShared->SMPQNum, //tdsaRotateQnumber(tiRoot, oneDeviceData),
name|agDevHandle
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|ossaSMPCompleted
argument_list|)
expr_stmt|;
comment|/* increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
name|tdSMPRequestBody
operator|->
name|retries
operator|++
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tdSMPFrameHeader
operator|=
operator|(
name|tdssSMPFrameHeader_t
operator|*
operator|)
name|agSMPFrame
operator|->
name|outFrameBuf
expr_stmt|;
name|tdSMPPayload
operator|=
operator|(
name|bit8
operator|*
operator|)
name|agSMPFrame
operator|->
name|outFrameBuf
operator|+
literal|4
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: failed! no more retry! agIOStatus 0x%x %d\n"
operator|,
name|agIOStatus
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: failed! agIOStatus is OSSA_IO_DS_NON_OPERATIONAL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: failed! agIOStatus is OSSA_IO_DS_IN_RECOVERY\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* discovery failure */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: SMP function 0x%x\n"
operator|,
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: discover done with error\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: SMP_PHY_CONTROL\n"
operator|)
argument_list|)
expr_stmt|;
name|smpPhyControlReq
operator|=
operator|(
name|smpReqPhyControl_t
operator|*
operator|)
name|tdSMPPayload
expr_stmt|;
if|if
condition|(
name|smpPhyControlReq
operator|->
name|phyOperation
operator|==
name|SMP_PHY_CONTROL_CLEAR_AFFILIATION
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: discover done with error\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSASDiscoverDone
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
argument_list|,
name|tiError
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|smpPhyControlReq
operator|->
name|phyOperation
operator|==
name|SMP_PHY_CONTROL_HARD_RESET
operator|||
name|smpPhyControlReq
operator|->
name|phyOperation
operator|==
name|SMP_PHY_CONTROL_LINK_RESET
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: device reset failed\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CurrentTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: callback to OS layer with failure\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* hard reset was not done with this device */
name|oneDeviceData
operator|->
name|ResetCnt
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: unknown phy operation 0x%x\n"
operator|,
name|smpPhyControlReq
operator|->
name|phyOperation
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* SMP_PHY_CONTROL */
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssSMPCompleted: SMP function 0x%x\n"
operator|,
name|tdSMPFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* else */
block|}
comment|/* outer else */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdssSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
name|osGLOBAL
name|void
name|itdssSMPCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
comment|/* pass the payload to OS layer */
name|TI_DBG3
argument_list|(
operator|(
literal|"itdssSMPCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *! \brief itdIoSuccessHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_SUCCESS * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOSuccessHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|osData
operator|->
name|itdsaIni
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaSSPResponseInfoUnit_t
name|agSSPRespIU
decl_stmt|;
name|tiSenseData_t
name|senseData
decl_stmt|;
name|bit8
name|senseDataPayload
index|[
literal|256
index|]
decl_stmt|;
name|bit8
name|respData
index|[
literal|128
index|]
decl_stmt|;
name|bit32
name|scsi_status
decl_stmt|;
name|bit32
name|senseLen
decl_stmt|;
name|bit32
name|respLen
decl_stmt|;
name|bit32
name|data_status
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: agIOInfoLen %d\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/*     agIOInfoLen must be>= sizeof(agsaSSPResponseInfoUnit_t), which is minimum     date length   */
if|if
condition|(
name|agIOInfoLen
operator|<
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: First agIOInfoLen does not match!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: First agIOInfoLen 0x%x IU 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
comment|/* tiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* reads agsaSSPResponseInfoUnit_t */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|agSSPRespIU
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|)
expr_stmt|;
name|data_status
operator|=
name|SA_SSPRESP_GET_DATAPRES
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|scsi_status
operator|=
name|agSSPRespIU
operator|.
name|status
expr_stmt|;
comment|/* endianess is invovled here */
name|senseLen
operator|=
name|SA_SSPRESP_GET_SENSEDATALEN
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|respLen
operator|=
name|SA_SSPRESP_GET_RESPONSEDATALEN
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: dataPres=%x\n"
operator|,
name|data_status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: scsi status=0x%x, senselen=0x%x resplen 0x%x\n"
operator|,
name|scsi_status
operator|,
name|senseLen
operator|,
name|respLen
operator|)
argument_list|)
expr_stmt|;
comment|/*     sanity check: do not go beyond of agIOInfoLen. if happens, return error     agIOInfoLen>= sizeof(agsaSSPResponseInfoUnit_t) + senseLen + respLen -> OK     because frame must be divisible by 4, so there can be extra padding     agIOInfoLen< sizeof(agsaSSPResponseInfoUnit_t) + senseLen + respLen -> NOT OK   */
if|if
condition|(
name|agIOInfoLen
operator|<
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|+
name|senseLen
operator|+
name|respLen
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: Second agIOInfoLen does not match!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: Second agIOInfoLen 0x%x IU 0x%x senselen 0x%x resplen 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|,
name|senseLen
operator|,
name|respLen
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
comment|/* tiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* reads response data */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|,
name|respData
argument_list|,
name|respLen
argument_list|)
expr_stmt|;
comment|/* reads sense data */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|+
name|respLen
argument_list|,
name|senseDataPayload
argument_list|,
name|senseLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_status
operator|==
literal|0
condition|)
block|{
comment|/* NO_DATA */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: no data scsi_status 0x%x\n"
operator|,
name|scsi_status
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
comment|/* tiIORequest */
name|tiIOSuccess
argument_list|,
name|scsi_status
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data_status
operator|==
literal|1
condition|)
block|{
comment|/* RESPONSE_DATA */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: response data \n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
comment|/* tiIORequest */
name|tiIOSuccess
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data_status
operator|==
literal|2
condition|)
block|{
comment|/* SENSE_DATA */
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: sense data \n"
operator|)
argument_list|)
expr_stmt|;
name|senseData
operator|.
name|senseData
operator|=
operator|&
name|senseDataPayload
expr_stmt|;
name|senseData
operator|.
name|senseLen
operator|=
name|MIN
argument_list|(
literal|256
argument_list|,
name|senseLen
argument_list|)
expr_stmt|;
comment|/* debugging */
name|tdhexdump
argument_list|(
literal|"ResponseIU I"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agSSPRespIU
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|)
expr_stmt|;
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"sense data Sense Key 0x%2X ASC(Code) 0x%2X ASCQ(Qualifier) 0x%2X, did 0x%x\n"
operator|,
operator|*
operator|(
name|senseDataPayload
operator|+
literal|2
operator|)
operator|,
operator|*
operator|(
name|senseDataPayload
operator|+
literal|12
operator|)
operator|,
operator|*
operator|(
name|senseDataPayload
operator|+
literal|13
operator|)
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"sense data I"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|senseDataPayload
argument_list|,
name|senseLen
argument_list|)
expr_stmt|;
comment|//    tdhexdump("sense data II", (bit8 *)senseData.senseData, senseData.senseLen);
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_RECOVERED_ERROR
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|SoftError
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_NOT_READY
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|MediumNotReady
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_MEDIUM_ERROR
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|MediumError
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_HARDWARE_ERROR
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|HardwareError
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_ILLEGAL_REQUEST
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|IllegalRequest
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_UNIT_ATTENTION
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|UnitAttention
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_ABORTED_COMMAND
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|AbortCommand
operator|++
expr_stmt|;
block|}
else|else
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|OtherKeyType
operator|++
expr_stmt|;
block|}
comment|/* when ASQ and ASCQ 0x04 0x11, does saLocalPhyControl for notify spinup */
if|if
condition|(
operator|(
name|senseDataPayload
index|[
literal|12
index|]
operator|==
literal|0x04
operator|&&
name|senseDataPayload
index|[
literal|13
index|]
operator|==
literal|0x11
operator|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: sending notfify spinup\n"
operator|)
argument_list|)
expr_stmt|;
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_NOTIFY_SPINUP
condition|;
name|i
operator|++
control|)
block|{
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_NOTIFY_ENABLE_SPINUP
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
comment|/* tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|scsi_status
argument_list|,
operator|&
name|senseData
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data_status
operator|==
literal|3
condition|)
block|{
comment|/* RESERVED */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOSuccessHandler: reserved wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
comment|/* tiIORequest */
name|tiIOFailed
argument_list|,
name|scsi_status
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssIOAbortedHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_ABORTED * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_comment
comment|/* see itdosIOCompleted() and itdinit.c and  itdIoAbortedHandler in itdio.c*/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOAbortedHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOAbortedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_ABORTED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOAbortedHandler: incorrect agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOAbortedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdIORequestBody
operator|!=
name|agNULL
condition|)
block|{
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
block|}
if|if
condition|(
name|tiDeviceHandle
operator|!=
name|agNULL
condition|)
block|{
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOAbortedHandler: did %d \n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOAbortedHandler: oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailAborted
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief itdssIOOverFlowHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OVERFLOW * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOOverFlowHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOOverFlowHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOOverFlowHandler: not transferred byte 0x%x\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOOverRun
argument_list|,
name|agIOInfoLen
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *! \brief itdssIOUnderFlowHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_UNDERFLOW * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOUnderFlowHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssIOUnderFlowHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"itdssIOUnderFlowHandler: agIOInfoLen 0x%x\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|agIOInfoLen
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssIOFailedHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_FAILED * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOFailedHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOFailedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssIOAbortResetHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_ABORT_RESET * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOAbortResetHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOAbortResetHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailAbortReset
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssIONotValidHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_NOT_VALID * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIONotValidHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIONotValidHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailNotValid
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssIONoDeviceHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_NO_DEVICE * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIONoDeviceHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIONoDeviceHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_comment
comment|/* to do: removed from spec */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief itdssIllegalParameterHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_ILLEGAL_PARAMETER * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIllegalParameterHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIllegalParameterHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *! \brief itdssLinkFailureHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_LINK_FAILURE * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssLinkFailureHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssLinkFailureHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssProgErrorHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_PROG_ERROR * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssProgErrorHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssProgErrorHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorBreakHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_BREAK * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorBreakHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferErrorBreakHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorPhyNotReadyHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_PHY_NOT_READY * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorPhyNotReadyHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferErrorPhyNotReadyHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorProtocolNotSupprotedHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorProtocolNotSupprotedHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssOpenCnxErrorProtocolNotSupprotedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorZoneViolationHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorZoneViolationHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssOpenCnxErrorZoneViolationHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorBreakHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_BREAK * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorBreakHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssOpenCnxErrorBreakHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorITNexusLossHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorITNexusLossHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssOpenCnxErrorITNexusLossHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorBadDestinationHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorBadDestinationHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssOpenCnxErrorBadDestinationHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorConnectionRateNotSupportedHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorConnectionRateNotSupportedHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ConnRate
init|=
name|SAS_CONNECTION_RATE_12_0G
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssOpenCnxErrorConnectionRateNotSupportedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* we retry by lowering link rate      retry should be in ossaSetDeviceInfoCB()   */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|RateAdjust
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|ConnRate
operator|=
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConnRate
operator|==
name|SAS_CONNECTION_RATE_1_5G
condition|)
block|{
comment|/* no retry; completes IO */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ConnRate
operator|=
name|ConnRate
operator|-
literal|1
expr_stmt|;
block|}
name|agContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agContext
operator|)
expr_stmt|;
name|agContext
operator|->
name|osData
operator|=
name|agIORequest
expr_stmt|;
name|saSetDeviceInfo
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
literal|32
argument_list|,
name|ConnRate
operator|<<
literal|28
argument_list|,
name|ossaIniSetDeviceInfoCB
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorSTPResourceBusyHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorSTPResourceBusyHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssOpenCnxErrorSTPResourceBusyHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorWrongDestinationHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorWrongDestinationHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssOpenCnxErrorWrongDestinationHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorUnknownErrorHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorUnknownErrorHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssOpenCnxErrorUnknownErrorHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorNAKReceivedHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_NAK_RECEIVED * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorNAKReceivedHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferErrorNAKReceivedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorACKNAKTimeoutHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_ACK_NAK_TIMEOUT * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorACKNAKTimeoutHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferErrorACKNAKTimeoutHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorPeerAbortedHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_PEER_ABORTED * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorPeerAbortedHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferErrorPeerAbortedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorRxFrameHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_RX_FRAME * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorRxFrameHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferErrorRxFrameHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorDMAHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_DMA * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorDMAHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferErrorDMAHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherErrorNoRetry
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorCreditTimeoutHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_CREDIT_TIMEOUT * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorCreditTimeoutHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferErrorCreditTimeoutHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorCMDIssueACKNAKTimeoutHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_CMD_ISSUE_ACK_NAK_TIMEOUT * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorCMDIssueACKNAKTimeoutHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferErrorCMDIssueACKNAKTimeoutHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorCMDIssueBreakBeforeACKNAKHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_CMD_ISSUE_BREAK_BEFORE_ACK_NAK * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorCMDIssueBreakBeforeACKNAKHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferErrorCMDIssueBreakBeforeACKNAKHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorCMDIssuePhyDownBeforeACKNAKHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_CMD_ISSUE_PHY_DOWN_BEFORE_ACK_NAK * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorCMDIssuePhyDownBeforeACKNAKHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferErrorCMDIssuePhyDownBeforeACKNAKHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorDisruptedPhyDownHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_DISRUPTED_PHY_DOWN * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorDisruptedPhyDownHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferErrorDisruptedPhyDownHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorOffsetMismatchHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_OFFSET_MISMATCH * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorOffsetMismatchHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferErrorOffsetMismatchHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorXferZeroDataLenHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_XFER_ZERO_DATA_LEN * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorXferZeroDataLenHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferErrorXferZeroDataLenHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferOpenRetryTimeoutHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_OPEN_RETRY_TIMEOUT * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferOpenRetryTimeoutHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|itdsaIni_t
modifier|*
name|Initiator
init|=
operator|(
name|itdsaIni_t
operator|*
operator|)
name|tdsaAllShared
operator|->
name|itdsaIni
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|saStatus
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferOpenRetryTimeoutHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|tdIORequestBody
operator|->
name|reTries
operator|<
name|OPEN_RETRY_RETRIES
condition|)
comment|/* 10 */
block|{
name|saStatus
operator|=
name|saSSPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|tdIORequestBody
operator|->
name|agRequestType
argument_list|,
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SAS
operator|.
name|agSASRequestBody
operator|)
argument_list|,
name|agNULL
argument_list|,
operator|&
name|ossaSSPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|saStatus
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferOpenRetryTimeoutHandler: retried\n"
operator|)
argument_list|)
expr_stmt|;
name|Initiator
operator|->
name|NumIOsActive
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|++
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferOpenRetryTimeoutHandler: retry failed\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferOpenRetryTimeoutHandler: retry is over and fail\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssXferOpenRetryTimeoutHandler: not valid deivce no retry\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssPortInResetHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_PORT_IN_RESET * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssPortInResetHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssPortInResetHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssDsNonOperationalHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_DS_NON_OPERATIONAL * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssDsNonOperationalHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssDsNonOperationalHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|#
directive|if
literal|1
comment|/* TBD */
comment|/* let's do it only once ????? */
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssDsInRecoveryHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_DS_IN_RECOVERY * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssDsInRecoveryHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssDsInRecoveryHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssTmTagNotFoundHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_TM_TAG_NOT_FOUND * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssTmTagNotFoundHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssTmTagNotFoundHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssSSPExtIUZeroLenHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_SSP_EXT_IU_ZERO_LEN_ERROR * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssSSPExtIUZeroLenHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssSSPExtIUZeroLenHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorUnexpectedPhaseHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERROR_UNEXPECTED_PHASE * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorUnexpectedPhaseHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferErrorUnexpectedPhaseHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_comment
comment|/***************************************************************************** *! \brief itdssIOUnderFlowWithChkConditionHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_UNDERFLOW_WITH_CHK_COND * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \return: None * * *****************************************************************************/
end_comment

begin_comment
comment|/*   How to report SCSI_STAT_CHECK_CONDITION and tiIOUnderRun simultaneoulsy???   ostiInitiatorIOCompleted(                              tiRoot,                              tdIORequestBody->tiIORequest,                              tiIOSuccess,                              SCSI_STAT_CHECK_CONDITION,&senseData,                              agTRUE                              );                   vs    ostiInitiatorIOCompleted (                             tiRoot,                             tdIORequestBody->tiIORequest,                             tiIOUnderRun,                             agIOInfoLen,                             agNULL,                             intContext                             );    For now, SCSI_STAT_CHECK_CONDITION is reported until TISA changes (as of 1/6/09)   In other words, this handler is the practically same as itdssIOSuccessHandler() */
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOUnderFlowWithChkConditionHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaSSPResponseInfoUnit_t
name|agSSPRespIU
decl_stmt|;
name|tiSenseData_t
name|senseData
decl_stmt|;
name|bit8
name|senseDataPayload
index|[
literal|256
index|]
decl_stmt|;
name|bit8
name|respData
index|[
literal|128
index|]
decl_stmt|;
name|bit32
name|scsi_status
decl_stmt|;
name|bit32
name|senseLen
decl_stmt|;
name|bit32
name|respLen
decl_stmt|;
name|bit32
name|data_status
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: agIOInfoLen 0x%x\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/*     agIOInfoLen must be>= sizeof(agsaSSPResponseInfoUnit_t), which is minimum     date length   */
if|if
condition|(
name|agIOInfoLen
operator|<
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: First agIOInfoLen does not match!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: First agIOInfoLen 0x%x IU 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
comment|/* tiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* reads agsaSSPResponseInfoUnit_t */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|agSSPRespIU
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|)
expr_stmt|;
name|data_status
operator|=
name|SA_SSPRESP_GET_DATAPRES
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|scsi_status
operator|=
name|agSSPRespIU
operator|.
name|status
expr_stmt|;
comment|/* endianess is invovled here */
name|senseLen
operator|=
name|SA_SSPRESP_GET_SENSEDATALEN
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|respLen
operator|=
name|SA_SSPRESP_GET_RESPONSEDATALEN
argument_list|(
operator|&
name|agSSPRespIU
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: dataPres=%x\n"
operator|,
name|data_status
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: scsi status=0x%x, senselen=0x%x resplen 0x%x\n"
operator|,
name|scsi_status
operator|,
name|senseLen
operator|,
name|respLen
operator|)
argument_list|)
expr_stmt|;
comment|/*     sanity check: do not go beyond of agIOInfoLen. if happens, return error     agIOInfoLen>= sizeof(agsaSSPResponseInfoUnit_t) + senseLen + respLen -> OK     because frame must be divisible by 4, so there can be extra padding     agIOInfoLen< sizeof(agsaSSPResponseInfoUnit_t) + senseLen + respLen -> NOT OK   */
if|if
condition|(
name|agIOInfoLen
operator|<
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|+
name|senseLen
operator|+
name|respLen
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: Second agIOInfoLen does not match!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: Second agIOInfoLen 0x%x IU 0x%x senselen 0x%x resplen 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|,
name|senseLen
operator|,
name|respLen
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
comment|/* tiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* reads response data */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|,
name|respData
argument_list|,
name|respLen
argument_list|)
expr_stmt|;
comment|/* reads sense data */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
operator|+
name|respLen
argument_list|,
name|senseDataPayload
argument_list|,
name|senseLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_status
operator|==
literal|0
condition|)
block|{
comment|/* NO_DATA */
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: no data\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
comment|/* tiIORequest */
name|tiIOSuccess
argument_list|,
name|scsi_status
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data_status
operator|==
literal|1
condition|)
block|{
comment|/* RESPONSE_DATA */
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: response data \n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
comment|/* tiIORequest */
name|tiIOSuccess
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data_status
operator|==
literal|2
condition|)
block|{
comment|/* SENSE_DATA */
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: sense data \n"
operator|)
argument_list|)
expr_stmt|;
name|senseData
operator|.
name|senseData
operator|=
operator|&
name|senseDataPayload
expr_stmt|;
name|senseData
operator|.
name|senseLen
operator|=
name|MIN
argument_list|(
literal|256
argument_list|,
name|senseLen
argument_list|)
expr_stmt|;
comment|/* debugging */
name|tdhexdump
argument_list|(
literal|"ResponseIU I"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agSSPRespIU
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSSPResponseInfoUnit_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"sense data I"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|senseDataPayload
argument_list|,
name|senseLen
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"sense data II"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|senseData
operator|.
name|senseData
argument_list|,
name|senseData
operator|.
name|senseLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_RECOVERED_ERROR
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|SoftError
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_NOT_READY
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|MediumNotReady
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_MEDIUM_ERROR
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|MediumError
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_HARDWARE_ERROR
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|HardwareError
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_ILLEGAL_REQUEST
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|IllegalRequest
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_UNIT_ATTENTION
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|UnitAttention
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|senseDataPayload
index|[
literal|2
index|]
operator|==
name|SCSI_SENSE_KEY_ABORTED_COMMAND
condition|)
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|AbortCommand
operator|++
expr_stmt|;
block|}
else|else
block|{
name|Initiator
operator|->
name|SenseKeyCounter
operator|.
name|OtherKeyType
operator|++
expr_stmt|;
block|}
comment|/* when ASQ and ASCQ 0x04 0x11, does saLocalPhyControl for notify spinup */
if|if
condition|(
operator|(
name|senseDataPayload
index|[
literal|12
index|]
operator|==
literal|0x04
operator|&&
name|senseDataPayload
index|[
literal|13
index|]
operator|==
literal|0x11
operator|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: sending notfify spinup\n"
operator|)
argument_list|)
expr_stmt|;
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_NOTIFY_SPINUP
condition|;
name|i
operator|++
control|)
block|{
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_NOTIFY_ENABLE_SPINUP
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
comment|/* tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|scsi_status
argument_list|,
operator|&
name|senseData
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data_status
operator|==
literal|3
condition|)
block|{
comment|/* RESERVED */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOUnderFlowWithChkConditionHandler: reserved wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
comment|/* tiIORequest */
name|tiIOFailed
argument_list|,
name|scsi_status
argument_list|,
name|agNULL
argument_list|,
name|agTRUE
comment|/* intContext; is not being used */
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/***************************************************************************** *! \brief itdssXferOpenRetryBackoffThresholdReachedHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = *            OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferOpenRetryBackoffThresholdReachedHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferOpenRetryBackoffThresholdReachedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorItNexusLossOpenTmoHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorItNexusLossOpenTmoHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssOpenCnxErrorItNexusLossOpenTmoHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorItNexusLossNoDestHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorItNexusLossNoDestHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssOpenCnxErrorItNexusLossNoDestHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorItNexusLossOpenCollideHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorItNexusLossOpenCollideHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssOpenCnxErrorItNexusLossOpenCollideHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorItNexusLossOpenPathwayBlockedHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorItNexusLossOpenPathwayBlockedHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssOpenCnxErrorItNexusLossOpenPathwayBlockedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssEncryptionHandler * *  Purpose:  This function processes I/Os completed and returned by SAS lower *            layer with any encryption specific agIOStatus. * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssEncryptionHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|bit32
name|errorDetail
init|=
name|tiDetailOtherError
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssEncryptionHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssEncryptionHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailDekKeyCacheMiss
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_CIPHER_MODE_INVALID
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssEncryptionHandler: OSSA_IO_XFR_ERROR_CIPHER_MODE_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailCipherModeInvalid
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_IV_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_IV_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailDekIVMismatch
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_RAM_INTERFACE_ERROR
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_RAM_INTERFACE_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailDekRamInterfaceError
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_INDEX_OUT_OF_BOUNDS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_INDEX_OUT_OF_BOUNDS\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailDekIndexOutofBounds
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_ILLEGAL_TABLE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_ILLEGAL_TABLE\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailOtherError
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssEncryptionHandler: other error!!! 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailOtherError
expr_stmt|;
break|break;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOEncryptError
argument_list|,
name|errorDetail
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssDifHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with any DIF specific agIOStatus * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssDifHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|bit32
name|errorDetail
init|=
name|tiDetailOtherError
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaDifDetails_t
modifier|*
name|DifDetail
decl_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssDifHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssDifHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|DifDetail
operator|=
operator|(
name|agsaDifDetails_t
operator|*
operator|)
name|agParam
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_XFR_ERROR_DIF_MISMATCH
case|:
name|errorDetail
operator|=
name|tiDetailDifMismatch
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssDifHandler: OSSA_IO_XFR_ERROR_DIF_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
name|errorDetail
operator|=
name|tiDetailDifAppTagMismatch
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssDifHandler: OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
name|errorDetail
operator|=
name|tiDetailDifRefTagMismatch
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssDifHandler: OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
name|errorDetail
operator|=
name|tiDetailDifCrcMismatch
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssDifHandler: OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|errorDetail
operator|=
name|tiDetailOtherError
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssDifHandler: other error!!! 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssDifHandler: DIF detail UpperLBA 0x%08x LowerLBA 0x%08x\n"
operator|,
name|DifDetail
operator|->
name|UpperLBA
operator|,
name|DifDetail
operator|->
name|LowerLBA
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIODifError
argument_list|,
name|errorDetail
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssIOResourceUnavailableHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOResourceUnavailableHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOResourceUnavailableHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIOResourceUnavailableHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailBusy
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssIORQEBusyFullHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_MPI_IO_RQE_BUSY_FULL * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIORQEBusyFullHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIORQEBusyFullHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIORQEBusyFullHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailBusy
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorInvalidSSPRspFrameHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFR_ERROR_INVALID_SSP_RSP_FRAME * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorInvalidSSPRspFrameHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferErrorInvalidSSPRspFrameHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferErrorInvalidSSPRspFrameHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssXferErrorEOBDataOverrunHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_XFER_ERR_EOB_DATA_OVERRUN * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssXferErrorEOBDataOverrunHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferErrorEOBDataOverrunHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssXferErrorEOBDataOverrunHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssOpenCnxErrorOpenPreemptedHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = OSSA_IO_OPEN_CNX_ERROR_OPEN_PREEMPTED * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssOpenCnxErrorOpenPreemptedHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssOpenCnxErrorOpenPreemptedHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssOpenCnxErrorOpenPreemptedHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* default */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief itdssIODefaultHandler * *  Purpose:  This function processes I/Os completed and returned by SAS/SATA lower *            layer with agIOStatus = unspecified * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIODefaultHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIODefaultHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdssIODefaultHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssIOForDebugging1Completed * *  Purpose:  This function is only for debugging. This function should NOT be *            called. * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOForDebugging1Completed
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOForDebugging1Completed: start, error!!! can't be called. \n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssIOForDebugging2Completed * *  Purpose:  This function is only for debugging. This function should NOT be *            called. * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOForDebugging2Completed
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOForDebugging2Completed: start, error!!! can't be called.  \n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdssIOForDebugging3Completed * *  Purpose:  This function is only for debugging. This function should NOT be *            called. * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \param  agOtherInfo        Residual count *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdssIOForDebugging3Completed
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdssIOForDebugging3Completed: start, error!!! can't be called.  \n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/** \file  *  * The file implementing SCSI/ATA Translation (SAT).  * The routines in this file are independent from HW LL API.  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SATA_ENABLE
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sata/host/sat.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sata/host/satproto.h>
end_include

begin_comment
comment|/*****************************************************************************  *! \brief  satIOStart  *  *   This routine is called to initiate a new SCSI request to SATL.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return:  *  *  \e tiSuccess:     I/O request successfully initiated.  *  \e tiBusy:        No resources available, try again later.  *  \e tiIONoDevice:  Invalid device handle.  *  \e tiError:       Other errors that prevent the I/O request to be started.  *  *  *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satIOStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|retVal
init|=
name|tiSuccess
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiLUN_t
modifier|*
name|pLun
decl_stmt|;
name|satInternalIo_t
modifier|*
name|pSatIntIo
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
endif|#
directive|endif
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pLun
operator|=
operator|&
name|scsiCmnd
operator|->
name|lun
expr_stmt|;
comment|/*    * Reject all other LUN other than LUN 0.    */
if|if
condition|(
operator|(
operator|(
name|pLun
operator|->
name|lun
index|[
literal|0
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|1
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|2
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|3
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|4
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|5
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|6
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|7
index|]
operator|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|!=
name|SCSIOPC_INQUIRY
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOStart: *** REJECT *** LUN not zero, cdb[0]=0x%x tiIORequest=%p tiDeviceHandle=%p\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|tiIORequest
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_NOT_SUPPORTED
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|tiSuccess
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satIOStart: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
comment|/* this may happen after tiCOMReset until OS sends inquiry */
if|if
condition|(
name|pSatDevData
operator|->
name|IDDeviceValid
operator|==
name|agFALSE
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|!=
name|SCSIOPC_INQUIRY
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOStart: invalid identify device data did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|tiIONoDevice
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/*    * Check if we need to return BUSY, i.e. recovery in progress    */
if|if
condition|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOStart: IN RECOVERY STATE cdb[0]=0x%x tiIORequest=%p tiDeviceHandle=%p\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|tiIORequest
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOStart: IN RECOVERY STATE did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOStart: device %p satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOStart: device %p satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|tiError
expr_stmt|;
goto|goto
name|ext
goto|;
comment|//    return tiBusy;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_REPORT_LUN
condition|)
block|{
return|return
name|satReportLun
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|satPacket
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
return|;
block|}
block|}
else|else
comment|/* pSatDevData->satDeviceType != SATA_ATAPI_DEVICE */
block|{
comment|/* Parse CDB */
switch|switch
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
condition|)
block|{
case|case
name|SCSIOPC_READ_6
case|:
name|retVal
operator|=
name|satRead6
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_10
case|:
name|retVal
operator|=
name|satRead10
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_12
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_READ_12\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satRead12
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_16
case|:
name|retVal
operator|=
name|satRead16
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_6
case|:
name|retVal
operator|=
name|satWrite6
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_10
case|:
name|retVal
operator|=
name|satWrite10
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_12
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_WRITE_12 \n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satWrite12
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_16
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_WRITE_16\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satWrite16
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_VERIFY_10
case|:
name|retVal
operator|=
name|satVerify10
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_VERIFY_12
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_VERIFY_12\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satVerify12
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_VERIFY_16
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_VERIFY_16\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satVerify16
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_TEST_UNIT_READY
case|:
name|retVal
operator|=
name|satTestUnitReady
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_INQUIRY
case|:
name|retVal
operator|=
name|satInquiry
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_REQUEST_SENSE
case|:
name|retVal
operator|=
name|satRequestSense
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_MODE_SENSE_6
case|:
name|retVal
operator|=
name|satModeSense6
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_MODE_SENSE_10
case|:
name|retVal
operator|=
name|satModeSense10
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_CAPACITY_10
case|:
name|retVal
operator|=
name|satReadCapacity10
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_CAPACITY_16
case|:
name|retVal
operator|=
name|satReadCapacity16
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_REPORT_LUN
case|:
name|retVal
operator|=
name|satReportLun
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_FORMAT_UNIT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_FORMAT_UNIT\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satFormatUnit
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_SEND_DIAGNOSTIC
case|:
comment|/* Table 28, p40 */
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_SEND_DIAGNOSTIC\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satSendDiagnostic
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_START_STOP_UNIT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_START_STOP_UNIT\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satStartStopUnit
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_SAME_10
case|:
comment|/*  sector and LBA; SAT p64 case 3 accessing payload and very                                       inefficient now */
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_WRITE_SAME_10\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satWriteSame10
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_SAME_16
case|:
comment|/* no support due to transfer length(sector count) */
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_WRITE_SAME_16\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satWriteSame16
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_LOG_SENSE
case|:
comment|/* SCT and log parameter(informational exceptions) */
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_LOG_SENSE\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satLogSense
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_MODE_SELECT_6
case|:
comment|/*mode layout and AlloLen check */
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_MODE_SELECT_6\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satModeSelect6
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_MODE_SELECT_10
case|:
comment|/* mode layout and AlloLen check and sharing CB with  satModeSelect6*/
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_MODE_SELECT_10\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satModeSelect10
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_SYNCHRONIZE_CACHE_10
case|:
comment|/* on error what to return, sharing CB with                                            satSynchronizeCache16 */
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_SYNCHRONIZE_CACHE_10\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satSynchronizeCache10
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_SYNCHRONIZE_CACHE_16
case|:
comment|/* on error what to return, sharing CB with                                             satSynchronizeCache16 */
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_SYNCHRONIZE_CACHE_16\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satSynchronizeCache16
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_AND_VERIFY_10
case|:
comment|/* single write and multiple writes */
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_WRITE_AND_VERIFY_10\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satWriteAndVerify10
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_AND_VERIFY_12
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_WRITE_AND_VERIFY_12\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satWriteAndVerify12
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_AND_VERIFY_16
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_WRITE_AND_VERIFY_16\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satWriteAndVerify16
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_MEDIA_SERIAL_NUMBER
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_READ_MEDIA_SERIAL_NUMBER\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satReadMediaSerialNumber
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_BUFFER
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_READ_BUFFER\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satReadBuffer
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_BUFFER
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_WRITE_BUFFER\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satWriteBuffer
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_REASSIGN_BLOCKS
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOStart: SCSIOPC_REASSIGN_BLOCKS\n"
operator|)
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|satReassignBlocks
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Not implemented SCSI cmd, set up error response */
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOStart: unsupported SCSI cdb[0]=0x%x tiIORequest=%p tiDeviceHandle=%p\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|tiIORequest
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|retVal
operator|=
name|tiSuccess
expr_stmt|;
break|break;
block|}
comment|/* end switch  */
block|}
if|if
condition|(
name|retVal
operator|==
name|tiBusy
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOStart: BUSY did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satIOStart: LL is busy or target queue is full\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satIOStart: device %p satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satIOStart: device %p satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|pSatIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
comment|/* interal structure free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|pSatIntIo
argument_list|)
expr_stmt|;
block|}
name|ext
label|:
return|return
name|retVal
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief Setup up the SCSI Sense response.  *  *  This function is used to setup up the Sense Data payload for  *     CHECK CONDITION status.  *  *  \param pSense:      Pointer to the scsiRspSense_t sense data structure.  *  \param SnsKey:      SCSI Sense Key.  *  \param SnsInfo:     SCSI Sense Info.  *  \param SnsCode:     SCSI Sense Code.  *  *  \return: None  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|void
name|satSetSensePayload
parameter_list|(
name|scsiRspSense_t
modifier|*
name|pSense
parameter_list|,
name|bit8
name|SnsKey
parameter_list|,
name|bit32
name|SnsInfo
parameter_list|,
name|bit16
name|SnsCode
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/* for fixed format sense data, SPC-4, p37 */
name|bit32
name|i
decl_stmt|;
name|bit32
name|senseLength
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSetSensePayload: start\n"
operator|)
argument_list|)
expr_stmt|;
name|senseLength
operator|=
sizeof|sizeof
argument_list|(
name|scsiRspSense_t
argument_list|)
expr_stmt|;
comment|/* zero out the data area */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|senseLength
condition|;
name|i
operator|++
control|)
block|{
operator|(
operator|(
name|bit8
operator|*
operator|)
name|pSense
operator|)
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/*    * SCSI Sense Data part of response data    */
name|pSense
operator|->
name|snsRespCode
operator|=
literal|0x70
expr_stmt|;
comment|/*  0xC0 == vendor specific */
comment|/*  0x70 == standard current error */
name|pSense
operator|->
name|senseKey
operator|=
name|SnsKey
expr_stmt|;
comment|/*    * Put sense info in scsi order format    */
name|pSense
operator|->
name|info
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|info
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|info
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|info
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|addSenseLen
operator|=
literal|11
expr_stmt|;
comment|/* fixed size of sense data = 18 */
name|pSense
operator|->
name|addSenseCode
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsCode
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|senseQual
operator|=
call|(
name|bit8
call|)
argument_list|(
name|SnsCode
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/*    * Set pointer in scsi status    */
switch|switch
condition|(
name|SnsKey
condition|)
block|{
comment|/*      * set illegal request sense key specific error in cdb, no bit pointer      */
case|case
name|SCSI_SNSKEY_ILLEGAL_REQUEST
case|:
name|pSense
operator|->
name|skeySpecific
index|[
literal|0
index|]
operator|=
literal|0xC8
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* setting sense data length */
if|if
condition|(
name|satIOContext
operator|!=
name|agNULL
condition|)
block|{
name|satIOContext
operator|->
name|pTiSenseData
operator|->
name|senseLen
operator|=
literal|18
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSetSensePayload: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief Setup up the SCSI Sense response.  *  *  This function is used to setup up the Sense Data payload for  *     CHECK CONDITION status.  *  *  \param pSense:      Pointer to the scsiRspSense_t sense data structure.  *  \param SnsKey:      SCSI Sense Key.  *  \param SnsInfo:     SCSI Sense Info.  *  \param SnsCode:     SCSI Sense Code.  *  *  \return: None  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|void
name|satSetDeferredSensePayload
parameter_list|(
name|scsiRspSense_t
modifier|*
name|pSense
parameter_list|,
name|bit8
name|SnsKey
parameter_list|,
name|bit32
name|SnsInfo
parameter_list|,
name|bit16
name|SnsCode
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/* for fixed format sense data, SPC-4, p37 */
name|bit32
name|i
decl_stmt|;
name|bit32
name|senseLength
decl_stmt|;
name|senseLength
operator|=
sizeof|sizeof
argument_list|(
name|scsiRspSense_t
argument_list|)
expr_stmt|;
comment|/* zero out the data area */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|senseLength
condition|;
name|i
operator|++
control|)
block|{
operator|(
operator|(
name|bit8
operator|*
operator|)
name|pSense
operator|)
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/*    * SCSI Sense Data part of response data    */
name|pSense
operator|->
name|snsRespCode
operator|=
literal|0x71
expr_stmt|;
comment|/*  0xC0 == vendor specific */
comment|/*  0x70 == standard current error */
name|pSense
operator|->
name|senseKey
operator|=
name|SnsKey
expr_stmt|;
comment|/*    * Put sense info in scsi order format    */
name|pSense
operator|->
name|info
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|info
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|info
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|info
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|addSenseLen
operator|=
literal|11
expr_stmt|;
comment|/* fixed size of sense data = 18 */
name|pSense
operator|->
name|addSenseCode
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsCode
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|senseQual
operator|=
call|(
name|bit8
call|)
argument_list|(
name|SnsCode
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/*    * Set pointer in scsi status    */
switch|switch
condition|(
name|SnsKey
condition|)
block|{
comment|/*      * set illegal request sense key specific error in cdb, no bit pointer      */
case|case
name|SCSI_SNSKEY_ILLEGAL_REQUEST
case|:
name|pSense
operator|->
name|skeySpecific
index|[
literal|0
index|]
operator|=
literal|0xC8
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* setting sense data length */
if|if
condition|(
name|satIOContext
operator|!=
name|agNULL
condition|)
block|{
name|satIOContext
operator|->
name|pTiSenseData
operator|->
name|senseLen
operator|=
literal|18
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSetDeferredSensePayload: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for ATAPI Packet Command.  *  *  SAT implementation for ATAPI Packet and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satPacket
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_D2H_PKT
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satPacket: start, SCSI CDB is 0x%X %X %X %X %X %X %X %X %X %X %X %X\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set 1*/
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_PACKET
expr_stmt|;
comment|/* 0xA0 */
if|if
condition|(
name|pSatDevData
operator|->
name|satDMADIRSupport
condition|)
comment|/* DMADIR enabled*/
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
operator|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionIn
operator|)
condition|?
literal|0x04
else|:
literal|0
expr_stmt|;
comment|/* 1 for D2H, 0 for H2D */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
block|}
comment|/* Byte count low and byte count high */
if|if
condition|(
name|scsiCmnd
operator|->
name|expDataLength
operator|>
literal|0xFFFF
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
operator|(
name|bit8
operator|)
name|scsiCmnd
operator|->
name|expDataLength
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|expDataLength
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
block|}
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_PACKET
expr_stmt|;
if|if
condition|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionIn
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_D2H_PKT
expr_stmt|;
block|}
else|else
block|{
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_H2D_PKT
expr_stmt|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/*DMA transfer mode*/
name|fis
operator|->
name|h
operator|.
name|features
operator||=
literal|0x01
expr_stmt|;
block|}
else|else
block|{
comment|/*PIO transfer mode*/
name|fis
operator|->
name|h
operator|.
name|features
operator||=
literal|0x0
expr_stmt|;
block|}
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satPacketCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satPacket: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for satSetFeatures.  *  *  This function creates SetFeatures fis and sends the request to LL layer  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satSetFeatures
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit8
name|bIsDMAMode
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetFeatures: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the Set Features command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x03
expr_stmt|;
comment|/* set transfer mode */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
if|if
condition|(
name|bIsDMAMode
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x45
expr_stmt|;
comment|/*satIOContext->satCompleteCB =&satSetFeaturesDMACB;*/
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x0C
expr_stmt|;
comment|/*satIOContext->satCompleteCB =&satSetFeaturesPIOCB;*/
block|}
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSetFeaturesCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSetFeatures: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI REQUEST SENSE to ATAPI device.  *  *  SAT implementation for SCSI REQUEST SENSE.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satRequestSenseForATAPI
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_D2H_PKT
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|=
name|SCSIOPC_REQUEST_SENSE
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|=
name|SENSE_DATA_LENGTH
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satRequestSenseForATAPI: start, SCSI CDB is 0x%X %X %X %X %X %X %X %X %X %X %X %X\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set 1*/
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_PACKET
expr_stmt|;
comment|/* 0xA0 */
if|if
condition|(
name|pSatDevData
operator|->
name|satDMADIRSupport
condition|)
comment|/* DMADIR enabled*/
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
operator|(
name|tiScsiRequest
operator|->
name|dataDirection
operator|==
name|tiDirectionIn
operator|)
condition|?
literal|0x04
else|:
literal|0
expr_stmt|;
comment|/* 1 for D2H, 0 for H2D */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
block|}
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0x20
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
call|(
name|bit32
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_PACKET
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_D2H_PKT
expr_stmt|;
comment|//if (pSatDevData->sat48BitSupport == agTRUE)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator||=
literal|0x01
expr_stmt|;
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator||=
literal|0x0
expr_stmt|;
block|}
block|}
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satRequestSenseForATAPICB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRequestSenseForATAPI: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for satDeviceReset.  *  *  This function creates DEVICE RESET fis and sends the request to LL layer  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satDeviceReset
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satDeviceReset: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the  Execute Device Diagnostic command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_DEVICE_RESET
expr_stmt|;
comment|/* 0x90 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DEV_RESET
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satDeviceResetCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satDeviceReset: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for saExecuteDeviceDiagnostic.  *  *  This function creates Execute Device Diagnostic fis and sends the request to LL layer  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satExecuteDeviceDiagnostic
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satExecuteDeviceDiagnostic: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the  Execute Device Diagnostic command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_EXECUTE_DEVICE_DIAGNOSTIC
expr_stmt|;
comment|/* 0x90 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satExecuteDeviceDiagnosticCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satExecuteDeviceDiagnostic: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI READ10.  *  *  SAT implementation for SCSI READ10 and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satRead10
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_READ
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|4
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: pSatDevData=%p\n"
operator|,
name|pSatDevData
operator|)
argument_list|)
expr_stmt|;
comment|//  tdhexdump("satRead10", (bit8 *)scsiCmnd->cdb, 10);
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead10: return FUA_NV\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead10: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit32
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
comment|/* cbd10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: lba %d functioned lba %d\n"
operator|,
name|lba
operator|,
name|satComputeCDB10LBA
argument_list|(
name|satIOContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: lba 0x%x functioned lba 0x%x\n"
operator|,
name|lba
operator|,
name|satComputeCDB10LBA
argument_list|(
name|satIOContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: tl %d functioned tl %d\n"
operator|,
name|tl
operator|,
name|satComputeCDB10TL
argument_list|(
name|satIOContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead10: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead10: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
operator|!
name|rangeChk
condition|)
comment|//  if (lba + tl<= SAT_TR_LBA_LIMIT)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* READ DMA*/
comment|/* in case that we can't fit the transfer length,          we need to make it fit by sending multiple ATA cmnds */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA
expr_stmt|;
comment|/* 0xC8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* READ MULTIPLE or READ SECTOR(S) */
comment|/* READ SECTORS for easier implemetation */
comment|/* in case that we can't fit the transfer length,          we need to make it fit by sending multiple ATA cmnds */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* READ DMA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
comment|/* 0x25 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* READ MULTIPLE EXT or READ SECTOR(S) EXT or READ VERIFY SECTOR(S) EXT*/
comment|/* READ SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ10_FUA_MASK
condition|)
block|{
comment|/* for now, no support for FUA */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satRead10: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use READ FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x60 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
block|}
comment|//  tdhexdump("satRead10 final fis", (bit8 *)fis, sizeof(agsaFisRegHostToDevice_t));
comment|/* saves the current LBA and orginal TL */
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUED */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead10: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead10: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satRead_1.  *  *  SAT implementation for SCSI satRead_1  *  Sub function of satRead10  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*  * as a part of loop for read10  */
end_comment

begin_function
name|GLOBAL
name|bit32
name|satRead_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     Assumption: error check on lba and tl has been done in satRead*()     lba = lba + tl;   */
name|bit32
name|status
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|agNULL
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_READ
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|DenomTL
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|Remainder
init|=
literal|0
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
comment|/* 0 MSB, 3 LSB */
name|TI_DBG2
argument_list|(
operator|(
literal|"satRead_1: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_DMA
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_READ_SECTORS
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_READ_DMA_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_READ_SECTORS_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_READ_FPDMA_QUEUED
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead_1: error incorrect ata command 0x%x\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
name|Remainder
operator|=
name|satOrgIOContext
operator|->
name|OrgTL
operator|%
name|DenomTL
expr_stmt|;
name|satOrgIOContext
operator|->
name|currentLBA
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
operator|+
name|DenomTL
expr_stmt|;
name|lba
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
expr_stmt|;
name|LBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF0
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0xF
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_DMA
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA
expr_stmt|;
comment|/* 0xC8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
break|break;
case|case
name|SAT_READ_SECTORS
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
break|break;
case|case
name|SAT_READ_DMA_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
comment|/* 0x25 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
break|break;
case|case
name|SAT_READ_SECTORS_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
break|break;
case|case
name|SAT_READ_FPDMA_QUEUED
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x60 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_READ
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead_1: error incorrect ata command 0x%x\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
comment|/* Initialize CB for SATA completion.    */
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedDataIOCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead_1: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI READ12.  *  *  SAT implementation for SCSI READ12 and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satRead12
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_READ
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|4
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead12: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead12: return FUA_NV\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satRead12: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit32
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
name|lba
operator|=
name|satComputeCDB12LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|satComputeCDB12TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead12: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead12: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
operator|!
name|rangeChk
condition|)
comment|//  if (lba + tl<= SAT_TR_LBA_LIMIT)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* READ DMA*/
comment|/* in case that we can't fit the transfer length,          we need to make it fit by sending multiple ATA cmnds */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead12: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA
expr_stmt|;
comment|/* 0xC8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* READ MULTIPLE or READ SECTOR(S) */
comment|/* READ SECTORS for easier implemetation */
comment|/* can't fit the transfer length but need to make it fit by sending multiple*/
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead12: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* READ DMA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead12: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
comment|/* 0x25 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* READ MULTIPLE EXT or READ SECTOR(S) EXT or READ VERIFY SECTOR(S) EXT*/
comment|/* READ SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead12: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ12_FUA_MASK
condition|)
block|{
comment|/* for now, no support for FUA */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead12: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satRead12: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use READ FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x60 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ12_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
block|}
comment|/* saves the current LBA and orginal TL */
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead12: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead12: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead12: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI READ16.  *  *  SAT implementation for SCSI READ16 and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satRead16
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_READ
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|bit32
name|limitChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead16: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead16: return FUA_NV\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead16: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit64
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
name|limitChk
operator|=
name|satCompareLBALimitbit
argument_list|(
name|LBA
argument_list|)
expr_stmt|;
name|lba
operator|=
name|satComputeCDB16LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|satComputeCDB16TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|limitChk
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead16: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead16: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
operator|!
name|rangeChk
condition|)
comment|//  if (lba + tl<= SAT_TR_LBA_LIMIT)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* READ DMA*/
comment|/* in case that we can't fit the transfer length,          we need to make it fit by sending multiple ATA cmnds */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead16: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA
expr_stmt|;
comment|/* 0xC8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* READ MULTIPLE or READ SECTOR(S) */
comment|/* READ SECTORS for easier implemetation */
comment|/* can't fit the transfer length but need to make it fit by sending multiple*/
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead16: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* READ DMA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead16: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
comment|/* 0x25 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* READ MULTIPLE EXT or READ SECTOR(S) EXT or READ VERIFY SECTOR(S) EXT*/
comment|/* READ SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead16: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ16_FUA_MASK
condition|)
block|{
comment|/* for now, no support for FUA */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead16: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satRead16: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use READ FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x60 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ16_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
block|}
comment|/* saves the current LBA and orginal TL */
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead16: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead16: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead16: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI READ6.  *  *  SAT implementation for SCSI READ6 and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satRead6
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_READ
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit16
name|tl
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead6: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* no FUA checking since read6 */
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satRead6: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* cbd6; computing LBA and transfer length */
name|lba
operator|=
operator|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
operator|)
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|tl
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satRead6: return LBA out of range\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
name|lba
operator|+
name|tl
operator|<=
name|SAT_TR_LBA_LIMIT
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* READ DMA*/
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead6: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA
expr_stmt|;
comment|/* 0xC8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* temporary fix */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xff
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* READ SECTORS for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead6: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* temporary fix */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xff
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* READ DMA EXT only */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead6: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
comment|/* 0x25 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* READ SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead6: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
comment|/* sanity check */
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead6: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satRead6: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use READ FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x60 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_READ
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedDataIOCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI WRITE16.  *  *  SAT implementation for SCSI WRITE16 and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWrite16
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|bit32
name|limitChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite16: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite16: return FUA_NV\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite16: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit64
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
name|limitChk
operator|=
name|satCompareLBALimitbit
argument_list|(
name|LBA
argument_list|)
expr_stmt|;
name|lba
operator|=
name|satComputeCDB16LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|satComputeCDB16TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED   */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|limitChk
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite16: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite16: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
operator|!
name|rangeChk
condition|)
comment|//  if (lba + tl<= SAT_TR_LBA_LIMIT)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* In case that we can't fit the transfer length, we loop */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite16: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* In case that we can't fit the transfer length, we loop */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite16: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite16: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite16: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite16: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satWrite16: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE16_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite16: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite16: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI WRITE12.  *  *  SAT implementation for SCSI WRITE12 and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWrite12
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|4
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite12: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite12: return FUA_NV\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite12: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit32
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
name|lba
operator|=
name|satComputeCDB12LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|satComputeCDB12TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite12: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite12: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
operator|!
name|rangeChk
condition|)
comment|//  if (lba + tl<= SAT_TR_LBA_LIMIT)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* In case that we can't fit the transfer length, we loop */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite12: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* In case that we can't fit the transfer length, we loop */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite12: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite12: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite12: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite12: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satWrite12: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE12_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite12: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite12: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI WRITE10.  *  *  SAT implementation for SCSI WRITE10 and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWrite10
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|4
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite10: return FUA_NV\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite10: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit32
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
comment|/* cbd10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite10: lba %d functioned lba %d\n"
operator|,
name|lba
operator|,
name|satComputeCDB10LBA
argument_list|(
name|satIOContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite10: tl %d functioned tl %d\n"
operator|,
name|tl
operator|,
name|satComputeCDB10TL
argument_list|(
name|satIOContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite10: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite10: cdb 0x%x 0x%x 0x%x 0x%x\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite10: lba 0x%x SAT_TR_LBA_LIMIT 0x%x\n"
operator|,
name|lba
operator|,
name|SAT_TR_LBA_LIMIT
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite10: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
operator|!
name|rangeChk
condition|)
comment|//  if (lba + tl<= SAT_TR_LBA_LIMIT)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* can't fit the transfer length */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite10: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* can't fit the transfer length */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite10: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite10: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite10: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite10: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satWrite10: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
comment|//  tdhexdump("satWrite10 final fis", (bit8 *)fis, sizeof(agsaFisRegHostToDevice_t));
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite10: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite10: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWrite_1.  *  *  SAT implementation for SCSI WRITE10 and send FIS request to LL layer.  *  This is used when WRITE10 is divided into multiple ATA commands  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWrite_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     Assumption: error check on lba and tl has been done in satWrite*()     lba = lba + tl;   */
name|bit32
name|status
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|agNULL
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|DenomTL
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|Remainder
init|=
literal|0
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
comment|/* 0 MSB, 3 LSB */
name|TI_DBG2
argument_list|(
operator|(
literal|"satWrite_1: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_WRITE_DMA
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_FUA_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite_1: error incorrect ata command 0x%x\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
name|Remainder
operator|=
name|satOrgIOContext
operator|->
name|OrgTL
operator|%
name|DenomTL
expr_stmt|;
name|satOrgIOContext
operator|->
name|currentLBA
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
operator|+
name|DenomTL
expr_stmt|;
name|lba
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
expr_stmt|;
name|LBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF0
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0xF
argument_list|)
expr_stmt|;
comment|/* LSB */
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_WRITE_DMA
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x3D */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
empty_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite_1: error incorrect ata command 0x%x\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
comment|/* Initialize CB for SATA completion.    */
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedDataIOCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite_1: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI WRITE6.  *  *  SAT implementation for SCSI WRITE6 and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWrite6
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit16
name|tl
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite6: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite6: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* cbd6; computing LBA and transfer length */
name|lba
operator|=
operator|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
operator|)
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|tl
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite6: return LBA out of range\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
name|lba
operator|+
name|tl
operator|<=
name|SAT_TR_LBA_LIMIT
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite6: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* temporary fix */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xff
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE SECTORS for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite6: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* temporary fix */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xff
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT only */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite6: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite6: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
comment|/* sanity check */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite6: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satWrite6: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedDataIOCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI TEST UNIT READY.  *  *  SAT implementation for SCSI TUR and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satTestUnitReady
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satTestUnitReady: entry tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReady: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* SAT revision 8, 8.11.2, p42*/
if|if
condition|(
name|pSatDevData
operator|->
name|satStopState
operator|==
name|agTRUE
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_INITIALIZING_COMMAND_REQUIRED
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReady: stop state\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*    * Check if format is in progress    */
if|if
condition|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_FORMAT_IN_PROGRESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReady() FORMAT_IN_PROGRESS  tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_FORMAT_IN_PROGRESS
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReady: format in progress\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*     check previously issued ATA command   */
if|if
condition|(
name|pSatDevData
operator|->
name|satPendingIO
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceFaultState
operator|==
name|agTRUE
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReady: previous command ended in error\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/*     check removalbe media feature set    */
if|if
condition|(
name|pSatDevData
operator|->
name|satRemovableMedia
operator|&&
name|pSatDevData
operator|->
name|satRemovableMediaEnabled
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satTestUnitReady: sending get media status cmnd\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* send GET MEDIA STATUS command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_GET_MEDIA_STATUS
expr_stmt|;
comment|/* 0xDA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satTestUnitReadyCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/*     number 6) in SAT p42     send ATA CHECK POWER MODE   */
name|TI_DBG5
argument_list|(
operator|(
literal|"satTestUnitReady: sending check power mode cmnd\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|satTestUnitReady_1
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satTestUnitReady_1.  *  *  SAT implementation for SCSI satTestUnitReady_1.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satTestUnitReady_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     sends SAT_CHECK_POWER_MODE as a part of TESTUNITREADY     internally generated - no directly corresponding scsi     called in satIOCompleted as a part of satTestUnitReady(), SAT, revision8, 8.11.2, p42   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satTestUnitReady_1: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the ATA CHECK POWER MODE command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_CHECK_POWER_MODE
expr_stmt|;
comment|/* 0xE5 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satTestUnitReadyCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satTestUnitReady_1: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satReportLun.  *  *  SAT implementation for SCSI satReportLun. Only LUN0 is reported.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satReportLun
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|bit32
name|allocationLen
decl_stmt|;
name|bit32
name|reportLunLen
decl_stmt|;
name|scsiReportLun_t
modifier|*
name|pReportLun
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satReportLun entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pReportLun
operator|=
operator|(
name|scsiReportLun_t
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
comment|//  tdhexdump("satReportLun cdb", (bit8 *)scsiCmnd, 16);
comment|/* Find the buffer size allocated by Initiator */
name|allocationLen
operator|=
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|)
operator|)
expr_stmt|;
name|reportLunLen
operator|=
literal|16
expr_stmt|;
comment|/* 8 byte header and 8 bytes of LUN0 */
if|if
condition|(
name|allocationLen
operator|<
name|reportLunLen
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReportLun *** ERROR *** insufficient len=0x%x tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|reportLunLen
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* Set length to one entry */
name|pReportLun
operator|->
name|len
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|len
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|len
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|len
index|[
literal|3
index|]
operator|=
sizeof|sizeof
argument_list|(
name|tiLUN_t
argument_list|)
expr_stmt|;
name|pReportLun
operator|->
name|reserved
operator|=
literal|0
expr_stmt|;
comment|/* Set to LUN 0:    * - address method to 0x00: Peripheral device addressing method,    * - bus identifier to 0    */
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|allocationLen
operator|>
name|reportLunLen
condition|)
block|{
comment|/* underrun */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReportLun reporting underrun reportLunLen=0x%x allocationLen=0x%x \n"
operator|,
name|reportLunLen
operator|,
name|allocationLen
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|reportLunLen
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI REQUEST SENSE.  *  *  SAT implementation for SCSI REQUEST SENSE.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satRequestSense
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     SAT Rev 8 p38, Table25     sending SMART RETURN STATUS     Checking SMART Treshold Exceeded Condition is done in satRequestSenseCB()     Only fixed format sense data is support. In other words, we don't support DESC bit is set     in Request Sense    */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext2
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
operator|(
name|scsiRspSense_t
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: pSatDevData=%p\n"
operator|,
name|pSatDevData
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSense: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*     Only fixed format sense data is support. In other words, we don't support DESC bit is set     in Request Sense    */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|ATA_REMOVABLE_MEDIA_DEVICE_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSense: DESC bit is set, which we don't support\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends SMART RETURN STATUS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_RETURN_STATUS
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xDA
expr_stmt|;
comment|/* FIS features */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satRequestSenseCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: if return, status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
else|else
block|{
comment|/*allocate iocontext for xmitting xmit SAT_CHECK_POWER_MODE       then call satRequestSense2 */
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: before satIntIo %p\n"
operator|,
name|satIntIo
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate iocontext */
name|satIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
comment|/* original request */
name|pSatDevData
argument_list|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: after satIntIo %p\n"
operator|,
name|satIntIo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* failed during sending SMART RETURN STATUS */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: else fail 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext except      * reqType and satCompleteCB which will be set depending on cmd.      */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: satIntIo is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: satIntIo is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* use this --- tttttthe one the same */
name|satIntIo
operator|->
name|satOrgTiIORequest
operator|=
name|tiIORequest
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSatDevData
operator|=
name|pSatDevData
expr_stmt|;
name|satIOContext2
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSense
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pTiSenseData
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pTiSenseData
operator|->
name|senseData
operator|=
name|satIOContext2
operator|->
name|pSense
expr_stmt|;
name|satIOContext2
operator|->
name|tiRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|->
name|interruptContext
operator|=
name|satIOContext
operator|->
name|interruptContext
expr_stmt|;
name|satIOContext2
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satIOContext2
operator|->
name|ptiDeviceHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
name|satIOContext2
operator|->
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: satIntIo->satIntTiScsiXchg.agSgl1.len %d\n"
operator|,
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|len
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: satIntIo->satIntTiScsiXchg.agSgl1.upper %d\n"
operator|,
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|upper
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: satIntIo->satIntTiScsiXchg.agSgl1.lower %d\n"
operator|,
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|lower
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: satIntIo->satIntTiScsiXchg.agSgl1.type %d\n"
operator|,
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|satRequestSense_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiIORequest
operator|)
argument_list|,
name|tiDeviceHandle
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|)
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* failed during sending SMART RETURN STATUS */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSense: else fail 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense: else return success\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI REQUEST SENSE.  *  *  SAT implementation for SCSI REQUEST SENSE.  *  Sub function of satRequestSense  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satRequestSense_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     sends SAT_CHECK_POWER_MODE   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense_1 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/*    * Send the ATA CHECK POWER MODE command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_CHECK_POWER_MODE
expr_stmt|;
comment|/* 0xE5 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satRequestSenseCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense_1: agSgl1.len %d\n"
operator|,
name|tiScsiRequest
operator|->
name|agSgl1
operator|.
name|len
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense_1: agSgl1.upper %d\n"
operator|,
name|tiScsiRequest
operator|->
name|agSgl1
operator|.
name|upper
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense_1: agSgl1.lower %d\n"
operator|,
name|tiScsiRequest
operator|->
name|agSgl1
operator|.
name|lower
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSense_1: agSgl1.type %d\n"
operator|,
name|tiScsiRequest
operator|->
name|agSgl1
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
comment|//  tdhexdump("satRequestSense_1", (bit8 *)fis, sizeof(agsaFisRegHostToDevice_t));
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI INQUIRY.  *  *  SAT implementation for SCSI INQUIRY.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satInquiry
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     CMDDT bit is obsolete in SPC-3 and this is assumed in SAT revision 8   */
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiry: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiry entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiry: pSatDevData=%p\n"
operator|,
name|pSatDevData
operator|)
argument_list|)
expr_stmt|;
comment|//tdhexdump("satInquiry", (bit8 *)scsiCmnd->cdb, 6);
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satInquiry: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking EVPD and Allocation Length */
comment|/* SPC-4 spec 6.4 p141 */
comment|/* EVPD bit == 0&& PAGE CODE != 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_EVPD_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiry: return EVPD and PAGE CODE\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiry: allocation length 0x%x %d\n"
operator|,
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|)
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|)
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* convert OS IO to TD internal IO */
if|if
condition|(
name|pSatDevData
operator|->
name|IDDeviceValid
operator|==
name|agFALSE
condition|)
block|{
name|status
operator|=
name|satStartIDDev
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiry: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiry: calling satInquiryIntCB\n"
operator|)
argument_list|)
expr_stmt|;
name|satInquiryIntCB
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satReadCapacity10.  *  *  SAT implementation for SCSI satReadCapacity10.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satReadCapacity10
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit8
modifier|*
name|pVirtAddr
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit32
name|lastLba
decl_stmt|;
name|bit32
name|word117_118
decl_stmt|;
name|bit32
name|word117
decl_stmt|;
name|bit32
name|word118
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satReadCapacity10: start: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pVirtAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|pSATAIdData
operator|=
operator|&
name|pSatDevData
operator|->
name|satIdentifyData
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity10: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*    * If Logical block address is not set to zero, return error    */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity10 *** ERROR *** logical address non zero, tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*    * If PMI bit is not zero, return error    */
if|if
condition|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|)
operator|&
name|SCSI_READ_CAPACITY10_PMI_MASK
operator|)
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity10 *** ERROR *** PMI is not zero, tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*     filling in Read Capacity parameter data     saved identify device has been already flipped     See ATA spec p125 and p136 and SBC spec p54   */
comment|/*    * If 48-bit addressing is supported, set capacity information from Identify    * Device Word 100-103.    */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/*      * Setting RETURNED LOGICAL BLOCK ADDRESS in READ CAPACITY(10) response data:      * SBC-2 specifies that if the capacity exceeded the 4-byte RETURNED LOGICAL      * BLOCK ADDRESS in READ CAPACITY(10) parameter data, the RETURNED LOGICAL      * BLOCK ADDRESS should be set to 0xFFFFFFFF so the application client would      * then issue a READ CAPACITY(16) command.      */
comment|/* ATA Identify Device information word 100 - 103 */
if|if
condition|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA32_47
operator|!=
literal|0
operator|)
operator|||
operator|(
name|pSATAIdData
operator|->
name|maxLBA48_63
operator|!=
literal|0
operator|)
condition|)
block|{
name|pVirtAddr
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* MSB number of block */
name|pVirtAddr
index|[
literal|1
index|]
operator|=
literal|0xFF
expr_stmt|;
name|pVirtAddr
index|[
literal|2
index|]
operator|=
literal|0xFF
expr_stmt|;
name|pVirtAddr
index|[
literal|3
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* LSB number of block */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity10: returns 0xFFFFFFFF\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* Fit the Readcapacity10 4-bytes response length */
block|{
name|lastLba
operator|=
operator|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA16_31
operator|)
operator|<<
literal|16
operator|)
operator|)
operator||
operator|(
name|pSATAIdData
operator|->
name|maxLBA0_15
operator|)
expr_stmt|;
name|lastLba
operator|=
name|lastLba
operator|-
literal|1
expr_stmt|;
comment|/* LBA starts from zero */
comment|/*         for testing       lastLba = lastLba - (512*10) - 1;       */
name|pVirtAddr
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* MSB */
name|pVirtAddr
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* LSB */
name|TI_DBG3
argument_list|(
operator|(
literal|"satReadCapacity10: lastLba is 0x%x %d\n"
operator|,
name|lastLba
operator|,
name|lastLba
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satReadCapacity10: LBA 0 is 0x%x %d\n"
operator|,
name|pVirtAddr
index|[
literal|0
index|]
operator|,
name|pVirtAddr
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satReadCapacity10: LBA 1 is 0x%x %d\n"
operator|,
name|pVirtAddr
index|[
literal|1
index|]
operator|,
name|pVirtAddr
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satReadCapacity10: LBA 2 is 0x%x %d\n"
operator|,
name|pVirtAddr
index|[
literal|2
index|]
operator|,
name|pVirtAddr
index|[
literal|2
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satReadCapacity10: LBA 3 is 0x%x %d\n"
operator|,
name|pVirtAddr
index|[
literal|3
index|]
operator|,
name|pVirtAddr
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*    * For 28-bit addressing, set capacity information from Identify    * Device Word 60-61.    */
else|else
block|{
comment|/* ATA Identify Device information word 60 - 61 */
name|lastLba
operator|=
operator|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|numOfUserAddressableSectorsHi
operator|)
operator|<<
literal|16
operator|)
operator|)
operator||
operator|(
name|pSATAIdData
operator|->
name|numOfUserAddressableSectorsLo
operator|)
expr_stmt|;
name|lastLba
operator|=
name|lastLba
operator|-
literal|1
expr_stmt|;
comment|/* LBA starts from zero */
name|pVirtAddr
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* MSB */
name|pVirtAddr
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* LSB */
block|}
comment|/* SAT Rev 8d */
if|if
condition|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|word104_107
index|[
literal|2
index|]
operator|)
operator|&
literal|0x1000
operator|)
operator|==
literal|0
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satReadCapacity10: Default Block Length is 512\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Set the block size, fixed at 512 bytes.      */
name|pVirtAddr
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MSB block size in bytes */
name|pVirtAddr
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|pVirtAddr
index|[
literal|6
index|]
operator|=
literal|0x02
expr_stmt|;
name|pVirtAddr
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LSB block size in bytes */
block|}
else|else
block|{
name|word118
operator|=
name|pSATAIdData
operator|->
name|word112_126
index|[
literal|6
index|]
expr_stmt|;
name|word117
operator|=
name|pSATAIdData
operator|->
name|word112_126
index|[
literal|5
index|]
expr_stmt|;
name|word117_118
operator|=
operator|(
name|word118
operator|<<
literal|16
operator|)
operator|+
name|word117
expr_stmt|;
name|word117_118
operator|=
name|word117_118
operator|*
literal|2
expr_stmt|;
name|pVirtAddr
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|word117_118
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* MSB block size in bytes */
name|pVirtAddr
index|[
literal|5
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|word117_118
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|6
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|word117_118
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|7
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|word117_118
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* LSB block size in bytes */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity10: Nondefault word118 %d 0x%x \n"
operator|,
name|word118
operator|,
name|word118
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity10: Nondefault word117 %d 0x%x \n"
operator|,
name|word117
operator|,
name|word117
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity10: Nondefault Block Length is %d 0x%x \n"
operator|,
name|word117_118
operator|,
name|word117_118
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* fill in MAX LBA, which is used in satSendDiagnostic_1() */
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|4
index|]
operator|=
name|pVirtAddr
index|[
literal|0
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|5
index|]
operator|=
name|pVirtAddr
index|[
literal|1
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|6
index|]
operator|=
name|pVirtAddr
index|[
literal|2
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|7
index|]
operator|=
name|pVirtAddr
index|[
literal|3
index|]
expr_stmt|;
comment|/* LSB */
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadCapacity10 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x , tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|pVirtAddr
index|[
literal|0
index|]
operator|,
name|pVirtAddr
index|[
literal|1
index|]
operator|,
name|pVirtAddr
index|[
literal|2
index|]
operator|,
name|pVirtAddr
index|[
literal|3
index|]
operator|,
name|pVirtAddr
index|[
literal|4
index|]
operator|,
name|pVirtAddr
index|[
literal|5
index|]
operator|,
name|pVirtAddr
index|[
literal|6
index|]
operator|,
name|pVirtAddr
index|[
literal|7
index|]
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the completion response now.    */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satReadCapacity16.  *  *  SAT implementation for SCSI satReadCapacity16.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satReadCapacity16
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit8
modifier|*
name|pVirtAddr
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit32
name|lastLbaLo
decl_stmt|;
name|bit32
name|allocationLen
decl_stmt|;
name|bit32
name|readCapacityLen
init|=
literal|32
decl_stmt|;
name|bit32
name|i
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satReadCapacity16 start: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pVirtAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|pSATAIdData
operator|=
operator|&
name|pSatDevData
operator|->
name|satIdentifyData
expr_stmt|;
comment|/* Find the buffer size allocated by Initiator */
name|allocationLen
operator|=
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|allocationLen
operator|<
name|readCapacityLen
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity16 *** ERROR *** insufficient len=0x%x readCapacityLen=0x%x\n"
operator|,
name|allocationLen
operator|,
name|readCapacityLen
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity16: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*    * If Logical blcok address is not set to zero, return error    */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity16 *** ERROR *** logical address non zero, tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*    * If PMI bit is not zero, return error    */
if|if
condition|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|14
index|]
operator|)
operator|&
name|SCSI_READ_CAPACITY16_PMI_MASK
operator|)
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity16 *** ERROR *** PMI is not zero, tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*     filling in Read Capacity parameter data   */
comment|/*    * If 48-bit addressing is supported, set capacity information from Identify    * Device Word 100-103.    */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|pVirtAddr
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA48_63
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/* MSB */
name|pVirtAddr
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA48_63
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA32_47
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA32_47
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|lastLbaLo
operator|=
operator|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA16_31
operator|)
operator|<<
literal|16
operator|)
operator|)
operator||
operator|(
name|pSATAIdData
operator|->
name|maxLBA0_15
operator|)
expr_stmt|;
name|lastLbaLo
operator|=
name|lastLbaLo
operator|-
literal|1
expr_stmt|;
comment|/* LBA starts from zero */
name|pVirtAddr
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|5
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|6
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|7
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* LSB */
block|}
comment|/*    * For 28-bit addressing, set capacity information from Identify    * Device Word 60-61.    */
else|else
block|{
name|pVirtAddr
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|pVirtAddr
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pVirtAddr
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pVirtAddr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|lastLbaLo
operator|=
operator|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|numOfUserAddressableSectorsHi
operator|)
operator|<<
literal|16
operator|)
operator|)
operator||
operator|(
name|pSATAIdData
operator|->
name|numOfUserAddressableSectorsLo
operator|)
expr_stmt|;
name|lastLbaLo
operator|=
name|lastLbaLo
operator|-
literal|1
expr_stmt|;
comment|/* LBA starts from zero */
name|pVirtAddr
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|5
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|6
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pVirtAddr
index|[
literal|7
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* LSB */
block|}
comment|/*    * Set the block size, fixed at 512 bytes.    */
name|pVirtAddr
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MSB block size in bytes */
name|pVirtAddr
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|pVirtAddr
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
name|pVirtAddr
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LSB block size in bytes */
comment|/* fill in MAX LBA, which is used in satSendDiagnostic_1() */
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|0
index|]
operator|=
name|pVirtAddr
index|[
literal|0
index|]
expr_stmt|;
comment|/* MSB */
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|1
index|]
operator|=
name|pVirtAddr
index|[
literal|1
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|2
index|]
operator|=
name|pVirtAddr
index|[
literal|2
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|3
index|]
operator|=
name|pVirtAddr
index|[
literal|3
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|4
index|]
operator|=
name|pVirtAddr
index|[
literal|4
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|5
index|]
operator|=
name|pVirtAddr
index|[
literal|5
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|6
index|]
operator|=
name|pVirtAddr
index|[
literal|6
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|7
index|]
operator|=
name|pVirtAddr
index|[
literal|7
index|]
expr_stmt|;
comment|/* LSB */
name|TI_DBG5
argument_list|(
operator|(
literal|"satReadCapacity16 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x , tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|pVirtAddr
index|[
literal|0
index|]
operator|,
name|pVirtAddr
index|[
literal|1
index|]
operator|,
name|pVirtAddr
index|[
literal|2
index|]
operator|,
name|pVirtAddr
index|[
literal|3
index|]
operator|,
name|pVirtAddr
index|[
literal|4
index|]
operator|,
name|pVirtAddr
index|[
literal|5
index|]
operator|,
name|pVirtAddr
index|[
literal|6
index|]
operator|,
name|pVirtAddr
index|[
literal|7
index|]
operator|,
name|pVirtAddr
index|[
literal|8
index|]
operator|,
name|pVirtAddr
index|[
literal|9
index|]
operator|,
name|pVirtAddr
index|[
literal|10
index|]
operator|,
name|pVirtAddr
index|[
literal|11
index|]
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|12
init|;
name|i
operator|<=
literal|31
condition|;
name|i
operator|++
control|)
block|{
name|pVirtAddr
index|[
name|i
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
comment|/*    * Send the completion response now.    */
if|if
condition|(
name|allocationLen
operator|>
name|readCapacityLen
condition|)
block|{
comment|/* underrun */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadCapacity16 reporting underrun readCapacityLen=0x%x allocationLen=0x%x \n"
operator|,
name|readCapacityLen
operator|,
name|allocationLen
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|readCapacityLen
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI MODE SENSE (6).  *  *  SAT implementation for SCSI MODE SENSE (6).  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satModeSense6
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|bit32
name|requestLen
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|pageSupported
decl_stmt|;
name|bit8
name|page
decl_stmt|;
name|bit8
modifier|*
name|pModeSense
decl_stmt|;
comment|/* Mode Sense data buffer */
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|bit8
name|PC
decl_stmt|;
name|bit8
name|AllPages
index|[
name|MODE_SENSE6_RETURN_ALL_PAGES_LEN
index|]
decl_stmt|;
name|bit8
name|Control
index|[
name|MODE_SENSE6_CONTROL_PAGE_LEN
index|]
decl_stmt|;
name|bit8
name|RWErrorRecovery
index|[
name|MODE_SENSE6_READ_WRITE_ERROR_RECOVERY_PAGE_LEN
index|]
decl_stmt|;
name|bit8
name|Caching
index|[
name|MODE_SENSE6_CACHING_LEN
index|]
decl_stmt|;
name|bit8
name|InfoExceptionCtrl
index|[
name|MODE_SENSE6_INFORMATION_EXCEPTION_CONTROL_PAGE_LEN
index|]
decl_stmt|;
name|bit8
name|lenRead
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense6 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pModeSense
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|//tdhexdump("satModeSense6", (bit8 *)scsiCmnd->cdb, 6);
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satModeSense6: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking PC(Page Control)      SAT revion 8, 8.5.3 p33 and 10.1.2, p66   */
name|PC
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|)
operator|&
name|SCSI_MODE_SENSE6_PC_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|PC
operator|!=
literal|0
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSense6: return due to PC value pc 0x%x\n"
operator|,
name|PC
operator|>>
literal|6
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* reading PAGE CODE */
name|page
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|)
operator|&
name|SCSI_MODE_SENSE6_PAGE_CODE_MASK
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense6: page=0x%x, tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|page
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|requestLen
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/*     Based on page code value, returns a corresponding mode page     note: no support for subpage   */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|MODESENSE_RETURN_ALL_PAGES
case|:
case|case
name|MODESENSE_CONTROL_PAGE
case|:
comment|/* control */
case|case
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
comment|/* Read-Write Error Recovery */
case|case
name|MODESENSE_CACHING
case|:
comment|/* caching */
case|case
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
comment|/* informational exceptions control*/
name|pageSupported
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|MODESENSE_VENDOR_SPECIFIC_PAGE
case|:
comment|/* vendor specific */
default|default:
name|pageSupported
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|pageSupported
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSense6 *** ERROR *** not supported page 0x%x tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|page
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|MODESENSE_RETURN_ALL_PAGES
case|:
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE6_RETURN_ALL_PAGES_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODESENSE_CONTROL_PAGE
case|:
comment|/* control */
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE6_CONTROL_PAGE_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
comment|/* Read-Write Error Recovery */
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE6_READ_WRITE_ERROR_RECOVERY_PAGE_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODESENSE_CACHING
case|:
comment|/* caching */
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE6_CACHING_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
comment|/* informational exceptions control*/
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE6_INFORMATION_EXCEPTION_CONTROL_PAGE_LEN
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSense6: default error page %d\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|page
operator|==
name|MODESENSE_RETURN_ALL_PAGES
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense6: MODESENSE_RETURN_ALL_PAGES\n"
operator|)
argument_list|)
expr_stmt|;
name|AllPages
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|1
argument_list|)
expr_stmt|;
name|AllPages
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|AllPages
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|AllPages
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
comment|/* density code */
name|AllPages
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|AllPages
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|AllPages
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|AllPages
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|AllPages
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE */
name|AllPages
index|[
literal|12
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
literal|13
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|AllPages
index|[
literal|14
index|]
operator|=
literal|0x40
expr_stmt|;
comment|/* ARRE is set */
name|AllPages
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MODESENSE_CACHING */
name|AllPages
index|[
literal|24
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
literal|25
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* page length */
ifdef|#
directive|ifdef
name|NOT_YET
if|if
condition|(
name|pSatDevData
operator|->
name|satWriteCacheEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
literal|26
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* WCE bit is set */
block|}
else|else
block|{
name|AllPages
index|[
literal|26
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
block|}
endif|#
directive|endif
name|AllPages
index|[
literal|26
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
name|AllPages
index|[
literal|27
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|28
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|29
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|30
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|31
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|32
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|33
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|34
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|35
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satLookAheadEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
literal|36
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DRA bit is NOT set */
block|}
else|else
block|{
name|AllPages
index|[
literal|36
index|]
operator|=
literal|0x20
expr_stmt|;
comment|/* DRA bit is set */
block|}
name|AllPages
index|[
literal|37
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|38
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|39
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|40
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|41
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|42
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|43
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MODESENSE_CONTROL_PAGE */
name|AllPages
index|[
literal|44
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
literal|45
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|AllPages
index|[
literal|46
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* only GLTSD bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
literal|47
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* Queue Alogorithm modifier 1b and QErr 01b*/
block|}
else|else
block|{
name|AllPages
index|[
literal|47
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Queue Alogorithm modifier 0b and QErr 01b */
block|}
name|AllPages
index|[
literal|48
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|49
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|50
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|AllPages
index|[
literal|51
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|AllPages
index|[
literal|52
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|AllPages
index|[
literal|53
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|AllPages
index|[
literal|54
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|AllPages
index|[
literal|55
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
comment|/* MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE */
name|AllPages
index|[
literal|56
index|]
operator|=
literal|0x1C
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
literal|57
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
literal|58
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DEXCPT bit is NOT set */
block|}
else|else
block|{
name|AllPages
index|[
literal|58
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* DEXCPT bit is set */
block|}
name|AllPages
index|[
literal|59
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* We don't support MRIE */
name|AllPages
index|[
literal|60
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Interval timer vendor-specific */
name|AllPages
index|[
literal|61
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|62
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|63
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|64
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* REPORT-COUNT */
name|AllPages
index|[
literal|65
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|66
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|67
index|]
operator|=
literal|0x00
expr_stmt|;
name|osti_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|AllPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_CONTROL_PAGE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense6: MODESENSE_CONTROL_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|Control
index|[
literal|0
index|]
operator|=
name|MODE_SENSE6_CONTROL_PAGE_LEN
operator|-
literal|1
expr_stmt|;
name|Control
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|Control
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|Control
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
comment|/* density code */
name|Control
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Control
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Control
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Control
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Control
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/*      * Fill-up control mode page, SAT, Table 65      */
name|Control
index|[
literal|12
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page code */
name|Control
index|[
literal|13
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|Control
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* only GLTSD bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
name|Control
index|[
literal|15
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* Queue Alogorithm modifier 1b and QErr 01b*/
block|}
else|else
block|{
name|Control
index|[
literal|15
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Queue Alogorithm modifier 0b and QErr 01b */
block|}
name|Control
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|Control
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|Control
index|[
literal|20
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|Control
index|[
literal|21
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|Control
index|[
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|Control
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|osti_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|Control
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense6: MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|RWErrorRecovery
index|[
literal|0
index|]
operator|=
name|MODE_SENSE6_READ_WRITE_ERROR_RECOVERY_PAGE_LEN
operator|-
literal|1
expr_stmt|;
name|RWErrorRecovery
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|RWErrorRecovery
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|RWErrorRecovery
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
comment|/* density code */
name|RWErrorRecovery
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|RWErrorRecovery
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|RWErrorRecovery
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|RWErrorRecovery
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/*      * Fill-up Read-Write Error Recovery mode page, SAT, Table 66      */
name|RWErrorRecovery
index|[
literal|12
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* page code */
name|RWErrorRecovery
index|[
literal|13
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|RWErrorRecovery
index|[
literal|14
index|]
operator|=
literal|0x40
expr_stmt|;
comment|/* ARRE is set */
name|RWErrorRecovery
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
name|osti_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|RWErrorRecovery
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_CACHING
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense6: MODESENSE_CACHING\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* special case */
if|if
condition|(
name|requestLen
operator|==
literal|4
operator|&&
name|page
operator|==
name|MODESENSE_CACHING
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense6: linux 2.6.8.24 support\n"
operator|)
argument_list|)
expr_stmt|;
name|pModeSense
index|[
literal|0
index|]
operator|=
literal|0x20
operator|-
literal|1
expr_stmt|;
comment|/* 32 - 1 */
name|pModeSense
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|pModeSense
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|pModeSense
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|Caching
index|[
literal|0
index|]
operator|=
name|MODE_SENSE6_CACHING_LEN
operator|-
literal|1
expr_stmt|;
name|Caching
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|Caching
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|Caching
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
comment|/* density code */
name|Caching
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Caching
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Caching
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Caching
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Caching
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/*      * Fill-up Caching mode page, SAT, Table 67      */
comment|/* length 20 */
name|Caching
index|[
literal|12
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* page code */
name|Caching
index|[
literal|13
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* page length */
ifdef|#
directive|ifdef
name|NOT_YET
if|if
condition|(
name|pSatDevData
operator|->
name|satWriteCacheEnabled
operator|==
name|agTRUE
condition|)
block|{
name|Caching
index|[
literal|14
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* WCE bit is set */
block|}
else|else
block|{
name|Caching
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
block|}
endif|#
directive|endif
name|Caching
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
name|Caching
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satLookAheadEnabled
operator|==
name|agTRUE
condition|)
block|{
name|Caching
index|[
literal|24
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DRA bit is NOT set */
block|}
else|else
block|{
name|Caching
index|[
literal|24
index|]
operator|=
literal|0x20
expr_stmt|;
comment|/* DRA bit is set */
block|}
name|Caching
index|[
literal|25
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|26
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|27
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|28
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|29
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|30
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|31
index|]
operator|=
literal|0x00
expr_stmt|;
name|osti_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|Caching
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense6: MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|0
index|]
operator|=
name|MODE_SENSE6_INFORMATION_EXCEPTION_CONTROL_PAGE_LEN
operator|-
literal|1
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|InfoExceptionCtrl
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|InfoExceptionCtrl
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
comment|/* density code */
name|InfoExceptionCtrl
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|InfoExceptionCtrl
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|InfoExceptionCtrl
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|InfoExceptionCtrl
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/*      * Fill-up informational-exceptions control mode page, SAT, Table 68      */
name|InfoExceptionCtrl
index|[
literal|12
index|]
operator|=
literal|0x1C
expr_stmt|;
comment|/* page code */
name|InfoExceptionCtrl
index|[
literal|13
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
condition|)
block|{
name|InfoExceptionCtrl
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DEXCPT bit is NOT set */
block|}
else|else
block|{
name|InfoExceptionCtrl
index|[
literal|14
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* DEXCPT bit is set */
block|}
name|InfoExceptionCtrl
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* We don't support MRIE */
name|InfoExceptionCtrl
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Interval timer vendor-specific */
name|InfoExceptionCtrl
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* REPORT-COUNT */
name|InfoExceptionCtrl
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
name|osti_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|InfoExceptionCtrl
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Error */
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSense6: Error page %d\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* there can be only underrun not overrun in error case */
if|if
condition|(
name|requestLen
operator|>
name|lenRead
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satModeSense6 reporting underrun lenRead=0x%x requestLen=0x%x tiIORequest=%p\n"
operator|,
name|lenRead
operator|,
name|requestLen
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|requestLen
operator|-
name|lenRead
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI MODE SENSE (10).  *  *  SAT implementation for SCSI MODE SENSE (10).  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satModeSense10
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|bit32
name|requestLen
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|pageSupported
decl_stmt|;
name|bit8
name|page
decl_stmt|;
name|bit8
modifier|*
name|pModeSense
decl_stmt|;
comment|/* Mode Sense data buffer */
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|bit8
name|PC
decl_stmt|;
comment|/* page control */
name|bit8
name|LLBAA
decl_stmt|;
comment|/* Long LBA Accepted */
name|bit32
name|index
decl_stmt|;
name|bit8
name|AllPages
index|[
name|MODE_SENSE10_RETURN_ALL_PAGES_LLBAA_LEN
index|]
decl_stmt|;
name|bit8
name|Control
index|[
name|MODE_SENSE10_CONTROL_PAGE_LLBAA_LEN
index|]
decl_stmt|;
name|bit8
name|RWErrorRecovery
index|[
name|MODE_SENSE10_READ_WRITE_ERROR_RECOVERY_PAGE_LLBAA_LEN
index|]
decl_stmt|;
name|bit8
name|Caching
index|[
name|MODE_SENSE10_CACHING_LLBAA_LEN
index|]
decl_stmt|;
name|bit8
name|InfoExceptionCtrl
index|[
name|MODE_SENSE10_INFORMATION_EXCEPTION_CONTROL_PAGE_LLBAA_LEN
index|]
decl_stmt|;
name|bit8
name|lenRead
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense10 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pModeSense
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satModeSense10: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking PC(Page Control)      SAT revion 8, 8.5.3 p33 and 10.1.2, p66   */
name|PC
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|)
operator|&
name|SCSI_MODE_SENSE10_PC_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|PC
operator|!=
literal|0
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSense10: return due to PC value pc 0x%x\n"
operator|,
name|PC
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* finding LLBAA bit */
name|LLBAA
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
name|SCSI_MODE_SENSE10_LLBAA_MASK
argument_list|)
expr_stmt|;
comment|/* reading PAGE CODE */
name|page
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|)
operator|&
name|SCSI_MODE_SENSE10_PAGE_CODE_MASK
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense10: page=0x%x, tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|page
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|requestLen
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/*     Based on page code value, returns a corresponding mode page     note: no support for subpage   */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|MODESENSE_RETURN_ALL_PAGES
case|:
comment|/* return all pages */
case|case
name|MODESENSE_CONTROL_PAGE
case|:
comment|/* control */
case|case
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
comment|/* Read-Write Error Recovery */
case|case
name|MODESENSE_CACHING
case|:
comment|/* caching */
case|case
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
comment|/* informational exceptions control*/
name|pageSupported
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|MODESENSE_VENDOR_SPECIFIC_PAGE
case|:
comment|/* vendor specific */
default|default:
name|pageSupported
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|pageSupported
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSense10 *** ERROR *** not supported page 0x%x tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|page
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|MODESENSE_RETURN_ALL_PAGES
case|:
if|if
condition|(
name|LLBAA
condition|)
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE10_RETURN_ALL_PAGES_LLBAA_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE10_RETURN_ALL_PAGES_LEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MODESENSE_CONTROL_PAGE
case|:
comment|/* control */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE10_CONTROL_PAGE_LLBAA_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE10_CONTROL_PAGE_LEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
comment|/* Read-Write Error Recovery */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE10_READ_WRITE_ERROR_RECOVERY_PAGE_LLBAA_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE10_READ_WRITE_ERROR_RECOVERY_PAGE_LEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MODESENSE_CACHING
case|:
comment|/* caching */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE10_CACHING_LLBAA_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE10_CACHING_LEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
comment|/* informational exceptions control*/
if|if
condition|(
name|LLBAA
condition|)
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE10_INFORMATION_EXCEPTION_CONTROL_PAGE_LLBAA_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|requestLen
argument_list|,
name|MODE_SENSE10_INFORMATION_EXCEPTION_CONTROL_PAGE_LEN
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSense10: default error page %d\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|page
operator|==
name|MODESENSE_RETURN_ALL_PAGES
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense10: MODESENSE_RETURN_ALL_PAGES\n"
operator|)
argument_list|)
expr_stmt|;
name|AllPages
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|AllPages
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|2
argument_list|)
expr_stmt|;
name|AllPages
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* medium type: default medium type (currently mounted medium type) */
name|AllPages
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* device-specific param: no write-protect, no support for DPO-FUA */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|AllPages
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA */
name|AllPages
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|AllPages
index|[
literal|4
index|]
operator||
literal|0x1
argument_list|)
expr_stmt|;
comment|/* LONGLBA is set */
block|}
else|else
block|{
name|AllPages
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA: LONGLBA is not set */
block|}
name|AllPages
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|AllPages
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* block descriptot length */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|AllPages
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* block descriptor length: LONGLBA is set. So, length is 16 */
block|}
else|else
block|{
name|AllPages
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length: LONGLBA is NOT set. So, length is 8 */
block|}
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
if|if
condition|(
name|LLBAA
condition|)
block|{
comment|/* density code */
name|AllPages
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|AllPages
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|AllPages
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|AllPages
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|AllPages
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|AllPages
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|AllPages
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|22
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|AllPages
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
comment|/* density code */
name|AllPages
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|AllPages
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|AllPages
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|AllPages
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|AllPages
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|LLBAA
condition|)
block|{
name|index
operator|=
literal|24
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|16
expr_stmt|;
block|}
comment|/* MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE */
name|AllPages
index|[
name|index
operator|+
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
name|index
operator|+
literal|1
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|AllPages
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x40
expr_stmt|;
comment|/* ARRE is set */
name|AllPages
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MODESENSE_CACHING */
comment|/*      * Fill-up Caching mode page, SAT, Table 67      */
comment|/* length 20 */
name|AllPages
index|[
name|index
operator|+
literal|12
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
name|index
operator|+
literal|13
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* page length */
ifdef|#
directive|ifdef
name|NOT_YET
if|if
condition|(
name|pSatDevData
operator|->
name|satWriteCacheEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
name|index
operator|+
literal|14
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* WCE bit is set */
block|}
else|else
block|{
name|AllPages
index|[
name|index
operator|+
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
block|}
endif|#
directive|endif
name|AllPages
index|[
name|index
operator|+
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
name|AllPages
index|[
name|index
operator|+
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satLookAheadEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
name|index
operator|+
literal|24
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DRA bit is NOT set */
block|}
else|else
block|{
name|AllPages
index|[
name|index
operator|+
literal|24
index|]
operator|=
literal|0x20
expr_stmt|;
comment|/* DRA bit is set */
block|}
name|AllPages
index|[
name|index
operator|+
literal|25
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|26
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|27
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|28
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|29
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|30
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|31
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MODESENSE_CONTROL_PAGE */
comment|/*      * Fill-up control mode page, SAT, Table 65      */
name|AllPages
index|[
name|index
operator|+
literal|32
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
name|index
operator|+
literal|33
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|AllPages
index|[
name|index
operator|+
literal|34
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* only GLTSD bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
name|index
operator|+
literal|35
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* Queue Alogorithm modifier 1b and QErr 01b*/
block|}
else|else
block|{
name|AllPages
index|[
name|index
operator|+
literal|35
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Queue Alogorithm modifier 0b and QErr 01b */
block|}
name|AllPages
index|[
name|index
operator|+
literal|36
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|37
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|38
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|AllPages
index|[
name|index
operator|+
literal|39
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|AllPages
index|[
name|index
operator|+
literal|40
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|AllPages
index|[
name|index
operator|+
literal|41
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|AllPages
index|[
name|index
operator|+
literal|42
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|AllPages
index|[
name|index
operator|+
literal|43
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
comment|/* MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE */
comment|/*      * Fill-up informational-exceptions control mode page, SAT, Table 68      */
name|AllPages
index|[
name|index
operator|+
literal|44
index|]
operator|=
literal|0x1C
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
name|index
operator|+
literal|45
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
name|index
operator|+
literal|46
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DEXCPT bit is NOT set */
block|}
else|else
block|{
name|AllPages
index|[
name|index
operator|+
literal|46
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* DEXCPT bit is set */
block|}
name|AllPages
index|[
name|index
operator|+
literal|47
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* We don't support MRIE */
name|AllPages
index|[
name|index
operator|+
literal|48
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Interval timer vendor-specific */
name|AllPages
index|[
name|index
operator|+
literal|49
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|50
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|51
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|52
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* REPORT-COUNT */
name|AllPages
index|[
name|index
operator|+
literal|53
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|54
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|55
index|]
operator|=
literal|0x00
expr_stmt|;
name|osti_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|AllPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_CONTROL_PAGE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense10: MODESENSE_CONTROL_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|Control
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|Control
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|2
argument_list|)
expr_stmt|;
name|Control
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* medium type: default medium type (currently mounted medium type) */
name|Control
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* device-specific param: no write-protect, no support for DPO-FUA */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|Control
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA */
name|Control
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Control
index|[
literal|4
index|]
operator||
literal|0x1
argument_list|)
expr_stmt|;
comment|/* LONGLBA is set */
block|}
else|else
block|{
name|Control
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA: LONGLBA is not set */
block|}
name|Control
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Control
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* block descriptot length */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|Control
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* block descriptor length: LONGLBA is set. So, length is 16 */
block|}
else|else
block|{
name|Control
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length: LONGLBA is NOT set. So, length is 8 */
block|}
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
if|if
condition|(
name|LLBAA
condition|)
block|{
comment|/* density code */
name|Control
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Control
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Control
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Control
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Control
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Control
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Control
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|22
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Control
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
comment|/* density code */
name|Control
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Control
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Control
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Control
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Control
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|LLBAA
condition|)
block|{
name|index
operator|=
literal|24
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|16
expr_stmt|;
block|}
comment|/*      * Fill-up control mode page, SAT, Table 65      */
name|Control
index|[
name|index
operator|+
literal|0
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page code */
name|Control
index|[
name|index
operator|+
literal|1
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|Control
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* only GLTSD bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
name|Control
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* Queue Alogorithm modifier 1b and QErr 01b*/
block|}
else|else
block|{
name|Control
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Queue Alogorithm modifier 0b and QErr 01b */
block|}
name|Control
index|[
name|index
operator|+
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
name|index
operator|+
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
name|index
operator|+
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|Control
index|[
name|index
operator|+
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|Control
index|[
name|index
operator|+
literal|8
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|Control
index|[
name|index
operator|+
literal|9
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|Control
index|[
name|index
operator|+
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|Control
index|[
name|index
operator|+
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|osti_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|Control
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense10: MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|RWErrorRecovery
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|RWErrorRecovery
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|2
argument_list|)
expr_stmt|;
name|RWErrorRecovery
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* medium type: default medium type (currently mounted medium type) */
name|RWErrorRecovery
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* device-specific param: no write-protect, no support for DPO-FUA */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|RWErrorRecovery
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA */
name|RWErrorRecovery
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|RWErrorRecovery
index|[
literal|4
index|]
operator||
literal|0x1
argument_list|)
expr_stmt|;
comment|/* LONGLBA is set */
block|}
else|else
block|{
name|RWErrorRecovery
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA: LONGLBA is not set */
block|}
name|RWErrorRecovery
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* block descriptot length */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|RWErrorRecovery
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* block descriptor length: LONGLBA is set. So, length is 16 */
block|}
else|else
block|{
name|RWErrorRecovery
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length: LONGLBA is NOT set. So, length is 8 */
block|}
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
if|if
condition|(
name|LLBAA
condition|)
block|{
comment|/* density code */
name|RWErrorRecovery
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|RWErrorRecovery
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|RWErrorRecovery
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|22
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|RWErrorRecovery
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
comment|/* density code */
name|RWErrorRecovery
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|RWErrorRecovery
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|RWErrorRecovery
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|RWErrorRecovery
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|LLBAA
condition|)
block|{
name|index
operator|=
literal|24
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|16
expr_stmt|;
block|}
comment|/*      * Fill-up Read-Write Error Recovery mode page, SAT, Table 66      */
name|RWErrorRecovery
index|[
name|index
operator|+
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* page code */
name|RWErrorRecovery
index|[
name|index
operator|+
literal|1
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|RWErrorRecovery
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x40
expr_stmt|;
comment|/* ARRE is set */
name|RWErrorRecovery
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
name|osti_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|RWErrorRecovery
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_CACHING
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense10: MODESENSE_CACHING\n"
operator|)
argument_list|)
expr_stmt|;
name|Caching
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|Caching
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|2
argument_list|)
expr_stmt|;
name|Caching
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* medium type: default medium type (currently mounted medium type) */
name|Caching
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* device-specific param: no write-protect, no support for DPO-FUA */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|Caching
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA */
name|Caching
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Caching
index|[
literal|4
index|]
operator||
literal|0x1
argument_list|)
expr_stmt|;
comment|/* LONGLBA is set */
block|}
else|else
block|{
name|Caching
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA: LONGLBA is not set */
block|}
name|Caching
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Caching
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* block descriptot length */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|Caching
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* block descriptor length: LONGLBA is set. So, length is 16 */
block|}
else|else
block|{
name|Caching
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length: LONGLBA is NOT set. So, length is 8 */
block|}
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
if|if
condition|(
name|LLBAA
condition|)
block|{
comment|/* density code */
name|Caching
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Caching
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Caching
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Caching
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Caching
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Caching
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Caching
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|22
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Caching
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
comment|/* density code */
name|Caching
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Caching
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Caching
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Caching
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Caching
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|LLBAA
condition|)
block|{
name|index
operator|=
literal|24
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|16
expr_stmt|;
block|}
comment|/*      * Fill-up Caching mode page, SAT, Table 67      */
comment|/* length 20 */
name|Caching
index|[
name|index
operator|+
literal|0
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* page code */
name|Caching
index|[
name|index
operator|+
literal|1
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* page length */
ifdef|#
directive|ifdef
name|NOT_YET
if|if
condition|(
name|pSatDevData
operator|->
name|satWriteCacheEnabled
operator|==
name|agTRUE
condition|)
block|{
name|Caching
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* WCE bit is set */
block|}
else|else
block|{
name|Caching
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
block|}
endif|#
directive|endif
name|Caching
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
name|Caching
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satLookAheadEnabled
operator|==
name|agTRUE
condition|)
block|{
name|Caching
index|[
name|index
operator|+
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DRA bit is NOT set */
block|}
else|else
block|{
name|Caching
index|[
name|index
operator|+
literal|12
index|]
operator|=
literal|0x20
expr_stmt|;
comment|/* DRA bit is set */
block|}
name|Caching
index|[
name|index
operator|+
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|osti_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|Caching
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSense10: MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|2
argument_list|)
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* medium type: default medium type (currently mounted medium type) */
name|InfoExceptionCtrl
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* device-specific param: no write-protect, no support for DPO-FUA */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|InfoExceptionCtrl
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA */
name|InfoExceptionCtrl
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|InfoExceptionCtrl
index|[
literal|4
index|]
operator||
literal|0x1
argument_list|)
expr_stmt|;
comment|/* LONGLBA is set */
block|}
else|else
block|{
name|InfoExceptionCtrl
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA: LONGLBA is not set */
block|}
name|InfoExceptionCtrl
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* block descriptot length */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|InfoExceptionCtrl
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* block descriptor length: LONGLBA is set. So, length is 16 */
block|}
else|else
block|{
name|InfoExceptionCtrl
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length: LONGLBA is NOT set. So, length is 8 */
block|}
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
if|if
condition|(
name|LLBAA
condition|)
block|{
comment|/* density code */
name|InfoExceptionCtrl
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|InfoExceptionCtrl
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|InfoExceptionCtrl
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|22
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|InfoExceptionCtrl
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
comment|/* density code */
name|InfoExceptionCtrl
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|InfoExceptionCtrl
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|InfoExceptionCtrl
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|InfoExceptionCtrl
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|LLBAA
condition|)
block|{
name|index
operator|=
literal|24
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|16
expr_stmt|;
block|}
comment|/*      * Fill-up informational-exceptions control mode page, SAT, Table 68      */
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|0
index|]
operator|=
literal|0x1C
expr_stmt|;
comment|/* page code */
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|1
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
condition|)
block|{
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DEXCPT bit is NOT set */
block|}
else|else
block|{
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* DEXCPT bit is set */
block|}
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* We don't support MRIE */
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Interval timer vendor-specific */
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* REPORT-COUNT */
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
name|osti_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|InfoExceptionCtrl
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Error */
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSense10: Error page %d\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|requestLen
operator|>
name|lenRead
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSense10 reporting underrun lenRead=0x%x requestLen=0x%x tiIORequest=%p\n"
operator|,
name|lenRead
operator|,
name|requestLen
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|requestLen
operator|-
name|lenRead
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI VERIFY (10).  *  *  SAT implementation for SCSI VERIFY (10).  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satVerify10
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     For simple implementation,     no byte comparison supported as of 4/5/06   */
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|4
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify10 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* checking BYTCHK */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_VERIFY_BYTCHK_MASK
condition|)
block|{
comment|/*       should do the byte check       but not supported in this version      */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10: no byte checking \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satVerify10: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit32
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
comment|/* cbd10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10: cdb 0x%x 0x%x 0x%x 0x%x\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10: lba 0x%x SAT_TR_LBA_LIMIT 0x%x\n"
operator|,
name|lba
operator|,
name|SAT_TR_LBA_LIMIT
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify10: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify10: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10: error case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|LoopNum
operator|=
literal|1
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify10: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10: error case 2!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|satChainedVerify
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|agNULL
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|DenomTL
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|Remainder
init|=
literal|0
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
comment|/* 0 MSB, 3 LSB */
name|TI_DBG2
argument_list|(
operator|(
literal|"satChainedVerify: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerify: error incorrect ata command 0x%x\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
name|Remainder
operator|=
name|satOrgIOContext
operator|->
name|OrgTL
operator|%
name|DenomTL
expr_stmt|;
name|satOrgIOContext
operator|->
name|currentLBA
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
operator|+
name|DenomTL
expr_stmt|;
name|lba
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
expr_stmt|;
name|LBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF0
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0xF
argument_list|)
expr_stmt|;
comment|/* LSB */
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerify: error incorrect ata command 0x%x\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
comment|/* Initialize CB for SATA completion.    */
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedVerifyCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedVerify: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI VERIFY (12).  *  *  SAT implementation for SCSI VERIFY (12).  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satVerify12
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     For simple implementation,     no byte comparison supported as of 4/5/06   */
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|4
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify12 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* checking BYTCHK */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_VERIFY_BYTCHK_MASK
condition|)
block|{
comment|/*       should do the byte check       but not supported in this version      */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify12: no byte checking \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify12: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit32
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
name|lba
operator|=
name|satComputeCDB12LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|satComputeCDB12TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify12: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify12: cdb 0x%x 0x%x 0x%x 0x%x\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify12: lba 0x%x SAT_TR_LBA_LIMIT 0x%x\n"
operator|,
name|lba
operator|,
name|SAT_TR_LBA_LIMIT
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify12: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify12: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify12: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify12: error case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|LoopNum
operator|=
literal|1
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify12: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify12: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10: error case 2!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI VERIFY (16).  *  *  SAT implementation for SCSI VERIFY (16).  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satVerify16
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     For simple implementation,     no byte comparison supported as of 4/5/06   */
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|bit32
name|limitChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify16 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* checking BYTCHK */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_VERIFY_BYTCHK_MASK
condition|)
block|{
comment|/*       should do the byte check       but not supported in this version      */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify16: no byte checking \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satVerify16: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit64
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
name|limitChk
operator|=
name|satCompareLBALimitbit
argument_list|(
name|LBA
argument_list|)
expr_stmt|;
name|lba
operator|=
name|satComputeCDB16LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|satComputeCDB16TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|limitChk
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify16: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify16: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify16: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify12: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify12: error case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|LoopNum
operator|=
literal|1
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify12: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify12: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10: error case 2!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satFormatUnit.  *  *  SAT implementation for SCSI satFormatUnit.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satFormatUnit
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     note: we don't support media certification in this version and IP bit     satDevData->satFormatState will be agFalse since SAT does not actually sends     any ATA command    */
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|index
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satFormatUnit:start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     checking opcode     1. FMTDATA bit == 0(no defect list header)     2. FMTDATA bit == 1 and DCRT bit == 1(defect list header is provided     with DCRT bit set)   */
if|if
condition|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_FMTDATA_MASK
operator|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_FMTDATA_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_DCRT_MASK
operator|)
operator|)
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satFormatUnit: return opcode\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*     checking DEFECT LIST FORMAT and defect list length   */
if|if
condition|(
operator|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_DEFECT_LIST_FORMAT_MASK
operator|)
operator|==
literal|0x00
operator|)
operator|||
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_DEFECT_LIST_FORMAT_MASK
operator|)
operator|==
literal|0x06
operator|)
operator|)
condition|)
block|{
comment|/* short parameter header */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_FORMAT_UNIT_LONGLIST_MASK
operator|)
operator|==
literal|0x00
condition|)
block|{
name|index
operator|=
literal|8
expr_stmt|;
block|}
comment|/* long parameter header */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_FORMAT_UNIT_LONGLIST_MASK
operator|)
operator|==
literal|0x01
condition|)
block|{
name|index
operator|=
literal|10
expr_stmt|;
block|}
comment|/* defect list length */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
name|index
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
name|index
operator|+
literal|1
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satFormatUnit: return defect list format\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* FMTDATA == 1&& CMPLIST == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_FMTDATA_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_CMPLIST_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satFormatUnit: return cmplist\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satFormatUnit: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* defect list header filed, if exists, SAT rev8, Table 37, p48 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_FMTDATA_MASK
condition|)
block|{
comment|/* case 1,2,3 */
comment|/* IMMED 1; FOV 0; FOV 1, DCRT 1, IP 0 */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IMMED_MASK
operator|)
operator|||
operator|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_FOV_MASK
operator|)
operator|)
operator|||
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_FOV_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_DCRT_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IP_MASK
operator|)
operator|)
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satFormatUnit: return defect list case 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* case 4,5,6 */
comment|/*         1. IMMED 0, FOV 1, DCRT 0, IP 0         2. IMMED 0, FOV 1, DCRT 0, IP 1         3. IMMED 0, FOV 1, DCRT 1, IP 1       */
if|if
condition|(
operator|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IMMED_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_FOV_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_DCRT_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IP_MASK
operator|)
operator|)
operator|||
operator|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IMMED_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_FOV_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_DCRT_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IP_MASK
operator|)
operator|)
operator|||
operator|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IMMED_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_FOV_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_DCRT_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IP_MASK
operator|)
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satFormatUnit: return defect list case 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/*    * Send the completion response now.    */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satFormatUnit: return last\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satSendDiagnostic.  *  *  SAT implementation for SCSI satSendDiagnostic.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satSendDiagnostic
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|parmLen
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic:start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* reset satVerifyState */
name|pSatDevData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
comment|/* no pending diagnostic in background */
name|pSatDevData
operator|->
name|satBGPendingDiag
operator|=
name|agFALSE
expr_stmt|;
comment|/* table 27, 8.10 p39 SAT Rev8 */
comment|/*     1. checking PF == 1     2. checking DEVOFFL == 1     3. checking UNITOFFL == 1     4. checking PARAMETER LIST LENGTH != 0    */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_PF_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_DEVOFFL_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_UNITOFFL_MASK
operator|)
operator|||
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnostic: return PF, DEVOFFL, UNITOFFL, PARAM LIST\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satSendDiagnostic: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|parmLen
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* checking SELFTEST bit*/
comment|/* table 29, 8.10.3, p41 SAT Rev8 */
comment|/* case 1 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agFALSE
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnostic: return Table 29 case 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* case 2 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agFALSE
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_ATA_DEVICE_FEATURE_NOT_ENABLED
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: return Table 29 case 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*     case 3      see SELF TEST CODE later   */
comment|/* case 4 */
comment|/*     sends three ATA verify commands    */
if|if
condition|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agFALSE
operator|)
operator|)
operator|||
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agFALSE
operator|)
operator|)
condition|)
block|{
comment|/*       sector count 1, LBA 0       sector count 1, LBA MAX       sector count 1, LBA random     */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSendDiagnosticCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: return Table 29 case 4\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/* case 5 */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
operator|)
condition|)
block|{
comment|/* sends SMART EXECUTE OFF-LINE IMMEDIATE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD4
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x81
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSendDiagnosticCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: return Table 29 case 5\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/* SAT rev8 Table29 p41 case 3*/
comment|/* checking SELF TEST CODE*/
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
operator|)
condition|)
block|{
comment|/* SAT rev8 Table28 p40 */
comment|/* finding self-test code */
switch|switch
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_TEST_CODE_MASK
operator|)
operator|>>
literal|5
condition|)
block|{
case|case
literal|1
case|:
name|pSatDevData
operator|->
name|satBGPendingDiag
operator|=
name|agTRUE
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
comment|/* sends SMART EXECUTE OFF-LINE IMMEDIATE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD4
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.        */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSendDiagnosticCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.        */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: return Table 28 case 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
case|case
literal|2
case|:
name|pSatDevData
operator|->
name|satBGPendingDiag
operator|=
name|agTRUE
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
comment|/* issuing SMART EXECUTE OFF-LINE IMMEDIATE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD4
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x02
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.        */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSendDiagnosticCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.        */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: return Table 28 case 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
case|case
literal|4
case|:
comment|/* For simplicity, no abort is supported          Returns good status          need a flag in device data for previously sent background Send Diagnostic       */
if|if
condition|(
name|parmLen
operator|!=
literal|0
condition|)
block|{
comment|/* check condition */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnostic: case 4, non zero ParmLen %d\n"
operator|,
name|parmLen
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satBGPendingDiag
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends SMART EXECUTE OFF-LINE IMMEDIATE abort */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD4
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x7F
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSendDiagnosticCB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: send SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: Table 28 case 4\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
else|else
block|{
comment|/* check condition */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnostic: case 4, no pending diagnostic in background\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: Table 28 case 4\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
break|break;
case|case
literal|5
case|:
comment|/* issuing SMART EXECUTE OFF-LINE IMMEDIATE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD4
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x81
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.        */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSendDiagnosticCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.        */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: return Table 28 case 5\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
case|case
literal|6
case|:
comment|/* issuing SMART EXECUTE OFF-LINE IMMEDIATE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD4
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x82
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.        */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSendDiagnosticCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.        */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: return Table 28 case 6\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
case|case
literal|0
case|:
case|case
literal|3
case|:
comment|/* fall through */
case|case
literal|7
case|:
comment|/* fall through */
default|default:
break|break;
block|}
comment|/* switch */
comment|/* returns the results of default self-testing, which is good */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: return Table 28 case 0,3,7 and default\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic: return last\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satSendDiagnostic_1.  *  *  SAT implementation for SCSI satSendDiagnostic_1.  *  Sub function of satSendDiagnostic.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satSendDiagnostic_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     SAT Rev9, Table29, p41     send 2nd SAT_READ_VERIFY_SECTORS(_EXT)   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic_1 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/*     sector count 1, LBA MAX   */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|4
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* DEV and LBA 27:24 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSendDiagnosticCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satSendDiagnostic_2.  *  *  SAT implementation for SCSI satSendDiagnostic_2.  *  Sub function of satSendDiagnostic.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satSendDiagnostic_2
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     SAT Rev9, Table29, p41     send 3rd SAT_READ_VERIFY_SECTORS(_EXT)   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnostic_2 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/*     sector count 1, LBA Random   */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x7F
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x7F
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSendDiagnosticCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satStartStopUnit.  *  *  SAT implementation for SCSI satStartStopUnit.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satStartStopUnit
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnit:start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnit: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* Spec p55, Table 48 checking START and LOEJ bit */
comment|/* case 1 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_START_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_LOEJ_MASK
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
comment|/* immed bit , SAT rev 8, 9.11.2.1 p 54*/
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnit: return table48 case 1-1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* sends FLUSH CACHE or FLUSH CACHE EXT */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* FLUSH CACHE EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE_EXT
expr_stmt|;
comment|/* 0xEA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
block|}
else|else
block|{
comment|/* FLUSH CACHE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE
expr_stmt|;
comment|/* 0xE7 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satStartStopUnitCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnit: return table48 case 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/* case 2 */
elseif|else
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_START_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_LOEJ_MASK
operator|)
condition|)
block|{
comment|/* immed bit , SAT rev 8, 9.11.2.1 p 54*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnit: return table48 case 2 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*       sends READ_VERIFY_SECTORS(_EXT)       sector count 1, any LBA between zero to Maximum     */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satStartStopUnitCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnit: return table48 case 2 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* case 3 */
elseif|else
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_START_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_LOEJ_MASK
operator|)
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satRemovableMedia
operator|&&
name|pSatDevData
operator|->
name|satRemovableMediaEnabled
condition|)
block|{
comment|/* support for removal media */
comment|/* immed bit , SAT rev 8, 9.11.2.1 p 54*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnit: return table48 case 3 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*         sends MEDIA EJECT       */
comment|/* Media Eject fis */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_MEDIA_EJECT
expr_stmt|;
comment|/* 0xED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* sector count zero */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.        */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satStartStopUnitCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.        */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
comment|/* no support for removal media */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnit: return Table 29 case 3 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 4 */
else|else
comment|/* ( (scsiCmnd->cdb[4]& SCSI_START_MASK)&& (scsiCmnd->cdb[4]& SCSI_LOEJ_MASK) ) */
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnit: return Table 29 case 4\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satStartStopUnit_1.  *  *  SAT implementation for SCSI satStartStopUnit_1.  *  Sub function of satStartStopUnit  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satStartStopUnit_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     SAT Rev 8, Table 48, 9.11.3 p55     sends STANDBY   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnit_1 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* STANDBY */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_STANDBY
expr_stmt|;
comment|/* 0xE2 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* 0 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satStartStopUnitCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnit_1 return status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satRead10_2.  *  *  SAT implementation for SCSI satRead10_2  *  Sub function of satRead10  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satRead10_2
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     externally generated ATA cmd, there is corresponding scsi cmnd     called by satStartStopUnit() or maybe satRead10()    */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satReadVerifySectorsNoChain: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* specifying ReadVerifySectors has no chain */
name|pSatDevData
operator|->
name|satVerifyState
operator|=
literal|0xFFFFFFFF
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x7F
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0xF1
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0x5F
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x4E
expr_stmt|;
comment|/* 01001110 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x7F
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x4E
expr_stmt|;
comment|/* 01001110 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonDataIOCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satReadVerifySectorsNoChain: return last\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWriteSame10.  *  *  SAT implementation for SCSI satWriteSame10.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWriteSame10
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking LBDATA and PBDATA */
comment|/* case 1 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_LBDATA_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_PBDATA_MASK
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: case 1\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* spec 9.26.2, Table 62, p64, case 1*/
comment|/*       normal case       just like write in 9.17.1     */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
comment|/*         writeSame10 but no support for 48 bit addressing         -> problem in transfer length. Therefore, return check condition       */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10: return internal checking\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* cdb10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*       note: As of 2/10/2006, no support for DMA QUEUED     */
comment|/*       Table 34, 9.1, p 46, b (footnote)       When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),       return check condition     */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
comment|/* SAT_TR_LBA_LIMIT is 2^28, 0x10000000 */
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10: return LBA out of range\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
if|if
condition|(
name|lba
operator|+
name|tl
operator|<=
name|SAT_TR_LBA_LIMIT
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA */
comment|/* can't fit the transfer length since WRITE DMA has 1 byte for sector count */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: case 1-2 !!! error due to writeSame10\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS is chosen for easier implemetation */
comment|/* can't fit the transfer length since WRITE DMA has 1 byte for sector count */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: case 1-1 !!! error due to writesame10\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* end of case 1 and 2 */
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
comment|/* WRITE DMA EXT is chosen since WRITE SAME does not have FUA bit */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: case 1-3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* error check              ATA spec, p125, 6.17.29              pSatDevData->satMaxUserAddrSectors should be 0x0FFFFFFF              and allowed value is 0x0FFFFFFF - 1           */
if|if
condition|(
name|pSatDevData
operator|->
name|satMaxUserAddrSectors
operator|>
literal|0x0FFFFFFF
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: case 3 !!! warning can't fit sectors\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* one sector at a time */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT is chosen for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: case 1-4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* error check              ATA spec, p125, 6.17.29              pSatDevData->satMaxUserAddrSectors should be 0x0FFFFFFF              and allowed value is 0x0FFFFFFF - 1           */
if|if
condition|(
name|pSatDevData
operator|->
name|satMaxUserAddrSectors
operator|>
literal|0x0FFFFFFF
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: case 4 !!! warning can't fit sectors\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* one sector at a time */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: case 1-5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: case 1-5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* error check            ATA spec, p125, 6.17.29            pSatDevData->satMaxUserAddrSectors should be 0x0FFFFFFF            and allowed value is 0x0FFFFFFF - 1         */
if|if
condition|(
name|pSatDevData
operator|->
name|satMaxUserAddrSectors
operator|>
literal|0x0FFFFFFF
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: case 4 !!! warning can't fit sectors\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* one sector at a time */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* NO FUA bit in the WRITE SAME 10 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satWriteSame10CB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/* end of case 1 */
elseif|else
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_LBDATA_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_PBDATA_MASK
operator|)
condition|)
block|{
comment|/* spec 9.26.2, Table 62, p64, case 2*/
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: return Table 62 case 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_LBDATA_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_PBDATA_MASK
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: Table 62 case 3\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* ( (scsiCmnd->cdb[1]& SCSI_WRITE_SAME_LBDATA_MASK)&&             (scsiCmnd->cdb[1]& SCSI_WRITE_SAME_PBDATA_MASK)) */
block|{
comment|/* spec 9.26.2, Table 62, p64, case 4*/
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10: return Table 62 case 4\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWriteSame10_1.  *  *  SAT implementation for SCSI WRITESANE10 and send FIS request to LL layer.  *  This is used when WRITESAME10 is divided into multiple ATA commands  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  \param   lba:              LBA  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWriteSame10_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|lba
parameter_list|)
block|{
comment|/*     sends SAT_WRITE_DMA_EXT   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
name|lba1
decl_stmt|,
name|lba2
decl_stmt|,
name|lba3
decl_stmt|,
name|lba4
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10_1 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* MSB */
name|lba1
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF000000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
name|lba2
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x00FF0000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|lba3
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x0000FF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* LSB */
name|lba4
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0x000000FF
argument_list|)
expr_stmt|;
comment|/* SAT_WRITE_DMA_EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|lba4
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|lba3
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|lba2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|lba1
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
comment|/* one sector at a time */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satWriteSame10CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10_1 return status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWriteSame10_2.  *  *  SAT implementation for SCSI WRITESANE10 and send FIS request to LL layer.  *  This is used when WRITESAME10 is divided into multiple ATA commands  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  \param   lba:              LBA  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWriteSame10_2
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|lba
parameter_list|)
block|{
comment|/*     sends SAT_WRITE_SECTORS_EXT   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
name|lba1
decl_stmt|,
name|lba2
decl_stmt|,
name|lba3
decl_stmt|,
name|lba4
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10_2 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* MSB */
name|lba1
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF000000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
name|lba2
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x00FF0000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|lba3
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x0000FF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* LSB */
name|lba4
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0x000000FF
argument_list|)
expr_stmt|;
comment|/* SAT_WRITE_SECTORS_EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|lba4
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|lba3
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|lba2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|lba1
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
comment|/* one sector at a time */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satWriteSame10CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10_2 return status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWriteSame10_3.  *  *  SAT implementation for SCSI WRITESANE10 and send FIS request to LL layer.  *  This is used when WRITESAME10 is divided into multiple ATA commands  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  \param   lba:              LBA  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWriteSame10_3
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|lba
parameter_list|)
block|{
comment|/*     sends SAT_WRITE_FPDMA_QUEUED   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
name|lba1
decl_stmt|,
name|lba2
decl_stmt|,
name|lba3
decl_stmt|,
name|lba4
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10_3 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* MSB */
name|lba1
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF000000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
name|lba2
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x00FF0000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|lba3
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x0000FF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* LSB */
name|lba4
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0x000000FF
argument_list|)
expr_stmt|;
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
comment|/* one sector at a time */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|lba4
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|lba3
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|lba2
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* NO FUA bit in the WRITE SAME 10 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|lba1
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satWriteSame10CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10_2 return status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWriteSame16.  *  *  SAT implementation for SCSI satWriteSame16.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWriteSame16
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame16:start\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame16: return internal checking\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satLogSense_1.  *  *  Part of SAT implementation for SCSI satLogSense.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satLogSense_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense_1: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* SAT Rev 8, 10.2.4 p74 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense_1: case 2-1 sends READ LOG EXT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends READ LOG EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_LOG_EXT
expr_stmt|;
comment|/* 0x2F */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x07
expr_stmt|;
comment|/* 0x07 */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x01
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x00
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satLogSenseCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense_1: case 2-2 sends SMART READ LOG\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART READ LOG */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_READ_LOG
expr_stmt|;
comment|/* 0x2F */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x00
expr_stmt|;
comment|/* 0xd5 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x06
expr_stmt|;
comment|/* 0x06 */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x00
expr_stmt|;
comment|/* 0x4f */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0x00
expr_stmt|;
comment|/* 0xc2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x01
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x00
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satLogSenseCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satSMARTEnable.  *  *  Part of SAT implementation for SCSI satLogSense.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satSMARTEnable
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satSMARTEnable entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/*    * Send the SAT_SMART_ENABLE_OPERATIONS command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_ENABLE_OPERATIONS
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD8
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSMARTEnableCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satLogSense_3.  *  *  Part of SAT implementation for SCSI satLogSense.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satLogSense_3
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satLogSense_3 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* sends READ LOG EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_READ_LOG
expr_stmt|;
comment|/* 0x2F */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD5
expr_stmt|;
comment|/* 0xd5 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x06
expr_stmt|;
comment|/* 0x06 */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* 0x4f */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* 0xc2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x01
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x00
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satLogSenseCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satLogSense_2.  *  *  Part of SAT implementation for SCSI satLogSense.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satLogSense_2
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satLogSense_2 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* sends READ LOG EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_LOG_EXT
expr_stmt|;
comment|/* 0x2F */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x07
expr_stmt|;
comment|/* 0x07 */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x01
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x00
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satLogSenseCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satLogSenseAllocate.  *  *  Part of SAT implementation for SCSI satLogSense.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  \param   payloadSize:      size of payload to be allocated.  *  \param   flag:             flag value  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  *  \note  *    - flag values: LOG_SENSE_0, LOG_SENSE_1, LOG_SENSE_2  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satLogSenseAllocate
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|payloadSize
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext2
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satLogSense_2 entry: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|/* create internal satIOContext */
name|satIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
comment|/* original request */
name|pSatDevData
argument_list|,
name|payloadSize
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satLogSense_2: fail in allocation\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* end of memory allocation failure */
name|satIntIo
operator|->
name|satOrgTiIORequest
operator|=
name|tiIORequest
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSatDevData
operator|=
name|pSatDevData
expr_stmt|;
name|satIOContext2
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSense
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pTiSenseData
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pTiSenseData
operator|->
name|senseData
operator|=
name|satIOContext2
operator|->
name|pSense
expr_stmt|;
name|satIOContext2
operator|->
name|tiRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|->
name|interruptContext
operator|=
name|satIOContext
operator|->
name|interruptContext
expr_stmt|;
name|satIOContext2
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satIOContext2
operator|->
name|ptiDeviceHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
name|satIOContext2
operator|->
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
if|if
condition|(
name|flag
operator|==
name|LOG_SENSE_0
condition|)
block|{
comment|/* SAT_SMART_ENABLE_OPERATIONS */
name|status
operator|=
name|satSMARTEnable
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiIORequest
operator|)
argument_list|,
name|tiDeviceHandle
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|)
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
name|LOG_SENSE_1
condition|)
block|{
comment|/* SAT_READ_LOG_EXT */
name|status
operator|=
name|satLogSense_2
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiIORequest
operator|)
argument_list|,
name|tiDeviceHandle
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|)
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_SMART_READ_LOG */
comment|/* SAT_READ_LOG_EXT */
name|status
operator|=
name|satLogSense_3
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiIORequest
operator|)
argument_list|,
name|tiDeviceHandle
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|)
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satLogSense.  *  *  SAT implementation for SCSI satLogSense.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satLogSense
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pLogPage
decl_stmt|;
comment|/* Log Page data buffer */
name|bit32
name|flag
init|=
literal|0
decl_stmt|;
name|bit16
name|AllocLen
init|=
literal|0
decl_stmt|;
comment|/* allocation length */
name|bit8
name|AllLogPages
index|[
literal|8
index|]
decl_stmt|;
name|bit16
name|lenRead
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: start\n"
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|AllLogPages
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satLogSense: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|AllocLen
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
comment|/* checking PC (Page Control) */
comment|/* nothing */
comment|/* special cases */
if|if
condition|(
name|AllocLen
operator|==
literal|4
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSense: AllocLen is 4\n"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_LOG_SENSE_PAGE_CODE_MASK
condition|)
block|{
case|case
name|LOGSENSE_SUPPORTED_LOG_PAGES
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case LOGSENSE_SUPPORTED_LOG_PAGES\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* SAT Rev 8, 10.2.5 p76 */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTFeatureSet
operator|==
name|agTRUE
condition|)
block|{
comment|/* add informational exception log */
name|flag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
condition|)
block|{
comment|/* add Self-Test results log page */
name|flag
operator|=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* only supported, no informational exception log, no  Self-Test results log page */
name|flag
operator|=
literal|0
expr_stmt|;
block|}
name|lenRead
operator|=
literal|4
expr_stmt|;
name|AllLogPages
index|[
literal|0
index|]
operator|=
name|LOGSENSE_SUPPORTED_LOG_PAGES
expr_stmt|;
comment|/* page code */
name|AllLogPages
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* reserved  */
switch|switch
condition|(
name|flag
condition|)
block|{
case|case
literal|0
case|:
comment|/* only supported */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
comment|/* page length */
break|break;
case|case
literal|1
case|:
comment|/* supported and informational exception log */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|2
expr_stmt|;
comment|/* page length */
break|break;
case|case
literal|2
case|:
comment|/* supported and informational exception log */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
comment|/* page length */
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSense: error unallowed flag value %d\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|osti_memcpy
argument_list|(
name|pLogPage
argument_list|,
operator|&
name|AllLogPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
break|break;
case|case
name|LOGSENSE_SELFTEST_RESULTS_PAGE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case LOGSENSE_SUPPORTED_LOG_PAGES\n"
operator|)
argument_list|)
expr_stmt|;
name|lenRead
operator|=
literal|4
expr_stmt|;
name|AllLogPages
index|[
literal|0
index|]
operator|=
name|LOGSENSE_SELFTEST_RESULTS_PAGE
expr_stmt|;
comment|/* page code */
name|AllLogPages
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* reserved  */
comment|/* page length = SELFTEST_RESULTS_LOG_PAGE_LENGTH - 1 - 3 = 400 = 0x190 */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0x01
expr_stmt|;
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|0x90
expr_stmt|;
comment|/* page length */
name|osti_memcpy
argument_list|(
name|pLogPage
argument_list|,
operator|&
name|AllLogPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
break|break;
case|case
name|LOGSENSE_INFORMATION_EXCEPTIONS_PAGE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case LOGSENSE_SUPPORTED_LOG_PAGES\n"
operator|)
argument_list|)
expr_stmt|;
name|lenRead
operator|=
literal|4
expr_stmt|;
name|AllLogPages
index|[
literal|0
index|]
operator|=
name|LOGSENSE_INFORMATION_EXCEPTIONS_PAGE
expr_stmt|;
comment|/* page code */
name|AllLogPages
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* reserved  */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
name|INFORMATION_EXCEPTIONS_LOG_PAGE_LENGTH
operator|-
literal|1
operator|-
literal|3
expr_stmt|;
comment|/* page length */
name|osti_memcpy
argument_list|(
name|pLogPage
argument_list|,
operator|&
name|AllLogPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSense: default Page Code 0x%x\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_LOG_SENSE_PAGE_CODE_MASK
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* if */
comment|/* SAT rev8 Table 11  p30*/
comment|/* checking Page Code */
switch|switch
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_LOG_SENSE_PAGE_CODE_MASK
condition|)
block|{
case|case
name|LOGSENSE_SUPPORTED_LOG_PAGES
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case 1\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* SAT Rev 8, 10.2.5 p76 */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTFeatureSet
operator|==
name|agTRUE
condition|)
block|{
comment|/* add informational exception log */
name|flag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
condition|)
block|{
comment|/* add Self-Test results log page */
name|flag
operator|=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* only supported, no informational exception log, no  Self-Test results log page */
name|flag
operator|=
literal|0
expr_stmt|;
block|}
name|AllLogPages
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page code */
name|AllLogPages
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* reserved  */
switch|switch
condition|(
name|flag
condition|)
block|{
case|case
literal|0
case|:
comment|/* only supported */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* supported page list */
name|lenRead
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|AllocLen
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* supported and informational exception log */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|2
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* supported page list */
name|AllLogPages
index|[
literal|5
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* supported page list */
name|lenRead
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|AllocLen
argument_list|,
literal|6
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* supported and informational exception log */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* supported page list */
name|AllLogPages
index|[
literal|5
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* supported page list */
name|AllLogPages
index|[
literal|6
index|]
operator|=
literal|0x2F
expr_stmt|;
comment|/* supported page list */
name|lenRead
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|AllocLen
argument_list|,
literal|7
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSense: error unallowed flag value %d\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|osti_memcpy
argument_list|(
name|pLogPage
argument_list|,
operator|&
name|AllLogPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
comment|/* comparing allocation length to Log Page byte size */
comment|/* SPC-4, 4.3.4.6, p28 */
if|if
condition|(
name|AllocLen
operator|>
name|lenRead
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSense reporting underrun lenRead=0x%x AllocLen=0x%x tiIORequest=%p\n"
operator|,
name|lenRead
operator|,
name|AllocLen
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|AllocLen
operator|-
name|lenRead
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|LOGSENSE_SELFTEST_RESULTS_PAGE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case 2\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking SMART self-test */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case 2 no SMART Self Test\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* if satSMARTEnabled is false, send SMART_ENABLE_OPERATIONS */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case 2 calling satSMARTEnable\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|satLogSenseAllocate
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|,
literal|0
argument_list|,
name|LOG_SENSE_0
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
comment|/* SAT Rev 8, 10.2.4 p74 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case 2-1 sends READ LOG EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|satLogSenseAllocate
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|,
literal|512
argument_list|,
name|LOG_SENSE_1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case 2-2 sends SMART READ LOG\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|satLogSenseAllocate
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|,
literal|512
argument_list|,
name|LOG_SENSE_2
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
block|}
break|break;
case|case
name|LOGSENSE_INFORMATION_EXCEPTIONS_PAGE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case 3\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking SMART feature set */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTFeatureSet
operator|==
name|agFALSE
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* checking SMART feature enabled */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agFALSE
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_ATA_DEVICE_FEATURE_NOT_ENABLED
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT Rev 8, 10.2.3 p72 */
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSense: case 3 sends SMART RETURN STATUS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART RETURN STATUS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_RETURN_STATUS
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xDA
expr_stmt|;
comment|/* FIS features */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.            */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satLogSenseCB
expr_stmt|;
comment|/*            * Prepare SGL and send FIS to LL layer.            */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSense: default Page Code 0x%x\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_LOG_SENSE_PAGE_CODE_MASK
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* end switch */
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satModeSelect6.  *  *  SAT implementation for SCSI satModeSelect6.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satModeSelect6
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pLogPage
decl_stmt|;
comment|/* Log Page data buffer */
name|bit32
name|StartingIndex
init|=
literal|0
decl_stmt|;
name|bit8
name|PageCode
init|=
literal|0
decl_stmt|;
name|bit32
name|chkCnd
init|=
name|agFALSE
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satModeSelect6: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking PF bit */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_MODE_SELECT6_PF_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6: PF bit check \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking Block Descriptor Length on Mode parameter header(6)*/
if|if
condition|(
name|pLogPage
index|[
literal|3
index|]
operator|==
literal|8
condition|)
block|{
comment|/* mode parameter block descriptor exists */
name|PageCode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pLogPage
index|[
literal|12
index|]
operator|&
literal|0x3F
argument_list|)
expr_stmt|;
comment|/* page code and index is 4 + 8 */
name|StartingIndex
operator|=
literal|12
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pLogPage
index|[
literal|3
index|]
operator|==
literal|0
condition|)
block|{
comment|/* mode parameter block descriptor does not exist */
name|PageCode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pLogPage
index|[
literal|4
index|]
operator|&
literal|0x3F
argument_list|)
expr_stmt|;
comment|/* page code and index is 4 + 0 */
name|StartingIndex
operator|=
literal|4
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6: return mode parameter block descriptor 0x%x\n"
operator|,
name|pLogPage
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* no more than one mode parameter block descriptor shall be supported */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
switch|switch
condition|(
name|PageCode
condition|)
comment|/* page code */
block|{
case|case
name|MODESELECT_CONTROL_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6: Control mode page\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       compare pLogPage to expected value (SAT Table 65, p67)       If not match, return check condition      */
if|if
condition|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|1
index|]
operator|!=
literal|0x0A
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|!=
literal|0x02
operator|||
operator|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
operator|&&
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|!=
literal|0x12
operator|)
operator|||
operator|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agFALSE
operator|&&
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|!=
literal|0x02
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT3_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* SWP bit */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT4_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* UA_INTLCK_CTRL */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT5_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* UA_INTLCK_CTRL */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT0_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT1_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT2_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT6_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* TAS bit */
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|8
index|]
operator|!=
literal|0xFF
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|9
index|]
operator|!=
literal|0xFF
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|!=
literal|0x00
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|!=
literal|0x00
condition|)
block|{
name|chkCnd
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|chkCnd
operator|==
name|agTRUE
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect10: unexpected values\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
break|break;
case|case
name|MODESELECT_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6: Read-Write Error Recovery mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_AWRE_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_RC_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_EER_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_PER_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_DTE_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_DCR_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6: return check condition \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6: return GOOD \n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
break|break;
case|case
name|MODESELECT_CACHING
case|:
comment|/* SAT rev8 Table67, p69*/
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6: Caching mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
literal|0xFB
operator|)
operator|||
comment|/* 1111 1011 */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|6
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|7
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|8
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|9
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|12
index|]
operator|&
literal|0xC1
operator|)
operator|||
comment|/* 1100 0001 */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|13
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|14
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|15
index|]
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6: return check condition \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
comment|/* sends ATA SET FEATURES based on WCE bit */
if|if
condition|(
operator|!
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_WCE_MASK
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6: disable write cache\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x82
expr_stmt|;
comment|/* disable write cache */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6: enable write cache\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x02
expr_stmt|;
comment|/* enable write cache */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
break|break;
case|case
name|MODESELECT_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6: Informational Exception Control mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_PERF_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_TEST_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6: return check condition \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
comment|/* sends either ATA SMART ENABLE/DISABLE OPERATIONS based on DEXCPT bit */
if|if
condition|(
operator|!
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
literal|0x08
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6: enable information exceptions reporting\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART ENABLE OPERATIONS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_ENABLE_OPERATIONS
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD8
expr_stmt|;
comment|/* enable */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* 0x4F */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* 0xC2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6: disable information exceptions reporting\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART DISABLE OPERATIONS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_DISABLE_OPERATIONS
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD9
expr_stmt|;
comment|/* disable */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* 0x4F */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* 0xC2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6: Error unknown page code 0x%x\n"
operator|,
name|pLogPage
index|[
literal|12
index|]
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satModeSelect6n10_1.  *  *  This function is part of implementation of ModeSelect6 and ModeSelect10.  *  When ModeSelect6 or ModeSelect10 is coverted into multiple ATA commands,  *  this function is used.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satModeSelect6n10_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/* sends either ATA SET FEATURES based on DRA bit */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pLogPage
decl_stmt|;
comment|/* Log Page data buffer */
name|bit32
name|StartingIndex
init|=
literal|0
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6_1: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking Block Descriptor Length on Mode parameter header(6)*/
if|if
condition|(
name|pLogPage
index|[
literal|3
index|]
operator|==
literal|8
condition|)
block|{
comment|/* mode parameter block descriptor exists */
name|StartingIndex
operator|=
literal|12
expr_stmt|;
block|}
else|else
block|{
comment|/* mode parameter block descriptor does not exist */
name|StartingIndex
operator|=
literal|4
expr_stmt|;
block|}
comment|/* sends ATA SET FEATURES based on DRA bit */
if|if
condition|(
operator|!
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|12
index|]
operator|&
name|SCSI_MODE_SELECT6_DRA_MASK
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6_1: enable read look-ahead feature\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xAA
expr_stmt|;
comment|/* enable read look-ahead */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satModeSelect6n10CB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6_1: disable read look-ahead feature\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x55
expr_stmt|;
comment|/* disable read look-ahead */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satModeSelect6n10CB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satModeSelect10.  *  *  SAT implementation for SCSI satModeSelect10.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satModeSelect10
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pLogPage
decl_stmt|;
comment|/* Log Page data buffer */
name|bit16
name|BlkDescLen
init|=
literal|0
decl_stmt|;
comment|/* Block Descriptor Length */
name|bit32
name|StartingIndex
init|=
literal|0
decl_stmt|;
name|bit8
name|PageCode
init|=
literal|0
decl_stmt|;
name|bit32
name|chkCnd
init|=
name|agFALSE
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satModeSelect10: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking PF bit */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_MODE_SELECT10_PF_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect10: PF bit check \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|BlkDescLen
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pLogPage
index|[
literal|6
index|]
operator|<<
literal|8
operator|)
operator|+
name|pLogPage
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
comment|/* checking Block Descriptor Length on Mode parameter header(10) and LONGLBA bit*/
if|if
condition|(
operator|(
name|BlkDescLen
operator|==
literal|8
operator|)
operator|&&
operator|!
operator|(
name|pLogPage
index|[
literal|4
index|]
operator|&
name|SCSI_MODE_SELECT10_LONGLBA_MASK
operator|)
condition|)
block|{
comment|/* mode parameter block descriptor exists and length is 8 byte */
name|PageCode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pLogPage
index|[
literal|16
index|]
operator|&
literal|0x3F
argument_list|)
expr_stmt|;
comment|/* page code and index is 8 + 8 */
name|StartingIndex
operator|=
literal|16
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|BlkDescLen
operator|==
literal|16
operator|)
operator|&&
operator|(
name|pLogPage
index|[
literal|4
index|]
operator|&
name|SCSI_MODE_SELECT10_LONGLBA_MASK
operator|)
condition|)
block|{
comment|/* mode parameter block descriptor exists and length is 16 byte */
name|PageCode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pLogPage
index|[
literal|24
index|]
operator|&
literal|0x3F
argument_list|)
expr_stmt|;
comment|/* page code and index is 8 + 16 */
name|StartingIndex
operator|=
literal|24
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|BlkDescLen
operator|==
literal|0
condition|)
block|{
comment|/*       mode parameter block descriptor does not exist       */
name|PageCode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pLogPage
index|[
literal|8
index|]
operator|&
literal|0x3F
argument_list|)
expr_stmt|;
comment|/* page code and index is 8 + 0 */
name|StartingIndex
operator|=
literal|8
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect10: return mode parameter block descriptor 0x%x\n"
operator|,
name|BlkDescLen
operator|)
argument_list|)
expr_stmt|;
comment|/* no more than one mode parameter block descriptor shall be supported */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/*     for debugging only   */
if|if
condition|(
name|StartingIndex
operator|==
literal|8
condition|)
block|{
name|tdhexdump
argument_list|(
literal|"startingindex 8"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pLogPage
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|StartingIndex
operator|==
literal|16
condition|)
block|{
if|if
condition|(
name|PageCode
operator|==
name|MODESELECT_CACHING
condition|)
block|{
name|tdhexdump
argument_list|(
literal|"startingindex 16"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pLogPage
argument_list|,
literal|16
operator|+
literal|20
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdhexdump
argument_list|(
literal|"startingindex 16"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pLogPage
argument_list|,
literal|16
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|PageCode
operator|==
name|MODESELECT_CACHING
condition|)
block|{
name|tdhexdump
argument_list|(
literal|"startingindex 24"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pLogPage
argument_list|,
literal|24
operator|+
literal|20
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdhexdump
argument_list|(
literal|"startingindex 24"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pLogPage
argument_list|,
literal|24
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|PageCode
condition|)
comment|/* page code */
block|{
case|case
name|MODESELECT_CONTROL_PAGE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect10: Control mode page\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       compare pLogPage to expected value (SAT Table 65, p67)       If not match, return check condition      */
if|if
condition|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|1
index|]
operator|!=
literal|0x0A
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|!=
literal|0x02
operator|||
operator|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
operator|&&
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|!=
literal|0x12
operator|)
operator|||
operator|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agFALSE
operator|&&
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|!=
literal|0x02
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT3_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* SWP bit */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT4_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* UA_INTLCK_CTRL */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT5_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* UA_INTLCK_CTRL */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT0_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT1_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT2_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT6_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* TAS bit */
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|8
index|]
operator|!=
literal|0xFF
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|9
index|]
operator|!=
literal|0xFF
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|!=
literal|0x00
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|!=
literal|0x00
condition|)
block|{
name|chkCnd
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|chkCnd
operator|==
name|agTRUE
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect10: unexpected values\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
break|break;
case|case
name|MODESELECT_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect10: Read-Write Error Recovery mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_AWRE_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_RC_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_EER_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_PER_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_DTE_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_DCR_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect10: return check condition \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"satModeSelect10: return GOOD \n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
break|break;
case|case
name|MODESELECT_CACHING
case|:
comment|/* SAT rev8 Table67, p69*/
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect10: Caching mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
literal|0xFB
operator|)
operator|||
comment|/* 1111 1011 */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|6
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|7
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|8
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|9
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|12
index|]
operator|&
literal|0xC1
operator|)
operator|||
comment|/* 1100 0001 */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|13
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|14
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|15
index|]
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect10: return check condition \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
comment|/* sends ATA SET FEATURES based on WCE bit */
if|if
condition|(
operator|!
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_WCE_MASK
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect10: disable write cache\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x82
expr_stmt|;
comment|/* disable write cache */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect10: enable write cache\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x02
expr_stmt|;
comment|/* enable write cache */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
break|break;
case|case
name|MODESELECT_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect10: Informational Exception Control mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_PERF_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_TEST_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect10: return check condition \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
comment|/* sends either ATA SMART ENABLE/DISABLE OPERATIONS based on DEXCPT bit */
if|if
condition|(
operator|!
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_DEXCPT_MASK
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect10: enable information exceptions reporting\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART ENABLE OPERATIONS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_ENABLE_OPERATIONS
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD8
expr_stmt|;
comment|/* enable */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* 0x4F */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* 0xC2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect10: disable information exceptions reporting\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART DISABLE OPERATIONS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART_DISABLE_OPERATIONS
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xD9
expr_stmt|;
comment|/* disable */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* 0x4F */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* 0xC2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect10: Error unknown page code 0x%x\n"
operator|,
name|pLogPage
index|[
literal|12
index|]
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satSynchronizeCache10.  *  *  SAT implementation for SCSI satSynchronizeCache10.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satSynchronizeCache10
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSynchronizeCache10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satSynchronizeCache10: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking IMMED bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SYNC_CACHE_IMMED_MASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSynchronizeCache10: GOOD status due to IMMED bit\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* return GOOD status first here */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
comment|/* sends FLUSH CACHE or FLUSH CACHE EXT */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satSynchronizeCache10: sends FLUSH CACHE EXT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* FLUSH CACHE EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE_EXT
expr_stmt|;
comment|/* 0xEA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satSynchronizeCache10: sends FLUSH CACHE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* FLUSH CACHE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE
expr_stmt|;
comment|/* 0xE7 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSynchronizeCache10n16CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satSynchronizeCache16.  *  *  SAT implementation for SCSI satSynchronizeCache16.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satSynchronizeCache16
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSynchronizeCache16: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSynchronizeCache16: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking IMMED bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SYNC_CACHE_IMMED_MASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSynchronizeCache16: GOOD status due to IMMED bit\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* return GOOD status first here */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
comment|/* sends FLUSH CACHE or FLUSH CACHE EXT */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satSynchronizeCache16: sends FLUSH CACHE EXT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* FLUSH CACHE EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE_EXT
expr_stmt|;
comment|/* 0xEA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satSynchronizeCache16: sends FLUSH CACHE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* FLUSH CACHE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE
expr_stmt|;
comment|/* 0xE7 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satSynchronizeCache10n16CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWriteAndVerify10.  *  *  SAT implementation for SCSI satWriteAndVerify10.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWriteAndVerify10
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     combination of write10 and verify10   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|4
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking BYTCHK bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_N_VERIFY_BYTCHK_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify10: BYTCHK bit checking \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify10: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit32
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
comment|/* cbd10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify10: return LBA out of range\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWrite10: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
operator|!
name|rangeChk
condition|)
comment|//  if (lba + tl<= SAT_TR_LBA_LIMIT)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* can't fit the transfer length */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 2 !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* can't fit the transfer length */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 1 !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_N_VERIFY10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedWriteNVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify10: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedWriteNVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_function
name|GLOBAL
name|bit32
name|satWriteAndVerify10
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     combination of write10 and verify10   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking BYTCHK bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_N_VERIFY_BYTCHK_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify10: BYTCHK bit checking \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satWriteAndVerify10: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* let's do write10 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
comment|/*       writeandverify10 but no support for 48 bit addressing -> problem in transfer       length(sector count)     */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify10: return internal checking\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* cbd10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify10: return LBA out of range\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
name|lba
operator|+
name|tl
operator|<=
name|SAT_TR_LBA_LIMIT
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* can't fit the transfer length */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 2 !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* can't fit the transfer length */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 1 !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_N_VERIFY10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satWriteAndVerify10CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* REMOVED */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWriteAndVerify10_1.  *  *  SAT implementation for SCSI satWriteAndVerify10_1.  *  Sub function of satWriteAndVerify10  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWriteAndVerify10_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify10_1: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satWriteAndVerify10CB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify10_1: return status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
else|else
block|{
comment|/* can't fit in SAT_READ_VERIFY_SECTORS becasue of Sector Count and LBA */
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify10_1: can't fit in SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* REMOVED */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWriteAndVerify12.  *  *  SAT implementation for SCSI satWriteAndVerify12.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWriteAndVerify12
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     combination of write12 and verify12     temp: since write12 is not support (due to internal checking), no support   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|4
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify12: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking BYTCHK bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_N_VERIFY_BYTCHK_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify12: BYTCHK bit checking \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satWriteAndVerify12: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit32
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
name|lba
operator|=
name|satComputeCDB12LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|satComputeCDB12TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify12: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify12: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
operator|!
name|rangeChk
condition|)
comment|//  if (lba + tl<= SAT_TR_LBA_LIMIT)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* In case that we can't fit the transfer length, we loop */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify12: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* In case that we can't fit the transfer length, we loop */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify12: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify12: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify12: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify12: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satWriteAndVerify12: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE12_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
comment|//  satIOContext->OrgLBA = lba;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
name|satIOContext
operator|->
name|LoopNum2
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify12: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedWriteNVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify12: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedWriteNVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|satNonChainedWriteNVerify_Verify
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedWriteNVerify_Verify: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedWriteNVerifyCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerify_Verify: return status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
else|else
block|{
comment|/* can't fit in SAT_READ_VERIFY_SECTORS becasue of Sector Count and LBA */
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerify_Verify: can't fit in SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|satChainedWriteNVerify_Write
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     Assumption: error check on lba and tl has been done in satWrite*()     lba = lba + tl;   */
name|bit32
name|status
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|agNULL
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|DenomTL
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|Remainder
init|=
literal|0
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
comment|/* 0 MSB, 3 LSB */
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Write: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_WRITE_DMA
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_FUA_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Write: error incorrect ata command 0x%x\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
name|Remainder
operator|=
name|satOrgIOContext
operator|->
name|OrgTL
operator|%
name|DenomTL
expr_stmt|;
name|satOrgIOContext
operator|->
name|currentLBA
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
operator|+
name|DenomTL
expr_stmt|;
name|lba
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
expr_stmt|;
name|LBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF0
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0xF
argument_list|)
expr_stmt|;
comment|/* LSB */
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_WRITE_DMA
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x3D */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
empty_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Write: error incorrect ata command 0x%x\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
comment|/* Initialize CB for SATA completion.    */
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedWriteNVerifyCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Write: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*   similar to write12 and verify10;   this will be similar to verify12   */
end_comment

begin_function
name|GLOBAL
name|bit32
name|satChainedWriteNVerify_Start_Verify
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     deal with transfer length; others have been handled previously at this point;     no LBA check; no range check;   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|4
index|]
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Start_Verify: start\n"
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
name|lba
operator|=
name|satComputeCDB12LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|satComputeCDB12TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Start_Verify: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Start_Verify: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Start_Verify: error case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|LoopNum
operator|=
literal|1
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Start_Verify: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedWriteNVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Start_Verify: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Start_Verify: error case 2!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedWriteNVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|satChainedWriteNVerify_Verify
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|agNULL
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|DenomTL
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|Remainder
init|=
literal|0
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
comment|/* 0 MSB, 3 LSB */
name|TI_DBG2
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Verify: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Verify: error incorrect ata command 0x%x\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
name|Remainder
operator|=
name|satOrgIOContext
operator|->
name|OrgTL
operator|%
name|DenomTL
expr_stmt|;
name|satOrgIOContext
operator|->
name|currentLBA
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
operator|+
name|DenomTL
expr_stmt|;
name|lba
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
expr_stmt|;
name|LBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF0
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0xF
argument_list|)
expr_stmt|;
comment|/* LSB */
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Verify: error incorrect ata command 0x%x\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
comment|/* Initialize CB for SATA completion.    */
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedWriteNVerifyCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Verify: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWriteAndVerify16.  *  *  SAT implementation for SCSI satWriteAndVerify16.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWriteAndVerify16
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     combination of write16 and verify16     since write16 has 8 bytes LBA -> problem ATA LBA(upto 6 bytes), no support   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|rangeChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|bit32
name|limitChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba and tl range check */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify16:start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking BYTCHK bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_N_VERIFY_BYTCHK_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify16: BYTCHK bit checking \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satWriteAndVerify16: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* LSB */
name|rangeChk
operator|=
name|satAddNComparebit64
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|)
expr_stmt|;
name|limitChk
operator|=
name|satCompareLBALimitbit
argument_list|(
name|LBA
argument_list|)
expr_stmt|;
name|lba
operator|=
name|satComputeCDB16LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|satComputeCDB16TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED   */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|limitChk
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify16: return LBA out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|rangeChk
condition|)
comment|//    if (lba + tl> SAT_TR_LBA_LIMIT)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify16: return LBA+TL out of range, not EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
operator|!
name|rangeChk
condition|)
comment|//  if (lba + tl<= SAT_TR_LBA_LIMIT)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* In case that we can't fit the transfer length, we loop */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify16: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* In case that we can't fit the transfer length, we loop */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify16: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify16: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify16: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify16: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satWriteAndVerify16: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE16_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|satComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteAndVerify16: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satNonChainedWriteNVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteAndVerify16: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satChainedWriteNVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satReadMediaSerialNumber.  *  *  SAT implementation for SCSI Read Media Serial Number.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satReadMediaSerialNumber
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_PIO_READ
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit8
modifier|*
name|pSerialNumber
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pSATAIdData
operator|=
operator|&
operator|(
name|pSatDevData
operator|->
name|satIdentifyData
operator|)
expr_stmt|;
name|pSerialNumber
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadMediaSerialNumber: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadMediaSerialNumber: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
operator|==
literal|4
condition|)
block|{
if|if
condition|(
name|pSATAIdData
operator|->
name|commandSetFeatureDefault
operator|&
literal|0x4
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadMediaSerialNumber: Media serial number returning only length\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* SPC-3 6.16 p192; filling in length */
name|pSerialNumber
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|pSerialNumber
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pSerialNumber
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pSerialNumber
index|[
literal|3
index|]
operator|=
literal|0x3C
expr_stmt|;
block|}
else|else
block|{
comment|/* 1 sector - 4 = 512 - 4 to avoid underflow; 0x1fc*/
name|pSerialNumber
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|pSerialNumber
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pSerialNumber
index|[
literal|2
index|]
operator|=
literal|0x1
expr_stmt|;
name|pSerialNumber
index|[
literal|3
index|]
operator|=
literal|0xfc
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|IDDeviceValid
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSATAIdData
operator|->
name|commandSetFeatureDefault
operator|&
literal|0x4
condition|)
block|{
comment|/* word87 bit2 Media serial number is valid */
comment|/* read word 176 to 205; length is 2*30 = 60 = 0x3C*/
name|tdhexdump
argument_list|(
literal|"ID satReadMediaSerialNumber"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pSATAIdData
operator|->
name|currentMediaSerialNumber
argument_list|,
literal|2
operator|*
literal|30
argument_list|)
expr_stmt|;
comment|/* SPC-3 6.16 p192; filling in length */
name|pSerialNumber
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|pSerialNumber
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pSerialNumber
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pSerialNumber
index|[
literal|3
index|]
operator|=
literal|0x3C
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|pSerialNumber
index|[
literal|4
index|]
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pSATAIdData
operator|->
name|currentMediaSerialNumber
argument_list|,
literal|60
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"satReadMediaSerialNumber"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pSerialNumber
argument_list|,
literal|2
operator|*
literal|30
operator|+
literal|4
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
comment|/* word87 bit2 Media serial number is NOT valid */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadMediaSerialNumber: Media serial number is NOT valid \n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ VERIFY SECTORS EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTORS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
block|}
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satReadMediaSerialNumberCB
expr_stmt|;
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
else|else
block|{
comment|/* temporary failure */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satReadBuffer.  *  *  SAT implementation for SCSI Read Buffer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* SAT-2, Revision 00*/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satReadBuffer
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
init|=
name|tiSuccess
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_PIO_READ
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|bufferOffset
decl_stmt|;
name|bit32
name|tl
decl_stmt|;
name|bit8
name|mode
decl_stmt|;
name|bit8
name|bufferID
decl_stmt|;
name|bit8
modifier|*
name|pBuff
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pBuff
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satReadBuffer: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadBuffer: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|bufferOffset
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|mode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ_BUFFER_MODE_MASK
argument_list|)
expr_stmt|;
name|bufferID
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|READ_BUFFER_DATA_MODE
condition|)
comment|/* 2 */
block|{
if|if
condition|(
name|bufferID
operator|==
literal|0
operator|&&
name|bufferOffset
operator|==
literal|0
operator|&&
name|tl
operator|==
literal|512
condition|)
block|{
comment|/* send ATA READ BUFFER */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_BUFFER
expr_stmt|;
comment|/* 0xE4 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satReadBufferCB
expr_stmt|;
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|bufferID
operator|==
literal|0
operator|&&
name|bufferOffset
operator|==
literal|0
operator|&&
name|tl
operator|!=
literal|512
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadBuffer: allocation length is not 512; it is %d\n"
operator|,
name|tl
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|bufferID
operator|==
literal|0
operator|&&
name|bufferOffset
operator|!=
literal|0
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadBuffer: buffer offset is not 0; it is %d\n"
operator|,
name|bufferOffset
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* all other cases unsupported */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadBuffer: unsupported case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
name|READ_BUFFER_DESCRIPTOR_MODE
condition|)
comment|/* 3 */
block|{
if|if
condition|(
name|tl
operator|<
name|READ_BUFFER_DESCRIPTOR_MODE_DATA_LEN
condition|)
comment|/* 4 */
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadBuffer: tl< 4; tl is %d\n"
operator|,
name|tl
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
name|bufferID
operator|==
literal|0
condition|)
block|{
comment|/* SPC-4, 6.15.5, p189; SAT-2 Rev00, 8.7.2.3, p41*/
name|pBuff
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
name|pBuff
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
name|pBuff
index|[
literal|2
index|]
operator|=
literal|0x02
expr_stmt|;
name|pBuff
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|READ_BUFFER_DESCRIPTOR_MODE_DATA_LEN
operator|<
name|tl
condition|)
block|{
comment|/* underrrun */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadBuffer: underrun tl %d data %d\n"
operator|,
name|tl
operator|,
name|READ_BUFFER_DESCRIPTOR_MODE_DATA_LEN
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|tl
operator|-
name|READ_BUFFER_DESCRIPTOR_MODE_DATA_LEN
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
else|else
block|{
comment|/* We don't support other than bufferID 0 */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
else|else
block|{
comment|/* We don't support any other mode */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadBuffer: unsupported mode %d\n"
operator|,
name|mode
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satWriteBuffer.  *  *  SAT implementation for SCSI Write Buffer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* SAT-2, Revision 00*/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satWriteBuffer
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|NOT_YET
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_PIO_READ
decl_stmt|;
endif|#
directive|endif
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|bufferOffset
decl_stmt|;
name|bit32
name|parmLen
decl_stmt|;
name|bit8
name|mode
decl_stmt|;
name|bit8
name|bufferID
decl_stmt|;
name|bit8
modifier|*
name|pBuff
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pBuff
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satWriteBuffer: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteBuffer: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|bufferOffset
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|parmLen
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|mode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ_BUFFER_MODE_MASK
argument_list|)
expr_stmt|;
name|bufferID
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* for debugging only */
name|tdhexdump
argument_list|(
literal|"satWriteBuffer pBuff"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pBuff
argument_list|,
literal|24
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|WRITE_BUFFER_DATA_MODE
condition|)
comment|/* 2 */
block|{
if|if
condition|(
name|bufferID
operator|==
literal|0
operator|&&
name|bufferOffset
operator|==
literal|0
operator|&&
name|parmLen
operator|==
literal|512
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteBuffer: sending ATA WRITE BUFFER\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* send ATA WRITE BUFFER */
ifdef|#
directive|ifdef
name|NOT_YET
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_BUFFER
expr_stmt|;
comment|/* 0xE8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satWriteBufferCB
expr_stmt|;
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
endif|#
directive|endif
comment|/* temp */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
if|if
condition|(
operator|(
name|bufferID
operator|==
literal|0
operator|&&
name|bufferOffset
operator|!=
literal|0
operator|)
operator|||
operator|(
name|bufferID
operator|==
literal|0
operator|&&
name|parmLen
operator|!=
literal|512
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteBuffer: wrong buffer offset %d or parameter length parmLen %d\n"
operator|,
name|bufferOffset
operator|,
name|parmLen
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
comment|/* all other cases unsupported */
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteBuffer: unsupported case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
name|WRITE_BUFFER_DL_MICROCODE_SAVE_MODE
condition|)
comment|/* 5 */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteBuffer: not yet supported mode %d\n"
operator|,
name|mode
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
comment|/* We don't support any other mode */
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteBuffer: unsupported mode %d\n"
operator|,
name|mode
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satReassignBlocks.  *  *  SAT implementation for SCSI Reassign Blocks.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satReassignBlocks
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     assumes all LBA fits in ATA command; no boundary condition is checked here yet   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pParmList
decl_stmt|;
comment|/* Log Page data buffer */
name|bit8
name|LongLBA
decl_stmt|;
name|bit8
name|LongList
decl_stmt|;
name|bit32
name|defectListLen
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|startingIndex
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pParmList
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satReassignBlocks: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocks: return control\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|osti_memset
argument_list|(
name|satIOContext
operator|->
name|LBA
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|ParmIndex
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|ParmLen
operator|=
literal|0
expr_stmt|;
name|LongList
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_REASSIGN_BLOCKS_LONGLIST_MASK
argument_list|)
expr_stmt|;
name|LongLBA
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_REASSIGN_BLOCKS_LONGLBA_MASK
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|LongList
operator|==
literal|0
condition|)
block|{
name|defectListLen
operator|=
operator|(
name|pParmList
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
name|pParmList
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
block|{
name|defectListLen
operator|=
operator|(
name|pParmList
index|[
literal|0
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|pParmList
index|[
literal|1
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|pParmList
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
name|pParmList
index|[
literal|3
index|]
expr_stmt|;
block|}
comment|/* SBC 5.16.2, p61*/
name|satIOContext
operator|->
name|ParmLen
operator|=
name|defectListLen
operator|+
literal|4
comment|/* header size */
expr_stmt|;
name|startingIndex
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|LongLBA
operator|==
literal|0
condition|)
block|{
name|LBA
index|[
literal|4
index|]
operator|=
name|pParmList
index|[
name|startingIndex
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|5
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|1
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|3
index|]
expr_stmt|;
comment|/* LSB */
name|startingIndex
operator|=
name|startingIndex
operator|+
literal|4
expr_stmt|;
block|}
else|else
block|{
name|LBA
index|[
literal|0
index|]
operator|=
name|pParmList
index|[
name|startingIndex
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|1
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|7
index|]
expr_stmt|;
comment|/* LSB */
name|startingIndex
operator|=
name|startingIndex
operator|+
literal|8
expr_stmt|;
block|}
name|tdhexdump
argument_list|(
literal|"satReassignBlocks Parameter list"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pParmList
argument_list|,
literal|4
operator|+
name|defectListLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|4
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* DEV and LBA 27:24 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|osti_memcpy
argument_list|(
name|satIOContext
operator|->
name|LBA
argument_list|,
name|LBA
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|ParmIndex
operator|=
name|startingIndex
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satReassignBlocksCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satReassignBlocks_1.  *  *  SAT implementation for SCSI Reassign Blocks. This is helper function for  *  satReassignBlocks and satReassignBlocksCB. This sends ATA verify command.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* next LBA; sends READ VERIFY SECTOR; update LBA and ParmIdx */
end_comment

begin_function
name|GLOBAL
name|bit32
name|satReassignBlocks_1
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|satIOContext_t
modifier|*
name|satOrgIOContext
parameter_list|)
block|{
comment|/*     assumes all LBA fits in ATA command; no boundary condition is checked here yet     tiScsiRequest is OS generated; needs for accessing parameter list   */
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pParmList
decl_stmt|;
comment|/* Log Page data buffer */
name|bit8
name|LongLBA
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|startingIndex
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pParmList
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satReassignBlocks_1: start\n"
operator|)
argument_list|)
expr_stmt|;
name|LongLBA
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_REASSIGN_BLOCKS_LONGLBA_MASK
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|startingIndex
operator|=
name|satOrgIOContext
operator|->
name|ParmIndex
expr_stmt|;
if|if
condition|(
name|LongLBA
operator|==
literal|0
condition|)
block|{
name|LBA
index|[
literal|4
index|]
operator|=
name|pParmList
index|[
name|startingIndex
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|1
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|3
index|]
expr_stmt|;
name|startingIndex
operator|=
name|startingIndex
operator|+
literal|4
expr_stmt|;
block|}
else|else
block|{
name|LBA
index|[
literal|0
index|]
operator|=
name|pParmList
index|[
name|startingIndex
index|]
expr_stmt|;
name|LBA
index|[
literal|1
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|1
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|7
index|]
expr_stmt|;
name|startingIndex
operator|=
name|startingIndex
operator|+
literal|8
expr_stmt|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|4
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* DEV and LBA 27:24 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|osti_memcpy
argument_list|(
name|satOrgIOContext
operator|->
name|LBA
argument_list|,
name|LBA
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|->
name|ParmIndex
operator|=
name|startingIndex
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satReassignBlocksCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satReassignBlocks_2.  *  *  SAT implementation for SCSI Reassign Blocks. This is helper function for  *  satReassignBlocks and satReassignBlocksCB. This sends ATA write command.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  \param   LBA:              Pointer to the LBA to be processed  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* current LBA; sends WRITE */
end_comment

begin_function
name|GLOBAL
name|bit32
name|satReassignBlocks_2
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit8
modifier|*
name|LBA
parameter_list|)
block|{
comment|/*     assumes all LBA fits in ATA command; no boundary condition is checked here yet     tiScsiRequest is TD generated for writing   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* can't fit the transfer length */
name|TI_DBG5
argument_list|(
operator|(
literal|"satReassignBlocks_2: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|4
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* can't fit the transfer length */
name|TI_DBG5
argument_list|(
operator|(
literal|"satReassignBlocks_2: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|4
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|TI_DBG5
argument_list|(
operator|(
literal|"satReassignBlocks_2: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|TI_DBG5
argument_list|(
operator|(
literal|"satReassignBlocks_2: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satReassignBlocks_2: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satWrite10: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satReassignBlocksCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
comment|/* not the original, should be the TD generated one */
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI satPrepareNewIO.  *  *  This function fills in the fields of internal IO generated by TD layer.  *  This is mostly used in the callback functions.  *  *  \param   satNewIntIo:      Pointer to the internal IO structure.  *  \param   tiOrgIORequest:   Pointer to the original tiIOrequest sent by OS layer  *  \param   satDevData:       Pointer to the device data.  *  \param   scsiCmnd:         Pointer to SCSI command.  *  \param   satOrgIOContext:  Pointer to the original SAT IO Context  *  *  \return  *    - \e Pointer to the new SAT IO Context  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|satIOContext_t
modifier|*
name|satPrepareNewIO
parameter_list|(
name|satInternalIo_t
modifier|*
name|satNewIntIo
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
parameter_list|,
name|satDeviceData_t
modifier|*
name|satDevData
parameter_list|,
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
parameter_list|,
name|satIOContext_t
modifier|*
name|satOrgIOContext
parameter_list|)
block|{
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdNewIORequestBody
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satPrepareNewIO: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* the one to be used; good 8/2/07 */
name|satNewIntIo
operator|->
name|satOrgTiIORequest
operator|=
name|tiOrgIORequest
expr_stmt|;
comment|/* this is already done in                                                         satAllocIntIoResource() */
name|tdNewIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satNewIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|=
operator|&
operator|(
name|tdNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSatDevData
operator|=
name|satDevData
expr_stmt|;
name|satNewIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
if|if
condition|(
name|scsiCmnd
operator|!=
name|agNULL
condition|)
block|{
comment|/* saves only CBD; not scsi command for LBA and number of blocks */
name|osti_memcpy
argument_list|(
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|->
name|cdb
argument_list|,
name|scsiCmnd
operator|->
name|cdb
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
name|satNewIOContext
operator|->
name|pSense
operator|=
operator|&
operator|(
name|tdNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pTiSenseData
operator|=
operator|&
operator|(
name|tdNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pTiSenseData
operator|->
name|senseData
operator|=
name|satNewIOContext
operator|->
name|pSense
expr_stmt|;
name|satNewIOContext
operator|->
name|tiRequestBody
operator|=
name|satNewIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|->
name|interruptContext
operator|=
name|satNewIOContext
operator|->
name|interruptContext
expr_stmt|;
name|satNewIOContext
operator|->
name|satIntIoContext
operator|=
name|satNewIntIo
expr_stmt|;
name|satNewIOContext
operator|->
name|ptiDeviceHandle
operator|=
name|satOrgIOContext
operator|->
name|ptiDeviceHandle
expr_stmt|;
name|satNewIOContext
operator|->
name|satOrgIOContext
operator|=
name|satOrgIOContext
expr_stmt|;
comment|/* saves tiScsiXchg; only for writesame10() */
name|satNewIOContext
operator|->
name|tiScsiXchg
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
return|return
name|satNewIOContext
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief  satIOAbort  *  *   This routine is called to initiate a I/O abort to SATL.  *   This routine is independent of HW/LL API.  *  *  \param  tiRoot:     Pointer to TISA initiator driver/port instance.  *  \param  taskTag:    Pointer to TISA I/O request context/tag to be aborted.  *  *  \return:  *  *  \e tiSuccess:     I/O request successfully initiated.  *  \e tiBusy:        No resources available, try again later.  *  \e tiError:       Other errors that prevent the I/O request to be started.  *  *  *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satIOAbort
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|taskTag
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIONewRequestBody
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satIOAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|taskTag
operator|->
name|tdData
expr_stmt|;
comment|/* needs to distinguish internally generated or externally generated */
name|satIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOAbort: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOAbort: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIONewRequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|tdIONewRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
block|}
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOAbort: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"satIOAbort: ostiAllocMemory returned NULL tdAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/* remember IO to be aborted */
name|tdAbortIORequestBody
operator|->
name|tiIOToBeAbortedRequest
operator|=
name|taskTag
expr_stmt|;
name|status
operator|=
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agIORequest
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satIOAbort: return status=0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
return|return
name|tiSuccess
return|;
else|else
return|return
name|tiError
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief  satTM  *  *   This routine is called to initiate a TM request to SATL.  *   This routine is independent of HW/LL API.  *  *  \param  tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param  tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param  task:             SAM-3 task management request.  *  \param  lun:              Pointer to LUN.  *  \param  taskTag:          Pointer to the associated task where the TM  *                            command is to be applied.  *  \param  currentTaskTag:   Pointer to tag/context for this TM request.  *  *  \return:  *  *  \e tiSuccess:     I/O request successfully initiated.  *  \e tiBusy:        No resources available, try again later.  *  \e tiIONoDevice:  Invalid device handle.  *  \e tiError:       Other errors that prevent the I/O request to be started.  *  *  *****************************************************************************/
end_comment

begin_comment
comment|/* save task in satIOContext */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|satTM
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|bit32
name|task
parameter_list|,
name|tiLUN_t
modifier|*
name|lun
parameter_list|,
name|tiIORequest_t
modifier|*
name|taskTag
parameter_list|,
name|tiIORequest_t
modifier|*
name|currentTaskTag
parameter_list|,
name|tdIORequestBody_t
modifier|*
name|tiRequestBody
parameter_list|,
name|bit32
name|NotifyOS
parameter_list|)
block|{
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
init|=
name|agNULL
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satTM: tiDeviceHandle=%p task=0x%x\n"
operator|,
name|tiDeviceHandle
operator|,
name|task
operator|)
argument_list|)
expr_stmt|;
comment|/* set satIOContext fields and etc */
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiRequestBody
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|=
operator|&
name|oneDeviceData
operator|->
name|satDevData
expr_stmt|;
name|satIOContext
operator|->
name|pFis
operator|=
operator|&
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
expr_stmt|;
name|satIOContext
operator|->
name|tiRequestBody
operator|=
name|tiRequestBody
expr_stmt|;
name|satIOContext
operator|->
name|ptiDeviceHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
name|satIOContext
operator|->
name|satIntIoContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
comment|/* followings are used only for internal IO */
name|satIOContext
operator|->
name|currentLBA
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
literal|0
expr_stmt|;
comment|/* saving task in satIOContext */
name|satIOContext
operator|->
name|TMF
operator|=
name|task
expr_stmt|;
name|satIOContext
operator|->
name|satToBeAbortedIOContext
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|satIOContext
operator|->
name|NotifyOS
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|satIOContext
operator|->
name|NotifyOS
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/*    * Our SAT supports RESET LUN and partially support ABORT TASK (only if there    * is no more than one I/O pending on the drive.    */
if|if
condition|(
name|task
operator|==
name|AG_LOGICAL_UNIT_RESET
condition|)
block|{
name|status
operator|=
name|satTmResetLUN
argument_list|(
name|tiRoot
argument_list|,
name|currentTaskTag
argument_list|,
name|tiDeviceHandle
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|,
name|lun
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
ifdef|#
directive|ifdef
name|TO_BE_REMOVED
elseif|else
if|if
condition|(
name|task
operator|==
name|AG_TARGET_WARM_RESET
condition|)
block|{
name|status
operator|=
name|satTmWarmReset
argument_list|(
name|tiRoot
argument_list|,
name|currentTaskTag
argument_list|,
name|tiDeviceHandle
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|task
operator|==
name|AG_ABORT_TASK
condition|)
block|{
name|status
operator|=
name|satTmAbortTask
argument_list|(
name|tiRoot
argument_list|,
name|currentTaskTag
argument_list|,
name|tiDeviceHandle
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
elseif|else
if|if
condition|(
name|task
operator|==
name|TD_INTERNAL_TM_RESET
condition|)
block|{
name|status
operator|=
name|satTDInternalTmReset
argument_list|(
name|tiRoot
argument_list|,
name|currentTaskTag
argument_list|,
name|tiDeviceHandle
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTM: tiDeviceHandle=%p UNSUPPORTED TM task=0x%x\n"
operator|,
name|tiDeviceHandle
operator|,
name|task
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tiRequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief  satTmResetLUN  *  *   This routine is called to initiate a TM RESET LUN request to SATL.  *   This routine is independent of HW/LL API.  *  *  \param  tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param  tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param  lun:              Pointer to LUN.  *  \param  currentTaskTag:   Pointer to tag/context for this TM request.  *  *  \return:  *  *  \e tiSuccess:     I/O request successfully initiated.  *  \e tiBusy:        No resources available, try again later.  *  \e tiIONoDevice:  Invalid device handle.  *  \e tiError:       Other errors that prevent the I/O request to be started.  *  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|satTmResetLUN
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
comment|/* current task tag */
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|tiLUN_t
modifier|*
name|lun
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|satDevData
operator|=
operator|&
name|tdsaDeviceData
operator|->
name|satDevData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmResetLUN: tiDeviceHandle=%p.\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Only support LUN 0    */
if|if
condition|(
operator|(
name|lun
operator|->
name|lun
index|[
literal|0
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|1
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|2
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|3
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|4
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|5
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|6
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|7
index|]
operator|)
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmResetLUN: *** REJECT *** LUN not zero, tiDeviceHandle=%p\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/*    * Check if there is other TM request pending    */
if|if
condition|(
name|satDevData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmResetLUN: *** REJECT *** other TM pending, tiDeviceHandle=%p\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/*    * Save tiIORequest, will be returned at device reset completion to return    * the TM completion.    */
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|tiIORequest
expr_stmt|;
comment|/*    * Set flag to indicate device in recovery mode.    */
name|satDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
comment|/*    * Issue SATA device reset. Set flag to indicate NOT to automatically abort    * at the completion of SATA device reset.    */
name|satDevData
operator|->
name|satAbortAfterReset
operator|=
name|agFALSE
expr_stmt|;
comment|/* SAT rev8 6.3.6 p22 */
name|satStartResetDevice
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
comment|/* currentTaskTag */
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief  satTmWarmReset  *  *   This routine is called to initiate a TM warm RESET request to SATL.  *   This routine is independent of HW/LL API.  *  *  \param  tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param  tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param  currentTaskTag:   Pointer to tag/context for this TM request.  *  *  \return:  *  *  \e tiSuccess:     I/O request successfully initiated.  *  \e tiBusy:        No resources available, try again later.  *  \e tiIONoDevice:  Invalid device handle.  *  \e tiError:       Other errors that prevent the I/O request to be started.  *  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|satTmWarmReset
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
comment|/* current task tag */
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|satDevData
operator|=
operator|&
name|tdsaDeviceData
operator|->
name|satDevData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmWarmReset: tiDeviceHandle=%p.\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Check if there is other TM request pending    */
if|if
condition|(
name|satDevData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmWarmReset: *** REJECT *** other TM pending, tiDeviceHandle=%p\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/*    * Save tiIORequest, will be returned at device reset completion to return    * the TM completion.    */
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|tiIORequest
expr_stmt|;
comment|/*    * Set flag to indicate device in recovery mode.    */
name|satDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
comment|/*    * Issue SATA device reset. Set flag to indicate NOT to automatically abort    * at the completion of SATA device reset.    */
name|satDevData
operator|->
name|satAbortAfterReset
operator|=
name|agFALSE
expr_stmt|;
comment|/* SAT rev8 6.3.6 p22 */
name|satStartResetDevice
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
comment|/* currentTaskTag */
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|satTDInternalTmReset
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
comment|/* current task tag */
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|satDevData
operator|=
operator|&
name|tdsaDeviceData
operator|->
name|satDevData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmWarmReset: tiDeviceHandle=%p.\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Check if there is other TM request pending    */
if|if
condition|(
name|satDevData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmWarmReset: *** REJECT *** other TM pending, tiDeviceHandle=%p\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/*    * Save tiIORequest, will be returned at device reset completion to return    * the TM completion.    */
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|tiIORequest
expr_stmt|;
comment|/*    * Set flag to indicate device in recovery mode.    */
name|satDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
comment|/*    * Issue SATA device reset. Set flag to indicate NOT to automatically abort    * at the completion of SATA device reset.    */
name|satDevData
operator|->
name|satAbortAfterReset
operator|=
name|agFALSE
expr_stmt|;
comment|/* SAT rev8 6.3.6 p22 */
name|satStartResetDevice
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
comment|/* currentTaskTag */
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief  satTmAbortTask  *  *   This routine is called to initiate a TM ABORT TASK request to SATL.  *   This routine is independent of HW/LL API.  *  *  \param  tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param  tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param  taskTag:          Pointer to the associated task where the TM  *                            command is to be applied.  *  \param  currentTaskTag:   Pointer to tag/context for this TM request.  *  *  \return:  *  *  \e tiSuccess:     I/O request successfully initiated.  *  \e tiBusy:        No resources available, try again later.  *  \e tiIONoDevice:  Invalid device handle.  *  \e tiError:       Other errors that prevent the I/O request to be started.  *  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|satTmAbortTask
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
comment|/* current task tag */
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
comment|/* NULL */
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|tiIORequest_t
modifier|*
name|taskTag
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|satIOContext_t
modifier|*
name|satTempIOContext
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|TMtdIORequestBody
decl_stmt|;
name|tdList_t
modifier|*
name|elementHdr
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiIOReq
decl_stmt|;
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|satDevData
operator|=
operator|&
name|tdsaDeviceData
operator|->
name|satDevData
expr_stmt|;
name|TMtdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiIORequest
operator|->
name|tdData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmAbortTask: tiDeviceHandle=%p taskTag=%p.\n"
operator|,
name|tiDeviceHandle
operator|,
name|taskTag
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Check if there is other TM request pending    */
if|if
condition|(
name|satDevData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmAbortTask: REJECT other TM pending, tiDeviceHandle=%p\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
comment|/*    * Check if there is only one I/O pending.    */
if|if
condition|(
name|satDevData
operator|->
name|satPendingIO
operator|>
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmAbortTask: REJECT num pending I/O, tiDeviceHandle=%p, satPendingIO=0x%x\n"
operator|,
name|tiDeviceHandle
operator|,
name|satDevData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
endif|#
directive|endif
comment|/*    * Check that the only pending I/O matches taskTag. If not return tiError.    */
name|elementHdr
operator|=
name|satDevData
operator|->
name|satIoLinkList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|elementHdr
operator|!=
operator|&
name|satDevData
operator|->
name|satIoLinkList
condition|)
block|{
name|satTempIOContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|satIOContext_t
argument_list|,
name|satIoContextLink
argument_list|,
name|elementHdr
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satTempIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiIOReq
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|elementHdr
operator|=
name|elementHdr
operator|->
name|flink
expr_stmt|;
comment|/* for the next while loop  */
comment|/*      * Check if the tag matches      */
if|if
condition|(
name|tiIOReq
operator|==
name|taskTag
condition|)
block|{
name|found
operator|=
name|agTRUE
expr_stmt|;
name|satIOContext
operator|->
name|satToBeAbortedIOContext
operator|=
name|satTempIOContext
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmAbortTask: found matching tag.\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* if matching tag */
block|}
comment|/* while loop */
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmAbortTask: *** REJECT *** no match, tiDeviceHandle=%p\n"
operator|,
name|tiDeviceHandle
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/*    * Save tiIORequest, will be returned at device reset completion to return    * the TM completion.    */
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|tiIORequest
expr_stmt|;
comment|/*    * Set flag to indicate device in recovery mode.    */
name|satDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
comment|/*    * Issue SATA device reset or check power mode. Set flag to to automatically abort    * at the completion of SATA device reset.    * SAT r09 p25    */
name|satDevData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
operator|(
name|satTempIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satTempIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmAbortTask: calling satStartCheckPowerMode\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* send check power mode */
name|satStartCheckPowerMode
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
comment|/* currentTaskTag */
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTmAbortTask: calling satStartResetDevice\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* send AGSA_SATA_PROTOCOL_SRST_ASSERT */
name|satStartResetDevice
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
comment|/* currentTaskTag */
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief  osSatResetCB  *  *   This routine is called to notify the completion of SATA device reset  *   which was initiated previously through the call to sataLLReset().  *   This routine is independent of HW/LL API.  *  *  \param  tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param  tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param  resetStatus:      Reset status either tiSuccess or tiError.  *  \param  respFis:          Pointer to the Register Device-To-Host FIS  *                            received from the device.  *  *  \return: None  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|osSatResetCB
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|bit32
name|resetStatus
parameter_list|,
name|void
modifier|*
name|respFis
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBodyTmp
decl_stmt|;
name|tdList_t
modifier|*
name|elementHdr
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|agRoot
operator|=
name|tdsaDeviceData
operator|->
name|agRoot
expr_stmt|;
name|satDevData
operator|=
operator|&
name|tdsaDeviceData
operator|->
name|satDevData
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"osSatResetCB: tiDeviceHandle=%p resetStatus=0x%x\n"
operator|,
name|tiDeviceHandle
operator|,
name|resetStatus
operator|)
argument_list|)
expr_stmt|;
comment|/* We may need to check FIS to check device operating condition */
comment|/*    * Check if need to abort all pending I/Os    */
if|if
condition|(
name|satDevData
operator|->
name|satAbortAfterReset
operator|==
name|agTRUE
condition|)
block|{
comment|/*      * Issue abort to LL layer to all other pending I/Os for the same SATA drive      */
name|elementHdr
operator|=
name|satDevData
operator|->
name|satIoLinkList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|elementHdr
operator|!=
operator|&
name|satDevData
operator|->
name|satIoLinkList
condition|)
block|{
name|satIOContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|satIOContext_t
argument_list|,
name|satIoContextLink
argument_list|,
name|elementHdr
argument_list|)
expr_stmt|;
name|tdIORequestBodyTmp
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satIOContext
operator|->
name|tiRequestBody
expr_stmt|;
comment|/*        * Issue abort        */
name|TI_DBG5
argument_list|(
operator|(
literal|"osSatResetCB: issuing ABORT tiDeviceHandle=%p agIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
operator|&
name|tdIORequestBodyTmp
operator|->
name|agIORequest
operator|)
argument_list|)
expr_stmt|;
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatResetCB: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatResetCB: ostiAllocMemory returned NULL tdAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
operator|&
operator|(
name|tdIORequestBodyTmp
operator|->
name|agIORequest
operator|)
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|elementHdr
operator|=
name|elementHdr
operator|->
name|flink
expr_stmt|;
comment|/* for the next while loop  */
block|}
comment|/* while */
comment|/* Reset flag */
name|satDevData
operator|->
name|satAbortAfterReset
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/*    * Check if the device reset if the result of TM request.    */
if|if
condition|(
name|satDevData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"osSatResetCB: calling TM completion tiDeviceHandle=%p satTmTaskTag=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|satDevData
operator|->
name|satTmTaskTag
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* portalContext not used */
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMOK
argument_list|,
name|satDevData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
comment|/*      * Reset flag      */
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief  osSatIOCompleted  *  *   This routine is a callback for SATA completion that required FIS status  *   translation to SCSI status.  *  *  \param   tiRoot:          Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:     Pointer to TISA I/O request context for this I/O.  *  \param   respFis:         Pointer to status FIS to read.  *  \param   respFisLen:      Length of response FIS to read.  *  \param   satIOContext:    Pointer to SAT context.  *  \param   interruptContext:      Interrupt context  *  *  \return: None  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|osSatIOCompleted
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|respFisLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tiIniScsiCmnd_t
modifier|*
name|pScsiCmnd
decl_stmt|;
endif|#
directive|endif
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext2
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|agsaFisSetDevBitsHeader_t
modifier|*
name|statSetDevBitFisHeader
init|=
name|agNULL
decl_stmt|;
name|tiIORequest_t
name|tiIORequestTMP
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|pScsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
endif|#
directive|endif
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|tiDeviceHandle
operator|=
operator|&
operator|(
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
operator|(
name|pSatDevData
operator|->
name|satSaDeviceData
operator|)
operator|)
operator|->
name|tiDeviceHandle
expr_stmt|;
comment|/*    * Find out the type of response FIS:    * Set Device Bit FIS or Reg Device To Host FIS.    */
comment|/* First assume it is Reg Device to Host FIS */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|statDevToHostFisHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
comment|/* for debugging */
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatIOCompleted: H to D command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatIOCompleted: D to H fistype 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|==
name|SET_DEV_BITS_FIS
condition|)
block|{
comment|/* It is Set Device Bits FIS */
name|statSetDevBitFisHeader
operator|=
operator|(
name|agsaFisSetDevBitsHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
comment|/* Get ATA Status register */
name|ataStatus
operator|=
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x70
operator|)
expr_stmt|;
comment|/* bits 4,5,6 */
name|ataStatus
operator|=
name|ataStatus
operator||
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x07
operator|)
expr_stmt|;
comment|/* bits 0,1,2 */
comment|/* ATA Eror register   */
name|ataError
operator|=
name|statSetDevBitFisHeader
operator|->
name|error
expr_stmt|;
name|statDevToHostFisHeader
operator|=
name|agNULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatIOCompleted: *** UNEXPECTED RESP FIS TYPE 0x%x *** tiIORequest=%p\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INTERNAL_TARGET_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
condition|)
block|{
name|pSatDevData
operator|->
name|satDeviceFaultState
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|pSatDevData
operator|->
name|satDeviceFaultState
operator|=
name|agFALSE
expr_stmt|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"osSatIOCompleted: tiIORequest=%p  CDB=0x%x ATA CMD =0x%x\n"
operator|,
name|tiIORequest
operator|,
name|pScsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Decide which ATA command is the translation needed    */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_FPDMA_QUEUED
case|:
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
comment|/************************************************************************        *        * !!!! See Section 13.5.2.4 of SATA 2.5 specs.                      !!!!        * !!!! If the NCQ error ends up here, it means that the device sent !!!!        * !!!! Set Device Bit FIS (which has SActive register) instead of   !!!!        * !!!! Register Device To Host FIS (which does not have SActive     !!!!        * !!!! register). The callback ossaSATAEvent() deals with the case  !!!!        * !!!! where Register Device To Host FIS was sent by the device.    !!!!        *        * For NCQ we need to issue READ LOG EXT command with log page 10h        * to get the error and to allow other I/Os to continue.        *        * Here is the basic flow or sequence of error recovery, note that due        * to the SATA HW assist that we have, this sequence is slighly different        * from the one described in SATA 2.5:        *        * 1. Set SATA device flag to indicate error condition and returning busy        *    for all new request.        *   return tiSuccess;         * 2. Because the HW/LL layer received Set Device Bit FIS, it can get the        *    tag or I/O context for NCQ request, SATL would translate the ATA error        *    to SCSI status and return the original NCQ I/O with the appopriate        *    SCSI status.        *        * 3. Prepare READ LOG EXT page 10h command. Set flag to indicate that        *    the failed I/O has been returned to the OS Layer. Send command.        *        * 4. When the device receives READ LOG EXT page 10h request all other        *    pending I/O are implicitly aborted. No completion (aborted) status        *    will be sent to the host for these aborted commands.        *        * 5. SATL receives the completion for READ LOG EXT command in        *    satReadLogExtCB(). Steps 6,7,8,9 below are the step 1,2,3,4 in        *    satReadLogExtCB().        *        * 6. Check flag that indicates whether the failed I/O has been returned        *    to the OS Layer. If not, search the I/O context in device data        *    looking for a matched tag. Then return the completion of the failed        *    NCQ command with the appopriate/trasnlated SCSI status.        *        * 7. Issue abort to LL layer to all other pending I/Os for the same SATA        *    drive.        *        * 8. Free resource allocated for the internally generated READ LOG EXT.        *        * 9. At the completion of abort, in the context of ossaSATACompleted(),        *    return the I/O with error status to the OS-App Specific layer.        *    When all I/O aborts are completed, clear SATA device flag to        *    indicate ready to process new request.        *        ***********************************************************************/
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatIOCompleted: NCQ ERROR tiIORequest=%p ataStatus=0x%x ataError=0x%x\n"
operator|,
name|tiIORequest
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
comment|/* Set flag to indicate we are in recovery */
name|pSatDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
comment|/* Return the failed NCQ I/O to OS-Apps Specifiic layer */
name|osSatDefaultTranslation
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|satIOContext
argument_list|,
name|pSense
argument_list|,
operator|(
name|bit8
operator|)
name|ataStatus
argument_list|,
operator|(
name|bit8
operator|)
name|ataError
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
comment|/*        * Allocate resource for READ LOG EXT page 10h        */
name|satIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|tiIORequestTMP
operator|)
argument_list|,
comment|/* anything but NULL */
name|pSatDevData
argument_list|,
sizeof|sizeof
argument_list|(
name|satReadLogExtPage10h_t
argument_list|)
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatIOCompleted: can't send RLE due to resource lack\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Abort I/O after completion of device reset */
name|pSatDevData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* needs further investigation */
comment|/* no report to OS layer */
name|satSubTM
argument_list|(
name|tiRoot
argument_list|,
name|tiDeviceHandle
argument_list|,
name|TD_INTERNAL_TM_RESET
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatIOCompleted: calling saSATADeviceReset 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*        * Set flag to indicate that the failed I/O has been returned to the        * OS-App specific Layer.        */
name|satIntIo
operator|->
name|satIntFlag
operator|=
name|AG_SAT_INT_IO_FLAG_ORG_IO_COMPLETED
expr_stmt|;
comment|/* compare to satPrepareNewIO() */
comment|/* Send READ LOG EXIT page 10h command */
comment|/*        * Need to initialize all the fields within satIOContext except        * reqType and satCompleteCB which will be set depending on cmd.        */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSatDevData
operator|=
name|pSatDevData
expr_stmt|;
name|satIOContext2
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSense
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pTiSenseData
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pTiSenseData
operator|->
name|senseData
operator|=
name|satIOContext2
operator|->
name|pSense
expr_stmt|;
name|satIOContext2
operator|->
name|tiRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|->
name|interruptContext
operator|=
name|interruptContext
expr_stmt|;
name|satIOContext2
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satIOContext2
operator|->
name|ptiDeviceHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
name|satIOContext2
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext2
operator|->
name|tiScsiXchg
operator|=
name|agNULL
expr_stmt|;
name|status
operator|=
name|satSendReadLogExt
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatIOCompleted: can't send RLE due to LL api failure\n"
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* Abort I/O after completion of device reset */
name|pSatDevData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* needs further investigation */
comment|/* no report to OS layer */
name|satSubTM
argument_list|(
name|tiRoot
argument_list|,
name|tiDeviceHandle
argument_list|,
name|TD_INTERNAL_TM_RESET
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatIOCompleted: calling saSATADeviceReset 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_READ_DMA_EXT
case|:
comment|/* fall through */
comment|/* Use default status/error translation */
case|case
name|SAT_READ_DMA
case|:
comment|/* fall through */
comment|/* Use default status/error translation */
default|default:
name|osSatDefaultTranslation
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|satIOContext
argument_list|,
name|pSense
argument_list|,
operator|(
name|bit8
operator|)
name|ataStatus
argument_list|,
operator|(
name|bit8
operator|)
name|ataError
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* end switch  */
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI STANDARD INQUIRY.  *  *  SAT implementation for SCSI STANDARD INQUIRY.  *  *  \param   pInquiry:         Pointer to Inquiry Data buffer.  *  \param   pSATAIdData:      Pointer to ATA IDENTIFY DEVICE data.  *  *  \return None.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satInquiryStandard
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|,
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
parameter_list|)
block|{
name|tiLUN_t
modifier|*
name|pLun
decl_stmt|;
name|pLun
operator|=
operator|&
name|scsiCmnd
operator|->
name|lun
expr_stmt|;
comment|/*     Assumption: Basic Task Mangement is supported     -> BQUE 1 and CMDQUE 0, SPC-4, Table96, p147   */
comment|/*     See SPC-4, 6.4.2, p 143     and SAT revision 8, 8.1.2, p 28    */
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryStandard: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pInquiry
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryStandard: pInquiry is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryStandard: pInquiry is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*    * Reject all other LUN other than LUN 0.    */
if|if
condition|(
operator|(
operator|(
name|pLun
operator|->
name|lun
index|[
literal|0
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|1
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|2
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|3
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|4
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|5
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|6
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|7
index|]
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
comment|/* SAT Spec Table 8, p27, footnote 'a' */
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x7F
expr_stmt|;
block|}
else|else
block|{
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|pSATAIdData
operator|->
name|rm_ataDevice
operator|&
name|ATA_REMOVABLE_MEDIA_DEVICE_MASK
condition|)
block|{
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x80
expr_stmt|;
block|}
else|else
block|{
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0x05
expr_stmt|;
comment|/* SPC-3 */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* set HiSup 1; resp data format set to 2 */
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x1F
expr_stmt|;
comment|/* 35 - 4 = 31; Additional length */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* The following two are for task management. SAT Rev8, p20 */
if|if
condition|(
name|pSATAIdData
operator|->
name|sataCapabilities
operator|&
literal|0x100
condition|)
block|{
comment|/* NCQ supported; multiple outstanding SCSI IO are supported */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* BQUE bit is not set */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* CMDQUE bit is set */
block|}
else|else
block|{
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x80
expr_stmt|;
comment|/* BQUE bit is set */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* CMDQUE bit is not set */
block|}
comment|/*    * Vendor ID.    */
name|osti_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|8
index|]
argument_list|,
name|AG_SAT_VENDOR_ID_STRING
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* 8 bytes   */
comment|/*    * Product ID    */
comment|/* when flipped by LL */
name|pInquiry
index|[
literal|16
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|1
index|]
expr_stmt|;
name|pInquiry
index|[
literal|17
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|0
index|]
expr_stmt|;
name|pInquiry
index|[
literal|18
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|3
index|]
expr_stmt|;
name|pInquiry
index|[
literal|19
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|2
index|]
expr_stmt|;
name|pInquiry
index|[
literal|20
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|5
index|]
expr_stmt|;
name|pInquiry
index|[
literal|21
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|4
index|]
expr_stmt|;
name|pInquiry
index|[
literal|22
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|7
index|]
expr_stmt|;
name|pInquiry
index|[
literal|23
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|6
index|]
expr_stmt|;
name|pInquiry
index|[
literal|24
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|9
index|]
expr_stmt|;
name|pInquiry
index|[
literal|25
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|8
index|]
expr_stmt|;
name|pInquiry
index|[
literal|26
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|11
index|]
expr_stmt|;
name|pInquiry
index|[
literal|27
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|10
index|]
expr_stmt|;
name|pInquiry
index|[
literal|28
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|13
index|]
expr_stmt|;
name|pInquiry
index|[
literal|29
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|12
index|]
expr_stmt|;
name|pInquiry
index|[
literal|30
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|15
index|]
expr_stmt|;
name|pInquiry
index|[
literal|31
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|14
index|]
expr_stmt|;
comment|/* when flipped */
comment|/*    * Product Revision level.    */
comment|/*    * If the IDENTIFY DEVICE data received in words 25 and 26 from the ATA    * device are ASCII spaces (20h), do this translation.    */
if|if
condition|(
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|4
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|5
index|]
operator|==
literal|0x00
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|6
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|7
index|]
operator|==
literal|0x00
operator|)
condition|)
block|{
name|pInquiry
index|[
literal|32
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|1
index|]
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|0
index|]
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|3
index|]
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|2
index|]
expr_stmt|;
block|}
else|else
block|{
name|pInquiry
index|[
literal|32
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|5
index|]
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|4
index|]
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|7
index|]
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|6
index|]
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
comment|/*    * Product ID    */
comment|/* when flipped by LL */
name|pInquiry
index|[
literal|16
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|0
index|]
expr_stmt|;
name|pInquiry
index|[
literal|17
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|1
index|]
expr_stmt|;
name|pInquiry
index|[
literal|18
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|2
index|]
expr_stmt|;
name|pInquiry
index|[
literal|19
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|3
index|]
expr_stmt|;
name|pInquiry
index|[
literal|20
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|4
index|]
expr_stmt|;
name|pInquiry
index|[
literal|21
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|5
index|]
expr_stmt|;
name|pInquiry
index|[
literal|22
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|6
index|]
expr_stmt|;
name|pInquiry
index|[
literal|23
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|7
index|]
expr_stmt|;
name|pInquiry
index|[
literal|24
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|8
index|]
expr_stmt|;
name|pInquiry
index|[
literal|25
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|9
index|]
expr_stmt|;
name|pInquiry
index|[
literal|26
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|10
index|]
expr_stmt|;
name|pInquiry
index|[
literal|27
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|11
index|]
expr_stmt|;
name|pInquiry
index|[
literal|28
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|12
index|]
expr_stmt|;
name|pInquiry
index|[
literal|29
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|13
index|]
expr_stmt|;
name|pInquiry
index|[
literal|30
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|14
index|]
expr_stmt|;
name|pInquiry
index|[
literal|31
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|15
index|]
expr_stmt|;
comment|/* when flipped */
comment|/*    * Product Revision level.    */
comment|/*    * If the IDENTIFY DEVICE data received in words 25 and 26 from the ATA    * device are ASCII spaces (20h), do this translation.    */
if|if
condition|(
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|4
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|5
index|]
operator|==
literal|0x00
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|6
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|7
index|]
operator|==
literal|0x00
operator|)
condition|)
block|{
name|pInquiry
index|[
literal|32
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|0
index|]
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|1
index|]
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|2
index|]
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
block|{
name|pInquiry
index|[
literal|32
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|4
index|]
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|5
index|]
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|6
index|]
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|7
index|]
expr_stmt|;
block|}
endif|#
directive|endif
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryStandard: end\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI INQUIRY page 0.  *  *  SAT implementation for SCSI INQUIRY page 0.  *  *  \param   pInquiry:         Pointer to Inquiry Data buffer.  *  \param   pSATAIdData:      Pointer to ATA IDENTIFY DEVICE data.  *  *  \return None.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satInquiryPage0
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryPage0: entry\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     See SPC-4, 7.6.9, p 345     and SAT revision 8, 10.3.2, p 77    */
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* page code */
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|7
operator|-
literal|3
expr_stmt|;
comment|/* last index(in this case, 6) - 3; page length */
comment|/* supported vpd page list */
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* page 0x00 supported */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x80
expr_stmt|;
comment|/* page 0x80 supported */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x83
expr_stmt|;
comment|/* page 0x83 supported */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x89
expr_stmt|;
comment|/* page 0x89 supported */
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI INQUIRY page 83.  *  *  SAT implementation for SCSI INQUIRY page 83.  *  *  \param   pInquiry:         Pointer to Inquiry Data buffer.  *  \param   pSATAIdData:      Pointer to ATA IDENTIFY DEVICE data.  *  *  \return None.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satInquiryPage83
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|,
name|satDeviceData_t
modifier|*
name|pSatDevData
parameter_list|)
block|{
name|satSimpleSATAIdentifyData_t
modifier|*
name|pSimpleData
decl_stmt|;
comment|/*    * When translating the fields, in some cases using the simple form of SATA    * Identify Device Data is easier. So we define it here.    * Both pSimpleData and pSATAIdData points to the same data.    */
name|pSimpleData
operator|=
operator|(
name|satSimpleSATAIdentifyData_t
operator|*
operator|)
name|pSATAIdData
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryPage83: entry\n"
operator|)
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x83
expr_stmt|;
comment|/* page code */
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Reserved */
comment|/*    * If the ATA device returns word 87 bit 8 set to one in its IDENTIFY DEVICE    * data indicating that it supports the WORLD WIDE NAME field    * (i.e., words 108-111), the SATL shall include an identification descriptor    * containing a logical unit name.    */
if|if
condition|(
name|pSatDevData
operator|->
name|satWWNSupport
condition|)
block|{
comment|/* Fill in SAT Rev8 Table85 */
comment|/*      * Logical unit name derived from the world wide name.      */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|12
expr_stmt|;
comment|/* 15-3; page length, no addition ID descriptor assumed*/
comment|/*      * Identifier descriptor      */
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Code set: binary codes */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x03
expr_stmt|;
comment|/* Identifier type : NAA  */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved               */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* Identifier length      */
comment|/* Bit 4-7 NAA field, bit 0-3 MSB of IEEE Company ID */
name|pInquiry
index|[
literal|8
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|9
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* IEEE Company ID */
name|pInquiry
index|[
literal|10
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority1
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* IEEE Company ID */
comment|/* Bit 4-7 LSB of IEEE Company ID, bit 0-3 MSB of Vendor Specific ID */
name|pInquiry
index|[
literal|11
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority1
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|12
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit16_31
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
name|pInquiry
index|[
literal|13
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit16_31
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
name|pInquiry
index|[
literal|14
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit0_15
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
name|pInquiry
index|[
literal|15
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit0_15
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
block|}
else|else
block|{
comment|/* Fill in SAT Rev8 Table86 */
comment|/*      * Logical unit name derived from the model number and serial number.      */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|72
expr_stmt|;
comment|/* 75 - 3; page length */
comment|/*      * Identifier descriptor      */
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Code set: ASCII codes */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Identifier type : T10 vendor ID based */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x44
expr_stmt|;
comment|/* 0x44, 68 Identifier length */
comment|/* Byte 8 to 15 is the vendor id string 'ATA     '. */
name|osti_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|8
index|]
argument_list|,
name|AG_SAT_VENDOR_ID_STRING
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/*      * Byte 16 to 75 is vendor specific id      */
name|pInquiry
index|[
literal|16
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|27
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|17
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|27
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|18
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|28
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|19
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|28
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|20
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|29
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|21
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|29
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|22
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|30
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|23
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|30
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|24
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|31
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|25
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|31
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|26
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|32
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|27
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|32
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|28
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|33
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|29
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|33
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|30
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|34
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|31
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|34
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|32
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|35
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|35
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|36
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|36
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|36
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|37
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|37
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|37
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|38
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|38
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|39
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|38
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|40
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|39
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|41
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|39
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|42
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|40
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|43
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|40
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|44
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|41
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|45
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|41
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|46
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|42
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|47
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|42
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|48
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|43
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|49
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|43
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|50
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|44
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|51
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|44
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|52
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|45
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|53
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|45
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|54
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|46
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|55
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|46
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|56
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|10
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|57
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|10
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|58
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|11
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|59
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|11
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|60
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|12
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|61
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|12
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|62
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|13
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|63
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|13
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|64
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|14
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|65
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|14
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|66
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|15
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|67
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|15
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|68
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|16
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|69
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|16
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|70
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|17
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|71
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|17
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|72
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|18
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|73
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|18
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|74
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|19
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|75
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|19
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI INQUIRY page 89.  *  *  SAT implementation for SCSI INQUIRY page 89.  *  *  \param   pInquiry:         Pointer to Inquiry Data buffer.  *  \param   pSATAIdData:      Pointer to ATA IDENTIFY DEVICE data.  *  \param   pSatDevData       Pointer to internal device data structure  *  *  \return None.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satInquiryPage89
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|,
name|satDeviceData_t
modifier|*
name|pSatDevData
parameter_list|)
block|{
comment|/*     SAT revision 8, 10.3.5, p 83    */
name|satSimpleSATAIdentifyData_t
modifier|*
name|pSimpleData
decl_stmt|;
comment|/*    * When translating the fields, in some cases using the simple form of SATA    * Identify Device Data is easier. So we define it here.    * Both pSimpleData and pSATAIdData points to the same data.    */
name|pSimpleData
operator|=
operator|(
name|satSimpleSATAIdentifyData_t
operator|*
operator|)
name|pSATAIdData
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryPage89: start\n"
operator|)
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Peripheral Qualifier and Peripheral Device Type */
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x89
expr_stmt|;
comment|/* page code */
comment|/* Page length 0x238 */
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0x02
expr_stmt|;
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|0x38
expr_stmt|;
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* reserved */
comment|/* SAT Vendor Identification */
name|osti_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|8
index|]
argument_list|,
literal|"PMC-SIERRA"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* 8 bytes   */
comment|/* SAT Product Idetification */
name|osti_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|16
index|]
argument_list|,
literal|"Tachyon-SPC    "
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* 16 bytes   */
comment|/* SAT Product Revision Level */
name|osti_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|32
index|]
argument_list|,
literal|"01"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* 4 bytes   */
comment|/* Signature, SAT revision8, Table88, p85 */
name|pInquiry
index|[
literal|36
index|]
operator|=
literal|0x34
expr_stmt|;
comment|/* FIS type */
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATA_DEVICE
condition|)
block|{
comment|/* interrupt assume to be 0 */
name|pInquiry
index|[
literal|37
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSatDevData
operator|->
name|satPMField
operator|)
operator|>>
operator|(
literal|4
operator|*
literal|7
operator|)
argument_list|)
expr_stmt|;
comment|/* first four bits of PM field */
block|}
else|else
block|{
comment|/* interrupt assume to be 1 */
name|pInquiry
index|[
literal|37
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
literal|0x40
operator|+
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|pSatDevData
operator|->
name|satPMField
operator|)
operator|>>
operator|(
literal|4
operator|*
literal|7
operator|)
operator|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* first four bits of PM field */
block|}
name|pInquiry
index|[
literal|38
index|]
operator|=
literal|0
expr_stmt|;
name|pInquiry
index|[
literal|39
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATA_DEVICE
condition|)
block|{
name|pInquiry
index|[
literal|40
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* LBA Low          */
name|pInquiry
index|[
literal|41
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Mid          */
name|pInquiry
index|[
literal|42
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA High         */
name|pInquiry
index|[
literal|43
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Device           */
name|pInquiry
index|[
literal|44
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Low Exp      */
name|pInquiry
index|[
literal|45
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Mid Exp      */
name|pInquiry
index|[
literal|46
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA High Exp     */
name|pInquiry
index|[
literal|47
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved         */
name|pInquiry
index|[
literal|48
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Sector Count     */
name|pInquiry
index|[
literal|49
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Sector Count Exp */
block|}
else|else
block|{
name|pInquiry
index|[
literal|40
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* LBA Low          */
name|pInquiry
index|[
literal|41
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Mid          */
name|pInquiry
index|[
literal|42
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA High         */
name|pInquiry
index|[
literal|43
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Device           */
name|pInquiry
index|[
literal|44
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Low Exp      */
name|pInquiry
index|[
literal|45
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Mid Exp      */
name|pInquiry
index|[
literal|46
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA High Exp     */
name|pInquiry
index|[
literal|47
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved         */
name|pInquiry
index|[
literal|48
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Sector Count     */
name|pInquiry
index|[
literal|49
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Sector Count Exp */
block|}
comment|/* Reserved */
name|pInquiry
index|[
literal|50
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|51
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|52
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|53
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|54
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|55
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Command Code */
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATA_DEVICE
condition|)
block|{
name|pInquiry
index|[
literal|56
index|]
operator|=
literal|0xEC
expr_stmt|;
comment|/* IDENTIFY DEVICE */
block|}
else|else
block|{
name|pInquiry
index|[
literal|56
index|]
operator|=
literal|0xA1
expr_stmt|;
comment|/* IDENTIFY PACKET DEVICE */
block|}
comment|/* Reserved */
name|pInquiry
index|[
literal|57
index|]
operator|=
literal|0x0
expr_stmt|;
name|pInquiry
index|[
literal|58
index|]
operator|=
literal|0x0
expr_stmt|;
name|pInquiry
index|[
literal|59
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* Identify Device */
name|osti_memcpy
argument_list|(
operator|&
name|pInquiry
index|[
literal|60
index|]
argument_list|,
name|pSimpleData
argument_list|,
sizeof|sizeof
argument_list|(
name|satSimpleSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI INQUIRY page 0.  *  *  SAT implementation for SCSI INQUIRY page 0.  *  *  \param   pInquiry:         Pointer to Inquiry Data buffer.  *  \param   pSATAIdData:      Pointer to ATA IDENTIFY DEVICE data.  *  *  \return None.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satInquiryPage80
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryPage80: entry\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     See SPC-4, 7.6.9, p 345     and SAT revision 8, 10.3.3, p 77    */
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x80
expr_stmt|;
comment|/* page code */
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|0x14
expr_stmt|;
comment|/* page length */
comment|/* supported vpd page list */
name|pInquiry
index|[
literal|4
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|1
index|]
expr_stmt|;
name|pInquiry
index|[
literal|5
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|0
index|]
expr_stmt|;
name|pInquiry
index|[
literal|6
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|3
index|]
expr_stmt|;
name|pInquiry
index|[
literal|7
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|2
index|]
expr_stmt|;
name|pInquiry
index|[
literal|8
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|5
index|]
expr_stmt|;
name|pInquiry
index|[
literal|9
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|4
index|]
expr_stmt|;
name|pInquiry
index|[
literal|10
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|7
index|]
expr_stmt|;
name|pInquiry
index|[
literal|11
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|6
index|]
expr_stmt|;
name|pInquiry
index|[
literal|12
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|9
index|]
expr_stmt|;
name|pInquiry
index|[
literal|13
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|8
index|]
expr_stmt|;
name|pInquiry
index|[
literal|14
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|11
index|]
expr_stmt|;
name|pInquiry
index|[
literal|15
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|10
index|]
expr_stmt|;
name|pInquiry
index|[
literal|16
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|13
index|]
expr_stmt|;
name|pInquiry
index|[
literal|17
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|12
index|]
expr_stmt|;
name|pInquiry
index|[
literal|18
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|15
index|]
expr_stmt|;
name|pInquiry
index|[
literal|19
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|14
index|]
expr_stmt|;
name|pInquiry
index|[
literal|20
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|17
index|]
expr_stmt|;
name|pInquiry
index|[
literal|21
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|16
index|]
expr_stmt|;
name|pInquiry
index|[
literal|22
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|19
index|]
expr_stmt|;
name|pInquiry
index|[
literal|23
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|18
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief  Send READ LOG EXT ATA PAGE 10h command to sata drive.  *  *  Send READ LOG EXT ATA command PAGE 10h request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satSendReadLogExt
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendReadLogExt: tiDeviceHandle=%p tiIORequest=%p\n"
operator|,
name|tiDeviceHandle
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_LOG_EXT
expr_stmt|;
comment|/* 0x2F */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x10
expr_stmt|;
comment|/* Page number */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* DEV is ignored in SATA */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x01
expr_stmt|;
comment|/*  1 sector counts*/
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x00
expr_stmt|;
comment|/*  1 sector counts */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satReadLogExtCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendReadLogExt: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief  SAT default ATA status and ATA error translation to SCSI.  *  *  SSAT default ATA status and ATA error translation to SCSI.  *  *  \param   tiRoot:        Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:   Pointer to TISA I/O request context for this I/O.  *  \param   satIOContext:  Pointer to the SAT IO Context  *  \param   pSense:        Pointer to scsiRspSense_t  *  \param   ataStatus:     ATA status register  *  \param   ataError:      ATA error register  *  \param   interruptContext:    Interrupt context  *  *  \return  None  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|osSatDefaultTranslation
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|scsiRspSense_t
modifier|*
name|pSense
parameter_list|,
name|bit8
name|ataStatus
parameter_list|,
name|bit8
name|ataError
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
comment|/*    * Check for device fault case    */
if|if
condition|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INTERNAL_TARGET_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*    * If status error bit it set, need to check the error register    */
if|if
condition|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
condition|)
block|{
if|if
condition|(
name|ataError
operator|&
name|NM_ATA_ERROR_MASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatDefaultTranslation: NM_ATA_ERROR ataError= 0x%x, tiIORequest=%p\n"
operator|,
name|ataError
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|UNC_ATA_ERROR_MASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatDefaultTranslation: UNC_ATA_ERROR ataError= 0x%x, tiIORequest=%p\n"
operator|,
name|ataError
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_MEDIUM_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_UNRECOVERED_READ_ERROR
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|IDNF_ATA_ERROR_MASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatDefaultTranslation: IDNF_ATA_ERROR ataError= 0x%x, tiIORequest=%p\n"
operator|,
name|ataError
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_MEDIUM_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_RECORD_NOT_FOUND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|MC_ATA_ERROR_MASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatDefaultTranslation: MC_ATA_ERROR ataError= 0x%x, tiIORequest=%p\n"
operator|,
name|ataError
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_UNIT_ATTENTION
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NOT_READY_TO_READY_CHANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|MCR_ATA_ERROR_MASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatDefaultTranslation: MCR_ATA_ERROR ataError= 0x%x, tiIORequest=%p\n"
operator|,
name|ataError
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_UNIT_ATTENTION
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_OPERATOR_MEDIUM_REMOVAL_REQUEST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|ICRC_ATA_ERROR_MASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatDefaultTranslation: ICRC_ATA_ERROR ataError= 0x%x, tiIORequest=%p\n"
operator|,
name|ataError
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INFORMATION_UNIT_CRC_ERROR
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|ABRT_ATA_ERROR_MASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatDefaultTranslation: ABRT_ATA_ERROR ataError= 0x%x, tiIORequest=%p\n"
operator|,
name|ataError
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatDefaultTranslation: **** UNEXPECTED ATA_ERROR **** ataError= 0x%x, tiIORequest=%p\n"
operator|,
name|ataError
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INTERNAL_TARGET_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
comment|/* Send the completion response now */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
comment|/*  (ataStatus& ERR_ATA_STATUS_MASK ) is false */
block|{
comment|/* This case should never happen */
name|TI_DBG1
argument_list|(
operator|(
literal|"osSatDefaultTranslation: *** UNEXPECTED ATA status 0x%x *** tiIORequest=%p\n"
operator|,
name|ataStatus
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INTERNAL_TARGET_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief  Allocate resource for SAT intervally generated I/O.  *  *  Allocate resource for SAT intervally generated I/O.  *  *  \param   tiRoot:      Pointer to TISA driver/port instance.  *  \param   satDevData:  Pointer to SAT specific device data.  *  \param   allocLength: Length in byte of the DMA mem to allocate, upto  *                        one page size.  *  \param   satIntIo:    Pointer (output) to context for SAT internally  *                        generated I/O that is allocated by this routine.  *  *  \return If command is started successfully  *    - \e tiSuccess:     Success.  *    - \e tiError:       Failed allocating resource.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|satInternalIo_t
modifier|*
name|satAllocIntIoResource
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|satDeviceData_t
modifier|*
name|satDevData
parameter_list|,
name|bit32
name|dmaAllocLength
parameter_list|,
name|satInternalIo_t
modifier|*
name|satIntIo
parameter_list|)
block|{
name|tdList_t
modifier|*
name|tdList
init|=
name|agNULL
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satAllocIntIoResource: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satAllocIntIoResource: satIntIo %p\n"
operator|,
name|satIntIo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satDevData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAllocIntIoResource: ***** ASSERT satDevData is null\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TDLIST_EMPTY
argument_list|(
operator|&
operator|(
name|satDevData
operator|->
name|satFreeIntIoLinkList
operator|)
argument_list|)
condition|)
block|{
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|tdList
argument_list|,
operator|&
operator|(
name|satDevData
operator|->
name|satFreeIntIoLinkList
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satAllocIntIoResource() no more internal free link.\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
name|tdList
operator|==
name|agNULL
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satAllocIntIoResource() FAIL to alloc satIntIo.\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|satIntIo
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|satInternalIo_t
argument_list|,
name|satIntIoLink
argument_list|,
name|tdList
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satAllocIntIoResource: satDevData %p satIntIo id %d\n"
operator|,
name|satDevData
operator|,
name|satIntIo
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* Put in active list */
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|satIntIo
operator|->
name|satIntIoLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|satIntIo
operator|->
name|satIntIoLink
operator|)
argument_list|,
operator|&
operator|(
name|satDevData
operator|->
name|satActiveIntIoLinkList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
comment|/* Put in active list */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
name|tdList
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
name|tdList
argument_list|,
operator|&
operator|(
name|satDevData
operator|->
name|satActiveIntIoLinkList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|satIntIo
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|satInternalIo_t
argument_list|,
name|satIntIoLink
argument_list|,
name|tdList
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satAllocIntIoResource: satDevData %p satIntIo id %d\n"
operator|,
name|satDevData
operator|,
name|satIntIo
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*     typedef struct     {       tdList_t                    satIntIoLink;       tiIORequest_t               satIntTiIORequest;       void                        *satIntRequestBody;       tiScsiInitiatorRequest_t   satIntTiScsiXchg;       tiMem_t                     satIntDmaMem;       tiMem_t                     satIntReqBodyMem;       bit32                       satIntFlag;     } satInternalIo_t;   */
comment|/*    * Allocate mem for Request Body    */
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
operator|=
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
expr_stmt|;
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|osHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|satIntIo
operator|->
name|satIntRequestBody
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|physAddrUpper
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|physAddrLower
argument_list|,
literal|8
argument_list|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAllocIntIoResource() FAIL to alloc mem for Req Body.\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Return satIntIo to the free list      */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|satIntIo
operator|->
name|satIntIoLink
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_HEAD
argument_list|(
operator|&
name|satIntIo
operator|->
name|satIntIoLink
argument_list|,
operator|&
name|satDevData
operator|->
name|satFreeIntIoLinkList
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
comment|/*    *   Allocate DMA memory if required    */
if|if
condition|(
name|dmaAllocLength
operator|!=
literal|0
condition|)
block|{
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
operator|=
name|dmaAllocLength
expr_stmt|;
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|osHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|virtPtr
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|physAddrUpper
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|physAddrLower
argument_list|,
literal|8
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satAllocIntIoResource: len %d \n"
operator|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satAllocIntIoResource: pointer %p \n"
operator|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|osHandle
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAllocIntIoResource() FAIL to alloc mem for DMA mem.\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*        * Return satIntIo to the free list        */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|satIntIo
operator|->
name|satIntIoLink
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_HEAD
argument_list|(
operator|&
name|satIntIo
operator|->
name|satIntIoLink
argument_list|,
operator|&
name|satDevData
operator|->
name|satFreeIntIoLinkList
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
comment|/*        * Free mem allocated for Req body        */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|osHandle
argument_list|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
block|}
comment|/*     typedef struct     {       tdList_t                    satIntIoLink;       tiIORequest_t               satIntTiIORequest;       void                        *satIntRequestBody;       tiScsiInitiatorRequest_t   satIntTiScsiXchg;       tiMem_t                     satIntDmaMem;       tiMem_t                     satIntReqBodyMem;       bit32                       satIntFlag;     } satInternalIo_t;   */
comment|/*    * Initialize satIntTiIORequest field    */
name|satIntIo
operator|->
name|satIntTiIORequest
operator|.
name|osData
operator|=
name|agNULL
expr_stmt|;
comment|/* Not used for internal SAT I/O */
name|satIntIo
operator|->
name|satIntTiIORequest
operator|.
name|tdData
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
comment|/*    * saves the original tiIOrequest    */
name|satIntIo
operator|->
name|satOrgTiIORequest
operator|=
name|tiIORequest
expr_stmt|;
comment|/*     typedef struct tiIniScsiCmnd     {       tiLUN_t     lun;       bit32       expDataLength;       bit32       taskAttribute;       bit32       crn;       bit8        cdb[16];     } tiIniScsiCmnd_t;      typedef struct tiScsiInitiatorExchange     {       void                *sglVirtualAddr;       tiIniScsiCmnd_t     scsiCmnd;       tiSgl_t             agSgl1;       tiSgl_t             agSgl2;       tiDataDirection_t   dataDirection;     } tiScsiInitiatorRequest_t;    */
comment|/*    * Initialize satIntTiScsiXchg. Since the internal SAT request is NOT    * originated from SCSI request, only the following fields are initialized:    *  - sglVirtualAddr if DMA transfer is involved    *  - agSgl1 if DMA transfer is involved    *  - expDataLength in scsiCmnd since this field is read by sataLLIOStart()    */
if|if
condition|(
name|dmaAllocLength
operator|!=
literal|0
condition|)
block|{
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|sglVirtualAddr
operator|=
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|virtPtr
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agNULL
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|len
argument_list|,
literal|0
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|lower
operator|=
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|physAddrLower
expr_stmt|;
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|upper
operator|=
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|physAddrUpper
expr_stmt|;
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|type
operator|=
name|tiSgl
expr_stmt|;
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|.
name|expDataLength
operator|=
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
expr_stmt|;
block|}
else|else
block|{
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|sglVirtualAddr
operator|=
name|agNULL
expr_stmt|;
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|lower
operator|=
literal|0
expr_stmt|;
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|upper
operator|=
literal|0
expr_stmt|;
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|type
operator|=
name|tiSgl
expr_stmt|;
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|.
name|expDataLength
operator|=
literal|0
expr_stmt|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satAllocIntIoResource: satIntIo->satIntTiScsiXchg.agSgl1.len %d\n"
operator|,
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|len
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satAllocIntIoResource: satIntIo->satIntTiScsiXchg.agSgl1.upper %d\n"
operator|,
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|upper
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satAllocIntIoResource: satIntIo->satIntTiScsiXchg.agSgl1.lower %d\n"
operator|,
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|lower
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satAllocIntIoResource: satIntIo->satIntTiScsiXchg.agSgl1.type %d\n"
operator|,
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|agSgl1
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satAllocIntIoResource: return satIntIo %p\n"
operator|,
name|satIntIo
operator|)
argument_list|)
expr_stmt|;
return|return
name|satIntIo
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief  Free resource for SAT intervally generated I/O.  *  *  Free resource for SAT intervally generated I/O that was previously  *  allocated in satAllocIntIoResource().  *  *  \param   tiRoot:      Pointer to TISA driver/port instance.  *  \param   satDevData:  Pointer to SAT specific device data.  *  \param   satIntIo:    Pointer to context for SAT internal I/O that was  *                        previously allocated in satAllocIntIoResource().  *  *  \return  None  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satFreeIntIoResource
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|satDeviceData_t
modifier|*
name|satDevData
parameter_list|,
name|satInternalIo_t
modifier|*
name|satIntIo
parameter_list|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satFreeIntIoResource: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satFreeIntIoResource: allowed call\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* sets the original tiIOrequest to agNULL for internally generated ATA cmnd */
name|satIntIo
operator|->
name|satOrgTiIORequest
operator|=
name|agNULL
expr_stmt|;
comment|/*    * Free DMA memory if previosly alocated    */
if|if
condition|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|.
name|expDataLength
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satFreeIntIoResource: DMA len %d\n"
operator|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satFreeIntIoResource: pointer %p\n"
operator|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|osHandle
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|osHandle
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|.
name|expDataLength
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satFreeIntIoResource: req body len %d\n"
operator|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Free mem allocated for Req body      */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|osHandle
argument_list|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
operator|=
literal|0
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satFreeIntIoResource: satDevData %p satIntIo id %d\n"
operator|,
name|satDevData
operator|,
name|satIntIo
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Return satIntIo to the free list    */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|satIntIo
operator|->
name|satIntIoLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|satIntIo
operator|->
name|satIntIoLink
operator|)
argument_list|,
operator|&
operator|(
name|satDevData
operator|->
name|satFreeIntIoLinkList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI INQUIRY.  *  *  SAT implementation for SCSI INQUIRY.  *  This function sends ATA Identify Device data command for SCSI INQUIRY  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satSendIDDev
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satInternalIo_t
modifier|*
name|satIntIoContext
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
endif|#
directive|endif
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendIDDev: start\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
endif|#
directive|endif
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendIDDev: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satIntIoContext
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|tdIORequestBody
operator|=
name|satIntIoContext
operator|->
name|satIntRequestBody
expr_stmt|;
endif|#
directive|endif
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendIDDev: satIOContext %p tdIORequestBody %p\n"
operator|,
name|satIOContext
operator|,
name|tdIORequestBody
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_IDENTIFY_PACKET_DEVICE
expr_stmt|;
comment|/* 0x40 */
else|else
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_IDENTIFY_DEVICE
expr_stmt|;
comment|/* 0xEC */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satInquiryCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdhexdump
argument_list|(
literal|"satSendIDDev"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|satIOContext
operator|->
name|pFis
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdhexdump
argument_list|(
literal|"satSendIDDev LL"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satSendIDDev: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI INQUIRY.  *  *  SAT implementation for SCSI INQUIRY.  *  This function prepares TD layer internal resource to send ATA  *  Identify Device data command for SCSI INQUIRY  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* prerequsite: tdsaDeviceData and agdevhandle must exist; in other words, LL discovered the device    already */
end_comment

begin_comment
comment|/*   convert OS generated IO to TD generated IO due to difference in sgl */
end_comment

begin_function
name|GLOBAL
name|bit32
name|satStartIDDev
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|satInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartIDDev: start\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartIDDev: before alloc\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate identify device command */
name|satIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|satDevData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|,
comment|/* 512; size of identify device data */
name|satIntIo
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartIDDev: before after\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartIDDev: can't alloacate\n"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|ostiInitiatorIOCompleted (                               tiRoot,                               tiIORequest,                               tiIOFailed,                               tiDetailOtherError,                               agNULL,                               satIOContext->interruptContext                               );
endif|#
directive|endif
return|return
name|tiError
return|;
block|}
comment|/* fill in fields */
comment|/* real ttttttthe one worked and the same; 5/21/07/ */
name|satIntIo
operator|->
name|satOrgTiIORequest
operator|=
name|tiIORequest
expr_stmt|;
comment|/* changed */
name|tdIORequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSatDevData
operator|=
name|satDevData
expr_stmt|;
name|satNewIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSense
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pTiSenseData
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|tiRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
comment|/* key fix */
name|satNewIOContext
operator|->
name|interruptContext
operator|=
name|tiInterruptContext
expr_stmt|;
name|satNewIOContext
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satNewIOContext
operator|->
name|ptiDeviceHandle
operator|=
name|agNULL
expr_stmt|;
name|satNewIOContext
operator|->
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
comment|/* changed */
comment|/* this is valid only for TD layer generated (not triggered by OS at all) IO */
name|satNewIOContext
operator|->
name|tiScsiXchg
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartIDDev: OS satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartIDDev: TD satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartIDDev: OS tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartIDDev: TD tiScsiXchg %p \n"
operator|,
name|satNewIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartIDDev: satNewIOContext %p tdIORequestBody %p\n"
operator|,
name|satNewIOContext
operator|,
name|tdIORequestBody
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|satSendIDDev
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
comment|/* New tiIORequest */
name|tiDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|tiScsiXchg
argument_list|,
comment|/* New tiScsiInitiatorRequest_t *tiScsiRequest, */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartIDDev: failed in sending\n"
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|ostiInitiatorIOCompleted (                               tiRoot,                               tiIORequest,                               tiIOFailed,                               tiDetailOtherError,                               agNULL,                               satIOContext->interruptContext                               );
endif|#
directive|endif
return|return
name|tiError
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartIDDev: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satComputeCDB10LBA.  *  *  This fuctions computes LBA of CDB10.  *  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return  *    - \e LBA  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|bit32
name|satComputeCDB10LBA
parameter_list|(
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satComputeCDB10LBA: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tiScsiRequest
operator|=
name|satIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
return|return
name|lba
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satComputeCDB10TL.  *  *  This fuctions computes transfer length of CDB10.  *  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return  *    - \e TL  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|bit32
name|satComputeCDB10TL
parameter_list|(
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satComputeCDB10TL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tiScsiRequest
operator|=
name|satIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
return|return
name|tl
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satComputeCDB12LBA.  *  *  This fuctions computes LBA of CDB12.  *  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return  *    - \e LBA  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|bit32
name|satComputeCDB12LBA
parameter_list|(
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satComputeCDB10LBA: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tiScsiRequest
operator|=
name|satIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
return|return
name|lba
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satComputeCDB12TL.  *  *  This fuctions computes transfer length of CDB12.  *  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return  *    - \e TL  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|bit32
name|satComputeCDB12TL
parameter_list|(
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satComputeCDB10TL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tiScsiRequest
operator|=
name|satIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
return|return
name|tl
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satComputeCDB16LBA.  *  *  This fuctions computes LBA of CDB16.  *  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return  *    - \e LBA  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*   CBD16 has bit64 LBA   But it has to be less than (2^28 - 1)   Therefore, use last four bytes to compute LBA is OK */
end_comment

begin_function
name|bit32
name|satComputeCDB16LBA
parameter_list|(
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satComputeCDB10LBA: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tiScsiRequest
operator|=
name|satIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
return|return
name|lba
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satComputeCDB16TL.  *  *  This fuctions computes transfer length of CDB16.  *  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return  *    - \e TL  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|bit32
name|satComputeCDB16TL
parameter_list|(
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satComputeCDB10TL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tiScsiRequest
operator|=
name|satIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
return|return
name|tl
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satComputeLoopNum.  *  *  This fuctions computes the number of interation needed for a transfer  *  length with a specific number.  *  *  \param   a:   a numerator  *  \param   b:   a denominator  *  *  \return  *    - \e number of interation  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*   (tl, denom)   tl can be upto bit32 because CDB16 has bit32 tl   Therefore, fine   either (tl, 0xFF) or (tl, 0xFFFF) */
end_comment

begin_function
name|bit32
name|satComputeLoopNum
parameter_list|(
name|bit32
name|a
parameter_list|,
name|bit32
name|b
parameter_list|)
block|{
name|bit32
name|quo
init|=
literal|0
decl_stmt|,
name|rem
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satComputeLoopNum: start\n"
operator|)
argument_list|)
expr_stmt|;
name|quo
operator|=
name|a
operator|/
name|b
expr_stmt|;
if|if
condition|(
name|quo
operator|==
literal|0
condition|)
block|{
name|LoopNum
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rem
operator|=
name|a
operator|%
name|b
expr_stmt|;
if|if
condition|(
name|rem
operator|==
literal|0
condition|)
block|{
name|LoopNum
operator|=
name|quo
expr_stmt|;
block|}
else|else
block|{
name|LoopNum
operator|=
name|quo
operator|+
literal|1
expr_stmt|;
block|}
block|}
return|return
name|LoopNum
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satAddNComparebit64.  *  *  *  *  *  \param   a:   lba  *  \param   b:   tl  *  *  \return  *    - \e TRUE if (lba + tl> SAT_TR_LBA_LIMIT)  *    - \e FALSE otherwise  *  \note: a and b must be in the same length  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*   input: bit8 a[8], bit8 b[8] (lba, tl) must be in same length   if (lba + tl> SAT_TR_LBA_LIMIT)   then returns true   else returns false   (LBA,TL) */
end_comment

begin_function
name|bit32
name|satAddNComparebit64
parameter_list|(
name|bit8
modifier|*
name|a
parameter_list|,
name|bit8
modifier|*
name|b
parameter_list|)
block|{
name|bit16
name|ans
index|[
literal|8
index|]
decl_stmt|;
comment|// 0 MSB, 8 LSB
name|bit8
name|final_ans
index|[
literal|9
index|]
decl_stmt|;
comment|// 0 MSB, 9 LSB
name|bit8
name|max
index|[
literal|9
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddNComparebit64: start\n"
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|ans
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ans
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|final_ans
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|final_ans
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|max
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|max
argument_list|)
argument_list|)
expr_stmt|;
name|max
index|[
literal|0
index|]
operator|=
literal|0x1
expr_stmt|;
comment|//max = 0x1 0000 0000 0000 0000
comment|// adding from LSB to MSB
for|for
control|(
name|i
operator|=
literal|7
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|ans
index|[
name|i
index|]
operator|=
call|(
name|bit16
call|)
argument_list|(
name|a
index|[
name|i
index|]
operator|+
name|b
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|7
condition|)
block|{
name|ans
index|[
name|i
index|]
operator|=
call|(
name|bit16
call|)
argument_list|(
name|ans
index|[
name|i
index|]
operator|+
operator|(
operator|(
name|ans
index|[
name|i
operator|+
literal|1
index|]
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*     filling in the final answer    */
name|final_ans
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|ans
index|[
literal|0
index|]
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
name|final_ans
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|ans
index|[
literal|0
index|]
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<=
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|final_ans
index|[
name|i
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|ans
index|[
name|i
operator|-
literal|1
index|]
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
block|}
comment|//compare final_ans to max
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|>
name|max
index|[
name|i
index|]
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddNComparebit64: yes at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
elseif|else
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|<
name|max
index|[
name|i
index|]
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddNComparebit64: no at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
return|return
name|agFALSE
return|;
block|}
else|else
block|{
continue|continue;
block|}
block|}
return|return
name|agFALSE
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satAddNComparebit32.  *  *  *  *  *  \param   a:   lba  *  \param   b:   tl  *  *  \return  *    - \e TRUE if (lba + tl> SAT_TR_LBA_LIMIT)  *    - \e FALSE otherwise  *  \note: a and b must be in the same length  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*   input: bit8 a[4], bit8 b[4] (lba, tl) must be in same length   if (lba + tl> SAT_TR_LBA_LIMIT)   then returns true   else returns false   (LBA,TL) */
end_comment

begin_function
name|bit32
name|satAddNComparebit32
parameter_list|(
name|bit8
modifier|*
name|a
parameter_list|,
name|bit8
modifier|*
name|b
parameter_list|)
block|{
name|bit16
name|ans
index|[
literal|4
index|]
decl_stmt|;
comment|// 0 MSB, 4 LSB
name|bit8
name|final_ans
index|[
literal|5
index|]
decl_stmt|;
comment|// 0 MSB, 5 LSB
name|bit8
name|max
index|[
literal|4
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddNComparebit32: start\n"
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|ans
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ans
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|final_ans
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|final_ans
argument_list|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
name|max
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|max
argument_list|)
argument_list|)
expr_stmt|;
name|max
index|[
literal|0
index|]
operator|=
literal|0x10
expr_stmt|;
comment|// max =0x1000 0000
comment|// adding from LSB to MSB
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|ans
index|[
name|i
index|]
operator|=
call|(
name|bit16
call|)
argument_list|(
name|a
index|[
name|i
index|]
operator|+
name|b
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|3
condition|)
block|{
name|ans
index|[
name|i
index|]
operator|=
call|(
name|bit16
call|)
argument_list|(
name|ans
index|[
name|i
index|]
operator|+
operator|(
operator|(
name|ans
index|[
name|i
operator|+
literal|1
index|]
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*     filling in the final answer    */
name|final_ans
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|ans
index|[
literal|0
index|]
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
name|final_ans
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|ans
index|[
literal|0
index|]
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<=
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|final_ans
index|[
name|i
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|ans
index|[
name|i
operator|-
literal|1
index|]
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
block|}
comment|//compare final_ans to max
if|if
condition|(
name|final_ans
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddNComparebit32: yes bigger and out of range\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|>
name|max
index|[
name|i
operator|-
literal|1
index|]
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddNComparebit32: yes at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
elseif|else
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|<
name|max
index|[
name|i
operator|-
literal|1
index|]
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddNComparebit32: no at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
return|return
name|agFALSE
return|;
block|}
else|else
block|{
continue|continue;
block|}
block|}
return|return
name|agFALSE
return|;
empty_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satCompareLBALimitbit.  *  *  *  *  *  \param   lba:   lba  *  *  \return  *    - \e TRUE if (lba> SAT_TR_LBA_LIMIT - 1)  *    - \e FALSE otherwise  *  \note: a and b must be in the same length  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*   lba */
end_comment

begin_comment
comment|/*   input: bit8 lba[8]   if (lba> SAT_TR_LBA_LIMIT - 1)   then returns true   else returns false   (LBA,TL) */
end_comment

begin_function
name|bit32
name|satCompareLBALimitbit
parameter_list|(
name|bit8
modifier|*
name|lba
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
name|bit8
name|limit
index|[
literal|8
index|]
decl_stmt|;
comment|/* limit is 0xF FF FF = 2^28 - 1 */
name|limit
index|[
literal|0
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* MSB */
name|limit
index|[
literal|1
index|]
operator|=
literal|0x0
expr_stmt|;
name|limit
index|[
literal|2
index|]
operator|=
literal|0x0
expr_stmt|;
name|limit
index|[
literal|3
index|]
operator|=
literal|0x0
expr_stmt|;
name|limit
index|[
literal|4
index|]
operator|=
literal|0xF
expr_stmt|;
name|limit
index|[
literal|5
index|]
operator|=
literal|0xFF
expr_stmt|;
name|limit
index|[
literal|6
index|]
operator|=
literal|0xFF
expr_stmt|;
name|limit
index|[
literal|7
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* LSB */
comment|//compare lba to limit
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|lba
index|[
name|i
index|]
operator|>
name|limit
index|[
name|i
index|]
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satCompareLBALimitbit64: yes at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
elseif|else
if|if
condition|(
name|lba
index|[
name|i
index|]
operator|<
name|limit
index|[
name|i
index|]
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satCompareLBALimitbit64: no at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
return|return
name|agFALSE
return|;
block|}
else|else
block|{
continue|continue;
block|}
block|}
return|return
name|agFALSE
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief *  Purpose: bitwise set * *  Parameters: *   data        - input output buffer *   index       - bit to set * *  Return: *   none * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satBitSet
parameter_list|(
name|bit8
modifier|*
name|data
parameter_list|,
name|bit32
name|index
parameter_list|)
block|{
name|data
index|[
name|index
operator|/
literal|8
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
name|index
operator|%
literal|8
operator|)
operator|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief *  Purpose: bitwise clear * *  Parameters: *   data        - input output buffer *   index       - bit to clear * *  Return: *   none * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satBitClear
parameter_list|(
name|bit8
modifier|*
name|data
parameter_list|,
name|bit32
name|index
parameter_list|)
block|{
name|data
index|[
name|index
operator|/
literal|8
index|]
operator|&=
operator|~
operator|(
literal|1
operator|<<
operator|(
name|index
operator|%
literal|8
operator|)
operator|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief *  Purpose: bitwise test * *  Parameters: *   data        - input output buffer *   index       - bit to test * *  Return: *   0 - not set *   1 - set * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|agBOOLEAN
name|satBitTest
parameter_list|(
name|bit8
modifier|*
name|data
parameter_list|,
name|bit32
name|index
parameter_list|)
block|{
return|return
operator|(
call|(
name|BOOLEAN
call|)
argument_list|(
operator|(
name|data
index|[
name|index
operator|/
literal|8
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|index
operator|%
literal|8
operator|)
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief allocate an available SATA tag  *  *  allocate an available SATA tag  *  *  \param tiRoot           Pointer to TISA initiator driver/port instance.  *  \param pSatDevData  *  \param pTag  *  *  \return -Success or fail-  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satTagAlloc
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|satDeviceData_t
modifier|*
name|pSatDevData
parameter_list|,
name|bit8
modifier|*
name|pTag
parameter_list|)
block|{
name|bit32
name|retCode
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pSatDevData
operator|->
name|satNCQMaxIO
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
literal|0
operator|==
name|satBitTest
argument_list|(
operator|(
name|bit8
operator|*
operator|)
operator|&
name|pSatDevData
operator|->
name|freeSATAFDMATagBitmap
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|satBitSet
argument_list|(
operator|(
name|bit8
operator|*
operator|)
operator|&
name|pSatDevData
operator|->
name|freeSATAFDMATagBitmap
argument_list|,
name|i
argument_list|)
expr_stmt|;
operator|*
name|pTag
operator|=
operator|(
name|bit8
operator|)
name|i
expr_stmt|;
name|retCode
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
return|return
name|retCode
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief release an SATA tag  *  *  release an available SATA tag  *  *  \param tiRoot           Pointer to TISA initiator driver/port instance.  *  \param pSatDevData  *  \param Tag  *  *  \return -the tag-  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satTagRelease
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|satDeviceData_t
modifier|*
name|pSatDevData
parameter_list|,
name|bit8
name|tag
parameter_list|)
block|{
name|bit32
name|retCode
init|=
name|agFALSE
decl_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|tag
operator|<
name|pSatDevData
operator|->
name|satNCQMaxIO
condition|)
block|{
name|satBitClear
argument_list|(
operator|(
name|bit8
operator|*
operator|)
operator|&
name|pSatDevData
operator|->
name|freeSATAFDMATagBitmap
argument_list|,
operator|(
name|bit32
operator|)
name|tag
argument_list|)
expr_stmt|;
name|retCode
operator|=
name|agTRUE
expr_stmt|;
block|}
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
return|return
name|retCode
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief  satSubTM  *  *   This routine is called to initiate a TM request to SATL.  *   This routine is independent of HW/LL API.  *  *  \param  tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param  tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param  task:             SAM-3 task management request.  *  \param  lun:              Pointer to LUN.  *  \param  taskTag:          Pointer to the associated task where the TM  *                            command is to be applied.  *  \param  currentTaskTag:   Pointer to tag/context for this TM request.  *  \param  NotifyOS          flag determines whether notify OS layer or not  *  *  \return:  *  *  \e tiSuccess:     I/O request successfully initiated.  *  \e tiBusy:        No resources available, try again later.  *  \e tiIONoDevice:  Invalid device handle.  *  \e tiError:       Other errors that prevent the I/O request to be started.  *  *  \note:  *        This funcion is triggered bottom up. Not yet in use.  *****************************************************************************/
end_comment

begin_comment
comment|/* called for bottom up */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|satSubTM
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|bit32
name|task
parameter_list|,
name|tiLUN_t
modifier|*
name|lun
parameter_list|,
name|tiIORequest_t
modifier|*
name|taskTag
parameter_list|,
name|tiIORequest_t
modifier|*
name|currentTaskTag
parameter_list|,
name|bit32
name|NotifyOS
parameter_list|)
block|{
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|TMtdIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satSubTM: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocation tdIORequestBody and pass it to satTM() */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|TMtdIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSubTM: ostiAllocMemory failed... \n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|TMtdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSubTM: ostiAllocMemory returned NULL TMIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* setup task management structure */
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|CurrentTaskTag
operator|=
name|agNULL
expr_stmt|;
name|TMtdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|TaskTag
operator|=
name|agNULL
expr_stmt|;
comment|/* initialize tiDevhandle */
name|TMtdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* initialize tiIORequest */
name|TMtdIORequestBody
operator|->
name|tiIORequest
operator|=
name|agNULL
expr_stmt|;
comment|/* initialize agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|TMtdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|TMtdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SA takes care of this */
name|satTM
argument_list|(
name|tiRoot
argument_list|,
name|tiDeviceHandle
argument_list|,
name|task
argument_list|,
comment|/* TD_INTERNAL_TM_RESET */
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|TMtdIORequestBody
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for satStartResetDevice.  *  *  SAT implementation for sending SRT and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  *  \note : triggerred by OS layer or bottom up  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* OS triggerred or bottom up */
end_comment

begin_function
name|GLOBAL
name|bit32
name|satStartResetDevice
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
comment|/* currentTaskTag */
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
comment|/* should be NULL */
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|satInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
init|=
name|agNULL
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|tiIORequest_t
modifier|*
name|currentTaskTag
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartResetDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
name|currentTaskTag
operator|=
name|tiIORequest
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartResetDevice: before alloc\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate any fis for seting SRT bit in device control */
name|satIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartResetDevice: before after\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartResetDevice: can't alloacate\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|->
name|NotifyOS
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
block|}
return|return
name|tiError
return|;
block|}
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satIntIo
argument_list|,
name|tiIORequest
argument_list|,
name|satDevData
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartResetDevice: OS satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartResetDevice: TD satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartResetDevice: OS tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartResetDevice: TD tiScsiXchg %p \n"
operator|,
name|satNewIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartResetDevice: satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
name|status
operator|=
name|satDeviceReset
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
comment|/* New tiIORequest */
name|tiDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|tiScsiXchg
argument_list|,
comment|/* New tiScsiInitiatorRequest_t *tiScsiRequest, */
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|satResetDevice
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
comment|/* New tiIORequest */
name|tiDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|tiScsiXchg
argument_list|,
comment|/* New tiScsiInitiatorRequest_t *tiScsiRequest, */
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartResetDevice: failed in sending\n"
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|->
name|NotifyOS
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
block|}
return|return
name|tiError
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartResetDevice: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for satResetDevice.  *  *  SAT implementation for building SRT FIS and sends the request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*   create any fis and set SRST bit in device control */
end_comment

begin_function
name|GLOBAL
name|bit32
name|satResetDevice
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIoContext
decl_stmt|;
endif|#
directive|endif
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satResetDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satIntIoContext
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|tdIORequestBody
operator|=
name|satIntIoContext
operator|->
name|satIntRequestBody
expr_stmt|;
endif|#
directive|endif
name|TI_DBG5
argument_list|(
operator|(
literal|"satResetDevice: satIOContext %p tdIORequestBody %p\n"
operator|,
name|satIOContext
operator|,
name|tdIORequestBody
operator|)
argument_list|)
expr_stmt|;
comment|/* any fis should work */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0
expr_stmt|;
comment|/* C Bit is not set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
literal|0
expr_stmt|;
comment|/* any command */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0x4
expr_stmt|;
comment|/* SRST bit is set  */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_SRST_ASSERT
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satResetDeviceCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdhexdump
argument_list|(
literal|"satResetDevice"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|satIOContext
operator|->
name|pFis
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdhexdump
argument_list|(
literal|"satResetDevice LL"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satResetDevice: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satResetDeviceCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with SRT completion. This function send DSRT * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satResetDeviceCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/* callback for satResetDevice */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|bit32
name|status
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satResetDeviceCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satResetDeviceCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satResetDeviceCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satResetDeviceCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satResetDeviceCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satResetDeviceCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satResetDeviceCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satResetDeviceCB: OSSA_IO_OPEN_CNX_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
comment|/* only agsaFisPioSetup_t is expected */
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"satResetDeviceCB: ataStatus 0x%x ataError 0x%x\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"satResetDeviceCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* send AGSA_SATA_PROTOCOL_SRST_DEASSERT */
name|status
operator|=
name|satDeResetDevice
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
name|agNULL
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
comment|/* sending AGSA_SATA_PROTOCOL_SRST_DEASSERT fails */
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satResetDeviceCB: device %p pending IO %d\n"
operator|,
name|satDevData
operator|,
name|satDevData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satResetDeviceCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for satDeResetDevice.  *  *  SAT implementation for building DSRT FIS and sends the request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satDeResetDevice
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIoContext
decl_stmt|;
endif|#
directive|endif
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeResetDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satIntIoContext
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|tdIORequestBody
operator|=
name|satIntIoContext
operator|->
name|satIntRequestBody
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satDeResetDevice: satIOContext %p tdIORequestBody %p\n"
operator|,
name|satIOContext
operator|,
name|tdIORequestBody
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* any fis should work */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0
expr_stmt|;
comment|/* C Bit is not set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
literal|0
expr_stmt|;
comment|/* any command */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* SRST bit is not set  */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_SRST_DEASSERT
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satDeResetDeviceCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdhexdump
argument_list|(
literal|"satDeResetDevice"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|satIOContext
operator|->
name|pFis
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdhexdump
argument_list|(
literal|"satDeResetDevice LL"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeResetDevice: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satDeResetDeviceCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with DSRT completion. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satDeResetDeviceCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/* callback for satDeResetDevice */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
init|=
name|agNULL
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|bit32
name|report
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|AbortTM
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeResetDeviceCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeResetDeviceCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeResetDeviceCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeResetDeviceCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeResetDeviceCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: OSSA_IO_OPEN_CNX_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
comment|/* only agsaFisPioSetup_t is expected */
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: ataStatus 0x%x ataError 0x%x\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: success \n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: TMF %d\n"
operator|,
name|satOrgIOContext
operator|->
name|TMF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|TMF
operator|==
name|AG_ABORT_TASK
condition|)
block|{
name|AbortTM
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|report
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|AbortTM
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: calling satAbort\n"
operator|)
argument_list|)
expr_stmt|;
name|satAbort
argument_list|(
name|agRoot
argument_list|,
name|satOrgIOContext
operator|->
name|satToBeAbortedIOContext
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|satDevData
operator|->
name|satPendingIO
operator|,
name|satDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|satDevData
operator|->
name|satPendingNCQIO
operator|,
name|satDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|tdOrgIORequestBody
operator|!=
name|agNULL
condition|)
block|{
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: tdOrgIORequestBody is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|report
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMOK
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satDeResetDeviceCB: device %p pending IO %d\n"
operator|,
name|satDevData
operator|,
name|satDevData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeResetDeviceCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for satStartCheckPowerMode.  *  *  SAT implementation for abort task management for non-ncq sata disk.  *  This function sends CHECK POWER MODE  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satStartCheckPowerMode
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
comment|/* NULL */
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|satInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
init|=
name|agNULL
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|tiIORequest_t
modifier|*
name|currentTaskTag
init|=
name|agNULL
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartCheckPowerMode: start\n"
operator|)
argument_list|)
expr_stmt|;
name|currentTaskTag
operator|=
name|tiIORequest
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartCheckPowerMode: before alloc\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate any fis for seting SRT bit in device control */
name|satIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartCheckPowerMode: before after\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartCheckPowerMode: can't alloacate\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|->
name|NotifyOS
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
block|}
return|return
name|tiError
return|;
block|}
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satIntIo
argument_list|,
name|tiIORequest
argument_list|,
name|satDevData
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartCheckPowerMode: OS satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartCheckPowerMode: TD satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartCheckPowerMode: OS tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartCheckPowerMode: TD tiScsiXchg %p \n"
operator|,
name|satNewIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartCheckPowerMode: satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|satCheckPowerMode
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
comment|/* New tiIORequest */
name|tiDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|tiScsiXchg
argument_list|,
comment|/* New tiScsiInitiatorRequest_t *tiScsiRequest, */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartCheckPowerMode: failed in sending\n"
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|->
name|NotifyOS
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
block|}
return|return
name|tiError
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satStartCheckPowerMode: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for satCheckPowerMode.  *  *  This function creates CHECK POWER MODE fis and sends the request to LL layer  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satCheckPowerMode
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     sends SAT_CHECK_POWER_MODE as a part of ABORT TASKMANGEMENT for NCQ commands     internally generated - no directly corresponding scsi   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satCheckPowerMode: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the ATA CHECK POWER MODE command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_CHECK_POWER_MODE
expr_stmt|;
comment|/* 0xE5 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satCheckPowerModeCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satCheckPowerMode: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satCheckPowerModeCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with CHECK POWER MODE completion as abort task *   management. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satCheckPowerModeCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/* callback for satDeResetDevice */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
init|=
name|agNULL
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|bit32
name|report
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|AbortTM
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satCheckPowerModeCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satCheckPowerModeCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satCheckPowerModeCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satCheckPowerModeCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: OSSA_IO_OPEN_CNX_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
comment|/* only agsaFisPioSetup_t is expected */
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: ataStatus 0x%x ataError 0x%x\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: success\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: TMF %d\n"
operator|,
name|satOrgIOContext
operator|->
name|TMF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|TMF
operator|==
name|AG_ABORT_TASK
condition|)
block|{
name|AbortTM
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|report
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|AbortTM
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: calling satAbort\n"
operator|)
argument_list|)
expr_stmt|;
name|satAbort
argument_list|(
name|agRoot
argument_list|,
name|satOrgIOContext
operator|->
name|satToBeAbortedIOContext
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|satDevData
operator|->
name|satPendingIO
operator|,
name|satDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|satDevData
operator|->
name|satPendingNCQIO
operator|,
name|satDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|tdOrgIORequestBody
operator|!=
name|agNULL
condition|)
block|{
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satCheckPowerModeCB: tdOrgIORequestBody is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|report
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMOK
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satCheckPowerModeCB: device %p pending IO %d\n"
operator|,
name|satDevData
operator|,
name|satDevData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satCheckPowerModeCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for satAddSATAStartIDDev.  *  *  This function sends identify device data to find out the uniqueness  *  of device.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satAddSATAStartIDDev
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
comment|// NULL
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|satInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: start\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: before alloc\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate identify device command */
name|satIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|satDevData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|,
comment|/* 512; size of identify device data */
name|satIntIo
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: after alloc\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: can't alloacate\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* fill in fields */
comment|/* real ttttttthe one worked and the same; 5/21/07/ */
name|satIntIo
operator|->
name|satOrgTiIORequest
operator|=
name|tiIORequest
expr_stmt|;
comment|/* changed */
name|tdIORequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSatDevData
operator|=
name|satDevData
expr_stmt|;
name|satNewIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSense
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pTiSenseData
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|tiRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
comment|/* key fix */
name|satNewIOContext
operator|->
name|interruptContext
operator|=
name|tiInterruptContext
expr_stmt|;
name|satNewIOContext
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satNewIOContext
operator|->
name|ptiDeviceHandle
operator|=
name|agNULL
expr_stmt|;
name|satNewIOContext
operator|->
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
comment|/* changed */
comment|/* this is valid only for TD layer generated (not triggered by OS at all) IO */
name|satNewIOContext
operator|->
name|tiScsiXchg
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: OS satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: TD satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: OS tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: TD tiScsiXchg %p \n"
operator|,
name|satNewIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: satNewIOContext %p tdIORequestBody %p\n"
operator|,
name|satNewIOContext
operator|,
name|tdIORequestBody
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|satAddSATASendIDDev
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
comment|/* New tiIORequest */
name|tiDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|tiScsiXchg
argument_list|,
comment|/* New tiScsiInitiatorRequest_t *tiScsiRequest, */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: failed in sending\n"
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"satAddSATAStartIDDev: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for satAddSATASendIDDev.  *  *  This function creates identify device data fis and send it to LL  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|satAddSATASendIDDev
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIoContext
decl_stmt|;
endif|#
directive|endif
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATASendIDDev: start\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satIntIoContext
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|tdIORequestBody
operator|=
name|satIntIoContext
operator|->
name|satIntRequestBody
expr_stmt|;
endif|#
directive|endif
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddSATASendIDDev: satIOContext %p tdIORequestBody %p\n"
operator|,
name|satIOContext
operator|,
name|tdIORequestBody
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_IDENTIFY_PACKET_DEVICE
expr_stmt|;
comment|/* 0x40 */
else|else
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_IDENTIFY_DEVICE
expr_stmt|;
comment|/* 0xEC */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|satAddSATAIDDevCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdhexdump
argument_list|(
literal|"satAddSATASendIDDev"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|satIOContext
operator|->
name|pFis
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdhexdump
argument_list|(
literal|"satAddSATASendIDDev LL"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATASendIDDev: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satAddSATAIDDevCB * *   This routine is a callback function for satAddSATASendIDDev() *   Using Identify Device Data, this function finds whether devicedata is *   new or old. If new, add it to the devicelist. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satAddSATAIDDevCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of Inquiry     Process SAT_IDENTIFY_DEVICE   */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit16
modifier|*
name|tmpptr
decl_stmt|,
name|tmpptr_tmp
decl_stmt|;
name|bit32
name|x
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|NewOneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|int
name|new_device
init|=
name|agTRUE
decl_stmt|;
name|bit8
name|PhyID
decl_stmt|;
name|void
modifier|*
name|sglVirtualAddr
decl_stmt|;
name|bit32
name|retry_status
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|bit32
name|status
init|=
literal|0
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|NewOneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: NewOneDeviceData %p did %d\n"
operator|,
name|NewOneDeviceData
operator|,
name|NewOneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|PhyID
operator|=
name|NewOneDeviceData
operator|->
name|phyID
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: phyID %d\n"
operator|,
name|PhyID
operator|)
argument_list|)
expr_stmt|;
name|agContext
operator|=
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|agDeviceResetContext
operator|)
expr_stmt|;
name|agContext
operator|->
name|osData
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: Not possible case\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|)
expr_stmt|;
comment|/* put onedevicedata back to free list */
name|osti_memset
argument_list|(
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: satOrgIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|sglVirtualAddr
operator|=
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|sglVirtualAddr
expr_stmt|;
block|}
block|}
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: satOrgIOContext->pid %d\n"
operator|,
name|satOrgIOContext
operator|->
name|pid
operator|)
argument_list|)
expr_stmt|;
comment|/* protect against double completion for old port */
if|if
condition|(
name|satOrgIOContext
operator|->
name|pid
operator|!=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|->
name|id
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: incorrect pid\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: satOrgIOContext->pid %d\n"
operator|,
name|satOrgIOContext
operator|->
name|pid
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: tiPortalContext pid %d\n"
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|)
expr_stmt|;
comment|/* put onedevicedata back to free list */
name|osti_memset
argument_list|(
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* no notification to OS layer */
return|return;
block|}
comment|/* completion after portcontext is invalidated */
name|onePortContext
operator|=
name|NewOneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: portcontext is invalid\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: onePortContext->id pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* no notification to OS layer */
return|return;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
operator|&&
name|satDevData
operator|->
name|ID_Retries
operator|<
name|SATA_ID_DEVICE_DATA_RETRIES
condition|)
block|{
name|satDevData
operator|->
name|satPendingNONNCQIO
operator|--
expr_stmt|;
name|satDevData
operator|->
name|satPendingIO
operator|--
expr_stmt|;
name|retry_status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|satIOContext
operator|->
name|tiScsiXchg
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry_status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* simply give up */
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satAddSATAIDDevCBCleanup
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
return|return;
block|}
name|satDevData
operator|->
name|ID_Retries
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
return|return;
block|}
else|else
block|{
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|==
literal|0
condition|)
block|{
name|satAddSATAIDDevCBCleanup
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* ResetInDiscovery in on */
block|{
comment|/* RESET only one after ID retries */
if|if
condition|(
name|satDevData
operator|->
name|NumOfIDRetries
operator|<=
literal|0
condition|)
block|{
name|satDevData
operator|->
name|NumOfIDRetries
operator|++
expr_stmt|;
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satAddSATAIDDevCBReset
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
comment|/* send link reset */
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|NewOneDeviceData
argument_list|)
argument_list|,
name|PhyID
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satAddSATAIDDevCBCleanup
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: OSSA_IO_OPEN_CNX_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
operator|&&
name|satDevData
operator|->
name|ID_Retries
operator|<
name|SATA_ID_DEVICE_DATA_RETRIES
condition|)
block|{
name|satDevData
operator|->
name|satPendingNONNCQIO
operator|--
expr_stmt|;
name|satDevData
operator|->
name|satPendingIO
operator|--
expr_stmt|;
name|retry_status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|satIOContext
operator|->
name|tiScsiXchg
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry_status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* simply give up */
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satAddSATAIDDevCBCleanup
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
return|return;
block|}
name|satDevData
operator|->
name|ID_Retries
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
return|return;
block|}
else|else
block|{
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|==
literal|0
condition|)
block|{
name|satAddSATAIDDevCBCleanup
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* ResetInDiscovery in on */
block|{
comment|/* RESET only one after ID retries */
if|if
condition|(
name|satDevData
operator|->
name|NumOfIDRetries
operator|<=
literal|0
condition|)
block|{
name|satDevData
operator|->
name|NumOfIDRetries
operator|++
expr_stmt|;
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satAddSATAIDDevCBReset
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
comment|/* send link reset */
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|NewOneDeviceData
argument_list|)
argument_list|,
name|PhyID
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satAddSATAIDDevCBCleanup
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
operator|||
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agFirstDword
operator|!=
name|agNULL
operator|&&
name|agIOInfoLen
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
operator|&&
name|satDevData
operator|->
name|ID_Retries
operator|<
name|SATA_ID_DEVICE_DATA_RETRIES
condition|)
block|{
name|satIOContext
operator|->
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|--
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|->
name|satPendingIO
operator|--
expr_stmt|;
name|retry_status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|satIOContext
operator|->
name|tiScsiXchg
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry_status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* simply give up */
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satAddSATAIDDevCBCleanup
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
return|return;
block|}
name|satDevData
operator|->
name|ID_Retries
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
return|return;
block|}
else|else
block|{
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|==
literal|0
condition|)
block|{
name|satAddSATAIDDevCBCleanup
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* ResetInDiscovery in on */
block|{
comment|/* RESET only one after ID retries */
if|if
condition|(
name|satDevData
operator|->
name|NumOfIDRetries
operator|<=
literal|0
condition|)
block|{
name|satDevData
operator|->
name|NumOfIDRetries
operator|++
expr_stmt|;
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satAddSATAIDDevCBReset
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
comment|/* send link reset */
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|NewOneDeviceData
argument_list|)
argument_list|,
name|PhyID
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satAddSATAIDDevCBCleanup
argument_list|(
name|agRoot
argument_list|,
name|NewOneDeviceData
argument_list|,
name|satIOContext
argument_list|,
name|tdOrgIORequestBody
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
block|}
comment|/* success */
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: Success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Convert to host endian */
name|tmpptr
operator|=
operator|(
name|bit16
operator|*
operator|)
name|sglVirtualAddr
expr_stmt|;
comment|//tdhexdump("satAddSATAIDDevCB before", (bit8 *)sglVirtualAddr, sizeof(agsaSATAIdentifyData_t));
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bit16
argument_list|)
condition|;
name|x
operator|++
control|)
block|{
name|OSSA_READ_LE_16
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tmpptr_tmp
argument_list|,
name|tmpptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|tmpptr
operator|=
name|tmpptr_tmp
expr_stmt|;
name|tmpptr
operator|++
expr_stmt|;
comment|/*Print tmpptr_tmp here for debugging purpose*/
block|}
name|pSATAIdData
operator|=
operator|(
name|agsaSATAIdentifyData_t
operator|*
operator|)
name|sglVirtualAddr
expr_stmt|;
comment|//tdhexdump("satAddSATAIDDevCB after", (bit8 *)pSATAIdData, sizeof(agsaSATAIdentifyData_t));
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: OS satOrgIOContext %p \n"
operator|,
name|satOrgIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: TD satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: OS tiScsiXchg %p \n"
operator|,
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: TD tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
comment|/* compare idenitfy device data to the exiting list */
name|DeviceListList
operator|=
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: LOOP oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|//tdhexdump("satAddSATAIDDevCB LOOP", (bit8 *)&oneDeviceData->satDevData.satIdentifyData, sizeof(agsaSATAIdentifyData_t));
comment|/* what is unique ID for sata device -> response of identify devicedata; not really        Let's compare serial number, firmware version, model number     */
if|if
condition|(
name|oneDeviceData
operator|->
name|DeviceType
operator|==
name|TD_SATA_DEVICE
operator|&&
operator|(
name|osti_memcmp
argument_list|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|.
name|serialNumber
argument_list|,
name|pSATAIdData
operator|->
name|serialNumber
argument_list|,
literal|20
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|osti_memcmp
argument_list|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|.
name|firmwareVersion
argument_list|,
name|pSATAIdData
operator|->
name|firmwareVersion
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|osti_memcmp
argument_list|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|.
name|modelNumber
argument_list|,
name|pSATAIdData
operator|->
name|modelNumber
argument_list|,
literal|40
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|new_device
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|new_device
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: old device data\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agTRUE
expr_stmt|;
comment|/* save data field from new device data */
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|oneDeviceData
operator|->
name|agDevHandle
operator|=
name|NewOneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|oneDeviceData
operator|->
name|agDevHandle
operator|->
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
comment|/* TD layer */
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|NewOneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
name|oneDeviceData
operator|->
name|phyID
operator|=
name|NewOneDeviceData
operator|->
name|phyID
expr_stmt|;
comment|/*       one SATA directly attached device per phy;       Therefore, deregister then register     */
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|NewOneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: re-registering old device data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* already has old information; just register it again */
name|saRegisterNewDevice
argument_list|(
comment|/* satAddSATAIDDevCB */
name|agRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agContext
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|agPortContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|//    tdsaAbortAll(tiRoot, agRoot, NewOneDeviceData);
comment|/* put onedevicedata back to free list */
name|osti_memset
argument_list|(
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|NewOneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
comment|/* send the Set Feature ATA command to ATAPI device for enbling PIO and DMA transfer mode*/
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* enable PIO mode, then enable Ultra DMA mode in the satSetFeaturesCB callback function*/
name|status
operator|=
name|satSetFeatures
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: pid %d\n"
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: new device data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* copy ID Dev data to satDevData */
name|satDevData
operator|->
name|satIdentifyData
operator|=
operator|*
name|pSATAIdData
expr_stmt|;
name|satDevData
operator|->
name|IDDeviceValid
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdhexdump
argument_list|(
literal|"satAddSATAIDDevCB ID Dev data"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pSATAIdData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"satAddSATAIDDevCB Device ID Dev data"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|satDevData
operator|->
name|satIdentifyData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* set satDevData fields from IndentifyData */
name|satSetDevInfo
argument_list|(
name|satDevData
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
comment|/* send the Set Feature ATA command to ATAPI device for enbling PIO and DMA transfer mode*/
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* enable PIO mode, then enable Ultra DMA mode in the satSetFeaturesCB callback function*/
name|status
operator|=
name|satSetFeatures
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: pid %d\n"
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satAddSATAIDDevCBReset * *   This routine cleans up IOs for failed Identify device data * *  \param   agRoot:           Handles for this instance of SAS/SATA hardware *  \param   oneDeviceData:    Pointer to the device data. *  \param   ioContext:        Pointer to satIOContext_t. *  \param   tdIORequestBody:  Pointer to the request body *  \param   flag:             Decrement pending io or not * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satAddSATAIDDevCBReset
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCBReset: start\n"
operator|)
argument_list|)
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satAddSATAIDDevCBCleanup * *   This routine cleans up IOs for failed Identify device data * *  \param   agRoot:           Handles for this instance of SAS/SATA hardware *  \param   oneDeviceData:    Pointer to the device data. *  \param   ioContext:        Pointer to satIOContext_t. *  \param   tdIORequestBody:  Pointer to the request body * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satAddSATAIDDevCBCleanup
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|bit8
name|PhyID
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"satAddSATAIDDevCBCleanup: start\n"
operator|)
argument_list|)
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|PhyID
operator|=
name|oneDeviceData
operator|->
name|phyID
expr_stmt|;
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* put onedevicedata back to free list */
name|osti_memset
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for tdsaDiscoveryStartIDDev.  *  *  This function sends identify device data to SATA device in discovery  *  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   oneDeviceData :   Pointer to the device data.  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|tdsaDiscoveryStartIDDev
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
comment|/* agNULL */
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
comment|/* agNULL */
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
comment|/* identify device data itself */
name|satIOContext_t
modifier|*
name|satIOContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
comment|/* allocate tdiorequestbody and call tdsaDiscoveryIntStartIDDev   tdsaDiscoveryIntStartIDDev(tiRoot, agNULL, tiDeviceHandle, satIOContext);    */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDev: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDev: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* allocation tdIORequestBody and pass it to satTM() */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDev: ostiAllocMemory failed... loc 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDev: ostiAllocMemory returned NULL tdIORequestBody loc 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* setup identify device data IO structure */
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|CurrentTaskTag
operator|=
name|agNULL
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|TaskTag
operator|=
name|agNULL
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
comment|/* initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|agNULL
expr_stmt|;
comment|/* initialize agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SA takes care of this */
comment|/* set up satIOContext */
name|satIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|tiRequestBody
operator|=
name|tdIORequestBody
expr_stmt|;
name|satIOContext
operator|->
name|ptiDeviceHandle
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|tiScsiXchg
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satIntIoContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
comment|/* followings are used only for internal IO */
name|satIOContext
operator|->
name|currentLBA
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|satToBeAbortedIOContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|NotifyOS
operator|=
name|agFALSE
expr_stmt|;
comment|/* saving port ID just in case of full discovery to full discovery transition */
name|satIOContext
operator|->
name|pid
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|id
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0x0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaDiscoveryIntStartIDDev
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
comment|/* agNULL */
name|tiDeviceHandle
argument_list|,
comment|/*&(oneDeviceData->tiDeviceHandle)*/
name|agNULL
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDev: failed in sending %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for tdsaDiscoveryIntStartIDDev.  *  *  This function sends identify device data to SATA device.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|tdsaDiscoveryIntStartIDDev
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
comment|/* agNULL */
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
comment|/* agNULL */
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|satInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
init|=
name|agNULL
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryIntStartIDDev: start\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|/* allocate identify device command */
name|satIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|satDevData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|,
comment|/* 512; size of identify device data */
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"tdsaDiscoveryIntStartIDDev: can't alloacate\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
comment|/* fill in fields */
comment|/* real ttttttthe one worked and the same; 5/21/07/ */
name|satIntIo
operator|->
name|satOrgTiIORequest
operator|=
name|tiIORequest
expr_stmt|;
comment|/* changed */
name|tdIORequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSatDevData
operator|=
name|satDevData
expr_stmt|;
name|satNewIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSense
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pTiSenseData
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|tiRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
comment|/* key fix */
name|satNewIOContext
operator|->
name|interruptContext
operator|=
name|tiInterruptContext
expr_stmt|;
name|satNewIOContext
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satNewIOContext
operator|->
name|ptiDeviceHandle
operator|=
name|agNULL
expr_stmt|;
name|satNewIOContext
operator|->
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
comment|/* changed */
comment|/* this is valid only for TD layer generated (not triggered by OS at all) IO */
name|satNewIOContext
operator|->
name|tiScsiXchg
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaDiscoveryIntStartIDDev: OS satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaDiscoveryIntStartIDDev: TD satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaDiscoveryIntStartIDDev: OS tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaDiscoveryIntStartIDDev: TD tiScsiXchg %p \n"
operator|,
name|satNewIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryIntStartIDDev: satNewIOContext %p tdIORequestBody %p\n"
operator|,
name|satNewIOContext
operator|,
name|tdIORequestBody
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tdsaDiscoverySendIDDev
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
comment|/* New tiIORequest */
name|tiDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|tiScsiXchg
argument_list|,
comment|/* New tiScsiInitiatorRequest_t *tiScsiRequest, */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryIntStartIDDev: failed in sending %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaDiscoveryIntStartIDDev: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for tdsaDiscoverySendIDDev.  *  *  This function prepares identify device data FIS and sends it to SATA device.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|tdsaDiscoverySendIDDev
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIoContext
decl_stmt|;
endif|#
directive|endif
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverySendIDDev: start\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satIntIoContext
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|tdIORequestBody
operator|=
name|satIntIoContext
operator|->
name|satIntRequestBody
expr_stmt|;
endif|#
directive|endif
name|TI_DBG5
argument_list|(
operator|(
literal|"tdsaDiscoverySendIDDev: satIOContext %p tdIORequestBody %p\n"
operator|,
name|satIOContext
operator|,
name|tdIORequestBody
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_IDENTIFY_PACKET_DEVICE
expr_stmt|;
comment|/* 0xA1 */
else|else
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_IDENTIFY_DEVICE
expr_stmt|;
comment|/* 0xEC */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|tdsaDiscoveryStartIDDevCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdhexdump
argument_list|(
literal|"tdsaDiscoverySendIDDev"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|satIOContext
operator|->
name|pFis
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdhexdump
argument_list|(
literal|"tdsaDiscoverySendIDDev LL"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoverySendIDDev: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdsaDiscoveryStartIDDevCB * *   This routine is a callback function for tdsaDiscoverySendIDDev() *   Using Identify Device Data, this function finds whether devicedata is *   new or old. If new, add it to the devicelist. This is done as a part *   of discovery. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|tdsaDiscoveryStartIDDevCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of SAT_IDENTIFY_DEVICE during discovery   */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
init|=
name|agNULL
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit16
modifier|*
name|tmpptr
decl_stmt|,
name|tmpptr_tmp
decl_stmt|;
name|bit32
name|x
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|sglVirtualAddr
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tiPortalContext_t
modifier|*
name|tiPortalContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|retry_status
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: onePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiPortalContext
operator|=
name|onePortContext
operator|->
name|tiPortalContext
expr_stmt|;
name|satDevData
operator|->
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: Not possible case\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: satOrgIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|sglVirtualAddr
operator|=
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|sglVirtualAddr
expr_stmt|;
block|}
block|}
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: satOrgIOContext->pid %d\n"
operator|,
name|satOrgIOContext
operator|->
name|pid
operator|)
argument_list|)
expr_stmt|;
comment|/* protect against double completion for old port */
if|if
condition|(
name|satOrgIOContext
operator|->
name|pid
operator|!=
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|id
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: incorrect pid\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: satOrgIOContext->pid %d\n"
operator|,
name|satOrgIOContext
operator|->
name|pid
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: tiPortalContext pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|tdPortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* completion after portcontext is invalidated */
if|if
condition|(
name|onePortContext
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: portcontext is invalid\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: onePortContext->id pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* no notification to OS layer */
return|return;
block|}
block|}
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
operator|&&
name|satDevData
operator|->
name|ID_Retries
operator|<
name|SATA_ID_DEVICE_DATA_RETRIES
condition|)
block|{
name|satIOContext
operator|->
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|--
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|->
name|satPendingIO
operator|--
expr_stmt|;
name|retry_status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|satIOContext
operator|->
name|tiScsiXchg
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry_status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* simply give up */
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satDevData
operator|->
name|ID_Retries
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
return|return;
block|}
else|else
block|{
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
condition|)
block|{
comment|/* ResetInDiscovery in on */
if|if
condition|(
name|satDevData
operator|->
name|NumOfIDRetries
operator|<=
literal|0
condition|)
block|{
name|satDevData
operator|->
name|NumOfIDRetries
operator|++
expr_stmt|;
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
comment|/* send link reset */
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_UNDERFLOW
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_NAK_RECEIVED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_DMA
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_SATA_LINK_TIMEOUT
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_REJECTED_NCQ_MODE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_NO_DEVICE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_PORT_IN_RESET
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_ERROR
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: OSSA_IO_OPEN_CNX_ERROR 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
operator|&&
name|satDevData
operator|->
name|ID_Retries
operator|<
name|SATA_ID_DEVICE_DATA_RETRIES
condition|)
block|{
name|satIOContext
operator|->
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|--
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|->
name|satPendingIO
operator|--
expr_stmt|;
name|retry_status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|satIOContext
operator|->
name|tiScsiXchg
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry_status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* simply give up */
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satDevData
operator|->
name|ID_Retries
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
return|return;
block|}
else|else
block|{
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
condition|)
block|{
comment|/* ResetInDiscovery in on */
if|if
condition|(
name|satDevData
operator|->
name|NumOfIDRetries
operator|<=
literal|0
condition|)
block|{
name|satDevData
operator|->
name|NumOfIDRetries
operator|++
expr_stmt|;
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
comment|/* send link reset */
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
operator|||
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agFirstDword
operator|!=
name|agNULL
operator|&&
name|agIOInfoLen
operator|!=
literal|0
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
comment|/* only agsaFisPioSetup_t is expected */
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: ataStatus 0x%x ataError 0x%x\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
operator|&&
name|satDevData
operator|->
name|ID_Retries
operator|<
name|SATA_ID_DEVICE_DATA_RETRIES
condition|)
block|{
name|satIOContext
operator|->
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|--
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|->
name|satPendingIO
operator|--
expr_stmt|;
name|retry_status
operator|=
name|sataLLIOStart
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|satIOContext
operator|->
name|tiScsiXchg
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry_status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* simply give up */
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satDevData
operator|->
name|ID_Retries
operator|++
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
return|return;
block|}
else|else
block|{
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|!=
literal|0
condition|)
block|{
comment|/* ResetInDiscovery in on */
if|if
condition|(
name|satDevData
operator|->
name|NumOfIDRetries
operator|<=
literal|0
condition|)
block|{
name|satDevData
operator|->
name|NumOfIDRetries
operator|++
expr_stmt|;
name|satDevData
operator|->
name|ID_Retries
operator|=
literal|0
expr_stmt|;
comment|/* send link reset */
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
block|}
comment|/* success */
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: Success\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: Success did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* Convert to host endian */
name|tmpptr
operator|=
operator|(
name|bit16
operator|*
operator|)
name|sglVirtualAddr
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bit16
argument_list|)
condition|;
name|x
operator|++
control|)
block|{
name|OSSA_READ_LE_16
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tmpptr_tmp
argument_list|,
name|tmpptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|tmpptr
operator|=
name|tmpptr_tmp
expr_stmt|;
name|tmpptr
operator|++
expr_stmt|;
block|}
name|pSATAIdData
operator|=
operator|(
name|agsaSATAIdentifyData_t
operator|*
operator|)
name|sglVirtualAddr
expr_stmt|;
comment|//tdhexdump("satAddSATAIDDevCB before", (bit8 *)pSATAIdData, sizeof(agsaSATAIdentifyData_t));
name|TI_DBG5
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: OS satOrgIOContext %p \n"
operator|,
name|satOrgIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: TD satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: OS tiScsiXchg %p \n"
operator|,
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: TD tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
comment|/* copy ID Dev data to satDevData */
name|satDevData
operator|->
name|satIdentifyData
operator|=
operator|*
name|pSATAIdData
expr_stmt|;
name|satDevData
operator|->
name|IDDeviceValid
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdhexdump
argument_list|(
literal|"tdsaDiscoveryStartIDDevCB ID Dev data"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pSATAIdData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"tdsaDiscoveryStartIDDevCB Device ID Dev data"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|satDevData
operator|->
name|satIdentifyData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* set satDevData fields from IndentifyData */
name|satSetDevInfo
argument_list|(
name|satDevData
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
comment|/* send the Set Feature ATA command to ATAPI device for enbling PIO and DMA transfer mode*/
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* enable PIO mode, then enable Ultra DMA mode in the satSetFeaturesCB callback function*/
name|retry_status
operator|=
name|satSetFeatures
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry_status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|ITD_DSTATE_COMPLETED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: ID completed after discovery is done; tiDeviceArrival\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* in case registration is finished after discovery is finished */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: onePortContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"tdsaDiscoveryStartIDDevCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satAbort * *   This routine does local abort for outstanding FIS. * *  \param   agRoot:         Handles for this instance of SAS/SATA hardware *  \param   satIOContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satAbort
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
comment|/* io to be aborted */
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
decl_stmt|;
comment|/* abort io itself */
name|agsaIORequest_t
modifier|*
name|agToBeAbortedIORequest
decl_stmt|;
comment|/* io to be aborted */
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
decl_stmt|;
comment|/* abort io itself */
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satAbort: satIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|agToBeAbortedIORequest
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"satAbort: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"satAbort: ostiAllocMemory returned NULL tdAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/*    * Issue abort    */
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agToBeAbortedIORequest
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satAbort: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief  satSATADeviceReset  *  *   This routine is called to reset all phys of port which a device belongs to  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   oneDeviceData:    Pointer to the device data.  *  \param   flag:             reset flag  *  *  \return:  *  *  none  *  *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|satSATADeviceReset
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSATADeviceReset: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|agRoot
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSATADeviceReset: Error!!! agRoot is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSATADeviceReset: Error!!! onePortContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TD_MAX_NUM_PHYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|PhyIDList
index|[
name|i
index|]
operator|==
name|agTRUE
condition|)
block|{
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|)
argument_list|,
name|i
argument_list|,
name|flag
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* #ifdef SATA_ENABLE */
end_comment

end_unit


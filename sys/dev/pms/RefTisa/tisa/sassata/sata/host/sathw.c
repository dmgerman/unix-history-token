begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/** \file  *  * The file implementing LL HW encapsulation for SCSI/ATA Translation (SAT).  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SATA_ENABLE
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sata/host/sat.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sata/host/satproto.h>
end_include

begin_comment
comment|/*  * This table is used to map LL Layer saSATAStart() status to TISA status.  */
end_comment

begin_decl_stmt
specifier|static
name|bit32
name|mapStat
index|[
literal|3
index|]
init|=
block|{
name|tiSuccess
block|,
name|tiError
block|,
name|tiBusy
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************  *! \brief  sataLLIOStart  *  *   This routine is called to initiate a new SATA request to LL layer.  *   This function implements/encapsulates HW and LL API dependency.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return:  *  *  \e tiSuccess:     I/O request successfully initiated.  *  \e tiBusy:        No resources available, try again later.  *  \e tiIONoDevice:  Invalid device handle.  *  \e tiError:       Other errors that prevent the I/O request to be started.  *  *  *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|sataLLIOStart
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaSATAInitiatorRequest_t
modifier|*
name|agSATAReq
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|bit32
name|RLERecovery
init|=
name|agFALSE
decl_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|agSATAReq
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|)
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
comment|/*    * If this is a super I/O request, check for optional settings.    * Be careful. Use the superRequest pointer for all references    * in this block of code.    */
name|agSATAReq
operator|->
name|option
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|tiSuperScsiInitiatorRequest_t
modifier|*
name|superRequest
init|=
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|tiScsiRequest
decl_stmt|;
name|agBOOLEAN
name|needPlusDataLenAdjustment
init|=
name|agFALSE
decl_stmt|;
name|agBOOLEAN
name|needMinusDataLenAdjustment
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|adjusted_length
decl_stmt|;
if|if
condition|(
name|superRequest
operator|->
name|flags
operator|&
name|TI_SCSI_INITIATOR_ENCRYPT
condition|)
block|{
comment|/*          * Copy all of the relevant encrypt information          */
name|agSATAReq
operator|->
name|option
operator||=
name|AGSA_SATA_ENABLE_ENCRYPTION
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|agSATAReq
operator|->
name|encrypt
argument_list|,
operator|&
name|superRequest
operator|->
name|Encrypt
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaEncrypt_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|superRequest
operator|->
name|flags
operator|&
name|TI_SCSI_INITIATOR_DIF
condition|)
block|{
comment|/*            * Copy all of the relevant DIF information            */
name|agSATAReq
operator|->
name|option
operator||=
name|AGSA_SATA_ENABLE_DIF
expr_stmt|;
name|osti_memcpy
argument_list|(
operator|&
name|agSATAReq
operator|->
name|dif
argument_list|,
operator|&
name|superRequest
operator|->
name|Dif
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDif_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*            * Set SGL data len            * XXX This code needs to support more sector sizes            */
if|if
condition|(
name|needPlusDataLenAdjustment
operator|==
name|agTRUE
condition|)
block|{
name|adjusted_length
operator|=
name|superRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
name|adjusted_length
operator|+=
operator|(
name|adjusted_length
operator|/
literal|512
operator|)
operator|*
literal|8
expr_stmt|;
name|agSATAReq
operator|->
name|dataLength
operator|=
name|adjusted_length
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|needMinusDataLenAdjustment
operator|==
name|agTRUE
condition|)
block|{
name|adjusted_length
operator|=
name|superRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
name|adjusted_length
operator|-=
operator|(
name|adjusted_length
operator|/
literal|520
operator|)
operator|*
literal|8
expr_stmt|;
name|agSATAReq
operator|->
name|dataLength
operator|=
name|adjusted_length
expr_stmt|;
block|}
else|else
block|{
comment|/* setting the data length */
name|agSATAReq
operator|->
name|dataLength
operator|=
name|superRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
name|agSATAReq
operator|->
name|dataLength
expr_stmt|;
block|}
else|else
block|{
comment|/* initialize expDataLength */
if|if
condition|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_NON_DATA
operator|||
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_SRST_ASSERT
operator|||
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_SRST_DEASSERT
condition|)
block|{
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|agSATAReq
operator|->
name|dataLength
operator|=
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
expr_stmt|;
block|}
block|}
else|else
block|{
name|agSATAReq
operator|->
name|option
operator|=
literal|0
expr_stmt|;
comment|/* initialize expDataLength */
if|if
condition|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_NON_DATA
operator|||
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_SRST_ASSERT
operator|||
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_SRST_DEASSERT
condition|)
block|{
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|agSATAReq
operator|->
name|dataLength
operator|=
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|satIOContext
operator|->
name|pFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_LOG_EXT
operator|)
condition|)
block|{
name|RLERecovery
operator|=
name|agTRUE
expr_stmt|;
block|}
comment|/* check max io */
comment|/* be sure to free */
if|if
condition|(
operator|(
name|pSatDevData
operator|->
name|satDriveState
operator|!=
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|||
operator|(
name|RLERecovery
operator|==
name|agTRUE
operator|)
condition|)
block|{
if|if
condition|(
name|RLERecovery
operator|==
name|agFALSE
condition|)
comment|/* RLE is not checked against pending IO's */
block|{
if|if
condition|(
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|>=
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|||
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"sataLLIOStart: 1st busy NCQ. NCQ Pending %d NONNCQ Pending %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
comment|/* free resource */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return
name|tiBusy
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|>=
name|SAT_NONNCQ_MAX
operator|||
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|!=
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"sataLLIOStart: 2nd busy NON-NCQ. NCQ Pending %d NON-NCQ Pending %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
comment|/* free resource */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return
name|tiBusy
return|;
block|}
block|}
block|}
comment|/* RLE */
comment|/* for internal SATA command only */
if|if
condition|(
name|satIOContext
operator|->
name|satOrgIOContext
operator|!=
name|agNULL
condition|)
block|{
comment|/* Initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
block|}
comment|/* Initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
comment|/* Initializes Scatter Gather and ESGL */
name|status
operator|=
name|itdsataIOPrepareSGL
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
argument_list|,
operator|&
name|tiScsiRequest
operator|->
name|agSgl1
argument_list|,
name|tiScsiRequest
operator|->
name|sglVirtualAddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"sataLLIOStart: can't get SGL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* Initialize LL Layer agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SA takes care of this */
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
comment|/*    #ifdef PRE_SALL_v033 GLOBAL bit32 saSATAStart(                         agsaRoot_t      *agRoot,                         agsaIORequest_t *agIORequest,                         agsaDevHandle_t *agDevHandle,                         bit32           agRequestType,                         agsaSATAInitiatorRequest_t  *agSATAReq,                         bit8            *agTag                         ); #endif GLOBAL bit32 saSATAStart(                         agsaRoot_t                  *agRoot,                         agsaIORequest_t             *agIORequest,                         agsaDevHandle_t             *agDevHandle,                         bit32                       agRequestType,                         agsaSATAInitiatorRequest_t  *agSATAReq,                         bit8                        agTag,                         ossaSATACompletedCB_t       agCB                         );   */
comment|/* assign tag value for SATA */
if|if
condition|(
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
if|if
condition|(
name|agFALSE
operator|==
name|satTagAlloc
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
operator|&
name|satIOContext
operator|->
name|sataTag
argument_list|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"sataLLIOStart: No more NCQ tag\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
return|return
name|tiBusy
return|;
block|}
name|TI_DBG3
argument_list|(
operator|(
literal|"sataLLIOStart: ncq tag 0x%x\n"
operator|,
name|satIOContext
operator|->
name|sataTag
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|satIOContext
operator|->
name|sataTag
operator|=
literal|0xFF
expr_stmt|;
block|}
block|}
else|else
comment|/* AGSA_SATA_PROTOCOL_SRST_ASSERT or AGSA_SATA_PROTOCOL_SRST_DEASSERT           or SAT_CHECK_POWER_MODE as ABORT */
block|{
name|agsaSgl_t
modifier|*
name|agSgl
decl_stmt|;
comment|/* for internal SATA command only */
if|if
condition|(
name|satIOContext
operator|->
name|satOrgIOContext
operator|!=
name|agNULL
condition|)
block|{
comment|/* Initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|tiIORequest
expr_stmt|;
block|}
comment|/* Initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|=
literal|0
expr_stmt|;
comment|/* SGL for SATA request */
name|agSgl
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|agSgl
operator|)
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|agSgl
operator|->
name|sgUpper
operator|=
literal|0
expr_stmt|;
name|agSgl
operator|->
name|sgLower
operator|=
literal|0
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|CLEAR_ESGL_EXTEND
argument_list|(
name|agSgl
operator|->
name|extReserved
argument_list|)
expr_stmt|;
comment|/* Initialize LL Layer agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SA takes care of this */
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
comment|/* setting the data length */
name|agSATAReq
operator|->
name|dataLength
operator|=
literal|0
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
name|osti_memset
argument_list|(
name|agSATAReq
operator|->
name|scsiCDB
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|osti_memcpy
argument_list|(
name|agSATAReq
operator|->
name|scsiCDB
argument_list|,
name|tiScsiRequest
operator|->
name|scsiCmnd
operator|.
name|cdb
argument_list|,
literal|16
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdhexdump
argument_list|(
literal|"sataLLIOStart"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|satIOContext
operator|->
name|pFis
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"sataLLIOStart LL"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|agSATAReq
operator|->
name|fis
operator|.
name|fisRegHostToDev
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TI_DBG6
argument_list|(
operator|(
literal|"sataLLIOStart: agDevHandle %p\n"
operator|,
name|agDevHandle
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|saSATAStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|satIOContext
operator|->
name|reqType
argument_list|,
name|agSATAReq
argument_list|,
name|satIOContext
operator|->
name|sataTag
argument_list|,
name|ossaSATACompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satPendingIO
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satPendingNCQIO
operator|++
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satPendingNONNCQIO
operator|++
expr_stmt|;
block|}
name|TDLIST_INIT_ELEMENT
argument_list|(
operator|&
name|satIOContext
operator|->
name|satIoContextLink
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
name|satIOContext
operator|->
name|satIoContextLink
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIoLinkList
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
comment|//    TI_DBG5(("sataLLIOStart: device %p pending IO %d\n", oneDeviceData->satDevData,oneDeviceData->satDevData.satPendingIO));
block|}
else|else
block|{
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"sataLLIOStart: saSATAStart busy\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"sataLLIOStart: saSATAStart failed\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
name|satTagRelease
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIOContext
operator|->
name|sataTag
argument_list|)
expr_stmt|;
block|}
comment|/* Free the ESGL pages associated with this I/O */
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
comment|/*      * Map the SAS/SATA LL layer status to the TISA status      */
name|status
operator|=
name|mapStat
index|[
name|status
index|]
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
return|return
operator|(
name|tiSuccess
operator|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdsataIOPrepareSGL * *  This function is called to prepare and translate the TISA SGL information *  to the SAS/SATA LL layer specific SGL. This function is similar to *  itdssIOPrepareSGL(), except the request body reflects SATA host request. * *  \param    tiRoot:         Pointer to initiator driver/port instance. *  \param    IORequestBody:  TD layer request body for the I/O. *  \param    tiSgl1:         First TISA SGL info. *  \param    tiSgl2:         Second TISA SGL info. *  \param    sglVirtualAddr: The virtual address of the first element in *                            tiSgl1 when tiSgl1 is used with the type tiSglList. * *  \return: * *  \e tiSuccess:     SGL initialized successfully. *  \e tiError:       Failed to initialize SGL. * * *****************************************************************************/
end_comment

begin_function
unit|\
name|osGLOBAL
name|bit32
name|itdsataIOPrepareSGL
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
parameter_list|,
name|tiSgl_t
modifier|*
name|tiSgl1
parameter_list|,
name|void
modifier|*
name|sglVirtualAddr
parameter_list|)
block|{
name|agsaSgl_t
modifier|*
name|agSgl
decl_stmt|;
comment|/* Uppper should be zero-out */
name|TI_DBG5
argument_list|(
operator|(
literal|"itdsataIOPrepareSGL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"itdsataIOPrepareSGL: tiSgl1->upper %d tiSgl1->lower %d tiSgl1->len %d\n"
operator|,
name|tiSgl1
operator|->
name|upper
operator|,
name|tiSgl1
operator|->
name|lower
operator|,
name|tiSgl1
operator|->
name|len
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"itdsataIOPrepareSGL: tiSgl1->type %d\n"
operator|,
name|tiSgl1
operator|->
name|type
operator|)
argument_list|)
expr_stmt|;
comment|/* SGL for SATA request */
name|agSgl
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|agSgl
operator|)
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tiSgl1
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsataIOPrepareSGL: Error tiSgl1 is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorRegIO
operator|.
name|expDataLength
operator|==
literal|0
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"itdsataIOPrepareSGL: expDataLength is 0\n"
operator|)
argument_list|)
expr_stmt|;
name|agSgl
operator|->
name|sgUpper
operator|=
literal|0
expr_stmt|;
name|agSgl
operator|->
name|sgLower
operator|=
literal|0
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|CLEAR_ESGL_EXTEND
argument_list|(
name|agSgl
operator|->
name|extReserved
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
name|agSgl
operator|->
name|sgUpper
operator|=
name|tiSgl1
operator|->
name|upper
expr_stmt|;
name|agSgl
operator|->
name|sgLower
operator|=
name|tiSgl1
operator|->
name|lower
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
name|tiSgl1
operator|->
name|len
expr_stmt|;
name|agSgl
operator|->
name|extReserved
operator|=
name|tiSgl1
operator|->
name|type
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *! \brief  sataLLIOAbort  *  *   This routine is called to initiate an I/O abort to LL layer.  *   This function implements/encapsulates HW and LL API dependency.  *  *  \param   tiRoot:      Pointer to TISA initiator driver/port instance.  *  \param   taskTag:     Pointer to TISA I/O context to be aborted.  *  *  \return:  *  *  \e tiSuccess:     Abort request was successfully initiated.  *  \e tiBusy:        No resources available, try again later.  *  \e tiError:       Other errors that prevent the abort request from being  *                    started..  *  *  *****************************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_comment
comment|/* not in use */
end_comment

begin_function
name|GLOBAL
name|bit32
name|sataLLIOAbort
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|taskTag
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"sataLLIOAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|taskTag
operator|->
name|tdData
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|status
operator|=
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|,
name|agIORequest
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"sataLLIOAbort: agIORequest %p\n"
operator|,
name|agIORequest
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"sataLLIOAbort: saSATAAbort returns status, %x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
return|return
name|tiSuccess
return|;
block|}
else|else
block|{
return|return
name|tiError
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|REMOVED
end_ifdef

begin_comment
comment|/*****************************************************************************  *! \brief  sataLLReset  *  *   This routine is called to initiate a SATA device reset to LL layer.  *   This function implements/encapsulates HW and LL API dependency.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   option:           SATA device reset option  *  *  \return: None  *  *  *****************************************************************************/
end_comment

begin_comment
comment|/* not in use */
end_comment

begin_function
name|GLOBAL
name|void
name|sataLLReset
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|bit32
name|option
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"sataLLReset: extry\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaRoot
operator|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
expr_stmt|;
name|tdsaAllShared
operator|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
expr_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|satSATADeviceReset
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* 0 */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* #ifdef SATA_ENABLE */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/** \file  *  * The file implementing SCSI/ATA Translation (SAT) for LL Layer callback  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SATA_ENABLE
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sata/host/sat.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sata/host/satproto.h>
end_include

begin_comment
comment|/***************************************************************************** *! \brief  ossaSATACompleted * *   This routine is called to complete a SATA request previously issued to the *    LL Layer in saSATAStart() * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|ossaSATACompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|void
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|TDSA_OUT_ENTER
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaSATACompleted: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIORequest
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: agIORequest is NULL!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|tdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: tdIORequestBody is NULL!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
if|if
condition|(
name|tdIORequestBody
operator|->
name|ioCompleted
operator|==
name|agTRUE
condition|)
block|{
name|tiDeviceHandle
operator|=
name|tdIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: tiDeviceHandle is NULL!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: Error!!!!!! double completion\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: tdsaDeviceData is NULL!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: did %d \n"
operator|,
name|tdsaDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: satIOContext is NULL!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
if|if
condition|(
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|!=
name|agNULL
condition|)
block|{
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|->
name|tdData
expr_stmt|;
block|}
if|if
condition|(
name|pSatDevData
operator|==
name|agNULL
operator|&&
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: pSatDevData is NULL, loc 1, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|pSatDevData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: pSatDevData is NULL loc 2, wrong\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|->
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: external command\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: internal command\n"
operator|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|ext
goto|;
block|}
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|pSatDevData
operator|->
name|satSaDeviceData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|!=
name|tdsaDeviceData
condition|)
block|{
if|if
condition|(
name|satIOContext
operator|->
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: diff device handle; external command\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: diff device handle; internal command\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|tdsaDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: tdsaDeviceData is NULL!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|onePortContext
operator|=
name|tdsaDeviceData
operator|->
name|tdPortContext
expr_stmt|;
comment|/* retries in OSSA_IO_XFER_OPEN_RETRY_TIMEOUT */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
condition|)
block|{
if|if
condition|(
name|tdsaDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|tdsaDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|tdsaDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|tdIORequestBody
operator|->
name|reTries
operator|<=
name|OPEN_RETRY_RETRIES
condition|)
comment|/* 10 */
block|{
name|agDevHandle
operator|=
name|tdsaDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|status
operator|=
name|saSATAStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|tdsaDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|satIOContext
operator|->
name|reqType
argument_list|,
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|)
argument_list|,
name|satIOContext
operator|->
name|sataTag
argument_list|,
name|ossaSATACompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: retried\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|++
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: retry failed\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* retries is over, do nothing */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: retry is over and fail\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: incorrect device state or no portcontext\n"
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|reTries
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* if OSSA_IO_XFER_OPEN_RETRY_TIMEOUT*/
comment|/* release tag value for SATA */
if|if
condition|(
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
name|satTagRelease
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIOContext
operator|->
name|sataTag
argument_list|)
expr_stmt|;
block|}
comment|/* send SMP_PHY_CONTROL_HARD_RESET */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
operator|&&
name|tdsaAllShared
operator|->
name|FCA
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|NumOfFCA
operator|<=
literal|0
condition|)
comment|/* does SMP HARD RESET only upto one time */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY; sending HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|->
name|NumOfFCA
operator|++
expr_stmt|;
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|tdsaDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|tdsaDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* given up after one time of SMP HARD RESET; */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY; NO!!! sending HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|==
literal|0
condition|)
block|{
comment|/*           1. remove this device           2. device removal event         */
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|tdsaDeviceData
argument_list|)
expr_stmt|;
name|tdsaDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|tdsaDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|tdsaDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
comment|//      pSatDevData->NumOfFCA = 0;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceRemoval
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
comment|/*        free abort IO request itself - agParam; done in ossaSATAEvent()     */
block|}
comment|/* just for debugging */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: agIOStatus is OSSA_IO_DS_NON_OPERATIONAL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATACompleted: agIOStatus is OSSA_IO_DS_IN_RECOVERY\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|satCompleteCB
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ext
label|:
name|TDSA_OUT_LEAVE
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satPacketCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with normal Packet command I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satPacketCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|interruptContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|bit8
name|bSenseKey
init|=
literal|0
decl_stmt|;
name|bit16
name|bSenseCodeInfo
init|=
literal|0
decl_stmt|;
name|bit32
name|status
init|=
literal|0
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satPacketCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|/*ttttttthe one */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satPacketCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satPacketCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satPacketCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satPacketCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
comment|/* Parse CDB */
switch|switch
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
condition|)
block|{
case|case
name|SCSIOPC_TEST_UNIT_READY
case|:
comment|//satTestUnitReadyCB(agRoot, agIORequest, agIOStatus, agFirstDword, agIOInfoLen, agParam, ioContext);
comment|//break;
case|case
name|SCSIOPC_GET_EVENT_STATUS_NOTIFICATION
case|:
comment|//break;
case|case
name|SCSIOPC_READ_CAPACITY_10
case|:
case|case
name|SCSIOPC_READ_CAPACITY_16
case|:
comment|//satPacketReadCapacityCB(agRoot, agIORequest, agIOStatus, agFirstDword, agIOInfoLen, agParam, ioContext);
comment|//break;
default|default:
break|break;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* interal structure free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agFirstDword
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satPacketCB: agIOStatus == OSSA_IO_SUCCESS, agFirstDword == agNULL \n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agFirstDword
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satPacketCB: wrong. agIOStatus == OSSA_IO_SUCCESS&& agFirstDword != agNULL \n"
operator|)
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|32
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
comment|/* just translate the ATAPI error register to sense information */
name|satTranslateATAPIErrorsToSCSIErrors
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satPacketCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends request sense to ATAPI device for acquiring sense information */
name|status
operator|=
name|satRequestSenseForATAPI
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* just translate the ATAPI error register to sense information */
name|satTranslateATAPIErrorsToSCSIErrors
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satPacketCB: failed to call satRequestSenseForATAPI()\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satPacketCB: wrong. agIOStatus != OSSA_IO_SUCCESS, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|itdsatProcessAbnormalCompletion
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satPacketCB: Unknown error \n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satRequestSenseForATAPICB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satRequestSenseForATAPICB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|bit32
name|interruptContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satPacketCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|/*ttttttthe one */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satPacketCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satPacketCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satPacketCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satPacketCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* copy the request sense buffer to original IO buffer*/
if|if
condition|(
name|satIntIo
operator|!=
name|agNULL
condition|)
block|{
name|osti_memcpy
argument_list|(
name|satOrgIOContext
operator|->
name|pTiSenseData
operator|->
name|senseData
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|virtPtr
argument_list|,
name|SENSE_DATA_LENGTH
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|->
name|pTiSenseData
operator|->
name|senseLen
operator|=
name|SENSE_DATA_LENGTH
expr_stmt|;
comment|/* interal structure free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* notify the OS to complete this SRB */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satSetFeaturesPIOCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satSetFeaturesPIOCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetFeaturesPIOCB start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|/*ttttttthe one */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSetFeaturesPIOCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSetFeaturesPIOCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSetFeaturesPIOCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSetFeaturesPIOCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* interal structure free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*if the ATAPI device support DMA, then enble this feature*/
if|if
condition|(
name|satDevData
operator|->
name|satDMASupport
operator|&&
name|satDevData
operator|->
name|satDMAEnabled
condition|)
block|{
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSetFeaturesPIOCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends either ATA SET FEATURES based on DMA bit */
name|status
operator|=
name|satSetFeatures
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSetFeaturesPIOCB: failed to call satSetFeatures()\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satSetFeaturesCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satSetFeaturesCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
init|=
name|agNULL
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tiPortalContext_t
modifier|*
name|tiPortalContext
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit8
name|PhyID
init|=
literal|0
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetFeaturesCB start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|->
name|tdData
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|tdPortContext
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSetFeaturesCB: onePortContext is  NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tiPortalContext
operator|=
name|onePortContext
operator|->
name|tiPortalContext
expr_stmt|;
name|PhyID
operator|=
name|oneDeviceData
operator|->
name|phyID
expr_stmt|;
comment|/*ttttttthe one */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSetFeaturesCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSetFeaturesCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSetFeaturesCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSetFeaturesCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* interal structure free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|tdOrgIORequestBody
operator|!=
name|agNULL
condition|)
block|{
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|!=
name|agNULL
condition|)
block|{
comment|/* this condition is for tdsaDiscoveryStartIDDevCB routine*/
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|ITD_DSTATE_COMPLETED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSetFeaturesCB: ID completed after discovery is done; tiDeviceArrival\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* in case registration is finished after discovery is finished */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return;
block|}
name|TI_DBG2
argument_list|(
operator|(
literal|"satSetFeaturesCB: pid %d\n"
operator|,
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|portContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* the below codes is for satAddSATAIDDevCB routine*/
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|PhyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSetFeaturesCB: onePortContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satDeviceResetCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satDeviceResetCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/* callback for satResetDevice */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
init|=
name|agNULL
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
comment|//   satIOContext_t          *satNewIOContext;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//   satInternalIo_t         *satNewIntIo = agNULL;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
comment|//   bit32                     status;
name|bit32
name|report
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|AbortTM
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeviceResetCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeviceResetCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeviceResetCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeviceResetCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeviceResetCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeviceResetCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeviceResetCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeviceResetCB: OSSA_IO_OPEN_CNX_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisPioSetup_t is expected */
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeviceResetCB: ataStatus 0x%x ataError 0x%x\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMFailed
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
if|if
condition|(
name|satOrgIOContext
operator|->
name|TMF
operator|==
name|AG_ABORT_TASK
condition|)
block|{
name|AbortTM
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|satOrgIOContext
operator|->
name|NotifyOS
operator|==
name|agTRUE
condition|)
block|{
name|report
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|AbortTM
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeResetDeviceCB: calling satAbort\n"
operator|)
argument_list|)
expr_stmt|;
name|satAbort
argument_list|(
name|agRoot
argument_list|,
name|satOrgIOContext
operator|->
name|satToBeAbortedIOContext
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeviceResetCB: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|satDevData
operator|->
name|satPendingIO
operator|,
name|satDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeviceResetCB: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|satDevData
operator|->
name|satPendingNCQIO
operator|,
name|satDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|tdOrgIORequestBody
operator|!=
name|agNULL
condition|)
block|{
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satDeviceResetCB: tdOrgIORequestBody is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|report
condition|)
block|{
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMOK
argument_list|,
name|tiOrgIORequest
argument_list|)
expr_stmt|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satDeviceResetCB: device %p pending IO %d\n"
operator|,
name|satDevData
operator|,
name|satDevData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satDeviceResetCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satExecuteDeviceDiagnosticCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satExecuteDeviceDiagnosticCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satExecuteDeviceDiagnosticCB start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|/*ttttttthe one */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satExecuteDeviceDiagnosticCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satExecuteDeviceDiagnosticCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satExecuteDeviceDiagnosticCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satExecuteDeviceDiagnosticCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* interal structure free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satNonChainedDataIOCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satNonChainedDataIOCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|bit32
name|interruptContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|SatIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|SatDevData
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satNonChainedDataIOCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|SatIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|SatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* interal structure free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|SatDevData
argument_list|,
name|SatIntIo
argument_list|)
expr_stmt|;
comment|/* Process completion */
if|if
condition|(
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|)
operator|&&
operator|(
name|agIOInfoLen
operator|==
literal|0
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedDataIOCB: success\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedDataIOCB: success agIORequest %p\n"
operator|,
name|agIORequest
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Command was completed OK, this is the normal path.      * Now call the OS-App Specific layer about this completion.      */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedDataIOCB: calling itdsatProcessAbnormalCompletion\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* More checking needed */
name|itdsatProcessAbnormalCompletion
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satChainedDataIOCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with normal chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satChainedDataIOCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|bit32
name|dataLength
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satChainedDataIOCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedDataIOCB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedDataIOCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedDataIOCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedDataIOCB: satOrgIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedDataIOCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedDataIOCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* agsaFisPioSetup_t or agsaFisRegDeviceToHost_t or agsaFisSetDevBits_t for read        agsaFisRegDeviceToHost_t or agsaFisSetDevBits_t for write        first, assumed to be Reg Device to Host FIS        This is OK to just find fis type     */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
comment|/* for debugging */
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedDataIOCB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* for debugging */
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedDataIOCB: FAILED, error status and command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* the function below handles abort case */
name|itdsatDelayedProcessAbnormalCompletion
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of error */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_DMA
case|:
comment|/* fall through */
case|case
name|SAT_READ_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_DMA_EXT
case|:
comment|/* fall through */
case|case
name|SAT_READ_SECTORS_EXT
case|:
comment|/* fall through */
case|case
name|SAT_READ_FPDMA_QUEUED
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_DMA
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_DMA_FUA_EXT
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_DMA_EXT
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedDataIOCB: READ/WRITE success case\n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internally genereated SAT_SMART_RETURN_STATUS */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* let's loop till TL */
comment|/* lba = lba + tl        loopnum--;        if (loopnum == 0) done      */
operator|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|)
operator|--
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|0
condition|)
block|{
comment|/* done with read */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
else|else
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|dataLength
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedDataIOCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sending another ATA command */
switch|switch
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
condition|)
block|{
case|case
name|SCSIOPC_READ_6
case|:
comment|/* no loop should occur with READ6 since it fits in one ATA command */
break|break;
case|case
name|SCSIOPC_READ_10
case|:
comment|/* fall through */
case|case
name|SCSIOPC_READ_12
case|:
comment|/* fall through */
case|case
name|SCSIOPC_READ_16
case|:
comment|/* fall through */
name|status
operator|=
name|satRead_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_6
case|:
comment|/* no loop should occur with WRITE6 since it fits in one ATA command */
break|break;
case|case
name|SCSIOPC_WRITE_10
case|:
comment|/* fall through */
case|case
name|SCSIOPC_WRITE_12
case|:
comment|/* fall through */
case|case
name|SCSIOPC_WRITE_16
case|:
comment|/* fall through */
name|status
operator|=
name|satWrite_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedDataIOCB: success but default case scsi cmd 0x%x ata cmd 0x%x\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiError
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedDataIOCB: calling satRead10_1 fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedDataIOCB: success but default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|satNonChainedWriteNVerifyCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|agsaFisSetDevBitsHeader_t
modifier|*
name|statSetDevBitFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* SPC: Self-Test Result Log page */
name|tiScsiRequest
operator|=
name|satIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/*       FIS type should be either REG_DEV_TO_HOST_FIS or SET_DEV_BITS_FIS     */
comment|/* First, assumed to be Reg Device to Host FIS */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|==
name|SET_DEV_BITS_FIS
condition|)
block|{
name|statSetDevBitFisHeader
operator|=
operator|(
name|agsaFisSetDevBitsHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
comment|/* Get ATA Status register */
name|ataStatus
operator|=
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x70
operator|)
expr_stmt|;
comment|/* bits 4,5,6 */
name|ataStatus
operator|=
name|ataStatus
operator||
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x07
operator|)
expr_stmt|;
comment|/* bits 0,1,2 */
comment|/* ATA Eror register   */
block|}
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/*     checking IO status, FIS type and error status     FIS type should be either REG_DEV_TO_HOST_FIS or SET_DEV_BITS_FIS     Both have fisType in the same location   */
if|if
condition|(
operator|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
operator|)
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: FAILED, NOT IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_WRITE_DMA_FUA_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_WRITE_DMA_FUA_EXT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_WRITE_DMA_EXT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_WRITE_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_WRITE_FPDMA_QUEUED\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end error checking */
block|}
comment|/* process success from this point on */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_WRITE_DMA_FUA_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_WRITE_DMA_FUA_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_WRITE_DMA_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_WRITE_SECTORS_EXT succes\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_WRITE_FPDMA_QUEUED succes\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_READ_VERIFY_SECTORS succes\n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* return stat_good */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: SAT_READ_VERIFY_SECTORS_EXT succes\n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* return stat_good */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB:  error default case command 0x%x success\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
break|break;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends ATA verify command(READ_VERIFY_SECTORS or READ_VERIFY_SECTORS_EXT) */
name|status
operator|=
name|satNonChainedWriteNVerify_Verify
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* sending ATA command fails */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedWriteNVerifyCB: calling satWriteAndVerify10_1 fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end send fails */
return|return;
block|}
end_function

begin_function
name|void
name|satChainedWriteNVerifyCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     send write in loop     then, send verify in loop   */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|dataLength
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* agsaFisPioSetup_t or agsaFisRegDeviceToHost_t or agsaFisSetDevBits_t for read        agsaFisRegDeviceToHost_t or agsaFisSetDevBits_t for write        first, assumed to be Reg Device to Host FIS        This is OK to just find fis type     */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
comment|/* for debugging */
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* for debugging */
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: FAILED, error status and command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* the function below handles abort case */
name|itdsatDelayedProcessAbnormalCompletion
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of error */
comment|/* process the success case */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_WRITE_DMA
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_SECTORS
case|:
comment|/* fall through */
comment|//  case SAT_WRITE_DMA_FUA_EXT: /* fall through */
case|case
name|SAT_WRITE_DMA_EXT
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: WRITE success case\n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internally genereated SAT_SMART_RETURN_STATUS */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* let's loop till TL */
operator|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|)
operator|--
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
else|else
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|dataLength
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|0
condition|)
block|{
comment|/*         done with write         start with verify       */
name|satOrgIOContext
operator|->
name|LoopNum
operator|=
name|satOrgIOContext
operator|->
name|LoopNum2
expr_stmt|;
name|status
operator|=
name|satChainedWriteNVerify_Start_Verify
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|satChainedWriteNVerify_Write
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: calling satChainedWriteNVerify_Write fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internally genereated SAT_SMART_RETURN_STATUS */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* let's loop till TL */
comment|/* lba = lba + tl        loopnum--;        if (loopnum == 0) done      */
operator|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|)
operator|--
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|0
condition|)
block|{
comment|/*         done with write and verify       */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
else|else
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|dataLength
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|status
operator|=
name|satChainedWriteNVerify_Verify
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: calling satChainedWriteNVerify_Verify fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerifyCB: success but default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  itdsatProcessAbnormalCompletion * *   This routine is called to complete error case for SATA request previously *   issued to the LL Layer in saSATAStart() * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|itdsatProcessAbnormalCompletion
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|interruptContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIORequest=%p agIOStatus=0x%x agIOInfoLen=%d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|tiDeviceHandle
operator|=
name|satIOContext
operator|->
name|ptiDeviceHandle
expr_stmt|;
comment|/* Get into the detail */
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_SUCCESS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_SUCCESS agIOInfoLen %d calling osSatIOCompleted\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/*      * At this point agIOInfoLen should be non-zero and there is valid FIS      * to read. Pass this info to the SAT layer in order to do the ATA status      * to SCSI status translation.      */
name|osSatIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORTED
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_ABORTED\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailAborted
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: TM callback\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* TM completed */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* portalContext not used */
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMOK
argument_list|,
name|pSatDevData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
comment|/*        * Reset flag        */
name|pSatDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
block|}
comment|/*      * Check if we are in recovery mode and need to update the recovery flag      */
if|if
condition|(
operator|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satPendingIO
operator|==
literal|0
operator|)
condition|)
block|{
name|pSatDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: STATE NORMAL.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: satDriveState %d\n"
operator|,
name|pSatDevData
operator|->
name|satDriveState
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_UNDERFLOW
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_UNDERFLOW\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|agIOInfoLen
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_FAILED
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_FAILED\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORT_RESET
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_ABORT_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailAbortReset
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
comment|/*      * Check if we are in recovery mode and need to update the recovery flag      */
if|if
condition|(
operator|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satPendingIO
operator|==
literal|0
operator|)
condition|)
block|{
name|pSatDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: STATE NORMAL.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: satDriveState %d\n"
operator|,
name|pSatDevData
operator|->
name|satDriveState
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_NO_DEVICE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_PROG_ERROR
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_PROG_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
case|:
comment|/* fall through */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_OPEN_CNX_ERROR_* 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: wrong, oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
comment|//tiDetailNoDeviceError, //tiDetailAborted,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_BREAK
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_PEER_ABORTED
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_DMA
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_SATA_LINK_TIMEOUT
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_ABORTED_DUE_TO_SRST
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_REJECTED_NCQ_MODE
case|:
comment|/* fall throuth */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_XFER_ERROR_* 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_IN_ERROR
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_DS_IN_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: wrong, oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_NON_OPERATIONAL
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_DS_NON_OPERATIONAL\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: wrong, oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = ENCRYPTION ERROR 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|itdsatEncryptionHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = DIF ERROR 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|itdsatDifHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: agIOStatus = unknown 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatProcessAbnormalCompletion: oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* switch */
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  itdsatDelayedProcessAbnormalCompletion * *   This routine is called to complete error case for SATA request previously *   issued to the LL Layer in saSATAStart(). *   This is used when command is chained. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|itdsatDelayedProcessAbnormalCompletion
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|interruptContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIORequest=%p agIOStatus=0x%x agIOInfoLen=%d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|tiDeviceHandle
operator|=
name|satIOContext
operator|->
name|ptiDeviceHandle
expr_stmt|;
comment|/* Get into the detail */
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_SUCCESS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_SUCCESS calling osSatIOCompleted\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* do nothing */
break|break;
case|case
name|OSSA_IO_ABORTED
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_ABORTED\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailAborted
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: TM callback\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* TM completed */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
comment|/* portalContext not used */
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeTaskManagement
argument_list|,
name|tiTMOK
argument_list|,
name|pSatDevData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
comment|/*        * Reset flag        */
name|pSatDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
block|}
comment|/*      * Check if we are in recovery mode and need to update the recovery flag      */
if|if
condition|(
operator|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satPendingIO
operator|==
literal|0
operator|)
condition|)
block|{
name|pSatDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: STATE NORMAL.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: satDriveState %d\n"
operator|,
name|pSatDevData
operator|->
name|satDriveState
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_UNDERFLOW
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_UNDERFLOW\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|agIOInfoLen
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_FAILED
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_FAILED\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORT_RESET
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_ABORT_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailAbortReset
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
comment|/*      * Check if we are in recovery mode and need to update the recovery flag      */
if|if
condition|(
operator|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satPendingIO
operator|==
literal|0
operator|)
condition|)
block|{
name|pSatDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: STATE NORMAL.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: satDriveState %d\n"
operator|,
name|pSatDevData
operator|->
name|satDriveState
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_NO_DEVICE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_PROG_ERROR
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_PROG_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
case|:
comment|/* fall through */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_OPEN_CNX_ERROR_* 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: wrong, oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
comment|//tiDetailNoDeviceError, //tiDetailAborted,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_BREAK
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_PEER_ABORTED
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_DMA
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_SATA_LINK_TIMEOUT
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_ABORTED_DUE_TO_SRST
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_REJECTED_NCQ_MODE
case|:
comment|/* fall throuth */
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_XFER_ERROR_* 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_IN_ERROR
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_DS_IN_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: wrong, oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_NON_OPERATIONAL
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_DS_NON_OPERATIONAL\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: wrong, tiDeviceHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: wrong, oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|tdPortContext
operator|!=
name|agNULL
condition|)
block|{
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = ENCRYPTION ERROR 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|itdsatEncryptionHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = DIF ERROR 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|itdsatDifHandler
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDelayedProcessAbnormalCompletion: agIOStatus = unknown\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* switch */
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdsatEncryptionHandler * *  Purpose:  This function processes I/Os completed and returned by SATA lower *            layer with any encryption specific agIOStatus. * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdsatEncryptionHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|bit32
name|errorDetail
init|=
name|tiDetailOtherError
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatEncryptionHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatEncryptionHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailDekKeyCacheMiss
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_CIPHER_MODE_INVALID
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatEncryptionHandler: OSSA_IO_XFR_ERROR_CIPHER_MODE_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailCipherModeInvalid
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_IV_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_IV_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailDekIVMismatch
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_RAM_INTERFACE_ERROR
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_RAM_INTERFACE_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailDekRamInterfaceError
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatEncryptionHandler: other error!!! 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailOtherError
expr_stmt|;
break|break;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOEncryptError
argument_list|,
name|errorDetail
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief itdsatDifHandler * *  Purpose:  This function processes I/Os completed and returned by SATA lower *            layer with any DIF specific agIOStatus. * *  \param  agRoot:            pointer to port instance *  \param  agIORequest:       pointer to I/O request *  \param  agIOStatus:        I/O status given by LL layer *  \param  agIOInfoLen:       lenth of complete SAS RESP frame *  \param  agParam            A Handle used to refer to the response frame or handle *                             of abort request *  \return: None * * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdsatDifHandler
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|bit32
name|intContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|bit32
name|errorDetail
init|=
name|tiDetailOtherError
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaDifDetails_t
modifier|*
name|DifDetail
decl_stmt|;
endif|#
directive|endif
name|TI_DBG2
argument_list|(
operator|(
literal|"itdsatDifHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"itdsatDifHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|DifDetail
operator|=
operator|(
name|agsaDifDetails_t
operator|*
operator|)
name|agParam
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDifHandler: OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailDifAppTagMismatch
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDifHandler: OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailDifRefTagMismatch
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDifHandler: OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailDifCrcMismatch
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatDifHandler: other error!!! 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|tiDetailOtherError
expr_stmt|;
break|break;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"smsatDifHandler: DIF detail UpperLBA 0x%08x LowerLBA 0x%08x\n"
operator|,
name|DifDetail
operator|->
name|UpperLBA
operator|,
name|DifDetail
operator|->
name|LowerLBA
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIODifError
argument_list|,
name|errorDetail
argument_list|,
name|agNULL
argument_list|,
name|intContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satProcessAbort  *  *  This function processes abort.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return  *           None  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|void
name|satProcessAbort
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
comment|//tiDeviceHandle_t          *tiDeviceHandle;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satProcessAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|//tiDeviceHandle  = satIOContext->ptiDeviceHandle;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
operator|)
operator|&&
operator|(
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x01
operator|&&
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x02
operator|)
condition|)
block|{
comment|/* no completion for send diagnotic in background. It is done in satSendDiagnostic() */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailAborted
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satProcessAbort: TM callback\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Reset flag      */
name|pSatDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
block|}
comment|/*    * Check if we are in recovery mode and need to update the recovery flag    */
if|if
condition|(
operator|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satPendingIO
operator|==
literal|0
operator|)
condition|)
block|{
name|pSatDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satProcessAbort: STATE NORMAL.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"satProcessAbort: satDriveState %d\n"
operator|,
name|pSatDevData
operator|->
name|satDriveState
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satProcessAbort: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satProcessAbort: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satNonDataIOCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with non-data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satNonDataIOCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|bit32
name|interruptContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonDataIOCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* Process completion */
if|if
condition|(
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|)
operator|&&
operator|(
name|agIOInfoLen
operator|==
literal|0
operator|)
condition|)
block|{
comment|/*      * !!! We expect that agIOInfoLen should be non-zero !!!!.      * Now call the OS-App Specific layer about this unexpected completion.      */
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonDataIOCB: *** ERROR***  agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* More checking needed, for non-data IO this should be the normal case */
name|itdsatProcessAbnormalCompletion
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  tdssSATADeviceTypeDecode * *   This routine decodes ATA signature * *  \param   pSignature:       ATA signature * * *  \return: *          TRUE if ATA signature *          FALSE otherwise * *****************************************************************************/
end_comment

begin_comment
comment|/*   ATA p65   PM p65   SATAII p79, p80  */
end_comment

begin_function
name|GLOBAL
name|bit32
name|tdssSATADeviceTypeDecode
parameter_list|(
name|bit8
modifier|*
name|pSignature
parameter_list|)
block|{
name|bit32
name|deviceType
init|=
name|UNKNOWN_DEVICE
decl_stmt|;
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0x00
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0x00
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0xA0
condition|)
comment|/* this is the signature of a Hitachi SATA HDD*/
block|{
name|deviceType
operator|=
name|SATA_ATA_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0x00
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0x00
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0x00
condition|)
block|{
name|deviceType
operator|=
name|SATA_ATA_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0x14
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0xEB
operator|&&
operator|(
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0x00
operator|||
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0x10
operator|)
condition|)
block|{
name|deviceType
operator|=
name|SATA_ATAPI_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0x69
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0x96
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0x00
condition|)
block|{
name|deviceType
operator|=
name|SATA_PM_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0x3C
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0xC3
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0x00
condition|)
block|{
name|deviceType
operator|=
name|SATA_SEMB_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0xFF
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0xFF
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0xFF
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0xFF
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0xFF
condition|)
block|{
name|deviceType
operator|=
name|SATA_SEMB_WO_SEP_DEVICE
expr_stmt|;
block|}
return|return
name|deviceType
return|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief ossaDiscoverSataCB * *  Purpose:  This function is called by lower layer to inform TD layer of *            STP/SATA discovery results * * *  \param   agRoot         Pointer to chip/driver Instance. *  \param   agPortContext  Pointer to the port context of TD and Lower layer *  \param   event          event type *  \param   pParm1         Pointer to data associated with event *  \param   pParm2         Pointer to data associated with event * *  \return: none * *  \note -  For details, refer to SAS/SATA Low-Level API Specification * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaDiscoverSataCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|bit32
name|event
parameter_list|,
name|void
modifier|*
name|pParm1
parameter_list|,
name|void
modifier|*
name|pParm2
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|agsaSATADeviceInfo_t
modifier|*
name|agSATADeviceInfo
decl_stmt|;
name|tiPortalContext_t
modifier|*
name|tiPortalContext
decl_stmt|;
name|bit32
name|devicetype
init|=
name|UNKNOWN_DEVICE
decl_stmt|;
name|osData
operator|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
expr_stmt|;
name|tiRoot
operator|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: NULL agsaPortContext; wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|onePortContext
operator|=
operator|(
name|tdsaPortContext_t
operator|*
operator|)
name|agPortContext
operator|->
name|osData
expr_stmt|;
name|tiPortalContext
operator|=
operator|(
name|tiPortalContext_t
operator|*
operator|)
name|onePortContext
operator|->
name|tiPortalContext
expr_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|OSSA_DISCOVER_STARTED
case|:
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: STARTED\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Do nothing */
break|break;
block|}
case|case
name|OSSA_DISCOVER_FOUND_DEVICE
case|:
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: ***** FOUND DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
operator|(
name|agsaDevHandle_t
operator|*
operator|)
name|pParm1
expr_stmt|;
name|agSATADeviceInfo
operator|=
operator|(
name|agsaSATADeviceInfo_t
operator|*
operator|)
name|pParm2
expr_stmt|;
comment|/* parse the device type */
name|devicetype
operator|=
name|tdssSATADeviceTypeDecode
argument_list|(
name|agSATADeviceInfo
operator|->
name|signature
argument_list|)
expr_stmt|;
comment|/* for now, TD handles only ATA Device or ATAPI Device */
if|if
condition|(
name|devicetype
operator|==
name|SATA_ATA_DEVICE
operator|||
name|devicetype
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: ***** adding ....\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Add SATA device */
name|tdssAddSATAToSharedcontext
argument_list|(
name|onePortContext
argument_list|,
name|agRoot
argument_list|,
name|agDevHandle
argument_list|,
name|agSATADeviceInfo
argument_list|,
name|agTRUE
argument_list|,
name|agSATADeviceInfo
operator|->
name|stpPhyIdentifier
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceArrival
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/* end of ATA_ATA_DEVICE or ATA_ATAPI_DEVICE */
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: ***** not adding ..... devicetype 0x%x\n"
operator|,
name|devicetype
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|OSSA_DISCOVER_REMOVED_DEVICE
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: REMOVED_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
operator|(
name|agsaDevHandle_t
operator|*
operator|)
name|pParm1
expr_stmt|;
name|agSATADeviceInfo
operator|=
operator|(
name|agsaSATADeviceInfo_t
operator|*
operator|)
name|pParm2
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: signature: 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x\n"
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|0
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|1
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|2
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|3
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|4
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|5
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|6
index|]
operator|,
name|agSATADeviceInfo
operator|->
name|signature
index|[
literal|7
index|]
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: Wrong. DevHandle->osData is NULL but is being removed\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdssRemoveSATAFromSharedcontext
argument_list|(
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|agRoot
argument_list|)
expr_stmt|;
name|agDevHandle
operator|->
name|osData
operator|=
name|agNULL
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceRemoval
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
name|OSSA_DISCOVER_COMPLETE
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: COMPLETE\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|ITD_DSTATE_COMPLETED
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: COMPLETE pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* Let OS-Apps specific layer know discovery has been successfully complete */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_DISCOVER_ABORT
case|:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: OSSA_DISCOVER_ABORT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Let OS-Apps specific layer know discovery has failed */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaDiscoverSataCB: error default event 0x%x\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
comment|/* Let OS-Apps specific layer know discovery has failed */
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDiscovery
argument_list|,
name|tiDiscFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* end of switch */
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdssAddSataToSharedcontext * *  Purpose:  This function adds a discovered SATA device to a device list of *            a port context * *  \param   tsddPortContext_Instance Pointer to the target port context *  \param   agRoot                   Pointer to the root data structure of *                                    TD and Lower layer *  \param   agDevHandle              Pointer to a device handle *  \param   agSATADeviceInfo         Pointer to SATA device info structure *  \param   registered               indication flag for registration to LL * *  \Return: none * *****************************************************************************/
end_comment

begin_comment
comment|/* split into devicedata allocation/registration and sending identify device data */
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssAddSATAToSharedcontext
parameter_list|(
name|tdsaPortContext_t
modifier|*
name|tdsaPortContext_Instance
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|agsaSATADeviceInfo_t
modifier|*
name|agSATADeviceInfo
parameter_list|,
name|bit32
name|registered
parameter_list|,
name|bit8
name|phyID
parameter_list|)
block|{
name|tdsaPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|PortContextList
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tdList_t
modifier|*
name|DeviceListList
init|=
name|agNULL
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|bit32
name|Indenom
init|=
name|tdsaAllShared
operator|->
name|QueueConfig
operator|.
name|numInboundQueues
decl_stmt|;
name|bit32
name|Outdenom
init|=
name|tdsaAllShared
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
decl_stmt|;
name|bit8
name|dev_s_rate
init|=
literal|0
decl_stmt|;
name|bit8
name|sasorsata
init|=
literal|1
decl_stmt|;
name|bit8
name|connectionRate
decl_stmt|;
name|bit8
name|flag
init|=
literal|0
decl_stmt|;
name|bit8
name|TLR
init|=
literal|0
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssAddSataToSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Find a right portcontext, then get devicedata from FreeLink in DeviceList.    * Then, add the devicedata to the portcontext.    */
comment|/* Find a right portcontext */
name|PortContextList
operator|=
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|PortContextList
operator|!=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainPortContextList
operator|)
condition|)
block|{
name|onePortContext
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaPortContext_t
argument_list|,
name|MainLink
argument_list|,
name|PortContextList
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|tdsaPortContext_Instance
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssAddSataToSharedcontext: found; oneportContext ID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|PortContextList
operator|=
name|PortContextList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSataToSharedcontext: No corressponding tdsaPortContext\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*    1. add the devicedata    2. Send Identify Device Data    3. In CB of Identify Device Data (satAddSATAIDDevCB), finds out the devicedata is new or old   */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TDLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSataToSharedcontext: ERROR empty DeviceData FreeLink\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|TDLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|DeviceListList
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|TDLIST_OBJECT_BASE
argument_list|(
name|tdsaDeviceData_t
argument_list|,
name|FreeLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssAddSataToSharedcontext: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|InQID
operator|=
name|oneDeviceData
operator|->
name|id
operator|%
name|Indenom
expr_stmt|;
name|oneDeviceData
operator|->
name|OutQID
operator|=
name|oneDeviceData
operator|->
name|id
operator|%
name|Outdenom
expr_stmt|;
name|pSatDevData
operator|=
operator|(
name|satDeviceData_t
operator|*
operator|)
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
name|pSatDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|pSatDevData
operator|->
name|satPendingIO
operator|=
literal|0
expr_stmt|;
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|=
literal|0
expr_stmt|;
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|=
literal|0
expr_stmt|;
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|=
literal|0
expr_stmt|;
name|pSatDevData
operator|->
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
name|pSatDevData
operator|->
name|satDeviceType
operator|=
name|tdssSATADeviceTypeDecode
argument_list|(
name|onePortContext
operator|->
name|remoteSignature
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|.
name|satIdentifyData
operator|)
argument_list|,
literal|0xFF
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|Count
operator|++
expr_stmt|;
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|TD_SATA_DEVICE
expr_stmt|;
comment|// either TD_SAS_DEVICE or TD_SATA_DEVICE
name|oneDeviceData
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
comment|//  oneDeviceData->agDevHandle = agDevHandle;
comment|//  agDevHandle->osData = oneDeviceData; /* TD layer */
name|oneDeviceData
operator|->
name|tdPortContext
operator|=
name|onePortContext
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|directlyAttached
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|=
literal|0
expr_stmt|;
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|=
literal|0x1
expr_stmt|;
comment|/* setting SATA device bit */
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
comment|/* parse sasIDframe to fill in agDeviceInfo */
name|flag
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|phyID
operator|<<
literal|4
operator|)
operator||
name|TLR
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SMPTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|DEFAULT_SMP_TIMEOUT
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_ITNEXUSTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|tdsaAllShared
operator|->
name|itNexusTimeout
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FBS
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|//temp
comment|//DEVINFO_PUT_FLAG(&oneDeviceData->agDeviceInfo, 0);
name|DEVINFO_PUT_FLAG
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|sasorsata
operator|=
name|SATA_DEVICE_TYPE
expr_stmt|;
comment|/* SATA disk */
name|connectionRate
operator|=
name|onePortContext
operator|->
name|LinkRate
expr_stmt|;
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
operator|(
name|sasorsata
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dev_s_rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|dev_s_rate
operator||
name|connectionRate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_DEV_S_RATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|dev_s_rate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||=
name|ATAPI_DEVICE_FLAG
expr_stmt|;
comment|/* ATAPI device flag*/
block|}
name|oneDeviceData
operator|->
name|agContext
operator|.
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agFALSE
condition|)
block|{
name|saRegisterNewDevice
argument_list|(
comment|/* tdssAddSATAToSharedcontext  */
name|agRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|agContext
argument_list|,
literal|0
argument_list|,
comment|/*tdsaRotateQnumber(tiRoot, oneDeviceData),*/
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|onePortContext
operator|->
name|agPortContext
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdssRetrySATAID * *  Purpose:  This function retries identify device data to directly attached SATA *            device after device registration * *  \param   tiRoot:           Pointer to TISA initiator driver/port instance. *  \param   oneDeviceData     Pointer to a device data *  \Return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssRetrySATAID
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
comment|/* identify device data itself */
name|satIOContext_t
modifier|*
name|satIOContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"tdssRetrySATAID: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate identify device data and sends it */
comment|/* allocation tdIORequestBody and pass it to satTM() */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRetrySATAID: ostiAllocMemory failed... loc 2\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
if|if
condition|(
name|tdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRetrySATAID: ostiAllocMemory returned NULL tdIORequestBody loc 2\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
comment|/* setup identify device data IO structure */
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|CurrentTaskTag
operator|=
name|agNULL
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|TaskTag
operator|=
name|agNULL
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
comment|/* initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|agNULL
expr_stmt|;
comment|/* initialize agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SA takes care of this */
comment|/* set up satIOContext */
name|satIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|tiRequestBody
operator|=
name|tdIORequestBody
expr_stmt|;
name|satIOContext
operator|->
name|ptiDeviceHandle
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|tiScsiXchg
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satIntIoContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
comment|/* followings are used only for internal IO */
name|satIOContext
operator|->
name|currentLBA
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|satToBeAbortedIOContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|NotifyOS
operator|=
name|agFALSE
expr_stmt|;
name|satIOContext
operator|->
name|pid
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|portContext
operator|->
name|id
expr_stmt|;
name|status
operator|=
name|satAddSATAStartIDDev
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* assumption; always new device data */
if|if
condition|(
name|status
operator|==
name|tiSuccess
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdssRetrySATAID: successfully sent identify device data\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdssRetrySATAID: one case did %d \n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRetrySATAID: failed in sending identify device data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* put onedevicedata back to free list */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdssSubAddSATAToSharedcontext * *  Purpose:  This function sends identify device data to directly attached SATA *            device after device registration * *  \param   tiRoot:           Pointer to TISA initiator driver/port instance. *  \param   oneDeviceData     Pointer to a device data *  \Return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssSubAddSATAToSharedcontext
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
comment|/* identify device data itself */
name|satIOContext_t
modifier|*
name|satIOContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssSubAddSATAToSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate identify device data and sends it */
comment|/* allocation tdIORequestBody and pass it to satTM() */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssSubAddSATAToSharedcontext: ostiAllocMemory failed... loc 2\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
if|if
condition|(
name|tdIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssSubAddSATAToSharedcontext: ostiAllocMemory returned NULL tdIORequestBody loc 2\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
comment|/* setup identify device data IO structure */
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|CurrentTaskTag
operator|=
name|agNULL
expr_stmt|;
name|tdIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|TaskTag
operator|=
name|agNULL
expr_stmt|;
comment|/* initialize tiDevhandle */
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|tiDevHandle
operator|->
name|tdData
operator|=
name|oneDeviceData
expr_stmt|;
comment|/* initialize tiIORequest */
name|tdIORequestBody
operator|->
name|tiIORequest
operator|=
name|agNULL
expr_stmt|;
comment|/* initialize agIORequest */
name|agIORequest
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdIORequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SA takes care of this */
comment|/* set up satIOContext */
name|satIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|satDevData
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|tiRequestBody
operator|=
name|tdIORequestBody
expr_stmt|;
name|satIOContext
operator|->
name|ptiDeviceHandle
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|tiScsiXchg
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satIntIoContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
comment|/* followings are used only for internal IO */
name|satIOContext
operator|->
name|currentLBA
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|satToBeAbortedIOContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|NotifyOS
operator|=
name|agFALSE
expr_stmt|;
name|satIOContext
operator|->
name|pid
operator|=
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|portContext
operator|->
name|id
expr_stmt|;
name|status
operator|=
name|satAddSATAStartIDDev
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|tiDeviceHandle
operator|)
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* assumption; always new device data */
if|if
condition|(
name|status
operator|==
name|tiSuccess
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"tdssSubAddSATAToSharedcontext: successfully sent identify device data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Add the devicedata to the mainlink */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tdssSubAddSATAToSharedcontext: one case did %d \n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssSubAddSATAToSharedcontext: failed in sending identify device data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* put onedevicedata back to free list */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|TDLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|tdsaAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_DEVICE_LOCK
argument_list|)
expr_stmt|;
comment|/* notifying link up */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortLinkUp
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
comment|/* triggers discovery */
name|ostiPortEvent
argument_list|(
name|tiRoot
argument_list|,
name|tiPortDiscoveryReady
argument_list|,
name|tiSuccess
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tdsaAllShared
operator|->
name|Ports
index|[
name|oneDeviceData
operator|->
name|phyID
index|]
operator|.
name|tiPortalContext
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tdssRemoveSATAFromSharedcontext * *  Purpose:  This function removes a discovered device from a device list of *            a port context * *  \param   tsddPortContext_Ins      Pointer to the target port context *  \param   tdsaDeviceData_Ins       Pointer to the target device *  \param   agRoot                   Pointer to the root data structure of *                                    TD and Lower layer  * *  \Return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tdssRemoveSATAFromSharedcontext
parameter_list|(
name|tdsaPortContext_t
modifier|*
name|tdsaPortContext_Ins
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData_ins
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"tdssRemoveSATAFromSharedcontex: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief satSetDevInfo * *  Purpose:  Based on ATA identify device data, this functions sets fields of *            device data maintained in TD layer * *  \param   satDevData          Pointer to a device data *  \param   SATAIdData          Pointer to ATA identify device data * * *  \Return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satSetDevInfo
parameter_list|(
name|satDeviceData_t
modifier|*
name|satDevData
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|SATAIdData
parameter_list|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: start\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|satDevData
operator|->
name|satFormatState
operator|=
name|agFALSE
expr_stmt|;
name|satDevData
operator|->
name|satDeviceFaultState
operator|=
name|agFALSE
expr_stmt|;
name|satDevData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|satDevData
operator|->
name|satAbortAfterReset
operator|=
name|agFALSE
expr_stmt|;
name|satDevData
operator|->
name|satAbortCalled
operator|=
name|agFALSE
expr_stmt|;
name|satDevData
operator|->
name|satSectorDone
operator|=
literal|0
expr_stmt|;
comment|/* Qeueu depth, Word 75 */
name|satDevData
operator|->
name|satNCQMaxIO
operator|=
name|SATAIdData
operator|->
name|queueDepth
operator|+
literal|1
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: max queue depth %d\n"
operator|,
name|satDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
comment|/* Support NCQ, if Word 76 bit 8 is set */
if|if
condition|(
name|SATAIdData
operator|->
name|sataCapabilities
operator|&
literal|0x100
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: device supports NCQ\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satNCQ
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no NCQ\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satNCQ
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support 48 bit addressing, if Word 83 bit 10 and Word 86 bit 10 are set */
if|if
condition|(
operator|(
name|SATAIdData
operator|->
name|commandSetSupported1
operator|&
literal|0x400
operator|)
operator|&&
operator|(
name|SATAIdData
operator|->
name|commandSetFeatureEnabled1
operator|&
literal|0x400
operator|)
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: support 48 bit addressing\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|sat48BitSupport
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: NO 48 bit addressing\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|sat48BitSupport
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support SMART Self Test, word84 bit 1 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureSupportedExt
operator|&
literal|0x02
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: SMART self-test supported \n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satSMARTSelfTest
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no SMART self-test suppored\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satSMARTSelfTest
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support SMART feature set, word82 bit 0 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetSupported
operator|&
literal|0x01
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: SMART feature set supported \n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satSMARTFeatureSet
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no SMART feature set suppored\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satSMARTFeatureSet
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support SMART enabled, word85 bit 0 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureEnabled
operator|&
literal|0x01
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: SMART enabled \n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satSMARTEnabled
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no SMART enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satSMARTEnabled
operator|=
name|agFALSE
expr_stmt|;
block|}
name|satDevData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
comment|/* Removable Media feature set support, word82 bit 2 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetSupported
operator|&
literal|0x4
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: Removable Media supported \n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satRemovableMedia
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no Removable Media suppored\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satRemovableMedia
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Removable Media feature set enabled, word 85, bit 2 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureEnabled
operator|&
literal|0x4
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: Removable Media enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satRemovableMediaEnabled
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no Removable Media enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satRemovableMediaEnabled
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* DMA Support, word49 bit8 */
if|if
condition|(
name|SATAIdData
operator|->
name|dma_lba_iod_ios_stimer
operator|&
literal|0x100
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: DMA supported \n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satDMASupport
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no DMA suppored\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satDMASupport
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* DMA Enabled, word88 bit0-6, bit8-14*/
comment|/* 0x7F7F = 0111 1111 0111 1111*/
if|if
condition|(
name|SATAIdData
operator|->
name|ultraDMAModes
operator|&
literal|0x7F7F
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: DMA enabled \n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satDMAEnabled
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no DMA enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satDMAEnabled
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/*     setting MaxUserAddrSectors: max user addressable setctors     word60 - 61, should be 0x 0F FF FF FF   */
name|satDevData
operator|->
name|satMaxUserAddrSectors
operator|=
operator|(
name|SATAIdData
operator|->
name|numOfUserAddressableSectorsHi
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
name|SATAIdData
operator|->
name|numOfUserAddressableSectorsLo
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: MaxUserAddrSectors 0x%x decimal %d\n"
operator|,
name|satDevData
operator|->
name|satMaxUserAddrSectors
operator|,
name|satDevData
operator|->
name|satMaxUserAddrSectors
operator|)
argument_list|)
expr_stmt|;
comment|/* Support DMADIR, if Word 62 bit 8 is set */
if|if
condition|(
name|SATAIdData
operator|->
name|word62_74
index|[
literal|0
index|]
operator|&
literal|0x8000
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: DMADIR enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satDMADIRSupport
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: DMADIR disabled\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satDMADIRSupport
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* write cache enabled for caching mode page SAT Table 67 p69, word85 bit5 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureEnabled
operator|&
literal|0x20
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: write cache enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satWriteCacheEnabled
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no write cache enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satWriteCacheEnabled
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* look ahead enabled for caching mode page SAT Table 67 p69, word85 bit6 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureEnabled
operator|&
literal|0x40
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: look ahead enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satLookAheadEnabled
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no look ahead enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satLookAheadEnabled
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support WWN, if Word 87 bit 8 is set */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureDefault
operator|&
literal|0x100
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: device supports WWN\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satWWNSupport
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: no WWN\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satWWNSupport
operator|=
name|agFALSE
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satInquiryCB * *   This routine is a callback function for satInquiry() * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satInquiryCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of Inquiry     Process SAT_IDENTIFY_DEVICE   */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
comment|/* TD's tiScsiXchg */
name|tiScsiInitiatorRequest_t
modifier|*
name|tiOrgScsiRequest
decl_stmt|;
comment|/* OS's tiScsiXchg */
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit8
modifier|*
name|pInquiry
decl_stmt|;
name|bit8
name|page
init|=
literal|0xFF
decl_stmt|;
name|bit16
modifier|*
name|tmpptr
decl_stmt|,
name|tmpptr_tmp
decl_stmt|;
name|bit32
name|x
decl_stmt|;
name|bit32
name|lenReceived
decl_stmt|;
name|bit32
name|lenNeeded
init|=
literal|0
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|satDevData
operator|->
name|satSaDeviceData
expr_stmt|;
endif|#
directive|endif
name|tiScsiRequest
operator|=
name|satIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tiOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|pInquiry
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiOrgScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|TI_DBG3
argument_list|(
operator|(
literal|"satInquiryCB: did %d\n"
operator|,
name|tdsaDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryCB: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* should NOT be retried */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryCB: NOT OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryCB: OSSA_IO_OPEN_CNX_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
operator|||
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agFirstDword
operator|!=
name|agNULL
operator|&&
name|agIOInfoLen
operator|!=
literal|0
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
comment|// only agsaFisPioSetup_t is expected
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|// ATA Status register
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|// ATA Eror register
endif|#
directive|endif
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryCB: ataStatus 0x%x ataError 0x%x\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
comment|/* Convert to host endian */
name|tmpptr
operator|=
operator|(
name|bit16
operator|*
operator|)
operator|(
name|tiScsiRequest
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bit16
argument_list|)
condition|;
name|x
operator|++
control|)
block|{
name|OSSA_READ_LE_16
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tmpptr_tmp
argument_list|,
name|tmpptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|tmpptr
operator|=
name|tmpptr_tmp
expr_stmt|;
name|tmpptr
operator|++
expr_stmt|;
comment|/*Print tmpptr_tmp here for debugging purpose*/
block|}
name|pSATAIdData
operator|=
operator|(
name|agsaSATAIdentifyData_t
operator|*
operator|)
operator|(
name|tiScsiRequest
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryCB: OS satOrgIOContext %p \n"
operator|,
name|satOrgIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryCB: TD satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryCB: OS tiScsiXchg %p \n"
operator|,
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryCB: TD tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|tiScsiXchg
operator|)
argument_list|)
expr_stmt|;
comment|/* copy ID Dev data to satDevData */
name|satDevData
operator|->
name|satIdentifyData
operator|=
operator|*
name|pSATAIdData
expr_stmt|;
name|satDevData
operator|->
name|IDDeviceValid
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
name|tdhexdump
argument_list|(
literal|"satInquiryCB ID Dev data"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pSATAIdData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"satInquiryCB Device ID Dev data"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|satDevData
operator|->
name|satIdentifyData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|// tdhexdump("satInquiryCB Device ID Dev data",(bit8 *)&satDevData->satIdentifyData, sizeof(agsaSATAIdentifyData_t));
comment|/* set satDevData fields from IndentifyData */
name|satSetDevInfo
argument_list|(
name|satDevData
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
name|lenReceived
operator|=
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|)
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* SPC-4, spec 6.4 p 141 */
comment|/* EVPD bit == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_EVPD_MASK
operator|)
condition|)
block|{
comment|/* Returns the standard INQUIRY data */
name|lenNeeded
operator|=
name|STANDARD_INQUIRY_SIZE
expr_stmt|;
name|satInquiryStandard
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|scsiCmnd
argument_list|)
expr_stmt|;
comment|//tdhexdump("satInquiryCB ***standard***", (bit8 *)pInquiry, 36);
block|}
else|else
block|{
comment|/* EVPD bit != 0&& PAGE CODE != 0 */
comment|/* returns the pages of vital product data information */
comment|/* we must support page 00h, 83h and 89h */
name|page
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|page
operator|!=
name|INQUIRY_SUPPORTED_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryCB: invalid PAGE CODE 0x%x\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* checking length */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|INQUIRY_SUPPORTED_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGE0_INQUIRY_SIZE
expr_stmt|;
comment|/* 36 */
break|break;
case|case
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
case|:
if|if
condition|(
name|satDevData
operator|->
name|satWWNSupport
condition|)
block|{
name|lenNeeded
operator|=
name|SATA_PAGE83_INQUIRY_WWN_SIZE
expr_stmt|;
comment|/* 16 */
block|}
else|else
block|{
name|lenNeeded
operator|=
name|SATA_PAGE83_INQUIRY_NO_WWN_SIZE
expr_stmt|;
comment|/* 76 */
block|}
break|break;
case|case
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGE89_INQUIRY_SIZE
expr_stmt|;
comment|/* 572 */
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryCB: wrong!!! invalid PAGE CODE 0x%x\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*      * Fill in the Inquiry data depending on what Inquiry data we are returning.      */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|INQUIRY_SUPPORTED_VPD_PAGE
case|:
name|satInquiryPage0
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
case|:
name|satInquiryPage83
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|satDevData
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
case|:
name|satInquiryPage89
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|satDevData
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryCB: wrong!!! invalidinvalid PAGE CODE 0x%x\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* else */
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryCB: calling ostiInitiatorIOCompleted\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lenReceived
operator|>
name|lenNeeded
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryCB reporting underrun lenNeeded=0x%x lenReceived=0x%x tiIORequest=%p\n"
operator|,
name|lenNeeded
operator|,
name|lenReceived
operator|,
name|tiOrgIORequest
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|lenNeeded
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryCB: device %p pending IO %d\n"
operator|,
name|satDevData
operator|,
name|satDevData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satInquiryIntCB.  *  *  This function is part of INQUIRY SAT implementation. This is called when  *  ATA identify device data is available.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e tiSuccess:     I/O request successfully initiated.  *    - \e tiBusy:        No resources available, try again later.  *    - \e tiIONoDevice:  Invalid device handle.  *    - \e tiError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|void
name|satInquiryIntCB
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tiIORequest_t
modifier|*
name|tiIORequest
parameter_list|,
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
parameter_list|,
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit8
modifier|*
name|pInquiry
decl_stmt|;
name|bit8
name|page
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|lenReceived
decl_stmt|;
name|bit32
name|lenNeeded
init|=
literal|0
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryIntCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|tiScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pInquiry
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|pSATAIdData
operator|=
operator|&
name|satDevData
operator|->
name|satIdentifyData
expr_stmt|;
name|lenReceived
operator|=
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|)
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* SPC-4, spec 6.4 p 141 */
comment|/* EVPD bit == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_EVPD_MASK
operator|)
condition|)
block|{
comment|/* Returns the standard INQUIRY data */
name|lenNeeded
operator|=
name|STANDARD_INQUIRY_SIZE
expr_stmt|;
name|satInquiryStandard
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|scsiCmnd
argument_list|)
expr_stmt|;
comment|//tdhexdump("satInquiryIntCB ***standard***", (bit8 *)pInquiry, 36);
block|}
else|else
block|{
comment|/* EVPD bit != 0&& PAGE CODE != 0 */
comment|/* returns the pages of vital product data information */
comment|/* we must support page 00h, 83h and 89h */
name|page
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|page
operator|!=
name|INQUIRY_SUPPORTED_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_UNIT_SERIAL_NUMBER_VPD_PAGE
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryIntCB: invalid PAGE CODE 0x%x\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* checking length */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|INQUIRY_SUPPORTED_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGE0_INQUIRY_SIZE
expr_stmt|;
comment|/* 36 */
break|break;
case|case
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
case|:
if|if
condition|(
name|satDevData
operator|->
name|satWWNSupport
condition|)
block|{
name|lenNeeded
operator|=
name|SATA_PAGE83_INQUIRY_WWN_SIZE
expr_stmt|;
comment|/* 16 */
block|}
else|else
block|{
name|lenNeeded
operator|=
name|SATA_PAGE83_INQUIRY_NO_WWN_SIZE
expr_stmt|;
comment|/* 76 */
block|}
break|break;
case|case
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGE89_INQUIRY_SIZE
expr_stmt|;
comment|/* 572 */
break|break;
case|case
name|INQUIRY_UNIT_SERIAL_NUMBER_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGE80_INQUIRY_SIZE
expr_stmt|;
comment|/* 24 */
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryIntCB: wrong!!! invalidinvalid PAGE CODE 0x%x\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*      * Fill in the Inquiry data depending on what Inquiry data we are returning.      */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|INQUIRY_SUPPORTED_VPD_PAGE
case|:
name|satInquiryPage0
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
case|:
name|satInquiryPage83
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|satDevData
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
case|:
name|satInquiryPage89
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|satDevData
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_UNIT_SERIAL_NUMBER_VPD_PAGE
case|:
name|satInquiryPage80
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satInquiryIntCB: wrong!!! invalidinvalid PAGE CODE 0x%x\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* else */
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryIntCB: calling ostiInitiatorIOCompleted\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lenReceived
operator|>
name|lenNeeded
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryIntCB reporting underrun lenNeeded=0x%x lenReceived=0x%x tiIORequest=%p\n"
operator|,
name|lenNeeded
operator|,
name|lenReceived
operator|,
name|tiIORequest
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|lenNeeded
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satInquiryIntCB: device %p pending IO %d\n"
operator|,
name|satDevData
operator|,
name|satDevData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satInquiryIntCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satVerify10CB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with Verify(10) completion. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satVerify10CB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify10CB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satVerify10CB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satVerify10CB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satVerify10CB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satVerify10CB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10CB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10CB: FAILED, NOT IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10CB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10CB: FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10CB: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10CB: error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end error checking */
block|}
comment|/* process success from this point on */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satVerify10CB: SAT_WRITE_DMA_EXT success \n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satVerify10CB: success but error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* similar to satVerify10CB */
end_comment

begin_function
name|void
name|satNonChainedVerifyCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: FAILED, NOT IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end error checking */
block|}
comment|/* process success from this point on */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: SAT_WRITE_DMA_EXT success \n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satNonChainedVerifyCB: success but error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|satChainedVerifyCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|bit32
name|dataLength
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedVerifyCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satChainedVerifyCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satChainedVerifyCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satChainedVerifyCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satChainedVerifyCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerifyCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerifyCB: FAILED, NOT IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerifyCB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerifyCB: FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerifyCB: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerifyCB: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerifyCB: error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end error checking */
block|}
comment|/* process success from this point on */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satChainedVerifyCB: SAT_WRITE_DMA_EXT success \n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* let's loop till TL */
comment|/* lba = lba + tl        loopnum--;        if (loopnum == 0) done      */
operator|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|)
operator|--
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|0
condition|)
block|{
comment|/*         done with write and verify       */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
else|else
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|dataLength
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerifyCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|status
operator|=
name|satChainedVerify
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerifyCB: calling satChainedVerify fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satChainedVerifyCB: success but error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satTestUnitReadyCB * *   This routine is a callback function for satTestUnitReady() * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satTestUnitReadyCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of TestUnitReady     Process SAT_GET_MEDIA_STATUS     Process SAT_CHECK_POWER_MODE   */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"satTestUnitReadyCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satTestUnitReadyCB: no internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satTestUnitReadyCB: yes internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* orginal tiIOContext */
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|satIOContext
operator|->
name|satIntIoContext
operator|->
name|satOrgTiIORequest
expr_stmt|;
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|tiOrgIORequest
operator|->
name|tdData
expr_stmt|;
name|satOrgIOContext
operator|=
operator|&
operator|(
name|tdOrgIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReadyCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     HW checks an error for us and the results is agIOStatus   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|statDevToHostFisHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReadyCB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReadyCB: FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_GET_MEDIA_STATUS
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReadyCB: SAT_GET_MEDIA_STATUS failed \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking NM bit */
if|if
condition|(
name|ataError
operator|&
name|SCSI_NM_MASK
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_CHECK_POWER_MODE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReadyCB: SAT_CHECK_POWER_MODE failed \n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_DOES_NOT_RESPOND_TO_SELECTION
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReadyCB: default failed command %d\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
comment|/* end error */
comment|/* ATA command completes sucessfully */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_GET_MEDIA_STATUS
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satTestUnitReadyCB: SAT_GET_MEDIA_STATUS success\n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReadyCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends SAT_CHECK_POWER_MODE */
name|status
operator|=
name|satTestUnitReady_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* sending SAT_CHECK_POWER_MODE fails */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReadyCB: calling satTestUnitReady_1 fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_CHECK_POWER_MODE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satTestUnitReadyCB: SAT_CHECK_POWER_MODE success\n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* returns good status */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satTestUnitReadyCB: default success command %d\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satWriteSame10CB * *   This routine is a callback function for satWriteSame10() * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satWriteSame10CB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdNewIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|sectorcount
init|=
literal|0
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|,
name|tl
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|agsaFisSetDevBitsHeader_t
modifier|*
name|statSetDevBitFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10CB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satWriteSame10CB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satWriteSame10CB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satWriteSame10CB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satWriteSame10CB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* FP, DMA and PIO write */
comment|/* First, assumed to be Reg Device to Host FIS */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|==
name|SET_DEV_BITS_FIS
condition|)
block|{
name|statSetDevBitFisHeader
operator|=
operator|(
name|agsaFisSetDevBitsHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
comment|/* Get ATA Status register */
name|ataStatus
operator|=
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x70
operator|)
expr_stmt|;
comment|/* bits 4,5,6 */
name|ataStatus
operator|=
name|ataStatus
operator||
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x07
operator|)
expr_stmt|;
comment|/* bits 0,1,2 */
comment|/* ATA Eror register   */
block|}
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/*     checking IO status, FIS type and error status     FIS type should be either REG_DEV_TO_HOST_FIS or SET_DEV_BITS_FIS   */
if|if
condition|(
operator|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
operator|)
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: FAILED, NOT IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: SAT_WRITE_DMA_EXT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: SAT_WRITE_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: SAT_WRITE_FPDMA_QUEUED\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end error */
block|}
comment|/* process success from this point on */
comment|/*     note: inefficient implementation until a single block can be manipulated   */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10CB: SAT_WRITE_DMA_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10CB: SAT_WRITE_SECTORS_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10CB: SAT_WRITE_FPDMA_QUEUED success\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: error case command 0x%x success\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* free */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*     increment LBA by one, keeping the same sector count(1)     sends another ATA command with the changed parameters   */
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satSectorDone
operator|++
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: sectordone %d\n"
operator|,
name|satDevData
operator|->
name|satSectorDone
operator|)
argument_list|)
expr_stmt|;
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satWriteSame10CB: lba 0x%x tl 0x%x\n"
operator|,
name|lba
operator|,
name|tl
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* (satDevData->satMaxUserAddrSectors - 1) - lba*/
name|sectorcount
operator|=
operator|(
literal|0x0FFFFFFF
operator|-
literal|1
operator|)
operator|-
name|lba
expr_stmt|;
block|}
else|else
block|{
name|sectorcount
operator|=
name|tl
expr_stmt|;
block|}
if|if
condition|(
name|sectorcount
operator|<=
literal|0
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: incorrect sectorcount 0x%x\n"
operator|,
name|sectorcount
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sectorcount
operator|==
name|satDevData
operator|->
name|satSectorDone
condition|)
block|{
comment|/*       done with writesame     */
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: return writesame done\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satSectorDone
operator|=
literal|0
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* sends another ATA command */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: sends another SAT_WRITE_DMA_EXT\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: sends another SAT_WRITE_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: sends another SAT_WRITE_FPDMA_QUEUED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
comment|/* the one to be used */
name|tdNewIORequestBody
operator|=
name|satNewIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|=
operator|&
name|tdNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
expr_stmt|;
name|satNewIOContext
operator|->
name|pSatDevData
operator|=
name|satDevData
expr_stmt|;
name|satNewIOContext
operator|->
name|pFis
operator|=
operator|&
name|tdNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
expr_stmt|;
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
expr_stmt|;
comment|/* saves scsi command for LBA and number of blocks */
name|osti_memcpy
argument_list|(
name|satNewIOContext
operator|->
name|pScsiCmnd
argument_list|,
name|scsiCmnd
argument_list|,
sizeof|sizeof
argument_list|(
name|tiIniScsiCmnd_t
argument_list|)
argument_list|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSense
operator|=
operator|&
name|tdNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
expr_stmt|;
name|satNewIOContext
operator|->
name|pTiSenseData
operator|=
operator|&
name|tdNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
expr_stmt|;
name|satNewIOContext
operator|->
name|pTiSenseData
operator|->
name|senseData
operator|=
name|satNewIOContext
operator|->
name|pSense
expr_stmt|;
name|satNewIOContext
operator|->
name|tiRequestBody
operator|=
name|satNewIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|->
name|interruptContext
operator|=
name|satNewIOContext
operator|->
name|interruptContext
expr_stmt|;
name|satNewIOContext
operator|->
name|satIntIoContext
operator|=
name|satNewIntIo
expr_stmt|;
name|satNewIOContext
operator|->
name|ptiDeviceHandle
operator|=
name|satIOContext
operator|->
name|ptiDeviceHandle
expr_stmt|;
comment|/* saves tiScsiXchg; only for writesame10() */
name|satNewIOContext
operator|->
name|tiScsiXchg
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
condition|)
block|{
name|status
operator|=
name|satWriteSame10_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|,
name|lba
operator|+
name|satDevData
operator|->
name|satSectorDone
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
condition|)
block|{
name|status
operator|=
name|satWriteSame10_2
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|,
name|lba
operator|+
name|satDevData
operator|->
name|satSectorDone
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
name|status
operator|=
name|satWriteSame10_3
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|,
name|lba
operator|+
name|satDevData
operator|->
name|satSectorDone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|tiError
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB: sucess but error in command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* sending ATA command fails */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteSame10CB:calling satWriteSame10_1 fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end send fails */
block|}
comment|/* end sends another ATA command */
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satStartStopUnitCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with Send Diagnostic completion. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satStartStopUnitCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of StartStopUnit     Process FLUSH CACHE (EXT)     Process STANDBY     Process READ VERIFY SECTOR(S) EXT     Process MEDIA EJECT   */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnitCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satStartStopUnitCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satStartStopUnitCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satStartStopUnitCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satStartStopUnitCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnitCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnitCB: immed bit 0\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* IMMED == 1 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnitCB: immed bit 1\n"
operator|)
argument_list|)
expr_stmt|;
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnitCB: FAILED, NOT IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnitCB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnitCB: FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_FLUSH_CACHE
case|:
comment|/* fall through */
case|case
name|SAT_FLUSH_CACHE_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnitCB: SAT_FLUSH_CACHE(_EXT)\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* check immed bit in scsi command */
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* IMMED == 1 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
condition|)
block|{
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SAT_STANDBY
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnitCB: SAT_STANDBY\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* check immed bit in scsi command */
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* IMMED == 1 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
condition|)
block|{
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnitCB: SAT_READ_VERIFY_SECTORS(_EXT)\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* IMMED == 1 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
condition|)
block|{
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SAT_MEDIA_EJECT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnitCB: SAT_MEDIA_EJECT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIA_LOAD_OR_EJECT_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* IMMED == 1 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
condition|)
block|{
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIA_LOAD_OR_EJECT_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* unspecified case, return no sense and no addition info */
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnitCB: default command %d\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* switch */
return|return;
block|}
comment|/* error check */
block|}
comment|/* ATA command completes sucessfully */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_FLUSH_CACHE
case|:
comment|/* fall through */
case|case
name|SAT_FLUSH_CACHE_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnitCB: SAT_READ_VERIFY_SECTORS(_EXT) success case\n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with SAT_FLUSH_CACHE(_EXT) */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* at this point, successful SAT_READ_VERIFY_SECTORS(_EXT)        send SAT_SATNDBY     */
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* IMMED == 1 */
block|{
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnitCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sending SAT_STANDBY */
name|status
operator|=
name|satStartStopUnit_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* sending SAT_CHECK_POWER_MODE fails */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* IMMED == 1 */
block|{
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnitCB: calling satStartStopUnit_1 fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_STANDBY
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnitCB: SAT_STANDBY success case\n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with SAT_STANDBY */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*       if immed == 0, return good status      */
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDevData
operator|->
name|satStopState
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnitCB: SAT_READ_VERIFY_SECTORS(_EXT) success case\n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with SAT_READ_VERIFY_SECTORS(_EXT) */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*       if immed == 0, return good status      */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
comment|/*       if immed == 0, return good status      */
comment|/*       don't forget to check and set driver state; Active power state     */
name|satDevData
operator|->
name|satStopState
operator|=
name|agFALSE
expr_stmt|;
break|break;
case|case
name|SAT_MEDIA_EJECT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satStartStopUnitCB: SAT_MEDIA_EJECT success case\n"
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with SAT_READ_VERIFY_SECTORS(_EXT) */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*       if immed == 0, return good status      */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satStartStopUnitCB:success but  error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
comment|/* unspecified case, return no sense and no addition info */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satSendDiagnosticCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with Send Diagnostic completion. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satSendDiagnosticCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of SendDiagnotic     Process READ VERIFY SECTOR(S) EXT two time     Process SMART ECECUTE OFF-LINE IMMEDIATE   */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnosticCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSendDiagnosticCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSendDiagnosticCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSendDiagnosticCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSendDiagnosticCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnosticCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
name|satDevData
operator|->
name|satBGPendingDiag
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x01
operator|&&
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x02
condition|)
block|{
comment|/* no completion for background send diagnotic. It is done in satSendDiagnostic() */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnosticCB: fis command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/*     checking IO status, FIS type and error status   */
name|satDevData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
name|satDevData
operator|->
name|satBGPendingDiag
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_RETURN_STATUS
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnosticCB: FAILED, NOT IO_SUCCESS and SAT_READ_VERIFY_SECTORS(_EXT)\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnosticCB: FAILED, NOT IO_SUCCESS and SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* for debugging */
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_RETURN_STATUS
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnosticCB: FAILED, Wrong FIS type 0x%x and SAT_READ_VERIFY_SECTORS(_EXT)\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnosticCB: FAILED, Wrong FIS type 0x%x and SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* for debugging */
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_RETURN_STATUS
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnosticCB: FAILED, error status and SAT_READ_VERIFY_SECTORS(_EXT)\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnosticCB: FAILED, error status and SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
operator|)
condition|)
block|{
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SAT_READ_VERIFY_SECTORS(_EXT) */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_FAILED_SELF_TEST
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_FAILED_SELF_TEST
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x01
operator|&&
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x02
condition|)
block|{
comment|/* no completion for background send diagnotic. It is done in satSendDiagnostic() */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
comment|/* processing success case */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnosticCB: SAT_READ_VERIFY_SECTORS(_EXT) case\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satVerifyState
operator|++
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnosticCB: satVerifyState %d\n"
operator|,
name|satDevData
operator|->
name|satVerifyState
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internally genereated AT_READ_VERIFY_SECTORS(_EXT) */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satDevData
operator|->
name|satVerifyState
operator|==
literal|3
condition|)
block|{
comment|/* reset satVerifyState */
name|satDevData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
comment|/* return GOOD status */
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnosticCB: return GOOD status\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
comment|/* prepare SAT_READ_VERIFY_SECTORS(_EXT) */
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* reset satVerifyState */
name|satDevData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* failed as a part of sending SAT_READ_VERIFY_SECTORS(_EXT) */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_FAILED_SELF_TEST
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnosticCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*        * Need to initialize all the fields within satIOContext        */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|satDevData
operator|->
name|satVerifyState
operator|==
literal|1
condition|)
block|{
comment|/* sending SAT_CHECK_POWER_MODE */
name|status
operator|=
name|satSendDiagnostic_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* satDevData->satVerifyState == 2 */
name|status
operator|=
name|satSendDiagnostic_2
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* sending SAT_READ_VERIFY_SECTORS(_EXT) fails */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* failed during sending SAT_READ_VERIFY_SECTORS(_EXT) */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_FAILED_SELF_TEST
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
comment|/* reset satVerifyState */
name|satDevData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnosticCB: calling satSendDiagnostic_1 or _2 fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* satDevData->satVerifyState == 1 or 2 */
break|break;
case|case
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnosticCB: SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE case\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satBGPendingDiag
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|==
literal|0x01
operator|||
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|==
literal|0x02
condition|)
block|{
comment|/* for background send diagnostic, no completion here. It is done already. */
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with AT_SMART_EXEUTE_OFF_LINE_IMMEDIATE */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnosticCB: returning but no IOCompleted\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satSendDiagnosticCB: returning good status for senddiagnostic\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with AT_SMART_EXEUTE_OFF_LINE_IMMEDIATE */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satSendDiagnosticCB: success but error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
comment|/* unspecified case, return no sense and no addition info */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satRequestSenseCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with Request Sense completion. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_comment
comment|/*   CB for internnaly generated SMART_RETURN_STATUS and SAT_CHECK_POWER_MODE   in the process of RequestSense  */
end_comment

begin_function
name|void
name|satRequestSenseCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/* ATA Vol 1, p299 SAT_SMART_RETURN_STATUS */
comment|/*     if threshold exceeds, return SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE     else call satRequestSense_1 to send CHECK_POWER_MODE   */
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|agsaFisRegD2HData_t
name|statDevToHostFisData
decl_stmt|;
name|bit32
name|lenReceived
init|=
literal|0
decl_stmt|;
name|bit32
name|dataLength
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSenseCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/*ttttttthe one */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSenseCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|pSense
operator|=
operator|(
name|scsiRspSense_t
operator|*
operator|)
operator|(
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|//satOrgIOContext->pSense;
block|}
else|else
block|{
name|pSense
operator|=
operator|(
name|scsiRspSense_t
operator|*
operator|)
operator|(
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|//satOrgIOContext->pSense;
block|}
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSenseCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSenseCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSenseCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|pSense
operator|=
operator|(
name|scsiRspSense_t
operator|*
operator|)
operator|(
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|//satOrgIOContext->pSense;
block|}
else|else
block|{
name|pSense
operator|=
operator|(
name|scsiRspSense_t
operator|*
operator|)
operator|(
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|//satOrgIOContext->pSense;
block|}
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSenseCB: fis command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|lenReceived
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: lenReceived in CDB %d 0x%x\n"
operator|,
name|lenReceived
operator|,
name|lenReceived
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
comment|/* for debugging */
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_RETURN_STATUS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: FAILED, Wrong FIS type 0x%x and SAT_SMART_RETURN_STATU\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: FAILED, Wrong FIS type 0x%x and SAT_CHECK_POWER_MODE\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* for debugging */
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_RETURN_STATUS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: FAILED, error status and SAT_SMART_RETURN_STATU\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: FAILED, error status and SAT_CHECK_POWER_MODE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_RETURN_STATUS
condition|)
block|{
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SMART RETURN STATUS */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|lenReceived
condition|)
block|{
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SAT_CHECK_POWER_MODE */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOW_POWER_CONDITION_ON
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|lenReceived
condition|)
block|{
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|statDevToHostFisData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegD2HData_t
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_SMART_RETURN_STATUS
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSenseCB: SAT_SMART_RETURN_STATUS case\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|statDevToHostFisData
operator|.
name|lbaMid
operator|==
literal|0xF4
operator|||
name|statDevToHostFisData
operator|.
name|lbaHigh
operator|==
literal|0x2C
condition|)
block|{
comment|/* threshold exceeds */
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: threshold exceeds\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SMART RETURN STATUS */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|lenReceived
condition|)
block|{
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internally genereated SAT_SMART_RETURN_STATUS */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* at this point, successful SMART_RETURN_STATUS        xmit SAT_CHECK_POWER_MODE     */
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
else|else
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|dataLength
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* failed as a part of sending SMART RETURN STATUS */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|lenReceived
condition|)
block|{
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sending SAT_CHECK_POWER_MODE */
name|status
operator|=
name|satRequestSense_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* sending SAT_CHECK_POWER_MODE fails */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* failed during sending SAT_CHECK_POWER_MODE */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOW_POWER_CONDITION_ON
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|lenReceived
condition|)
block|{
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: calling satRequestSense_1 fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_CHECK_POWER_MODE
case|:
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSenseCB: SAT_CHECK_POWER_MODE case\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* check ATA STANDBY state */
if|if
condition|(
name|statDevToHostFisData
operator|.
name|sectorCount
operator|==
literal|0x00
condition|)
block|{
comment|/* in STANDBY */
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: in standby\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SAT_CHECK_POWER_MODE */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOW_POWER_CONDITION_ON
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|lenReceived
condition|)
block|{
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internnaly generated SAT_CHECK_POWER_MODE */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satDevData
operator|->
name|satFormatState
operator|==
name|agTRUE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: in format\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* report using the original tiIOrequst */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_FORMAT_IN_PROGRESS
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|lenReceived
condition|)
block|{
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
comment|/* normal: returns good status for requestsense */
comment|/* report using the original tiIOrequst */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satRequestSenseCB: returning good status for requestsense\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|lenReceived
condition|)
block|{
comment|/* underrun */
name|TI_DBG6
argument_list|(
operator|(
literal|"satRequestSenseCB reporting underrun lenNeeded=0x%x lenReceived=0x%x tiIORequest=%p\n"
operator|,
name|SENSE_DATA_LENGTH
operator|,
name|lenReceived
operator|,
name|tiOrgIORequest
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satRequestSenseCB: success but error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
comment|/* pSense here is a part of satOrgIOContext */
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pTiSenseData
operator|->
name|senseData
expr_stmt|;
name|satOrgIOContext
operator|->
name|pTiSenseData
operator|->
name|senseLen
operator|=
name|SENSE_DATA_LENGTH
expr_stmt|;
comment|/* unspecified case, return no sense and no addition info */
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* switch */
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satSynchronizeCache10n16CB * *   This routine is a callback function for satSynchronizeCache10 and *   satSynchronizeCache1016() * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satSynchronizeCache10n16CB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* SPC: Self-Test Result Log page */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: FAILED, NOT IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_FLUSH_CACHE
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: SAT_FLUSH_CACHE failed\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking IMMED bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FLUSH_CACHE_IMMED_MASK
condition|)
block|{
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
break|break;
case|case
name|SAT_FLUSH_CACHE_EXT
case|:
name|TI_DBG1
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: SAT_FLUSH_CACHE_EXT failed\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking IMMED bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FLUSH_CACHE_IMMED_MASK
condition|)
block|{
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|satSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: error unknown command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
break|break;
block|}
return|return;
block|}
comment|/* end of error checking */
block|}
comment|/* prcessing the success case */
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_FLUSH_CACHE
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: SAT_FLUSH_CACHE success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking IMMED bit */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FLUSH_CACHE_IMMED_MASK
operator|)
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_FLUSH_CACHE_EXT
case|:
name|TI_DBG5
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: SAT_FLUSH_CACHE_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking IMMED bit */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FLUSH_CACHE_IMMED_MASK
operator|)
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
default|default:
name|TI_DBG5
argument_list|(
operator|(
literal|"satSynchronizeCache10n16CB: error unknown command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satModeSelect6n10CB * *   This routine is a callback function for satModeSelect6() and *   satModeSelect10() * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satModeSelect6n10CB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6n10CB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satModeSelect6n10CB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|tiScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satModeSelect6n10CB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satModeSelect6n10CB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satModeSelect6n10CB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|tiScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB FAILED, NOT IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SET_FEATURES
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x82
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x02
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB 1 SAT_SET_FEATURES failed, feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0xAA
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x55
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ssatModeSelect6n10CB 2 SAT_SET_FEATURES failed, feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB error unknown command 0x%x feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_ENABLE_OPERATIONS
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_DISABLE_OPERATIONS
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB SAT_SMART_ENABLE/DISABLE_OPERATIONS failed, feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB error unknown command 0x%x feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* error checking */
block|}
comment|/* prcessing the success case */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SET_FEATURES
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x82
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x02
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6n10CB 1 SAT_SET_FEATURES success, feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends either ATA SET FEATURES based on DRA bit */
name|status
operator|=
name|satModeSelect6n10_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* sending ATA command fails */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB calling satModeSelect6_1 fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end send fails */
return|return;
block|}
elseif|else
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0xAA
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x55
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6n10CB 2 SAT_SET_FEATURES success, feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* return stat_good */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB error unknown command success 0x%x feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_ENABLE_OPERATIONS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_DISABLE_OPERATIONS
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0xD8
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0xD9
operator|)
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satModeSelect6n10CB SAT_SMART_ENABLE/DISABLE_OPERATIONS success, feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* return stat_good */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB error unknown command failed 0x%x feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satModeSelect6n10CB error default case command success 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satSMARTEnableCB * *   This routine is a callback function for satSMARTEnable() * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satSMARTEnableCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satSMARTEnableCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|/*ttttttthe one */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSMARTEnableCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSMARTEnableCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSMARTEnableCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satSMARTEnableCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSMARTEnableCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satSMARTEnableCB: not success status, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* process success case */
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|512
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|status
operator|=
name|satLogSense_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* sending SAT_CHECK_POWER_MODE fails */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satLogSenseCB * *   This routine is a callback function for satLogSense() * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satLogSenseCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|tiScsiInitiatorRequest_t
modifier|*
name|tiOrgScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|satReadLogExtSelfTest_t
modifier|*
name|virtAddr1
decl_stmt|;
name|satSmartReadLogSelfTest_t
modifier|*
name|virtAddr2
decl_stmt|;
name|bit8
modifier|*
name|pLogPage
decl_stmt|;
name|bit8
name|SelfTestExecutionStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|i
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|agsaFisRegD2HData_t
name|statDevToHostFisData
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|lenReceived
init|=
literal|0
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSenseCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satLogSenseCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|tiOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiOrgScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
comment|/* ATA command response payload */
name|tiScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satLogSenseCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satLogSenseCB: satOrgIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satLogSenseCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|tiOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiOrgScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
comment|/* ATA command response payload */
name|tiScsiRequest
operator|=
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|)
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* non-data and pio read -> device to host and pio setup fis are expected */
comment|/*       first, assumed to be Reg Device to Host FIS       This is OK to just find fis type     */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
operator|)
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: FAILED, NOT IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_LOG_EXT
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: SAT_READ_LOG_EXT failed\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_READ_LOG
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: SAT_SMART_READ_LOG failed\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_RETURN_STATUS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: SAT_SMART_RETURN_STATUS failed\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: error unknown command 0x%x feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: error default case command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* error checking */
block|}
comment|/* prcessing the success case */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|statDevToHostFisData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegD2HData_t
argument_list|)
argument_list|)
expr_stmt|;
name|lenReceived
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSenseCB: lenReceived in CDB %d 0x%x\n"
operator|,
name|lenReceived
operator|,
name|lenReceived
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_LOG_EXT
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSenseCB: SAT_READ_LOG_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* process log data and sends it to upper */
comment|/* ATA: Extended Self-Test Log */
name|virtAddr1
operator|=
operator|(
name|satReadLogExtSelfTest_t
operator|*
operator|)
operator|(
name|tiScsiRequest
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|/*       ATA/ATAPI VOLII, p197, 287       self-test execution status (4 bits); ((virtAddr1->byte[5]& 0xF0)>> 4)     */
name|SelfTestExecutionStatus
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|virtAddr1
operator|->
name|byte
index|[
literal|5
index|]
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
comment|/* fills in the log page from ATA log page */
comment|/* SPC-4, 7.2.10, Table 216, 217, p 259 - 260 */
name|pLogPage
index|[
literal|0
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* page code */
name|pLogPage
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pLogPage
index|[
literal|2
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* 0x190, page length */
name|pLogPage
index|[
literal|3
index|]
operator|=
literal|0x90
expr_stmt|;
comment|/* SPC-4, Table 217 */
name|pLogPage
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Parameter Code */
name|pLogPage
index|[
literal|5
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Parameter Code,  unspecfied but ... */
name|pLogPage
index|[
literal|6
index|]
operator|=
literal|3
expr_stmt|;
comment|/* unspecified but ... */
name|pLogPage
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* Parameter Length */
name|pLogPage
index|[
literal|8
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
literal|0
operator||
operator|(
operator|(
name|virtAddr1
operator|->
name|byte
index|[
literal|5
index|]
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
comment|/* Self Test Code and Self-Test Result */
name|pLogPage
index|[
literal|9
index|]
operator|=
literal|0
expr_stmt|;
comment|/* self test number */
name|pLogPage
index|[
literal|10
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|7
index|]
expr_stmt|;
comment|/* time stamp, MSB */
name|pLogPage
index|[
literal|11
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|6
index|]
expr_stmt|;
comment|/* time stamp, LSB */
name|pLogPage
index|[
literal|12
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure MSB*/
name|pLogPage
index|[
literal|13
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|14
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|14
index|]
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|15
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|13
index|]
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|16
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|12
index|]
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|17
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|11
index|]
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|18
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|10
index|]
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|19
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|9
index|]
expr_stmt|;
comment|/* address of first failure LSB */
comment|/* SAT rev8 Table75, p 76 */
switch|switch
condition|(
name|SelfTestExecutionStatus
condition|)
block|{
case|case
literal|0
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x81
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x82
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x83
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x84
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x85
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x86
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_MEDIUM_ERROR
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x87
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x88
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* fall through */
case|case
literal|10
case|:
comment|/* fall through */
case|case
literal|11
case|:
comment|/* fall through */
case|case
literal|12
case|:
comment|/* fall through */
case|case
literal|13
case|:
comment|/* fall through */
case|case
literal|14
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: Error, incorrect SelfTestExecutionStatus 0x%x\n"
operator|,
name|SelfTestExecutionStatus
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|pLogPage
index|[
literal|23
index|]
operator|=
literal|0
expr_stmt|;
comment|/* vendor specific */
comment|/* the rest of Self-test results log */
comment|/* 403 is from SPC-4, 7.2.10, Table 216, p 259*/
for|for
control|(
name|i
operator|=
literal|24
init|;
name|i
operator|<=
literal|403
condition|;
name|i
operator|++
control|)
block|{
name|pLogPage
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
comment|/* vendor specific */
block|}
if|if
condition|(
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
operator|<
name|lenReceived
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satLogSenseCB: 1st underrun lenReceived %d len %d \n"
operator|,
name|lenReceived
operator|,
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
operator|)
argument_list|)
expr_stmt|;
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_READ_LOG
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART_RETURN_STATUS
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0xd5
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSenseCB: SAT_SMART_READ_LOG success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* process log data and sends it to upper */
comment|/* ATA: Extended Self-Test Log */
name|virtAddr2
operator|=
operator|(
name|satSmartReadLogSelfTest_t
operator|*
operator|)
operator|(
name|tiScsiRequest
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|/*         SPC-4, p197, 287         self-test execution status (4 bits); ((virtAddr2->byte[3]& 0xF0)>> 4)       */
name|SelfTestExecutionStatus
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|virtAddr2
operator|->
name|byte
index|[
literal|3
index|]
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
comment|/* fills in the log page from ATA log page */
comment|/* SPC-4, 7.2.10, Table 216, 217, p 259 - 260 */
name|pLogPage
index|[
literal|0
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* page code */
name|pLogPage
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pLogPage
index|[
literal|2
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* 0x190, page length */
name|pLogPage
index|[
literal|3
index|]
operator|=
literal|0x90
expr_stmt|;
comment|/* 0x190, page length */
comment|/* SPC-4, Table 217 */
name|pLogPage
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Parameter Code */
name|pLogPage
index|[
literal|5
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Parameter Code unspecfied but ... */
name|pLogPage
index|[
literal|6
index|]
operator|=
literal|3
expr_stmt|;
comment|/* unspecified but ... */
name|pLogPage
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* Parameter Length */
name|pLogPage
index|[
literal|8
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
literal|0
operator||
operator|(
operator|(
name|virtAddr2
operator|->
name|byte
index|[
literal|3
index|]
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
comment|/* Self Test Code and Self-Test Result */
name|pLogPage
index|[
literal|9
index|]
operator|=
literal|0
expr_stmt|;
comment|/* self test number */
name|pLogPage
index|[
literal|10
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|5
index|]
expr_stmt|;
comment|/* time stamp, MSB */
name|pLogPage
index|[
literal|11
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|4
index|]
expr_stmt|;
comment|/* time stamp, LSB */
name|pLogPage
index|[
literal|12
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure MSB*/
name|pLogPage
index|[
literal|13
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|14
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|15
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|16
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|10
index|]
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|17
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|9
index|]
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|18
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|8
index|]
expr_stmt|;
comment|/* address of first failure */
name|pLogPage
index|[
literal|19
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|7
index|]
expr_stmt|;
comment|/* address of first failure LSB */
comment|/* SAT rev8 Table75, p 76 */
switch|switch
condition|(
name|SelfTestExecutionStatus
condition|)
block|{
case|case
literal|0
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x81
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x82
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x83
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x84
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x85
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x86
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_MEDIUM_ERROR
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x87
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
literal|0x88
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* fall through */
case|case
literal|10
case|:
comment|/* fall through */
case|case
literal|11
case|:
comment|/* fall through */
case|case
literal|12
case|:
comment|/* fall through */
case|case
literal|13
case|:
comment|/* fall through */
case|case
literal|14
case|:
comment|/* unspecified */
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|pLogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|pLogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pLogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
default|default:
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: Error, incorrect SelfTestExecutionStatus 0x%x\n"
operator|,
name|SelfTestExecutionStatus
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|pLogPage
index|[
literal|23
index|]
operator|=
literal|0
expr_stmt|;
comment|/* vendor specific */
comment|/* the rest of Self-test results log */
comment|/* 403 is from SPC-4, 7.2.10, Table 216, p 259*/
for|for
control|(
name|i
operator|=
literal|24
init|;
name|i
operator|<=
literal|403
condition|;
name|i
operator|++
control|)
block|{
name|pLogPage
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
comment|/* vendor specific */
block|}
if|if
condition|(
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
operator|<
name|lenReceived
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satLogSenseCB: 2nd underrun lenReceived %d len %d \n"
operator|,
name|lenReceived
operator|,
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
operator|)
argument_list|)
expr_stmt|;
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0xda
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satLogSenseCB: SAT_SMART_RETURN_STATUS success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* fills in the log page from ATA output */
comment|/* SPC-4, 7.2.5, Table 209, 211, p 255 */
name|pLogPage
index|[
literal|0
index|]
operator|=
literal|0x2F
expr_stmt|;
comment|/* page code unspecified */
name|pLogPage
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* reserved */
name|pLogPage
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|pLogPage
index|[
literal|3
index|]
operator|=
literal|0x07
expr_stmt|;
comment|/* page length */
comment|/*         SPC-4, 7.2.5, Table 211, p 255         no vendor specific field        */
name|pLogPage
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Parameter Code */
name|pLogPage
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Parameter Code unspecfied but to do: */
name|pLogPage
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
comment|/* unspecified */
name|pLogPage
index|[
literal|7
index|]
operator|=
literal|0x03
expr_stmt|;
comment|/* Parameter length, unspecified */
comment|/* SAT rev8, 10.2.3.1 Table 72, p 73 */
if|if
condition|(
name|statDevToHostFisData
operator|.
name|lbaMid
operator|==
literal|0x4F
operator|||
name|statDevToHostFisData
operator|.
name|lbaHigh
operator|==
literal|0xC2
condition|)
block|{
name|pLogPage
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Sense code */
name|pLogPage
index|[
literal|9
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Sense code qualifier */
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisData
operator|.
name|lbaMid
operator|==
literal|0xF4
operator|||
name|statDevToHostFisData
operator|.
name|lbaHigh
operator|==
literal|0x2C
condition|)
block|{
name|pLogPage
index|[
literal|8
index|]
operator|=
literal|0x5D
expr_stmt|;
comment|/* Sense code */
name|pLogPage
index|[
literal|9
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* Sense code qualifier */
block|}
comment|/* Assumption: No support for SCT */
name|pLogPage
index|[
literal|10
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Most Recent Temperature Reading */
if|if
condition|(
name|INFORMATION_EXCEPTIONS_LOG_PAGE_LENGTH
operator|<
name|lenReceived
condition|)
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"satLogSenseCB: 3rd underrun lenReceived %d len %d \n"
operator|,
name|lenReceived
operator|,
name|INFORMATION_EXCEPTIONS_LOG_PAGE_LENGTH
operator|)
argument_list|)
expr_stmt|;
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|INFORMATION_EXCEPTIONS_LOG_PAGE_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: error unknown command success 0x%x feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satLogSenseCB: error unknown command success 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satReadMediaSerialNumberCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with Read Media Serial Number completion. * *  \param   agRoot:       Handles for this instance of SAS/SATA hardware *  \param   agIORequest:  Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:   Status of completed I/O. *  \param   agSATAParm1:  Additional info based on status. *  \param   agIOInfoLen:  Length in bytes of overrun/underrun residual or FIS *                         length. *  \param   ioContext:    Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satReadMediaSerialNumberCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiOrgScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|bit8
modifier|*
name|pMediaSerialNumber
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|lenReceived
init|=
literal|0
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadMediaSerialNumberCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadMediaSerialNumberCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|tiOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
name|pMediaSerialNumber
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiOrgScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
comment|/* ATA command response payload */
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadMediaSerialNumberCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadMediaSerialNumberCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadMediaSerialNumberCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|tiOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
name|pMediaSerialNumber
operator|=
operator|(
name|bit8
operator|*
operator|)
name|tiOrgScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
comment|/* ATA command response payload */
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadMediaSerialNumberCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* process success case */
name|lenReceived
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satReadMediaSerialNumberCB: lenReceived in CDB %d 0x%x\n"
operator|,
name|lenReceived
operator|,
name|lenReceived
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
condition|)
block|{
name|pMediaSerialNumber
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|pMediaSerialNumber
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pMediaSerialNumber
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pMediaSerialNumber
index|[
literal|3
index|]
operator|=
literal|4
expr_stmt|;
name|pMediaSerialNumber
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|pMediaSerialNumber
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|pMediaSerialNumber
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|pMediaSerialNumber
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ZERO_MEDIA_SERIAL_NUMBER_LENGTH
operator|<
name|lenReceived
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadMediaSerialNumberCB: 1st underrun lenReceived %d len %d \n"
operator|,
name|lenReceived
operator|,
name|ZERO_MEDIA_SERIAL_NUMBER_LENGTH
operator|)
argument_list|)
expr_stmt|;
comment|/* underrun */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgTiIORequest */
name|tiIOUnderRun
argument_list|,
name|lenReceived
operator|-
name|ZERO_MEDIA_SERIAL_NUMBER_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadMediaSerialNumberCB: error unknown command success 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satReadBufferCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with Read Buffer. * *  \param   agRoot:       Handles for this instance of SAS/SATA hardware *  \param   agIORequest:  Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:   Status of completed I/O. *  \param   agSATAParm1:  Additional info based on status. *  \param   agIOInfoLen:  Length in bytes of overrun/underrun residual or FIS *                         length. *  \param   ioContext:    Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satReadBufferCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadBufferCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadBufferCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
comment|/* ATA command response payload */
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadBufferCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadBufferCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReadBufferCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
comment|/* ATA command response payload */
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadBufferCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* process success case */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_BUFFER
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadBufferCB: error unknown command success 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satWriteBufferCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with Write Buffer. * *  \param   agRoot:       Handles for this instance of SAS/SATA hardware *  \param   agIORequest:  Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:   Status of completed I/O. *  \param   agSATAParm1:  Additional info based on status. *  \param   agIOInfoLen:  Length in bytes of overrun/underrun residual or FIS *                         length. *  \param   ioContext:    Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satWriteBufferCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satWriteBufferCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satWriteBufferCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
comment|/* ATA command response payload */
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satWriteBufferCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satWriteBufferCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satWriteBufferCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
comment|/* ATA command response payload */
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteBufferCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* process success case */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_BUFFER
condition|)
block|{
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satWriteBufferCB: error unknown command success 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satReassignBlocksCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals with Reassign Blocks. * *  \param   agRoot:       Handles for this instance of SAS/SATA hardware *  \param   agIORequest:  Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:   Status of completed I/O. *  \param   agSATAParm1:  Additional info based on status. *  \param   agIOInfoLen:  Length in bytes of overrun/underrun residual or FIS *                         length. *  \param   ioContext:    Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|void
name|satReassignBlocksCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|scsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|tiIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|tiIORequest_t
modifier|*
name|tiOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|tiScsiInitiatorRequest_t
modifier|*
name|tiScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|TI_DBG5
argument_list|(
operator|(
literal|"satReassignBlocksCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReassignBlocksCB: External satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tiOrgIORequest
operator|=
name|tdIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|tiScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReassignBlocksCB: Internal satInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReassignBlocksCB: satOrgIOContext is NULL, Wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG4
argument_list|(
operator|(
literal|"satReassignBlocksCB: satOrgIOContext is NOT NULL, Wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|tiOrgIORequest
operator|=
operator|(
name|tiIORequest_t
operator|*
operator|)
name|tdOrgIORequestBody
operator|->
name|tiIORequest
expr_stmt|;
name|tiScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|tiScsiXchg
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB: wrong. agFirstDword is NULL when error, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB FAILED, NOT IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB FAILED, Wrong FIS type 0x%x\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB FAILED, FAILED, error status\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|satProcessAbort
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB SAT_READ_VERIFY_SECTORS(_EXT) failed\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Verify failed; send Write with same LBA */
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|512
argument_list|,
comment|/* writing 1 sector */
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* send Write with same LBA */
name|status
operator|=
name|satReassignBlocks_2
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satNewIOContext
argument_list|,
name|satOrgIOContext
operator|->
name|LBA
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* sending ATA command fails */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB calling fail 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end send fails */
return|return;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB SAT_WRITE failed\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* fall through */
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB error default case unexpected command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* error checking */
block|}
comment|/* prcessing the success case */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
comment|/* next LBA; verify */
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|ParmIndex
operator|>=
name|satOrgIOContext
operator|->
name|ParmLen
condition|)
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satReassignBlocksCB: GOOD status\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* return stat_good */
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG5
argument_list|(
operator|(
literal|"satReassignBlocksCB: processing next LBA\n"
operator|)
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|satPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|tiOrgIORequest
argument_list|,
name|satDevData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* send Verify with the next LBA */
name|status
operator|=
name|satReassignBlocks_1
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|satNewIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
name|tiScsiRequest
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* sending ATA command fails */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB calling satModeSelect6_1 fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end send fails */
block|}
comment|/* else */
return|return;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
comment|/* next LBA; verify */
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReassignBlocksCB error unknown command success 0x%x \n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tiOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgTiIORequest */
name|tiIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pTiSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  satReadLogExtCB * *   This routine is a callback function called from ossaSATACompleted(). *   This CB routine deals READ LOG EXT completion. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to satIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_comment
comment|/*   SATAII spec p42  */
end_comment

begin_function
name|void
name|satReadLogExtCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satReadLogExtIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadLogExtCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satReadLogExtIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satReadLogExtIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satReadLogExtIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|satDevData
operator|->
name|satSaDeviceData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadLogExtCB: did %d\n"
operator|,
name|tdsaDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satReadLogExtIOContext
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|tdIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/*    * If READ LOG EXT failed, we issue device reset.    */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
operator|||
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agFirstDword
operator|!=
name|agNULL
operator|&&
name|agIOInfoLen
operator|!=
literal|0
operator|)
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadLogExtCB: FAILED.\n"
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* Abort I/O after completion of device reset */
name|satDevData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* needs to investigate this case */
comment|/* no report to OS layer */
name|satSubTM
argument_list|(
name|tiRoot
argument_list|,
name|satReadLogExtIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
name|TD_INTERNAL_TM_RESET
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
comment|/***************************************************************************    * The following steps take place when READ LOG EXT successfully completed.    ***************************************************************************/
comment|/************************************************************************    *    * 1. Issue abort to LL layer to all other pending I/Os for the same SATA    *    drive.    *    * 2. Free resource allocated for the internally generated READ LOG EXT.    *    * 3. At the completion of abort, in the context of ossaSATACompleted(),    *    return the I/O with error status to the OS-App Specific layer.    *    When all I/O aborts are completed, clear SATA device flag to    *    indicate ready to process new request.    *    ***********************************************************************/
comment|/*    * Issue abort to LL layer to all other pending I/Os for the same SATA drive    */
comment|/*     replace the single IO abort with device abort   */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadLogExtCB: issuing saSATAAbort. Device Abort\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* do not deregister this device */
name|tdsaDeviceData
operator|->
name|OSAbortAll
operator|=
name|agTRUE
expr_stmt|;
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|ostiAllocMemory
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tdAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadLogExtCB: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadLogExtCB: ostiAllocMemory returned NULL tdAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* setup task management structure */
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
operator|=
operator|(
name|tiDeviceHandle_t
operator|*
operator|)
operator|&
operator|(
name|tdsaDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|tdAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|tdAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/*    * Issue abort    */
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|tdsaDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|1
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
comment|/*    * Free resource allocated for the internally generated READ LOG EXT.    */
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*    * Sequence of recovery continue at some other context:    * At the completion of abort, in the context of ossaSATACompleted(),    * return the I/O with error status to the OS-App Specific layer.    * When all I/O aborts are completed, clear SATA device flag to    * indicate ready to process new request.    */
name|satDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"satReadLogExtCB: end return\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|FDS_SM
end_ifndef

begin_comment
comment|/***************************************************************************** *! \brief  ossaSATAEvent * *   This routine is called to notify the OS Layer of an event associated with *   SATA port or SATA device * *  \param   agRoot:        Handles for this instance of SAS/SATA hardware *  \param   agIORequest:   Pointer to the LL I/O request context for this I/O. *  \param   agPortContext  Pointer to the port context of TD and Lower layer *  \param   agDevHandle:   Pointer to a device handle *  \param   event:         event type * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSATAEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|event
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|bit32
name|interruptContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|pDeviceData
decl_stmt|;
name|satDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext2
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdIORequestBody
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
decl_stmt|;
name|tiIORequest_t
name|tiIORequestTMP
decl_stmt|;
name|agsaDifDetails_t
name|agDifDetails
decl_stmt|;
name|bit8
name|framePayload
index|[
literal|256
index|]
decl_stmt|;
name|bit16
name|frameOffset
init|=
literal|0
decl_stmt|;
name|bit16
name|frameLen
init|=
literal|0
decl_stmt|;
comment|/* new */
name|tdsaDeviceData_t
modifier|*
name|tdsaDeviceData
init|=
name|agNULL
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|tdsaPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_ERROR_ABORTED_NCQ_MODE
condition|)
block|{
comment|/**************************************************************************      *      * !!!! See Section 13.5.2.4 of SATA 2.5 specs.                       !!!!      * !!!! If the NCQ error ends up here, it means that the device sent  !!!!      * !!!! Register Device To Host FIS (which does not have SActive      !!!!      * !!!! register) instead of Set Device Bit FIS (which has SActive    !!!!      * !!!! register). The routine osSatIOCompleted() deals with the case !!!!      * !!!! where Set Device Bit FIS was sent by the device.              !!!!      *      * For NCQ we need to issue READ LOG EXT command with log page 10h      * to get the error and to allow other I/Os to continue.      *      * Here is the basic flow or sequence of error recovery, this sequence is      * similar to the one described in SATA 2.5:      *      * 1. Set SATA device flag to indicate error condition and returning busy      *    for all new request.      *      * 2. Prepare READ LOG EXT page 10h command. Set flag to indicate that      *    the failed I/O has NOT been returned to the OS Layer. Send command.      *      * 3. When the device receives READ LOG EXT page 10h request all other      *    pending I/O are implicitly aborted. No completion (aborted) status      *    will be sent to the host for these aborted commands.      *      * 4. SATL receives the completion for READ LOG EXT command in      *    satReadLogExtCB(). Steps 5,6,7,8 below are the step 1,2,3,4 in      *    satReadLogExtCB().      *      * 5. Check flag that indicates whether the failed I/O has been returned      *    to the OS Layer. If not, search the I/O context in device data      *    looking for a matched tag. Then return the completion of the failed      *    NCQ command with the appopriate/trasnlated SCSI status.      *      * 6. Issue abort to LL layer to all other pending I/Os for the same SATA      *    drive.      *      * 7. Free resource allocated for the internally generated READ LOG EXT.      *      * 8. At the completion of abort, in the context of ossaSATACompleted(),      *    return the I/O with error status to the OS-App Specific layer.      *    When all I/O aborts are completed, clear SATA device flag to      *    indicate ready to process new request.      *      *************************************************************************/
name|pDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
name|pSatDevData
operator|=
operator|&
name|pDeviceData
operator|->
name|satDevData
expr_stmt|;
name|tiDeviceHandle
operator|=
operator|&
operator|(
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
operator|(
name|pSatDevData
operator|->
name|satSaDeviceData
operator|)
operator|)
operator|->
name|tiDeviceHandle
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: did %d\n"
operator|,
name|pDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_NORMAL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: NCQ ERROR agDevHandle=%p.\n"
operator|,
name|agDevHandle
operator|)
argument_list|)
expr_stmt|;
comment|/* Set flag to indicate we are in recovery */
name|pSatDevData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
comment|/*        * Allocate resource for READ LOG EXIT page 10h        */
name|satIntIo
operator|=
name|satAllocIntIoResource
argument_list|(
name|tiRoot
argument_list|,
operator|&
operator|(
name|tiIORequestTMP
operator|)
argument_list|,
comment|/* anything but NULL */
name|pSatDevData
argument_list|,
sizeof|sizeof
argument_list|(
name|satReadLogExtPage10h_t
argument_list|)
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*        * If we cannot allocate resource to do the normal NCQ recovery, we        * will do SATA device reset.        */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* Abort I/O after completion of device reset */
name|pSatDevData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: can't send RLE due to resource lack\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* needs to investigate this case */
comment|/* no report to OS layer */
name|satSubTM
argument_list|(
name|tiRoot
argument_list|,
name|tiDeviceHandle
argument_list|,
name|TD_INTERNAL_TM_RESET
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
comment|/*        * Clear flag to indicate that the failed I/O has NOT been returned to the        * OS-App specific Layer.        */
name|satIntIo
operator|->
name|satIntFlag
operator|=
literal|0
expr_stmt|;
comment|/* compare to satPrepareNewIO() */
comment|/* Send READ LOG EXIT page 10h command */
comment|/*        * Need to initialize all the fields within satIOContext except        * reqType and satCompleteCB which will be set depending on cmd.        */
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSatDevData
operator|=
name|pSatDevData
expr_stmt|;
name|satIOContext2
operator|->
name|pFis
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntTiScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSense
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pTiSenseData
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|tiSenseData
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pTiSenseData
operator|->
name|senseData
operator|=
name|satIOContext2
operator|->
name|pSense
expr_stmt|;
name|satIOContext2
operator|->
name|tiRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|->
name|interruptContext
operator|=
name|interruptContext
expr_stmt|;
name|satIOContext2
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satIOContext2
operator|->
name|ptiDeviceHandle
operator|=
name|tiDeviceHandle
expr_stmt|;
name|satIOContext2
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext2
operator|->
name|tiScsiXchg
operator|=
name|agNULL
expr_stmt|;
name|status
operator|=
name|satSendReadLogExt
argument_list|(
name|tiRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiIORequest
argument_list|,
name|tiDeviceHandle
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntTiScsiXchg
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|tiSuccess
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: can't send RLE due to LL api failure\n"
operator|)
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* Abort I/O after completion of device reset */
name|pSatDevData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* needs to investigate this case */
comment|/* no report to OS layer */
name|satSubTM
argument_list|(
name|tiRoot
argument_list|,
name|tiDeviceHandle
argument_list|,
name|TD_INTERNAL_TM_RESET
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: NCQ ERROR but recovery in progress\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_CMD_FRAME_ISSUED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_XFER_CMD_FRAME_ISSUED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_PIO_SETUP_ERROR
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_XFER_PIO_SETUP_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_MISMATCH
operator|||
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
operator|||
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
operator|||
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSSPEvent: DIF related, event 0x%x\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
comment|/* process DIF detail information */
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: agIOInfoLen %d\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agParam
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: agParam is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOInfoLen
operator|<
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
condition|)
block|{
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: wrong agIOInfoLen!!! agIOInfoLen %d sizeof(agsaDifDetails_t) %d\n"
operator|,
name|agIOInfoLen
operator|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* reads agsaDifDetails_t */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|agDifDetails
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
argument_list|)
expr_stmt|;
name|frameOffset
operator|=
operator|(
name|agDifDetails
operator|.
name|ErrBoffsetEDataLen
operator|&
literal|0xFFFF
operator|)
expr_stmt|;
name|frameLen
operator|=
operator|(
name|agDifDetails
operator|.
name|ErrBoffsetEDataLen
operator|&
literal|0xFFFF0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: UpperLBA 0x%08x LowerLBA 0x%08x\n"
operator|,
name|agDifDetails
operator|.
name|UpperLBA
operator|,
name|agDifDetails
operator|.
name|LowerLBA
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: SASAddrHI 0x%08x SASAddrLO 0x%08x\n"
operator|,
name|TD_GET_SAS_ADDRESSHI
argument_list|(
name|agDifDetails
operator|.
name|sasAddressHi
argument_list|)
operator|,
name|TD_GET_SAS_ADDRESSLO
argument_list|(
name|agDifDetails
operator|.
name|sasAddressLo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|TI_DBG2
argument_list|(
operator|(
literal|"ossaSSPEvent: DIF error mask 0x%x Device ID 0x%x\n"
operator|,
operator|(
name|agDifDetails
operator|.
name|DIFErrDevID
operator|)
operator|&
literal|0xFF
operator|,
operator|(
name|agDifDetails
operator|.
name|DIFErrDevID
operator|&
literal|0xFFFF0000
operator|)
operator|>>
literal|16
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|frameLen
operator|!=
literal|0
operator|&&
name|frameLen
operator|<=
literal|256
condition|)
block|{
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
argument_list|,
name|framePayload
argument_list|,
name|frameLen
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"ossaSSPEvent frame"
argument_list|,
name|framePayload
argument_list|,
name|frameLen
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: ERROR event %d agDevHandle=%p.\n"
operator|,
name|event
operator|,
name|agDevHandle
operator|)
argument_list|)
expr_stmt|;
name|tdIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|tdIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|tdsaDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|pSatDevData
operator|->
name|satSaDeviceData
expr_stmt|;
name|onePortContext
operator|=
name|tdsaDeviceData
operator|->
name|tdPortContext
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: did %d\n"
operator|,
name|tdsaDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* send SMP_PHY_CONTROL_HARD_RESET */
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
operator|&&
name|tdsaAllShared
operator|->
name|FCA
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|NumOfFCA
operator|<=
literal|0
condition|)
comment|/* does SMP HARD RESET only upto one time */
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY; sending HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|->
name|NumOfFCA
operator|++
expr_stmt|;
name|tdsaPhyControlSend
argument_list|(
name|tiRoot
argument_list|,
name|tdsaDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* given up after one time of SMP HARD RESET; */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY; NO!!! sending HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdsaDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
name|tdsaAllShared
operator|->
name|ResetInDiscovery
operator|==
literal|0
condition|)
block|{
comment|/*             1. remove this device             2. device removal event           */
name|tdsaAbortAll
argument_list|(
name|tiRoot
argument_list|,
name|agRoot
argument_list|,
name|tdsaDeviceData
argument_list|)
expr_stmt|;
name|tdsaDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|tdsaDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|tdsaDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|onePortContext
operator|->
name|tiPortalContext
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeDeviceChange
argument_list|,
name|tiDeviceRemoval
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FDS_SM */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  itdsatErrorSATAEventHandle * *   This routine is called to handle SATA error event * *  \param   agRoot:        Handles for this instance of SAS/SATA hardware *  \param   agIORequest:   Pointer to the LL I/O request context for this I/O. *  \param   agPortContext  Pointer to the port context of TD and Lower layer *  \param   agDevHandle:   Pointer to a device handle *  \param   event:         event type *  \param   ioContext:     Pointer to satIOContext_t * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|itdsatErrorSATAEventHandle
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|event
parameter_list|,
name|satIOContext_t
modifier|*
name|ioContext
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
name|tdsaRoot
operator|->
name|tdsaAllShared
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdOrgIORequestBody
decl_stmt|;
name|satIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|satIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|satInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|bit32
name|interruptContext
init|=
name|osData
operator|->
name|IntContext
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatErrorSATAEventHandle: start\n"
operator|)
argument_list|)
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|satIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatErrorSATAEventHandle: event 0x%x\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatErrorSATAEventHandle: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OVERFLOW
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatErrorSATAEventHandle: tiIOOverRun\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOOverRun
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatErrorSATAEventHandle: else\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorIOCompleted
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|tiIORequest
argument_list|,
name|tiIOFailed
argument_list|,
name|tiDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatErrorSATAEventHandle: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"itdsatErrorSATAEventHandle: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|TI_DBG6
argument_list|(
operator|(
literal|"itdsatErrorSATAEventHandle: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdOrgIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|tiRequestBody
expr_stmt|;
name|satDecrementPendingIO
argument_list|(
name|tiRoot
argument_list|,
name|tdsaAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|satFreeIntIoResource
argument_list|(
name|tiRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdOrgIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ossaSATAAbortCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdIORequestBody_t
modifier|*
name|tdAbortIORequestBody
init|=
name|agNULL
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|tiIORequest_t
modifier|*
name|taskTag
init|=
name|agNULL
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdAbortIORequestBody
operator|=
operator|(
name|tdIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|tdAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: tdAbortIORequestBody is NULL warning!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|flag
operator|==
literal|2
condition|)
block|{
comment|/* abort per port */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: abort per port\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|1
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: abort all\n"
operator|)
argument_list|)
expr_stmt|;
name|tiDeviceHandle
operator|=
operator|(
name|tiDeviceHandle_t
operator|*
operator|)
name|tdAbortIORequestBody
operator|->
name|tiDevHandle
expr_stmt|;
if|if
condition|(
name|tiDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: tiDeviceHandle is NULL warning!!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|tiDeviceHandle
operator|->
name|tdData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: oneDeviceData is NULL warning!!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: calling saDeregisterDeviceHandle did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* callback to OS layer here ??? */
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NOT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: OSSA_IO_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*         Nothing is reproted to OS layer       */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortFailed
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: calling saDeregisterDeviceHandle did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NO_DEVICE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*         Nothing is reproted to OS layer       */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortInProgress
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: calling saDeregisterDeviceHandle did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_IN_PROGRESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: OSSA_IO_ABORT_IN_PROGRESS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*         Nothing is reproted to OS layer       */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortInProgress
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: calling saDeregisterDeviceHandle did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: unspecified status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|/*         Nothing is reproted to OS layer       */
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortInProgress
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: calling saDeregisterDeviceHandle did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|saDeregisterDeviceHandle
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|tdsaRotateQnumber
argument_list|(
name|tiRoot
argument_list|,
name|oneDeviceData
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|0
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: abort one\n"
operator|)
argument_list|)
expr_stmt|;
name|taskTag
operator|=
name|tdAbortIORequestBody
operator|->
name|tiIOToBeAbortedRequest
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortOK
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NOT_VALID
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: OSSA_IO_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortFailed
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NO_DEVICE
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortInProgress
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_IN_PROGRESS
condition|)
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: OSSA_IO_ABORT_IN_PROGRESS\n"
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortInProgress
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: unspecified status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|ostiInitiatorEvent
argument_list|(
name|tiRoot
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|tiIntrEventTypeLocalAbort
argument_list|,
name|tiAbortFailed
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|tiRoot
argument_list|,
name|tdAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATAAbortCB: wrong flag %d\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  ossaSATADeviceResetCB * *   This routine is called to complete a SATA device reset request previously *   issued to the LL Layer in saSATADeviceReset(). * *  \param agRoot:      Handles for this instance of SAS/SATA hardware *  \param agDevHandle: Pointer to a device handle *  \param resetStatus: Reset status: *                      OSSA_SUCCESS: The reset operation completed successfully. *                      OSSA_FAILURE: The reset operation failed. *  \param resetparm:  Pointer to the Device-To-Host FIS received from the device. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ossaSATADeviceResetCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|resetStatus
parameter_list|,
name|void
modifier|*
name|resetparm
parameter_list|)
block|{
name|bit32
name|tiResetStatus
decl_stmt|;
name|tdsaRootOsData_t
modifier|*
name|osData
init|=
operator|(
name|tdsaRootOsData_t
operator|*
operator|)
name|agRoot
operator|->
name|osData
decl_stmt|;
name|tiRoot_t
modifier|*
name|tiRoot
init|=
operator|(
name|tiRoot_t
operator|*
operator|)
name|osData
operator|->
name|tiRoot
decl_stmt|;
name|tdsaDeviceData_t
modifier|*
name|pDeviceData
decl_stmt|;
name|tiDeviceHandle_t
modifier|*
name|tiDeviceHandle
decl_stmt|;
name|TI_DBG1
argument_list|(
operator|(
literal|"ossaSATADeviceResetCB: agDevHandle=%p resetStatus=0x%x\n"
operator|,
name|agDevHandle
operator|,
name|resetStatus
operator|)
argument_list|)
expr_stmt|;
name|pDeviceData
operator|=
operator|(
name|tdsaDeviceData_t
operator|*
operator|)
name|agDevHandle
operator|->
name|osData
expr_stmt|;
name|tiDeviceHandle
operator|=
operator|&
operator|(
name|pDeviceData
operator|->
name|tiDeviceHandle
operator|)
expr_stmt|;
if|if
condition|(
name|resetStatus
operator|==
name|OSSA_SUCCESS
condition|)
name|tiResetStatus
operator|=
name|tiSuccess
expr_stmt|;
else|else
name|tiResetStatus
operator|=
name|tiError
expr_stmt|;
name|osSatResetCB
argument_list|(
name|tiRoot
argument_list|,
name|tiDeviceHandle
argument_list|,
name|tiResetStatus
argument_list|,
name|resetparm
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief satDecrementPendingIO  *  *  This function decrements the number of pending IO's  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tdsaAllShared:    Pointer to TD context.  *  \param   satIOContext_t:   Pointer to the SAT IO Context  *  *  \return  *          None  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|satDecrementPendingIO
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaContext_t
modifier|*
name|tdsaAllShared
parameter_list|,
name|satIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|satDeviceData_t
modifier|*
name|satDevData
decl_stmt|;
name|TI_DBG4
argument_list|(
operator|(
literal|"satDecrementPendingIO: start\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
if|if
condition|(
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satPendingNCQIO
operator|--
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|->
name|satPendingIO
operator|--
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|satIOContext
operator|->
name|satIoContextLink
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsaSingleThreadedEnter
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
name|satDevData
operator|->
name|satPendingNONNCQIO
operator|--
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|->
name|satPendingIO
operator|--
expr_stmt|;
name|TDLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|satIOContext
operator|->
name|satIoContextLink
argument_list|)
expr_stmt|;
name|tdsaSingleThreadedLeave
argument_list|(
name|tiRoot
argument_list|,
name|TD_SATA_LOCK
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|satTranslateATAPIErrorsToSCSIErrors
parameter_list|(
name|bit8
name|bCommand
parameter_list|,
name|bit8
name|bATAStatus
parameter_list|,
name|bit8
name|bATAError
parameter_list|,
name|bit8
modifier|*
name|pSenseKey
parameter_list|,
name|bit16
modifier|*
name|pSenseCodeInfo
parameter_list|)
block|{
if|if
condition|(
name|pSenseKey
operator|==
name|agNULL
operator|||
name|pSenseCodeInfo
operator|==
name|agNULL
condition|)
block|{
name|TI_DBG0
argument_list|(
operator|(
literal|"TranslateATAErrorsToSCSIErros: pSenseKey == agNULL || pSenseCodeInfo == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|bATAStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|&&
operator|(
name|bATAError
operator|&
name|NM_ATA_ERROR_MASK
operator|)
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_NOT_READY
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x3a00
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|bATAStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|&&
operator|(
name|bATAError
operator|&
name|ABRT_ATA_ERROR_MASK
operator|)
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|bATAStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|&&
operator|(
name|bATAError
operator|&
name|MCR_ATA_ERROR_MASK
operator|)
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_UNIT_ATTENTION
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x5a01
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|bATAStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|&&
operator|(
name|bATAError
operator|&
name|IDNF_ATA_ERROR_MASK
operator|)
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_MEDIUM_ERROR
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x1401
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|bATAStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|&&
operator|(
name|bATAError
operator|&
name|MC_ATA_ERROR_MASK
operator|)
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_UNIT_ATTENTION
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x2800
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|bATAStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|&&
operator|(
name|bATAError
operator|&
name|UNC_ATA_ERROR_MASK
operator|)
condition|)
block|{
comment|/*READ*/
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_MEDIUM_ERROR
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x1100
expr_stmt|;
comment|/*add WRITE here */
block|}
elseif|else
if|if
condition|(
operator|(
name|bATAStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|&&
operator|(
name|bATAError
operator|&
name|ICRC_ATA_ERROR_MASK
operator|)
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x4703
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|bATAStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x4400
expr_stmt|;
block|}
else|else
block|{
name|TI_DBG0
argument_list|(
operator|(
literal|"unhandled ata error: bATAStatus = 0x%x, bATAError = 0x%x\n"
operator|,
name|bATAStatus
operator|,
name|bATAError
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* #ifdef SATA_ENABLE */
end_comment

end_unit


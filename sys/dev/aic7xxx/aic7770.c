begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Product specific probe and attach routines for:  * 	27/284X and aic7770 motherboard SCSI controllers  *  * Copyright (c) 1994-1998, 2000, 2001 Justin T. Gibbs.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice immediately at the beginning of the file, without modification,  *    this list of conditions, and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * Alternatively, this software may be distributed under the terms of the  * GNU Public License ("GPL").  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: //depot/src/aic7xxx/aic7770.c#9 $  *  * $FreeBSD$  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__linux__
end_ifdef

begin_include
include|#
directive|include
file|"aic7xxx_linux.h"
end_include

begin_include
include|#
directive|include
file|"aic7xxx_inline.h"
end_include

begin_include
include|#
directive|include
file|"aic7xxx_93cx6.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<dev/aic7xxx/aic7xxx_freebsd.h>
end_include

begin_include
include|#
directive|include
file|<dev/aic7xxx/aic7xxx_inline.h>
end_include

begin_include
include|#
directive|include
file|<dev/aic7xxx/aic7xxx_93cx6.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ID_AIC7770
value|0x04907770
end_define

begin_define
define|#
directive|define
name|ID_AHA_274x
value|0x04907771
end_define

begin_define
define|#
directive|define
name|ID_AHA_284xB
value|0x04907756
end_define

begin_comment
comment|/* BIOS enabled */
end_comment

begin_define
define|#
directive|define
name|ID_AHA_284x
value|0x04907757
end_define

begin_comment
comment|/* BIOS disabled*/
end_comment

begin_function_decl
specifier|static
name|void
name|aha2840_load_seeprom
parameter_list|(
name|struct
name|ahc_softc
modifier|*
name|ahc
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|ahc_device_setup_t
name|ahc_aic7770_VL_setup
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ahc_device_setup_t
name|ahc_aic7770_EISA_setup
decl_stmt|;
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
specifier|static
name|ahc_device_setup_t
name|ahc_aic7770_setup
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|aic7770_identity
name|aic7770_ident_table
index|[]
init|=
block|{
block|{
name|ID_AHA_274x
block|,
literal|0xFFFFFFFF
block|,
literal|"Adaptec 274X SCSI adapter"
block|,
name|ahc_aic7770_EISA_setup
block|}
block|,
block|{
name|ID_AHA_284xB
block|,
literal|0xFFFFFFFE
block|,
literal|"Adaptec 284X SCSI adapter"
block|,
name|ahc_aic7770_VL_setup
block|}
block|,
comment|/* Generic chip probes for devices we don't know 'exactly' */
block|{
name|ID_AIC7770
block|,
literal|0xFFFFFFFF
block|,
literal|"Adaptec aic7770 SCSI adapter"
block|,
name|ahc_aic7770_EISA_setup
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|int
name|ahc_num_aic7770_devs
init|=
name|NUM_ELEMENTS
argument_list|(
name|aic7770_ident_table
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|struct
name|aic7770_identity
modifier|*
name|aic7770_find_device
parameter_list|(
name|uint32_t
name|id
parameter_list|)
block|{
name|struct
name|aic7770_identity
modifier|*
name|entry
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ahc_num_aic7770_devs
condition|;
name|i
operator|++
control|)
block|{
name|entry
operator|=
operator|&
name|aic7770_ident_table
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|full_id
operator|==
operator|(
name|id
operator|&
name|entry
operator|->
name|id_mask
operator|)
condition|)
return|return
operator|(
name|entry
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|int
name|aic7770_config
parameter_list|(
name|struct
name|ahc_softc
modifier|*
name|ahc
parameter_list|,
name|struct
name|aic7770_identity
modifier|*
name|entry
parameter_list|)
block|{
name|struct
name|ahc_probe_config
name|probe_config
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int
name|hostconf
decl_stmt|;
name|u_int
name|irq
decl_stmt|;
name|u_int
name|intdef
decl_stmt|;
name|ahc_init_probe_config
argument_list|(
operator|&
name|probe_config
argument_list|)
expr_stmt|;
name|error
operator|=
name|entry
operator|->
name|setup
argument_list|(
name|ahc
operator|->
name|dev_softc
argument_list|,
operator|&
name|probe_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|aic7770_map_registers
argument_list|(
name|ahc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|probe_config
operator|.
name|description
operator|=
name|entry
operator|->
name|name
expr_stmt|;
name|error
operator|=
name|ahc_softc_init
argument_list|(
name|ahc
argument_list|,
operator|&
name|probe_config
argument_list|)
expr_stmt|;
name|error
operator|=
name|ahc_reset
argument_list|(
name|ahc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Make sure we have a valid interrupt vector */
name|intdef
operator|=
name|ahc_inb
argument_list|(
name|ahc
argument_list|,
name|INTDEF
argument_list|)
expr_stmt|;
name|irq
operator|=
name|intdef
operator|&
name|VECTOR
expr_stmt|;
switch|switch
condition|(
name|irq
condition|)
block|{
case|case
literal|9
case|:
case|case
literal|10
case|:
case|case
literal|11
case|:
case|case
literal|12
case|:
case|case
literal|14
case|:
case|case
literal|15
case|:
break|break;
default|default:
name|printf
argument_list|(
literal|"aic7770_config: illegal irq setting %d\n"
argument_list|,
name|intdef
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|intdef
operator|&
name|EDGE_TRIG
operator|)
operator|!=
literal|0
condition|)
name|ahc
operator|->
name|flags
operator||=
name|AHC_EDGE_INTERRUPT
expr_stmt|;
name|error
operator|=
name|aic7770_map_int
argument_list|(
name|ahc
argument_list|,
name|irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
switch|switch
condition|(
name|probe_config
operator|.
name|chip
operator|&
operator|(
name|AHC_EISA
operator||
name|AHC_VL
operator|)
condition|)
block|{
case|case
name|AHC_EISA
case|:
block|{
name|u_int
name|biosctrl
decl_stmt|;
name|u_int
name|scsiconf
decl_stmt|;
name|u_int
name|scsiconf1
decl_stmt|;
name|biosctrl
operator|=
name|ahc_inb
argument_list|(
name|ahc
argument_list|,
name|HA_274_BIOSCTRL
argument_list|)
expr_stmt|;
name|scsiconf
operator|=
name|ahc_inb
argument_list|(
name|ahc
argument_list|,
name|SCSICONF
argument_list|)
expr_stmt|;
name|scsiconf1
operator|=
name|ahc_inb
argument_list|(
name|ahc
argument_list|,
name|SCSICONF
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* Get the primary channel information */
if|if
condition|(
operator|(
name|biosctrl
operator|&
name|CHANNEL_B_PRIMARY
operator|)
operator|!=
literal|0
condition|)
name|ahc
operator|->
name|flags
operator||=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|biosctrl
operator|&
name|BIOSMODE
operator|)
operator|==
name|BIOSDISABLED
condition|)
block|{
name|ahc
operator|->
name|flags
operator||=
name|AHC_USEDEFAULTS
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ahc
operator|->
name|features
operator|&
name|AHC_WIDE
operator|)
operator|!=
literal|0
condition|)
block|{
name|ahc
operator|->
name|our_id
operator|=
name|scsiconf1
operator|&
name|HWSCSIID
expr_stmt|;
if|if
condition|(
name|scsiconf
operator|&
name|TERM_ENB
condition|)
name|ahc
operator|->
name|flags
operator||=
name|AHC_TERM_ENB_A
expr_stmt|;
block|}
else|else
block|{
name|ahc
operator|->
name|our_id
operator|=
name|scsiconf
operator|&
name|HSCSIID
expr_stmt|;
name|ahc
operator|->
name|our_id_b
operator|=
name|scsiconf1
operator|&
name|HSCSIID
expr_stmt|;
if|if
condition|(
name|scsiconf
operator|&
name|TERM_ENB
condition|)
name|ahc
operator|->
name|flags
operator||=
name|AHC_TERM_ENB_A
expr_stmt|;
if|if
condition|(
name|scsiconf1
operator|&
name|TERM_ENB
condition|)
name|ahc
operator|->
name|flags
operator||=
name|AHC_TERM_ENB_B
expr_stmt|;
block|}
block|}
comment|/* 		 * We have no way to tell, so assume extended 		 * translation is enabled. 		 */
name|ahc
operator|->
name|flags
operator||=
name|AHC_EXTENDED_TRANS_A
operator||
name|AHC_EXTENDED_TRANS_B
expr_stmt|;
break|break;
block|}
case|case
name|AHC_VL
case|:
block|{
name|aha2840_load_seeprom
argument_list|(
name|ahc
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
break|break;
block|}
comment|/* 	 * Ensure autoflush is enabled 	 */
name|ahc_outb
argument_list|(
name|ahc
argument_list|,
name|SBLKCTL
argument_list|,
name|ahc_inb
argument_list|(
name|ahc
argument_list|,
name|SBLKCTL
argument_list|)
operator|&
operator|~
name|AUTOFLUSHDIS
argument_list|)
expr_stmt|;
comment|/* Setup the FIFO threshold and the bus off time */
name|hostconf
operator|=
name|ahc_inb
argument_list|(
name|ahc
argument_list|,
name|HOSTCONF
argument_list|)
expr_stmt|;
name|ahc_outb
argument_list|(
name|ahc
argument_list|,
name|BUSSPD
argument_list|,
name|hostconf
operator|&
name|DFTHRSH
argument_list|)
expr_stmt|;
name|ahc_outb
argument_list|(
name|ahc
argument_list|,
name|BUSTIME
argument_list|,
operator|(
name|hostconf
operator|<<
literal|2
operator|)
operator|&
name|BOFF
argument_list|)
expr_stmt|;
comment|/* 	 * Generic aic7xxx initialization. 	 */
name|error
operator|=
name|ahc_init
argument_list|(
name|ahc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * Link this softc in with all other ahc instances. 	 */
name|ahc_softc_insert
argument_list|(
name|ahc
argument_list|)
expr_stmt|;
comment|/* 	 * Enable the board's BUS drivers 	 */
name|ahc_outb
argument_list|(
name|ahc
argument_list|,
name|BCTL
argument_list|,
name|ENABLE
argument_list|)
expr_stmt|;
comment|/* 	 * Allow interrupts. 	 */
name|ahc_intr_enable
argument_list|(
name|ahc
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read the 284x SEEPROM.  */
end_comment

begin_function
specifier|static
name|void
name|aha2840_load_seeprom
parameter_list|(
name|struct
name|ahc_softc
modifier|*
name|ahc
parameter_list|)
block|{
name|struct
name|seeprom_descriptor
name|sd
decl_stmt|;
name|struct
name|seeprom_config
name|sc
decl_stmt|;
name|uint16_t
name|checksum
init|=
literal|0
decl_stmt|;
name|uint8_t
name|scsi_conf
decl_stmt|;
name|int
name|have_seeprom
decl_stmt|;
name|sd
operator|.
name|sd_ahc
operator|=
name|ahc
expr_stmt|;
name|sd
operator|.
name|sd_control_offset
operator|=
name|SEECTL_2840
expr_stmt|;
name|sd
operator|.
name|sd_status_offset
operator|=
name|STATUS_2840
expr_stmt|;
name|sd
operator|.
name|sd_dataout_offset
operator|=
name|STATUS_2840
expr_stmt|;
name|sd
operator|.
name|sd_chip
operator|=
name|C46
expr_stmt|;
name|sd
operator|.
name|sd_MS
operator|=
literal|0
expr_stmt|;
name|sd
operator|.
name|sd_RDY
operator|=
name|EEPROM_TF
expr_stmt|;
name|sd
operator|.
name|sd_CS
operator|=
name|CS_2840
expr_stmt|;
name|sd
operator|.
name|sd_CK
operator|=
name|CK_2840
expr_stmt|;
name|sd
operator|.
name|sd_DO
operator|=
name|DO_2840
expr_stmt|;
name|sd
operator|.
name|sd_DI
operator|=
name|DI_2840
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"%s: Reading SEEPROM..."
argument_list|,
name|ahc_name
argument_list|(
name|ahc
argument_list|)
argument_list|)
expr_stmt|;
name|have_seeprom
operator|=
name|read_seeprom
argument_list|(
operator|&
name|sd
argument_list|,
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|sc
argument_list|,
comment|/*start_addr*/
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
argument_list|)
operator|/
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_seeprom
condition|)
block|{
comment|/* Check checksum */
name|int
name|i
decl_stmt|;
name|int
name|maxaddr
init|=
operator|(
sizeof|sizeof
argument_list|(
name|sc
argument_list|)
operator|/
literal|2
operator|)
operator|-
literal|1
decl_stmt|;
name|uint16_t
modifier|*
name|scarray
init|=
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|sc
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxaddr
condition|;
name|i
operator|++
control|)
name|checksum
operator|=
name|checksum
operator|+
name|scarray
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|checksum
operator|!=
name|sc
operator|.
name|checksum
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"checksum error\n"
argument_list|)
expr_stmt|;
name|have_seeprom
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"done.\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|have_seeprom
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"%s: No SEEPROM available\n"
argument_list|,
name|ahc_name
argument_list|(
name|ahc
argument_list|)
argument_list|)
expr_stmt|;
name|ahc
operator|->
name|flags
operator||=
name|AHC_USEDEFAULTS
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Put the data we've collected down into SRAM 		 * where ahc_init will find it. 		 */
name|int
name|i
decl_stmt|;
name|int
name|max_targ
init|=
operator|(
name|ahc
operator|->
name|features
operator|&
name|AHC_WIDE
operator|)
operator|!=
literal|0
condition|?
literal|16
else|:
literal|8
decl_stmt|;
name|uint16_t
name|discenable
decl_stmt|;
name|discenable
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_targ
condition|;
name|i
operator|++
control|)
block|{
name|uint8_t
name|target_settings
decl_stmt|;
name|target_settings
operator|=
operator|(
name|sc
operator|.
name|device_flags
index|[
name|i
index|]
operator|&
name|CFXFER
operator|)
operator|<<
literal|4
expr_stmt|;
if|if
condition|(
name|sc
operator|.
name|device_flags
index|[
name|i
index|]
operator|&
name|CFSYNCH
condition|)
name|target_settings
operator||=
name|SOFS
expr_stmt|;
if|if
condition|(
name|sc
operator|.
name|device_flags
index|[
name|i
index|]
operator|&
name|CFWIDEB
condition|)
name|target_settings
operator||=
name|WIDEXFER
expr_stmt|;
if|if
condition|(
name|sc
operator|.
name|device_flags
index|[
name|i
index|]
operator|&
name|CFDISC
condition|)
name|discenable
operator||=
operator|(
literal|0x01
operator|<<
name|i
operator|)
expr_stmt|;
name|ahc_outb
argument_list|(
name|ahc
argument_list|,
name|TARG_SCSIRATE
operator|+
name|i
argument_list|,
name|target_settings
argument_list|)
expr_stmt|;
block|}
name|ahc_outb
argument_list|(
name|ahc
argument_list|,
name|DISC_DSB
argument_list|,
operator|~
operator|(
name|discenable
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|ahc_outb
argument_list|(
name|ahc
argument_list|,
name|DISC_DSB
operator|+
literal|1
argument_list|,
operator|~
operator|(
operator|(
name|discenable
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|ahc
operator|->
name|our_id
operator|=
name|sc
operator|.
name|brtime_id
operator|&
name|CFSCSIID
expr_stmt|;
name|scsi_conf
operator|=
operator|(
name|ahc
operator|->
name|our_id
operator|&
literal|0x7
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|.
name|adapter_control
operator|&
name|CFSPARITY
condition|)
name|scsi_conf
operator||=
name|ENSPCHK
expr_stmt|;
if|if
condition|(
name|sc
operator|.
name|adapter_control
operator|&
name|CFRESETB
condition|)
name|scsi_conf
operator||=
name|RESET_SCSI
expr_stmt|;
if|if
condition|(
name|sc
operator|.
name|bios_control
operator|&
name|CF284XEXTEND
condition|)
name|ahc
operator|->
name|flags
operator||=
name|AHC_EXTENDED_TRANS_A
expr_stmt|;
comment|/* Set SCSICONF info */
name|ahc_outb
argument_list|(
name|ahc
argument_list|,
name|SCSICONF
argument_list|,
name|scsi_conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|.
name|adapter_control
operator|&
name|CF284XSTERM
condition|)
name|ahc
operator|->
name|flags
operator||=
name|AHC_TERM_ENB_A
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ahc_aic7770_VL_setup
parameter_list|(
name|ahc_dev_softc_t
name|dev
parameter_list|,
name|struct
name|ahc_probe_config
modifier|*
name|probe_config
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|ahc_aic7770_setup
argument_list|(
name|dev
argument_list|,
name|probe_config
argument_list|)
expr_stmt|;
name|probe_config
operator|->
name|chip
operator||=
name|AHC_VL
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahc_aic7770_EISA_setup
parameter_list|(
name|ahc_dev_softc_t
name|dev
parameter_list|,
name|struct
name|ahc_probe_config
modifier|*
name|probe_config
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|ahc_aic7770_setup
argument_list|(
name|dev
argument_list|,
name|probe_config
argument_list|)
expr_stmt|;
name|probe_config
operator|->
name|chip
operator||=
name|AHC_EISA
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ahc_aic7770_setup
parameter_list|(
name|ahc_dev_softc_t
name|dev
parameter_list|,
name|struct
name|ahc_probe_config
modifier|*
name|probe_config
parameter_list|)
block|{
name|probe_config
operator|->
name|channel
operator|=
literal|'A'
expr_stmt|;
name|probe_config
operator|->
name|channel_b
operator|=
literal|'B'
expr_stmt|;
name|probe_config
operator|->
name|chip
operator|=
name|AHC_AIC7770
expr_stmt|;
name|probe_config
operator|->
name|features
operator|=
name|AHC_AIC7770_FE
expr_stmt|;
name|probe_config
operator|->
name|bugs
operator||=
name|AHC_TMODE_WIDEODD_BUG
expr_stmt|;
name|probe_config
operator|->
name|flags
operator||=
name|AHC_PAGESCBS
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


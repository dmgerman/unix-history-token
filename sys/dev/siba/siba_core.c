begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2010 Weongyo Jeong<weongyo@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    similar to the "NO WARRANTY" disclaimer below ("Disclaimer") and any  *    redistribution must be conditioned upon including a substantially  *    similar Disclaimer requirement for further binary redistribution.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF NONINFRINGEMENT, MERCHANTIBILITY  * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL  * THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY,  * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER  * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGES.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * the Sonics Silicon Backplane driver.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/siba_ids.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/sibareg.h>
end_include

begin_include
include|#
directive|include
file|<dev/siba/sibavar.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SIBA_DEBUG
end_ifdef

begin_enum
enum|enum
block|{
name|SIBA_DEBUG_SCAN
init|=
literal|0x00000001
block|,
comment|/* scan */
name|SIBA_DEBUG_PMU
init|=
literal|0x00000002
block|,
comment|/* PMU */
name|SIBA_DEBUG_PLL
init|=
literal|0x00000004
block|,
comment|/* PLL */
name|SIBA_DEBUG_SWITCHCORE
init|=
literal|0x00000008
block|,
comment|/* switching core */
name|SIBA_DEBUG_SPROM
init|=
literal|0x00000010
block|,
comment|/* SPROM */
name|SIBA_DEBUG_CORE
init|=
literal|0x00000020
block|,
comment|/* handling cores */
name|SIBA_DEBUG_ANY
init|=
literal|0xffffffff
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|siba
parameter_list|,
name|m
parameter_list|,
name|fmt
parameter_list|,
modifier|...
parameter_list|)
value|do {			\ 	if (siba->siba_debug& (m))			\ 		printf(fmt, __VA_ARGS__);		\ } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|siba
parameter_list|,
name|m
parameter_list|,
name|fmt
parameter_list|,
modifier|...
parameter_list|)
value|do { (void) siba; } while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof(a[0]))
end_define

begin_function_decl
specifier|static
name|void
name|siba_pci_gpio
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_scan
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siba_switchcore
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siba_pci_switchcore_sub
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|siba_scan_read_4
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|siba_dev2chipid
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|siba_pci_read_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|siba_pci_read_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pci_write_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pci_write_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_cc_clock
parameter_list|(
name|struct
name|siba_cc
modifier|*
parameter_list|,
name|enum
name|siba_clock
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_cc_pmu_init
parameter_list|(
name|struct
name|siba_cc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_cc_power_init
parameter_list|(
name|struct
name|siba_cc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_cc_powerup_delay
parameter_list|(
name|struct
name|siba_cc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siba_cc_clockfreq
parameter_list|(
name|struct
name|siba_cc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_cc_pmu1_pll0_init
parameter_list|(
name|struct
name|siba_cc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_cc_pmu0_pll0_init
parameter_list|(
name|struct
name|siba_cc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|enum
name|siba_clksrc
name|siba_cc_clksrc
parameter_list|(
name|struct
name|siba_cc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|struct
name|siba_cc_pmu1_plltab
modifier|*
name|siba_cc_pmu1_plltab_find
parameter_list|(
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|siba_cc_pll_read
parameter_list|(
name|struct
name|siba_cc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_cc_pll_write
parameter_list|(
name|struct
name|siba_cc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|struct
name|siba_cc_pmu0_plltab
modifier|*
name|siba_cc_pmu0_plltab_findentry
parameter_list|(
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siba_pci_sprom
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|,
name|struct
name|siba_sprom
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siba_sprom_read
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|,
name|uint16_t
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sprom_check_crc
parameter_list|(
specifier|const
name|uint16_t
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|siba_crc8
parameter_list|(
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_sprom_r123
parameter_list|(
name|struct
name|siba_sprom
modifier|*
parameter_list|,
specifier|const
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_sprom_r45
parameter_list|(
name|struct
name|siba_sprom
modifier|*
parameter_list|,
specifier|const
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_sprom_r8
parameter_list|(
name|struct
name|siba_sprom
modifier|*
parameter_list|,
specifier|const
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int8_t
name|siba_sprom_r123_antgain
parameter_list|(
name|uint8_t
parameter_list|,
specifier|const
name|uint16_t
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|siba_tmslow_reject_bitmask
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|siba_pcicore_read_4
parameter_list|(
name|struct
name|siba_pci
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pcicore_write_4
parameter_list|(
name|struct
name|siba_pci
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|siba_pcie_read
parameter_list|(
name|struct
name|siba_pci
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pcie_write
parameter_list|(
name|struct
name|siba_pci
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pcie_mdio_write
parameter_list|(
name|struct
name|siba_pci
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pci_read_multi_1
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pci_read_multi_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pci_read_multi_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pci_write_multi_1
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pci_write_multi_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pci_write_multi_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|siba_core_name
parameter_list|(
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siba_pcicore_init
parameter_list|(
name|struct
name|siba_pci
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|device_t
name|siba_add_child
parameter_list|(
name|device_t
parameter_list|,
name|struct
name|siba_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|siba_core_attach
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|siba_core_detach
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|siba_core_suspend
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|siba_core_resume
parameter_list|(
name|struct
name|siba_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|uint8_t
name|siba_getncores
parameter_list|(
name|device_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|siba_bus_ops
name|siba_pci_ops
init|=
block|{
operator|.
name|read_2
operator|=
name|siba_pci_read_2
block|,
operator|.
name|read_4
operator|=
name|siba_pci_read_4
block|,
operator|.
name|write_2
operator|=
name|siba_pci_write_2
block|,
operator|.
name|write_4
operator|=
name|siba_pci_write_4
block|,
operator|.
name|read_multi_1
operator|=
name|siba_pci_read_multi_1
block|,
operator|.
name|read_multi_2
operator|=
name|siba_pci_read_multi_2
block|,
operator|.
name|read_multi_4
operator|=
name|siba_pci_read_multi_4
block|,
operator|.
name|write_multi_1
operator|=
name|siba_pci_write_multi_1
block|,
operator|.
name|write_multi_2
operator|=
name|siba_pci_write_multi_2
block|,
operator|.
name|write_multi_4
operator|=
name|siba_pci_write_multi_4
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|siba_cc_pmu_res_updown
name|siba_cc_pmu_4325_updown
index|[]
init|=
name|SIBA_CC_PMU_4325_RES_UPDOWN
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|siba_cc_pmu_res_depend
name|siba_cc_pmu_4325_depend
index|[]
init|=
name|SIBA_CC_PMU_4325_RES_DEPEND
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|siba_cc_pmu_res_updown
name|siba_cc_pmu_4328_updown
index|[]
init|=
name|SIBA_CC_PMU_4328_RES_UPDOWN
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|siba_cc_pmu_res_depend
name|siba_cc_pmu_4328_depend
index|[]
init|=
name|SIBA_CC_PMU_4328_RES_DEPEND
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|siba_cc_pmu0_plltab
name|siba_cc_pmu0_plltab
index|[]
init|=
name|SIBA_CC_PMU0_PLLTAB_ENTRY
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|siba_cc_pmu1_plltab
name|siba_cc_pmu1_plltab
index|[]
init|=
name|SIBA_CC_PMU1_PLLTAB_ENTRY
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|siba_core_attach
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|)
block|{
name|struct
name|siba_cc
modifier|*
name|scc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|KASSERT
argument_list|(
name|siba
operator|->
name|siba_type
operator|==
name|SIBA_TYPE_PCI
argument_list|,
operator|(
literal|"unsupported BUS type (%#x)"
operator|,
name|siba
operator|->
name|siba_type
operator|)
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_ops
operator|=
operator|&
name|siba_pci_ops
expr_stmt|;
name|siba_pci_gpio
argument_list|(
name|siba
argument_list|,
name|SIBA_GPIO_CRYSTAL
operator||
name|SIBA_GPIO_PLL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|siba_scan
argument_list|(
name|siba
argument_list|)
expr_stmt|;
comment|/* XXX init PCI or PCMCIA host devices */
name|siba_powerup
argument_list|(
name|siba
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* init ChipCommon */
name|scc
operator|=
operator|&
name|siba
operator|->
name|siba_cc
expr_stmt|;
if|if
condition|(
name|scc
operator|->
name|scc_dev
operator|!=
name|NULL
condition|)
block|{
name|siba_cc_pmu_init
argument_list|(
name|scc
argument_list|)
expr_stmt|;
name|siba_cc_power_init
argument_list|(
name|scc
argument_list|)
expr_stmt|;
name|siba_cc_clock
argument_list|(
name|scc
argument_list|,
name|SIBA_CLOCK_FAST
argument_list|)
expr_stmt|;
name|siba_cc_powerup_delay
argument_list|(
name|scc
argument_list|)
expr_stmt|;
block|}
comment|/* fetch various internal informations for PCI */
name|siba
operator|->
name|siba_board_vendor
operator|=
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|PCIR_SUBVEND_0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_board_type
operator|=
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|PCIR_SUBDEV_0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_board_rev
operator|=
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|PCIR_REVID
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|error
operator|=
name|siba_pci_sprom
argument_list|(
name|siba
argument_list|,
operator|&
name|siba
operator|->
name|siba_sprom
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|siba_powerdown
argument_list|(
name|siba
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|siba_powerdown
argument_list|(
name|siba
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|siba_core_detach
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|)
block|{
name|device_t
modifier|*
name|devlistp
decl_stmt|;
name|int
name|devcnt
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
name|device_get_children
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
operator|&
name|devlistp
argument_list|,
operator|&
name|devcnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|devcnt
condition|;
name|i
operator|++
control|)
name|device_delete_child
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|devlistp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|devlistp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pci_gpio
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|,
name|uint32_t
name|what
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|uint32_t
name|in
decl_stmt|,
name|out
decl_stmt|;
name|uint16_t
name|status
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_type
operator|!=
name|SIBA_TYPE_PCI
condition|)
return|return;
name|out
operator|=
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_GPIO_OUT
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|on
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|what
operator|&
name|SIBA_GPIO_PLL
condition|)
name|out
operator||=
name|SIBA_GPIO_PLL
expr_stmt|;
if|if
condition|(
name|what
operator|&
name|SIBA_GPIO_CRYSTAL
condition|)
name|out
operator|&=
operator|~
name|SIBA_GPIO_CRYSTAL
expr_stmt|;
name|pci_write_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_GPIO_OUT
argument_list|,
name|out
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_GPIO_OUT_EN
argument_list|,
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_GPIO_OUT_EN
argument_list|,
literal|4
argument_list|)
operator||
name|what
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return;
block|}
name|in
operator|=
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_GPIO_IN
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|in
operator|&
name|SIBA_GPIO_CRYSTAL
operator|)
operator|!=
name|SIBA_GPIO_CRYSTAL
condition|)
block|{
if|if
condition|(
name|what
operator|&
name|SIBA_GPIO_CRYSTAL
condition|)
block|{
name|out
operator||=
name|SIBA_GPIO_CRYSTAL
expr_stmt|;
if|if
condition|(
name|what
operator|&
name|SIBA_GPIO_PLL
condition|)
name|out
operator||=
name|SIBA_GPIO_PLL
expr_stmt|;
name|pci_write_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_GPIO_OUT
argument_list|,
name|out
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_GPIO_OUT_EN
argument_list|,
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_GPIO_OUT_EN
argument_list|,
literal|4
argument_list|)
operator||
name|what
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|what
operator|&
name|SIBA_GPIO_PLL
condition|)
block|{
name|out
operator|&=
operator|~
name|SIBA_GPIO_PLL
expr_stmt|;
name|pci_write_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_GPIO_OUT
argument_list|,
name|out
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5000
argument_list|)
expr_stmt|;
block|}
block|}
name|status
operator|=
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|PCIR_STATUS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|status
operator|&=
operator|~
name|PCIM_STATUS_STABORT
expr_stmt|;
name|pci_write_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|PCIR_STATUS
argument_list|,
name|status
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_scan
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|)
block|{
name|struct
name|siba_dev_softc
modifier|*
name|sd
decl_stmt|;
name|uint32_t
name|idhi
decl_stmt|,
name|tmp
decl_stmt|;
name|int
name|base
decl_stmt|,
name|dev_i
init|=
literal|0
decl_stmt|,
name|error
decl_stmt|,
name|i
decl_stmt|,
name|is_pcie
decl_stmt|,
name|n_80211
init|=
literal|0
decl_stmt|,
name|n_cc
init|=
literal|0
decl_stmt|,
name|n_pci
init|=
literal|0
decl_stmt|;
name|KASSERT
argument_list|(
name|siba
operator|->
name|siba_type
operator|==
name|SIBA_TYPE_PCI
argument_list|,
operator|(
literal|"unsupported BUS type (%#x)"
operator|,
name|siba
operator|->
name|siba_type
operator|)
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_ndevs
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|siba_switchcore
argument_list|(
name|siba
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* need the first core */
if|if
condition|(
name|error
condition|)
return|return;
name|idhi
operator|=
name|siba_scan_read_4
argument_list|(
name|siba
argument_list|,
literal|0
argument_list|,
name|SIBA_IDHIGH
argument_list|)
expr_stmt|;
if|if
condition|(
name|SIBA_IDHIGH_CORECODE
argument_list|(
name|idhi
argument_list|)
operator|==
name|SIBA_DEVID_CHIPCOMMON
condition|)
block|{
name|tmp
operator|=
name|siba_scan_read_4
argument_list|(
name|siba
argument_list|,
literal|0
argument_list|,
name|SIBA_CC_CHIPID
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_chipid
operator|=
name|SIBA_CC_ID
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_chiprev
operator|=
name|SIBA_CC_REV
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_chippkg
operator|=
name|SIBA_CC_PKG
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|SIBA_IDHIGH_REV
argument_list|(
name|idhi
argument_list|)
operator|>=
literal|4
condition|)
name|siba
operator|->
name|siba_ndevs
operator|=
name|SIBA_CC_NCORES
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_cc
operator|.
name|scc_caps
operator|=
name|siba_scan_read_4
argument_list|(
name|siba
argument_list|,
literal|0
argument_list|,
name|SIBA_CC_CAPS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|siba
operator|->
name|siba_type
operator|==
name|SIBA_TYPE_PCI
condition|)
block|{
name|siba
operator|->
name|siba_chipid
operator|=
name|siba_dev2chipid
argument_list|(
name|siba
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_chiprev
operator|=
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|PCIR_REVID
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_chippkg
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|siba
operator|->
name|siba_chipid
operator|=
literal|0x4710
expr_stmt|;
name|siba
operator|->
name|siba_chiprev
operator|=
literal|0
expr_stmt|;
name|siba
operator|->
name|siba_chippkg
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|siba
operator|->
name|siba_ndevs
operator|==
literal|0
condition|)
name|siba
operator|->
name|siba_ndevs
operator|=
name|siba_getncores
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|siba
operator|->
name|siba_chipid
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_ndevs
operator|>
name|SIBA_MAX_CORES
condition|)
block|{
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"too many siba cores (max %d %d)\n"
argument_list|,
name|SIBA_MAX_CORES
argument_list|,
name|siba
operator|->
name|siba_ndevs
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* looking basic information about each cores/devices */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|siba
operator|->
name|siba_ndevs
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|siba_switchcore
argument_list|(
name|siba
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return;
name|sd
operator|=
operator|&
operator|(
name|siba
operator|->
name|siba_devs
index|[
name|dev_i
index|]
operator|)
expr_stmt|;
name|idhi
operator|=
name|siba_scan_read_4
argument_list|(
name|siba
argument_list|,
name|i
argument_list|,
name|SIBA_IDHIGH
argument_list|)
expr_stmt|;
name|sd
operator|->
name|sd_bus
operator|=
name|siba
expr_stmt|;
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
operator|=
name|SIBA_IDHIGH_CORECODE
argument_list|(
name|idhi
argument_list|)
expr_stmt|;
name|sd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|=
name|SIBA_IDHIGH_REV
argument_list|(
name|idhi
argument_list|)
expr_stmt|;
name|sd
operator|->
name|sd_id
operator|.
name|sd_vendor
operator|=
name|SIBA_IDHIGH_VENDOR
argument_list|(
name|idhi
argument_list|)
expr_stmt|;
name|sd
operator|->
name|sd_ops
operator|=
name|siba
operator|->
name|siba_ops
expr_stmt|;
name|sd
operator|->
name|sd_coreidx
operator|=
name|i
expr_stmt|;
name|DPRINTF
argument_list|(
name|siba
argument_list|,
name|SIBA_DEBUG_SCAN
argument_list|,
literal|"core %d (%s) found (cc %#xrev %#x vendor %#x)\n"
argument_list|,
name|i
argument_list|,
name|siba_core_name
argument_list|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
argument_list|)
argument_list|,
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
argument_list|,
name|sd
operator|->
name|sd_id
operator|.
name|sd_rev
argument_list|,
name|sd
operator|->
name|sd_id
operator|.
name|vendor
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
condition|)
block|{
case|case
name|SIBA_DEVID_CHIPCOMMON
case|:
name|n_cc
operator|++
expr_stmt|;
if|if
condition|(
name|n_cc
operator|>
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"warn: multiple ChipCommon\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|siba
operator|->
name|siba_cc
operator|.
name|scc_dev
operator|=
name|sd
expr_stmt|;
break|break;
case|case
name|SIBA_DEVID_80211
case|:
name|n_80211
operator|++
expr_stmt|;
if|if
condition|(
name|n_80211
operator|>
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"warn: multiple 802.11 core\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
break|break;
case|case
name|SIBA_DEVID_PCI
case|:
case|case
name|SIBA_DEVID_PCIE
case|:
name|n_pci
operator|++
expr_stmt|;
name|error
operator|=
name|pci_find_extcap
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|PCIY_EXPRESS
argument_list|,
operator|&
name|base
argument_list|)
expr_stmt|;
name|is_pcie
operator|=
operator|(
name|error
operator|==
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|n_pci
operator|>
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"warn: multiple PCI(E) cores\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
operator|==
name|SIBA_DEVID_PCI
operator|&&
name|is_pcie
operator|==
literal|1
condition|)
continue|continue;
if|if
condition|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
operator|==
name|SIBA_DEVID_PCIE
operator|&&
name|is_pcie
operator|==
literal|0
condition|)
continue|continue;
name|siba
operator|->
name|siba_pci
operator|.
name|spc_dev
operator|=
name|sd
expr_stmt|;
break|break;
case|case
name|SIBA_DEVID_MODEM
case|:
case|case
name|SIBA_DEVID_PCMCIA
case|:
break|break;
default|default:
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"unsupported coreid (%s)\n"
argument_list|,
name|siba_core_name
argument_list|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|dev_i
operator|++
expr_stmt|;
block|}
name|siba
operator|->
name|siba_ndevs
operator|=
name|dev_i
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|siba_switchcore
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|,
name|uint8_t
name|idx
parameter_list|)
block|{
switch|switch
condition|(
name|siba
operator|->
name|siba_type
condition|)
block|{
case|case
name|SIBA_TYPE_PCI
case|:
return|return
operator|(
name|siba_pci_switchcore_sub
argument_list|(
name|siba
argument_list|,
name|idx
argument_list|)
operator|)
return|;
default|default:
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: unsupported bustype %#x"
operator|,
name|__func__
operator|,
name|siba
operator|->
name|siba_type
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siba_pci_switchcore_sub
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|,
name|uint8_t
name|idx
parameter_list|)
block|{
define|#
directive|define
name|RETRY_MAX
value|50
name|int
name|i
decl_stmt|;
name|uint32_t
name|dir
decl_stmt|;
name|dir
operator|=
name|SIBA_REGWIN
argument_list|(
name|idx
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RETRY_MAX
condition|;
name|i
operator|++
control|)
block|{
name|pci_write_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_BAR0
argument_list|,
name|dir
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_BAR0
argument_list|,
literal|4
argument_list|)
operator|==
name|dir
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ENODEV
operator|)
return|;
undef|#
directive|undef
name|RETRY_MAX
block|}
end_function

begin_function
specifier|static
name|int
name|siba_pci_switchcore
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|,
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|DPRINTF
argument_list|(
name|siba
argument_list|,
name|SIBA_DEBUG_SWITCHCORE
argument_list|,
literal|"Switching to %s core, index %d\n"
argument_list|,
name|siba_core_name
argument_list|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
argument_list|)
argument_list|,
name|sd
operator|->
name|sd_coreidx
argument_list|)
expr_stmt|;
name|error
operator|=
name|siba_pci_switchcore_sub
argument_list|(
name|siba
argument_list|,
name|sd
operator|->
name|sd_coreidx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|siba
operator|->
name|siba_curdev
operator|=
name|sd
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|siba_scan_read_4
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|,
name|uint8_t
name|coreidx
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
operator|(
name|void
operator|)
name|coreidx
expr_stmt|;
name|KASSERT
argument_list|(
name|siba
operator|->
name|siba_type
operator|==
name|SIBA_TYPE_PCI
argument_list|,
operator|(
literal|"unsupported BUS type (%#x)"
operator|,
name|siba
operator|->
name|siba_type
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|SIBA_READ_4
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|siba_dev2chipid
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|)
block|{
name|uint16_t
name|chipid
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|siba
operator|->
name|siba_pci_did
condition|)
block|{
case|case
literal|0x4301
case|:
name|chipid
operator|=
literal|0x4301
expr_stmt|;
break|break;
case|case
literal|0x4305
case|:
case|case
literal|0x4306
case|:
case|case
literal|0x4307
case|:
name|chipid
operator|=
literal|0x4307
expr_stmt|;
break|break;
case|case
literal|0x4403
case|:
name|chipid
operator|=
literal|0x4402
expr_stmt|;
break|break;
case|case
literal|0x4610
case|:
case|case
literal|0x4611
case|:
case|case
literal|0x4612
case|:
case|case
literal|0x4613
case|:
case|case
literal|0x4614
case|:
case|case
literal|0x4615
case|:
name|chipid
operator|=
literal|0x4610
expr_stmt|;
break|break;
case|case
literal|0x4710
case|:
case|case
literal|0x4711
case|:
case|case
literal|0x4712
case|:
case|case
literal|0x4713
case|:
case|case
literal|0x4714
case|:
case|case
literal|0x4715
case|:
name|chipid
operator|=
literal|0x4710
expr_stmt|;
break|break;
case|case
literal|0x4320
case|:
case|case
literal|0x4321
case|:
case|case
literal|0x4322
case|:
case|case
literal|0x4323
case|:
case|case
literal|0x4324
case|:
case|case
literal|0x4325
case|:
name|chipid
operator|=
literal|0x4309
expr_stmt|;
break|break;
case|case
name|PCI_DEVICE_ID_BCM4401
case|:
case|case
name|PCI_DEVICE_ID_BCM4401B0
case|:
case|case
name|PCI_DEVICE_ID_BCM4401B1
case|:
name|chipid
operator|=
literal|0x4401
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"unknown PCI did (%d)\n"
argument_list|,
name|siba
operator|->
name|siba_pci_did
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|chipid
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Earlier ChipCommon revisions have hardcoded number of cores  * present dependent on the ChipCommon ID.  */
end_comment

begin_function
name|uint8_t
name|siba_getncores
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint16_t
name|chipid
parameter_list|)
block|{
switch|switch
condition|(
name|chipid
condition|)
block|{
case|case
literal|0x4401
case|:
case|case
literal|0x4402
case|:
return|return
operator|(
literal|3
operator|)
return|;
case|case
literal|0x4301
case|:
case|case
literal|0x4307
case|:
return|return
operator|(
literal|5
operator|)
return|;
case|case
literal|0x4306
case|:
return|return
operator|(
literal|6
operator|)
return|;
case|case
name|SIBA_CCID_SENTRY5
case|:
return|return
operator|(
literal|7
operator|)
return|;
case|case
literal|0x4310
case|:
return|return
operator|(
literal|8
operator|)
return|;
case|case
name|SIBA_CCID_BCM4710
case|:
case|case
literal|0x4610
case|:
case|case
name|SIBA_CCID_BCM4704
case|:
return|return
operator|(
literal|9
operator|)
return|;
default|default:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unknown the chipset ID %#x\n"
argument_list|,
name|chipid
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|siba_core_name
parameter_list|(
name|uint16_t
name|coreid
parameter_list|)
block|{
switch|switch
condition|(
name|coreid
condition|)
block|{
case|case
name|SIBA_DEVID_CHIPCOMMON
case|:
return|return
operator|(
literal|"ChipCommon"
operator|)
return|;
case|case
name|SIBA_DEVID_ILINE20
case|:
return|return
operator|(
literal|"ILine 20"
operator|)
return|;
case|case
name|SIBA_DEVID_SDRAM
case|:
return|return
operator|(
literal|"SDRAM"
operator|)
return|;
case|case
name|SIBA_DEVID_PCI
case|:
return|return
operator|(
literal|"PCI"
operator|)
return|;
case|case
name|SIBA_DEVID_MIPS
case|:
return|return
operator|(
literal|"MIPS"
operator|)
return|;
case|case
name|SIBA_DEVID_ETHERNET
case|:
return|return
operator|(
literal|"Fast Ethernet"
operator|)
return|;
case|case
name|SIBA_DEVID_MODEM
case|:
return|return
operator|(
literal|"Modem"
operator|)
return|;
case|case
name|SIBA_DEVID_USB11_HOSTDEV
case|:
return|return
operator|(
literal|"USB 1.1 Hostdev"
operator|)
return|;
case|case
name|SIBA_DEVID_ADSL
case|:
return|return
operator|(
literal|"ADSL"
operator|)
return|;
case|case
name|SIBA_DEVID_ILINE100
case|:
return|return
operator|(
literal|"ILine 100"
operator|)
return|;
case|case
name|SIBA_DEVID_IPSEC
case|:
return|return
operator|(
literal|"IPSEC"
operator|)
return|;
case|case
name|SIBA_DEVID_PCMCIA
case|:
return|return
operator|(
literal|"PCMCIA"
operator|)
return|;
case|case
name|SIBA_DEVID_INTERNAL_MEM
case|:
return|return
operator|(
literal|"Internal Memory"
operator|)
return|;
case|case
name|SIBA_DEVID_SDRAMDDR
case|:
return|return
operator|(
literal|"MEMC SDRAM"
operator|)
return|;
case|case
name|SIBA_DEVID_EXTIF
case|:
return|return
operator|(
literal|"EXTIF"
operator|)
return|;
case|case
name|SIBA_DEVID_80211
case|:
return|return
operator|(
literal|"IEEE 802.11"
operator|)
return|;
case|case
name|SIBA_DEVID_MIPS_3302
case|:
return|return
operator|(
literal|"MIPS 3302"
operator|)
return|;
case|case
name|SIBA_DEVID_USB11_HOST
case|:
return|return
operator|(
literal|"USB 1.1 Host"
operator|)
return|;
case|case
name|SIBA_DEVID_USB11_DEV
case|:
return|return
operator|(
literal|"USB 1.1 Device"
operator|)
return|;
case|case
name|SIBA_DEVID_USB20_HOST
case|:
return|return
operator|(
literal|"USB 2.0 Host"
operator|)
return|;
case|case
name|SIBA_DEVID_USB20_DEV
case|:
return|return
operator|(
literal|"USB 2.0 Device"
operator|)
return|;
case|case
name|SIBA_DEVID_SDIO_HOST
case|:
return|return
operator|(
literal|"SDIO Host"
operator|)
return|;
case|case
name|SIBA_DEVID_ROBOSWITCH
case|:
return|return
operator|(
literal|"Roboswitch"
operator|)
return|;
case|case
name|SIBA_DEVID_PARA_ATA
case|:
return|return
operator|(
literal|"PATA"
operator|)
return|;
case|case
name|SIBA_DEVID_SATA_XORDMA
case|:
return|return
operator|(
literal|"SATA XOR-DMA"
operator|)
return|;
case|case
name|SIBA_DEVID_ETHERNET_GBIT
case|:
return|return
operator|(
literal|"GBit Ethernet"
operator|)
return|;
case|case
name|SIBA_DEVID_PCIE
case|:
return|return
operator|(
literal|"PCI-Express"
operator|)
return|;
case|case
name|SIBA_DEVID_MIMO_PHY
case|:
return|return
operator|(
literal|"MIMO PHY"
operator|)
return|;
case|case
name|SIBA_DEVID_SRAM_CTRLR
case|:
return|return
operator|(
literal|"SRAM Controller"
operator|)
return|;
case|case
name|SIBA_DEVID_MINI_MACPHY
case|:
return|return
operator|(
literal|"Mini MACPHY"
operator|)
return|;
case|case
name|SIBA_DEVID_ARM_1176
case|:
return|return
operator|(
literal|"ARM 1176"
operator|)
return|;
case|case
name|SIBA_DEVID_ARM_7TDMI
case|:
return|return
operator|(
literal|"ARM 7TDMI"
operator|)
return|;
block|}
return|return
operator|(
literal|"unknown"
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|siba_pci_read_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_curdev
operator|!=
name|sd
operator|&&
name|siba_pci_switchcore
argument_list|(
name|siba
argument_list|,
name|sd
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0xffff
operator|)
return|;
return|return
operator|(
name|SIBA_READ_2
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|siba_pci_read_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_curdev
operator|!=
name|sd
operator|&&
name|siba_pci_switchcore
argument_list|(
name|siba
argument_list|,
name|sd
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0xffff
operator|)
return|;
return|return
operator|(
name|SIBA_READ_4
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pci_write_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint16_t
name|value
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_curdev
operator|!=
name|sd
operator|&&
name|siba_pci_switchcore
argument_list|(
name|siba
argument_list|,
name|sd
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|SIBA_WRITE_2
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pci_write_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_curdev
operator|!=
name|sd
operator|&&
name|siba_pci_switchcore
argument_list|(
name|siba
argument_list|,
name|sd
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|SIBA_WRITE_4
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pci_read_multi_1
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_curdev
operator|!=
name|sd
operator|&&
name|siba_pci_switchcore
argument_list|(
name|siba
argument_list|,
name|sd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|memset
argument_list|(
name|buffer
argument_list|,
literal|0xff
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return;
block|}
name|SIBA_READ_MULTI_1
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|,
name|buffer
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pci_read_multi_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_curdev
operator|!=
name|sd
operator|&&
name|siba_pci_switchcore
argument_list|(
name|siba
argument_list|,
name|sd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|memset
argument_list|(
name|buffer
argument_list|,
literal|0xff
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return;
block|}
name|KASSERT
argument_list|(
operator|!
operator|(
name|count
operator|&
literal|1
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|SIBA_READ_MULTI_2
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|,
name|buffer
argument_list|,
name|count
operator|>>
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pci_read_multi_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_curdev
operator|!=
name|sd
operator|&&
name|siba_pci_switchcore
argument_list|(
name|siba
argument_list|,
name|sd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|memset
argument_list|(
name|buffer
argument_list|,
literal|0xff
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return;
block|}
name|KASSERT
argument_list|(
operator|!
operator|(
name|count
operator|&
literal|3
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|SIBA_READ_MULTI_4
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|,
name|buffer
argument_list|,
name|count
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pci_write_multi_1
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_curdev
operator|!=
name|sd
operator|&&
name|siba_pci_switchcore
argument_list|(
name|siba
argument_list|,
name|sd
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|SIBA_WRITE_MULTI_1
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|,
name|buffer
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pci_write_multi_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_curdev
operator|!=
name|sd
operator|&&
name|siba_pci_switchcore
argument_list|(
name|siba
argument_list|,
name|sd
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|KASSERT
argument_list|(
operator|!
operator|(
name|count
operator|&
literal|1
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|SIBA_WRITE_MULTI_2
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|,
name|buffer
argument_list|,
name|count
operator|>>
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pci_write_multi_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_curdev
operator|!=
name|sd
operator|&&
name|siba_pci_switchcore
argument_list|(
name|siba
argument_list|,
name|sd
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|KASSERT
argument_list|(
operator|!
operator|(
name|count
operator|&
literal|3
operator|)
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|SIBA_WRITE_MULTI_4
argument_list|(
name|siba
argument_list|,
name|offset
argument_list|,
name|buffer
argument_list|,
name|count
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|siba_powerup
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|,
name|int
name|dynamic
parameter_list|)
block|{
name|siba_pci_gpio
argument_list|(
name|siba
argument_list|,
name|SIBA_GPIO_CRYSTAL
operator||
name|SIBA_GPIO_PLL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|siba_cc_clock
argument_list|(
operator|&
name|siba
operator|->
name|siba_cc
argument_list|,
operator|(
name|dynamic
operator|!=
literal|0
operator|)
condition|?
name|SIBA_CLOCK_DYNAMIC
else|:
name|SIBA_CLOCK_FAST
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_cc_clock
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|,
name|enum
name|siba_clock
name|clock
parameter_list|)
block|{
name|struct
name|siba_dev_softc
modifier|*
name|sd
init|=
name|scc
operator|->
name|scc_dev
decl_stmt|;
name|struct
name|siba_softc
modifier|*
name|siba
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|sd
operator|==
name|NULL
condition|)
return|return;
name|siba
operator|=
name|sd
operator|->
name|sd_bus
expr_stmt|;
comment|/* 	 * chipcommon< r6 (no dynamic clock control) 	 * chipcommon>= r10 (unknown) 	 */
if|if
condition|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|<
literal|6
operator|||
name|sd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|>=
literal|10
operator|||
operator|(
name|scc
operator|->
name|scc_caps
operator|&
name|SIBA_CC_CAPS_PWCTL
operator|)
operator|==
literal|0
condition|)
return|return;
switch|switch
condition|(
name|clock
condition|)
block|{
case|case
name|SIBA_CLOCK_DYNAMIC
case|:
name|tmp
operator|=
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSLOW
argument_list|)
operator|&
operator|~
operator|(
name|SIBA_CC_CLKSLOW_ENXTAL
operator||
name|SIBA_CC_CLKSLOW_FSLOW
operator||
name|SIBA_CC_CLKSLOW_IPLL
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
name|SIBA_CC_CLKSLOW_SRC
operator|)
operator|!=
name|SIBA_CC_CLKSLOW_SRC_CRYSTAL
condition|)
name|tmp
operator||=
name|SIBA_CC_CLKSLOW_ENXTAL
expr_stmt|;
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSLOW
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|SIBA_CC_CLKSLOW_ENXTAL
condition|)
name|siba_pci_gpio
argument_list|(
name|siba
argument_list|,
name|SIBA_GPIO_CRYSTAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIBA_CLOCK_SLOW
case|:
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSLOW
argument_list|,
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSLOW
argument_list|)
operator||
name|SIBA_CC_CLKSLOW_FSLOW
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIBA_CLOCK_FAST
case|:
comment|/* crystal on */
name|siba_pci_gpio
argument_list|(
name|siba
argument_list|,
name|SIBA_GPIO_CRYSTAL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSLOW
argument_list|,
operator|(
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSLOW
argument_list|)
operator||
name|SIBA_CC_CLKSLOW_IPLL
operator|)
operator|&
operator|~
name|SIBA_CC_CLKSLOW_FSLOW
argument_list|)
expr_stmt|;
break|break;
default|default:
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: unsupported clock %#x"
operator|,
name|__func__
operator|,
name|clock
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|uint16_t
name|siba_read_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
return|return
operator|(
name|sd
operator|->
name|sd_ops
operator|->
name|read_2
argument_list|(
name|sd
argument_list|,
name|offset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|siba_read_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
return|return
operator|(
name|sd
operator|->
name|sd_ops
operator|->
name|read_4
argument_list|(
name|sd
argument_list|,
name|offset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|siba_write_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint16_t
name|value
parameter_list|)
block|{
name|sd
operator|->
name|sd_ops
operator|->
name|write_2
argument_list|(
name|sd
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|siba_write_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|sd
operator|->
name|sd_ops
operator|->
name|write_4
argument_list|(
name|sd
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|siba_read_multi_1
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|sd
operator|->
name|sd_ops
operator|->
name|read_multi_1
argument_list|(
name|sd
argument_list|,
name|buffer
argument_list|,
name|count
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|siba_read_multi_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|sd
operator|->
name|sd_ops
operator|->
name|read_multi_2
argument_list|(
name|sd
argument_list|,
name|buffer
argument_list|,
name|count
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|siba_read_multi_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|sd
operator|->
name|sd_ops
operator|->
name|read_multi_4
argument_list|(
name|sd
argument_list|,
name|buffer
argument_list|,
name|count
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|siba_write_multi_1
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|sd
operator|->
name|sd_ops
operator|->
name|write_multi_1
argument_list|(
name|sd
argument_list|,
name|buffer
argument_list|,
name|count
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|siba_write_multi_2
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|sd
operator|->
name|sd_ops
operator|->
name|write_multi_2
argument_list|(
name|sd
argument_list|,
name|buffer
argument_list|,
name|count
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|siba_write_multi_4
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
specifier|const
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|count
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|sd
operator|->
name|sd_ops
operator|->
name|write_multi_4
argument_list|(
name|sd
argument_list|,
name|buffer
argument_list|,
name|count
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_cc_pmu_init
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|)
block|{
specifier|const
name|struct
name|siba_cc_pmu_res_updown
modifier|*
name|updown
init|=
name|NULL
decl_stmt|;
specifier|const
name|struct
name|siba_cc_pmu_res_depend
modifier|*
name|depend
init|=
name|NULL
decl_stmt|;
name|struct
name|siba_dev_softc
modifier|*
name|sd
init|=
name|scc
operator|->
name|scc_dev
decl_stmt|;
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
name|uint32_t
name|min
init|=
literal|0
decl_stmt|,
name|max
init|=
literal|0
decl_stmt|,
name|pmucap
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|updown_size
decl_stmt|,
name|depend_size
decl_stmt|;
if|if
condition|(
operator|(
name|scc
operator|->
name|scc_caps
operator|&
name|SIBA_CC_CAPS_PMU
operator|)
operator|==
literal|0
condition|)
return|return;
name|pmucap
operator|=
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMUCAPS
argument_list|)
expr_stmt|;
name|scc
operator|->
name|scc_pmu
operator|.
name|rev
operator|=
operator|(
name|pmucap
operator|&
name|SIBA_CC_PMUCAPS_REV
operator|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|siba
argument_list|,
name|SIBA_DEBUG_PMU
argument_list|,
literal|"PMU(r%u) found (caps %#x)\n"
argument_list|,
name|scc
operator|->
name|scc_pmu
operator|.
name|rev
argument_list|,
name|pmucap
argument_list|)
expr_stmt|;
if|if
condition|(
name|scc
operator|->
name|scc_pmu
operator|.
name|rev
operator|>=
literal|1
condition|)
block|{
if|if
condition|(
name|siba
operator|->
name|siba_chiprev
operator|<
literal|2
operator|&&
name|siba
operator|->
name|siba_chipid
operator|==
literal|0x4325
condition|)
name|SIBA_CC_MASK32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMUCTL
argument_list|,
operator|~
name|SIBA_CC_PMUCTL_NOILP
argument_list|)
expr_stmt|;
else|else
name|SIBA_CC_SET32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMUCTL
argument_list|,
name|SIBA_CC_PMUCTL_NOILP
argument_list|)
expr_stmt|;
block|}
comment|/* initialize PLL& PMU resources */
switch|switch
condition|(
name|siba
operator|->
name|siba_chipid
condition|)
block|{
case|case
literal|0x4312
case|:
name|siba_cc_pmu1_pll0_init
argument_list|(
name|scc
argument_list|,
literal|0
comment|/* use default */
argument_list|)
expr_stmt|;
comment|/* use the default: min = 0xcbb max = 0x7ffff */
break|break;
case|case
literal|0x4325
case|:
name|siba_cc_pmu1_pll0_init
argument_list|(
name|scc
argument_list|,
literal|0
comment|/* use default */
argument_list|)
expr_stmt|;
name|updown
operator|=
name|siba_cc_pmu_4325_updown
expr_stmt|;
name|updown_size
operator|=
name|N
argument_list|(
name|siba_cc_pmu_4325_updown
argument_list|)
expr_stmt|;
name|depend
operator|=
name|siba_cc_pmu_4325_depend
expr_stmt|;
name|depend_size
operator|=
name|N
argument_list|(
name|siba_cc_pmu_4325_depend
argument_list|)
expr_stmt|;
name|min
operator|=
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4325_BURST
operator|)
operator||
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4325_LN
operator|)
expr_stmt|;
if|if
condition|(
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CHIPSTAT
argument_list|)
operator|&
name|SIBA_CC_CHST_4325_PMUTOP_2B
condition|)
name|min
operator||=
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4325_CLBURST
operator|)
expr_stmt|;
name|max
operator|=
literal|0xfffff
expr_stmt|;
break|break;
case|case
literal|0x4328
case|:
name|siba_cc_pmu0_pll0_init
argument_list|(
name|scc
argument_list|,
literal|0
comment|/* use default */
argument_list|)
expr_stmt|;
name|updown
operator|=
name|siba_cc_pmu_4328_updown
expr_stmt|;
name|updown_size
operator|=
name|N
argument_list|(
name|siba_cc_pmu_4328_updown
argument_list|)
expr_stmt|;
name|depend
operator|=
name|siba_cc_pmu_4328_depend
expr_stmt|;
name|depend_size
operator|=
name|N
argument_list|(
name|siba_cc_pmu_4328_depend
argument_list|)
expr_stmt|;
name|min
operator|=
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4328_EXT_SWITCH_PWM
operator|)
operator||
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4328_BB_SWITCH_PWM
operator|)
operator||
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4328_CRYSTAL_EN
operator|)
expr_stmt|;
name|max
operator|=
literal|0xfffff
expr_stmt|;
break|break;
case|case
literal|0x5354
case|:
name|siba_cc_pmu0_pll0_init
argument_list|(
name|scc
argument_list|,
literal|0
comment|/* use default */
argument_list|)
expr_stmt|;
name|max
operator|=
literal|0xfffff
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"unknown chipid %#x for PLL& PMU init\n"
argument_list|,
name|siba
operator|->
name|siba_chipid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|updown
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|updown_size
condition|;
name|i
operator|++
control|)
block|{
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_TABSEL
argument_list|,
name|updown
index|[
name|i
index|]
operator|.
name|res
argument_list|)
expr_stmt|;
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_UPDNTM
argument_list|,
name|updown
index|[
name|i
index|]
operator|.
name|updown
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|depend
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|depend_size
condition|;
name|i
operator|++
control|)
block|{
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_TABSEL
argument_list|,
name|depend
index|[
name|i
index|]
operator|.
name|res
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|depend
index|[
name|i
index|]
operator|.
name|task
condition|)
block|{
case|case
name|SIBA_CC_PMU_DEP_SET
case|:
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_DEPMSK
argument_list|,
name|depend
index|[
name|i
index|]
operator|.
name|depend
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIBA_CC_PMU_DEP_ADD
case|:
name|SIBA_CC_SET32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_DEPMSK
argument_list|,
name|depend
index|[
name|i
index|]
operator|.
name|depend
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIBA_CC_PMU_DEP_REMOVE
case|:
name|SIBA_CC_MASK32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_DEPMSK
argument_list|,
operator|~
operator|(
name|depend
index|[
name|i
index|]
operator|.
name|depend
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: assertion failed"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|min
condition|)
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_MINRES
argument_list|,
name|min
argument_list|)
expr_stmt|;
if|if
condition|(
name|max
condition|)
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_MAXRES
argument_list|,
name|max
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_cc_power_init
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|scc
operator|->
name|scc_dev
operator|->
name|sd_bus
decl_stmt|;
name|int
name|maxfreq
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_chipid
operator|==
literal|0x4321
condition|)
block|{
if|if
condition|(
name|siba
operator|->
name|siba_chiprev
operator|==
literal|0
condition|)
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CHIPCTL
argument_list|,
literal|0x3a4
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|siba
operator|->
name|siba_chiprev
operator|==
literal|1
condition|)
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CHIPCTL
argument_list|,
literal|0xa4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|scc
operator|->
name|scc_caps
operator|&
name|SIBA_CC_CAPS_PWCTL
operator|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|scc
operator|->
name|scc_dev
operator|->
name|sd_id
operator|.
name|sd_rev
operator|>=
literal|10
condition|)
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSYSCTL
argument_list|,
operator|(
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSYSCTL
argument_list|)
operator|&
literal|0xffff
operator|)
operator||
literal|0x40000
argument_list|)
expr_stmt|;
else|else
block|{
name|maxfreq
operator|=
name|siba_cc_clockfreq
argument_list|(
name|scc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PLLONDELAY
argument_list|,
operator|(
name|maxfreq
operator|*
literal|150
operator|+
literal|999999
operator|)
operator|/
literal|1000000
argument_list|)
expr_stmt|;
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_FREFSELDELAY
argument_list|,
operator|(
name|maxfreq
operator|*
literal|15
operator|+
literal|999999
operator|)
operator|/
literal|1000000
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|siba_cc_powerup_delay
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|scc
operator|->
name|scc_dev
operator|->
name|sd_bus
decl_stmt|;
name|int
name|min
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_type
operator|!=
name|SIBA_TYPE_PCI
operator|||
operator|!
operator|(
name|scc
operator|->
name|scc_caps
operator|&
name|SIBA_CC_CAPS_PWCTL
operator|)
condition|)
return|return;
name|min
operator|=
name|siba_cc_clockfreq
argument_list|(
name|scc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|scc
operator|->
name|scc_powerup_delay
operator|=
operator|(
operator|(
operator|(
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PLLONDELAY
argument_list|)
operator|+
literal|2
operator|)
operator|*
literal|1000000
operator|)
operator|+
operator|(
name|min
operator|-
literal|1
operator|)
operator|)
operator|/
name|min
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|siba_cc_clockfreq
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|enum
name|siba_clksrc
name|src
decl_stmt|;
name|int
name|div
init|=
literal|1
decl_stmt|,
name|limit
init|=
literal|0
decl_stmt|;
name|src
operator|=
name|siba_cc_clksrc
argument_list|(
name|scc
argument_list|)
expr_stmt|;
if|if
condition|(
name|scc
operator|->
name|scc_dev
operator|->
name|sd_id
operator|.
name|sd_rev
operator|<
literal|6
condition|)
block|{
name|div
operator|=
operator|(
name|src
operator|==
name|SIBA_CC_CLKSRC_PCI
operator|)
condition|?
literal|64
else|:
operator|(
name|src
operator|==
name|SIBA_CC_CLKSRC_CRYSTAL
operator|)
condition|?
literal|32
else|:
literal|1
expr_stmt|;
name|KASSERT
argument_list|(
name|div
operator|!=
literal|1
argument_list|,
operator|(
literal|"%s: unknown clock %d"
operator|,
name|__func__
operator|,
name|src
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|scc
operator|->
name|scc_dev
operator|->
name|sd_id
operator|.
name|sd_rev
operator|<
literal|10
condition|)
block|{
switch|switch
condition|(
name|src
condition|)
block|{
case|case
name|SIBA_CC_CLKSRC_CRYSTAL
case|:
case|case
name|SIBA_CC_CLKSRC_PCI
case|:
name|div
operator|=
operator|(
operator|(
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSLOW
argument_list|)
operator|>>
literal|16
operator|)
operator|+
literal|1
operator|)
operator|*
literal|4
expr_stmt|;
break|break;
case|case
name|SIBA_CC_CLKSRC_LOWPW
case|:
break|break;
block|}
block|}
else|else
name|div
operator|=
operator|(
operator|(
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSYSCTL
argument_list|)
operator|>>
literal|16
operator|)
operator|+
literal|1
operator|)
operator|*
literal|4
expr_stmt|;
switch|switch
condition|(
name|src
condition|)
block|{
case|case
name|SIBA_CC_CLKSRC_CRYSTAL
case|:
name|limit
operator|=
operator|(
name|max
operator|)
condition|?
literal|20200000
else|:
literal|19800000
expr_stmt|;
break|break;
case|case
name|SIBA_CC_CLKSRC_LOWPW
case|:
name|limit
operator|=
operator|(
name|max
operator|)
condition|?
literal|43000
else|:
literal|25000
expr_stmt|;
break|break;
case|case
name|SIBA_CC_CLKSRC_PCI
case|:
name|limit
operator|=
operator|(
name|max
operator|)
condition|?
literal|34000000
else|:
literal|25000000
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|limit
operator|/
name|div
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_cc_pmu1_pll0_init
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|,
name|uint32_t
name|freq
parameter_list|)
block|{
name|struct
name|siba_dev_softc
modifier|*
name|sd
init|=
name|scc
operator|->
name|scc_dev
decl_stmt|;
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
specifier|const
name|struct
name|siba_cc_pmu1_plltab
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|bufsth
init|=
literal|0
decl_stmt|,
name|pll
decl_stmt|,
name|pmu
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|KASSERT
argument_list|(
name|freq
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d: assertion vail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_chipid
operator|==
literal|0x4312
condition|)
block|{
name|scc
operator|->
name|scc_pmu
operator|.
name|freq
operator|=
literal|20000
expr_stmt|;
return|return;
block|}
name|e
operator|=
name|siba_cc_pmu1_plltab_find
argument_list|(
name|SIBA_CC_PMU1_DEFAULT_FREQ
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|e
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s:%d: assertion vail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|scc
operator|->
name|scc_pmu
operator|.
name|freq
operator|=
name|e
operator|->
name|freq
expr_stmt|;
name|pmu
operator|=
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMUCTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|SIBA_CC_PMUCTL_XF_VAL
argument_list|(
name|pmu
argument_list|)
operator|==
name|e
operator|->
name|xf
condition|)
return|return;
name|DPRINTF
argument_list|(
name|siba
argument_list|,
name|SIBA_DEBUG_PLL
argument_list|,
literal|"change PLL value to %u.%03u MHz\n"
argument_list|,
operator|(
name|e
operator|->
name|freq
operator|/
literal|1000
operator|)
argument_list|,
operator|(
name|e
operator|->
name|freq
operator|%
literal|1000
operator|)
argument_list|)
expr_stmt|;
comment|/* turn PLL off */
switch|switch
condition|(
name|siba
operator|->
name|siba_chipid
condition|)
block|{
case|case
literal|0x4325
case|:
name|bufsth
operator|=
literal|0x222222
expr_stmt|;
name|SIBA_CC_MASK32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_MINRES
argument_list|,
operator|~
operator|(
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4325_BBPLL_PWR
operator|)
operator||
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4325_HT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SIBA_CC_MASK32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_MAXRES
argument_list|,
operator|~
operator|(
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4325_BBPLL_PWR
operator|)
operator||
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4325_HT
operator|)
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: assertion failed"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1500
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKCTLSTATUS
argument_list|)
operator|&
name|SIBA_CC_CLKCTLSTATUS_HT
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKCTLSTATUS
argument_list|)
operator|&
name|SIBA_CC_CLKCTLSTATUS_HT
condition|)
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"failed to turn PLL off!\n"
argument_list|)
expr_stmt|;
name|pll
operator|=
name|siba_cc_pll_read
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU1_PLL0
argument_list|)
expr_stmt|;
name|pll
operator|&=
operator|~
operator|(
name|SIBA_CC_PMU1_PLL0_P1DIV
operator||
name|SIBA_CC_PMU1_PLL0_P2DIV
operator|)
expr_stmt|;
name|pll
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|e
operator|->
name|p1div
operator|<<
literal|20
operator|)
operator|&
name|SIBA_CC_PMU1_PLL0_P1DIV
expr_stmt|;
name|pll
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|e
operator|->
name|p2div
operator|<<
literal|24
operator|)
operator|&
name|SIBA_CC_PMU1_PLL0_P2DIV
expr_stmt|;
name|siba_cc_pll_write
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU1_PLL0
argument_list|,
name|pll
argument_list|)
expr_stmt|;
name|pll
operator|=
name|siba_cc_pll_read
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU1_PLL2
argument_list|)
expr_stmt|;
name|pll
operator|&=
operator|~
operator|(
name|SIBA_CC_PMU1_PLL2_NDIVINT
operator||
name|SIBA_CC_PMU1_PLL2_NDIVMODE
operator|)
expr_stmt|;
name|pll
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|e
operator|->
name|ndiv_int
operator|<<
literal|20
operator|)
operator|&
name|SIBA_CC_PMU1_PLL2_NDIVINT
expr_stmt|;
name|pll
operator||=
operator|(
literal|1
operator|<<
literal|17
operator|)
operator|&
name|SIBA_CC_PMU1_PLL2_NDIVMODE
expr_stmt|;
name|siba_cc_pll_write
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU1_PLL2
argument_list|,
name|pll
argument_list|)
expr_stmt|;
name|pll
operator|=
name|siba_cc_pll_read
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU1_PLL3
argument_list|)
expr_stmt|;
name|pll
operator|&=
operator|~
name|SIBA_CC_PMU1_PLL3_NDIVFRAC
expr_stmt|;
name|pll
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|e
operator|->
name|ndiv_frac
operator|<<
literal|0
operator|)
operator|&
name|SIBA_CC_PMU1_PLL3_NDIVFRAC
expr_stmt|;
name|siba_cc_pll_write
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU1_PLL3
argument_list|,
name|pll
argument_list|)
expr_stmt|;
if|if
condition|(
name|bufsth
condition|)
block|{
name|pll
operator|=
name|siba_cc_pll_read
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU1_PLL5
argument_list|)
expr_stmt|;
name|pll
operator|&=
operator|~
name|SIBA_CC_PMU1_PLL5_CLKDRV
expr_stmt|;
name|pll
operator||=
operator|(
name|bufsth
operator|<<
literal|8
operator|)
operator|&
name|SIBA_CC_PMU1_PLL5_CLKDRV
expr_stmt|;
name|siba_cc_pll_write
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU1_PLL5
argument_list|,
name|pll
argument_list|)
expr_stmt|;
block|}
name|pmu
operator|=
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMUCTL
argument_list|)
expr_stmt|;
name|pmu
operator|&=
operator|~
operator|(
name|SIBA_CC_PMUCTL_ILP
operator||
name|SIBA_CC_PMUCTL_XF
operator|)
expr_stmt|;
name|pmu
operator||=
operator|(
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|e
operator|->
name|freq
operator|+
literal|127
operator|)
operator|/
literal|128
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator|&
name|SIBA_CC_PMUCTL_ILP
expr_stmt|;
name|pmu
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|e
operator|->
name|xf
operator|<<
literal|2
operator|)
operator|&
name|SIBA_CC_PMUCTL_XF
expr_stmt|;
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMUCTL
argument_list|,
name|pmu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_cc_pmu0_pll0_init
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|,
name|uint32_t
name|xtalfreq
parameter_list|)
block|{
name|struct
name|siba_dev_softc
modifier|*
name|sd
init|=
name|scc
operator|->
name|scc_dev
decl_stmt|;
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
specifier|const
name|struct
name|siba_cc_pmu0_plltab
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|pmu
decl_stmt|,
name|tmp
decl_stmt|,
name|pll
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|siba
operator|->
name|siba_chipid
operator|==
literal|0x5354
operator|)
operator|&&
operator|!
name|xtalfreq
condition|)
name|xtalfreq
operator|=
literal|25000
expr_stmt|;
if|if
condition|(
name|xtalfreq
condition|)
name|e
operator|=
name|siba_cc_pmu0_plltab_findentry
argument_list|(
name|xtalfreq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|e
condition|)
name|e
operator|=
name|siba_cc_pmu0_plltab_findentry
argument_list|(
name|SIBA_CC_PMU0_DEFAULT_XTALFREQ
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|e
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|xtalfreq
operator|=
name|e
operator|->
name|freq
expr_stmt|;
name|scc
operator|->
name|scc_pmu
operator|.
name|freq
operator|=
name|e
operator|->
name|freq
expr_stmt|;
name|pmu
operator|=
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMUCTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|pmu
operator|&
name|SIBA_CC_PMUCTL_XF
operator|)
operator|>>
literal|2
operator|)
operator|==
name|e
operator|->
name|xf
condition|)
return|return;
name|DPRINTF
argument_list|(
name|siba
argument_list|,
name|SIBA_DEBUG_PLL
argument_list|,
literal|"change PLL value to %u.%03u mhz\n"
argument_list|,
operator|(
name|xtalfreq
operator|/
literal|1000
operator|)
argument_list|,
operator|(
name|xtalfreq
operator|%
literal|1000
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|siba
operator|->
name|siba_chipid
operator|==
literal|0x4328
operator|||
name|siba
operator|->
name|siba_chipid
operator|==
literal|0x5354
argument_list|,
operator|(
literal|"%s:%d: fail"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|siba
operator|->
name|siba_chipid
condition|)
block|{
case|case
literal|0x4328
case|:
name|SIBA_CC_MASK32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_MINRES
argument_list|,
operator|~
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4328_BB_PLL_PU
operator|)
argument_list|)
expr_stmt|;
name|SIBA_CC_MASK32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_MAXRES
argument_list|,
operator|~
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_4328_BB_PLL_PU
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5354
case|:
name|SIBA_CC_MASK32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_MINRES
argument_list|,
operator|~
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_5354_BB_PLL_PU
operator|)
argument_list|)
expr_stmt|;
name|SIBA_CC_MASK32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU_MAXRES
argument_list|,
operator|~
operator|(
literal|1
operator|<<
name|SIBA_CC_PMU_5354_BB_PLL_PU
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|1500
init|;
name|i
condition|;
name|i
operator|--
control|)
block|{
name|tmp
operator|=
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKCTLSTATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|SIBA_CC_CLKCTLSTATUS_HT
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|tmp
operator|=
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKCTLSTATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|SIBA_CC_CLKCTLSTATUS_HT
condition|)
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"failed to turn PLL off!\n"
argument_list|)
expr_stmt|;
comment|/* set PDIV */
name|pll
operator|=
name|siba_cc_pll_read
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU0_PLL0
argument_list|)
expr_stmt|;
if|if
condition|(
name|xtalfreq
operator|>=
name|SIBA_CC_PMU0_PLL0_PDIV_FREQ
condition|)
name|pll
operator||=
name|SIBA_CC_PMU0_PLL0_PDIV_MSK
expr_stmt|;
else|else
name|pll
operator|&=
operator|~
name|SIBA_CC_PMU0_PLL0_PDIV_MSK
expr_stmt|;
name|siba_cc_pll_write
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU0_PLL0
argument_list|,
name|pll
argument_list|)
expr_stmt|;
comment|/* set WILD */
name|pll
operator|=
name|siba_cc_pll_read
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU0_PLL1
argument_list|)
expr_stmt|;
name|pll
operator|&=
operator|~
operator|(
name|SIBA_CC_PMU0_PLL1_STOPMOD
operator||
name|SIBA_CC_PMU0_PLL1_IMSK
operator||
name|SIBA_CC_PMU0_PLL1_FMSK
operator|)
expr_stmt|;
name|pll
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|e
operator|->
name|wb_int
operator|<<
literal|28
operator|)
operator|&
name|SIBA_CC_PMU0_PLL1_IMSK
expr_stmt|;
name|pll
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|e
operator|->
name|wb_frac
operator|<<
literal|8
operator|)
operator|&
name|SIBA_CC_PMU0_PLL1_FMSK
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|wb_frac
operator|==
literal|0
condition|)
name|pll
operator||=
name|SIBA_CC_PMU0_PLL1_STOPMOD
expr_stmt|;
name|siba_cc_pll_write
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU0_PLL1
argument_list|,
name|pll
argument_list|)
expr_stmt|;
comment|/* set WILD */
name|pll
operator|=
name|siba_cc_pll_read
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU0_PLL2
argument_list|)
expr_stmt|;
name|pll
operator|&=
operator|~
name|SIBA_CC_PMU0_PLL2_IMSKHI
expr_stmt|;
name|pll
operator||=
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|e
operator|->
name|wb_int
operator|>>
literal|4
operator|)
operator|<<
literal|0
operator|)
operator|&
name|SIBA_CC_PMU0_PLL2_IMSKHI
expr_stmt|;
name|siba_cc_pll_write
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMU0_PLL2
argument_list|,
name|pll
argument_list|)
expr_stmt|;
comment|/* set freq and divisor. */
name|pmu
operator|=
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMUCTL
argument_list|)
expr_stmt|;
name|pmu
operator|&=
operator|~
name|SIBA_CC_PMUCTL_ILP
expr_stmt|;
name|pmu
operator||=
operator|(
operator|(
operator|(
name|xtalfreq
operator|+
literal|127
operator|)
operator|/
literal|128
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator|&
name|SIBA_CC_PMUCTL_ILP
expr_stmt|;
name|pmu
operator|&=
operator|~
name|SIBA_CC_PMUCTL_XF
expr_stmt|;
name|pmu
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|e
operator|->
name|xf
operator|<<
literal|2
operator|)
operator|&
name|SIBA_CC_PMUCTL_XF
expr_stmt|;
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PMUCTL
argument_list|,
name|pmu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|siba_clksrc
name|siba_cc_clksrc
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|)
block|{
name|struct
name|siba_dev_softc
modifier|*
name|sd
init|=
name|scc
operator|->
name|scc_dev
decl_stmt|;
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|<
literal|6
condition|)
block|{
if|if
condition|(
name|siba
operator|->
name|siba_type
operator|==
name|SIBA_TYPE_PCI
condition|)
block|{
if|if
condition|(
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_GPIO_OUT
argument_list|,
literal|4
argument_list|)
operator|&
literal|0x10
condition|)
return|return
operator|(
name|SIBA_CC_CLKSRC_PCI
operator|)
return|;
return|return
operator|(
name|SIBA_CC_CLKSRC_CRYSTAL
operator|)
return|;
block|}
if|if
condition|(
name|siba
operator|->
name|siba_type
operator|==
name|SIBA_TYPE_SSB
operator|||
name|siba
operator|->
name|siba_type
operator|==
name|SIBA_TYPE_PCMCIA
condition|)
return|return
operator|(
name|SIBA_CC_CLKSRC_CRYSTAL
operator|)
return|;
block|}
if|if
condition|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|<
literal|10
condition|)
block|{
switch|switch
condition|(
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_CLKSLOW
argument_list|)
operator|&
literal|0x7
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
name|SIBA_CC_CLKSRC_LOWPW
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
name|SIBA_CC_CLKSRC_CRYSTAL
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
name|SIBA_CC_CLKSRC_PCI
operator|)
return|;
default|default:
break|break;
block|}
block|}
return|return
operator|(
name|SIBA_CC_CLKSRC_CRYSTAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|struct
name|siba_cc_pmu1_plltab
modifier|*
name|siba_cc_pmu1_plltab_find
parameter_list|(
name|uint32_t
name|crystalfreq
parameter_list|)
block|{
specifier|const
name|struct
name|siba_cc_pmu1_plltab
modifier|*
name|e
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|siba_cc_pmu1_plltab
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|e
operator|=
operator|&
name|siba_cc_pmu1_plltab
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|crystalfreq
operator|==
name|e
operator|->
name|freq
condition|)
return|return
operator|(
name|e
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|siba_cc_pll_read
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PLLCTL_ADDR
argument_list|,
name|offset
argument_list|)
expr_stmt|;
return|return
operator|(
name|SIBA_CC_READ32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PLLCTL_DATA
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_cc_pll_write
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PLLCTL_ADDR
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|SIBA_CC_WRITE32
argument_list|(
name|scc
argument_list|,
name|SIBA_CC_PLLCTL_DATA
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|struct
name|siba_cc_pmu0_plltab
modifier|*
name|siba_cc_pmu0_plltab_findentry
parameter_list|(
name|uint32_t
name|crystalfreq
parameter_list|)
block|{
specifier|const
name|struct
name|siba_cc_pmu0_plltab
modifier|*
name|e
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|siba_cc_pmu0_plltab
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|e
operator|=
operator|&
name|siba_cc_pmu0_plltab
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|freq
operator|==
name|crystalfreq
condition|)
return|return
operator|(
name|e
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siba_pci_sprom
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|,
name|struct
name|siba_sprom
modifier|*
name|sprom
parameter_list|)
block|{
name|int
name|error
init|=
name|ENOMEM
decl_stmt|;
name|uint16_t
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|SIBA_SPROMSIZE_R123
operator|*
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|siba_sprom_read
argument_list|(
name|siba
argument_list|,
name|buf
argument_list|,
name|SIBA_SPROMSIZE_R123
argument_list|)
expr_stmt|;
name|error
operator|=
name|sprom_check_crc
argument_list|(
name|buf
argument_list|,
name|siba
operator|->
name|siba_spromsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|SIBA_SPROMSIZE_R4
operator|*
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|siba_sprom_read
argument_list|(
name|siba
argument_list|,
name|buf
argument_list|,
name|SIBA_SPROMSIZE_R4
argument_list|)
expr_stmt|;
name|error
operator|=
name|sprom_check_crc
argument_list|(
name|buf
argument_list|,
name|siba
operator|->
name|siba_spromsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"warn: bad SPROM CRC\n"
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
name|sprom
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sprom
argument_list|)
argument_list|)
expr_stmt|;
name|sprom
operator|->
name|rev
operator|=
name|buf
index|[
name|siba
operator|->
name|siba_spromsize
operator|-
literal|1
index|]
operator|&
literal|0x00FF
expr_stmt|;
name|DPRINTF
argument_list|(
name|siba
argument_list|,
name|SIBA_DEBUG_SPROM
argument_list|,
literal|"SPROM rev %d\n"
argument_list|,
name|sprom
operator|->
name|rev
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|sprom
operator|->
name|mac_eth
argument_list|,
literal|0xff
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|sprom
operator|->
name|mac_80211a
argument_list|,
literal|0xff
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|siba
operator|->
name|siba_chipid
operator|&
literal|0xff00
operator|)
operator|==
literal|0x4400
condition|)
block|{
name|sprom
operator|->
name|rev
operator|=
literal|1
expr_stmt|;
name|siba_sprom_r123
argument_list|(
name|sprom
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|siba
operator|->
name|siba_chipid
operator|==
literal|0x4321
condition|)
block|{
name|sprom
operator|->
name|rev
operator|=
literal|4
expr_stmt|;
name|siba_sprom_r45
argument_list|(
name|sprom
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|sprom
operator|->
name|rev
condition|)
block|{
case|case
literal|1
case|:
case|case
literal|2
case|:
case|case
literal|3
case|:
name|siba_sprom_r123
argument_list|(
name|sprom
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
case|case
literal|5
case|:
name|siba_sprom_r45
argument_list|(
name|sprom
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|siba_sprom_r8
argument_list|(
name|sprom
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"unknown SPROM revision %d.\n"
argument_list|,
name|sprom
operator|->
name|rev
argument_list|)
expr_stmt|;
name|siba_sprom_r123
argument_list|(
name|sprom
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sprom
operator|->
name|bf_lo
operator|==
literal|0xffff
condition|)
name|sprom
operator|->
name|bf_lo
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sprom
operator|->
name|bf_hi
operator|==
literal|0xffff
condition|)
name|sprom
operator|->
name|bf_hi
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siba_sprom_read
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|,
name|uint16_t
modifier|*
name|sprom
parameter_list|,
name|uint16_t
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|sprom
index|[
name|i
index|]
operator|=
name|SIBA_READ_2
argument_list|(
name|siba
argument_list|,
name|SIBA_SPROM_BASE
operator|+
operator|(
name|i
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|siba
operator|->
name|siba_spromsize
operator|=
name|len
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sprom_check_crc
parameter_list|(
specifier|const
name|uint16_t
modifier|*
name|sprom
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|int
name|word
decl_stmt|;
name|uint8_t
name|crc0
decl_stmt|,
name|crc1
init|=
literal|0xff
decl_stmt|;
name|crc0
operator|=
operator|(
name|sprom
index|[
name|size
operator|-
literal|1
index|]
operator|&
name|SIBA_SPROM_REV_CRC
operator|)
operator|>>
literal|8
expr_stmt|;
for|for
control|(
name|word
operator|=
literal|0
init|;
name|word
operator|<
name|size
operator|-
literal|1
condition|;
name|word
operator|++
control|)
block|{
name|crc1
operator|=
name|siba_crc8
argument_list|(
name|crc1
argument_list|,
name|sprom
index|[
name|word
index|]
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|crc1
operator|=
name|siba_crc8
argument_list|(
name|crc1
argument_list|,
operator|(
name|sprom
index|[
name|word
index|]
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
name|crc1
operator|=
name|siba_crc8
argument_list|(
name|crc1
argument_list|,
name|sprom
index|[
name|size
operator|-
literal|1
index|]
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|crc1
operator|^=
literal|0xff
expr_stmt|;
return|return
operator|(
operator|(
name|crc0
operator|!=
name|crc1
operator|)
condition|?
name|EPROTO
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|siba_crc8
parameter_list|(
name|uint8_t
name|crc
parameter_list|,
name|uint8_t
name|data
parameter_list|)
block|{
specifier|static
specifier|const
name|uint8_t
name|ct
index|[]
init|=
block|{
literal|0x00
block|,
literal|0xf7
block|,
literal|0xb9
block|,
literal|0x4e
block|,
literal|0x25
block|,
literal|0xd2
block|,
literal|0x9c
block|,
literal|0x6b
block|,
literal|0x4a
block|,
literal|0xbd
block|,
literal|0xf3
block|,
literal|0x04
block|,
literal|0x6f
block|,
literal|0x98
block|,
literal|0xd6
block|,
literal|0x21
block|,
literal|0x94
block|,
literal|0x63
block|,
literal|0x2d
block|,
literal|0xda
block|,
literal|0xb1
block|,
literal|0x46
block|,
literal|0x08
block|,
literal|0xff
block|,
literal|0xde
block|,
literal|0x29
block|,
literal|0x67
block|,
literal|0x90
block|,
literal|0xfb
block|,
literal|0x0c
block|,
literal|0x42
block|,
literal|0xb5
block|,
literal|0x7f
block|,
literal|0x88
block|,
literal|0xc6
block|,
literal|0x31
block|,
literal|0x5a
block|,
literal|0xad
block|,
literal|0xe3
block|,
literal|0x14
block|,
literal|0x35
block|,
literal|0xc2
block|,
literal|0x8c
block|,
literal|0x7b
block|,
literal|0x10
block|,
literal|0xe7
block|,
literal|0xa9
block|,
literal|0x5e
block|,
literal|0xeb
block|,
literal|0x1c
block|,
literal|0x52
block|,
literal|0xa5
block|,
literal|0xce
block|,
literal|0x39
block|,
literal|0x77
block|,
literal|0x80
block|,
literal|0xa1
block|,
literal|0x56
block|,
literal|0x18
block|,
literal|0xef
block|,
literal|0x84
block|,
literal|0x73
block|,
literal|0x3d
block|,
literal|0xca
block|,
literal|0xfe
block|,
literal|0x09
block|,
literal|0x47
block|,
literal|0xb0
block|,
literal|0xdb
block|,
literal|0x2c
block|,
literal|0x62
block|,
literal|0x95
block|,
literal|0xb4
block|,
literal|0x43
block|,
literal|0x0d
block|,
literal|0xfa
block|,
literal|0x91
block|,
literal|0x66
block|,
literal|0x28
block|,
literal|0xdf
block|,
literal|0x6a
block|,
literal|0x9d
block|,
literal|0xd3
block|,
literal|0x24
block|,
literal|0x4f
block|,
literal|0xb8
block|,
literal|0xf6
block|,
literal|0x01
block|,
literal|0x20
block|,
literal|0xd7
block|,
literal|0x99
block|,
literal|0x6e
block|,
literal|0x05
block|,
literal|0xf2
block|,
literal|0xbc
block|,
literal|0x4b
block|,
literal|0x81
block|,
literal|0x76
block|,
literal|0x38
block|,
literal|0xcf
block|,
literal|0xa4
block|,
literal|0x53
block|,
literal|0x1d
block|,
literal|0xea
block|,
literal|0xcb
block|,
literal|0x3c
block|,
literal|0x72
block|,
literal|0x85
block|,
literal|0xee
block|,
literal|0x19
block|,
literal|0x57
block|,
literal|0xa0
block|,
literal|0x15
block|,
literal|0xe2
block|,
literal|0xac
block|,
literal|0x5b
block|,
literal|0x30
block|,
literal|0xc7
block|,
literal|0x89
block|,
literal|0x7e
block|,
literal|0x5f
block|,
literal|0xa8
block|,
literal|0xe6
block|,
literal|0x11
block|,
literal|0x7a
block|,
literal|0x8d
block|,
literal|0xc3
block|,
literal|0x34
block|,
literal|0xab
block|,
literal|0x5c
block|,
literal|0x12
block|,
literal|0xe5
block|,
literal|0x8e
block|,
literal|0x79
block|,
literal|0x37
block|,
literal|0xc0
block|,
literal|0xe1
block|,
literal|0x16
block|,
literal|0x58
block|,
literal|0xaf
block|,
literal|0xc4
block|,
literal|0x33
block|,
literal|0x7d
block|,
literal|0x8a
block|,
literal|0x3f
block|,
literal|0xc8
block|,
literal|0x86
block|,
literal|0x71
block|,
literal|0x1a
block|,
literal|0xed
block|,
literal|0xa3
block|,
literal|0x54
block|,
literal|0x75
block|,
literal|0x82
block|,
literal|0xcc
block|,
literal|0x3b
block|,
literal|0x50
block|,
literal|0xa7
block|,
literal|0xe9
block|,
literal|0x1e
block|,
literal|0xd4
block|,
literal|0x23
block|,
literal|0x6d
block|,
literal|0x9a
block|,
literal|0xf1
block|,
literal|0x06
block|,
literal|0x48
block|,
literal|0xbf
block|,
literal|0x9e
block|,
literal|0x69
block|,
literal|0x27
block|,
literal|0xd0
block|,
literal|0xbb
block|,
literal|0x4c
block|,
literal|0x02
block|,
literal|0xf5
block|,
literal|0x40
block|,
literal|0xb7
block|,
literal|0xf9
block|,
literal|0x0e
block|,
literal|0x65
block|,
literal|0x92
block|,
literal|0xdc
block|,
literal|0x2b
block|,
literal|0x0a
block|,
literal|0xfd
block|,
literal|0xb3
block|,
literal|0x44
block|,
literal|0x2f
block|,
literal|0xd8
block|,
literal|0x96
block|,
literal|0x61
block|,
literal|0x55
block|,
literal|0xa2
block|,
literal|0xec
block|,
literal|0x1b
block|,
literal|0x70
block|,
literal|0x87
block|,
literal|0xc9
block|,
literal|0x3e
block|,
literal|0x1f
block|,
literal|0xe8
block|,
literal|0xa6
block|,
literal|0x51
block|,
literal|0x3a
block|,
literal|0xcd
block|,
literal|0x83
block|,
literal|0x74
block|,
literal|0xc1
block|,
literal|0x36
block|,
literal|0x78
block|,
literal|0x8f
block|,
literal|0xe4
block|,
literal|0x13
block|,
literal|0x5d
block|,
literal|0xaa
block|,
literal|0x8b
block|,
literal|0x7c
block|,
literal|0x32
block|,
literal|0xc5
block|,
literal|0xae
block|,
literal|0x59
block|,
literal|0x17
block|,
literal|0xe0
block|,
literal|0x2a
block|,
literal|0xdd
block|,
literal|0x93
block|,
literal|0x64
block|,
literal|0x0f
block|,
literal|0xf8
block|,
literal|0xb6
block|,
literal|0x41
block|,
literal|0x60
block|,
literal|0x97
block|,
literal|0xd9
block|,
literal|0x2e
block|,
literal|0x45
block|,
literal|0xb2
block|,
literal|0xfc
block|,
literal|0x0b
block|,
literal|0xbe
block|,
literal|0x49
block|,
literal|0x07
block|,
literal|0xf0
block|,
literal|0x9b
block|,
literal|0x6c
block|,
literal|0x22
block|,
literal|0xd5
block|,
literal|0xf4
block|,
literal|0x03
block|,
literal|0x4d
block|,
literal|0xba
block|,
literal|0xd1
block|,
literal|0x26
block|,
literal|0x68
block|,
literal|0x9f
block|, 	}
decl_stmt|;
return|return
operator|(
name|ct
index|[
name|crc
operator|^
name|data
index|]
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|SIBA_LOWEST_SET_BIT
parameter_list|(
name|__mask
parameter_list|)
value|((((__mask) - 1)& (__mask)) ^ (__mask))
end_define

begin_define
define|#
directive|define
name|SIBA_OFFSET
parameter_list|(
name|offset
parameter_list|)
define|\
value|(((offset) - SIBA_SPROM_BASE) / sizeof(uint16_t))
end_define

begin_define
define|#
directive|define
name|SIBA_SHIFTOUT_SUB
parameter_list|(
name|__x
parameter_list|,
name|__mask
parameter_list|)
define|\
value|(((__x)& (__mask)) / SIBA_LOWEST_SET_BIT(__mask))
end_define

begin_define
define|#
directive|define
name|SIBA_SHIFTOUT
parameter_list|(
name|_var
parameter_list|,
name|_offset
parameter_list|,
name|_mask
parameter_list|)
define|\
value|out->_var = SIBA_SHIFTOUT_SUB(in[SIBA_OFFSET(_offset)], (_mask))
end_define

begin_function
specifier|static
name|void
name|siba_sprom_r123
parameter_list|(
name|struct
name|siba_sprom
modifier|*
name|out
parameter_list|,
specifier|const
name|uint16_t
modifier|*
name|in
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint16_t
name|v
decl_stmt|;
name|int8_t
name|gain
decl_stmt|;
name|uint16_t
name|loc
index|[
literal|3
index|]
decl_stmt|;
if|if
condition|(
name|out
operator|->
name|rev
operator|==
literal|3
condition|)
name|loc
index|[
literal|0
index|]
operator|=
name|SIBA_SPROM3_MAC_80211BG
expr_stmt|;
else|else
block|{
name|loc
index|[
literal|0
index|]
operator|=
name|SIBA_SPROM1_MAC_80211BG
expr_stmt|;
name|loc
index|[
literal|1
index|]
operator|=
name|SIBA_SPROM1_MAC_ETH
expr_stmt|;
name|loc
index|[
literal|2
index|]
operator|=
name|SIBA_SPROM1_MAC_80211A
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|=
name|in
index|[
name|SIBA_OFFSET
argument_list|(
name|loc
index|[
literal|0
index|]
argument_list|)
operator|+
name|i
index|]
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|out
operator|->
name|mac_80211bg
operator|)
operator|+
name|i
operator|)
operator|=
name|htobe16
argument_list|(
name|v
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|out
operator|->
name|rev
operator|<
literal|3
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|=
name|in
index|[
name|SIBA_OFFSET
argument_list|(
name|loc
index|[
literal|1
index|]
argument_list|)
operator|+
name|i
index|]
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|out
operator|->
name|mac_eth
operator|)
operator|+
name|i
operator|)
operator|=
name|htobe16
argument_list|(
name|v
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|=
name|in
index|[
name|SIBA_OFFSET
argument_list|(
name|loc
index|[
literal|2
index|]
argument_list|)
operator|+
name|i
index|]
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|out
operator|->
name|mac_80211a
operator|)
operator|+
name|i
operator|)
operator|=
name|htobe16
argument_list|(
name|v
argument_list|)
expr_stmt|;
block|}
block|}
name|SIBA_SHIFTOUT
argument_list|(
name|mii_eth0
argument_list|,
name|SIBA_SPROM1_ETHPHY
argument_list|,
name|SIBA_SPROM1_ETHPHY_MII_ETH0
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|mii_eth1
argument_list|,
name|SIBA_SPROM1_ETHPHY
argument_list|,
name|SIBA_SPROM1_ETHPHY_MII_ETH1
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|mdio_eth0
argument_list|,
name|SIBA_SPROM1_ETHPHY
argument_list|,
name|SIBA_SPROM1_ETHPHY_MDIO_ETH0
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|mdio_eth1
argument_list|,
name|SIBA_SPROM1_ETHPHY
argument_list|,
name|SIBA_SPROM1_ETHPHY_MDIO_ETH1
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|brev
argument_list|,
name|SIBA_SPROM1_BOARDINFO
argument_list|,
name|SIBA_SPROM1_BOARDINFO_BREV
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|ccode
argument_list|,
name|SIBA_SPROM1_BOARDINFO
argument_list|,
name|SIBA_SPROM1_BOARDINFO_CCODE
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|ant_a
argument_list|,
name|SIBA_SPROM1_BOARDINFO
argument_list|,
name|SIBA_SPROM1_BOARDINFO_ANTA
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|ant_bg
argument_list|,
name|SIBA_SPROM1_BOARDINFO
argument_list|,
name|SIBA_SPROM1_BOARDINFO_ANTBG
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|pa0b0
argument_list|,
name|SIBA_SPROM1_PA0B0
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|pa0b1
argument_list|,
name|SIBA_SPROM1_PA0B1
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|pa0b2
argument_list|,
name|SIBA_SPROM1_PA0B2
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|pa1b0
argument_list|,
name|SIBA_SPROM1_PA1B0
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|pa1b1
argument_list|,
name|SIBA_SPROM1_PA1B1
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|pa1b2
argument_list|,
name|SIBA_SPROM1_PA1B2
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio0
argument_list|,
name|SIBA_SPROM1_GPIOA
argument_list|,
name|SIBA_SPROM1_GPIOA_P0
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio1
argument_list|,
name|SIBA_SPROM1_GPIOA
argument_list|,
name|SIBA_SPROM1_GPIOA_P1
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio2
argument_list|,
name|SIBA_SPROM1_GPIOB
argument_list|,
name|SIBA_SPROM1_GPIOB_P2
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio3
argument_list|,
name|SIBA_SPROM1_GPIOB
argument_list|,
name|SIBA_SPROM1_GPIOB_P3
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|maxpwr_a
argument_list|,
name|SIBA_SPROM1_MAXPWR
argument_list|,
name|SIBA_SPROM1_MAXPWR_A
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|maxpwr_bg
argument_list|,
name|SIBA_SPROM1_MAXPWR
argument_list|,
name|SIBA_SPROM1_MAXPWR_BG
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|tssi_a
argument_list|,
name|SIBA_SPROM1_TSSI
argument_list|,
name|SIBA_SPROM1_TSSI_A
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|tssi_bg
argument_list|,
name|SIBA_SPROM1_TSSI
argument_list|,
name|SIBA_SPROM1_TSSI_BG
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|bf_lo
argument_list|,
name|SIBA_SPROM1_BFLOW
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|->
name|rev
operator|>=
literal|2
condition|)
name|SIBA_SHIFTOUT
argument_list|(
name|bf_hi
argument_list|,
name|SIBA_SPROM2_BFHIGH
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* antenna gain */
name|gain
operator|=
name|siba_sprom_r123_antgain
argument_list|(
name|out
operator|->
name|rev
argument_list|,
name|in
argument_list|,
name|SIBA_SPROM1_AGAIN_BG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|out
operator|->
name|again
operator|.
name|ghz24
operator|.
name|a0
operator|=
name|out
operator|->
name|again
operator|.
name|ghz24
operator|.
name|a1
operator|=
name|gain
expr_stmt|;
name|out
operator|->
name|again
operator|.
name|ghz24
operator|.
name|a2
operator|=
name|out
operator|->
name|again
operator|.
name|ghz24
operator|.
name|a3
operator|=
name|gain
expr_stmt|;
name|gain
operator|=
name|siba_sprom_r123_antgain
argument_list|(
name|out
operator|->
name|rev
argument_list|,
name|in
argument_list|,
name|SIBA_SPROM1_AGAIN_A
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|out
operator|->
name|again
operator|.
name|ghz5
operator|.
name|a0
operator|=
name|out
operator|->
name|again
operator|.
name|ghz5
operator|.
name|a1
operator|=
name|gain
expr_stmt|;
name|out
operator|->
name|again
operator|.
name|ghz5
operator|.
name|a2
operator|=
name|out
operator|->
name|again
operator|.
name|ghz5
operator|.
name|a3
operator|=
name|gain
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_sprom_r45
parameter_list|(
name|struct
name|siba_sprom
modifier|*
name|out
parameter_list|,
specifier|const
name|uint16_t
modifier|*
name|in
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint16_t
name|v
decl_stmt|;
name|uint16_t
name|mac_80211bg_offset
decl_stmt|;
if|if
condition|(
name|out
operator|->
name|rev
operator|==
literal|4
condition|)
name|mac_80211bg_offset
operator|=
name|SIBA_SPROM4_MAC_80211BG
expr_stmt|;
else|else
name|mac_80211bg_offset
operator|=
name|SIBA_SPROM5_MAC_80211BG
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|=
name|in
index|[
name|SIBA_OFFSET
argument_list|(
name|mac_80211bg_offset
argument_list|)
operator|+
name|i
index|]
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|out
operator|->
name|mac_80211bg
operator|)
operator|+
name|i
operator|)
operator|=
name|htobe16
argument_list|(
name|v
argument_list|)
expr_stmt|;
block|}
name|SIBA_SHIFTOUT
argument_list|(
name|mii_eth0
argument_list|,
name|SIBA_SPROM4_ETHPHY
argument_list|,
name|SIBA_SPROM4_ETHPHY_ET0A
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|mii_eth1
argument_list|,
name|SIBA_SPROM4_ETHPHY
argument_list|,
name|SIBA_SPROM4_ETHPHY_ET1A
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|->
name|rev
operator|==
literal|4
condition|)
block|{
name|SIBA_SHIFTOUT
argument_list|(
name|ccode
argument_list|,
name|SIBA_SPROM4_CCODE
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|bf_lo
argument_list|,
name|SIBA_SPROM4_BFLOW
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|bf_hi
argument_list|,
name|SIBA_SPROM4_BFHIGH
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SIBA_SHIFTOUT
argument_list|(
name|ccode
argument_list|,
name|SIBA_SPROM5_CCODE
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|bf_lo
argument_list|,
name|SIBA_SPROM5_BFLOW
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|bf_hi
argument_list|,
name|SIBA_SPROM5_BFHIGH
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
block|}
name|SIBA_SHIFTOUT
argument_list|(
name|ant_a
argument_list|,
name|SIBA_SPROM4_ANTAVAIL
argument_list|,
name|SIBA_SPROM4_ANTAVAIL_A
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|ant_bg
argument_list|,
name|SIBA_SPROM4_ANTAVAIL
argument_list|,
name|SIBA_SPROM4_ANTAVAIL_BG
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|maxpwr_bg
argument_list|,
name|SIBA_SPROM4_MAXP_BG
argument_list|,
name|SIBA_SPROM4_MAXP_BG_MASK
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|tssi_bg
argument_list|,
name|SIBA_SPROM4_MAXP_BG
argument_list|,
name|SIBA_SPROM4_TSSI_BG
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|maxpwr_a
argument_list|,
name|SIBA_SPROM4_MAXP_A
argument_list|,
name|SIBA_SPROM4_MAXP_A_MASK
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|tssi_a
argument_list|,
name|SIBA_SPROM4_MAXP_A
argument_list|,
name|SIBA_SPROM4_TSSI_A
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|->
name|rev
operator|==
literal|4
condition|)
block|{
name|SIBA_SHIFTOUT
argument_list|(
name|gpio0
argument_list|,
name|SIBA_SPROM4_GPIOA
argument_list|,
name|SIBA_SPROM4_GPIOA_P0
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio1
argument_list|,
name|SIBA_SPROM4_GPIOA
argument_list|,
name|SIBA_SPROM4_GPIOA_P1
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio2
argument_list|,
name|SIBA_SPROM4_GPIOB
argument_list|,
name|SIBA_SPROM4_GPIOB_P2
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio3
argument_list|,
name|SIBA_SPROM4_GPIOB
argument_list|,
name|SIBA_SPROM4_GPIOB_P3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SIBA_SHIFTOUT
argument_list|(
name|gpio0
argument_list|,
name|SIBA_SPROM5_GPIOA
argument_list|,
name|SIBA_SPROM5_GPIOA_P0
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio1
argument_list|,
name|SIBA_SPROM5_GPIOA
argument_list|,
name|SIBA_SPROM5_GPIOA_P1
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio2
argument_list|,
name|SIBA_SPROM5_GPIOB
argument_list|,
name|SIBA_SPROM5_GPIOB_P2
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio3
argument_list|,
name|SIBA_SPROM5_GPIOB
argument_list|,
name|SIBA_SPROM5_GPIOB_P3
argument_list|)
expr_stmt|;
block|}
comment|/* antenna gain */
name|SIBA_SHIFTOUT
argument_list|(
name|again
operator|.
name|ghz24
operator|.
name|a0
argument_list|,
name|SIBA_SPROM4_AGAIN01
argument_list|,
name|SIBA_SPROM4_AGAIN0
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|again
operator|.
name|ghz24
operator|.
name|a1
argument_list|,
name|SIBA_SPROM4_AGAIN01
argument_list|,
name|SIBA_SPROM4_AGAIN1
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|again
operator|.
name|ghz24
operator|.
name|a2
argument_list|,
name|SIBA_SPROM4_AGAIN23
argument_list|,
name|SIBA_SPROM4_AGAIN2
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|again
operator|.
name|ghz24
operator|.
name|a3
argument_list|,
name|SIBA_SPROM4_AGAIN23
argument_list|,
name|SIBA_SPROM4_AGAIN3
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|out
operator|->
name|again
operator|.
name|ghz24
argument_list|,
operator|&
name|out
operator|->
name|again
operator|.
name|ghz5
argument_list|,
sizeof|sizeof
argument_list|(
name|out
operator|->
name|again
operator|.
name|ghz5
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_sprom_r8
parameter_list|(
name|struct
name|siba_sprom
modifier|*
name|out
parameter_list|,
specifier|const
name|uint16_t
modifier|*
name|in
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint16_t
name|v
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|=
name|in
index|[
name|SIBA_OFFSET
argument_list|(
name|SIBA_SPROM1_MAC_80211BG
argument_list|)
operator|+
name|i
index|]
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|out
operator|->
name|mac_80211bg
operator|)
operator|+
name|i
operator|)
operator|=
name|htobe16
argument_list|(
name|v
argument_list|)
expr_stmt|;
block|}
name|SIBA_SHIFTOUT
argument_list|(
name|ccode
argument_list|,
name|SIBA_SPROM8_CCODE
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|bf_lo
argument_list|,
name|SIBA_SPROM8_BFLOW
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|bf_hi
argument_list|,
name|SIBA_SPROM8_BFHIGH
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|ant_a
argument_list|,
name|SIBA_SPROM8_ANTAVAIL
argument_list|,
name|SIBA_SPROM8_ANTAVAIL_A
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|ant_bg
argument_list|,
name|SIBA_SPROM8_ANTAVAIL
argument_list|,
name|SIBA_SPROM8_ANTAVAIL_BG
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|maxpwr_bg
argument_list|,
name|SIBA_SPROM8_MAXP_BG
argument_list|,
name|SIBA_SPROM8_MAXP_BG_MASK
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|tssi_bg
argument_list|,
name|SIBA_SPROM8_MAXP_BG
argument_list|,
name|SIBA_SPROM8_TSSI_BG
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|maxpwr_a
argument_list|,
name|SIBA_SPROM8_MAXP_A
argument_list|,
name|SIBA_SPROM8_MAXP_A_MASK
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|tssi_a
argument_list|,
name|SIBA_SPROM8_MAXP_A
argument_list|,
name|SIBA_SPROM8_TSSI_A
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio0
argument_list|,
name|SIBA_SPROM8_GPIOA
argument_list|,
name|SIBA_SPROM8_GPIOA_P0
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio1
argument_list|,
name|SIBA_SPROM8_GPIOA
argument_list|,
name|SIBA_SPROM8_GPIOA_P1
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio2
argument_list|,
name|SIBA_SPROM8_GPIOB
argument_list|,
name|SIBA_SPROM8_GPIOB_P2
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|gpio3
argument_list|,
name|SIBA_SPROM8_GPIOB
argument_list|,
name|SIBA_SPROM8_GPIOB_P3
argument_list|)
expr_stmt|;
comment|/* antenna gain */
name|SIBA_SHIFTOUT
argument_list|(
name|again
operator|.
name|ghz24
operator|.
name|a0
argument_list|,
name|SIBA_SPROM8_AGAIN01
argument_list|,
name|SIBA_SPROM8_AGAIN0
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|again
operator|.
name|ghz24
operator|.
name|a1
argument_list|,
name|SIBA_SPROM8_AGAIN01
argument_list|,
name|SIBA_SPROM8_AGAIN1
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|again
operator|.
name|ghz24
operator|.
name|a2
argument_list|,
name|SIBA_SPROM8_AGAIN23
argument_list|,
name|SIBA_SPROM8_AGAIN2
argument_list|)
expr_stmt|;
name|SIBA_SHIFTOUT
argument_list|(
name|again
operator|.
name|ghz24
operator|.
name|a3
argument_list|,
name|SIBA_SPROM8_AGAIN23
argument_list|,
name|SIBA_SPROM8_AGAIN3
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|out
operator|->
name|again
operator|.
name|ghz24
argument_list|,
operator|&
name|out
operator|->
name|again
operator|.
name|ghz5
argument_list|,
sizeof|sizeof
argument_list|(
name|out
operator|->
name|again
operator|.
name|ghz5
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int8_t
name|siba_sprom_r123_antgain
parameter_list|(
name|uint8_t
name|sprom_revision
parameter_list|,
specifier|const
name|uint16_t
modifier|*
name|in
parameter_list|,
name|uint16_t
name|mask
parameter_list|,
name|uint16_t
name|shift
parameter_list|)
block|{
name|uint16_t
name|v
decl_stmt|;
name|uint8_t
name|gain
decl_stmt|;
name|v
operator|=
name|in
index|[
name|SIBA_OFFSET
argument_list|(
name|SIBA_SPROM1_AGAIN
argument_list|)
index|]
expr_stmt|;
name|gain
operator|=
operator|(
name|v
operator|&
name|mask
operator|)
operator|>>
name|shift
expr_stmt|;
name|gain
operator|=
operator|(
name|gain
operator|==
literal|0xff
operator|)
condition|?
literal|2
else|:
operator|(
name|sprom_revision
operator|==
literal|1
operator|)
condition|?
name|gain
operator|<<
literal|2
else|:
operator|(
operator|(
name|gain
operator|&
literal|0xc0
operator|)
operator|>>
literal|6
operator|)
operator||
operator|(
operator|(
name|gain
operator|&
literal|0x3f
operator|)
operator|<<
literal|2
operator|)
expr_stmt|;
return|return
operator|(
operator|(
name|int8_t
operator|)
name|gain
operator|)
return|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|SIBA_LOWEST_SET_BIT
end_undef

begin_undef
undef|#
directive|undef
name|SIBA_OFFSET
end_undef

begin_undef
undef|#
directive|undef
name|SIBA_SHIFTOUT_SUB
end_undef

begin_undef
undef|#
directive|undef
name|SIBA_SHIFTOUT
end_undef

begin_function
name|int
name|siba_powerdown
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|)
block|{
name|struct
name|siba_cc
modifier|*
name|scc
decl_stmt|;
if|if
condition|(
name|siba
operator|->
name|siba_type
operator|==
name|SIBA_TYPE_SSB
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|scc
operator|=
operator|&
name|siba
operator|->
name|siba_cc
expr_stmt|;
if|if
condition|(
operator|!
name|scc
operator|->
name|scc_dev
operator|||
name|scc
operator|->
name|scc_dev
operator|->
name|sd_id
operator|.
name|sd_rev
operator|<
literal|5
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|siba_cc_clock
argument_list|(
name|scc
argument_list|,
name|SIBA_CLOCK_SLOW
argument_list|)
expr_stmt|;
name|siba_pci_gpio
argument_list|(
name|siba
argument_list|,
name|SIBA_GPIO_CRYSTAL
operator||
name|SIBA_GPIO_PLL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pcicore_init
parameter_list|(
name|struct
name|siba_pci
modifier|*
name|spc
parameter_list|)
block|{
name|struct
name|siba_dev_softc
modifier|*
name|sd
init|=
name|spc
operator|->
name|spc_dev
decl_stmt|;
name|struct
name|siba_softc
modifier|*
name|siba
decl_stmt|;
if|if
condition|(
name|sd
operator|==
name|NULL
condition|)
return|return;
name|siba
operator|=
name|sd
operator|->
name|sd_bus
expr_stmt|;
if|if
condition|(
operator|!
name|siba_dev_isup
argument_list|(
name|sd
argument_list|)
condition|)
name|siba_dev_up
argument_list|(
name|sd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|spc
operator|->
name|spc_hostmode
operator|==
literal|0
argument_list|,
operator|(
literal|"%s:%d: hostmode"
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
comment|/* disable PCI interrupt */
name|siba_write_4
argument_list|(
name|spc
operator|->
name|spc_dev
argument_list|,
name|SIBA_INTR_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|siba_dev_isup
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|)
block|{
name|uint32_t
name|reject
decl_stmt|,
name|val
decl_stmt|;
name|reject
operator|=
name|siba_tmslow_reject_bitmask
argument_list|(
name|sd
argument_list|)
expr_stmt|;
name|val
operator|=
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|)
expr_stmt|;
name|val
operator|&=
name|SIBA_TGSLOW_CLOCK
operator||
name|SIBA_TGSLOW_RESET
operator||
name|reject
expr_stmt|;
return|return
operator|(
name|val
operator|==
name|SIBA_TGSLOW_CLOCK
operator|)
return|;
block|}
end_function

begin_function
name|void
name|siba_dev_up
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|siba_dev_down
argument_list|(
name|sd
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|siba_write_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|,
name|SIBA_TGSLOW_RESET
operator||
name|SIBA_TGSLOW_CLOCK
operator||
name|SIBA_TGSLOW_FGC
operator||
name|flags
argument_list|)
expr_stmt|;
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSHIGH
argument_list|)
operator|&
name|SIBA_TGSHIGH_SERR
condition|)
name|siba_write_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSHIGH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_IAS
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
operator|(
name|SIBA_IAS_INBAND_ERR
operator||
name|SIBA_IAS_TIMEOUT
operator|)
condition|)
block|{
name|val
operator|&=
operator|~
operator|(
name|SIBA_IAS_INBAND_ERR
operator||
name|SIBA_IAS_TIMEOUT
operator|)
expr_stmt|;
name|siba_write_4
argument_list|(
name|sd
argument_list|,
name|SIBA_IAS
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|siba_write_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|,
name|SIBA_TGSLOW_CLOCK
operator||
name|SIBA_TGSLOW_FGC
operator||
name|flags
argument_list|)
expr_stmt|;
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|siba_write_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|,
name|SIBA_TGSLOW_CLOCK
operator||
name|flags
argument_list|)
expr_stmt|;
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|siba_tmslow_reject_bitmask
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|)
block|{
name|uint32_t
name|rev
init|=
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_IDLOW
argument_list|)
operator|&
name|SIBA_IDLOW_SSBREV
decl_stmt|;
switch|switch
condition|(
name|rev
condition|)
block|{
case|case
name|SIBA_IDLOW_SSBREV_22
case|:
return|return
operator|(
name|SIBA_TGSLOW_REJECT_22
operator|)
return|;
case|case
name|SIBA_IDLOW_SSBREV_23
case|:
return|return
operator|(
name|SIBA_TGSLOW_REJECT_23
operator|)
return|;
case|case
name|SIBA_IDLOW_SSBREV_24
case|:
case|case
name|SIBA_IDLOW_SSBREV_25
case|:
case|case
name|SIBA_IDLOW_SSBREV_26
case|:
case|case
name|SIBA_IDLOW_SSBREV_27
case|:
return|return
operator|(
name|SIBA_TGSLOW_REJECT_23
operator|)
return|;
default|default:
name|KASSERT
argument_list|(
literal|0
operator|==
literal|1
argument_list|,
operator|(
literal|"%s:%d: unknown backplane rev %#x\n"
operator|,
name|__func__
operator|,
name|__LINE__
operator|,
name|rev
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|SIBA_TGSLOW_REJECT_22
operator||
name|SIBA_TGSLOW_REJECT_23
operator|)
return|;
block|}
end_function

begin_function
name|void
name|siba_dev_down
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
name|uint32_t
name|reject
decl_stmt|,
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|)
operator|&
name|SIBA_TGSLOW_RESET
condition|)
return|return;
name|reject
operator|=
name|siba_tmslow_reject_bitmask
argument_list|(
name|sd
argument_list|)
expr_stmt|;
name|siba_write_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|,
name|reject
operator||
name|SIBA_TGSLOW_CLOCK
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1000
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|reject
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|val
operator|&
name|reject
operator|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"timeout (bit %#x reg %#x)\n"
argument_list|,
name|reject
argument_list|,
name|SIBA_TGSLOW
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1000
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSHIGH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|val
operator|&
name|SIBA_TGSHIGH_BUSY
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|val
operator|&
name|SIBA_TGSHIGH_BUSY
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
literal|"timeout (bit %#x reg %#x)\n"
argument_list|,
name|SIBA_TGSHIGH_BUSY
argument_list|,
name|SIBA_TGSHIGH
argument_list|)
expr_stmt|;
block|}
name|siba_write_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|,
name|SIBA_TGSLOW_FGC
operator||
name|SIBA_TGSLOW_CLOCK
operator||
name|reject
operator||
name|SIBA_TGSLOW_RESET
operator||
name|flags
argument_list|)
expr_stmt|;
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|siba_write_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|,
name|reject
operator||
name|SIBA_TGSLOW_RESET
operator||
name|flags
argument_list|)
expr_stmt|;
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TGSLOW
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pcicore_setup
parameter_list|(
name|struct
name|siba_pci
modifier|*
name|spc
parameter_list|,
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|)
block|{
name|struct
name|siba_dev_softc
modifier|*
name|psd
init|=
name|spc
operator|->
name|spc_dev
decl_stmt|;
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|psd
operator|->
name|sd_bus
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|psd
operator|->
name|sd_id
operator|.
name|sd_device
operator|==
name|SIBA_DEVID_PCI
condition|)
block|{
name|siba_pcicore_write_4
argument_list|(
name|spc
argument_list|,
name|SIBA_PCICORE_SBTOPCI2
argument_list|,
name|siba_pcicore_read_4
argument_list|(
name|spc
argument_list|,
name|SIBA_PCICORE_SBTOPCI2
argument_list|)
operator||
name|SIBA_PCICORE_SBTOPCI_PREF
operator||
name|SIBA_PCICORE_SBTOPCI_BURST
argument_list|)
expr_stmt|;
if|if
condition|(
name|psd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|<
literal|5
condition|)
block|{
name|tmp
operator|=
name|siba_read_4
argument_list|(
name|psd
argument_list|,
name|SIBA_IMCFGLO
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|SIBA_IMCFGLO_SERTO
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator||
literal|2
operator|)
operator|&
operator|~
name|SIBA_IMCFGLO_REQTO
expr_stmt|;
name|tmp
operator||=
literal|3
operator|<<
literal|4
comment|/* SIBA_IMCFGLO_REQTO_SHIFT */
expr_stmt|;
name|siba_write_4
argument_list|(
name|psd
argument_list|,
name|SIBA_IMCFGLO
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* broadcast value */
name|sd
operator|=
operator|(
name|siba
operator|->
name|siba_cc
operator|.
name|scc_dev
operator|!=
name|NULL
operator|)
condition|?
name|siba
operator|->
name|siba_cc
operator|.
name|scc_dev
else|:
name|siba
operator|->
name|siba_pci
operator|.
name|spc_dev
expr_stmt|;
if|if
condition|(
name|sd
operator|!=
name|NULL
condition|)
block|{
name|siba_write_4
argument_list|(
name|sd
argument_list|,
name|SIBA_PCICORE_BCAST_ADDR
argument_list|,
literal|0xfd8
argument_list|)
expr_stmt|;
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_PCICORE_BCAST_ADDR
argument_list|)
expr_stmt|;
name|siba_write_4
argument_list|(
name|sd
argument_list|,
name|SIBA_PCICORE_BCAST_DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_PCICORE_BCAST_DATA
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|psd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|>=
literal|11
condition|)
block|{
name|tmp
operator|=
name|siba_pcicore_read_4
argument_list|(
name|spc
argument_list|,
name|SIBA_PCICORE_SBTOPCI2
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|SIBA_PCICORE_SBTOPCI_MRM
expr_stmt|;
name|siba_pcicore_write_4
argument_list|(
name|spc
argument_list|,
name|SIBA_PCICORE_SBTOPCI2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|KASSERT
argument_list|(
name|psd
operator|->
name|sd_id
operator|.
name|sd_device
operator|==
name|SIBA_DEVID_PCIE
argument_list|,
operator|(
literal|"only PCIE"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|psd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|==
literal|0
operator|)
operator|||
operator|(
name|psd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|==
literal|1
operator|)
condition|)
name|siba_pcie_write
argument_list|(
name|spc
argument_list|,
literal|0x4
argument_list|,
name|siba_pcie_read
argument_list|(
name|spc
argument_list|,
literal|0x4
argument_list|)
operator||
literal|0x8
argument_list|)
expr_stmt|;
if|if
condition|(
name|psd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|==
literal|0
condition|)
block|{
name|siba_pcie_mdio_write
argument_list|(
name|spc
argument_list|,
literal|0x1f
argument_list|,
literal|2
argument_list|,
literal|0x8128
argument_list|)
expr_stmt|;
comment|/* Timer */
name|siba_pcie_mdio_write
argument_list|(
name|spc
argument_list|,
literal|0x1f
argument_list|,
literal|6
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
comment|/* CDR */
name|siba_pcie_mdio_write
argument_list|(
name|spc
argument_list|,
literal|0x1f
argument_list|,
literal|7
argument_list|,
literal|0x1466
argument_list|)
expr_stmt|;
comment|/* CDR BW */
block|}
elseif|else
if|if
condition|(
name|psd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|==
literal|1
condition|)
name|siba_pcie_write
argument_list|(
name|spc
argument_list|,
literal|0x100
argument_list|,
name|siba_pcie_read
argument_list|(
name|spc
argument_list|,
literal|0x100
argument_list|)
operator||
literal|0x40
argument_list|)
expr_stmt|;
block|}
name|spc
operator|->
name|spc_inited
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|siba_pcicore_intr
parameter_list|(
name|struct
name|siba_pci
modifier|*
name|spc
parameter_list|,
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|)
block|{
name|struct
name|siba_dev_softc
modifier|*
name|psd
init|=
name|spc
operator|->
name|spc_dev
decl_stmt|;
name|struct
name|siba_softc
modifier|*
name|siba
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_bus
operator|->
name|siba_type
operator|!=
name|SIBA_TYPE_PCI
operator|||
operator|!
name|psd
condition|)
return|return;
name|siba
operator|=
name|psd
operator|->
name|sd_bus
expr_stmt|;
comment|/* enable interrupts */
if|if
condition|(
name|siba
operator|->
name|siba_dev
operator|!=
name|NULL
operator|&&
operator|(
name|psd
operator|->
name|sd_id
operator|.
name|sd_rev
operator|>=
literal|6
operator|||
name|psd
operator|->
name|sd_id
operator|.
name|sd_device
operator|==
name|SIBA_DEVID_PCIE
operator|)
condition|)
block|{
name|tmp
operator|=
name|pci_read_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_IRQMASK
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|tmp
operator||=
operator|(
literal|1
operator|<<
name|sd
operator|->
name|sd_coreidx
operator|)
operator|<<
literal|8
expr_stmt|;
name|pci_write_config
argument_list|(
name|siba
operator|->
name|siba_dev
argument_list|,
name|SIBA_IRQMASK
argument_list|,
name|tmp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|siba_read_4
argument_list|(
name|sd
argument_list|,
name|SIBA_TPS
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|SIBA_TPS_BPFLAG
expr_stmt|;
name|siba_write_4
argument_list|(
name|psd
argument_list|,
name|SIBA_INTR_MASK
argument_list|,
name|siba_read_4
argument_list|(
name|psd
argument_list|,
name|SIBA_INTR_MASK
argument_list|)
operator||
operator|(
literal|1
operator|<<
name|tmp
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* setup PCIcore */
if|if
condition|(
name|spc
operator|->
name|spc_inited
operator|==
literal|0
condition|)
name|siba_pcicore_setup
argument_list|(
name|spc
argument_list|,
name|sd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|siba_pcicore_read_4
parameter_list|(
name|struct
name|siba_pci
modifier|*
name|spc
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
return|return
operator|(
name|siba_read_4
argument_list|(
name|spc
operator|->
name|spc_dev
argument_list|,
name|offset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pcicore_write_4
parameter_list|(
name|struct
name|siba_pci
modifier|*
name|spc
parameter_list|,
name|uint16_t
name|offset
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|siba_write_4
argument_list|(
name|spc
operator|->
name|spc_dev
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|siba_pcie_read
parameter_list|(
name|struct
name|siba_pci
modifier|*
name|spc
parameter_list|,
name|uint32_t
name|address
parameter_list|)
block|{
name|siba_pcicore_write_4
argument_list|(
name|spc
argument_list|,
literal|0x130
argument_list|,
name|address
argument_list|)
expr_stmt|;
return|return
operator|(
name|siba_pcicore_read_4
argument_list|(
name|spc
argument_list|,
literal|0x134
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pcie_write
parameter_list|(
name|struct
name|siba_pci
modifier|*
name|spc
parameter_list|,
name|uint32_t
name|address
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|siba_pcicore_write_4
argument_list|(
name|spc
argument_list|,
literal|0x130
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|siba_pcicore_write_4
argument_list|(
name|spc
argument_list|,
literal|0x134
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_pcie_mdio_write
parameter_list|(
name|struct
name|siba_pci
modifier|*
name|spc
parameter_list|,
name|uint8_t
name|device
parameter_list|,
name|uint8_t
name|address
parameter_list|,
name|uint16_t
name|data
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|siba_pcicore_write_4
argument_list|(
name|spc
argument_list|,
name|SIBA_PCICORE_MDIO_CTL
argument_list|,
literal|0x80
operator||
literal|0x2
argument_list|)
expr_stmt|;
name|siba_pcicore_write_4
argument_list|(
name|spc
argument_list|,
name|SIBA_PCICORE_MDIO_DATA
argument_list|,
operator|(
literal|1
operator|<<
literal|30
operator|)
operator||
operator|(
literal|1
operator|<<
literal|28
operator|)
operator||
operator|(
operator|(
name|uint32_t
operator|)
name|device
operator|<<
literal|22
operator|)
operator||
operator|(
operator|(
name|uint32_t
operator|)
name|address
operator|<<
literal|18
operator|)
operator||
operator|(
literal|1
operator|<<
literal|17
operator|)
operator||
name|data
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|siba_pcicore_read_4
argument_list|(
name|spc
argument_list|,
name|SIBA_PCICORE_MDIO_CTL
argument_list|)
operator|&
literal|0x100
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
name|siba_pcicore_write_4
argument_list|(
name|spc
argument_list|,
name|SIBA_PCICORE_MDIO_CTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|siba_dma_translation
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|sd
operator|->
name|sd_bus
operator|->
name|siba_type
operator|==
name|SIBA_TYPE_PCI
argument_list|,
operator|(
literal|"unsupported bustype %d\n"
operator|,
name|sd
operator|->
name|sd_bus
operator|->
name|siba_type
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|SIBA_PCI_DMA
operator|)
return|;
block|}
end_function

begin_function
name|void
name|siba_barrier
parameter_list|(
name|struct
name|siba_dev_softc
modifier|*
name|sd
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|siba_softc
modifier|*
name|siba
init|=
name|sd
operator|->
name|sd_bus
decl_stmt|;
name|SIBA_BARRIER
argument_list|(
name|siba
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Attach it as child.  */
end_comment

begin_function
name|device_t
name|siba_add_child
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|,
name|int
name|order
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|unit
parameter_list|)
block|{
name|struct
name|siba_dev_softc
modifier|*
name|sd
decl_stmt|;
name|device_t
name|child
decl_stmt|;
name|int
name|idx
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|child
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
name|name
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|siba_powerup
argument_list|(
name|siba
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|siba_pcicore_init
argument_list|(
operator|&
name|siba
operator|->
name|siba_pci
argument_list|)
expr_stmt|;
name|siba_powerdown
argument_list|(
name|siba
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|siba
operator|->
name|siba_ndevs
condition|;
name|i
operator|++
control|)
block|{
name|sd
operator|=
operator|&
operator|(
name|siba
operator|->
name|siba_devs
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
operator|!=
name|SIBA_DEVID_80211
condition|)
block|{
name|DPRINTF
argument_list|(
name|siba
argument_list|,
name|SIBA_DEBUG_CORE
argument_list|,
literal|"skip to register coreid %#x (%s)\n"
argument_list|,
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
argument_list|,
name|siba_core_name
argument_list|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|DPRINTF
argument_list|(
name|siba
argument_list|,
name|SIBA_DEBUG_CORE
argument_list|,
literal|"siba: attaching coreid %#x (%s) idx %d\n"
argument_list|,
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
argument_list|,
name|siba_core_name
argument_list|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
argument_list|)
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sd
operator|->
name|sd_id
operator|.
name|sd_device
operator|==
name|SIBA_DEVID_80211
argument_list|,
operator|(
literal|"%s:%d: SIBA_DEVID_80211 is only supportted currently."
operator|,
name|__func__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|device_set_ivars
argument_list|(
name|child
argument_list|,
name|sd
argument_list|)
expr_stmt|;
name|device_probe_and_attach
argument_list|(
name|child
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|child
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_cc_suspend
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|)
block|{
name|siba_cc_clock
argument_list|(
name|scc
argument_list|,
name|SIBA_CLOCK_SLOW
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siba_cc_resume
parameter_list|(
name|struct
name|siba_cc
modifier|*
name|scc
parameter_list|)
block|{
name|siba_cc_power_init
argument_list|(
name|scc
argument_list|)
expr_stmt|;
name|siba_cc_clock
argument_list|(
name|scc
argument_list|,
name|SIBA_CLOCK_FAST
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|siba_core_suspend
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|)
block|{
name|siba_cc_suspend
argument_list|(
operator|&
name|siba
operator|->
name|siba_cc
argument_list|)
expr_stmt|;
name|siba_pci_gpio
argument_list|(
name|siba
argument_list|,
name|SIBA_GPIO_CRYSTAL
operator||
name|SIBA_GPIO_PLL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|siba_core_resume
parameter_list|(
name|struct
name|siba_softc
modifier|*
name|siba
parameter_list|)
block|{
name|siba
operator|->
name|siba_pci
operator|.
name|spc_inited
operator|=
literal|0
expr_stmt|;
name|siba
operator|->
name|siba_curdev
operator|=
name|NULL
expr_stmt|;
name|siba_powerup
argument_list|(
name|siba
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX setup H/W for PCMCIA??? */
name|siba_cc_resume
argument_list|(
operator|&
name|siba
operator|->
name|siba_cc
argument_list|)
expr_stmt|;
name|siba_powerdown
argument_list|(
name|siba
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


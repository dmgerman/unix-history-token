begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Landon Fuller<landon@landonf.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    similar to the "NO WARRANTY" disclaimer below ("Disclaimer") and any  *    redistribution must be conditioned upon including a substantially  *    similar Disclaimer requirement for further binary redistribution.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF NONINFRINGEMENT, MERCHANTIBILITY  * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL  * THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY,  * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER  * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGES.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Broadcom BHND PCI/PCIe-Gen1 PCI-Host Bridge.  *   * This driver handles all interactions with PCI bridge cores operating in  * endpoint mode.  *   * Host-level PCI operations are handled at the bhndb bridge level by the  * bhndb_pci driver.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<dev/bhnd/bhnd.h>
end_include

begin_include
include|#
directive|include
file|"bhnd_pcireg.h"
end_include

begin_include
include|#
directive|include
file|"bhnd_pci_hostbvar.h"
end_include

begin_define
define|#
directive|define
name|BHND_PCI_ASSERT_QUIRK
parameter_list|(
name|_sc
parameter_list|,
name|_name
parameter_list|)
define|\
value|KASSERT((_sc)->quirks& (_name), ("quirk " __STRING(_name) " not set"))
end_define

begin_define
define|#
directive|define
name|BHND_PCI_DEV
parameter_list|(
name|_core
parameter_list|,
name|_quirks
parameter_list|)
define|\
value|BHND_DEVICE(_core, "", _quirks, BHND_DF_HOSTB)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|bhnd_device_quirk
name|bhnd_pci_quirks
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|bhnd_device_quirk
name|bhnd_pcie_quirks
index|[]
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|bhnd_pci_wars_early_once
parameter_list|(
name|struct
name|bhnd_pcihb_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bhnd_pci_wars_hwup
parameter_list|(
name|struct
name|bhnd_pcihb_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bhnd_pci_wars_hwdown
parameter_list|(
name|struct
name|bhnd_pcihb_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * device/quirk tables  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|bhnd_device
name|bhnd_pci_devs
index|[]
init|=
block|{
name|BHND_PCI_DEV
argument_list|(
name|PCI
argument_list|,
name|bhnd_pci_quirks
argument_list|)
block|,
name|BHND_PCI_DEV
argument_list|(
name|PCIE
argument_list|,
name|bhnd_pcie_quirks
argument_list|)
block|,
name|BHND_DEVICE_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|bhnd_device_quirk
name|bhnd_pci_quirks
index|[]
init|=
block|{
block|{
name|BHND_HWREV_ANY
block|,
name|BHND_PCI_QUIRK_SBTOPCI2_PREF_BURST
block|}
block|,
block|{
name|BHND_HWREV_GTE
argument_list|(
literal|11
argument_list|)
block|,
name|BHND_PCI_QUIRK_SBTOPCI2_READMULTI
operator||
name|BHND_PCI_QUIRK_CLKRUN_DSBL
block|}
block|,
name|BHND_DEVICE_QUIRK_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|bhnd_device_quirk
name|bhnd_pcie_quirks
index|[]
init|=
block|{
block|{
name|BHND_HWREV_EQ
argument_list|(
literal|0
argument_list|)
block|,
name|BHND_PCIE_QUIRK_SDR9_L0s_HANG
block|}
block|,
block|{
name|BHND_HWREV_RANGE
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
block|,
name|BHND_PCIE_QUIRK_UR_STATUS_FIX
block|}
block|,
block|{
name|BHND_HWREV_EQ
argument_list|(
literal|1
argument_list|)
block|,
name|BHND_PCIE_QUIRK_PCIPM_REQEN
block|}
block|,
block|{
name|BHND_HWREV_RANGE
argument_list|(
literal|3
argument_list|,
literal|5
argument_list|)
block|,
name|BHND_PCIE_QUIRK_ASPM_OVR
operator||
name|BHND_PCIE_QUIRK_SDR9_POLARITY
operator||
name|BHND_PCIE_QUIRK_SDR9_NO_FREQRETRY
block|}
block|,
block|{
name|BHND_HWREV_LTE
argument_list|(
literal|6
argument_list|)
block|,
name|BHND_PCIE_QUIRK_L1_IDLE_THRESH
block|}
block|,
block|{
name|BHND_HWREV_GTE
argument_list|(
literal|6
argument_list|)
block|,
name|BHND_PCIE_QUIRK_SPROM_L23_PCI_RESET
block|}
block|,
block|{
name|BHND_HWREV_EQ
argument_list|(
literal|7
argument_list|)
block|,
name|BHND_PCIE_QUIRK_SERDES_NOPLLDOWN
block|}
block|,
block|{
name|BHND_HWREV_GTE
argument_list|(
literal|8
argument_list|)
block|,
name|BHND_PCIE_QUIRK_L1_TIMER_PERF
block|}
block|,
block|{
name|BHND_HWREV_GTE
argument_list|(
literal|10
argument_list|)
block|,
name|BHND_PCIE_QUIRK_SD_C22_EXTADDR
block|}
block|,
name|BHND_DEVICE_QUIRK_END
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|// Quirk handling TODO
end_comment

begin_comment
comment|// WARs for the following are not yet implemented:
end_comment

begin_comment
comment|// - BHND_PCIE_QUIRK_ASPM_OVR
end_comment

begin_comment
comment|// - BHND_PCIE_QUIRK_SERDES_NOPLLDOWN
end_comment

begin_comment
comment|// Quirks (and WARs) for the following are not yet defined:
end_comment

begin_comment
comment|// - Power savings via MDIO BLK1/PWR_MGMT3 on PCIe hwrev 15-20, 21-22
end_comment

begin_comment
comment|// - WOWL PME enable/disable
end_comment

begin_comment
comment|// - 4360 PCIe SerDes Tx amplitude/deemphasis (vendor Apple, boards
end_comment

begin_comment
comment|//   BCM94360X51P2, BCM94360X51A).
end_comment

begin_comment
comment|// - PCI latency timer (boards CB2_4321_BOARD, CB2_4321_AG_BOARD)
end_comment

begin_comment
comment|// - Max SerDes TX drive strength (vendor Apple, pcie>= rev10,
end_comment

begin_comment
comment|//   board BCM94322X9)
end_comment

begin_comment
comment|// - 700mV SerDes TX drive strength (chipid BCM4331, boards BCM94331X19,
end_comment

begin_comment
comment|//   BCM94331X28, BCM94331X29B, BCM94331X19C)
end_comment

begin_define
define|#
directive|define
name|BHND_PCI_SOFTC
parameter_list|(
name|_sc
parameter_list|)
value|(&((_sc)->common))
end_define

begin_define
define|#
directive|define
name|BHND_PCI_READ_2
parameter_list|(
name|_sc
parameter_list|,
name|_reg
parameter_list|)
define|\
value|bhnd_bus_read_2(BHND_PCI_SOFTC(_sc)->mem_res, (_reg))
end_define

begin_define
define|#
directive|define
name|BHND_PCI_READ_4
parameter_list|(
name|_sc
parameter_list|,
name|_reg
parameter_list|)
define|\
value|bhnd_bus_read_4(BHND_PCI_SOFTC(_sc)->mem_res, (_reg))
end_define

begin_define
define|#
directive|define
name|BHND_PCI_WRITE_2
parameter_list|(
name|_sc
parameter_list|,
name|_reg
parameter_list|,
name|_val
parameter_list|)
define|\
value|bhnd_bus_write_2(BHND_PCI_SOFTC(_sc)->mem_res, (_reg), (_val))
end_define

begin_define
define|#
directive|define
name|BHND_PCI_WRITE_4
parameter_list|(
name|_sc
parameter_list|,
name|_reg
parameter_list|,
name|_val
parameter_list|)
define|\
value|bhnd_bus_write_4(BHND_PCI_SOFTC(_sc)->mem_res, (_reg), (_val))
end_define

begin_define
define|#
directive|define
name|BHND_PCI_PROTO_READ_4
parameter_list|(
name|_sc
parameter_list|,
name|_reg
parameter_list|)
define|\
value|bhnd_pcie_read_proto_reg(BHND_PCI_SOFTC(_sc), (_reg))
end_define

begin_define
define|#
directive|define
name|BHND_PCI_PROTO_WRITE_4
parameter_list|(
name|_sc
parameter_list|,
name|_reg
parameter_list|,
name|_val
parameter_list|)
define|\
value|bhnd_pcie_write_proto_reg(BHND_PCI_SOFTC(_sc), (_reg), (_val))
end_define

begin_define
define|#
directive|define
name|BHND_PCI_MDIO_READ
parameter_list|(
name|_sc
parameter_list|,
name|_phy
parameter_list|,
name|_reg
parameter_list|)
define|\
value|bhnd_pcie_mdio_read(BHND_PCI_SOFTC(_sc), (_phy), (_reg))
end_define

begin_define
define|#
directive|define
name|BHND_PCI_MDIO_WRITE
parameter_list|(
name|_sc
parameter_list|,
name|_phy
parameter_list|,
name|_reg
parameter_list|,
name|_val
parameter_list|)
define|\
value|bhnd_pcie_mdio_write(BHND_PCI_SOFTC(_sc), (_phy), (_reg), (_val))
end_define

begin_define
define|#
directive|define
name|BPCI_REG_SET
parameter_list|(
name|_regv
parameter_list|,
name|_attr
parameter_list|,
name|_val
parameter_list|)
define|\
value|BHND_PCI_REG_SET((_regv), BHND_ ## _attr, (_val))
end_define

begin_define
define|#
directive|define
name|BPCI_REG_GET
parameter_list|(
name|_regv
parameter_list|,
name|_attr
parameter_list|)
define|\
value|BHND_PCI_REG_GET((_regv), BHND_ ## _attr)
end_define

begin_define
define|#
directive|define
name|BPCI_CMN_REG_SET
parameter_list|(
name|_regv
parameter_list|,
name|_attr
parameter_list|,
name|_val
parameter_list|)
define|\
value|BHND_PCI_CMN_REG_SET(BHND_PCI_SOFTC(_sc)->regfmt, (_regv),	\ 	    BHND_ ## _attr, (_val))
end_define

begin_define
define|#
directive|define
name|BPCI_CMN_REG_GET
parameter_list|(
name|_regv
parameter_list|,
name|_attr
parameter_list|)
define|\
value|BHND_PCI_CMN_REG_GET(BHND_PCI_SOFTC(_sc)->regfmt, (_regv),	\ 	    BHND_ ## _attr)
end_define

begin_function
specifier|static
name|int
name|bhnd_pci_hostb_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bhnd_pcihb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|quirks
operator|=
name|bhnd_device_quirks
argument_list|(
name|dev
argument_list|,
name|bhnd_pci_devs
argument_list|,
sizeof|sizeof
argument_list|(
name|bhnd_pci_devs
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pci_generic_attach
argument_list|(
name|dev
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Apply early single-shot work-arounds */
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pci_wars_early_once
argument_list|(
name|sc
argument_list|)
operator|)
condition|)
block|{
name|bhnd_pci_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Apply attach/resume work-arounds */
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pci_wars_hwup
argument_list|(
name|sc
argument_list|)
operator|)
condition|)
block|{
name|bhnd_pci_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bhnd_pci_hostb_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bhnd_pcihb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Apply suspend/detach work-arounds */
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pci_wars_hwdown
argument_list|(
name|sc
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
name|bhnd_pci_generic_detach
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bhnd_pci_hostb_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bhnd_pcihb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Apply suspend/detach work-arounds */
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pci_wars_hwdown
argument_list|(
name|sc
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
name|bhnd_pci_generic_suspend
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bhnd_pci_hostb_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bhnd_pcihb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pci_generic_resume
argument_list|(
name|dev
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Apply attach/resume work-arounds */
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pci_wars_hwup
argument_list|(
name|sc
argument_list|)
operator|)
condition|)
block|{
name|bhnd_pci_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * Apply any hardware work-arounds that must be executed exactly once, early in  * the attach process.  *   * This must be called after core enumeration and discovery of all applicable  * quirks, but prior to probe/attach of any cores, parsing of  * SPROM, etc.  */
end_comment

begin_function
specifier|static
name|int
name|bhnd_pci_wars_early_once
parameter_list|(
name|struct
name|bhnd_pcihb_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Determine correct polarity by observing the attach-time PCIe PHY 	 * link status. This is used later to reset/force the SerDes 	 * polarity */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCIE_QUIRK_SDR9_POLARITY
condition|)
block|{
name|uint32_t
name|st
decl_stmt|;
name|bool
name|inv
decl_stmt|;
name|st
operator|=
name|BHND_PCI_PROTO_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_PLP_STATUSREG
argument_list|)
expr_stmt|;
name|inv
operator|=
operator|(
operator|(
name|st
operator|&
name|BHND_PCIE_PLP_POLARITY_INV
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|sc
operator|->
name|sdr9_quirk_polarity
operator|.
name|inv
operator|=
name|inv
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * Apply any hardware workarounds that are required upon attach or resume  * of the bridge device.  */
end_comment

begin_function
specifier|static
name|int
name|bhnd_pci_wars_hwup
parameter_list|(
name|struct
name|bhnd_pcihb_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Note that the order here matters; these work-arounds 	 * should not be re-ordered without careful review of their 	 * interdependencies */
comment|/* Enable PCI prefetch/burst/readmulti flags */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCI_QUIRK_SBTOPCI2_PREF_BURST
operator|||
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCI_QUIRK_SBTOPCI2_READMULTI
condition|)
block|{
name|uint32_t
name|sbp2
decl_stmt|;
name|sbp2
operator|=
name|BHND_PCI_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCI_SBTOPCI2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCI_QUIRK_SBTOPCI2_PREF_BURST
condition|)
name|sbp2
operator||=
operator|(
name|BHND_PCI_SBTOPCI_PREF
operator||
name|BHND_PCI_SBTOPCI_BURST
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCI_QUIRK_SBTOPCI2_READMULTI
condition|)
name|sbp2
operator||=
name|BHND_PCI_SBTOPCI_RC_READMULTI
expr_stmt|;
name|BHND_PCI_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCI_SBTOPCI2
argument_list|,
name|sbp2
argument_list|)
expr_stmt|;
block|}
comment|/* Disable PCI CLKRUN# */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCI_QUIRK_CLKRUN_DSBL
condition|)
block|{
name|uint32_t
name|ctl
decl_stmt|;
name|ctl
operator|=
name|BHND_PCI_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCI_CLKRUN_CTL
argument_list|)
expr_stmt|;
name|ctl
operator||=
name|BHND_PCI_CLKRUN_DSBL
expr_stmt|;
name|BHND_PCI_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCI_CLKRUN_CTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
block|}
comment|/* Enable TLP unmatched address handling work-around */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCIE_QUIRK_UR_STATUS_FIX
condition|)
block|{
name|uint32_t
name|wrs
decl_stmt|;
name|wrs
operator|=
name|BHND_PCI_PROTO_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_TLP_WORKAROUNDSREG
argument_list|)
expr_stmt|;
name|wrs
operator||=
name|BHND_PCIE_TLP_WORKAROUND_URBIT
expr_stmt|;
name|BHND_PCI_PROTO_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_TLP_WORKAROUNDSREG
argument_list|,
name|wrs
argument_list|)
expr_stmt|;
block|}
comment|/* Adjust SerDes CDR tuning to ensure that CDR is stable before sending 	 * data during L0s to L0 exit transitions. */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCIE_QUIRK_SDR9_L0s_HANG
condition|)
block|{
name|uint16_t
name|sdv
decl_stmt|;
comment|/* Set RX track/acquire timers to 2.064us/40.96us */
name|sdv
operator|=
name|BPCI_REG_SET
argument_list|(
literal|0
argument_list|,
name|PCIE_SDR9_RX_TIMER1_LKTRK
argument_list|,
operator|(
literal|2064
operator|/
literal|16
operator|)
argument_list|)
expr_stmt|;
name|sdv
operator|=
name|BPCI_REG_SET
argument_list|(
name|sdv
argument_list|,
name|PCIE_SDR9_RX_TIMER1_LKACQ
argument_list|,
operator|(
literal|40960
operator|/
literal|1024
operator|)
argument_list|)
expr_stmt|;
name|BHND_PCI_MDIO_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_PHY_SDR9_TXRX
argument_list|,
name|BHND_PCIE_SDR9_RX_TIMER1
argument_list|,
name|sdv
argument_list|)
expr_stmt|;
comment|/* Apply CDR frequency workaround */
name|sdv
operator|=
name|BHND_PCIE_SDR9_RX_CDR_FREQ_OVR_EN
expr_stmt|;
name|sdv
operator|=
name|BPCI_REG_SET
argument_list|(
name|sdv
argument_list|,
name|PCIE_SDR9_RX_CDR_FREQ_OVR
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|BHND_PCI_MDIO_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_PHY_SDR9_TXRX
argument_list|,
name|BHND_PCIE_SDR9_RX_CDR
argument_list|,
name|sdv
argument_list|)
expr_stmt|;
comment|/* Apply CDR BW tunings */
name|sdv
operator|=
literal|0
expr_stmt|;
name|sdv
operator|=
name|BPCI_REG_SET
argument_list|(
name|sdv
argument_list|,
name|PCIE_SDR9_RX_CDRBW_INTGTRK
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|sdv
operator|=
name|BPCI_REG_SET
argument_list|(
name|sdv
argument_list|,
name|PCIE_SDR9_RX_CDRBW_INTGACQ
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|sdv
operator|=
name|BPCI_REG_SET
argument_list|(
name|sdv
argument_list|,
name|PCIE_SDR9_RX_CDRBW_PROPTRK
argument_list|,
literal|0x6
argument_list|)
expr_stmt|;
name|sdv
operator|=
name|BPCI_REG_SET
argument_list|(
name|sdv
argument_list|,
name|PCIE_SDR9_RX_CDRBW_PROPACQ
argument_list|,
literal|0x6
argument_list|)
expr_stmt|;
name|BHND_PCI_MDIO_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_PHY_SDR9_TXRX
argument_list|,
name|BHND_PCIE_SDR9_RX_CDRBW
argument_list|,
name|sdv
argument_list|)
expr_stmt|;
block|}
comment|/* Force correct SerDes polarity */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCIE_QUIRK_SDR9_POLARITY
condition|)
block|{
name|uint16_t
name|rxctl
decl_stmt|;
name|rxctl
operator|=
name|BHND_PCI_MDIO_READ
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_PHY_SDR9_TXRX
argument_list|,
name|BHND_PCIE_SDR9_RX_CTRL
argument_list|)
expr_stmt|;
name|rxctl
operator||=
name|BHND_PCIE_SDR9_RX_CTRL_FORCE
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sdr9_quirk_polarity
operator|.
name|inv
condition|)
name|rxctl
operator||=
name|BHND_PCIE_SDR9_RX_CTRL_POLARITY_INV
expr_stmt|;
else|else
name|rxctl
operator|&=
operator|~
name|BHND_PCIE_SDR9_RX_CTRL_POLARITY_INV
expr_stmt|;
name|BHND_PCI_MDIO_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_PHY_SDR9_TXRX
argument_list|,
name|BHND_PCIE_SDR9_RX_CTRL
argument_list|,
name|rxctl
argument_list|)
expr_stmt|;
block|}
comment|/* Disable startup retry on PLL frequency detection failure */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCIE_QUIRK_SDR9_NO_FREQRETRY
condition|)
block|{
name|uint16_t
name|pctl
decl_stmt|;
name|pctl
operator|=
name|BHND_PCI_MDIO_READ
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_PHY_SDR9_PLL
argument_list|,
name|BHND_PCIE_SDR9_PLL_CTRL
argument_list|)
expr_stmt|;
name|pctl
operator|&=
operator|~
name|BHND_PCIE_SDR9_PLL_CTRL_FREQDET_EN
expr_stmt|;
name|BHND_PCI_MDIO_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_PHY_SDR9_PLL
argument_list|,
name|BHND_PCIE_SDR9_PLL_CTRL
argument_list|,
name|pctl
argument_list|)
expr_stmt|;
block|}
comment|/* Explicitly enable PCI-PM */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCIE_QUIRK_PCIPM_REQEN
condition|)
block|{
name|uint32_t
name|lcreg
decl_stmt|;
name|lcreg
operator|=
name|BHND_PCI_PROTO_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_DLLP_LCREG
argument_list|)
expr_stmt|;
name|lcreg
operator||=
name|BHND_PCIE_DLLP_LCREG_PCIPM_EN
expr_stmt|;
name|BHND_PCI_PROTO_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_DLLP_LCREG
argument_list|,
name|lcreg
argument_list|)
expr_stmt|;
block|}
comment|/* Adjust L1 timer to fix slow L1->L0 transitions */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCIE_QUIRK_L1_IDLE_THRESH
condition|)
block|{
name|uint32_t
name|pmt
decl_stmt|;
name|pmt
operator|=
name|BHND_PCI_PROTO_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_DLLP_PMTHRESHREG
argument_list|)
expr_stmt|;
name|pmt
operator|=
name|BPCI_REG_SET
argument_list|(
name|pmt
argument_list|,
name|PCIE_L1THRESHOLDTIME
argument_list|,
name|BHND_PCIE_L1THRESHOLD_WARVAL
argument_list|)
expr_stmt|;
name|BHND_PCI_PROTO_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_DLLP_PMTHRESHREG
argument_list|,
name|pmt
argument_list|)
expr_stmt|;
block|}
comment|/* Extend L1 timer for better performance. 	 * TODO: We could enable/disable this on demand for better power 	 * savings if we tie this to HT clock request handling */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCIE_QUIRK_L1_TIMER_PERF
condition|)
block|{
name|uint32_t
name|pmt
decl_stmt|;
name|pmt
operator|=
name|BHND_PCI_PROTO_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_DLLP_PMTHRESHREG
argument_list|)
expr_stmt|;
name|pmt
operator||=
name|BHND_PCIE_ASPMTIMER_EXTEND
expr_stmt|;
name|BHND_PCI_PROTO_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_DLLP_PMTHRESHREG
argument_list|,
name|pmt
argument_list|)
expr_stmt|;
block|}
comment|/* Enable L23READY_EXIT_NOPRST if not already set in SPROM. */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCIE_QUIRK_SPROM_L23_PCI_RESET
condition|)
block|{
name|bus_size_t
name|reg
decl_stmt|;
name|uint16_t
name|cfg
decl_stmt|;
comment|/* Fetch the misc cfg flags from SPROM */
name|reg
operator|=
name|BHND_PCIE_SPROM_SHADOW
operator|+
name|BHND_PCIE_SRSH_PCIE_MISC_CONFIG
expr_stmt|;
name|cfg
operator|=
name|BHND_PCI_READ_2
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Write EXIT_NOPRST flag if not already set in SPROM */
if|if
condition|(
operator|!
operator|(
name|cfg
operator|&
name|BHND_PCIE_SRSH_L23READY_EXIT_NOPRST
operator|)
condition|)
block|{
name|cfg
operator||=
name|BHND_PCIE_SRSH_L23READY_EXIT_NOPRST
expr_stmt|;
name|BHND_PCI_WRITE_2
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * Apply any hardware workarounds that are required upon detach or suspend  * of the bridge device.  */
end_comment

begin_function
specifier|static
name|int
name|bhnd_pci_wars_hwdown
parameter_list|(
name|struct
name|bhnd_pcihb_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Reduce L1 timer for better power savings. 	 * TODO: We could enable/disable this on demand for better power 	 * savings if we tie this to HT clock request handling */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BHND_PCIE_QUIRK_L1_TIMER_PERF
condition|)
block|{
name|uint32_t
name|pmt
decl_stmt|;
name|pmt
operator|=
name|BHND_PCI_PROTO_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_DLLP_PMTHRESHREG
argument_list|)
expr_stmt|;
name|pmt
operator|&=
operator|~
name|BHND_PCIE_ASPMTIMER_EXTEND
expr_stmt|;
name|BHND_PCI_PROTO_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PCIE_DLLP_PMTHRESHREG
argument_list|,
name|pmt
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|bhnd_pci_hostb_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|bhnd_pci_hostb_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|bhnd_pci_hostb_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|bhnd_pci_hostb_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|bhnd_pci_hostb_resume
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DEFINE_CLASS_1
argument_list|(
name|bhnd_pci_hostb
argument_list|,
name|bhnd_pci_hostb_driver
argument_list|,
name|bhnd_pci_hostb_methods
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bhnd_pcihb_softc
argument_list|)
argument_list|,
name|bhnd_pci_driver
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|bhnd_hostb
argument_list|,
name|bhnd
argument_list|,
name|bhnd_pci_hostb_driver
argument_list|,
name|bhnd_hostb_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|bhnd_pci_hostb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|bhnd_pci_hostb
argument_list|,
name|bhnd_pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2016 Landon Fuller<landonf@FreeBSD.org>  * Copyright (C) 2010, Broadcom Corporation.  * All rights reserved.  *  * This file is derived from the hndpmu.c source contributed by Broadcom   * to to the Linux staging repository, as well as later revisions of hndpmu.c  * distributed with the Asus RT-N16 firmware source code release.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *   * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY  * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION  * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN  * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<dev/bhnd/bhnd.h>
end_include

begin_include
include|#
directive|include
file|<dev/bhnd/cores/chipc/chipc.h>
end_include

begin_include
include|#
directive|include
file|<dev/bhnd/cores/chipc/chipcreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/bhnd/bcma/bcma_dmp.h>
end_include

begin_include
include|#
directive|include
file|"bhnd_nvram_map.h"
end_include

begin_include
include|#
directive|include
file|"bhnd_pmureg.h"
end_include

begin_include
include|#
directive|include
file|"bhnd_pmuvar.h"
end_include

begin_include
include|#
directive|include
file|"bhnd_pmu_private.h"
end_include

begin_define
define|#
directive|define
name|PMU_LOG
parameter_list|(
name|_sc
parameter_list|,
name|_fmt
parameter_list|,
modifier|...
parameter_list|)
value|do {				\ 	if (_sc->dev != NULL)					\ 		device_printf(_sc->dev, _fmt, ##__VA_ARGS__);	\ 	else							\ 		printf(_fmt, ##__VA_ARGS__);			\ } while (0)
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|BCMDBG
end_ifdef

begin_define
define|#
directive|define
name|PMU_DEBUG
parameter_list|(
name|_sc
parameter_list|,
name|_fmt
parameter_list|,
modifier|...
parameter_list|)
value|PMU_LOG(_sc, _fmt, ##__VA_ARGS__)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|PMU_DEBUG
parameter_list|(
name|_sc
parameter_list|,
name|_fmt
parameter_list|,
modifier|...
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
name|struct
name|pmu0_xtaltab0
name|pmu0_xtaltab0_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|pmu1_xtaltab0
name|pmu1_xtaltab0_t
typedef|;
end_typedef

begin_comment
comment|/* PLL controls/clocks */
end_comment

begin_function_decl
specifier|static
specifier|const
name|pmu1_xtaltab0_t
modifier|*
name|bhnd_pmu1_xtaltab0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|pmu1_xtaltab0_t
modifier|*
name|bhnd_pmu1_xtaldef0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bhnd_pmu0_pllinit0
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|xtal
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bhnd_pmu0_cpuclk0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bhnd_pmu0_alpclk0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bhnd_pmu1_pllinit0
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|xtal
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bhnd_pmu1_pllfvco0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bhnd_pmu1_cpuclk0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bhnd_pmu1_alpclk0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bhnd_pmu5_clock
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|,
name|u_int
name|pll0
parameter_list|,
name|u_int
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bhnd_pmu6_4706_clock
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|,
name|u_int
name|pll0
parameter_list|,
name|u_int
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* PMU resources */
end_comment

begin_function_decl
specifier|static
name|bool
name|bhnd_pmu_res_depfltr_bb
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|bhnd_pmu_res_depfltr_ncb
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|bhnd_pmu_res_depfltr_paldo
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|bhnd_pmu_res_depfltr_npaldo
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bhnd_pmu_res_deps
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|rsrcs
parameter_list|,
name|bool
name|all
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bhnd_pmu_res_uptime
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|rsrc
parameter_list|,
name|uint32_t
modifier|*
name|uptime
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bhnd_pmu_res_masks
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
modifier|*
name|pmin
parameter_list|,
name|uint32_t
modifier|*
name|pmax
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bhnd_pmu_spuravoid_pllupdate
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|spuravoid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bhnd_pmu_set_4330_plldivs
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|BHND_PMU_REV
parameter_list|(
name|_sc
parameter_list|)
define|\
value|((uint8_t)BHND_PMU_GET_BITS((_sc)->caps, BHND_PMU_CAP_REV))
end_define

begin_define
define|#
directive|define
name|PMU_WAIT_CLKST
parameter_list|(
name|_sc
parameter_list|,
name|_val
parameter_list|,
name|_mask
parameter_list|)
define|\
value|bhnd_pmu_wait_clkst((_sc), (_sc)->dev, (_sc)->res,	\ 	    BHND_CLK_CTL_ST, (_val), (_mask))
end_define

begin_define
define|#
directive|define
name|PMURES_BIT
parameter_list|(
name|_bit
parameter_list|)
define|\
value|(1<< (BHND_PMU_ ## _bit))
end_define

begin_define
define|#
directive|define
name|PMU_CST4330_SDIOD_CHIPMODE
parameter_list|(
name|_sc
parameter_list|)
define|\
value|CHIPC_CST4330_CHIPMODE_SDIOD((_sc)->io->rd_chipst((_sc)->io_ctx))
end_define

begin_comment
comment|/**  * Initialize @p query state.  *   * @param[out] query On success, will be populated with a valid query instance  * state.  * @param dev The device owning @p query, or NULL.  * @param id The bhnd chip identification.  * @param io I/O callback functions.  * @param ctx I/O callback context.  *  * @retval 0 success  * @retval non-zero if the query state could not be initialized.  */
end_comment

begin_function
name|int
name|bhnd_pmu_query_init
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|query
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|struct
name|bhnd_chipid
name|id
parameter_list|,
specifier|const
name|struct
name|bhnd_pmu_io
modifier|*
name|io
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|query
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|query
operator|->
name|io
operator|=
name|io
expr_stmt|;
name|query
operator|->
name|io_ctx
operator|=
name|ctx
expr_stmt|;
name|query
operator|->
name|cid
operator|=
name|id
expr_stmt|;
name|query
operator|->
name|caps
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|query
argument_list|,
name|BHND_PMU_CAP
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * Release any resources held by @p query.  *   * @param query A query instance previously initialized via  * bhnd_pmu_query_init().  */
end_comment

begin_function
name|void
name|bhnd_pmu_query_fini
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|query
parameter_list|)
block|{
comment|/* nothing to do */
block|}
end_function

begin_comment
comment|/**  * Perform an indirect register read.  *   * @param addr Offset of the address register.  * @param data Offset of the data register.  * @param reg Indirect register to be read.  */
end_comment

begin_function
name|uint32_t
name|bhnd_pmu_ind_read
parameter_list|(
specifier|const
name|struct
name|bhnd_pmu_io
modifier|*
name|io
parameter_list|,
name|void
modifier|*
name|io_ctx
parameter_list|,
name|bus_size_t
name|addr
parameter_list|,
name|bus_size_t
name|data
parameter_list|,
name|uint32_t
name|reg
parameter_list|)
block|{
name|io
operator|->
name|wr4
argument_list|(
name|addr
argument_list|,
name|reg
argument_list|,
name|io_ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|io
operator|->
name|rd4
argument_list|(
name|data
argument_list|,
name|io_ctx
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * Perform an indirect register write.  *   * @param addr Offset of the address register.  * @param data Offset of the data register.  * @param reg Indirect register to be written.  * @param val Value to be written to @p reg.  * @param mask Only the bits defined by @p mask will be updated from @p val.  */
end_comment

begin_function
name|void
name|bhnd_pmu_ind_write
parameter_list|(
specifier|const
name|struct
name|bhnd_pmu_io
modifier|*
name|io
parameter_list|,
name|void
modifier|*
name|io_ctx
parameter_list|,
name|bus_size_t
name|addr
parameter_list|,
name|bus_size_t
name|data
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|val
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
block|{
name|uint32_t
name|rval
decl_stmt|;
name|io
operator|->
name|wr4
argument_list|(
name|addr
argument_list|,
name|reg
argument_list|,
name|io_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|!=
name|UINT32_MAX
condition|)
block|{
name|rval
operator|=
name|io
operator|->
name|rd4
argument_list|(
name|data
argument_list|,
name|io_ctx
argument_list|)
expr_stmt|;
name|rval
operator|&=
operator|~
name|mask
operator||
operator|(
name|val
operator|&
name|mask
operator|)
expr_stmt|;
block|}
else|else
block|{
name|rval
operator|=
name|val
expr_stmt|;
block|}
name|io
operator|->
name|wr4
argument_list|(
name|data
argument_list|,
name|rval
argument_list|,
name|io_ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Wait for up to BHND_PMU_MAX_TRANSITION_DLY microseconds for the per-core  * clock status to be equal to @p value after applying @p mask.  *   * @param sc PMU driver state.  * @param dev Requesting device.  * @param r An active resource mapping the clock status register.  * @param clkst_reg Offset to the CLK_CTL_ST register.  * @param value Value to wait for.  * @param mask Mask to apply prior to value comparison.  */
end_comment

begin_function
name|bool
name|bhnd_pmu_wait_clkst
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|struct
name|bhnd_resource
modifier|*
name|r
parameter_list|,
name|bus_size_t
name|clkst_reg
parameter_list|,
name|uint32_t
name|value
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
block|{
name|uint32_t
name|clkst
decl_stmt|;
comment|/* Bitswapped HTAVAIL/ALPAVAIL work-around */
if|if
condition|(
name|sc
operator|->
name|quirks
operator|&
name|BPMU_QUIRK_CLKCTL_CCS0
condition|)
block|{
name|uint32_t
name|fmask
decl_stmt|,
name|fval
decl_stmt|;
name|fmask
operator|=
name|mask
operator|&
operator|~
operator|(
name|BHND_CCS_HTAVAIL
operator||
name|BHND_CCS_ALPAVAIL
operator|)
expr_stmt|;
name|fval
operator|=
name|value
operator|&
operator|~
operator|(
name|BHND_CCS_HTAVAIL
operator||
name|BHND_CCS_ALPAVAIL
operator|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|BHND_CCS_HTAVAIL
condition|)
name|fmask
operator||=
name|BHND_CCS0_HTAVAIL
expr_stmt|;
if|if
condition|(
name|value
operator|&
name|BHND_CCS_HTAVAIL
condition|)
name|fval
operator||=
name|BHND_CCS0_HTAVAIL
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|BHND_CCS_ALPAVAIL
condition|)
name|fmask
operator||=
name|BHND_CCS0_ALPAVAIL
expr_stmt|;
if|if
condition|(
name|value
operator|&
name|BHND_CCS_ALPAVAIL
condition|)
name|fval
operator||=
name|BHND_CCS0_ALPAVAIL
expr_stmt|;
name|mask
operator|=
name|fmask
expr_stmt|;
name|value
operator|=
name|fval
expr_stmt|;
block|}
for|for
control|(
name|uint32_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|BHND_PMU_MAX_TRANSITION_DLY
condition|;
name|i
operator|+=
literal|10
control|)
block|{
name|clkst
operator|=
name|bhnd_bus_read_4
argument_list|(
name|r
argument_list|,
name|clkst_reg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|clkst
operator|&
name|mask
operator|)
operator|==
operator|(
name|value
operator|&
name|mask
operator|)
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"clkst wait timeout (value=%#x, "
literal|"mask=%#x)\n"
argument_list|,
name|value
argument_list|,
name|mask
argument_list|)
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Setup switcher voltage */
end_comment

begin_function
name|void
name|bhnd_pmu_set_switcher_voltage
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|bb_voltage
parameter_list|,
name|uint8_t
name|rf_voltage
parameter_list|)
block|{
name|BHND_PMU_REGCTRL_WRITE
argument_list|(
name|sc
argument_list|,
literal|0x01
argument_list|,
operator|(
name|bb_voltage
operator|&
literal|0x1f
operator|)
operator|<<
literal|22
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_REGCTRL_WRITE
argument_list|(
name|sc
argument_list|,
literal|0x00
argument_list|,
operator|(
name|rf_voltage
operator|&
literal|0x1f
operator|)
operator|<<
literal|14
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bhnd_pmu_set_ldo_voltage
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|ldo
parameter_list|,
name|uint8_t
name|voltage
parameter_list|)
block|{
name|uint32_t
name|chipst
decl_stmt|;
name|uint32_t
name|regctrl
decl_stmt|;
name|uint8_t
name|shift
decl_stmt|;
name|uint8_t
name|mask
decl_stmt|;
name|uint8_t
name|addr
decl_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4328
case|:
case|case
name|BHND_CHIPID_BCM5354
case|:
switch|switch
condition|(
name|ldo
condition|)
block|{
case|case
name|SET_LDO_VOLTAGE_LDO1
case|:
name|addr
operator|=
literal|2
expr_stmt|;
name|shift
operator|=
literal|17
operator|+
literal|8
expr_stmt|;
name|mask
operator|=
literal|0xf
expr_stmt|;
break|break;
case|case
name|SET_LDO_VOLTAGE_LDO2
case|:
name|addr
operator|=
literal|3
expr_stmt|;
name|shift
operator|=
literal|1
expr_stmt|;
name|mask
operator|=
literal|0xf
expr_stmt|;
break|break;
case|case
name|SET_LDO_VOLTAGE_LDO3
case|:
name|addr
operator|=
literal|3
expr_stmt|;
name|shift
operator|=
literal|9
expr_stmt|;
name|mask
operator|=
literal|0xf
expr_stmt|;
break|break;
case|case
name|SET_LDO_VOLTAGE_PAREF
case|:
name|addr
operator|=
literal|3
expr_stmt|;
name|shift
operator|=
literal|17
expr_stmt|;
name|mask
operator|=
literal|0x3f
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown BCM4328/BCM5354 LDO %hhu\n"
argument_list|,
name|ldo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BHND_CHIPID_BCM4312
case|:
switch|switch
condition|(
name|ldo
condition|)
block|{
case|case
name|SET_LDO_VOLTAGE_PAREF
case|:
name|addr
operator|=
literal|0
expr_stmt|;
name|shift
operator|=
literal|21
expr_stmt|;
name|mask
operator|=
literal|0x3f
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown BCM4312 LDO %hhu\n"
argument_list|,
name|ldo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BHND_CHIPID_BCM4325
case|:
switch|switch
condition|(
name|ldo
condition|)
block|{
case|case
name|SET_LDO_VOLTAGE_CLDO_PWM
case|:
name|addr
operator|=
literal|5
expr_stmt|;
name|shift
operator|=
literal|9
expr_stmt|;
name|mask
operator|=
literal|0xf
expr_stmt|;
break|break;
case|case
name|SET_LDO_VOLTAGE_CLDO_BURST
case|:
name|addr
operator|=
literal|5
expr_stmt|;
name|shift
operator|=
literal|13
expr_stmt|;
name|mask
operator|=
literal|0xf
expr_stmt|;
break|break;
case|case
name|SET_LDO_VOLTAGE_CBUCK_PWM
case|:
name|addr
operator|=
literal|3
expr_stmt|;
name|shift
operator|=
literal|20
expr_stmt|;
name|mask
operator|=
literal|0x1f
expr_stmt|;
comment|/* Bit 116& 119 are inverted in CLB for opt 2b */
name|chipst
operator|=
name|BHND_CHIPC_READ_CHIPST
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|BHND_PMU_GET_BITS
argument_list|(
name|chipst
argument_list|,
name|CHIPC_CST4325_PMUTOP_2B
argument_list|)
condition|)
name|voltage
operator|^=
literal|0x9
expr_stmt|;
break|break;
case|case
name|SET_LDO_VOLTAGE_CBUCK_BURST
case|:
name|addr
operator|=
literal|3
expr_stmt|;
name|shift
operator|=
literal|25
expr_stmt|;
name|mask
operator|=
literal|0x1f
expr_stmt|;
comment|/* Bit 121& 124 are inverted in CLB for opt 2b */
name|chipst
operator|=
name|BHND_CHIPC_READ_CHIPST
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|BHND_PMU_GET_BITS
argument_list|(
name|chipst
argument_list|,
name|CHIPC_CST4325_PMUTOP_2B
argument_list|)
condition|)
name|voltage
operator|^=
literal|0x9
expr_stmt|;
break|break;
case|case
name|SET_LDO_VOLTAGE_LNLDO1
case|:
name|addr
operator|=
literal|5
expr_stmt|;
name|shift
operator|=
literal|17
expr_stmt|;
name|mask
operator|=
literal|0x1f
expr_stmt|;
break|break;
case|case
name|SET_LDO_VOLTAGE_LNLDO2_SEL
case|:
name|addr
operator|=
literal|6
expr_stmt|;
name|shift
operator|=
literal|0
expr_stmt|;
name|mask
operator|=
literal|0x1
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown BCM4325 LDO %hhu\n"
argument_list|,
name|ldo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BHND_CHIPID_BCM4336
case|:
switch|switch
condition|(
name|ldo
condition|)
block|{
case|case
name|SET_LDO_VOLTAGE_CLDO_PWM
case|:
name|addr
operator|=
literal|4
expr_stmt|;
name|shift
operator|=
literal|1
expr_stmt|;
name|mask
operator|=
literal|0xf
expr_stmt|;
break|break;
case|case
name|SET_LDO_VOLTAGE_CLDO_BURST
case|:
name|addr
operator|=
literal|4
expr_stmt|;
name|shift
operator|=
literal|5
expr_stmt|;
name|mask
operator|=
literal|0xf
expr_stmt|;
break|break;
case|case
name|SET_LDO_VOLTAGE_LNLDO1
case|:
name|addr
operator|=
literal|4
expr_stmt|;
name|shift
operator|=
literal|17
expr_stmt|;
name|mask
operator|=
literal|0xf
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown BCM4336 LDO %hhu\n"
argument_list|,
name|ldo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BHND_CHIPID_BCM4330
case|:
switch|switch
condition|(
name|ldo
condition|)
block|{
case|case
name|SET_LDO_VOLTAGE_CBUCK_PWM
case|:
name|addr
operator|=
literal|3
expr_stmt|;
name|shift
operator|=
literal|0
expr_stmt|;
name|mask
operator|=
literal|0x1f
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown BCM4330 LDO %hhu\n"
argument_list|,
name|ldo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BHND_CHIPID_BCM4331
case|:
switch|switch
condition|(
name|ldo
condition|)
block|{
case|case
name|SET_LDO_VOLTAGE_PAREF
case|:
name|addr
operator|=
literal|1
expr_stmt|;
name|shift
operator|=
literal|0
expr_stmt|;
name|mask
operator|=
literal|0xf
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown BCM4331 LDO %hhu\n"
argument_list|,
name|ldo
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|panic
argument_list|(
literal|"cannot set LDO voltage on unsupported chip %hu\n"
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|)
expr_stmt|;
return|return;
block|}
name|regctrl
operator|=
operator|(
name|voltage
operator|&
name|mask
operator|)
operator|<<
name|shift
expr_stmt|;
name|BHND_PMU_REGCTRL_WRITE
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|regctrl
argument_list|,
name|mask
operator|<<
name|shift
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* d11 slow to fast clock transition time in slow clock cycles */
end_comment

begin_define
define|#
directive|define
name|D11SCC_SLOW2FAST_TRANSITION
value|2
end_define

begin_function
name|int
name|bhnd_pmu_fast_pwrup_delay
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
modifier|*
name|pwrup_delay
parameter_list|)
block|{
name|uint32_t
name|ilp
decl_stmt|;
name|uint32_t
name|uptime
decl_stmt|;
name|u_int
name|delay
decl_stmt|;
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM43224
case|:
case|case
name|BHND_CHIPID_BCM43225
case|:
case|case
name|BHND_CHIPID_BCM43421
case|:
case|case
name|BHND_CHIPID_BCM43235
case|:
case|case
name|BHND_CHIPID_BCM43236
case|:
case|case
name|BHND_CHIPID_BCM43238
case|:
case|case
name|BHND_CHIPID_BCM4331
case|:
case|case
name|BHND_CHIPID_BCM6362
case|:
case|case
name|BHND_CHIPID_BCM4313
case|:
name|delay
operator|=
literal|3700
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4325
case|:
name|error
operator|=
name|bhnd_pmu_res_uptime
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES4325_HT_AVAIL
argument_list|,
operator|&
name|uptime
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ilp
operator|=
name|bhnd_pmu_ilp_clock
argument_list|(
operator|&
name|sc
operator|->
name|query
argument_list|)
expr_stmt|;
name|delay
operator|=
operator|(
name|uptime
operator|+
name|D11SCC_SLOW2FAST_TRANSITION
operator|)
operator|*
operator|(
operator|(
literal|1000000
operator|+
name|ilp
operator|-
literal|1
operator|)
operator|/
name|ilp
operator|)
expr_stmt|;
name|delay
operator|=
operator|(
literal|11
operator|*
name|delay
operator|)
operator|/
literal|10
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4329
case|:
name|error
operator|=
name|bhnd_pmu_res_uptime
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES4329_HT_AVAIL
argument_list|,
operator|&
name|uptime
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ilp
operator|=
name|bhnd_pmu_ilp_clock
argument_list|(
operator|&
name|sc
operator|->
name|query
argument_list|)
expr_stmt|;
name|delay
operator|=
operator|(
name|uptime
operator|+
name|D11SCC_SLOW2FAST_TRANSITION
operator|)
operator|*
operator|(
operator|(
literal|1000000
operator|+
name|ilp
operator|-
literal|1
operator|)
operator|/
name|ilp
operator|)
expr_stmt|;
name|delay
operator|=
operator|(
literal|11
operator|*
name|delay
operator|)
operator|/
literal|10
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4319
case|:
name|delay
operator|=
literal|3700
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4336
case|:
name|error
operator|=
name|bhnd_pmu_res_uptime
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES4336_HT_AVAIL
argument_list|,
operator|&
name|uptime
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ilp
operator|=
name|bhnd_pmu_ilp_clock
argument_list|(
operator|&
name|sc
operator|->
name|query
argument_list|)
expr_stmt|;
name|delay
operator|=
operator|(
name|uptime
operator|+
name|D11SCC_SLOW2FAST_TRANSITION
operator|)
operator|*
operator|(
operator|(
literal|1000000
operator|+
name|ilp
operator|-
literal|1
operator|)
operator|/
name|ilp
operator|)
expr_stmt|;
name|delay
operator|=
operator|(
literal|11
operator|*
name|delay
operator|)
operator|/
literal|10
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4330
case|:
name|error
operator|=
name|bhnd_pmu_res_uptime
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES4330_HT_AVAIL
argument_list|,
operator|&
name|uptime
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ilp
operator|=
name|bhnd_pmu_ilp_clock
argument_list|(
operator|&
name|sc
operator|->
name|query
argument_list|)
expr_stmt|;
name|delay
operator|=
operator|(
name|uptime
operator|+
name|D11SCC_SLOW2FAST_TRANSITION
operator|)
operator|*
operator|(
operator|(
literal|1000000
operator|+
name|ilp
operator|-
literal|1
operator|)
operator|/
name|ilp
operator|)
expr_stmt|;
name|delay
operator|=
operator|(
literal|11
operator|*
name|delay
operator|)
operator|/
literal|10
expr_stmt|;
break|break;
default|default:
name|delay
operator|=
name|BHND_PMU_MAX_TRANSITION_DLY
expr_stmt|;
break|break;
block|}
operator|*
name|pwrup_delay
operator|=
operator|(
name|uint16_t
operator|)
name|delay
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|bhnd_pmu_force_ilp
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|bool
name|force
parameter_list|)
block|{
name|uint32_t
name|orig
decl_stmt|;
name|uint32_t
name|pctrl
decl_stmt|;
name|pctrl
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|)
expr_stmt|;
name|orig
operator|=
name|pctrl
expr_stmt|;
if|if
condition|(
name|force
condition|)
name|pctrl
operator|&=
operator|~
operator|(
name|BHND_PMU_CTRL_HT_REQ_EN
operator||
name|BHND_PMU_CTRL_ALP_REQ_EN
operator|)
expr_stmt|;
else|else
name|pctrl
operator||=
operator|(
name|BHND_PMU_CTRL_HT_REQ_EN
operator||
name|BHND_PMU_CTRL_ALP_REQ_EN
operator|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|,
name|pctrl
argument_list|)
expr_stmt|;
return|return
operator|(
name|orig
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Setup resource up/down timers */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|uint8_t
name|resnum
decl_stmt|;
name|uint16_t
name|updown
decl_stmt|;
block|}
name|pmu_res_updown_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|bool
function_decl|(
modifier|*
name|pmu_res_filter
function_decl|)
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_typedef

begin_comment
comment|/* Change resource dependencies masks */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|uint32_t
name|res_mask
decl_stmt|;
comment|/* resources (chip specific) */
name|int8_t
name|action
decl_stmt|;
comment|/* action */
name|uint32_t
name|depend_mask
decl_stmt|;
comment|/* changes to the dependencies mask */
name|pmu_res_filter
name|filter
decl_stmt|;
comment|/* action is taken when filter is NULL or returns true */
block|}
name|pmu_res_depend_t
typedef|;
end_typedef

begin_comment
comment|/* Resource dependencies mask change action */
end_comment

begin_define
define|#
directive|define
name|RES_DEPEND_SET
value|0
end_define

begin_comment
comment|/* Override the dependencies mask */
end_comment

begin_define
define|#
directive|define
name|RES_DEPEND_ADD
value|1
end_define

begin_comment
comment|/* Add to the  dependencies mask */
end_comment

begin_define
define|#
directive|define
name|RES_DEPEND_REMOVE
value|-1
end_define

begin_comment
comment|/* Remove from the dependencies mask */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_updown_t
name|bcm4328a0_res_updown
index|[]
init|=
block|{
block|{
name|BHND_PMU_RES4328_EXT_SWITCHER_PWM
block|,
literal|0x0101
block|}
block|,
block|{
name|BHND_PMU_RES4328_BB_SWITCHER_PWM
block|,
literal|0x1f01
block|}
block|,
block|{
name|BHND_PMU_RES4328_BB_SWITCHER_BURST
block|,
literal|0x010f
block|}
block|,
block|{
name|BHND_PMU_RES4328_BB_EXT_SWITCHER_BURST
block|,
literal|0x0101
block|}
block|,
block|{
name|BHND_PMU_RES4328_ILP_REQUEST
block|,
literal|0x0202
block|}
block|,
block|{
name|BHND_PMU_RES4328_RADIO_SWITCHER_PWM
block|,
literal|0x0f01
block|}
block|,
block|{
name|BHND_PMU_RES4328_RADIO_SWITCHER_BURST
block|,
literal|0x0f01
block|}
block|,
block|{
name|BHND_PMU_RES4328_ROM_SWITCH
block|,
literal|0x0101
block|}
block|,
block|{
name|BHND_PMU_RES4328_PA_REF_LDO
block|,
literal|0x0f01
block|}
block|,
block|{
name|BHND_PMU_RES4328_RADIO_LDO
block|,
literal|0x0f01
block|}
block|,
block|{
name|BHND_PMU_RES4328_AFE_LDO
block|,
literal|0x0f01
block|}
block|,
block|{
name|BHND_PMU_RES4328_PLL_LDO
block|,
literal|0x0f01
block|}
block|,
block|{
name|BHND_PMU_RES4328_BG_FILTBYP
block|,
literal|0x0101
block|}
block|,
block|{
name|BHND_PMU_RES4328_TX_FILTBYP
block|,
literal|0x0101
block|}
block|,
block|{
name|BHND_PMU_RES4328_RX_FILTBYP
block|,
literal|0x0101
block|}
block|,
block|{
name|BHND_PMU_RES4328_XTAL_PU
block|,
literal|0x0101
block|}
block|,
block|{
name|BHND_PMU_RES4328_XTAL_EN
block|,
literal|0xa001
block|}
block|,
block|{
name|BHND_PMU_RES4328_BB_PLL_FILTBYP
block|,
literal|0x0101
block|}
block|,
block|{
name|BHND_PMU_RES4328_RF_PLL_FILTBYP
block|,
literal|0x0101
block|}
block|,
block|{
name|BHND_PMU_RES4328_BB_PLL_PU
block|,
literal|0x0701
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_depend_t
name|bcm4328a0_res_depend
index|[]
init|=
block|{
comment|/* Adjust ILP request resource not to force ext/BB switchers into burst mode */
block|{
name|PMURES_BIT
argument_list|(
name|RES4328_ILP_REQUEST
argument_list|)
block|,
name|RES_DEPEND_SET
block|,
name|PMURES_BIT
argument_list|(
name|RES4328_EXT_SWITCHER_PWM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4328_BB_SWITCHER_PWM
argument_list|)
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_updown_t
name|bcm4325a0_res_updown
index|[]
init|=
block|{
block|{
name|BHND_PMU_RES4325_XTAL_PU
block|,
literal|0x1501
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_depend_t
name|bcm4325a0_res_depend
index|[]
init|=
block|{
comment|/* Adjust OTP PU resource dependencies - remove BB BURST */
block|{
name|PMURES_BIT
argument_list|(
name|RES4325_OTP_PU
argument_list|)
block|,
name|RES_DEPEND_REMOVE
block|,
name|PMURES_BIT
argument_list|(
name|RES4325_BUCK_BOOST_BURST
argument_list|)
block|,
name|NULL
block|}
block|,
comment|/* Adjust ALP/HT Avail resource dependencies - bring up BB along if it is used. */
block|{
name|PMURES_BIT
argument_list|(
name|RES4325_ALP_AVAIL
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_HT_AVAIL
argument_list|)
block|,
name|RES_DEPEND_ADD
block|,
name|PMURES_BIT
argument_list|(
name|RES4325_BUCK_BOOST_BURST
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_BUCK_BOOST_PWM
argument_list|)
block|,
name|bhnd_pmu_res_depfltr_bb
block|}
block|,
comment|/* Adjust HT Avail resource dependencies - bring up RF switches along with HT. */
block|{
name|PMURES_BIT
argument_list|(
name|RES4325_HT_AVAIL
argument_list|)
block|,
name|RES_DEPEND_ADD
block|,
name|PMURES_BIT
argument_list|(
name|RES4325_RX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_TX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_LOGEN_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_AFE_PWRSW_PU
argument_list|)
block|,
name|NULL
block|}
block|,
comment|/* Adjust ALL resource dependencies - remove CBUCK dependencies if it is not used. */
block|{
name|PMURES_BIT
argument_list|(
name|RES4325_ILP_REQUEST
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_ABUCK_BURST
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_ABUCK_PWM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_LNLDO1_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325C1_LNLDO2_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_XTAL_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_ALP_AVAIL
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_RX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_TX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_RFPLL_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_LOGEN_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_AFE_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_BBPLL_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_HT_AVAIL
argument_list|)
block|,
name|RES_DEPEND_REMOVE
block|,
name|PMURES_BIT
argument_list|(
name|RES4325B0_CBUCK_LPOM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325B0_CBUCK_BURST
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325B0_CBUCK_PWM
argument_list|)
block|,
name|bhnd_pmu_res_depfltr_ncb
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_updown_t
name|bcm4315a0_res_updown
index|[]
init|=
block|{
block|{
name|BHND_PMU_RES4315_XTAL_PU
block|,
literal|0x2501
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_depend_t
name|bcm4315a0_res_depend
index|[]
init|=
block|{
comment|/* Adjust OTP PU resource dependencies - not need PALDO unless write */
block|{
name|PMURES_BIT
argument_list|(
name|RES4315_OTP_PU
argument_list|)
block|,
name|RES_DEPEND_REMOVE
block|,
name|PMURES_BIT
argument_list|(
name|RES4315_PALDO_PU
argument_list|)
block|,
name|bhnd_pmu_res_depfltr_npaldo
block|}
block|,
comment|/* Adjust ALP/HT Avail resource dependencies - bring up PALDO along if it is used. */
block|{
name|PMURES_BIT
argument_list|(
name|RES4315_ALP_AVAIL
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_HT_AVAIL
argument_list|)
block|,
name|RES_DEPEND_ADD
block|,
name|PMURES_BIT
argument_list|(
name|RES4315_PALDO_PU
argument_list|)
block|,
name|bhnd_pmu_res_depfltr_paldo
block|}
block|,
comment|/* Adjust HT Avail resource dependencies - bring up RF switches along with HT. */
block|{
name|PMURES_BIT
argument_list|(
name|RES4315_HT_AVAIL
argument_list|)
block|,
name|RES_DEPEND_ADD
block|,
name|PMURES_BIT
argument_list|(
name|RES4315_RX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_TX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_LOGEN_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_AFE_PWRSW_PU
argument_list|)
block|,
name|NULL
block|}
block|,
comment|/* Adjust ALL resource dependencies - remove CBUCK dependencies if it is not used. */
block|{
name|PMURES_BIT
argument_list|(
name|RES4315_CLDO_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_ILP_REQUEST
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_LNLDO1_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_OTP_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_LNLDO2_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_XTAL_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_ALP_AVAIL
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_RX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_TX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_RFPLL_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_LOGEN_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_AFE_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_BBPLL_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_HT_AVAIL
argument_list|)
block|,
name|RES_DEPEND_REMOVE
block|,
name|PMURES_BIT
argument_list|(
name|RES4315_CBUCK_LPOM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_CBUCK_BURST
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4315_CBUCK_PWM
argument_list|)
block|,
name|bhnd_pmu_res_depfltr_ncb
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 4329 specific. needs to come back this issue later */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_updown_t
name|bcm4329_res_updown
index|[]
init|=
block|{
block|{
name|BHND_PMU_RES4329_XTAL_PU
block|,
literal|0x1501
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_depend_t
name|bcm4329_res_depend
index|[]
init|=
block|{
comment|/* Adjust HT Avail resource dependencies */
block|{
name|PMURES_BIT
argument_list|(
name|RES4329_HT_AVAIL
argument_list|)
block|,
name|RES_DEPEND_ADD
block|,
name|PMURES_BIT
argument_list|(
name|RES4329_CBUCK_LPOM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_CBUCK_BURST
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_CBUCK_PWM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_CLDO_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_PALDO_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_LNLDO1_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_XTAL_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_ALP_AVAIL
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_RX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_TX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_RFPLL_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_LOGEN_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_AFE_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_BBPLL_PWRSW_PU
argument_list|)
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_updown_t
name|bcm4319a0_res_updown
index|[]
init|=
block|{
block|{
name|BHND_PMU_RES4319_XTAL_PU
block|,
literal|0x3f01
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_depend_t
name|bcm4319a0_res_depend
index|[]
init|=
block|{
comment|/* Adjust OTP PU resource dependencies - not need PALDO unless write */
block|{
name|PMURES_BIT
argument_list|(
name|RES4319_OTP_PU
argument_list|)
block|,
name|RES_DEPEND_REMOVE
block|,
name|PMURES_BIT
argument_list|(
name|RES4319_PALDO_PU
argument_list|)
block|,
name|bhnd_pmu_res_depfltr_npaldo
block|}
block|,
comment|/* Adjust HT Avail resource dependencies - bring up PALDO along if it is used. */
block|{
name|PMURES_BIT
argument_list|(
name|RES4319_HT_AVAIL
argument_list|)
block|,
name|RES_DEPEND_ADD
block|,
name|PMURES_BIT
argument_list|(
name|RES4319_PALDO_PU
argument_list|)
block|,
name|bhnd_pmu_res_depfltr_paldo
block|}
block|,
comment|/* Adjust HT Avail resource dependencies - bring up RF switches along with HT. */
block|{
name|PMURES_BIT
argument_list|(
name|RES4319_HT_AVAIL
argument_list|)
block|,
name|RES_DEPEND_ADD
block|,
name|PMURES_BIT
argument_list|(
name|RES4319_RX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4319_TX_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4319_RFPLL_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4319_LOGEN_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4319_AFE_PWRSW_PU
argument_list|)
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_updown_t
name|bcm4336a0_res_updown
index|[]
init|=
block|{
block|{
name|BHND_PMU_RES4336_HT_AVAIL
block|,
literal|0x0D01
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_depend_t
name|bcm4336a0_res_depend
index|[]
init|=
block|{
comment|/* Just a dummy entry for now */
block|{
name|PMURES_BIT
argument_list|(
name|RES4336_RSVD
argument_list|)
block|,
name|RES_DEPEND_ADD
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_updown_t
name|bcm4330a0_res_updown
index|[]
init|=
block|{
block|{
name|BHND_PMU_RES4330_HT_AVAIL
block|,
literal|0x0e02
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|pmu_res_depend_t
name|bcm4330a0_res_depend
index|[]
init|=
block|{
comment|/* Just a dummy entry for now */
block|{
name|PMURES_BIT
argument_list|(
name|RES4330_HT_AVAIL
argument_list|)
block|,
name|RES_DEPEND_ADD
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* true if the power topology uses the buck boost to provide 3.3V to VDDIO_RF  * and WLAN PA */
end_comment

begin_function
specifier|static
name|bool
name|bhnd_pmu_res_depfltr_bb
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
operator|(
name|BHND_PMU_GET_FLAG
argument_list|(
name|sc
operator|->
name|board
operator|.
name|board_flags
argument_list|,
name|BHND_BFL_BUCKBOOST
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* true if the power topology doesn't use the cbuck. Key on chiprev also if  * the chip is BCM4325. */
end_comment

begin_function
specifier|static
name|bool
name|bhnd_pmu_res_depfltr_ncb
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4325
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|<=
literal|1
condition|)
return|return
operator|(
name|false
operator|)
return|;
return|return
operator|(
name|BHND_PMU_GET_FLAG
argument_list|(
name|sc
operator|->
name|board
operator|.
name|board_flags
argument_list|,
name|BHND_BFL_NOCBUCK
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* true if the power topology uses the PALDO */
end_comment

begin_function
specifier|static
name|bool
name|bhnd_pmu_res_depfltr_paldo
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
operator|(
name|BHND_PMU_GET_FLAG
argument_list|(
name|sc
operator|->
name|board
operator|.
name|board_flags
argument_list|,
name|BHND_BFL_PALDO
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* true if the power topology doesn't use the PALDO */
end_comment

begin_function
specifier|static
name|bool
name|bhnd_pmu_res_depfltr_npaldo
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
operator|(
operator|!
name|BHND_PMU_GET_FLAG
argument_list|(
name|sc
operator|->
name|board
operator|.
name|board_flags
argument_list|,
name|BHND_BFL_PALDO
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Determine min/max rsrc masks. Value 0 leaves hardware at default. */
end_comment

begin_function
specifier|static
name|int
name|bhnd_pmu_res_masks
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
modifier|*
name|pmin
parameter_list|,
name|uint32_t
modifier|*
name|pmax
parameter_list|)
block|{
name|uint32_t
name|max_mask
decl_stmt|,
name|min_mask
decl_stmt|;
name|uint32_t
name|chipst
decl_stmt|,
name|otpsel
decl_stmt|;
name|uint32_t
name|nval
decl_stmt|;
name|uint8_t
name|rsrcs
decl_stmt|;
name|int
name|error
decl_stmt|;
name|max_mask
operator|=
literal|0
expr_stmt|;
name|min_mask
operator|=
literal|0
expr_stmt|;
comment|/* # resources */
name|rsrcs
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|sc
operator|->
name|caps
argument_list|,
name|BHND_PMU_CAP_RC
argument_list|)
expr_stmt|;
comment|/* determine min/max rsrc masks */
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4325
case|:
comment|/* If used by this device, enable the CBUCK */
if|if
condition|(
operator|!
name|bhnd_pmu_res_depfltr_ncb
argument_list|(
name|sc
argument_list|)
condition|)
name|min_mask
operator||=
name|PMURES_BIT
argument_list|(
name|RES4325B0_CBUCK_LPOM
argument_list|)
expr_stmt|;
name|chipst
operator|=
name|BHND_CHIPC_READ_CHIPST
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|BHND_PMU_GET_BITS
argument_list|(
name|chipst
argument_list|,
name|CHIPC_CST4325_PMUTOP_2B
argument_list|)
condition|)
name|min_mask
operator||=
name|PMURES_BIT
argument_list|(
name|RES4325B0_CLDO_PU
argument_list|)
expr_stmt|;
comment|/* Is OTP required? */
name|otpsel
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|chipst
argument_list|,
name|CHIPC_CST4325_SPROM_OTP_SEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|otpsel
operator|!=
name|CHIPC_CST_OTP_PWRDN
condition|)
name|min_mask
operator||=
name|PMURES_BIT
argument_list|(
name|RES4325_OTP_PU
argument_list|)
expr_stmt|;
comment|/* Leave buck boost on in burst mode for certain boards */
if|if
condition|(
name|sc
operator|->
name|board
operator|.
name|board_flags
operator|&
name|BHND_BFL_BUCKBOOST
condition|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|board
operator|.
name|board_type
condition|)
block|{
case|case
name|BHND_BOARD_BCM94325DEVBU
case|:
case|case
name|BHND_BOARD_BCM94325BGABU
case|:
name|min_mask
operator||=
name|PMURES_BIT
argument_list|(
name|RES4325_BUCK_BOOST_BURST
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* Allow all resources to be turned on upon requests */
name|max_mask
operator|=
operator|~
operator|(
operator|~
literal|0
operator|<<
name|rsrcs
operator|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4312
case|:
comment|/* default min_mask = 0x80000cbb is wrong */
name|min_mask
operator|=
literal|0xcbb
expr_stmt|;
comment|/* 		 * max_mask = 0x7fff; 		 * pmu_res_updown_table_sz = 0; 		 * pmu_res_depend_table_sz = 0; 		 */
break|break;
case|case
name|BHND_CHIPID_BCM4322
case|:
case|case
name|BHND_CHIPID_BCM43221
case|:
case|case
name|BHND_CHIPID_BCM43231
case|:
case|case
name|BHND_CHIPID_BCM4342
case|:
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|>=
literal|2
condition|)
break|break;
comment|/* request ALP(can skip for A1) */
name|min_mask
operator|=
name|PMURES_BIT
argument_list|(
name|RES4322_RF_LDO
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4322_XTAL_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4322_ALP_AVAIL
argument_list|)
expr_stmt|;
if|if
condition|(
name|bhnd_get_attach_type
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|)
operator|==
name|BHND_ATTACH_NATIVE
condition|)
block|{
name|min_mask
operator||=
name|PMURES_BIT
argument_list|(
name|RES4322_SI_PLL_ON
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4322_HT_SI_AVAIL
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4322_PHY_PLL_ON
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4322_OTP_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4322_HT_PHY_AVAIL
argument_list|)
expr_stmt|;
name|max_mask
operator|=
literal|0x1ff
expr_stmt|;
block|}
break|break;
case|case
name|BHND_CHIPID_BCM43222
case|:
case|case
name|BHND_CHIPID_BCM43111
case|:
case|case
name|BHND_CHIPID_BCM43112
case|:
case|case
name|BHND_CHIPID_BCM43224
case|:
case|case
name|BHND_CHIPID_BCM43225
case|:
case|case
name|BHND_CHIPID_BCM43421
case|:
case|case
name|BHND_CHIPID_BCM43226
case|:
case|case
name|BHND_CHIPID_BCM43420
case|:
case|case
name|BHND_CHIPID_BCM43235
case|:
case|case
name|BHND_CHIPID_BCM43236
case|:
case|case
name|BHND_CHIPID_BCM43238
case|:
case|case
name|BHND_CHIPID_BCM43234
case|:
case|case
name|BHND_CHIPID_BCM43237
case|:
case|case
name|BHND_CHIPID_BCM4331
case|:
case|case
name|BHND_CHIPID_BCM43431
case|:
case|case
name|BHND_CHIPID_BCM6362
case|:
comment|/* use chip default */
break|break;
case|case
name|BHND_CHIPID_BCM4328
case|:
name|min_mask
operator|=
name|PMURES_BIT
argument_list|(
name|RES4328_BB_SWITCHER_PWM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4328_EXT_SWITCHER_PWM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4328_XTAL_EN
argument_list|)
expr_stmt|;
name|max_mask
operator|=
literal|0xfffffff
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM5354
case|:
comment|/* Allow (but don't require) PLL to turn on */
name|max_mask
operator|=
literal|0xfffffff
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4329
case|:
comment|/* Down to save the power. */
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|>=
literal|0x2
condition|)
block|{
name|min_mask
operator|=
name|PMURES_BIT
argument_list|(
name|RES4329_CBUCK_LPOM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_LNLDO1_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_CLDO_PU
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|min_mask
operator|=
name|PMURES_BIT
argument_list|(
name|RES4329_CBUCK_LPOM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_CLDO_PU
argument_list|)
expr_stmt|;
block|}
comment|/* Is OTP required? */
name|chipst
operator|=
name|BHND_CHIPC_READ_CHIPST
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|)
expr_stmt|;
name|otpsel
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|chipst
argument_list|,
name|CHIPC_CST4329_SPROM_OTP_SEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|otpsel
operator|!=
name|CHIPC_CST_OTP_PWRDN
condition|)
name|min_mask
operator||=
name|PMURES_BIT
argument_list|(
name|RES4329_OTP_PU
argument_list|)
expr_stmt|;
comment|/* Allow (but don't require) PLL to turn on */
name|max_mask
operator|=
literal|0x3ff63e
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4319
case|:
comment|/* We only need a few resources to be kept on all the time */
name|min_mask
operator|=
name|PMURES_BIT
argument_list|(
name|RES4319_CBUCK_LPOM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4319_CLDO_PU
argument_list|)
expr_stmt|;
comment|/* Allow everything else to be turned on upon requests */
name|max_mask
operator|=
operator|~
operator|(
operator|~
literal|0
operator|<<
name|rsrcs
operator|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4336
case|:
comment|/* Down to save the power. */
name|min_mask
operator|=
name|PMURES_BIT
argument_list|(
name|RES4336_CBUCK_LPOM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4336_CLDO_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4336_LDO3P3_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4336_OTP_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4336_DIS_INT_RESET_PD
argument_list|)
expr_stmt|;
comment|/* Allow (but don't require) PLL to turn on */
name|max_mask
operator|=
literal|0x1ffffff
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4330
case|:
comment|/* Down to save the power. */
name|min_mask
operator|=
name|PMURES_BIT
argument_list|(
name|RES4330_CBUCK_LPOM
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4330_CLDO_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4330_DIS_INT_RESET_PD
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4330_LDO3P3_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4330_OTP_PU
argument_list|)
expr_stmt|;
comment|/* Allow (but don't require) PLL to turn on */
name|max_mask
operator|=
literal|0xfffffff
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4313
case|:
name|min_mask
operator|=
name|PMURES_BIT
argument_list|(
name|RES4313_BB_PU_RSRC
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4313_XTAL_PU_RSRC
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4313_ALP_AVAIL_RSRC
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4313_BB_PLL_PWRSW_RSRC
argument_list|)
expr_stmt|;
name|max_mask
operator|=
literal|0xffff
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* Apply nvram override to min mask */
name|error
operator|=
name|bhnd_nvram_getvar_uint32
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|,
name|BHND_NVAR_RMIN
argument_list|,
operator|&
name|nval
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|&&
name|error
operator|!=
name|ENOENT
condition|)
block|{
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"NVRAM error reading %s: %d\n"
argument_list|,
name|BHND_NVAR_RMIN
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Applying rmin=%#x to min_mask\n"
argument_list|,
name|nval
argument_list|)
expr_stmt|;
name|min_mask
operator|=
name|nval
expr_stmt|;
block|}
comment|/* Apply nvram override to max mask */
name|error
operator|=
name|bhnd_nvram_getvar_uint32
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|,
name|BHND_NVAR_RMAX
argument_list|,
operator|&
name|nval
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|&&
name|error
operator|!=
name|ENOENT
condition|)
block|{
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"NVRAM error reading %s: %d\n"
argument_list|,
name|BHND_NVAR_RMAX
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Applying rmax=%#x to max_mask\n"
argument_list|,
name|nval
argument_list|)
expr_stmt|;
name|min_mask
operator|=
name|nval
expr_stmt|;
block|}
if|if
condition|(
name|pmin
operator|!=
name|NULL
condition|)
operator|*
name|pmin
operator|=
name|min_mask
expr_stmt|;
if|if
condition|(
name|pmax
operator|!=
name|NULL
condition|)
operator|*
name|pmax
operator|=
name|max_mask
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* initialize PMU resources */
end_comment

begin_function
name|int
name|bhnd_pmu_res_init
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|pmu_res_updown_t
modifier|*
name|pmu_res_updown_table
decl_stmt|;
specifier|const
name|pmu_res_depend_t
modifier|*
name|pmu_res_depend_table
decl_stmt|;
name|size_t
name|pmu_res_updown_table_sz
decl_stmt|;
name|size_t
name|pmu_res_depend_table_sz
decl_stmt|;
name|uint32_t
name|max_mask
decl_stmt|,
name|min_mask
decl_stmt|;
name|uint8_t
name|rsrcs
decl_stmt|;
name|int
name|error
decl_stmt|;
name|pmu_res_depend_table
operator|=
name|NULL
expr_stmt|;
name|pmu_res_depend_table_sz
operator|=
literal|0
expr_stmt|;
name|pmu_res_updown_table
operator|=
name|NULL
expr_stmt|;
name|pmu_res_updown_table_sz
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4315
case|:
comment|/* Optimize resources up/down timers */
name|pmu_res_updown_table
operator|=
name|bcm4315a0_res_updown
expr_stmt|;
name|pmu_res_updown_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4315a0_res_updown
argument_list|)
expr_stmt|;
comment|/* Optimize resources dependencies */
name|pmu_res_depend_table
operator|=
name|bcm4315a0_res_depend
expr_stmt|;
name|pmu_res_depend_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4315a0_res_depend
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4325
case|:
comment|/* Optimize resources up/down timers */
name|pmu_res_updown_table
operator|=
name|bcm4325a0_res_updown
expr_stmt|;
name|pmu_res_updown_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4325a0_res_updown
argument_list|)
expr_stmt|;
comment|/* Optimize resources dependencies */
name|pmu_res_depend_table
operator|=
name|bcm4325a0_res_depend
expr_stmt|;
name|pmu_res_depend_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4325a0_res_depend
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4328
case|:
comment|/* Optimize resources up/down timers */
name|pmu_res_updown_table
operator|=
name|bcm4328a0_res_updown
expr_stmt|;
name|pmu_res_updown_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4328a0_res_updown
argument_list|)
expr_stmt|;
comment|/* Optimize resources dependencies */
name|pmu_res_depend_table
operator|=
name|bcm4328a0_res_depend
expr_stmt|;
name|pmu_res_depend_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4328a0_res_depend
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4329
case|:
comment|/* Optimize resources up/down timers */
name|pmu_res_updown_table
operator|=
name|bcm4329_res_updown
expr_stmt|;
name|pmu_res_updown_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4329_res_updown
argument_list|)
expr_stmt|;
comment|/* Optimize resources dependencies */
name|pmu_res_depend_table
operator|=
name|bcm4329_res_depend
expr_stmt|;
name|pmu_res_depend_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4329_res_depend
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4319
case|:
comment|/* Optimize resources up/down timers */
name|pmu_res_updown_table
operator|=
name|bcm4319a0_res_updown
expr_stmt|;
name|pmu_res_updown_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4319a0_res_updown
argument_list|)
expr_stmt|;
comment|/* Optimize resources dependencies masks */
name|pmu_res_depend_table
operator|=
name|bcm4319a0_res_depend
expr_stmt|;
name|pmu_res_depend_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4319a0_res_depend
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4336
case|:
comment|/* Optimize resources up/down timers */
name|pmu_res_updown_table
operator|=
name|bcm4336a0_res_updown
expr_stmt|;
name|pmu_res_updown_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4336a0_res_updown
argument_list|)
expr_stmt|;
comment|/* Optimize resources dependencies masks */
name|pmu_res_depend_table
operator|=
name|bcm4336a0_res_depend
expr_stmt|;
name|pmu_res_depend_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4336a0_res_depend
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4330
case|:
comment|/* Optimize resources up/down timers */
name|pmu_res_updown_table
operator|=
name|bcm4330a0_res_updown
expr_stmt|;
name|pmu_res_updown_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4330a0_res_updown
argument_list|)
expr_stmt|;
comment|/* Optimize resources dependencies masks */
name|pmu_res_depend_table
operator|=
name|bcm4330a0_res_depend
expr_stmt|;
name|pmu_res_depend_table_sz
operator|=
name|nitems
argument_list|(
name|bcm4330a0_res_depend
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* # resources */
name|rsrcs
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|sc
operator|->
name|caps
argument_list|,
name|BHND_PMU_CAP_RC
argument_list|)
expr_stmt|;
comment|/* Program up/down timers */
for|for
control|(
name|size_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|pmu_res_updown_table_sz
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|pmu_res_updown_t
modifier|*
name|updt
decl_stmt|;
name|KASSERT
argument_list|(
name|pmu_res_updown_table
operator|!=
name|NULL
argument_list|,
operator|(
literal|"no updown tables"
operator|)
argument_list|)
expr_stmt|;
name|updt
operator|=
operator|&
name|pmu_res_updown_table
index|[
name|pmu_res_updown_table_sz
operator|-
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Changing rsrc %d res_updn_timer to %#x\n"
argument_list|,
name|updt
operator|->
name|resnum
argument_list|,
name|updt
operator|->
name|updown
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_TABLE_SEL
argument_list|,
name|updt
operator|->
name|resnum
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_UPDN_TIMER
argument_list|,
name|updt
operator|->
name|updown
argument_list|)
expr_stmt|;
block|}
comment|/* Apply nvram overrides to up/down timers */
for|for
control|(
name|uint8_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|rsrcs
condition|;
name|i
operator|++
control|)
block|{
name|char
name|name
index|[
literal|6
index|]
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"r%dt"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|error
operator|=
name|bhnd_nvram_getvar_uint32
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|,
name|name
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|ENOENT
condition|)
block|{
continue|continue;
block|}
elseif|else
if|if
condition|(
name|error
condition|)
block|{
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"NVRAM error reading %s: %d\n"
argument_list|,
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Applying %s=%s to rsrc %d res_updn_timer\n"
argument_list|,
name|name
argument_list|,
name|val
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_TABLE_SEL
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_UPDN_TIMER
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* Program resource dependencies table */
for|for
control|(
name|size_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|pmu_res_depend_table_sz
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|pmu_res_depend_t
modifier|*
name|rdep
decl_stmt|;
name|pmu_res_filter
name|filter
decl_stmt|;
name|uint32_t
name|depend_mask
decl_stmt|;
name|KASSERT
argument_list|(
name|pmu_res_depend_table
operator|!=
name|NULL
argument_list|,
operator|(
literal|"no depend tables"
operator|)
argument_list|)
expr_stmt|;
name|rdep
operator|=
operator|&
name|pmu_res_depend_table
index|[
name|pmu_res_depend_table_sz
operator|-
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|filter
operator|=
name|rdep
operator|->
name|filter
expr_stmt|;
if|if
condition|(
name|filter
operator|!=
name|NULL
operator|&&
operator|!
name|filter
argument_list|(
name|sc
argument_list|)
condition|)
continue|continue;
for|for
control|(
name|uint8_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|rsrcs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rdep
operator|->
name|res_mask
operator|&
name|BHND_PMURES_BIT
argument_list|(
name|i
argument_list|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_TABLE_SEL
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|depend_mask
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_DEP_MASK
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rdep
operator|->
name|action
condition|)
block|{
case|case
name|RES_DEPEND_SET
case|:
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Changing rsrc %hhu res_dep_mask to "
literal|"%#x\n"
argument_list|,
name|i
argument_list|,
name|table
operator|->
name|depend_mask
argument_list|)
expr_stmt|;
name|depend_mask
operator|=
name|rdep
operator|->
name|depend_mask
expr_stmt|;
break|break;
case|case
name|RES_DEPEND_ADD
case|:
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Adding %#x to rsrc %hhu "
literal|"res_dep_mask\n"
argument_list|,
name|table
operator|->
name|depend_mask
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|depend_mask
operator||=
name|rdep
operator|->
name|depend_mask
expr_stmt|;
break|break;
case|case
name|RES_DEPEND_REMOVE
case|:
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Removing %#x from rsrc %hhu "
literal|"res_dep_mask\n"
argument_list|,
name|table
operator|->
name|depend_mask
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|depend_mask
operator|&=
operator|~
operator|(
name|rdep
operator|->
name|depend_mask
operator|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unknown RES_DEPEND action: %d\n"
argument_list|,
name|rdep
operator|->
name|action
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* Apply nvram overrides to dependencies masks */
for|for
control|(
name|uint8_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|rsrcs
condition|;
name|i
operator|++
control|)
block|{
name|char
name|name
index|[
literal|6
index|]
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"r%dd"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|error
operator|=
name|bhnd_nvram_getvar_uint32
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|,
name|name
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|ENOENT
condition|)
block|{
continue|continue;
block|}
elseif|else
if|if
condition|(
name|error
condition|)
block|{
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"NVRAM error reading %s: %d\n"
argument_list|,
name|name
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Applying %s=%s to rsrc %d res_dep_mask\n"
argument_list|,
name|name
argument_list|,
name|val
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_TABLE_SEL
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_DEP_MASK
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* Determine min/max rsrc masks */
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pmu_res_masks
argument_list|(
name|sc
argument_list|,
operator|&
name|min_mask
argument_list|,
operator|&
name|max_mask
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* It is required to program max_mask first and then min_mask */
comment|/* Program max resource mask */
if|if
condition|(
name|max_mask
operator|!=
literal|0
condition|)
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Changing max_res_mask to 0x%x\n"
argument_list|,
name|max_mask
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
name|max_mask
argument_list|)
expr_stmt|;
block|}
comment|/* Program min resource mask */
if|if
condition|(
name|min_mask
operator|!=
literal|0
condition|)
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Changing min_res_mask to 0x%x\n"
argument_list|,
name|min_mask
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
name|min_mask
argument_list|)
expr_stmt|;
block|}
comment|/* Add some delay; allow resources to come up and settle. */
name|DELAY
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* setup pll and query clock speed */
end_comment

begin_struct
struct|struct
name|pmu0_xtaltab0
block|{
name|uint16_t
name|freq
decl_stmt|;
name|uint8_t
name|xf
decl_stmt|;
name|uint8_t
name|wbint
decl_stmt|;
name|uint32_t
name|wbfrac
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* the following table is based on 880Mhz fvco */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|pmu0_xtaltab0_t
name|pmu0_xtaltab0
index|[]
init|=
block|{
block|{
literal|12000
block|,
literal|1
block|,
literal|73
block|,
literal|349525
block|}
block|,
block|{
literal|13000
block|,
literal|2
block|,
literal|67
block|,
literal|725937
block|}
block|,
block|{
literal|14400
block|,
literal|3
block|,
literal|61
block|,
literal|116508
block|}
block|,
block|{
literal|15360
block|,
literal|4
block|,
literal|57
block|,
literal|305834
block|}
block|,
block|{
literal|16200
block|,
literal|5
block|,
literal|54
block|,
literal|336579
block|}
block|,
block|{
literal|16800
block|,
literal|6
block|,
literal|52
block|,
literal|399457
block|}
block|,
block|{
literal|19200
block|,
literal|7
block|,
literal|45
block|,
literal|873813
block|}
block|,
block|{
literal|19800
block|,
literal|8
block|,
literal|44
block|,
literal|466033
block|}
block|,
block|{
literal|20000
block|,
literal|9
block|,
literal|44
block|,
literal|0
block|}
block|,
block|{
literal|25000
block|,
literal|10
block|,
literal|70
block|,
literal|419430
block|}
block|,
block|{
literal|26000
block|,
literal|11
block|,
literal|67
block|,
literal|725937
block|}
block|,
block|{
literal|30000
block|,
literal|12
block|,
literal|58
block|,
literal|699050
block|}
block|,
block|{
literal|38400
block|,
literal|13
block|,
literal|45
block|,
literal|873813
block|}
block|,
block|{
literal|40000
block|,
literal|14
block|,
literal|45
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PMU0_XTAL0_DEFAULT
value|8
end_define

begin_comment
comment|/* setup pll and query clock speed */
end_comment

begin_struct
struct|struct
name|pmu1_xtaltab0
block|{
name|uint16_t
name|fref
decl_stmt|;
name|uint8_t
name|xf
decl_stmt|;
name|uint8_t
name|p1div
decl_stmt|;
name|uint8_t
name|p2div
decl_stmt|;
name|uint8_t
name|ndiv_int
decl_stmt|;
name|uint32_t
name|ndiv_frac
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|pmu1_xtaltab0_t
name|pmu1_xtaltab0_880_4329
index|[]
init|=
block|{
block|{
literal|12000
block|,
literal|1
block|,
literal|3
block|,
literal|22
block|,
literal|0x9
block|,
literal|0xFFFFEF
block|}
block|,
block|{
literal|13000
block|,
literal|2
block|,
literal|1
block|,
literal|6
block|,
literal|0xb
block|,
literal|0x483483
block|}
block|,
block|{
literal|14400
block|,
literal|3
block|,
literal|1
block|,
literal|10
block|,
literal|0xa
block|,
literal|0x1C71C7
block|}
block|,
block|{
literal|15360
block|,
literal|4
block|,
literal|1
block|,
literal|5
block|,
literal|0xb
block|,
literal|0x755555
block|}
block|,
block|{
literal|16200
block|,
literal|5
block|,
literal|1
block|,
literal|10
block|,
literal|0x5
block|,
literal|0x6E9E06
block|}
block|,
block|{
literal|16800
block|,
literal|6
block|,
literal|1
block|,
literal|10
block|,
literal|0x5
block|,
literal|0x3Cf3Cf
block|}
block|,
block|{
literal|19200
block|,
literal|7
block|,
literal|1
block|,
literal|4
block|,
literal|0xb
block|,
literal|0x755555
block|}
block|,
block|{
literal|19800
block|,
literal|8
block|,
literal|1
block|,
literal|11
block|,
literal|0x4
block|,
literal|0xA57EB
block|}
block|,
block|{
literal|20000
block|,
literal|9
block|,
literal|1
block|,
literal|11
block|,
literal|0x4
block|,
literal|0x0
block|}
block|,
block|{
literal|24000
block|,
literal|10
block|,
literal|3
block|,
literal|11
block|,
literal|0xa
block|,
literal|0x0
block|}
block|,
block|{
literal|25000
block|,
literal|11
block|,
literal|5
block|,
literal|16
block|,
literal|0xb
block|,
literal|0x0
block|}
block|,
block|{
literal|26000
block|,
literal|12
block|,
literal|1
block|,
literal|1
block|,
literal|0x21
block|,
literal|0xD89D89
block|}
block|,
block|{
literal|30000
block|,
literal|13
block|,
literal|3
block|,
literal|8
block|,
literal|0xb
block|,
literal|0x0
block|}
block|,
block|{
literal|37400
block|,
literal|14
block|,
literal|3
block|,
literal|1
block|,
literal|0x46
block|,
literal|0x969696
block|}
block|,
block|{
literal|38400
block|,
literal|15
block|,
literal|1
block|,
literal|1
block|,
literal|0x16
block|,
literal|0xEAAAAA
block|}
block|,
block|{
literal|40000
block|,
literal|16
block|,
literal|1
block|,
literal|2
block|,
literal|0xb
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the following table is based on 880Mhz fvco */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|pmu1_xtaltab0_t
name|pmu1_xtaltab0_880
index|[]
init|=
block|{
block|{
literal|12000
block|,
literal|1
block|,
literal|3
block|,
literal|22
block|,
literal|0x9
block|,
literal|0xFFFFEF
block|}
block|,
block|{
literal|13000
block|,
literal|2
block|,
literal|1
block|,
literal|6
block|,
literal|0xb
block|,
literal|0x483483
block|}
block|,
block|{
literal|14400
block|,
literal|3
block|,
literal|1
block|,
literal|10
block|,
literal|0xa
block|,
literal|0x1C71C7
block|}
block|,
block|{
literal|15360
block|,
literal|4
block|,
literal|1
block|,
literal|5
block|,
literal|0xb
block|,
literal|0x755555
block|}
block|,
block|{
literal|16200
block|,
literal|5
block|,
literal|1
block|,
literal|10
block|,
literal|0x5
block|,
literal|0x6E9E06
block|}
block|,
block|{
literal|16800
block|,
literal|6
block|,
literal|1
block|,
literal|10
block|,
literal|0x5
block|,
literal|0x3Cf3Cf
block|}
block|,
block|{
literal|19200
block|,
literal|7
block|,
literal|1
block|,
literal|4
block|,
literal|0xb
block|,
literal|0x755555
block|}
block|,
block|{
literal|19800
block|,
literal|8
block|,
literal|1
block|,
literal|11
block|,
literal|0x4
block|,
literal|0xA57EB
block|}
block|,
block|{
literal|20000
block|,
literal|9
block|,
literal|1
block|,
literal|11
block|,
literal|0x4
block|,
literal|0x0
block|}
block|,
block|{
literal|24000
block|,
literal|10
block|,
literal|3
block|,
literal|11
block|,
literal|0xa
block|,
literal|0x0
block|}
block|,
block|{
literal|25000
block|,
literal|11
block|,
literal|5
block|,
literal|16
block|,
literal|0xb
block|,
literal|0x0
block|}
block|,
block|{
literal|26000
block|,
literal|12
block|,
literal|1
block|,
literal|2
block|,
literal|0x10
block|,
literal|0xEC4EC4
block|}
block|,
block|{
literal|30000
block|,
literal|13
block|,
literal|3
block|,
literal|8
block|,
literal|0xb
block|,
literal|0x0
block|}
block|,
block|{
literal|33600
block|,
literal|14
block|,
literal|1
block|,
literal|2
block|,
literal|0xd
block|,
literal|0x186186
block|}
block|,
block|{
literal|38400
block|,
literal|15
block|,
literal|1
block|,
literal|2
block|,
literal|0xb
block|,
literal|0x755555
block|}
block|,
block|{
literal|40000
block|,
literal|16
block|,
literal|1
block|,
literal|2
block|,
literal|0xb
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_12000K
value|0
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_13000K
value|1
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_14400K
value|2
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_15360K
value|3
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_16200K
value|4
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_16800K
value|5
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_19200K
value|6
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_19800K
value|7
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_20000K
value|8
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_24000K
value|9
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_25000K
value|10
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_26000K
value|11
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_30000K
value|12
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_37400K
value|13
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_38400K
value|14
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_880_40000K
value|15
end_define

begin_comment
comment|/* the following table is based on 1760Mhz fvco */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|pmu1_xtaltab0_t
name|pmu1_xtaltab0_1760
index|[]
init|=
block|{
block|{
literal|12000
block|,
literal|1
block|,
literal|3
block|,
literal|44
block|,
literal|0x9
block|,
literal|0xFFFFEF
block|}
block|,
block|{
literal|13000
block|,
literal|2
block|,
literal|1
block|,
literal|12
block|,
literal|0xb
block|,
literal|0x483483
block|}
block|,
block|{
literal|14400
block|,
literal|3
block|,
literal|1
block|,
literal|20
block|,
literal|0xa
block|,
literal|0x1C71C7
block|}
block|,
block|{
literal|15360
block|,
literal|4
block|,
literal|1
block|,
literal|10
block|,
literal|0xb
block|,
literal|0x755555
block|}
block|,
block|{
literal|16200
block|,
literal|5
block|,
literal|1
block|,
literal|20
block|,
literal|0x5
block|,
literal|0x6E9E06
block|}
block|,
block|{
literal|16800
block|,
literal|6
block|,
literal|1
block|,
literal|20
block|,
literal|0x5
block|,
literal|0x3Cf3Cf
block|}
block|,
block|{
literal|19200
block|,
literal|7
block|,
literal|1
block|,
literal|18
block|,
literal|0x5
block|,
literal|0x17B425
block|}
block|,
block|{
literal|19800
block|,
literal|8
block|,
literal|1
block|,
literal|22
block|,
literal|0x4
block|,
literal|0xA57EB
block|}
block|,
block|{
literal|20000
block|,
literal|9
block|,
literal|1
block|,
literal|22
block|,
literal|0x4
block|,
literal|0x0
block|}
block|,
block|{
literal|24000
block|,
literal|10
block|,
literal|3
block|,
literal|22
block|,
literal|0xa
block|,
literal|0x0
block|}
block|,
block|{
literal|25000
block|,
literal|11
block|,
literal|5
block|,
literal|32
block|,
literal|0xb
block|,
literal|0x0
block|}
block|,
block|{
literal|26000
block|,
literal|12
block|,
literal|1
block|,
literal|4
block|,
literal|0x10
block|,
literal|0xEC4EC4
block|}
block|,
block|{
literal|30000
block|,
literal|13
block|,
literal|3
block|,
literal|16
block|,
literal|0xb
block|,
literal|0x0
block|}
block|,
block|{
literal|38400
block|,
literal|14
block|,
literal|1
block|,
literal|10
block|,
literal|0x4
block|,
literal|0x955555
block|}
block|,
block|{
literal|40000
block|,
literal|15
block|,
literal|1
block|,
literal|4
block|,
literal|0xb
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* table index */
end_comment

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_12000K
value|0
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_13000K
value|1
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_14400K
value|2
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_15360K
value|3
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_16200K
value|4
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_16800K
value|5
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_19200K
value|6
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_19800K
value|7
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_20000K
value|8
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_24000K
value|9
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_25000K
value|10
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_26000K
value|11
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_30000K
value|12
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_38400K
value|13
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1760_40000K
value|14
end_define

begin_comment
comment|/* the following table is based on 1440Mhz fvco */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|pmu1_xtaltab0_t
name|pmu1_xtaltab0_1440
index|[]
init|=
block|{
block|{
literal|12000
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0x78
block|,
literal|0x0
block|}
block|,
block|{
literal|13000
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|0x6E
block|,
literal|0xC4EC4E
block|}
block|,
block|{
literal|14400
block|,
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|0x64
block|,
literal|0x0
block|}
block|,
block|{
literal|15360
block|,
literal|4
block|,
literal|1
block|,
literal|1
block|,
literal|0x5D
block|,
literal|0xC00000
block|}
block|,
block|{
literal|16200
block|,
literal|5
block|,
literal|1
block|,
literal|1
block|,
literal|0x58
block|,
literal|0xE38E38
block|}
block|,
block|{
literal|16800
block|,
literal|6
block|,
literal|1
block|,
literal|1
block|,
literal|0x55
block|,
literal|0xB6DB6D
block|}
block|,
block|{
literal|19200
block|,
literal|7
block|,
literal|1
block|,
literal|1
block|,
literal|0x4B
block|,
literal|0
block|}
block|,
block|{
literal|19800
block|,
literal|8
block|,
literal|1
block|,
literal|1
block|,
literal|0x48
block|,
literal|0xBA2E8B
block|}
block|,
block|{
literal|20000
block|,
literal|9
block|,
literal|1
block|,
literal|1
block|,
literal|0x48
block|,
literal|0x0
block|}
block|,
block|{
literal|25000
block|,
literal|10
block|,
literal|1
block|,
literal|1
block|,
literal|0x39
block|,
literal|0x999999
block|}
block|,
block|{
literal|26000
block|,
literal|11
block|,
literal|1
block|,
literal|1
block|,
literal|0x37
block|,
literal|0x627627
block|}
block|,
block|{
literal|30000
block|,
literal|12
block|,
literal|1
block|,
literal|1
block|,
literal|0x30
block|,
literal|0x0
block|}
block|,
block|{
literal|37400
block|,
literal|13
block|,
literal|2
block|,
literal|1
block|,
literal|0x4D
block|,
literal|0x15E76
block|}
block|,
block|{
literal|38400
block|,
literal|13
block|,
literal|2
block|,
literal|1
block|,
literal|0x4B
block|,
literal|0x0
block|}
block|,
block|{
literal|40000
block|,
literal|14
block|,
literal|2
block|,
literal|1
block|,
literal|0x48
block|,
literal|0x0
block|}
block|,
block|{
literal|48000
block|,
literal|15
block|,
literal|2
block|,
literal|1
block|,
literal|0x3c
block|,
literal|0x0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* table index */
end_comment

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_12000K
value|0
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_13000K
value|1
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_14400K
value|2
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_15360K
value|3
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_16200K
value|4
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_16800K
value|5
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_19200K
value|6
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_19800K
value|7
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_20000K
value|8
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_25000K
value|9
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_26000K
value|10
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_30000K
value|11
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_37400K
value|12
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_38400K
value|13
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_40000K
value|14
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_1440_48000K
value|15
end_define

begin_define
define|#
directive|define
name|XTAL_FREQ_24000MHZ
value|24000
end_define

begin_define
define|#
directive|define
name|XTAL_FREQ_30000MHZ
value|30000
end_define

begin_define
define|#
directive|define
name|XTAL_FREQ_37400MHZ
value|37400
end_define

begin_define
define|#
directive|define
name|XTAL_FREQ_48000MHZ
value|48000
end_define

begin_decl_stmt
specifier|static
specifier|const
name|pmu1_xtaltab0_t
name|pmu1_xtaltab0_960
index|[]
init|=
block|{
block|{
literal|12000
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0x50
block|,
literal|0x0
block|}
block|,
block|{
literal|13000
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|0x49
block|,
literal|0xD89D89
block|}
block|,
block|{
literal|14400
block|,
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|0x42
block|,
literal|0xAAAAAA
block|}
block|,
block|{
literal|15360
block|,
literal|4
block|,
literal|1
block|,
literal|1
block|,
literal|0x3E
block|,
literal|0x800000
block|}
block|,
block|{
literal|16200
block|,
literal|5
block|,
literal|1
block|,
literal|1
block|,
literal|0x39
block|,
literal|0x425ED0
block|}
block|,
block|{
literal|16800
block|,
literal|6
block|,
literal|1
block|,
literal|1
block|,
literal|0x39
block|,
literal|0x249249
block|}
block|,
block|{
literal|19200
block|,
literal|7
block|,
literal|1
block|,
literal|1
block|,
literal|0x32
block|,
literal|0x0
block|}
block|,
block|{
literal|19800
block|,
literal|8
block|,
literal|1
block|,
literal|1
block|,
literal|0x30
block|,
literal|0x7C1F07
block|}
block|,
block|{
literal|20000
block|,
literal|9
block|,
literal|1
block|,
literal|1
block|,
literal|0x30
block|,
literal|0x0
block|}
block|,
block|{
literal|25000
block|,
literal|10
block|,
literal|1
block|,
literal|1
block|,
literal|0x26
block|,
literal|0x666666
block|}
block|,
block|{
literal|26000
block|,
literal|11
block|,
literal|1
block|,
literal|1
block|,
literal|0x24
block|,
literal|0xEC4EC4
block|}
block|,
block|{
literal|30000
block|,
literal|12
block|,
literal|1
block|,
literal|1
block|,
literal|0x20
block|,
literal|0x0
block|}
block|,
block|{
literal|37400
block|,
literal|13
block|,
literal|2
block|,
literal|1
block|,
literal|0x33
block|,
literal|0x563EF9
block|}
block|,
block|{
literal|38400
block|,
literal|14
block|,
literal|2
block|,
literal|1
block|,
literal|0x32
block|,
literal|0x0
block|}
block|,
block|{
literal|40000
block|,
literal|15
block|,
literal|2
block|,
literal|1
block|,
literal|0x30
block|,
literal|0x0
block|}
block|,
block|{
literal|48000
block|,
literal|16
block|,
literal|2
block|,
literal|1
block|,
literal|0x28
block|,
literal|0x0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* table index */
end_comment

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_12000K
value|0
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_13000K
value|1
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_14400K
value|2
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_15360K
value|3
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_16200K
value|4
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_16800K
value|5
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_19200K
value|6
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_19800K
value|7
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_20000K
value|8
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_25000K
value|9
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_26000K
value|10
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_30000K
value|11
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_37400K
value|12
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_38400K
value|13
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_40000K
value|14
end_define

begin_define
define|#
directive|define
name|PMU1_XTALTAB0_960_48000K
value|15
end_define

begin_comment
comment|/* select xtal table for each chip */
end_comment

begin_function
specifier|static
specifier|const
name|pmu1_xtaltab0_t
modifier|*
name|bhnd_pmu1_xtaltab0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4315
case|:
return|return
operator|(
name|pmu1_xtaltab0_1760
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4319
case|:
return|return
operator|(
name|pmu1_xtaltab0_1440
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4325
case|:
return|return
operator|(
name|pmu1_xtaltab0_880
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4329
case|:
return|return
operator|(
name|pmu1_xtaltab0_880_4329
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4336
case|:
return|return
operator|(
name|pmu1_xtaltab0_960
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4330
case|:
if|if
condition|(
name|PMU_CST4330_SDIOD_CHIPMODE
argument_list|(
name|sc
argument_list|)
condition|)
return|return
operator|(
name|pmu1_xtaltab0_960
operator|)
return|;
else|else
return|return
operator|(
name|pmu1_xtaltab0_1440
operator|)
return|;
default|default:
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"bhnd_pmu1_xtaltab0: Unknown chipid %#hx\n"
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* select default xtal frequency for each chip */
end_comment

begin_function
specifier|static
specifier|const
name|pmu1_xtaltab0_t
modifier|*
name|bhnd_pmu1_xtaldef0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4315
case|:
comment|/* Default to 26000Khz */
return|return
operator|(
operator|&
name|pmu1_xtaltab0_1760
index|[
name|PMU1_XTALTAB0_1760_26000K
index|]
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4319
case|:
comment|/* Default to 30000Khz */
return|return
operator|(
operator|&
name|pmu1_xtaltab0_1440
index|[
name|PMU1_XTALTAB0_1440_30000K
index|]
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4325
case|:
comment|/* Default to 26000Khz */
return|return
operator|(
operator|&
name|pmu1_xtaltab0_880
index|[
name|PMU1_XTALTAB0_880_26000K
index|]
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4329
case|:
comment|/* Default to 38400Khz */
return|return
operator|(
operator|&
name|pmu1_xtaltab0_880_4329
index|[
name|PMU1_XTALTAB0_880_38400K
index|]
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4336
case|:
comment|/* Default to 26000Khz */
return|return
operator|(
operator|&
name|pmu1_xtaltab0_960
index|[
name|PMU1_XTALTAB0_960_26000K
index|]
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4330
case|:
comment|/* Default to 37400Khz */
if|if
condition|(
name|PMU_CST4330_SDIOD_CHIPMODE
argument_list|(
name|sc
argument_list|)
condition|)
return|return
operator|(
operator|&
name|pmu1_xtaltab0_960
index|[
name|PMU1_XTALTAB0_960_37400K
index|]
operator|)
return|;
else|else
return|return
operator|(
operator|&
name|pmu1_xtaltab0_1440
index|[
name|PMU1_XTALTAB0_1440_37400K
index|]
operator|)
return|;
default|default:
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"bhnd_pmu1_xtaldef0: Unknown chipid %#hx\n"
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* select default pll fvco for each chip */
end_comment

begin_function
specifier|static
name|uint32_t
name|bhnd_pmu1_pllfvco0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4329
case|:
return|return
operator|(
name|FVCO_880
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4319
case|:
return|return
operator|(
name|FVCO_1440
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4336
case|:
return|return
operator|(
name|FVCO_960
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4330
case|:
if|if
condition|(
name|PMU_CST4330_SDIOD_CHIPMODE
argument_list|(
name|sc
argument_list|)
condition|)
return|return
operator|(
name|FVCO_960
operator|)
return|;
else|else
return|return
operator|(
name|FVCO_1440
operator|)
return|;
default|default:
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"bhnd_pmu1_pllfvco0: Unknown chipid %#hx\n"
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* query alp/xtal clock frequency */
end_comment

begin_function
specifier|static
name|uint32_t
name|bhnd_pmu1_alpclk0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|pmu1_xtaltab0_t
modifier|*
name|xt
decl_stmt|;
name|uint32_t
name|xf
decl_stmt|;
comment|/* Find the frequency in the table */
name|xf
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|)
expr_stmt|;
name|xf
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|xf
argument_list|,
name|BHND_PMU_CTRL_XTALFREQ
argument_list|)
expr_stmt|;
for|for
control|(
name|xt
operator|=
name|bhnd_pmu1_xtaltab0
argument_list|(
name|sc
argument_list|)
init|;
name|xt
operator|!=
name|NULL
operator|&&
name|xt
operator|->
name|fref
operator|!=
literal|0
condition|;
name|xt
operator|++
control|)
block|{
if|if
condition|(
name|xt
operator|->
name|xf
operator|==
name|xf
condition|)
break|break;
block|}
comment|/* Could not find it so assign a default value */
if|if
condition|(
name|xt
operator|==
name|NULL
operator|||
name|xt
operator|->
name|fref
operator|==
literal|0
condition|)
name|xt
operator|=
name|bhnd_pmu1_xtaldef0
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|xt
operator|==
name|NULL
operator|||
name|xt
operator|->
name|fref
operator|==
literal|0
condition|)
block|{
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"no matching ALP/XTAL frequency found\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|xt
operator|->
name|fref
operator|*
literal|1000
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Set up PLL registers in the PMU as per the crystal speed. */
end_comment

begin_function
specifier|static
name|void
name|bhnd_pmu0_pllinit0
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|xtal
parameter_list|)
block|{
specifier|const
name|pmu0_xtaltab0_t
modifier|*
name|xt
decl_stmt|;
name|uint32_t
name|pll_data
decl_stmt|,
name|pll_mask
decl_stmt|;
name|uint32_t
name|pll_res
decl_stmt|;
name|uint32_t
name|pmu_ctrl
decl_stmt|;
name|uint32_t
name|xf
decl_stmt|;
comment|/* Use h/w default PLL config */
if|if
condition|(
name|xtal
operator|==
literal|0
condition|)
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Unspecified xtal frequency, skipping PLL "
literal|"configuration\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Find the frequency in the table */
for|for
control|(
name|xt
operator|=
name|pmu0_xtaltab0
init|;
name|xt
operator|->
name|freq
condition|;
name|xt
operator|++
control|)
block|{
if|if
condition|(
name|xt
operator|->
name|freq
operator|==
name|xtal
condition|)
break|break;
block|}
if|if
condition|(
name|xt
operator|->
name|freq
operator|==
literal|0
condition|)
name|xt
operator|=
operator|&
name|pmu0_xtaltab0
index|[
name|PMU0_XTAL0_DEFAULT
index|]
expr_stmt|;
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"XTAL %d.%d MHz (%d)\n"
argument_list|,
name|xtal
operator|/
literal|1000
argument_list|,
name|xtal
operator|%
literal|1000
argument_list|,
name|xt
operator|->
name|xf
argument_list|)
expr_stmt|;
comment|/* Check current PLL state */
name|pmu_ctrl
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|)
expr_stmt|;
name|xf
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|pmu_ctrl
argument_list|,
name|BHND_PMU_CTRL_XTALFREQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|xf
operator|==
name|xt
operator|->
name|xf
condition|)
block|{
ifdef|#
directive|ifdef
name|BCMUSBDEV
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4328
condition|)
block|{
name|bhnd_pmu0_sbclk4328
argument_list|(
name|sc
argument_list|,
name|BHND_PMU0_PLL0_PC0_DIV_ARM_88MHZ
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* BCMUSBDEV */
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"PLL already programmed for %d.%d MHz\n"
argument_list|,
name|xt
operator|->
name|freq
operator|/
literal|1000
argument_list|,
name|xt
operator|->
name|freq
operator|%
literal|1000
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|xf
operator|!=
literal|0
condition|)
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Reprogramming PLL for %d.%d MHz (was %d.%dMHz)\n"
argument_list|,
name|xt
operator|->
name|freq
operator|/
literal|1000
argument_list|,
name|xt
operator|->
name|freq
operator|%
literal|1000
argument_list|,
name|pmu0_xtaltab0
index|[
name|tmp
operator|-
literal|1
index|]
operator|.
name|freq
operator|/
literal|1000
argument_list|,
name|pmu0_xtaltab0
index|[
name|tmp
operator|-
literal|1
index|]
operator|.
name|freq
operator|%
literal|1000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Programming PLL for %d.%d MHz\n"
argument_list|,
name|xt
operator|->
name|freq
operator|/
literal|1000
argument_list|,
name|xt
operator|->
name|freq
operator|%
literal|1000
argument_list|)
expr_stmt|;
block|}
comment|/* Make sure the PLL is off */
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4328
case|:
name|pll_res
operator|=
name|PMURES_BIT
argument_list|(
name|RES4328_BB_PLL_PU
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM5354
case|:
name|pll_res
operator|=
name|PMURES_BIT
argument_list|(
name|RES5354_BB_PLL_PU
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unsupported chipid %#hx\n"
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|)
expr_stmt|;
block|}
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
name|pll_res
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
operator|~
name|pll_res
argument_list|)
expr_stmt|;
comment|/* Wait for HT clock to shutdown. */
name|PMU_WAIT_CLKST
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|BHND_CCS_HTAVAIL
argument_list|)
expr_stmt|;
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Done masking\n"
argument_list|)
expr_stmt|;
comment|/* Write PDIV in pllcontrol[0] */
if|if
condition|(
name|xt
operator|->
name|freq
operator|>=
name|BHND_PMU0_PLL0_PC0_PDIV_FREQ
condition|)
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU0_PLL0_PLLCTL0
argument_list|,
name|BHND_PMU0_PLL0_PC0_PDIV_MASK
argument_list|,
name|BHND_PMU0_PLL0_PC0_PDIV_MASK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU0_PLL0_PLLCTL0
argument_list|,
literal|0
argument_list|,
name|BHND_PMU0_PLL0_PC0_PDIV_MASK
argument_list|)
expr_stmt|;
block|}
comment|/* Write WILD in pllcontrol[1] */
name|pll_data
operator|=
name|BHND_PMU_SET_BITS
argument_list|(
name|xt
operator|->
name|wbint
argument_list|,
name|BHND_PMU0_PLL0_PC1_WILD_INT
argument_list|)
operator||
name|BHND_PMU_SET_BITS
argument_list|(
name|xt
operator|->
name|wbfrac
argument_list|,
name|BHND_PMU0_PLL0_PC1_WILD_FRAC
argument_list|)
expr_stmt|;
if|if
condition|(
name|xt
operator|->
name|wbfrac
operator|==
literal|0
condition|)
block|{
name|pll_data
operator||=
name|BHND_PMU0_PLL0_PC1_STOP_MOD
expr_stmt|;
block|}
else|else
block|{
name|pll_data
operator|&=
operator|~
name|BHND_PMU0_PLL0_PC1_STOP_MOD
expr_stmt|;
block|}
name|pll_mask
operator|=
name|BHND_PMU0_PLL0_PC1_WILD_INT_MASK
operator||
name|BHND_PMU0_PLL0_PC1_WILD_FRAC_MASK
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU0_PLL0_PLLCTL1
argument_list|,
name|pll_data
argument_list|,
name|pll_mask
argument_list|)
expr_stmt|;
comment|/* Write WILD in pllcontrol[2] */
name|pll_data
operator|=
name|BHND_PMU_SET_BITS
argument_list|(
name|xt
operator|->
name|wbint
argument_list|,
name|BHND_PMU0_PLL0_PC2_WILD_INT
argument_list|)
expr_stmt|;
name|pll_mask
operator|=
name|BHND_PMU0_PLL0_PC2_WILD_INT_MASK
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU0_PLL0_PLLCTL2
argument_list|,
name|pll_data
argument_list|,
name|pll_mask
argument_list|)
expr_stmt|;
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Done pll\n"
argument_list|)
expr_stmt|;
comment|/* Write XtalFreq. Set the divisor also. */
name|pmu_ctrl
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|)
expr_stmt|;
name|pmu_ctrl
operator|&=
operator|~
operator|(
name|BHND_PMU_CTRL_ILP_DIV_MASK
operator||
name|BHND_PMU_CTRL_XTALFREQ_MASK
operator|)
expr_stmt|;
name|pmu_ctrl
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
operator|(
operator|(
name|xt
operator|->
name|freq
operator|+
literal|127
operator|)
operator|/
literal|128
operator|)
operator|-
literal|1
argument_list|,
name|BHND_PMU_CTRL_ILP_DIV
argument_list|)
expr_stmt|;
name|pmu_ctrl
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|xt
operator|->
name|xf
argument_list|,
name|BHND_PMU_CTRL_XTALFREQ
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|,
name|pmu_ctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* query alp/xtal clock frequency */
end_comment

begin_function
specifier|static
name|uint32_t
name|bhnd_pmu0_alpclk0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|pmu0_xtaltab0_t
modifier|*
name|xt
decl_stmt|;
name|uint32_t
name|xf
decl_stmt|;
comment|/* Find the frequency in the table */
name|xf
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|)
expr_stmt|;
name|xf
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|xf
argument_list|,
name|BHND_PMU_CTRL_XTALFREQ
argument_list|)
expr_stmt|;
for|for
control|(
name|xt
operator|=
name|pmu0_xtaltab0
init|;
name|xt
operator|->
name|freq
condition|;
name|xt
operator|++
control|)
if|if
condition|(
name|xt
operator|->
name|xf
operator|==
name|xf
condition|)
break|break;
comment|/* PLL must be configured before */
if|if
condition|(
name|xt
operator|==
name|NULL
operator|||
name|xt
operator|->
name|freq
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"unsupported frequency: %u"
argument_list|,
name|xf
argument_list|)
expr_stmt|;
return|return
operator|(
name|xt
operator|->
name|freq
operator|*
literal|1000
operator|)
return|;
block|}
end_function

begin_comment
comment|/* query CPU clock frequency */
end_comment

begin_function
specifier|static
name|uint32_t
name|bhnd_pmu0_cpuclk0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|,
name|divarm
decl_stmt|;
name|uint32_t
name|FVCO
decl_stmt|;
ifdef|#
directive|ifdef
name|BCMDBG
name|uint32_t
name|pdiv
decl_stmt|,
name|wbint
decl_stmt|,
name|wbfrac
decl_stmt|,
name|fvco
decl_stmt|;
name|uint32_t
name|freq
decl_stmt|;
endif|#
directive|endif
name|FVCO
operator|=
name|FVCO_880
expr_stmt|;
comment|/* Read divarm from pllcontrol[0] */
name|tmp
operator|=
name|BHND_PMU_PLL_READ
argument_list|(
name|sc
argument_list|,
name|BHND_PMU0_PLL0_PLLCTL0
argument_list|)
expr_stmt|;
name|divarm
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU0_PLL0_PC0_DIV_ARM
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BCMDBG
comment|/* Calculate fvco based on xtal freq, pdiv, and wild */
name|pdiv
operator|=
name|tmp
operator|&
name|BHND_PMU0_PLL0_PC0_PDIV_MASK
expr_stmt|;
name|tmp
operator|=
name|BHND_PMU_PLL_READ
argument_list|(
name|sc
argument_list|,
name|BHND_PMU0_PLL0_PLLCTL1
argument_list|)
expr_stmt|;
name|wbfrac
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU0_PLL0_PC1_WILD_FRAC
argument_list|)
expr_stmt|;
name|wbint
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|PMU0_PLL0_PC1_WILD_INT
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BHND_PMU_PLL_READ
argument_list|(
name|sc
argument_list|,
name|BHND_PMU0_PLL0_PLLCTL2
argument_list|)
expr_stmt|;
name|wbint
operator|+=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU0_PLL0_PC2_WILD_INT
argument_list|)
expr_stmt|;
name|freq
operator|=
name|bhnd_pmu0_alpclk0
argument_list|(
name|sih
argument_list|,
name|osh
argument_list|,
name|cc
argument_list|)
operator|/
literal|1000
expr_stmt|;
name|fvco
operator|=
operator|(
name|freq
operator|*
name|wbint
operator|)
operator|<<
literal|8
expr_stmt|;
name|fvco
operator|+=
operator|(
name|freq
operator|*
operator|(
name|wbfrac
operator|>>
literal|10
operator|)
operator|)
operator|>>
literal|2
expr_stmt|;
name|fvco
operator|+=
operator|(
name|freq
operator|*
operator|(
name|wbfrac
operator|&
literal|0x3ff
operator|)
operator|)
operator|>>
literal|10
expr_stmt|;
name|fvco
operator|>>=
literal|8
expr_stmt|;
name|fvco
operator|>>=
name|pdiv
expr_stmt|;
name|fvco
operator|/=
literal|1000
expr_stmt|;
name|fvco
operator|*=
literal|1000
expr_stmt|;
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"bhnd_pmu0_cpuclk0: wbint %u wbfrac %u fvco %u\n"
argument_list|,
name|wbint
argument_list|,
name|wbfrac
argument_list|,
name|fvco
argument_list|)
expr_stmt|;
name|FVCO
operator|=
name|fvco
expr_stmt|;
endif|#
directive|endif
comment|/* BCMDBG */
comment|/* Return ARM/SB clock */
return|return
name|FVCO
operator|/
operator|(
name|divarm
operator|+
name|BHND_PMU0_PLL0_PC0_DIV_ARM_BASE
operator|)
operator|*
literal|1000
return|;
block|}
end_function

begin_comment
comment|/* Set up PLL registers in the PMU as per the crystal speed. */
end_comment

begin_function
specifier|static
name|void
name|bhnd_pmu1_pllinit0
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|xtal
parameter_list|)
block|{
specifier|const
name|pmu1_xtaltab0_t
modifier|*
name|xt
decl_stmt|;
name|uint32_t
name|buf_strength
decl_stmt|;
name|uint32_t
name|plladdr
decl_stmt|,
name|plldata
decl_stmt|,
name|pllmask
decl_stmt|;
name|uint32_t
name|pmuctrl
decl_stmt|;
name|uint32_t
name|FVCO
decl_stmt|;
name|uint8_t
name|ndiv_mode
decl_stmt|;
name|FVCO
operator|=
name|bhnd_pmu1_pllfvco0
argument_list|(
operator|&
name|sc
operator|->
name|query
argument_list|)
operator|/
literal|1000
expr_stmt|;
name|buf_strength
operator|=
literal|0
expr_stmt|;
name|ndiv_mode
operator|=
literal|1
expr_stmt|;
comment|/* Use h/w default PLL config */
if|if
condition|(
name|xtal
operator|==
literal|0
condition|)
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Unspecified xtal frequency, skipping PLL "
literal|"configuration\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Find the frequency in the table */
for|for
control|(
name|xt
operator|=
name|bhnd_pmu1_xtaltab0
argument_list|(
operator|&
name|sc
operator|->
name|query
argument_list|)
init|;
name|xt
operator|!=
name|NULL
operator|&&
name|xt
operator|->
name|fref
operator|!=
literal|0
condition|;
name|xt
operator|++
control|)
block|{
if|if
condition|(
name|xt
operator|->
name|fref
operator|==
name|xtal
condition|)
break|break;
block|}
comment|/* Check current PLL state, bail out if it has been programmed or 	 * we don't know how to program it. 	 */
if|if
condition|(
name|xt
operator|==
name|NULL
operator|||
name|xt
operator|->
name|fref
operator|==
literal|0
condition|)
block|{
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"Unsupported XTAL frequency %d.%dMHz, skipping PLL "
literal|"configuration\n"
argument_list|,
name|xtal
operator|/
literal|1000
argument_list|,
name|xtal
operator|%
literal|1000
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* For 4319 bootloader already programs the PLL but bootloader does not 	 * program the PLL4 and PLL5. So Skip this check for 4319. */
name|pmuctrl
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
name|BHND_PMU_GET_BITS
argument_list|(
name|pmuctrl
argument_list|,
name|BHND_PMU_CTRL_XTALFREQ
argument_list|)
operator|==
name|xt
operator|->
name|xf
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM4319
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM4330
condition|)
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"PLL already programmed for %d.%dMHz\n"
argument_list|,
name|xt
operator|->
name|fref
operator|/
literal|1000
argument_list|,
name|xt
operator|->
name|fref
operator|%
literal|1000
argument_list|)
expr_stmt|;
return|return;
block|}
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"XTAL %d.%dMHz (%d)\n"
argument_list|,
name|xtal
operator|/
literal|1000
argument_list|,
name|xtal
operator|%
literal|1000
argument_list|,
name|xt
operator|->
name|xf
argument_list|)
expr_stmt|;
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Programming PLL for %d.%dMHz\n"
argument_list|,
name|xt
operator|->
name|fref
operator|/
literal|1000
argument_list|,
name|xt
operator|->
name|fref
operator|%
literal|1000
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4325
case|:
comment|/* Change the BBPLL drive strength to 2 for all channels */
name|buf_strength
operator|=
literal|0x222222
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4325_BBPLL_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_HT_AVAIL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4325_BBPLL_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4325_HT_AVAIL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Wait for HT clock to shutdown. */
name|PMU_WAIT_CLKST
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|BHND_CCS_HTAVAIL
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4329
case|:
comment|/* Change the BBPLL drive strength to 8 for all channels */
name|buf_strength
operator|=
literal|0x888888
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4329_BBPLL_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_HT_AVAIL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4329_BBPLL_PWRSW_PU
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4329_HT_AVAIL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Wait for HT clock to shutdown. */
name|PMU_WAIT_CLKST
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|BHND_CCS_HTAVAIL
argument_list|)
expr_stmt|;
comment|/* Initialize PLL4 */
name|plladdr
operator|=
name|BHND_PMU1_PLL0_PLLCTL4
expr_stmt|;
if|if
condition|(
name|xt
operator|->
name|fref
operator|==
literal|38400
condition|)
name|plldata
operator|=
literal|0x200024C0
expr_stmt|;
elseif|else
if|if
condition|(
name|xt
operator|->
name|fref
operator|==
literal|37400
condition|)
name|plldata
operator|=
literal|0x20004500
expr_stmt|;
elseif|else
if|if
condition|(
name|xt
operator|->
name|fref
operator|==
literal|26000
condition|)
name|plldata
operator|=
literal|0x200024C0
expr_stmt|;
else|else
name|plldata
operator|=
literal|0x200005C0
expr_stmt|;
comment|/* Chip Dflt Settings */
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|plladdr
argument_list|,
name|plldata
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
comment|/* Initialize PLL5 */
name|plladdr
operator|=
name|BHND_PMU1_PLL0_PLLCTL5
expr_stmt|;
name|plldata
operator|=
name|BHND_PMU_PLL_READ
argument_list|(
name|sc
argument_list|,
name|plladdr
argument_list|)
expr_stmt|;
name|plldata
operator|&=
name|BHND_PMU1_PLL0_PC5_CLK_DRV_MASK
expr_stmt|;
if|if
condition|(
name|xt
operator|->
name|fref
operator|==
literal|38400
operator|||
name|xt
operator|->
name|fref
operator|==
literal|37400
operator|||
name|xt
operator|->
name|fref
operator|==
literal|26000
condition|)
block|{
name|plldata
operator||=
literal|0x15
expr_stmt|;
block|}
else|else
block|{
name|plldata
operator||=
literal|0x25
expr_stmt|;
comment|/* Chip Dflt Settings */
block|}
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|plladdr
argument_list|,
name|plldata
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4319
case|:
comment|/* Change the BBPLL drive strength to 2 for all channels */
name|buf_strength
operator|=
literal|0x222222
expr_stmt|;
comment|/* Make sure the PLL is off */
comment|/* WAR65104: Disable the HT_AVAIL resource first and then 		 * after a delay (more than downtime for HT_AVAIL) remove the 		 * BBPLL resource; backplane clock moves to ALP from HT. 		 */
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4319_HT_AVAIL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4319_HT_AVAIL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4319_BBPLL_PWRSW_PU
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4319_BBPLL_PWRSW_PU
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* Wait for HT clock to shutdown. */
name|PMU_WAIT_CLKST
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|BHND_CCS_HTAVAIL
argument_list|)
expr_stmt|;
name|plldata
operator|=
literal|0x200005c0
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
name|plldata
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4336
case|:
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4336_HT_AVAIL
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4336_MACPHY_CLKAVAIL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4336_HT_AVAIL
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4336_MACPHY_CLKAVAIL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* Wait for HT clock to shutdown. */
name|PMU_WAIT_CLKST
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|BHND_CCS_HTAVAIL
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4330
case|:
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4330_HT_AVAIL
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4330_MACPHY_CLKAVAIL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
operator|~
operator|(
name|PMURES_BIT
argument_list|(
name|RES4330_HT_AVAIL
argument_list|)
operator||
name|PMURES_BIT
argument_list|(
name|RES4330_MACPHY_CLKAVAIL
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* Wait for HT clock to shutdown. */
name|PMU_WAIT_CLKST
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|BHND_CCS_HTAVAIL
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unsupported chipid %#hx\n"
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|)
expr_stmt|;
block|}
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Done masking\n"
argument_list|)
expr_stmt|;
comment|/* Write p1div and p2div to pllcontrol[0] */
name|plldata
operator|=
name|BHND_PMU_SET_BITS
argument_list|(
name|xt
operator|->
name|p1div
argument_list|,
name|BHND_PMU1_PLL0_PC0_P1DIV
argument_list|)
operator||
name|BHND_PMU_SET_BITS
argument_list|(
name|xt
operator|->
name|p2div
argument_list|,
name|BHND_PMU1_PLL0_PC0_P2DIV
argument_list|)
expr_stmt|;
name|pllmask
operator|=
name|BHND_PMU1_PLL0_PC0_P1DIV_MASK
operator||
name|BHND_PMU1_PLL0_PC0_P2DIV_MASK
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4319
condition|)
block|{
name|plldata
operator|&=
operator|~
operator|(
name|BHND_PMU1_PLL0_PC0_BYPASS_SDMOD_MASK
operator|)
expr_stmt|;
name|pllmask
operator||=
name|BHND_PMU1_PLL0_PC0_BYPASS_SDMOD_MASK
expr_stmt|;
if|if
condition|(
operator|!
name|xt
operator|->
name|ndiv_frac
condition|)
block|{
name|plldata
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
literal|1
argument_list|,
name|BHND_PMU1_PLL0_PC0_BYPASS_SDMOD
argument_list|)
expr_stmt|;
block|}
block|}
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
name|plldata
argument_list|,
name|pllmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4330
condition|)
name|bhnd_pmu_set_4330_plldivs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4329
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|==
literal|0
condition|)
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
name|BHND_PMU_DOT11MAC_880MHZ_CLK_DIVISOR_VAL
argument_list|,
name|BHND_PMU_DOT11MAC_880MHZ_CLK_DIVISOR_MASK
argument_list|)
expr_stmt|;
block|}
comment|/* Write ndiv_int and ndiv_mode to pllcontrol[2] */
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4336
operator|||
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4330
condition|)
block|{
name|ndiv_mode
operator|=
name|BHND_PMU1_PLL0_PC2_NDIV_MODE_MFB
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4319
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|xt
operator|->
name|ndiv_frac
operator|)
condition|)
name|ndiv_mode
operator|=
name|BHND_PMU1_PLL0_PC2_NDIV_MODE_INT
expr_stmt|;
else|else
name|ndiv_mode
operator|=
name|BHND_PMU1_PLL0_PC2_NDIV_MODE_MFB
expr_stmt|;
block|}
else|else
block|{
name|ndiv_mode
operator|=
name|BHND_PMU1_PLL0_PC2_NDIV_MODE_MASH
expr_stmt|;
block|}
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
name|BHND_PMU_SET_BITS
argument_list|(
name|xt
operator|->
name|ndiv_int
argument_list|,
name|BHND_PMU1_PLL0_PC2_NDIV_INT
argument_list|)
operator||
name|BHND_PMU_SET_BITS
argument_list|(
name|ndiv_mode
argument_list|,
name|BHND_PMU1_PLL0_PC2_NDIV_MODE
argument_list|)
argument_list|,
name|BHND_PMU1_PLL0_PC2_NDIV_INT_MASK
operator||
name|BHND_PMU1_PLL0_PC2_NDIV_MODE_MASK
argument_list|)
expr_stmt|;
comment|/* Write ndiv_frac to pllcontrol[3] */
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|,
name|BHND_PMU_SET_BITS
argument_list|(
name|xt
operator|->
name|ndiv_frac
argument_list|,
name|BHND_PMU1_PLL0_PC3_NDIV_FRAC
argument_list|)
argument_list|,
name|BHND_PMU1_PLL0_PC3_NDIV_FRAC_MASK
argument_list|)
expr_stmt|;
comment|/* Writing to pllcontrol[4]  */
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4319
condition|)
block|{
name|uint8_t
name|xs
decl_stmt|;
if|if
condition|(
operator|!
name|xt
operator|->
name|ndiv_frac
condition|)
name|plldata
operator|=
literal|0x200005c0
expr_stmt|;
else|else
name|plldata
operator|=
literal|0x202C2820
expr_stmt|;
if|if
condition|(
name|FVCO
operator|<
literal|1600
condition|)
name|xs
operator|=
literal|4
expr_stmt|;
else|else
name|xs
operator|=
literal|7
expr_stmt|;
name|plldata
operator|&=
operator|~
operator|(
name|BHND_PMU1_PLL0_PC4_KVCO_XS_MASK
operator|)
expr_stmt|;
name|plldata
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|xs
argument_list|,
name|BHND_PMU1_PLL0_PC4_KVCO_XS
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
name|plldata
argument_list|)
expr_stmt|;
block|}
comment|/* Write clock driving strength to pllcontrol[5] */
if|if
condition|(
name|buf_strength
condition|)
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Adjusting PLL buffer drive strength: %x\n"
argument_list|,
name|buf_strength
argument_list|)
expr_stmt|;
name|plldata
operator|=
name|BHND_PMU_SET_BITS
argument_list|(
name|buf_strength
argument_list|,
name|BHND_PMU1_PLL0_PC5_CLK_DRV
argument_list|)
expr_stmt|;
name|pllmask
operator|=
name|BHND_PMU1_PLL0_PC5_CLK_DRV_MASK
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4319
condition|)
block|{
name|pllmask
operator||=
name|BHND_PMU1_PLL0_PC5_VCO_RNG_MASK
operator||
name|BHND_PMU1_PLL0_PC5_PLL_CTRL_37_32_MASK
expr_stmt|;
if|if
condition|(
operator|!
name|xt
operator|->
name|ndiv_frac
condition|)
block|{
name|plldata
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
literal|0x25
argument_list|,
name|BHND_PMU1_PLL0_PC5_PLL_CTRL_37_32
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|plldata
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
literal|0x15
argument_list|,
name|BHND_PMU1_PLL0_PC5_PLL_CTRL_37_32
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FVCO
operator|>=
literal|1600
condition|)
block|{
name|plldata
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
literal|0x1
argument_list|,
name|BHND_PMU1_PLL0_PC5_VCO_RNG
argument_list|)
expr_stmt|;
block|}
block|}
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
name|plldata
argument_list|,
name|pllmask
argument_list|)
expr_stmt|;
block|}
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Done pll\n"
argument_list|)
expr_stmt|;
comment|/* to operate the 4319 usb in 24MHz/48MHz; chipcontrol[2][84:83] needs 	 * to be updated. 	 */
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4319
operator|&&
name|xt
operator|->
name|fref
operator|!=
name|XTAL_FREQ_30000MHZ
condition|)
block|{
name|uint32_t
name|pll_sel
decl_stmt|;
switch|switch
condition|(
name|xt
operator|->
name|fref
condition|)
block|{
case|case
name|XTAL_FREQ_24000MHZ
case|:
name|pll_sel
operator|=
name|BHND_PMU_CCTL_4319USB_24MHZ_PLL_SEL
expr_stmt|;
break|break;
case|case
name|XTAL_FREQ_48000MHZ
case|:
name|pll_sel
operator|=
name|BHND_PMU_CCTL_4319USB_48MHZ_PLL_SEL
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"unsupported 4319USB XTAL frequency: %hu\n"
argument_list|,
name|xt
operator|->
name|fref
argument_list|)
expr_stmt|;
block|}
name|BHND_PMU_CCTRL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_CHIPCTL2
argument_list|,
name|BHND_PMU_SET_BITS
argument_list|(
name|pll_sel
argument_list|,
name|BHND_PMU_CCTL_4319USB_XTAL_SEL
argument_list|)
argument_list|,
name|BHND_PMU_CCTL_4319USB_XTAL_SEL_MASK
argument_list|)
expr_stmt|;
block|}
comment|/* Flush deferred pll control registers writes */
if|if
condition|(
name|BHND_PMU_REV
argument_list|(
name|sc
argument_list|)
operator|>=
literal|2
condition|)
name|BHND_PMU_OR_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|,
name|BHND_PMU_CTRL_PLL_PLLCTL_UPD
argument_list|)
expr_stmt|;
comment|/* Write XtalFreq. Set the divisor also. */
name|pmuctrl
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|)
expr_stmt|;
name|pmuctrl
operator|&=
operator|~
operator|(
name|BHND_PMU_CTRL_ILP_DIV_MASK
operator||
name|BHND_PMU_CTRL_XTALFREQ_MASK
operator|)
expr_stmt|;
name|pmuctrl
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
operator|(
operator|(
name|xt
operator|->
name|fref
operator|+
literal|127
operator|)
operator|/
literal|128
operator|)
operator|-
literal|1
argument_list|,
name|BHND_PMU_CTRL_ILP_DIV
argument_list|)
expr_stmt|;
name|pmuctrl
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|xt
operator|->
name|xf
argument_list|,
name|BHND_PMU_CTRL_XTALFREQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4329
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|==
literal|0
condition|)
block|{
comment|/* clear the htstretch before clearing HTReqEn */
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CLKSTRETCH
argument_list|,
operator|~
name|BHND_PMU_CLKSTRETCH
argument_list|)
expr_stmt|;
name|pmuctrl
operator|&=
operator|~
name|BHND_PMU_CTRL_HT_REQ_EN
expr_stmt|;
block|}
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|,
name|pmuctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* query the CPU clock frequency */
end_comment

begin_function
specifier|static
name|uint32_t
name|bhnd_pmu1_cpuclk0
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|,
name|m1div
decl_stmt|;
ifdef|#
directive|ifdef
name|BCMDBG
name|uint32_t
name|ndiv_int
decl_stmt|,
name|ndiv_frac
decl_stmt|,
name|p2div
decl_stmt|,
name|p1div
decl_stmt|,
name|fvco
decl_stmt|;
name|uint32_t
name|fref
decl_stmt|;
endif|#
directive|endif
name|uint32_t
name|FVCO
init|=
name|bhnd_pmu1_pllfvco0
argument_list|(
name|sc
argument_list|)
decl_stmt|;
comment|/* Read m1div from pllcontrol[1] */
name|tmp
operator|=
name|BHND_PMU_PLL_READ
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|)
expr_stmt|;
name|m1div
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU1_PLL0_PC1_M1DIV
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BCMDBG
comment|/* Read p2div/p1div from pllcontrol[0] */
name|tmp
operator|=
name|BHND_PMU_PLL_READ
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|)
expr_stmt|;
name|p2div
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU1_PLL0_PC0_P2DIV
argument_list|)
expr_stmt|;
name|p1div
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU1_PLL0_PC0_P1DIV
argument_list|)
expr_stmt|;
comment|/* Calculate fvco based on xtal freq and ndiv and pdiv */
name|tmp
operator|=
name|BHND_PMU_PLL_READ
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|)
expr_stmt|;
name|ndiv_int
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU1_PLL0_PC2_NDIV_INT
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BHND_PMU_PLL_READ
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|)
expr_stmt|;
name|ndiv_frac
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU1_PLL0_PC3_NDIV_FRAC
argument_list|)
expr_stmt|;
name|fref
operator|=
name|bhnd_pmu1_alpclk0
argument_list|(
name|sc
argument_list|)
operator|/
literal|1000
expr_stmt|;
name|fvco
operator|=
operator|(
name|fref
operator|*
name|ndiv_int
operator|)
operator|<<
literal|8
expr_stmt|;
name|fvco
operator|+=
operator|(
name|fref
operator|*
operator|(
name|ndiv_frac
operator|>>
literal|12
operator|)
operator|)
operator|>>
literal|4
expr_stmt|;
name|fvco
operator|+=
operator|(
name|fref
operator|*
operator|(
name|ndiv_frac
operator|&
literal|0xfff
operator|)
operator|)
operator|>>
literal|12
expr_stmt|;
name|fvco
operator|>>=
literal|8
expr_stmt|;
name|fvco
operator|*=
name|p2div
expr_stmt|;
name|fvco
operator|/=
name|p1div
expr_stmt|;
name|fvco
operator|/=
literal|1000
expr_stmt|;
name|fvco
operator|*=
literal|1000
expr_stmt|;
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"bhnd_pmu1_cpuclk0: ndiv_int %u ndiv_frac %u p2div %u "
literal|"p1div %u fvco %u\n"
argument_list|,
name|ndiv_int
argument_list|,
name|ndiv_frac
argument_list|,
name|p2div
argument_list|,
name|p1div
argument_list|,
name|fvco
argument_list|)
expr_stmt|;
name|FVCO
operator|=
name|fvco
expr_stmt|;
endif|#
directive|endif
comment|/* BCMDBG */
comment|/* Return ARM/SB clock */
return|return
operator|(
name|FVCO
operator|/
name|m1div
operator|*
literal|1000
operator|)
return|;
block|}
end_function

begin_comment
comment|/* initialize PLL */
end_comment

begin_function
name|void
name|bhnd_pmu_pll_init
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|u_int
name|xtalfreq
parameter_list|)
block|{
name|uint32_t
name|max_mask
decl_stmt|,
name|min_mask
decl_stmt|;
name|uint32_t
name|res_ht
decl_stmt|,
name|res_pll
decl_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4312
case|:
comment|/* assume default works */
break|break;
case|case
name|BHND_CHIPID_BCM4322
case|:
case|case
name|BHND_CHIPID_BCM43221
case|:
case|case
name|BHND_CHIPID_BCM43231
case|:
case|case
name|BHND_CHIPID_BCM4342
case|:
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|!=
literal|0
condition|)
break|break;
name|min_mask
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|)
expr_stmt|;
name|max_mask
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|)
expr_stmt|;
name|res_ht
operator|=
name|PMURES_BIT
argument_list|(
name|RES4322_HT_SI_AVAIL
argument_list|)
expr_stmt|;
name|res_pll
operator|=
name|PMURES_BIT
argument_list|(
name|RES4322_SI_PLL_ON
argument_list|)
expr_stmt|;
comment|/* Have to remove HT Avail request before powering off PLL */
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
name|res_ht
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
operator|~
name|res_ht
argument_list|)
expr_stmt|;
name|PMU_WAIT_CLKST
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|BHND_CCS_HTAVAIL
argument_list|)
expr_stmt|;
comment|/* Make sure the PLL is off */
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
name|res_pll
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
operator|~
name|res_pll
argument_list|)
expr_stmt|;
name|PMU_WAIT_CLKST
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|BHND_CCS_HTAVAIL
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU2_SI_PLL_PLLCTL
argument_list|,
literal|0x380005c0
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
name|max_mask
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
name|min_mask
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4325
case|:
name|bhnd_pmu1_pllinit0
argument_list|(
name|sc
argument_list|,
name|xtalfreq
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4328
case|:
name|bhnd_pmu0_pllinit0
argument_list|(
name|sc
argument_list|,
name|xtalfreq
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM5354
case|:
if|if
condition|(
name|xtalfreq
operator|==
literal|0
condition|)
name|xtalfreq
operator|=
literal|25000
expr_stmt|;
name|bhnd_pmu0_pllinit0
argument_list|(
name|sc
argument_list|,
name|xtalfreq
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4329
case|:
if|if
condition|(
name|xtalfreq
operator|==
literal|0
condition|)
name|xtalfreq
operator|=
literal|38400
expr_stmt|;
name|bhnd_pmu1_pllinit0
argument_list|(
name|sc
argument_list|,
name|xtalfreq
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4313
case|:
case|case
name|BHND_CHIPID_BCM43222
case|:
case|case
name|BHND_CHIPID_BCM43111
case|:
case|case
name|BHND_CHIPID_BCM43112
case|:
case|case
name|BHND_CHIPID_BCM43224
case|:
case|case
name|BHND_CHIPID_BCM43225
case|:
case|case
name|BHND_CHIPID_BCM43420
case|:
case|case
name|BHND_CHIPID_BCM43421
case|:
case|case
name|BHND_CHIPID_BCM43226
case|:
case|case
name|BHND_CHIPID_BCM43235
case|:
case|case
name|BHND_CHIPID_BCM43236
case|:
case|case
name|BHND_CHIPID_BCM43238
case|:
case|case
name|BHND_CHIPID_BCM43234
case|:
case|case
name|BHND_CHIPID_BCM43237
case|:
case|case
name|BHND_CHIPID_BCM4331
case|:
case|case
name|BHND_CHIPID_BCM43431
case|:
case|case
name|BHND_CHIPID_BCM43131
case|:
case|case
name|BHND_CHIPID_BCM43227
case|:
case|case
name|BHND_CHIPID_BCM43228
case|:
case|case
name|BHND_CHIPID_BCM43428
case|:
case|case
name|BHND_CHIPID_BCM6362
case|:
comment|/* assume default works */
break|break;
case|case
name|BHND_CHIPID_BCM4315
case|:
case|case
name|BHND_CHIPID_BCM4319
case|:
case|case
name|BHND_CHIPID_BCM4336
case|:
case|case
name|BHND_CHIPID_BCM4330
case|:
name|bhnd_pmu1_pllinit0
argument_list|(
name|sc
argument_list|,
name|xtalfreq
argument_list|)
expr_stmt|;
break|break;
default|default:
name|PMU_DEBUG
argument_list|(
literal|"No PLL init done for chip %#hx rev %d pmurev %d\n"
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_rev
argument_list|,
name|BHND_PMU_REV
argument_list|(
name|sc
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/**  * Return the ALP/XTAL clock frequency, in Hz.  *   * @param sc PMU query instance.  */
end_comment

begin_function
name|uint32_t
name|bhnd_pmu_alp_clock
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|clock
decl_stmt|;
name|clock
operator|=
name|BHND_PMU_ALP_CLOCK
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4328
case|:
case|case
name|BHND_CHIPID_BCM5354
case|:
name|clock
operator|=
name|bhnd_pmu0_alpclk0
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4315
case|:
case|case
name|BHND_CHIPID_BCM4319
case|:
case|case
name|BHND_CHIPID_BCM4325
case|:
case|case
name|BHND_CHIPID_BCM4329
case|:
case|case
name|BHND_CHIPID_BCM4330
case|:
case|case
name|BHND_CHIPID_BCM4336
case|:
name|clock
operator|=
name|bhnd_pmu1_alpclk0
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4312
case|:
case|case
name|BHND_CHIPID_BCM4322
case|:
case|case
name|BHND_CHIPID_BCM43221
case|:
case|case
name|BHND_CHIPID_BCM43231
case|:
case|case
name|BHND_CHIPID_BCM43222
case|:
case|case
name|BHND_CHIPID_BCM43111
case|:
case|case
name|BHND_CHIPID_BCM43112
case|:
case|case
name|BHND_CHIPID_BCM43224
case|:
case|case
name|BHND_CHIPID_BCM43225
case|:
case|case
name|BHND_CHIPID_BCM43420
case|:
case|case
name|BHND_CHIPID_BCM43421
case|:
case|case
name|BHND_CHIPID_BCM43226
case|:
case|case
name|BHND_CHIPID_BCM43235
case|:
case|case
name|BHND_CHIPID_BCM43236
case|:
case|case
name|BHND_CHIPID_BCM43238
case|:
case|case
name|BHND_CHIPID_BCM43234
case|:
case|case
name|BHND_CHIPID_BCM43237
case|:
case|case
name|BHND_CHIPID_BCM4331
case|:
case|case
name|BHND_CHIPID_BCM43431
case|:
case|case
name|BHND_CHIPID_BCM43131
case|:
case|case
name|BHND_CHIPID_BCM43227
case|:
case|case
name|BHND_CHIPID_BCM43228
case|:
case|case
name|BHND_CHIPID_BCM43428
case|:
case|case
name|BHND_CHIPID_BCM6362
case|:
case|case
name|BHND_CHIPID_BCM4342
case|:
case|case
name|BHND_CHIPID_BCM4716
case|:
case|case
name|BHND_CHIPID_BCM4748
case|:
case|case
name|BHND_CHIPID_BCM47162
case|:
case|case
name|BHND_CHIPID_BCM4313
case|:
case|case
name|BHND_CHIPID_BCM5357
case|:
case|case
name|BHND_CHIPID_BCM4749
case|:
case|case
name|BHND_CHIPID_BCM53572
case|:
comment|/* always 20Mhz */
name|clock
operator|=
literal|20000
operator|*
literal|1000
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM5356
case|:
case|case
name|BHND_CHIPID_BCM4706
case|:
comment|/* always 25Mhz */
name|clock
operator|=
literal|25000
operator|*
literal|1000
expr_stmt|;
break|break;
default|default:
name|PMU_DEBUG
argument_list|(
literal|"No ALP clock specified "
literal|"for chip %s rev %d pmurev %d, using default %d Hz\n"
argument_list|,
name|bcm_chipname
argument_list|(
name|sih
operator|->
name|chip
argument_list|,
name|chn
argument_list|,
literal|8
argument_list|)
argument_list|,
name|sih
operator|->
name|chiprev
argument_list|,
name|sih
operator|->
name|pmurev
argument_list|,
name|clock
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|clock
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Find the output of the "m" pll divider given pll controls that start with  * pllreg "pll0" i.e. 12 for main 6 for phy, 0 for misc.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|bhnd_pmu5_clock
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|,
name|u_int
name|pll0
parameter_list|,
name|u_int
name|m
parameter_list|)
block|{
name|uint32_t
name|div
decl_stmt|;
name|uint32_t
name|fc
decl_stmt|;
name|uint32_t
name|ndiv
decl_stmt|;
name|uint32_t
name|p1
decl_stmt|,
name|p2
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
operator|(
name|pll0
operator|&
literal|3
operator|)
operator|||
operator|(
name|pll0
operator|>
name|BHND_PMU4716_MAINPLL_PLL0
operator|)
condition|)
block|{
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"%s: Bad pll0: %d"
argument_list|,
name|__func__
argument_list|,
name|pll0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Strictly there is an m5 divider, but I'm not sure we use it */
if|if
condition|(
operator|(
name|m
operator|==
literal|0
operator|)
operator|||
operator|(
name|m
operator|>
literal|4
operator|)
condition|)
block|{
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"%s: Bad m divider: %d"
argument_list|,
name|__func__
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM5357
operator|||
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4749
condition|)
block|{
comment|/* Detect failure in clock setting */
name|tmp
operator|=
name|sc
operator|->
name|io
operator|->
name|rd_chipst
argument_list|(
name|sc
operator|->
name|io_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
literal|0x40000
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|133
operator|*
literal|1000000
operator|)
return|;
block|}
comment|/* Fetch p1 and p2 */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_ADDR
argument_list|,
name|pll0
operator|+
name|BHND_PMU5_PLL_P1P2_OFF
argument_list|)
expr_stmt|;
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_ADDR
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_DATA
argument_list|)
expr_stmt|;
name|p1
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU5_PLL_P1
argument_list|)
expr_stmt|;
name|p2
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU5_PLL_P2
argument_list|)
expr_stmt|;
comment|/* Fetch div */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_ADDR
argument_list|,
name|pll0
operator|+
name|BHND_PMU5_PLL_M14_OFF
argument_list|)
expr_stmt|;
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_ADDR
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_DATA
argument_list|)
expr_stmt|;
name|div
operator|=
operator|(
name|tmp
operator|>>
operator|(
operator|(
name|m
operator|-
literal|1
operator|)
operator|*
name|BHND_PMU5_PLL_MDIV_WIDTH
operator|)
operator|)
expr_stmt|;
name|div
operator|&=
name|BHND_PMU5_PLL_MDIV_MASK
expr_stmt|;
comment|/* Fetch ndiv */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_ADDR
argument_list|,
name|pll0
operator|+
name|BHND_PMU5_PLL_NM5_OFF
argument_list|)
expr_stmt|;
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_ADDR
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_DATA
argument_list|)
expr_stmt|;
name|ndiv
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU5_PLL_NDIV
argument_list|)
expr_stmt|;
comment|/* Do calculation in Mhz */
name|fc
operator|=
name|bhnd_pmu_alp_clock
argument_list|(
name|sc
argument_list|)
operator|/
literal|1000000
expr_stmt|;
name|fc
operator|=
operator|(
name|p1
operator|*
name|ndiv
operator|*
name|fc
operator|)
operator|/
name|p2
expr_stmt|;
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"%s: p1=%d, p2=%d, ndiv=%d(0x%x), m%d=%d; fc=%d, "
literal|"clock=%d\n"
argument_list|,
name|__func__
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|,
name|ndiv
argument_list|,
name|ndiv
argument_list|,
name|m
argument_list|,
name|div
argument_list|,
name|fc
argument_list|,
name|fc
operator|/
name|div
argument_list|)
expr_stmt|;
comment|/* Return clock in Hertz */
return|return
operator|(
operator|(
name|fc
operator|/
name|div
operator|)
operator|*
literal|1000000
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|bhnd_pmu6_4706_clock
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|,
name|u_int
name|pll0
parameter_list|,
name|u_int
name|m
parameter_list|)
block|{
name|uint32_t
name|chipst
decl_stmt|,
name|clock
decl_stmt|;
name|uint32_t
name|ndiv
decl_stmt|,
name|p1div
decl_stmt|,
name|p2div
decl_stmt|,
name|tmp
decl_stmt|;
comment|/* Get N, P1 and P2 dividers to determine CPU clock */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_ADDR
argument_list|,
name|pll0
operator|+
name|BHND_PMU6_4706_PROCPLL_OFF
argument_list|)
expr_stmt|;
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_ADDR
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_PLL_CONTROL_DATA
argument_list|)
expr_stmt|;
name|ndiv
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU6_4706_PROC_NDIV_INT
argument_list|)
expr_stmt|;
name|p1div
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU6_4706_PROC_P1DIV
argument_list|)
expr_stmt|;
name|p2div
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|tmp
argument_list|,
name|BHND_PMU6_4706_PROC_P2DIV
argument_list|)
expr_stmt|;
comment|/* Fixed 25MHz reference clock */
name|clock
operator|=
literal|25
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
comment|/* The low-cost bonding uses an input divider of 4; otherwise, 2 */
name|chipst
operator|=
name|sc
operator|->
name|io
operator|->
name|rd_chipst
argument_list|(
name|sc
operator|->
name|io_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|chipst
operator|&
name|CHIPC_CST4706_LOWCOST_PKG
condition|)
name|clock
operator|/=
literal|4
expr_stmt|;
else|else
name|clock
operator|/=
literal|2
expr_stmt|;
name|clock
operator|*=
name|ndiv
operator|*
name|p2div
operator|/
name|p1div
expr_stmt|;
switch|switch
condition|(
name|m
condition|)
block|{
case|case
name|BHND_PMU6_MAINPLL_CPU
case|:
return|return
operator|(
name|clock
operator|)
return|;
case|case
name|BHND_PMU6_MAINPLL_MEM
case|:
return|return
operator|(
name|clock
operator|/
literal|2
operator|)
return|;
case|case
name|BHND_PMU6_MAINPLL_SI
case|:
return|return
operator|(
name|clock
operator|/
literal|4
operator|)
return|;
default|default:
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"bad m divider: %d"
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/**  * Return the backplane clock frequency, in Hz.  *   * On designs that feed the same clock to both backplane  * and CPU, this returns the CPU clock speed.  *   * @param sc PMU query instance.  */
end_comment

begin_function
name|uint32_t
name|bhnd_pmu_si_clock
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|chipst
decl_stmt|;
name|uint32_t
name|clock
decl_stmt|;
name|clock
operator|=
name|BHND_PMU_HT_CLOCK
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4322
case|:
case|case
name|BHND_CHIPID_BCM43221
case|:
case|case
name|BHND_CHIPID_BCM43231
case|:
case|case
name|BHND_CHIPID_BCM43222
case|:
case|case
name|BHND_CHIPID_BCM43111
case|:
case|case
name|BHND_CHIPID_BCM43112
case|:
case|case
name|BHND_CHIPID_BCM43224
case|:
case|case
name|BHND_CHIPID_BCM43420
case|:
case|case
name|BHND_CHIPID_BCM43225
case|:
case|case
name|BHND_CHIPID_BCM43421
case|:
case|case
name|BHND_CHIPID_BCM43226
case|:
case|case
name|BHND_CHIPID_BCM4331
case|:
case|case
name|BHND_CHIPID_BCM43431
case|:
case|case
name|BHND_CHIPID_BCM6362
case|:
case|case
name|BHND_CHIPID_BCM4342
case|:
comment|/* 96MHz backplane clock */
name|clock
operator|=
literal|96000
operator|*
literal|1000
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4716
case|:
case|case
name|BHND_CHIPID_BCM4748
case|:
case|case
name|BHND_CHIPID_BCM47162
case|:
name|clock
operator|=
name|bhnd_pmu5_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU4716_MAINPLL_PLL0
argument_list|,
name|BHND_PMU5_MAINPLL_SI
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4325
case|:
name|clock
operator|=
name|bhnd_pmu1_cpuclk0
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4328
case|:
name|clock
operator|=
name|bhnd_pmu0_cpuclk0
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4329
case|:
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|==
literal|0
condition|)
name|clock
operator|=
literal|38400
operator|*
literal|1000
expr_stmt|;
else|else
name|clock
operator|=
name|bhnd_pmu1_cpuclk0
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4315
case|:
case|case
name|BHND_CHIPID_BCM4319
case|:
case|case
name|BHND_CHIPID_BCM4336
case|:
case|case
name|BHND_CHIPID_BCM4330
case|:
name|clock
operator|=
name|bhnd_pmu1_cpuclk0
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4313
case|:
comment|/* 80MHz backplane clock */
name|clock
operator|=
literal|80000
operator|*
literal|1000
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM43234
case|:
case|case
name|BHND_CHIPID_BCM43235
case|:
case|case
name|BHND_CHIPID_BCM43236
case|:
case|case
name|BHND_CHIPID_BCM43238
case|:
name|chipst
operator|=
name|sc
operator|->
name|io
operator|->
name|rd_chipst
argument_list|(
name|sc
operator|->
name|io_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|chipst
operator|&
name|CHIPC_CST43236_BP_CLK
condition|)
name|clock
operator|=
literal|120000
operator|*
literal|1000
expr_stmt|;
else|else
name|clock
operator|=
literal|96000
operator|*
literal|1000
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM43237
case|:
name|chipst
operator|=
name|sc
operator|->
name|io
operator|->
name|rd_chipst
argument_list|(
name|sc
operator|->
name|io_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|chipst
operator|&
name|CHIPC_CST43237_BP_CLK
condition|)
name|clock
operator|=
literal|96000
operator|*
literal|1000
expr_stmt|;
else|else
name|clock
operator|=
literal|80000
operator|*
literal|1000
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM5356
case|:
name|clock
operator|=
name|bhnd_pmu5_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU5356_MAINPLL_PLL0
argument_list|,
name|BHND_PMU5_MAINPLL_SI
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM5357
case|:
case|case
name|BHND_CHIPID_BCM4749
case|:
name|clock
operator|=
name|bhnd_pmu5_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU5357_MAINPLL_PLL0
argument_list|,
name|BHND_PMU5_MAINPLL_SI
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4706
case|:
name|clock
operator|=
name|bhnd_pmu6_4706_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU4706_MAINPLL_PLL0
argument_list|,
name|BHND_PMU6_MAINPLL_SI
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM53572
case|:
name|clock
operator|=
literal|75000000
expr_stmt|;
break|break;
default|default:
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"No backplane clock specified for chip %#hx rev "
literal|"%hhd pmurev %hhd, using default %dHz\n"
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_rev
argument_list|,
name|BHND_PMU_REV
argument_list|(
name|sc
argument_list|)
argument_list|,
name|clock
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|clock
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * Return the CPU clock frequency, in Hz.  *   * @param sc PMU query instance.  */
end_comment

begin_function
name|uint32_t
name|bhnd_pmu_cpu_clock
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
comment|/* 5354 chip uses a non programmable PLL of frequency 240MHz */
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM5354
condition|)
return|return
operator|(
literal|240
operator|*
literal|1000
operator|*
literal|1000
operator|)
return|;
comment|/* 240MHz */
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM53572
condition|)
return|return
operator|(
literal|300000000
operator|)
return|;
if|if
condition|(
name|BHND_PMU_REV
argument_list|(
name|sc
argument_list|)
operator|>=
literal|5
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM4329
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM4319
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM43234
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM43235
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM43236
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM43237
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM43238
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM4336
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM4330
condition|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM5356
case|:
return|return
operator|(
name|bhnd_pmu5_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU5356_MAINPLL_PLL0
argument_list|,
name|BHND_PMU5_MAINPLL_CPU
argument_list|)
operator|)
return|;
case|case
name|BHND_CHIPID_BCM5357
case|:
case|case
name|BHND_CHIPID_BCM4749
case|:
return|return
operator|(
name|bhnd_pmu5_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU5357_MAINPLL_PLL0
argument_list|,
name|BHND_PMU5_MAINPLL_CPU
argument_list|)
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4706
case|:
return|return
operator|(
name|bhnd_pmu6_4706_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU4706_MAINPLL_PLL0
argument_list|,
name|BHND_PMU6_MAINPLL_CPU
argument_list|)
operator|)
return|;
default|default:
return|return
operator|(
name|bhnd_pmu5_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU4716_MAINPLL_PLL0
argument_list|,
name|BHND_PMU5_MAINPLL_CPU
argument_list|)
operator|)
return|;
block|}
block|}
else|else
block|{
return|return
operator|(
name|bhnd_pmu_si_clock
argument_list|(
name|sc
argument_list|)
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/**  * Return the memory clock frequency, in Hz.  *   * @param sc PMU query instance.  */
end_comment

begin_function
name|uint32_t
name|bhnd_pmu_mem_clock
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|BHND_PMU_REV
argument_list|(
name|sc
argument_list|)
operator|>=
literal|5
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM4329
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM4319
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM43234
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM43235
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM43236
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM43237
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM43238
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM4336
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|!=
name|BHND_CHIPID_BCM4330
condition|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM5356
case|:
return|return
operator|(
name|bhnd_pmu5_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU5356_MAINPLL_PLL0
argument_list|,
name|BHND_PMU5_MAINPLL_MEM
argument_list|)
operator|)
return|;
case|case
name|BHND_CHIPID_BCM5357
case|:
case|case
name|BHND_CHIPID_BCM4749
case|:
return|return
operator|(
name|bhnd_pmu5_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU5357_MAINPLL_PLL0
argument_list|,
name|BHND_PMU5_MAINPLL_MEM
argument_list|)
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4706
case|:
return|return
operator|(
name|bhnd_pmu6_4706_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU4706_MAINPLL_PLL0
argument_list|,
name|BHND_PMU6_MAINPLL_MEM
argument_list|)
operator|)
return|;
default|default:
return|return
operator|(
name|bhnd_pmu5_clock
argument_list|(
name|sc
argument_list|,
name|BHND_PMU4716_MAINPLL_PLL0
argument_list|,
name|BHND_PMU5_MAINPLL_MEM
argument_list|)
operator|)
return|;
block|}
block|}
else|else
block|{
return|return
operator|(
name|bhnd_pmu_si_clock
argument_list|(
name|sc
argument_list|)
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* Measure ILP clock frequency */
end_comment

begin_define
define|#
directive|define
name|ILP_CALC_DUR
value|10
end_define

begin_comment
comment|/* ms, make sure 1000 can be divided by it. */
end_comment

begin_comment
comment|/**  * Measure and return the ILP clock frequency, in Hz.  *   * @param sc PMU query instance.  */
end_comment

begin_function
name|uint32_t
name|bhnd_pmu_ilp_clock
parameter_list|(
name|struct
name|bhnd_pmu_query
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|start
decl_stmt|,
name|end
decl_stmt|,
name|delta
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|ilp_cps
operator|==
literal|0
condition|)
block|{
name|start
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_TIMER
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|ILP_CALC_DUR
argument_list|)
expr_stmt|;
name|end
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_TIMER
argument_list|)
expr_stmt|;
name|delta
operator|=
name|end
operator|-
name|start
expr_stmt|;
name|sc
operator|->
name|ilp_cps
operator|=
name|delta
operator|*
operator|(
literal|1000
operator|/
name|ILP_CALC_DUR
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|sc
operator|->
name|ilp_cps
operator|)
return|;
block|}
end_function

begin_comment
comment|/* SDIO Pad drive strength to select value mappings */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|uint8_t
name|strength
decl_stmt|;
comment|/* Pad Drive Strength in mA */
name|uint8_t
name|sel
decl_stmt|;
comment|/* Chip-specific select value */
block|}
name|sdiod_drive_str_t
typedef|;
end_typedef

begin_comment
comment|/* SDIO Drive Strength to sel value table for PMU Rev 1 */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|sdiod_drive_str_t
name|sdiod_drive_strength_tab1
index|[]
init|=
block|{
block|{
literal|4
block|,
literal|0x2
block|}
block|,
block|{
literal|2
block|,
literal|0x3
block|}
block|,
block|{
literal|1
block|,
literal|0x0
block|}
block|,
block|{
literal|0
block|,
literal|0x0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* SDIO Drive Strength to sel value table for PMU Rev 2, 3 */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|sdiod_drive_str_t
name|sdiod_drive_strength_tab2
index|[]
init|=
block|{
block|{
literal|12
block|,
literal|0x7
block|}
block|,
block|{
literal|10
block|,
literal|0x6
block|}
block|,
block|{
literal|8
block|,
literal|0x5
block|}
block|,
block|{
literal|6
block|,
literal|0x4
block|}
block|,
block|{
literal|4
block|,
literal|0x2
block|}
block|,
block|{
literal|2
block|,
literal|0x1
block|}
block|,
block|{
literal|0
block|,
literal|0x0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* SDIO Drive Strength to sel value table for PMU Rev 8 (1.8V) */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|sdiod_drive_str_t
name|sdiod_drive_strength_tab3
index|[]
init|=
block|{
block|{
literal|32
block|,
literal|0x7
block|}
block|,
block|{
literal|26
block|,
literal|0x6
block|}
block|,
block|{
literal|22
block|,
literal|0x5
block|}
block|,
block|{
literal|16
block|,
literal|0x4
block|}
block|,
block|{
literal|12
block|,
literal|0x3
block|}
block|,
block|{
literal|8
block|,
literal|0x2
block|}
block|,
block|{
literal|4
block|,
literal|0x1
block|}
block|,
block|{
literal|0
block|,
literal|0x0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SDIOD_DRVSTR_KEY
parameter_list|(
name|chip
parameter_list|,
name|pmu
parameter_list|)
value|(((chip)<< 16) | (pmu))
end_define

begin_function
name|void
name|bhnd_pmu_sdiod_drive_strength_init
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|drivestrength
parameter_list|)
block|{
specifier|const
name|sdiod_drive_str_t
modifier|*
name|str_tab
decl_stmt|;
name|uint32_t
name|str_mask
decl_stmt|;
name|uint32_t
name|str_shift
decl_stmt|;
name|u_int
name|intr_val
decl_stmt|;
name|str_tab
operator|=
name|NULL
expr_stmt|;
name|str_mask
operator|=
literal|0
expr_stmt|;
name|str_shift
operator|=
literal|0
expr_stmt|;
name|intr_val
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|SDIOD_DRVSTR_KEY
argument_list|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|,
name|BHND_PMU_REV
argument_list|(
name|sc
argument_list|)
argument_list|)
condition|)
block|{
case|case
name|SDIOD_DRVSTR_KEY
argument_list|(
name|BHND_CHIPID_BCM4325
argument_list|,
literal|1
argument_list|)
case|:
name|str_tab
operator|=
name|sdiod_drive_strength_tab1
expr_stmt|;
name|str_mask
operator|=
literal|0x30000000
expr_stmt|;
name|str_shift
operator|=
literal|28
expr_stmt|;
break|break;
case|case
name|SDIOD_DRVSTR_KEY
argument_list|(
name|BHND_CHIPID_BCM4325
argument_list|,
literal|2
argument_list|)
case|:
case|case
name|SDIOD_DRVSTR_KEY
argument_list|(
name|BHND_CHIPID_BCM4325
argument_list|,
literal|3
argument_list|)
case|:
case|case
name|SDIOD_DRVSTR_KEY
argument_list|(
name|BHND_CHIPID_BCM4315
argument_list|,
literal|4
argument_list|)
case|:
case|case
name|SDIOD_DRVSTR_KEY
argument_list|(
name|BHND_CHIPID_BCM4319
argument_list|,
literal|7
argument_list|)
case|:
name|str_tab
operator|=
name|sdiod_drive_strength_tab2
expr_stmt|;
name|str_mask
operator|=
literal|0x00003800
expr_stmt|;
name|str_shift
operator|=
literal|11
expr_stmt|;
break|break;
case|case
name|SDIOD_DRVSTR_KEY
argument_list|(
name|BHND_CHIPID_BCM4336
argument_list|,
literal|8
argument_list|)
case|:
name|str_tab
operator|=
name|sdiod_drive_strength_tab3
expr_stmt|;
name|str_mask
operator|=
literal|0x00003800
expr_stmt|;
name|str_shift
operator|=
literal|11
expr_stmt|;
break|break;
default|default:
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"No SDIO Drive strength init done for chip %#x "
literal|"rev %hhd pmurev %hhd\n"
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_rev
argument_list|,
name|BHND_PMU_REV
argument_list|(
name|sc
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|str_tab
operator|!=
name|NULL
condition|)
block|{
name|uint32_t
name|drivestrength_sel
init|=
literal|0
decl_stmt|;
name|uint32_t
name|cc_data_temp
decl_stmt|;
for|for
control|(
name|u_int
name|i
init|=
literal|0
init|;
name|str_tab
index|[
name|i
index|]
operator|.
name|strength
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|drivestrength
operator|>=
name|str_tab
index|[
name|i
index|]
operator|.
name|strength
condition|)
block|{
name|drivestrength_sel
operator|=
name|str_tab
index|[
name|i
index|]
operator|.
name|sel
expr_stmt|;
break|break;
block|}
block|}
name|cc_data_temp
operator|=
name|BHND_PMU_CCTRL_READ
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cc_data_temp
operator|&=
operator|~
name|str_mask
expr_stmt|;
name|drivestrength_sel
operator|<<=
name|str_shift
expr_stmt|;
name|cc_data_temp
operator||=
name|drivestrength_sel
expr_stmt|;
name|BHND_PMU_CCTRL_WRITE
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
name|cc_data_temp
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"SDIO: %dmA drive strength selected, set to "
literal|"0x%08x\n"
argument_list|,
name|drivestrength
argument_list|,
name|cc_data_temp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * Initialize the PMU.  */
end_comment

begin_function
name|int
name|bhnd_pmu_init
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|xtalfreq
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|BHND_PMU_REV
argument_list|(
name|sc
argument_list|)
operator|==
literal|1
condition|)
block|{
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|,
operator|~
name|BHND_PMU_CTRL_NOILP_ON_WAIT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|BHND_PMU_REV
argument_list|(
name|sc
argument_list|)
operator|>=
literal|2
condition|)
block|{
name|BHND_PMU_OR_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|,
name|BHND_PMU_CTRL_NOILP_ON_WAIT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4329
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|==
literal|2
condition|)
block|{
comment|/* Fix for 4329b0 bad LPOM state. */
name|BHND_PMU_REGCTRL_WRITE
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|,
literal|0x100
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_REGCTRL_WRITE
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|,
literal|0x4
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4319
condition|)
block|{
comment|/* Limiting the PALDO spike during init time */
name|BHND_PMU_REGCTRL_WRITE
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|,
literal|0x00000005
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
block|}
comment|/* Fetch target xtalfreq, in KHz */
name|error
operator|=
name|bhnd_nvram_getvar_uint32
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|,
name|BHND_NVAR_XTALFREQ
argument_list|,
operator|&
name|xtalfreq
argument_list|)
expr_stmt|;
comment|/* If not available, log any real errors, and then try to measure it */
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|error
operator|!=
name|ENOENT
condition|)
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"error fetching xtalfreq: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|xtalfreq
operator|=
name|bhnd_pmu_measure_alpclk
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
comment|/* Perform PLL initialization */
name|bhnd_pmu_pll_init
argument_list|(
name|sc
argument_list|,
name|xtalfreq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pmu_res_init
argument_list|(
name|sc
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|bhnd_pmu_swreg_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Return up time in ILP cycles for the given resource. */
end_comment

begin_function
specifier|static
name|int
name|bhnd_pmu_res_uptime
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|rsrc
parameter_list|,
name|uint32_t
modifier|*
name|uptime
parameter_list|)
block|{
name|uint32_t
name|deps
decl_stmt|;
name|uint32_t
name|up
decl_stmt|,
name|dup
decl_stmt|,
name|dmax
decl_stmt|;
name|uint32_t
name|min_mask
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* uptime of resource 'rsrc' */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_TABLE_SEL
argument_list|,
name|rsrc
argument_list|)
expr_stmt|;
name|up
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_UPDN_TIMER
argument_list|)
expr_stmt|;
name|up
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|up
argument_list|,
name|BHND_PMU_RES_UPDN_UPTME
argument_list|)
expr_stmt|;
comment|/* Find direct dependencies of resource 'rsrc' */
name|deps
operator|=
name|bhnd_pmu_res_deps
argument_list|(
name|sc
argument_list|,
name|BHND_PMURES_BIT
argument_list|(
name|rsrc
argument_list|)
argument_list|,
name|false
argument_list|)
expr_stmt|;
for|for
control|(
name|uint8_t
name|i
init|=
literal|0
init|;
name|i
operator|<=
name|BHND_PMU_RESNUM_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|deps
operator|&
name|BHND_PMURES_BIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|deps
operator|&=
operator|~
name|bhnd_pmu_res_deps
argument_list|(
name|sc
argument_list|,
name|BHND_PMURES_BIT
argument_list|(
name|i
argument_list|)
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
comment|/* Exclude the minimum resource set */
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pmu_res_masks
argument_list|(
name|sc
argument_list|,
operator|&
name|min_mask
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|deps
operator|&=
operator|~
name|min_mask
expr_stmt|;
comment|/* max uptime of direct dependencies */
name|dmax
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|uint8_t
name|i
init|=
literal|0
init|;
name|i
operator|<=
name|BHND_PMU_RESNUM_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|deps
operator|&
name|BHND_PMURES_BIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pmu_res_uptime
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
operator|&
name|dup
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|dmax
operator|<
name|dup
condition|)
name|dmax
operator|=
name|dup
expr_stmt|;
block|}
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"bhnd_pmu_res_uptime: rsrc %hhu uptime %u(deps 0x%08x "
literal|"uptime %u)\n"
argument_list|,
name|rsrc
argument_list|,
name|up
argument_list|,
name|deps
argument_list|,
name|dmax
argument_list|)
expr_stmt|;
operator|*
name|uptime
operator|=
operator|(
name|up
operator|+
name|dmax
operator|+
name|BHND_PMURES_UP_TRANSITION
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Return dependencies (direct or all/indirect) for the given resources */
end_comment

begin_function
specifier|static
name|uint32_t
name|bhnd_pmu_res_deps
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|rsrcs
parameter_list|,
name|bool
name|all
parameter_list|)
block|{
name|uint32_t
name|deps
decl_stmt|;
name|deps
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|uint8_t
name|i
init|=
literal|0
init|;
name|i
operator|<=
name|BHND_PMU_RESNUM_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|rsrcs
operator|&
name|BHND_PMURES_BIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_TABLE_SEL
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|deps
operator||=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_DEP_MASK
argument_list|)
expr_stmt|;
block|}
comment|/* None found? */
if|if
condition|(
name|deps
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Recurse dependencies */
if|if
condition|(
name|all
condition|)
name|deps
operator||=
name|bhnd_pmu_res_deps
argument_list|(
name|sc
argument_list|,
name|deps
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return
operator|(
name|deps
operator|)
return|;
block|}
end_function

begin_comment
comment|/* power up/down OTP through PMU resources */
end_comment

begin_function
name|int
name|bhnd_pmu_otp_power
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|bool
name|on
parameter_list|)
block|{
name|uint32_t
name|deps
decl_stmt|;
name|uint32_t
name|min_mask
decl_stmt|;
name|uint32_t
name|rsrcs
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Determine rsrcs to turn on/off OTP power */
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4322
case|:
case|case
name|BHND_CHIPID_BCM43221
case|:
case|case
name|BHND_CHIPID_BCM43231
case|:
case|case
name|BHND_CHIPID_BCM4342
case|:
name|rsrcs
operator|=
name|PMURES_BIT
argument_list|(
name|RES4322_OTP_PU
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4315
case|:
name|rsrcs
operator|=
name|PMURES_BIT
argument_list|(
name|RES4315_OTP_PU
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4325
case|:
name|rsrcs
operator|=
name|PMURES_BIT
argument_list|(
name|RES4325_OTP_PU
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4329
case|:
name|rsrcs
operator|=
name|PMURES_BIT
argument_list|(
name|RES4329_OTP_PU
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4319
case|:
name|rsrcs
operator|=
name|PMURES_BIT
argument_list|(
name|RES4319_OTP_PU
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4336
case|:
name|rsrcs
operator|=
name|PMURES_BIT
argument_list|(
name|RES4336_OTP_PU
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4330
case|:
name|rsrcs
operator|=
name|PMURES_BIT
argument_list|(
name|RES4330_OTP_PU
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Not required? */
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Fetch all dependencies */
name|deps
operator|=
name|bhnd_pmu_res_deps
argument_list|(
name|sc
argument_list|,
name|rsrcs
argument_list|,
name|true
argument_list|)
expr_stmt|;
comment|/* Exclude the minimum resource set */
if|if
condition|(
operator|(
name|error
operator|=
name|bhnd_pmu_res_masks
argument_list|(
name|sc
argument_list|,
operator|&
name|min_mask
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|deps
operator|&=
operator|~
name|min_mask
expr_stmt|;
comment|/* Turn on/off the power */
if|if
condition|(
name|on
condition|)
block|{
name|uint32_t
name|state
decl_stmt|;
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Adding rsrc 0x%x to min_res_mask\n"
argument_list|,
name|rsrcs
operator||
name|deps
argument_list|)
expr_stmt|;
name|BHND_PMU_OR_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|(
name|rsrcs
operator||
name|deps
operator|)
argument_list|)
expr_stmt|;
comment|/* Wait for all resources to become available */
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|BHND_PMU_MAX_TRANSITION_DLY
condition|;
name|i
operator|+=
literal|10
control|)
block|{
name|state
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|state
operator|&
name|rsrcs
operator|)
operator|==
name|rsrcs
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|state
operator|&
name|rsrcs
operator|)
operator|!=
name|rsrcs
condition|)
block|{
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"timeout waiting for OTP resource "
literal|"enable\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
block|}
else|else
block|{
name|PMU_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"Removing rsrc 0x%x from min_res_mask\n"
argument_list|,
name|rsrcs
operator||
name|deps
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
operator|(
name|rsrcs
operator||
name|deps
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bhnd_pmu_rcal
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|chipst
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|uint8_t
name|rcal_code
decl_stmt|;
name|bool
name|bluetooth_rcal
decl_stmt|;
name|bluetooth_rcal
operator|=
name|false
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4325
case|:
case|case
name|BHND_CHIPID_BCM4329
case|:
comment|/* Kick RCal */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_ADDR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Power Down RCAL Block */
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_DATA
argument_list|,
operator|~
literal|0x04
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4325
condition|)
block|{
name|chipst
operator|=
name|BHND_CHIPC_READ_CHIPST
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|BHND_PMU_GET_BITS
argument_list|(
name|chipst
argument_list|,
name|CHIPC_CST4325_RCAL_VALID
argument_list|)
condition|)
name|bluetooth_rcal
operator|=
name|true
expr_stmt|;
block|}
comment|/* Power Up RCAL block */
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_DATA
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
comment|/* Wait for completion */
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
operator|(
literal|10
operator|*
literal|1000
operator|*
literal|1000
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|chipst
operator|=
name|BHND_CHIPC_READ_CHIPST
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|chipst
operator|&
literal|0x08
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|KASSERT
argument_list|(
operator|(
name|chipst
operator|&
literal|0x08
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"rcal completion timeout"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bluetooth_rcal
condition|)
block|{
name|rcal_code
operator|=
literal|0x6
expr_stmt|;
block|}
else|else
block|{
comment|/* Drop LSB to convert from 5 bit code to 4 bit code */
name|rcal_code
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|chipst
operator|>>
literal|5
argument_list|)
operator|&
literal|0x0f
expr_stmt|;
block|}
name|PMU_DEBUG
argument_list|(
literal|"RCal completed, status 0x%x, code 0x%x\n"
argument_list|,
name|R_REG
argument_list|(
operator|&
name|cc
operator|->
name|chipstatus
argument_list|)
argument_list|,
name|rcal_code
argument_list|)
expr_stmt|;
comment|/* Write RCal code into pmu_vreg_ctrl[32:29] */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_REG_CONTROL_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_REG_CONTROL_DATA
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
operator|(
name|uint32_t
operator|)
literal|0x07
operator|<<
literal|29
operator|)
expr_stmt|;
name|val
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|rcal_code
operator|&
literal|0x07
argument_list|)
operator|<<
literal|29
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_REG_CONTROL_DATA
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_REG_CONTROL_ADDR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|val
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_REG_CONTROL_DATA
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
name|uint32_t
operator|)
literal|0x01
expr_stmt|;
name|val
operator||=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|rcal_code
operator|>>
literal|3
operator|)
operator|&
literal|0x01
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_REG_CONTROL_DATA
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Write RCal code into pmu_chip_ctrl[33:30] */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_DATA
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
operator|(
name|uint32_t
operator|)
literal|0x03
operator|<<
literal|30
operator|)
expr_stmt|;
name|val
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|rcal_code
operator|&
literal|0x03
argument_list|)
operator|<<
literal|30
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_DATA
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_ADDR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|val
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_DATA
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
name|uint32_t
operator|)
literal|0x03
expr_stmt|;
name|val
operator||=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|rcal_code
operator|>>
literal|2
operator|)
operator|&
literal|0x03
argument_list|)
expr_stmt|;
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_DATA
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Set override in pmu_chip_ctrl[29] */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_OR_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_DATA
argument_list|,
operator|(
literal|0x01
operator|<<
literal|29
operator|)
argument_list|)
expr_stmt|;
comment|/* Power off RCal block */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_ADDR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CHIPCTL_DATA
argument_list|,
operator|~
literal|0x04
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|void
name|bhnd_pmu_spuravoid
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|spuravoid
parameter_list|)
block|{
comment|/* force the HT off  */
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4336
condition|)
block|{
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
operator|~
name|BHND_PMU_RES4336_HT_AVAIL
argument_list|)
expr_stmt|;
comment|/* wait for the ht to really go away */
name|PMU_WAIT_CLKST
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|BHND_CCS_HTAVAIL
argument_list|)
expr_stmt|;
block|}
comment|/* update the pll changes */
name|bhnd_pmu_spuravoid_pllupdate
argument_list|(
name|sc
argument_list|,
name|spuravoid
argument_list|)
expr_stmt|;
comment|/* enable HT back on  */
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM4336
condition|)
block|{
name|BHND_PMU_OR_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MAX_RES_MASK
argument_list|,
name|BHND_PMU_RES4336_HT_AVAIL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bhnd_pmu_spuravoid_pllupdate
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|spuravoid
parameter_list|)
block|{
name|uint16_t
name|chip_id
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|uint32_t
name|pmuctrl
decl_stmt|;
name|uint8_t
name|phypll_offset
decl_stmt|;
name|uint8_t
name|bcm5357_bcm43236_p1div
index|[]
init|=
block|{
literal|0x1
block|,
literal|0x5
block|,
literal|0x5
block|}
decl_stmt|;
name|uint8_t
name|bcm5357_bcm43236_ndiv
index|[]
init|=
block|{
literal|0x30
block|,
literal|0xf6
block|,
literal|0xfc
block|}
decl_stmt|;
comment|/* 6362a0 has same clks as 4322[4-6] */
name|chip_id
operator|=
name|sc
operator|->
name|cid
operator|.
name|chip_id
expr_stmt|;
if|if
condition|(
name|chip_id
operator|==
name|BHND_CHIPID_BCM6362
operator|&&
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|==
literal|0
condition|)
block|{
name|chip_id
operator|=
name|BHND_CHIPID_BCM43224
expr_stmt|;
block|}
switch|switch
condition|(
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM6362
case|:
name|KASSERT
argument_list|(
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|!=
literal|0
argument_list|,
operator|(
literal|"invalid clock config"
operator|)
argument_list|)
expr_stmt|;
comment|/* fallthrough */
case|case
name|BHND_CHIPID_BCM5357
case|:
case|case
name|BHND_CHIPID_BCM4749
case|:
case|case
name|BHND_CHIPID_BCM43235
case|:
case|case
name|BHND_CHIPID_BCM43236
case|:
case|case
name|BHND_CHIPID_BCM43238
case|:
case|case
name|BHND_CHIPID_BCM43234
case|:
case|case
name|BHND_CHIPID_BCM43237
case|:
case|case
name|BHND_CHIPID_BCM53572
case|:
name|KASSERT
argument_list|(
name|spuravoid
operator|<
name|nitems
argument_list|(
name|bcm5357_bcm43236_p1div
argument_list|)
argument_list|,
operator|(
literal|"spuravoid %hhu outside p1div table\n"
operator|,
name|spuravoid
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|spuravoid
operator|<
name|nitems
argument_list|(
name|bcm5357_bcm43236_ndiv
argument_list|)
argument_list|,
operator|(
literal|"spuravoid %hhu outside ndiv table\n"
operator|,
name|spuravoid
operator|)
argument_list|)
expr_stmt|;
comment|/* BCM5357 needs to touch PLL1_PLLCTL[02], so offset 		 * PLL0_PLLCTL[02] by 6 */
name|phypll_offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
operator|==
name|BHND_CHIPID_BCM5357
condition|)
name|phypll_offset
operator|=
literal|6
expr_stmt|;
comment|/* RMW only the P1 divider */
name|tmp
operator|=
name|BHND_PMU_SET_BITS
argument_list|(
name|bcm5357_bcm43236_p1div
index|[
name|spuravoid
index|]
argument_list|,
name|BHND_PMU1_PLL0_PC0_P1DIV
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
operator|+
name|phypll_offset
argument_list|,
name|tmp
argument_list|,
name|BHND_PMU1_PLL0_PC0_P1DIV_MASK
argument_list|)
expr_stmt|;
comment|/* RMW only the int feedback divider */
name|tmp
operator|=
name|BHND_PMU_SET_BITS
argument_list|(
name|bcm5357_bcm43236_ndiv
index|[
name|spuravoid
index|]
argument_list|,
name|BHND_PMU1_PLL0_PC2_NDIV_INT
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
operator|+
name|phypll_offset
argument_list|,
name|tmp
argument_list|,
name|BHND_PMU1_PLL0_PC0_P1DIV_MASK
argument_list|)
expr_stmt|;
name|pmuctrl
operator|=
name|BHND_PMU_CTRL_PLL_PLLCTL_UPD
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4331
case|:
if|if
condition|(
name|spuravoid
operator|==
literal|2
condition|)
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11500014
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x0FC00a08
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|spuravoid
operator|==
literal|1
condition|)
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11500014
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x0F600a08
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11100014
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x03000a08
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
name|pmuctrl
operator|=
name|BHND_PMU_CTRL_PLL_PLLCTL_UPD
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM43224
case|:
case|case
name|BHND_CHIPID_BCM43225
case|:
case|case
name|BHND_CHIPID_BCM43226
case|:
case|case
name|BHND_CHIPID_BCM43421
case|:
if|if
condition|(
name|spuravoid
operator|==
literal|1
condition|)
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11500010
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
literal|0x000C0C06
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x0F600a08
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|,
literal|0x00000000
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
literal|0x2001E920
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
literal|0x88888815
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11100010
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
literal|0x000c0c06
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x03000a08
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|,
literal|0x00000000
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
literal|0x200005c0
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
literal|0x88888815
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
name|pmuctrl
operator|=
name|BHND_PMU_CTRL_PLL_PLLCTL_UPD
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM43111
case|:
case|case
name|BHND_CHIPID_BCM43112
case|:
case|case
name|BHND_CHIPID_BCM43222
case|:
case|case
name|BHND_CHIPID_BCM43420
case|:
if|if
condition|(
name|spuravoid
operator|==
literal|1
condition|)
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11500008
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
literal|0x0c000c06
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x0f600a08
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|,
literal|0x00000000
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
literal|0x2001e920
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
literal|0x88888815
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11100008
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
literal|0x0c000c06
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x03000a08
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|,
literal|0x00000000
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
literal|0x200005c0
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
literal|0x88888855
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
name|pmuctrl
operator|=
name|BHND_PMU_CTRL_PLL_PLLCTL_UPD
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4716
case|:
case|case
name|BHND_CHIPID_BCM4748
case|:
case|case
name|BHND_CHIPID_BCM47162
case|:
if|if
condition|(
name|spuravoid
operator|==
literal|1
condition|)
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11500060
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
literal|0x080C0C06
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x0F600000
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|,
literal|0x00000000
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
literal|0x2001E924
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
literal|0x88888815
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11100060
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
literal|0x080c0c06
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x03000000
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|,
literal|0x00000000
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
literal|0x200005c0
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
literal|0x88888815
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
name|pmuctrl
operator|=
name|BHND_PMU_CTRL_NOILP_ON_WAIT
operator||
name|BHND_PMU_CTRL_PLL_PLLCTL_UPD
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4319
case|:
name|pmuctrl
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4322
case|:
case|case
name|BHND_CHIPID_BCM43221
case|:
case|case
name|BHND_CHIPID_BCM43231
case|:
case|case
name|BHND_CHIPID_BCM4342
case|:
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11100070
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
literal|0x1014140a
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
literal|0x88888854
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|spuravoid
operator|==
literal|1
condition|)
block|{
comment|/* spur_avoid ON, enable 41/82/164Mhz clock mode */
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x05201828
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* enable 40/80/160Mhz clock mode */
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x05001828
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
name|pmuctrl
operator|=
name|BHND_PMU_CTRL_PLL_PLLCTL_UPD
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4336
case|:
comment|/* Looks like these are only for default xtal freq 26MHz */
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x02100020
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
literal|0x0C0C0C0C
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x01240C0C
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
literal|0x202C2820
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
literal|0x88888825
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|spuravoid
operator|==
literal|1
condition|)
block|{
name|tmp
operator|=
literal|0x00EC4EC4
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
literal|0x00762762
expr_stmt|;
block|}
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|,
name|tmp
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|pmuctrl
operator|=
name|BHND_PMU_CTRL_PLL_PLLCTL_UPD
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM43131
case|:
case|case
name|BHND_CHIPID_BCM43227
case|:
case|case
name|BHND_CHIPID_BCM43228
case|:
case|case
name|BHND_CHIPID_BCM43428
case|:
comment|/* LCNXN */
comment|/* PLL Settings for spur avoidance on/off mode, no on2 support 		 * for 43228A0 */
if|if
condition|(
name|spuravoid
operator|==
literal|1
condition|)
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x01100014
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
literal|0x040C0C06
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x03140A08
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|,
literal|0x00333333
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
literal|0x202C2820
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
literal|0x88888815
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL0
argument_list|,
literal|0x11100014
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
literal|0x040c0c06
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
literal|0x03000a08
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL3
argument_list|,
literal|0x00000000
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL4
argument_list|,
literal|0x200005c0
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL5
argument_list|,
literal|0x88888815
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
name|pmuctrl
operator|=
name|BHND_PMU_CTRL_PLL_PLLCTL_UPD
expr_stmt|;
break|break;
default|default:
name|PMU_LOG
argument_list|(
name|sc
argument_list|,
literal|"%s: unknown spuravoidance settings for chip %#hx, "
literal|"not changing PLL"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|cid
operator|.
name|chip_id
argument_list|)
expr_stmt|;
name|pmuctrl
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|pmuctrl
operator|!=
literal|0
condition|)
name|BHND_PMU_OR_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_CTRL
argument_list|,
name|pmuctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|bool
name|bhnd_pmu_is_otp_powered
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|otp_res
decl_stmt|;
comment|/* Determine per-chip OTP resource */
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4329
case|:
name|otp_res
operator|=
name|PMURES_BIT
argument_list|(
name|RES4329_OTP_PU
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4319
case|:
name|otp_res
operator|=
name|PMURES_BIT
argument_list|(
name|RES4319_OTP_PU
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4336
case|:
name|otp_res
operator|=
name|PMURES_BIT
argument_list|(
name|RES4336_OTP_PU
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4330
case|:
name|otp_res
operator|=
name|PMURES_BIT
argument_list|(
name|RES4330_OTP_PU
argument_list|)
expr_stmt|;
break|break;
comment|/* These chips don't use PMU bit to power up/down OTP. OTP always on. 	 * Use OTP_INIT command to reset/refresh state. 	 */
case|case
name|BHND_CHIPID_BCM43224
case|:
case|case
name|BHND_CHIPID_BCM43225
case|:
case|case
name|BHND_CHIPID_BCM43421
case|:
case|case
name|BHND_CHIPID_BCM43236
case|:
case|case
name|BHND_CHIPID_BCM43235
case|:
case|case
name|BHND_CHIPID_BCM43238
case|:
return|return
operator|(
name|true
operator|)
return|;
default|default:
return|return
operator|(
name|true
operator|)
return|;
block|}
comment|/* Check resource state */
if|if
condition|(
operator|(
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_RES_STATE
argument_list|)
operator|&
name|otp_res
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|false
operator|)
return|;
return|return
operator|(
name|true
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bhnd_pmu_paref_ldo_enable
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|uint32_t
name|ldo
decl_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4328
case|:
name|ldo
operator|=
name|PMURES_BIT
argument_list|(
name|RES4328_PA_REF_LDO
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM5354
case|:
name|ldo
operator|=
name|PMURES_BIT
argument_list|(
name|RES5354_PA_REF_LDO
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4312
case|:
name|ldo
operator|=
name|PMURES_BIT
argument_list|(
name|RES4312_PA_REF_LDO
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return;
block|}
if|if
condition|(
name|enable
condition|)
block|{
name|BHND_PMU_OR_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
name|ldo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
name|ldo
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* initialize PMU switch/regulators */
end_comment

begin_function
name|void
name|bhnd_pmu_swreg_init
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|chipst
decl_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4325
case|:
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|<=
literal|2
condition|)
break|break;
name|chipst
operator|=
name|BHND_CHIPC_READ_CHIPST
argument_list|(
name|sc
operator|->
name|chipc_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|BHND_PMU_GET_BITS
argument_list|(
name|chipst
argument_list|,
name|CHIPC_CST4325_PMUTOP_2B
argument_list|)
condition|)
block|{
name|bhnd_pmu_set_ldo_voltage
argument_list|(
name|sc
argument_list|,
name|SET_LDO_VOLTAGE_CLDO_PWM
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
name|bhnd_pmu_set_ldo_voltage
argument_list|(
name|sc
argument_list|,
name|SET_LDO_VOLTAGE_CLDO_BURST
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
block|}
name|bhnd_pmu_set_ldo_voltage
argument_list|(
name|sc
argument_list|,
name|SET_LDO_VOLTAGE_CBUCK_PWM
argument_list|,
literal|0xb
argument_list|)
expr_stmt|;
name|bhnd_pmu_set_ldo_voltage
argument_list|(
name|sc
argument_list|,
name|SET_LDO_VOLTAGE_CBUCK_BURST
argument_list|,
literal|0xb
argument_list|)
expr_stmt|;
name|bhnd_pmu_set_ldo_voltage
argument_list|(
name|sc
argument_list|,
name|SET_LDO_VOLTAGE_LNLDO1
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|board
operator|.
name|board_flags
operator|&
name|BHND_BFL_LNLDO2_2P5
condition|)
block|{
name|bhnd_pmu_set_ldo_voltage
argument_list|(
name|sc
argument_list|,
name|SET_LDO_VOLTAGE_LNLDO2_SEL
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BHND_CHIPID_BCM4336
case|:
comment|/* Reduce CLDO PWM output voltage to 1.2V */
name|bhnd_pmu_set_ldo_voltage
argument_list|(
name|sc
argument_list|,
name|SET_LDO_VOLTAGE_CLDO_PWM
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
comment|/* Reduce CLDO BURST output voltage to 1.2V */
name|bhnd_pmu_set_ldo_voltage
argument_list|(
name|sc
argument_list|,
name|SET_LDO_VOLTAGE_CLDO_BURST
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
comment|/* Reduce LNLDO1 output voltage to 1.2V */
name|bhnd_pmu_set_ldo_voltage
argument_list|(
name|sc
argument_list|,
name|SET_LDO_VOLTAGE_LNLDO1
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_rev
operator|==
literal|0
condition|)
name|BHND_PMU_REGCTRL_WRITE
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|,
literal|0x400000
argument_list|,
literal|0x400000
argument_list|)
expr_stmt|;
break|break;
case|case
name|BHND_CHIPID_BCM4330
case|:
comment|/* CBUCK Voltage is 1.8 by default and set that to 1.5 */
name|bhnd_pmu_set_ldo_voltage
argument_list|(
name|sc
argument_list|,
name|SET_LDO_VOLTAGE_CBUCK_PWM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|int
name|bhnd_pmu_radio_enable
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|device_t
name|d11core
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|uint32_t
name|oobsel
decl_stmt|;
name|uint32_t
name|rsrcs
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|bhnd_get_device
argument_list|(
name|d11core
argument_list|)
operator|!=
name|BHND_COREID_D11
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"bhnd_pmu_radio_enable() called on non-D11 core"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
switch|switch
condition|(
name|sc
operator|->
name|cid
operator|.
name|chip_id
condition|)
block|{
case|case
name|BHND_CHIPID_BCM4325
case|:
if|if
condition|(
name|sc
operator|->
name|board
operator|.
name|board_flags
operator|&
name|BHND_BFL_FASTPWR
condition|)
break|break;
if|if
condition|(
operator|(
name|sc
operator|->
name|board
operator|.
name|board_flags
operator|&
name|BHND_BFL_BUCKBOOST
operator|)
operator|==
literal|0
condition|)
break|break;
name|rsrcs
operator|=
name|PMURES_BIT
argument_list|(
name|RES4325_BUCK_BOOST_BURST
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
block|{
name|BHND_PMU_OR_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
name|rsrcs
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/* 100ms */
block|}
else|else
block|{
name|BHND_PMU_AND_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_MIN_RES_MASK
argument_list|,
operator|~
name|rsrcs
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|BHND_CHIPID_BCM4319
case|:
name|error
operator|=
name|bhnd_read_config
argument_list|(
name|d11core
argument_list|,
name|BCMA_DMP_OOBSELOUTB74
argument_list|,
operator|&
name|oobsel
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|enable
condition|)
block|{
name|oobsel
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|BCMA_DMP_OOBSEL_EN
argument_list|,
name|BCMA_DMP_OOBSEL_5
argument_list|)
expr_stmt|;
name|oobsel
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|BCMA_DMP_OOBSEL_EN
argument_list|,
name|BCMA_DMP_OOBSEL_6
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|oobsel
operator|&=
operator|~
name|BHND_PMU_SET_BITS
argument_list|(
name|BCMA_DMP_OOBSEL_EN
argument_list|,
name|BCMA_DMP_OOBSEL_5
argument_list|)
expr_stmt|;
name|oobsel
operator|&=
operator|~
name|BHND_PMU_SET_BITS
argument_list|(
name|BCMA_DMP_OOBSEL_EN
argument_list|,
name|BCMA_DMP_OOBSEL_6
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|bhnd_write_config
argument_list|(
name|d11core
argument_list|,
name|BCMA_DMP_OOBSELOUTB74
argument_list|,
operator|&
name|oobsel
argument_list|,
literal|4
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Wait for a particular clock level to be on the backplane */
end_comment

begin_function
name|uint32_t
name|bhnd_pmu_waitforclk_on_backplane
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|clk
parameter_list|,
name|uint32_t
name|delay
parameter_list|)
block|{
name|uint32_t
name|pmu_st
decl_stmt|;
for|for
control|(
name|uint32_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|delay
condition|;
name|i
operator|+=
literal|10
control|)
block|{
name|pmu_st
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_ST
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pmu_st
operator|&
name|clk
operator|)
operator|==
name|clk
condition|)
return|return
operator|(
name|clk
operator|)
return|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|pmu_st
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_ST
argument_list|)
expr_stmt|;
return|return
operator|(
name|pmu_st
operator|&
name|clk
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Measures the ALP clock frequency in KHz.  Returns 0 if not possible.  * Possible only if PMU rev>= 10 and there is an external LPO 32768Hz crystal.  */
end_comment

begin_define
define|#
directive|define
name|EXT_ILP_HZ
value|32768
end_define

begin_function
name|uint32_t
name|bhnd_pmu_measure_alpclk
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|alp_khz
decl_stmt|;
name|uint32_t
name|pmu_st
decl_stmt|;
if|if
condition|(
name|BHND_PMU_REV
argument_list|(
name|sc
argument_list|)
operator|<
literal|10
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|pmu_st
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_ST
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmu_st
operator|&
name|BHND_PMU_ST_EXTLPOAVAIL
condition|)
block|{
name|uint32_t
name|alp_hz
decl_stmt|,
name|ilp_ctr
decl_stmt|;
comment|/* Enable frequency measurement */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_XTALFREQ
argument_list|,
literal|1U
operator|<<
name|BHND_PMU_XTALFREQ_REG_MEASURE_SHIFT
argument_list|)
expr_stmt|;
comment|/* Delay for well over 4 ILP clocks */
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* Read the latched number of ALP ticks per 4 ILP ticks */
name|ilp_ctr
operator|=
name|BHND_PMU_READ_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_XTALFREQ
argument_list|)
expr_stmt|;
name|ilp_ctr
operator|=
name|BHND_PMU_GET_BITS
argument_list|(
name|ilp_ctr
argument_list|,
name|BHND_PMU_XTALFREQ_REG_ILPCTR
argument_list|)
expr_stmt|;
comment|/* Turn off PMU_XTALFREQ_REG_MEASURE to save power */
name|BHND_PMU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|BHND_PMU_XTALFREQ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Calculate ALP frequency */
name|alp_hz
operator|=
operator|(
name|ilp_ctr
operator|*
name|EXT_ILP_HZ
operator|)
operator|/
literal|4
expr_stmt|;
comment|/* Round to nearest 100KHz and convert to KHz */
name|alp_khz
operator|=
operator|(
name|alp_hz
operator|+
literal|50000
operator|)
operator|/
literal|100000
operator|*
literal|100
expr_stmt|;
block|}
else|else
block|{
name|alp_khz
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|alp_khz
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bhnd_pmu_set_4330_plldivs
parameter_list|(
name|struct
name|bhnd_pmu_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|FVCO
init|=
name|bhnd_pmu1_pllfvco0
argument_list|(
operator|&
name|sc
operator|->
name|query
argument_list|)
operator|/
literal|1000
decl_stmt|;
name|uint32_t
name|m1div
decl_stmt|,
name|m2div
decl_stmt|,
name|m3div
decl_stmt|,
name|m4div
decl_stmt|,
name|m5div
decl_stmt|,
name|m6div
decl_stmt|;
name|uint32_t
name|pllc1
decl_stmt|,
name|pllc2
decl_stmt|;
name|m2div
operator|=
name|m3div
operator|=
name|m4div
operator|=
name|m6div
operator|=
name|FVCO
operator|/
literal|80
expr_stmt|;
name|m5div
operator|=
name|FVCO
operator|/
literal|160
expr_stmt|;
if|if
condition|(
name|PMU_CST4330_SDIOD_CHIPMODE
argument_list|(
name|sc
argument_list|)
condition|)
name|m1div
operator|=
name|FVCO
operator|/
literal|80
expr_stmt|;
else|else
name|m1div
operator|=
name|FVCO
operator|/
literal|90
expr_stmt|;
name|pllc1
operator|=
literal|0
expr_stmt|;
name|pllc1
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|m1div
argument_list|,
name|BHND_PMU1_PLL0_PC1_M1DIV
argument_list|)
expr_stmt|;
name|pllc1
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|m2div
argument_list|,
name|BHND_PMU1_PLL0_PC1_M2DIV
argument_list|)
expr_stmt|;
name|pllc1
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|m3div
argument_list|,
name|BHND_PMU1_PLL0_PC1_M3DIV
argument_list|)
expr_stmt|;
name|pllc1
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|m4div
argument_list|,
name|BHND_PMU1_PLL0_PC1_M4DIV
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL1
argument_list|,
name|pllc1
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|pllc2
operator|=
literal|0
expr_stmt|;
name|pllc2
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|m5div
argument_list|,
name|BHND_PMU1_PLL0_PC2_M5DIV
argument_list|)
expr_stmt|;
name|pllc2
operator||=
name|BHND_PMU_SET_BITS
argument_list|(
name|m6div
argument_list|,
name|BHND_PMU1_PLL0_PC2_M6DIV
argument_list|)
expr_stmt|;
name|BHND_PMU_PLL_WRITE
argument_list|(
name|sc
argument_list|,
name|BHND_PMU1_PLL0_PLLCTL2
argument_list|,
name|pllc2
argument_list|,
name|BHND_PMU1_PLL0_PC2_M5DIV_MASK
operator||
name|BHND_PMU1_PLL0_PC2_M6DIV_MASK
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Justin Hibbits  * Copyright (c) 2005, Joseph Koshy  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/pmc.h>
end_include

begin_include
include|#
directive|include
file|<sys/pmckern.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<machine/pmc_mdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<ddb/ddb.h>
end_include

begin_include
include|#
directive|include
file|"hwpmc_powerpc.h"
end_include

begin_define
define|#
directive|define
name|POWERPC_PMC_CAPS
value|(PMC_CAP_INTERRUPT | PMC_CAP_USER |     \ 				 PMC_CAP_SYSTEM | PMC_CAP_EDGE |	\ 				 PMC_CAP_THRESHOLD | PMC_CAP_READ |	\ 				 PMC_CAP_WRITE | PMC_CAP_INVERT |	\ 				 PMC_CAP_QUALIFIER)
end_define

begin_define
define|#
directive|define
name|E500_PMC_HAS_OVERFLOWED
parameter_list|(
name|x
parameter_list|)
value|(e500_pmcn_read(x)& (0x1<< 31))
end_define

begin_struct
struct|struct
name|e500_event_code_map
block|{
name|enum
name|pmc_event
name|pe_ev
decl_stmt|;
comment|/* enum value */
name|uint8_t
name|pe_counter_mask
decl_stmt|;
comment|/* Which counter this can be counted in. */
name|uint8_t
name|pe_code
decl_stmt|;
comment|/* numeric code */
name|uint8_t
name|pe_cpu
decl_stmt|;
comment|/* e500 core (v1,v2,mc), mask */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|E500_MAX_PMCS
value|4
end_define

begin_define
define|#
directive|define
name|PMC_PPC_MASK0
value|0
end_define

begin_define
define|#
directive|define
name|PMC_PPC_MASK1
value|1
end_define

begin_define
define|#
directive|define
name|PMC_PPC_MASK2
value|2
end_define

begin_define
define|#
directive|define
name|PMC_PPC_MASK3
value|3
end_define

begin_define
define|#
directive|define
name|PMC_PPC_MASK_ALL
value|0x0f
end_define

begin_define
define|#
directive|define
name|PMC_PPC_E500V1
value|1
end_define

begin_define
define|#
directive|define
name|PMC_PPC_E500V2
value|2
end_define

begin_define
define|#
directive|define
name|PMC_PPC_E500MC
value|4
end_define

begin_define
define|#
directive|define
name|PMC_PPC_E500_ANY
value|7
end_define

begin_define
define|#
directive|define
name|PMC_E500_EVENT
parameter_list|(
name|id
parameter_list|,
name|mask
parameter_list|,
name|number
parameter_list|,
name|core
parameter_list|)
define|\
value|[PMC_EV_E500_##id - PMC_EV_E500_FIRST] = \ 	    { .pe_ev = PMC_EV_E500_##id, .pe_counter_mask = mask, \ 	      .pe_code = number, .pe_cpu = core }
end_define

begin_define
define|#
directive|define
name|PMC_E500MC_ONLY
parameter_list|(
name|id
parameter_list|,
name|number
parameter_list|)
define|\
value|PMC_E500_EVENT(id, PMC_PPC_MASK_ALL, number, PMC_PPC_E500MC)
end_define

begin_define
define|#
directive|define
name|PMC_E500_COMMON
parameter_list|(
name|id
parameter_list|,
name|number
parameter_list|)
define|\
value|PMC_E500_EVENT(id, PMC_PPC_MASK_ALL, number, PMC_PPC_E500_ANY)
end_define

begin_decl_stmt
specifier|static
name|struct
name|e500_event_code_map
name|e500_event_codes
index|[]
init|=
block|{
name|PMC_E500_COMMON
argument_list|(
name|CYCLES
argument_list|,
literal|1
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|INSTR_COMPLETED
argument_list|,
literal|2
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|UOPS_COMPLETED
argument_list|,
literal|3
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|INSTR_FETCHED
argument_list|,
literal|4
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|UOPS_DECODED
argument_list|,
literal|5
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|PM_EVENT_TRANSITIONS
argument_list|,
literal|6
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|PM_EVENT_CYCLES
argument_list|,
literal|7
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|BRANCH_INSTRS_COMPLETED
argument_list|,
literal|8
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|LOAD_UOPS_COMPLETED
argument_list|,
literal|9
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|STORE_UOPS_COMPLETED
argument_list|,
literal|10
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CQ_REDIRECTS
argument_list|,
literal|11
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|BRANCHES_FINISHED
argument_list|,
literal|12
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|TAKEN_BRANCHES_FINISHED
argument_list|,
literal|13
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|FINISHED_UNCOND_BRANCHES_MISS_BTB
argument_list|,
literal|14
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|BRANCH_MISPRED
argument_list|,
literal|15
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|BTB_BRANCH_MISPRED_FROM_DIRECTION
argument_list|,
literal|16
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|BTB_HITS_PSEUDO_HITS
argument_list|,
literal|17
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CYCLES_DECODE_STALLED
argument_list|,
literal|18
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CYCLES_ISSUE_STALLED
argument_list|,
literal|19
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CYCLES_BRANCH_ISSUE_STALLED
argument_list|,
literal|20
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CYCLES_SU1_SCHED_STALLED
argument_list|,
literal|21
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CYCLES_SU2_SCHED_STALLED
argument_list|,
literal|22
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CYCLES_MU_SCHED_STALLED
argument_list|,
literal|23
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CYCLES_LRU_SCHED_STALLED
argument_list|,
literal|24
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CYCLES_BU_SCHED_STALLED
argument_list|,
literal|25
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|TOTAL_TRANSLATED
argument_list|,
literal|26
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|LOADS_TRANSLATED
argument_list|,
literal|27
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|STORES_TRANSLATED
argument_list|,
literal|28
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|TOUCHES_TRANSLATED
argument_list|,
literal|29
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CACHEOPS_TRANSLATED
argument_list|,
literal|30
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CACHE_INHIBITED_ACCESS_TRANSLATED
argument_list|,
literal|31
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|GUARDED_LOADS_TRANSLATED
argument_list|,
literal|32
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|WRITE_THROUGH_STORES_TRANSLATED
argument_list|,
literal|33
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|MISALIGNED_LOAD_STORE_ACCESS_TRANSLATED
argument_list|,
literal|34
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|TOTAL_ALLOCATED_TO_DLFB
argument_list|,
literal|35
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|LOADS_TRANSLATED_ALLOCATED_TO_DLFB
argument_list|,
literal|36
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|STORES_COMPLETED_ALLOCATED_TO_DLFB
argument_list|,
literal|37
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|TOUCHES_TRANSLATED_ALLOCATED_TO_DLFB
argument_list|,
literal|38
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|STORES_COMPLETED
argument_list|,
literal|39
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|DATA_L1_CACHE_LOCKS
argument_list|,
literal|40
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|DATA_L1_CACHE_RELOADS
argument_list|,
literal|41
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|DATA_L1_CACHE_CASTOUTS
argument_list|,
literal|42
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|LOAD_MISS_DLFB_FULL
argument_list|,
literal|43
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|LOAD_MISS_LDQ_FULL
argument_list|,
literal|44
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|LOAD_GUARDED_MISS
argument_list|,
literal|45
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|STORE_TRANSLATE_WHEN_QUEUE_FULL
argument_list|,
literal|46
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|ADDRESS_COLLISION
argument_list|,
literal|47
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|DATA_MMU_MISS
argument_list|,
literal|48
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|DATA_MMU_BUSY
argument_list|,
literal|49
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|PART2_MISALIGNED_CACHE_ACCESS
argument_list|,
literal|50
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|LOAD_MISS_DLFB_FULL_CYCLES
argument_list|,
literal|51
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|LOAD_MISS_LDQ_FULL_CYCLES
argument_list|,
literal|52
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|LOAD_GUARDED_MISS_CYCLES
argument_list|,
literal|53
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|STORE_TRANSLATE_WHEN_QUEUE_FULL_CYCLES
argument_list|,
literal|54
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|ADDRESS_COLLISION_CYCLES
argument_list|,
literal|55
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|DATA_MMU_MISS_CYCLES
argument_list|,
literal|56
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|DATA_MMU_BUSY_CYCLES
argument_list|,
literal|57
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|PART2_MISALIGNED_CACHE_ACCESS_CYCLES
argument_list|,
literal|58
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|INSTR_L1_CACHE_LOCKS
argument_list|,
literal|59
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|INSTR_L1_CACHE_RELOADS
argument_list|,
literal|60
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|INSTR_L1_CACHE_FETCHES
argument_list|,
literal|61
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|INSTR_MMU_TLB4K_RELOADS
argument_list|,
literal|62
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|INSTR_MMU_VSP_RELOADS
argument_list|,
literal|63
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|DATA_MMU_TLB4K_RELOADS
argument_list|,
literal|64
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|DATA_MMU_VSP_RELOADS
argument_list|,
literal|65
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|L2MMU_MISSES
argument_list|,
literal|66
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|BIU_MASTER_REQUESTS
argument_list|,
literal|67
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|BIU_MASTER_INSTR_SIDE_REQUESTS
argument_list|,
literal|68
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|BIU_MASTER_DATA_SIDE_REQUESTS
argument_list|,
literal|69
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|BIU_MASTER_DATA_SIDE_CASTOUT_REQUESTS
argument_list|,
literal|70
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|BIU_MASTER_RETRIES
argument_list|,
literal|71
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|SNOOP_REQUESTS
argument_list|,
literal|72
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|SNOOP_HITS
argument_list|,
literal|73
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|SNOOP_PUSHES
argument_list|,
literal|74
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|SNOOP_RETRIES
argument_list|,
literal|75
argument_list|)
block|,
name|PMC_E500_EVENT
argument_list|(
name|DLFB_LOAD_MISS_CYCLES
argument_list|,
name|PMC_PPC_MASK0
operator||
name|PMC_PPC_MASK1
argument_list|,
literal|76
argument_list|,
name|PMC_PPC_E500_ANY
argument_list|)
block|,
name|PMC_E500_EVENT
argument_list|(
name|ILFB_FETCH_MISS_CYCLES
argument_list|,
name|PMC_PPC_MASK0
operator||
name|PMC_PPC_MASK1
argument_list|,
literal|77
argument_list|,
name|PMC_PPC_E500_ANY
argument_list|)
block|,
name|PMC_E500_EVENT
argument_list|(
name|EXT_INPU_INTR_LATENCY_CYCLES
argument_list|,
name|PMC_PPC_MASK0
operator||
name|PMC_PPC_MASK1
argument_list|,
literal|78
argument_list|,
name|PMC_PPC_E500_ANY
argument_list|)
block|,
name|PMC_E500_EVENT
argument_list|(
name|CRIT_INPUT_INTR_LATENCY_CYCLES
argument_list|,
name|PMC_PPC_MASK0
operator||
name|PMC_PPC_MASK1
argument_list|,
literal|79
argument_list|,
name|PMC_PPC_E500_ANY
argument_list|)
block|,
name|PMC_E500_EVENT
argument_list|(
name|EXT_INPUT_INTR_PENDING_LATENCY_CYCLES
argument_list|,
name|PMC_PPC_MASK0
operator||
name|PMC_PPC_MASK1
argument_list|,
literal|80
argument_list|,
name|PMC_PPC_E500_ANY
argument_list|)
block|,
name|PMC_E500_EVENT
argument_list|(
name|CRIT_INPUT_INTR_PENDING_LATENCY_CYCLES
argument_list|,
name|PMC_PPC_MASK0
operator||
name|PMC_PPC_MASK1
argument_list|,
literal|81
argument_list|,
name|PMC_PPC_E500_ANY
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|PMC0_OVERFLOW
argument_list|,
literal|82
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|PMC1_OVERFLOW
argument_list|,
literal|83
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|PMC2_OVERFLOW
argument_list|,
literal|84
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|PMC3_OVERFLOW
argument_list|,
literal|85
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|INTERRUPTS_TAKEN
argument_list|,
literal|86
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|EXT_INPUT_INTR_TAKEN
argument_list|,
literal|87
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|CRIT_INPUT_INTR_TAKEN
argument_list|,
literal|88
argument_list|)
block|,
name|PMC_E500_COMMON
argument_list|(
name|SYSCALL_TRAP_INTR
argument_list|,
literal|89
argument_list|)
block|,
name|PMC_E500_EVENT
argument_list|(
name|TLB_BIT_TRANSITIONS
argument_list|,
name|PMC_PPC_MASK_ALL
argument_list|,
literal|90
argument_list|,
name|PMC_PPC_E500V2
operator||
name|PMC_PPC_E500MC
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_LINEFILL_BUFFER
argument_list|,
literal|91
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|LV2_VS
argument_list|,
literal|92
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|CASTOUTS_RELEASED
argument_list|,
literal|93
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|INTV_ALLOCATIONS
argument_list|,
literal|94
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DLFB_RETRIES_TO_MBAR
argument_list|,
literal|95
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STORE_RETRIES
argument_list|,
literal|96
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STASH_L1_HITS
argument_list|,
literal|97
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STASH_L2_HITS
argument_list|,
literal|98
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STASH_BUSY_1
argument_list|,
literal|99
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STASH_BUSY_2
argument_list|,
literal|100
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STASH_BUSY_3
argument_list|,
literal|101
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STASH_HITS
argument_list|,
literal|102
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STASH_HIT_DLFB
argument_list|,
literal|103
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STASH_REQUESTS
argument_list|,
literal|106
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STASH_REQUESTS_L1
argument_list|,
literal|107
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STASH_REQUESTS_L2
argument_list|,
literal|108
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STALLS_NO_CAQ_OR_COB
argument_list|,
literal|109
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_ACCESSES
argument_list|,
literal|110
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_HIT_CACHE_ACCESSES
argument_list|,
literal|111
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_DATA_ACCESSES
argument_list|,
literal|112
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_DATA_HITS
argument_list|,
literal|113
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_INSTR_ACCESSES
argument_list|,
literal|114
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_INSTR_HITS
argument_list|,
literal|115
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_ALLOCATIONS
argument_list|,
literal|116
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_DATA_ALLOCATIONS
argument_list|,
literal|117
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_DIRTY_DATA_ALLOCATIONS
argument_list|,
literal|118
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_INSTR_ALLOCATIONS
argument_list|,
literal|119
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_UPDATES
argument_list|,
literal|120
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_CLEAN_UPDATES
argument_list|,
literal|121
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_DIRTY_UPDATES
argument_list|,
literal|122
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_CLEAN_REDUNDANT_UPDATES
argument_list|,
literal|123
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_DIRTY_REDUNDANT_UPDATES
argument_list|,
literal|124
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_LOCKS
argument_list|,
literal|125
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_CASTOUTS
argument_list|,
literal|126
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CACHE_DATA_DIRTY_HITS
argument_list|,
literal|127
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|INSTR_LFB_WENT_HIGH_PRIORITY
argument_list|,
literal|128
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|SNOOP_THROTTLING_TURNED_ON
argument_list|,
literal|129
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_CLEAN_LINE_INVALIDATIONS
argument_list|,
literal|130
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_INCOHERENT_LINE_INVALIDATIONS
argument_list|,
literal|131
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|L2_COHERENT_LINE_INVALIDATIONS
argument_list|,
literal|132
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|COHERENT_LOOKUP_MISS_DUE_TO_VALID_BUT_INCOHERENT_MATCHES
argument_list|,
literal|133
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|IAC1S_DETECTED
argument_list|,
literal|140
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|IAC2S_DETECTED
argument_list|,
literal|141
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DAC1S_DTECTED
argument_list|,
literal|144
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DAC2S_DTECTED
argument_list|,
literal|145
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DVT0_DETECTED
argument_list|,
literal|148
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DVT1_DETECTED
argument_list|,
literal|149
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DVT2_DETECTED
argument_list|,
literal|150
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DVT3_DETECTED
argument_list|,
literal|151
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DVT4_DETECTED
argument_list|,
literal|152
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DVT5_DETECTED
argument_list|,
literal|153
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DVT6_DETECTED
argument_list|,
literal|154
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DVT7_DETECTED
argument_list|,
literal|155
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|CYCLES_COMPLETION_STALLED_NEXUS_FIFO_FULL
argument_list|,
literal|156
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|FPU_DOUBLE_PUMP
argument_list|,
literal|160
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|FPU_FINISH
argument_list|,
literal|161
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|FPU_DIVIDE_CYCLES
argument_list|,
literal|162
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|FPU_DENORM_INPUT_CYCLES
argument_list|,
literal|163
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|FPU_RESULT_STALL_CYCLES
argument_list|,
literal|164
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|FPU_FPSCR_FULL_STALL
argument_list|,
literal|165
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|FPU_PIPE_SYNC_STALLS
argument_list|,
literal|166
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|FPU_INPUT_DATA_STALLS
argument_list|,
literal|167
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DECORATED_LOADS
argument_list|,
literal|176
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|DECORATED_STORES
argument_list|,
literal|177
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|LOAD_RETRIES
argument_list|,
literal|178
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STWCX_SUCCESSES
argument_list|,
literal|179
argument_list|)
block|,
name|PMC_E500MC_ONLY
argument_list|(
name|STWCX_FAILURES
argument_list|,
literal|180
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|size_t
name|e500_event_codes_size
init|=
sizeof|sizeof
argument_list|(
name|e500_event_codes
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|e500_event_codes
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|pmc_value_t
name|e500_pmcn_read
parameter_list|(
name|unsigned
name|int
name|pmc
parameter_list|)
block|{
switch|switch
condition|(
name|pmc
condition|)
block|{
case|case
literal|0
case|:
return|return
name|mfpmr
argument_list|(
name|PMR_PMC0
argument_list|)
return|;
break|break;
case|case
literal|1
case|:
return|return
name|mfpmr
argument_list|(
name|PMR_PMC1
argument_list|)
return|;
break|break;
case|case
literal|2
case|:
return|return
name|mfpmr
argument_list|(
name|PMR_PMC2
argument_list|)
return|;
break|break;
case|case
literal|3
case|:
return|return
name|mfpmr
argument_list|(
name|PMR_PMC3
argument_list|)
return|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Invalid PMC number: %d\n"
argument_list|,
name|pmc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|e500_pmcn_write
parameter_list|(
name|unsigned
name|int
name|pmc
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
switch|switch
condition|(
name|pmc
condition|)
block|{
case|case
literal|0
case|:
name|mtpmr
argument_list|(
name|PMR_PMC0
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|mtpmr
argument_list|(
name|PMR_PMC1
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|mtpmr
argument_list|(
name|PMR_PMC2
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|mtpmr
argument_list|(
name|PMR_PMC3
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Invalid PMC number: %d\n"
argument_list|,
name|pmc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|e500_read_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|pmc_value_t
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|pmc_value_t
name|tmp
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|E500_MAX_PMCS
argument_list|,
operator|(
literal|"[powerpc,%d] illegal row index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|pm
operator|=
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
operator|.
name|phw_pmc
expr_stmt|;
name|KASSERT
argument_list|(
name|pm
argument_list|,
operator|(
literal|"[core,%d] cpu %d ri %d pmc not configured"
operator|,
name|__LINE__
operator|,
name|cpu
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|e500_pmcn_read
argument_list|(
name|ri
argument_list|)
expr_stmt|;
name|PMCDBG2
argument_list|(
name|MDP
argument_list|,
name|REA
argument_list|,
literal|2
argument_list|,
literal|"ppc-read id=%d -> %jd"
argument_list|,
name|ri
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|PMC_IS_SAMPLING_MODE
argument_list|(
name|PMC_TO_MODE
argument_list|(
name|pm
argument_list|)
argument_list|)
condition|)
operator|*
name|v
operator|=
name|POWERPC_PERFCTR_VALUE_TO_RELOAD_COUNT
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
else|else
operator|*
name|v
operator|=
name|tmp
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e500_write_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|pmc_value_t
name|v
parameter_list|)
block|{
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|E500_MAX_PMCS
argument_list|,
operator|(
literal|"[powerpc,%d] illegal row-index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|pm
operator|=
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
operator|.
name|phw_pmc
expr_stmt|;
if|if
condition|(
name|PMC_IS_SAMPLING_MODE
argument_list|(
name|PMC_TO_MODE
argument_list|(
name|pm
argument_list|)
argument_list|)
condition|)
name|v
operator|=
name|POWERPC_RELOAD_COUNT_TO_PERFCTR_VALUE
argument_list|(
name|v
argument_list|)
expr_stmt|;
name|PMCDBG3
argument_list|(
name|MDP
argument_list|,
name|WRI
argument_list|,
literal|1
argument_list|,
literal|"powerpc-write cpu=%d ri=%d v=%jx"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|e500_pmcn_write
argument_list|(
name|ri
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e500_config_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc
modifier|*
name|pm
parameter_list|)
block|{
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|PMCDBG3
argument_list|(
name|MDP
argument_list|,
name|CFG
argument_list|,
literal|1
argument_list|,
literal|"cpu=%d ri=%d pm=%p"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|,
name|pm
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|E500_MAX_PMCS
argument_list|,
operator|(
literal|"[powerpc,%d] illegal row-index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|phw
operator|=
operator|&
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|pm
operator|==
name|NULL
operator|||
name|phw
operator|->
name|phw_pmc
operator|==
name|NULL
argument_list|,
operator|(
literal|"[powerpc,%d] pm=%p phw->pm=%p hwpmc not unconfigured"
operator|,
name|__LINE__
operator|,
name|pm
operator|,
name|phw
operator|->
name|phw_pmc
operator|)
argument_list|)
expr_stmt|;
name|phw
operator|->
name|phw_pmc
operator|=
name|pm
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e500_start_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|)
block|{
name|uint32_t
name|config
decl_stmt|;
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|phw
operator|=
operator|&
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
expr_stmt|;
name|pm
operator|=
name|phw
operator|->
name|phw_pmc
expr_stmt|;
name|config
operator|=
name|pm
operator|->
name|pm_md
operator|.
name|pm_powerpc
operator|.
name|pm_powerpc_evsel
expr_stmt|;
if|if
condition|(
name|PMC_IS_SAMPLING_MODE
argument_list|(
name|PMC_TO_MODE
argument_list|(
name|pm
argument_list|)
argument_list|)
condition|)
name|config
operator||=
name|PMLCax_CE
expr_stmt|;
comment|/* Enable the PMC. */
switch|switch
condition|(
name|ri
condition|)
block|{
case|case
literal|0
case|:
name|mtpmr
argument_list|(
name|PMR_PMLCa0
argument_list|,
name|config
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|mtpmr
argument_list|(
name|PMR_PMLCa1
argument_list|,
name|config
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|mtpmr
argument_list|(
name|PMR_PMLCa2
argument_list|,
name|config
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|mtpmr
argument_list|(
name|PMR_PMLCa3
argument_list|,
name|config
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e500_stop_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|)
block|{
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|register_t
name|pmc_pmlc
decl_stmt|;
name|phw
operator|=
operator|&
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
expr_stmt|;
name|pm
operator|=
name|phw
operator|->
name|phw_pmc
expr_stmt|;
comment|/* 	 * Disable the PMCs. 	 */
switch|switch
condition|(
name|ri
condition|)
block|{
case|case
literal|0
case|:
name|pmc_pmlc
operator|=
name|mfpmr
argument_list|(
name|PMR_PMLCa0
argument_list|)
expr_stmt|;
name|pmc_pmlc
operator||=
name|PMLCax_FC
expr_stmt|;
name|mtpmr
argument_list|(
name|PMR_PMLCa0
argument_list|,
name|pmc_pmlc
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|pmc_pmlc
operator|=
name|mfpmr
argument_list|(
name|PMR_PMLCa1
argument_list|)
expr_stmt|;
name|pmc_pmlc
operator||=
name|PMLCax_FC
expr_stmt|;
name|mtpmr
argument_list|(
name|PMR_PMLCa1
argument_list|,
name|pmc_pmlc
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|pmc_pmlc
operator|=
name|mfpmr
argument_list|(
name|PMR_PMLCa2
argument_list|)
expr_stmt|;
name|pmc_pmlc
operator||=
name|PMLCax_FC
expr_stmt|;
name|mtpmr
argument_list|(
name|PMR_PMLCa2
argument_list|,
name|pmc_pmlc
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|pmc_pmlc
operator|=
name|mfpmr
argument_list|(
name|PMR_PMLCa3
argument_list|)
expr_stmt|;
name|pmc_pmlc
operator||=
name|PMLCax_FC
expr_stmt|;
name|mtpmr
argument_list|(
name|PMR_PMLCa3
argument_list|,
name|pmc_pmlc
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e500_pcpu_init
parameter_list|(
name|struct
name|pmc_mdep
modifier|*
name|md
parameter_list|,
name|int
name|cpu
parameter_list|)
block|{
name|int
name|first_ri
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|pmc_cpu
modifier|*
name|pc
decl_stmt|;
name|struct
name|powerpc_cpu
modifier|*
name|pac
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] wrong cpu number %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|PMCDBG1
argument_list|(
name|MDP
argument_list|,
name|INI
argument_list|,
literal|1
argument_list|,
literal|"powerpc-init cpu=%d"
argument_list|,
name|cpu
argument_list|)
expr_stmt|;
comment|/* Freeze all counters. */
name|mtpmr
argument_list|(
name|PMR_PMGC0
argument_list|,
name|PMGC_FAC
operator||
name|PMGC_PMIE
operator||
name|PMGC_FCECE
argument_list|)
expr_stmt|;
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|=
name|pac
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|powerpc_cpu
argument_list|)
argument_list|,
name|M_PMC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pac
operator|->
name|pc_ppcpmcs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|pmc_hw
argument_list|)
operator|*
name|E500_MAX_PMCS
argument_list|,
name|M_PMC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pac
operator|->
name|pc_class
operator|=
name|PMC_CLASS_E500
expr_stmt|;
name|pc
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
expr_stmt|;
name|first_ri
operator|=
name|md
operator|->
name|pmd_classdep
index|[
name|PMC_MDEP_CLASS_INDEX_POWERPC
index|]
operator|.
name|pcd_ri
expr_stmt|;
name|KASSERT
argument_list|(
name|pc
operator|!=
name|NULL
argument_list|,
operator|(
literal|"[powerpc,%d] NULL per-cpu pointer"
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|phw
operator|=
name|pac
operator|->
name|pc_ppcpmcs
init|;
name|i
operator|<
name|E500_MAX_PMCS
condition|;
name|i
operator|++
operator|,
name|phw
operator|++
control|)
block|{
name|phw
operator|->
name|phw_state
operator|=
name|PMC_PHW_FLAG_IS_ENABLED
operator||
name|PMC_PHW_CPU_TO_STATE
argument_list|(
name|cpu
argument_list|)
operator||
name|PMC_PHW_INDEX_TO_STATE
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|phw
operator|->
name|phw_pmc
operator|=
name|NULL
expr_stmt|;
name|pc
operator|->
name|pc_hwpmcs
index|[
name|i
operator|+
name|first_ri
index|]
operator|=
name|phw
expr_stmt|;
comment|/* Initialize the PMC to stopped */
name|e500_stop_pmc
argument_list|(
name|cpu
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
comment|/* Unfreeze global register. */
name|mtpmr
argument_list|(
name|PMR_PMGC0
argument_list|,
name|PMGC_PMIE
operator||
name|PMGC_FCECE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e500_pcpu_fini
parameter_list|(
name|struct
name|pmc_mdep
modifier|*
name|md
parameter_list|,
name|int
name|cpu
parameter_list|)
block|{
name|uint32_t
name|pmgc0
init|=
name|mfpmr
argument_list|(
name|PMR_PMGC0
argument_list|)
decl_stmt|;
name|pmgc0
operator||=
name|PMGC_FAC
expr_stmt|;
name|mtpmr
argument_list|(
name|PMR_PMGC0
argument_list|,
name|pmgc0
argument_list|)
expr_stmt|;
name|mtmsr
argument_list|(
name|mfmsr
argument_list|()
operator|&
operator|~
name|PSL_PMM
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
argument_list|,
name|M_PMC
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|powerpc_pcpu
index|[
name|cpu
index|]
argument_list|,
name|M_PMC
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e500_allocate_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc
modifier|*
name|pm
parameter_list|,
specifier|const
name|struct
name|pmc_op_pmcallocate
modifier|*
name|a
parameter_list|)
block|{
name|enum
name|pmc_event
name|pe
decl_stmt|;
name|uint32_t
name|caps
decl_stmt|,
name|config
decl_stmt|,
name|counter
decl_stmt|;
name|struct
name|e500_event_code_map
modifier|*
name|ev
decl_stmt|;
name|uint16_t
name|vers
decl_stmt|;
name|uint8_t
name|pe_cpu_mask
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|E500_MAX_PMCS
argument_list|,
operator|(
literal|"[powerpc,%d] illegal row index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|caps
operator|=
name|a
operator|->
name|pm_caps
expr_stmt|;
name|pe
operator|=
name|a
operator|->
name|pm_ev
expr_stmt|;
name|config
operator|=
name|PMLCax_FCS
operator||
name|PMLCax_FCU
operator||
name|PMLCax_FCM1
operator||
name|PMLCax_FCM1
expr_stmt|;
if|if
condition|(
name|pe
operator|<
name|PMC_EV_E500_FIRST
operator|||
name|pe
operator|>
name|PMC_EV_E500_LAST
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|ev
operator|=
operator|&
name|e500_event_codes
index|[
name|pe
operator|-
name|PMC_EV_E500_FIRST
index|]
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|pe_code
operator|==
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|vers
operator|=
name|mfpvr
argument_list|()
operator|>>
literal|16
expr_stmt|;
switch|switch
condition|(
name|vers
condition|)
block|{
case|case
name|FSL_E500v1
case|:
name|pe_cpu_mask
operator|=
name|ev
operator|->
name|pe_cpu
operator|&
name|PMC_PPC_E500V1
expr_stmt|;
break|break;
case|case
name|FSL_E500v2
case|:
name|pe_cpu_mask
operator|=
name|ev
operator|->
name|pe_cpu
operator|&
name|PMC_PPC_E500V2
expr_stmt|;
break|break;
case|case
name|FSL_E500mc
case|:
case|case
name|FSL_E5500
case|:
name|pe_cpu_mask
operator|=
name|ev
operator|->
name|pe_cpu
operator|&
name|PMC_PPC_E500MC
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|pe_cpu_mask
operator|==
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|config
operator||=
name|PMLCax_EVENT
argument_list|(
name|ev
operator|->
name|pe_code
argument_list|)
expr_stmt|;
name|counter
operator|=
name|ev
operator|->
name|pe_counter_mask
expr_stmt|;
if|if
condition|(
operator|(
name|counter
operator|&
operator|(
literal|1
operator|<<
name|ri
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|caps
operator|&
name|PMC_CAP_SYSTEM
condition|)
name|config
operator|&=
operator|~
name|PMLCax_FCS
expr_stmt|;
if|if
condition|(
name|caps
operator|&
name|PMC_CAP_USER
condition|)
name|config
operator|&=
operator|~
name|PMLCax_FCU
expr_stmt|;
if|if
condition|(
operator|(
name|caps
operator|&
operator|(
name|PMC_CAP_USER
operator||
name|PMC_CAP_SYSTEM
operator|)
operator|)
operator|==
literal|0
condition|)
name|config
operator|&=
operator|~
operator|(
name|PMLCax_FCS
operator||
name|PMLCax_FCU
operator|)
expr_stmt|;
name|pm
operator|->
name|pm_md
operator|.
name|pm_powerpc
operator|.
name|pm_powerpc_evsel
operator|=
name|config
expr_stmt|;
name|PMCDBG2
argument_list|(
name|MDP
argument_list|,
name|ALL
argument_list|,
literal|2
argument_list|,
literal|"powerpc-allocate ri=%d -> config=0x%x"
argument_list|,
name|ri
argument_list|,
name|config
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e500_release_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc
modifier|*
name|pmc
parameter_list|)
block|{
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|E500_MAX_PMCS
argument_list|,
operator|(
literal|"[powerpc,%d] illegal row-index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|phw
operator|=
operator|&
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|phw
operator|->
name|phw_pmc
operator|==
name|NULL
argument_list|,
operator|(
literal|"[powerpc,%d] PHW pmc %p non-NULL"
operator|,
name|__LINE__
operator|,
name|phw
operator|->
name|phw_pmc
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e500_intr
parameter_list|(
name|int
name|cpu
parameter_list|,
name|struct
name|trapframe
modifier|*
name|tf
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|retval
decl_stmt|;
name|uint32_t
name|config
decl_stmt|;
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|struct
name|powerpc_cpu
modifier|*
name|pac
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] out of range CPU %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|PMCDBG3
argument_list|(
name|MDP
argument_list|,
name|INT
argument_list|,
literal|1
argument_list|,
literal|"cpu=%d tf=%p um=%d"
argument_list|,
name|cpu
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tf
argument_list|,
name|TRAPF_USERMODE
argument_list|(
name|tf
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|pac
operator|=
name|powerpc_pcpu
index|[
name|cpu
index|]
expr_stmt|;
name|config
operator|=
name|mfpmr
argument_list|(
name|PMR_PMGC0
argument_list|)
operator|&
operator|~
name|PMGC_FAC
expr_stmt|;
comment|/* 	 * look for all PMCs that have interrupted: 	 * - look for a running, sampling PMC which has overflowed 	 *   and which has a valid 'struct pmc' association 	 * 	 * If found, we call a helper to process the interrupt. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|E500_MAX_PMCS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|pm
operator|=
name|pac
operator|->
name|pc_ppcpmcs
index|[
name|i
index|]
operator|.
name|phw_pmc
operator|)
operator|==
name|NULL
operator|||
operator|!
name|PMC_IS_SAMPLING_MODE
argument_list|(
name|PMC_TO_MODE
argument_list|(
name|pm
argument_list|)
argument_list|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
operator|!
name|E500_PMC_HAS_OVERFLOWED
argument_list|(
name|i
argument_list|)
condition|)
continue|continue;
name|retval
operator|=
literal|1
expr_stmt|;
comment|/* Found an interrupting PMC. */
if|if
condition|(
name|pm
operator|->
name|pm_state
operator|!=
name|PMC_STATE_RUNNING
condition|)
continue|continue;
comment|/* Stop the counter if logging fails. */
name|error
operator|=
name|pmc_process_interrupt
argument_list|(
name|cpu
argument_list|,
name|PMC_HR
argument_list|,
name|pm
argument_list|,
name|tf
argument_list|,
name|TRAPF_USERMODE
argument_list|(
name|tf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|e500_stop_pmc
argument_list|(
name|cpu
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* reload count. */
name|e500_write_pmc
argument_list|(
name|cpu
argument_list|,
name|i
argument_list|,
name|pm
operator|->
name|pm_sc
operator|.
name|pm_reloadcount
argument_list|)
expr_stmt|;
block|}
name|atomic_add_int
argument_list|(
name|retval
condition|?
operator|&
name|pmc_stats
operator|.
name|pm_intr_processed
else|:
operator|&
name|pmc_stats
operator|.
name|pm_intr_ignored
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Re-enable PERF exceptions. */
if|if
condition|(
name|retval
condition|)
name|mtpmr
argument_list|(
name|PMR_PMGC0
argument_list|,
name|config
operator||
name|PMGC_PMIE
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pmc_e500_initialize
parameter_list|(
name|struct
name|pmc_mdep
modifier|*
name|pmc_mdep
parameter_list|)
block|{
name|struct
name|pmc_classdep
modifier|*
name|pcd
decl_stmt|;
name|pmc_mdep
operator|->
name|pmd_cputype
operator|=
name|PMC_CPU_PPC_E500
expr_stmt|;
name|pcd
operator|=
operator|&
name|pmc_mdep
operator|->
name|pmd_classdep
index|[
name|PMC_MDEP_CLASS_INDEX_POWERPC
index|]
expr_stmt|;
name|pcd
operator|->
name|pcd_caps
operator|=
name|POWERPC_PMC_CAPS
expr_stmt|;
name|pcd
operator|->
name|pcd_class
operator|=
name|PMC_CLASS_E500
expr_stmt|;
name|pcd
operator|->
name|pcd_num
operator|=
name|E500_MAX_PMCS
expr_stmt|;
name|pcd
operator|->
name|pcd_ri
operator|=
name|pmc_mdep
operator|->
name|pmd_npmc
expr_stmt|;
name|pcd
operator|->
name|pcd_width
operator|=
literal|32
expr_stmt|;
name|pcd
operator|->
name|pcd_allocate_pmc
operator|=
name|e500_allocate_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_config_pmc
operator|=
name|e500_config_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_pcpu_fini
operator|=
name|e500_pcpu_fini
expr_stmt|;
name|pcd
operator|->
name|pcd_pcpu_init
operator|=
name|e500_pcpu_init
expr_stmt|;
name|pcd
operator|->
name|pcd_describe
operator|=
name|powerpc_describe
expr_stmt|;
name|pcd
operator|->
name|pcd_get_config
operator|=
name|powerpc_get_config
expr_stmt|;
name|pcd
operator|->
name|pcd_read_pmc
operator|=
name|e500_read_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_release_pmc
operator|=
name|e500_release_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_start_pmc
operator|=
name|e500_start_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_stop_pmc
operator|=
name|e500_stop_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_write_pmc
operator|=
name|e500_write_pmc
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_npmc
operator|+=
name|E500_MAX_PMCS
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_intr
operator|=
name|e500_intr
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


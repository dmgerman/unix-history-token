begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013 Justin Hibbits  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/pmc.h>
end_include

begin_include
include|#
directive|include
file|<sys/pmckern.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<machine/pmc_mdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/spr.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|"hwpmc_powerpc.h"
end_include

begin_define
define|#
directive|define
name|PPC970_MAX_PMCS
value|8
end_define

begin_comment
comment|/* MMCR0, PMC1 is 8 bytes in, PMC2 is 1 byte in. */
end_comment

begin_define
define|#
directive|define
name|PPC970_SET_MMCR0_PMCSEL
parameter_list|(
name|r
parameter_list|,
name|x
parameter_list|,
name|i
parameter_list|)
define|\
value|((r& ~(0x1f<< (7 * (1 - i) + 1))) | (x<< (7 * (1 - i) + 1)))
end_define

begin_comment
comment|/* MMCR1 has 6 PMC*SEL items (PMC3->PMC8), in sequence. */
end_comment

begin_define
define|#
directive|define
name|PPC970_SET_MMCR1_PMCSEL
parameter_list|(
name|r
parameter_list|,
name|x
parameter_list|,
name|i
parameter_list|)
define|\
value|((r& ~(0x1f<< (5 * (7 - i) + 2))) | (x<< (5 * (7 - i) + 2)))
end_define

begin_define
define|#
directive|define
name|PPC970_PMC_HAS_OVERFLOWED
parameter_list|(
name|x
parameter_list|)
value|(ppc970_pmcn_read(x)& (0x1<< 31))
end_define

begin_comment
comment|/* How PMC works on PPC970:  *  * Any PMC can count a direct event.  Indirect events are handled specially.  * Direct events: As published.  *  * Encoding 00 000 -- Add byte lane bit counters  *   MMCR1[24:31] -- select bit matching PMC being an adder.  * Bus events:  * PMCxSEL: 1x -- select from byte lane: 10 == lower lane (0/1), 11 == upper  * lane (2/3).  * PMCxSEL[2:4] -- bit in the byte lane selected.  *  * PMC[1,2,5,6] == lane 0/lane 2  * PMC[3,4,7,8] == lane 1,3  *  *  * Lanes:  * Lane 0 -- TTM0(FPU,ISU,IFU,VPU)  *           TTM1(IDU,ISU,STS)  *           LSU0 byte 0  *           LSU1 byte 0  * Lane 1 -- TTM0  *           TTM1  *           LSU0 byte 1  *           LSU1 byte 1  * Lane 2 -- TTM0  *           TTM1  *           LSU0 byte 2  *           LSU1 byte 2 or byte 6  * Lane 3 -- TTM0  *           TTM1  *           LSU0 byte 3  *           LSU1 byte 3 or byte 7  *  * Adders:  *  Add byte lane for PMC (above), bit 0+4, 1+5, 2+6, 3+7  */
end_comment

begin_struct
struct|struct
name|pmc_ppc970_event
block|{
name|enum
name|pmc_event
name|pe_event
decl_stmt|;
name|uint32_t
name|pe_flags
decl_stmt|;
define|#
directive|define
name|PMC_PPC970_FLAG_PMCS
value|0x000000ff
define|#
directive|define
name|PMC_PPC970_FLAG_PMC1
value|0x01
define|#
directive|define
name|PMC_PPC970_FLAG_PMC2
value|0x02
define|#
directive|define
name|PMC_PPC970_FLAG_PMC3
value|0x04
define|#
directive|define
name|PMC_PPC970_FLAG_PMC4
value|0x08
define|#
directive|define
name|PMC_PPC970_FLAG_PMC5
value|0x10
define|#
directive|define
name|PMC_PPC970_FLAG_PMC6
value|0x20
define|#
directive|define
name|PMC_PPC970_FLAG_PMC7
value|0x40
define|#
directive|define
name|PMC_PPC970_FLAG_PMC8
value|0x80
name|uint32_t
name|pe_code
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|pmc_ppc970_event
name|ppc970_event_codes
index|[]
init|=
block|{
block|{
name|PMC_EV_PPC970_INSTR_COMPLETED
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMCS
block|,
operator|.
name|pe_code
operator|=
literal|0x09
block|}
block|,
block|{
name|PMC_EV_PPC970_MARKED_GROUP_DISPATCH
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC1
block|,
operator|.
name|pe_code
operator|=
literal|0x2
block|}
block|,
block|{
name|PMC_EV_PPC970_MARKED_STORE_COMPLETED
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC1
block|,
operator|.
name|pe_code
operator|=
literal|0x03
block|}
block|,
block|{
name|PMC_EV_PPC970_GCT_EMPTY
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC1
block|,
operator|.
name|pe_code
operator|=
literal|0x04
block|}
block|,
block|{
name|PMC_EV_PPC970_RUN_CYCLES
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC1
block|,
operator|.
name|pe_code
operator|=
literal|0x05
block|}
block|,
block|{
name|PMC_EV_PPC970_OVERFLOW
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMCS
block|,
operator|.
name|pe_code
operator|=
literal|0x0a
block|}
block|,
block|{
name|PMC_EV_PPC970_CYCLES
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMCS
block|,
operator|.
name|pe_code
operator|=
literal|0x0f
block|}
block|,
block|{
name|PMC_EV_PPC970_THRESHOLD_TIMEOUT
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC2
block|,
operator|.
name|pe_code
operator|=
literal|0x3
block|}
block|,
block|{
name|PMC_EV_PPC970_GROUP_DISPATCH
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC2
block|,
operator|.
name|pe_code
operator|=
literal|0x4
block|}
block|,
block|{
name|PMC_EV_PPC970_BR_MARKED_INSTR_FINISH
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC2
block|,
operator|.
name|pe_code
operator|=
literal|0x5
block|}
block|,
block|{
name|PMC_EV_PPC970_GCT_EMPTY_BY_SRQ_FULL
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC2
block|,
operator|.
name|pe_code
operator|=
literal|0xb
block|}
block|,
block|{
name|PMC_EV_PPC970_STOP_COMPLETION
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC3
block|,
operator|.
name|pe_code
operator|=
literal|0x1
block|}
block|,
block|{
name|PMC_EV_PPC970_LSU_EMPTY
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC3
block|,
operator|.
name|pe_code
operator|=
literal|0x2
block|}
block|,
block|{
name|PMC_EV_PPC970_MARKED_STORE_WITH_INTR
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC3
block|,
operator|.
name|pe_code
operator|=
literal|0x3
block|}
block|,
block|{
name|PMC_EV_PPC970_CYCLES_IN_SUPER
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC3
block|,
operator|.
name|pe_code
operator|=
literal|0x4
block|}
block|,
block|{
name|PMC_EV_PPC970_VPU_MARKED_INSTR_COMPLETED
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC3
block|,
operator|.
name|pe_code
operator|=
literal|0x5
block|}
block|,
block|{
name|PMC_EV_PPC970_FXU0_IDLE_FXU1_BUSY
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC4
block|,
operator|.
name|pe_code
operator|=
literal|0x2
block|}
block|,
block|{
name|PMC_EV_PPC970_SRQ_EMPTY
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC4
block|,
operator|.
name|pe_code
operator|=
literal|0x3
block|}
block|,
block|{
name|PMC_EV_PPC970_MARKED_GROUP_COMPLETED
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC4
block|,
operator|.
name|pe_code
operator|=
literal|0x4
block|}
block|,
block|{
name|PMC_EV_PPC970_CR_MARKED_INSTR_FINISH
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC4
block|,
operator|.
name|pe_code
operator|=
literal|0x5
block|}
block|,
block|{
name|PMC_EV_PPC970_DISPATCH_SUCCESS
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC5
block|,
operator|.
name|pe_code
operator|=
literal|0x1
block|}
block|,
block|{
name|PMC_EV_PPC970_FXU0_IDLE_FXU1_IDLE
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC5
block|,
operator|.
name|pe_code
operator|=
literal|0x2
block|}
block|,
block|{
name|PMC_EV_PPC970_ONE_PLUS_INSTR_COMPLETED
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC5
block|,
operator|.
name|pe_code
operator|=
literal|0x3
block|}
block|,
block|{
name|PMC_EV_PPC970_GROUP_MARKED_IDU
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC5
block|,
operator|.
name|pe_code
operator|=
literal|0x4
block|}
block|,
block|{
name|PMC_EV_PPC970_MARKED_GROUP_COMPLETE_TIMEOUT
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC5
block|,
operator|.
name|pe_code
operator|=
literal|0x5
block|}
block|,
block|{
name|PMC_EV_PPC970_FXU0_BUSY_FXU1_BUSY
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC6
block|,
operator|.
name|pe_code
operator|=
literal|0x2
block|}
block|,
block|{
name|PMC_EV_PPC970_MARKED_STORE_SENT_TO_STS
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC6
block|,
operator|.
name|pe_code
operator|=
literal|0x3
block|}
block|,
block|{
name|PMC_EV_PPC970_FXU_MARKED_INSTR_FINISHED
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC6
block|,
operator|.
name|pe_code
operator|=
literal|0x4
block|}
block|,
block|{
name|PMC_EV_PPC970_MARKED_GROUP_ISSUED
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC6
block|,
operator|.
name|pe_code
operator|=
literal|0x5
block|}
block|,
block|{
name|PMC_EV_PPC970_FXU0_BUSY_FXU1_IDLE
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC7
block|,
operator|.
name|pe_code
operator|=
literal|0x2
block|}
block|,
block|{
name|PMC_EV_PPC970_GROUP_COMPLETED
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC7
block|,
operator|.
name|pe_code
operator|=
literal|0x3
block|}
block|,
block|{
name|PMC_EV_PPC970_FPU_MARKED_INSTR_COMPLETED
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC7
block|,
operator|.
name|pe_code
operator|=
literal|0x4
block|}
block|,
block|{
name|PMC_EV_PPC970_MARKED_INSTR_FINISH_ANY_UNIT
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC7
block|,
operator|.
name|pe_code
operator|=
literal|0x5
block|}
block|,
block|{
name|PMC_EV_PPC970_EXTERNAL_INTERRUPT
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC8
block|,
operator|.
name|pe_code
operator|=
literal|0x2
block|}
block|,
block|{
name|PMC_EV_PPC970_GROUP_DISPATCH_REJECT
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC8
block|,
operator|.
name|pe_code
operator|=
literal|0x3
block|}
block|,
block|{
name|PMC_EV_PPC970_LSU_MARKED_INSTR_FINISH
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC8
block|,
operator|.
name|pe_code
operator|=
literal|0x4
block|}
block|,
block|{
name|PMC_EV_PPC970_TIMEBASE_EVENT
block|,
operator|.
name|pe_flags
operator|=
name|PMC_PPC970_FLAG_PMC8
block|,
operator|.
name|pe_code
operator|=
literal|0x5
block|}
block|,
if|#
directive|if
literal|0
block|{PMC_EV_PPC970_LSU_COMPLETION_STALL, }, 	{PMC_EV_PPC970_FXU_COMPLETION_STALL, }, 	{PMC_EV_PPC970_DCACHE_MISS_COMPLETION_STALL, }, 	{PMC_EV_PPC970_FPU_COMPLETION_STALL, }, 	{PMC_EV_PPC970_FXU_LONG_INSTR_COMPLETION_STALL, }, 	{PMC_EV_PPC970_REJECT_COMPLETION_STALL, }, 	{PMC_EV_PPC970_FPU_LONG_INSTR_COMPLETION_STALL, }, 	{PMC_EV_PPC970_GCT_EMPTY_BY_ICACHE_MISS, }, 	{PMC_EV_PPC970_REJECT_COMPLETION_STALL_ERAT_MISS, }, 	{PMC_EV_PPC970_GCT_EMPTY_BY_BRANCH_MISS_PREDICT, },
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|size_t
name|ppc970_event_codes_size
init|=
name|nitems
argument_list|(
name|ppc970_event_codes
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|pmc_value_t
name|ppc970_pmcn_read
parameter_list|(
name|unsigned
name|int
name|pmc
parameter_list|)
block|{
name|pmc_value_t
name|val
decl_stmt|;
switch|switch
condition|(
name|pmc
condition|)
block|{
case|case
literal|0
case|:
name|val
operator|=
name|mfspr
argument_list|(
name|SPR_970PMC1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|val
operator|=
name|mfspr
argument_list|(
name|SPR_970PMC2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|val
operator|=
name|mfspr
argument_list|(
name|SPR_970PMC3
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|val
operator|=
name|mfspr
argument_list|(
name|SPR_970PMC4
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|val
operator|=
name|mfspr
argument_list|(
name|SPR_970PMC5
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|val
operator|=
name|mfspr
argument_list|(
name|SPR_970PMC6
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|val
operator|=
name|mfspr
argument_list|(
name|SPR_970PMC7
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|val
operator|=
name|mfspr
argument_list|(
name|SPR_970PMC8
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Invalid PMC number: %d\n"
argument_list|,
name|pmc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ppc970_pmcn_write
parameter_list|(
name|unsigned
name|int
name|pmc
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
switch|switch
condition|(
name|pmc
condition|)
block|{
case|case
literal|0
case|:
name|mtspr
argument_list|(
name|SPR_970PMC1
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|mtspr
argument_list|(
name|SPR_970PMC2
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|mtspr
argument_list|(
name|SPR_970PMC3
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|mtspr
argument_list|(
name|SPR_970PMC4
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|mtspr
argument_list|(
name|SPR_970PMC5
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|mtspr
argument_list|(
name|SPR_970PMC6
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|mtspr
argument_list|(
name|SPR_970PMC7
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|mtspr
argument_list|(
name|SPR_970PMC8
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Invalid PMC number: %d\n"
argument_list|,
name|pmc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_config_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc
modifier|*
name|pm
parameter_list|)
block|{
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|CFG
argument_list|,
literal|1
argument_list|,
literal|"cpu=%d ri=%d pm=%p"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|,
name|pm
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|PPC970_MAX_PMCS
argument_list|,
operator|(
literal|"[powerpc,%d] illegal row-index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|phw
operator|=
operator|&
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|pm
operator|==
name|NULL
operator|||
name|phw
operator|->
name|phw_pmc
operator|==
name|NULL
argument_list|,
operator|(
literal|"[powerpc,%d] pm=%p phw->pm=%p hwpmc not unconfigured"
operator|,
name|__LINE__
operator|,
name|pm
operator|,
name|phw
operator|->
name|phw_pmc
operator|)
argument_list|)
expr_stmt|;
name|phw
operator|->
name|phw_pmc
operator|=
name|pm
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_set_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|int
name|config
parameter_list|)
block|{
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|register_t
name|pmc_mmcr
decl_stmt|;
name|phw
operator|=
operator|&
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
expr_stmt|;
name|pm
operator|=
name|phw
operator|->
name|phw_pmc
expr_stmt|;
comment|/* 	 * Disable the PMCs. 	 */
switch|switch
condition|(
name|ri
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|1
case|:
name|pmc_mmcr
operator|=
name|mfspr
argument_list|(
name|SPR_970MMCR0
argument_list|)
expr_stmt|;
name|pmc_mmcr
operator|=
name|PPC970_SET_MMCR0_PMCSEL
argument_list|(
name|pmc_mmcr
argument_list|,
name|config
argument_list|,
name|ri
argument_list|)
expr_stmt|;
name|mtspr
argument_list|(
name|SPR_970MMCR0
argument_list|,
name|pmc_mmcr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
case|case
literal|3
case|:
case|case
literal|4
case|:
case|case
literal|5
case|:
case|case
literal|6
case|:
case|case
literal|7
case|:
name|pmc_mmcr
operator|=
name|mfspr
argument_list|(
name|SPR_970MMCR1
argument_list|)
expr_stmt|;
name|pmc_mmcr
operator|=
name|PPC970_SET_MMCR1_PMCSEL
argument_list|(
name|pmc_mmcr
argument_list|,
name|config
argument_list|,
name|ri
argument_list|)
expr_stmt|;
name|mtspr
argument_list|(
name|SPR_970MMCR1
argument_list|,
name|pmc_mmcr
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_start_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|)
block|{
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|register_t
name|pmc_mmcr
decl_stmt|;
name|uint32_t
name|config
decl_stmt|;
name|int
name|error
decl_stmt|;
name|phw
operator|=
operator|&
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
expr_stmt|;
name|pm
operator|=
name|phw
operator|->
name|phw_pmc
expr_stmt|;
name|config
operator|=
name|pm
operator|->
name|pm_md
operator|.
name|pm_powerpc
operator|.
name|pm_powerpc_evsel
operator|&
operator|~
name|POWERPC_PMC_ENABLE
expr_stmt|;
name|error
operator|=
name|ppc970_set_pmc
argument_list|(
name|cpu
argument_list|,
name|ri
argument_list|,
name|config
argument_list|)
expr_stmt|;
comment|/* The mask is inverted (enable is 1) compared to the flags in MMCR0, which 	 * are Freeze flags. 	 */
name|config
operator|=
operator|~
name|pm
operator|->
name|pm_md
operator|.
name|pm_powerpc
operator|.
name|pm_powerpc_evsel
operator|&
name|POWERPC_PMC_ENABLE
expr_stmt|;
name|pmc_mmcr
operator|=
name|mfspr
argument_list|(
name|SPR_970MMCR0
argument_list|)
expr_stmt|;
name|pmc_mmcr
operator|&=
operator|~
name|SPR_MMCR0_FC
expr_stmt|;
name|pmc_mmcr
operator||=
name|config
expr_stmt|;
name|mtspr
argument_list|(
name|SPR_970MMCR0
argument_list|,
name|pmc_mmcr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_stop_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|)
block|{
return|return
name|ppc970_set_pmc
argument_list|(
name|cpu
argument_list|,
name|ri
argument_list|,
name|PMC970N_NONE
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_read_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|pmc_value_t
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|pmc_value_t
name|tmp
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|PPC970_MAX_PMCS
argument_list|,
operator|(
literal|"[powerpc,%d] illegal row index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|pm
operator|=
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
operator|.
name|phw_pmc
expr_stmt|;
name|KASSERT
argument_list|(
name|pm
argument_list|,
operator|(
literal|"[core,%d] cpu %d ri %d pmc not configured"
operator|,
name|__LINE__
operator|,
name|cpu
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ppc970_pmcn_read
argument_list|(
name|ri
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|REA
argument_list|,
literal|2
argument_list|,
literal|"ppc-read id=%d -> %jd"
argument_list|,
name|ri
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|PMC_IS_SAMPLING_MODE
argument_list|(
name|PMC_TO_MODE
argument_list|(
name|pm
argument_list|)
argument_list|)
condition|)
operator|*
name|v
operator|=
name|POWERPC_PERFCTR_VALUE_TO_RELOAD_COUNT
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
else|else
operator|*
name|v
operator|=
name|tmp
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_write_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|pmc_value_t
name|v
parameter_list|)
block|{
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|PPC970_MAX_PMCS
argument_list|,
operator|(
literal|"[powerpc,%d] illegal row-index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|pm
operator|=
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
operator|.
name|phw_pmc
expr_stmt|;
if|if
condition|(
name|PMC_IS_SAMPLING_MODE
argument_list|(
name|PMC_TO_MODE
argument_list|(
name|pm
argument_list|)
argument_list|)
condition|)
name|v
operator|=
name|POWERPC_RELOAD_COUNT_TO_PERFCTR_VALUE
argument_list|(
name|v
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|WRI
argument_list|,
literal|1
argument_list|,
literal|"powerpc-write cpu=%d ri=%d v=%jx"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|ppc970_pmcn_write
argument_list|(
name|ri
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_intr
parameter_list|(
name|int
name|cpu
parameter_list|,
name|struct
name|trapframe
modifier|*
name|tf
parameter_list|)
block|{
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|struct
name|powerpc_cpu
modifier|*
name|pac
decl_stmt|;
name|pmc_value_t
name|v
decl_stmt|;
name|uint32_t
name|config
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|retval
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] out of range CPU %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|INT
argument_list|,
literal|1
argument_list|,
literal|"cpu=%d tf=%p um=%d"
argument_list|,
name|cpu
argument_list|,
operator|(
name|void
operator|*
operator|)
name|tf
argument_list|,
name|TRAPF_USERMODE
argument_list|(
name|tf
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|pac
operator|=
name|powerpc_pcpu
index|[
name|cpu
index|]
expr_stmt|;
comment|/* 	 * look for all PMCs that have interrupted: 	 * - look for a running, sampling PMC which has overflowed 	 *   and which has a valid 'struct pmc' association 	 * 	 * If found, we call a helper to process the interrupt. 	 */
name|config
operator|=
name|mfspr
argument_list|(
name|SPR_970MMCR0
argument_list|)
expr_stmt|;
name|mtspr
argument_list|(
name|SPR_970MMCR0
argument_list|,
name|config
operator||
name|SPR_MMCR0_FC
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PPC970_MAX_PMCS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|pm
operator|=
name|pac
operator|->
name|pc_ppcpmcs
index|[
name|i
index|]
operator|.
name|phw_pmc
operator|)
operator|==
name|NULL
operator|||
operator|!
name|PMC_IS_SAMPLING_MODE
argument_list|(
name|PMC_TO_MODE
argument_list|(
name|pm
argument_list|)
argument_list|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
operator|!
name|PPC970_PMC_HAS_OVERFLOWED
argument_list|(
name|i
argument_list|)
condition|)
continue|continue;
name|retval
operator|=
literal|1
expr_stmt|;
comment|/* Found an interrupting PMC. */
if|if
condition|(
name|pm
operator|->
name|pm_state
operator|!=
name|PMC_STATE_RUNNING
condition|)
continue|continue;
comment|/* Stop the PMC, reload count. */
name|v
operator|=
name|pm
operator|->
name|pm_sc
operator|.
name|pm_reloadcount
expr_stmt|;
name|ppc970_pmcn_write
argument_list|(
name|i
argument_list|,
name|v
argument_list|)
expr_stmt|;
comment|/* Restart the counter if logging succeeded. */
name|error
operator|=
name|pmc_process_interrupt
argument_list|(
name|cpu
argument_list|,
name|PMC_HR
argument_list|,
name|pm
argument_list|,
name|tf
argument_list|,
name|TRAPF_USERMODE
argument_list|(
name|tf
argument_list|)
argument_list|)
expr_stmt|;
name|mtspr
argument_list|(
name|SPR_970MMCR0
argument_list|,
name|config
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|ppc970_stop_pmc
argument_list|(
name|cpu
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|atomic_add_int
argument_list|(
name|retval
condition|?
operator|&
name|pmc_stats
operator|.
name|pm_intr_processed
else|:
operator|&
name|pmc_stats
operator|.
name|pm_intr_ignored
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Re-enable PERF exceptions. */
name|mtspr
argument_list|(
name|SPR_970MMCR0
argument_list|,
name|mfspr
argument_list|(
name|SPR_970MMCR0
argument_list|)
operator||
name|SPR_MMCR0_PMXE
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_pcpu_init
parameter_list|(
name|struct
name|pmc_mdep
modifier|*
name|md
parameter_list|,
name|int
name|cpu
parameter_list|)
block|{
name|struct
name|pmc_cpu
modifier|*
name|pc
decl_stmt|;
name|struct
name|powerpc_cpu
modifier|*
name|pac
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|int
name|first_ri
decl_stmt|,
name|i
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] wrong cpu number %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|INI
argument_list|,
literal|1
argument_list|,
literal|"powerpc-init cpu=%d"
argument_list|,
name|cpu
argument_list|)
expr_stmt|;
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|=
name|pac
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|powerpc_cpu
argument_list|)
argument_list|,
name|M_PMC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pac
operator|->
name|pc_ppcpmcs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|pmc_hw
argument_list|)
operator|*
name|PPC970_MAX_PMCS
argument_list|,
name|M_PMC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pac
operator|->
name|pc_class
operator|=
name|PMC_CLASS_PPC970
expr_stmt|;
name|pc
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
expr_stmt|;
name|first_ri
operator|=
name|md
operator|->
name|pmd_classdep
index|[
name|PMC_MDEP_CLASS_INDEX_PPC970
index|]
operator|.
name|pcd_ri
expr_stmt|;
name|KASSERT
argument_list|(
name|pc
operator|!=
name|NULL
argument_list|,
operator|(
literal|"[powerpc,%d] NULL per-cpu pointer"
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|phw
operator|=
name|pac
operator|->
name|pc_ppcpmcs
init|;
name|i
operator|<
name|PPC970_MAX_PMCS
condition|;
name|i
operator|++
operator|,
name|phw
operator|++
control|)
block|{
name|phw
operator|->
name|phw_state
operator|=
name|PMC_PHW_FLAG_IS_ENABLED
operator||
name|PMC_PHW_CPU_TO_STATE
argument_list|(
name|cpu
argument_list|)
operator||
name|PMC_PHW_INDEX_TO_STATE
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|phw
operator|->
name|phw_pmc
operator|=
name|NULL
expr_stmt|;
name|pc
operator|->
name|pc_hwpmcs
index|[
name|i
operator|+
name|first_ri
index|]
operator|=
name|phw
expr_stmt|;
block|}
comment|/* Clear the MMCRs, and set FC, to disable all PMCs. */
comment|/* 970 PMC is not counted when set to 0x08 */
name|mtspr
argument_list|(
name|SPR_970MMCR0
argument_list|,
name|SPR_MMCR0_FC
operator||
name|SPR_MMCR0_PMXE
operator||
name|SPR_MMCR0_PMC1CE
operator||
name|SPR_MMCR0_PMCNCE
operator||
name|SPR_970MMCR0_PMC1SEL
argument_list|(
literal|0x8
argument_list|)
operator||
name|SPR_970MMCR0_PMC2SEL
argument_list|(
literal|0x8
argument_list|)
argument_list|)
expr_stmt|;
name|mtspr
argument_list|(
name|SPR_970MMCR1
argument_list|,
literal|0x4218420
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_pcpu_fini
parameter_list|(
name|struct
name|pmc_mdep
modifier|*
name|md
parameter_list|,
name|int
name|cpu
parameter_list|)
block|{
name|register_t
name|mmcr0
init|=
name|mfspr
argument_list|(
name|SPR_MMCR0
argument_list|)
decl_stmt|;
name|mmcr0
operator||=
name|SPR_MMCR0_FC
expr_stmt|;
name|mmcr0
operator|&=
operator|~
name|SPR_MMCR0_PMXE
expr_stmt|;
name|mtspr
argument_list|(
name|SPR_MMCR0
argument_list|,
name|mmcr0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
argument_list|,
name|M_PMC
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|powerpc_pcpu
index|[
name|cpu
index|]
argument_list|,
name|M_PMC
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_allocate_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc
modifier|*
name|pm
parameter_list|,
specifier|const
name|struct
name|pmc_op_pmcallocate
modifier|*
name|a
parameter_list|)
block|{
name|enum
name|pmc_event
name|pe
decl_stmt|;
name|uint32_t
name|caps
decl_stmt|,
name|config
init|=
literal|0
decl_stmt|,
name|counter
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|PPC970_MAX_PMCS
argument_list|,
operator|(
literal|"[powerpc,%d] illegal row index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|caps
operator|=
name|a
operator|->
name|pm_caps
expr_stmt|;
name|pe
operator|=
name|a
operator|->
name|pm_ev
expr_stmt|;
if|if
condition|(
name|pe
operator|<
name|PMC_EV_PPC970_FIRST
operator|||
name|pe
operator|>
name|PMC_EV_PPC970_LAST
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ppc970_event_codes_size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ppc970_event_codes
index|[
name|i
index|]
operator|.
name|pe_event
operator|==
name|pe
condition|)
block|{
name|config
operator|=
name|ppc970_event_codes
index|[
name|i
index|]
operator|.
name|pe_code
expr_stmt|;
name|counter
operator|=
name|ppc970_event_codes
index|[
name|i
index|]
operator|.
name|pe_flags
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|ppc970_event_codes_size
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|(
name|counter
operator|&
operator|(
literal|1
operator|<<
name|ri
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|caps
operator|&
name|PMC_CAP_SYSTEM
condition|)
name|config
operator||=
name|POWERPC_PMC_KERNEL_ENABLE
expr_stmt|;
if|if
condition|(
name|caps
operator|&
name|PMC_CAP_USER
condition|)
name|config
operator||=
name|POWERPC_PMC_USER_ENABLE
expr_stmt|;
if|if
condition|(
operator|(
name|caps
operator|&
operator|(
name|PMC_CAP_USER
operator||
name|PMC_CAP_SYSTEM
operator|)
operator|)
operator|==
literal|0
condition|)
name|config
operator||=
name|POWERPC_PMC_ENABLE
expr_stmt|;
name|pm
operator|->
name|pm_md
operator|.
name|pm_powerpc
operator|.
name|pm_powerpc_evsel
operator|=
name|config
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|ALL
argument_list|,
literal|2
argument_list|,
literal|"powerpc-allocate ri=%d -> config=0x%x"
argument_list|,
name|ri
argument_list|,
name|config
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc970_release_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc
modifier|*
name|pmc
parameter_list|)
block|{
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|pmc_cpu_max
argument_list|()
argument_list|,
operator|(
literal|"[powerpc,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|PPC970_MAX_PMCS
argument_list|,
operator|(
literal|"[powerpc,%d] illegal row-index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|phw
operator|=
operator|&
name|powerpc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_ppcpmcs
index|[
name|ri
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|phw
operator|->
name|phw_pmc
operator|==
name|NULL
argument_list|,
operator|(
literal|"[powerpc,%d] PHW pmc %p non-NULL"
operator|,
name|__LINE__
operator|,
name|phw
operator|->
name|phw_pmc
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_ppc970_initialize
parameter_list|(
name|struct
name|pmc_mdep
modifier|*
name|pmc_mdep
parameter_list|)
block|{
name|struct
name|pmc_classdep
modifier|*
name|pcd
decl_stmt|;
name|pmc_mdep
operator|->
name|pmd_cputype
operator|=
name|PMC_CPU_PPC_970
expr_stmt|;
name|pcd
operator|=
operator|&
name|pmc_mdep
operator|->
name|pmd_classdep
index|[
name|PMC_MDEP_CLASS_INDEX_PPC970
index|]
expr_stmt|;
name|pcd
operator|->
name|pcd_caps
operator|=
name|POWERPC_PMC_CAPS
expr_stmt|;
name|pcd
operator|->
name|pcd_class
operator|=
name|PMC_CLASS_PPC970
expr_stmt|;
name|pcd
operator|->
name|pcd_num
operator|=
name|PPC970_MAX_PMCS
expr_stmt|;
name|pcd
operator|->
name|pcd_ri
operator|=
name|pmc_mdep
operator|->
name|pmd_npmc
expr_stmt|;
name|pcd
operator|->
name|pcd_width
operator|=
literal|32
expr_stmt|;
name|pcd
operator|->
name|pcd_allocate_pmc
operator|=
name|ppc970_allocate_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_config_pmc
operator|=
name|ppc970_config_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_pcpu_fini
operator|=
name|ppc970_pcpu_fini
expr_stmt|;
name|pcd
operator|->
name|pcd_pcpu_init
operator|=
name|ppc970_pcpu_init
expr_stmt|;
name|pcd
operator|->
name|pcd_describe
operator|=
name|powerpc_describe
expr_stmt|;
name|pcd
operator|->
name|pcd_get_config
operator|=
name|powerpc_get_config
expr_stmt|;
name|pcd
operator|->
name|pcd_read_pmc
operator|=
name|ppc970_read_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_release_pmc
operator|=
name|ppc970_release_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_start_pmc
operator|=
name|ppc970_start_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_stop_pmc
operator|=
name|ppc970_stop_pmc
expr_stmt|;
name|pcd
operator|->
name|pcd_write_pmc
operator|=
name|ppc970_write_pmc
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_npmc
operator|+=
name|PPC970_MAX_PMCS
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_intr
operator|=
name|ppc970_intr
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


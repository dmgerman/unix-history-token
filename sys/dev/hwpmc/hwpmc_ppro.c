begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003-2005 Joseph Koshy  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/pmc.h>
end_include

begin_include
include|#
directive|include
file|<sys/pmckern.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<machine/cputypes.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_comment
comment|/*  * PENTIUM PRO SUPPORT  */
end_comment

begin_struct
struct|struct
name|p6pmc_descr
block|{
name|struct
name|pmc_descr
name|pm_descr
decl_stmt|;
comment|/* common information */
name|uint32_t
name|pm_pmc_msr
decl_stmt|;
name|uint32_t
name|pm_evsel_msr
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|p6pmc_descr
name|p6_pmcdesc
index|[
name|P6_NPMCS
index|]
init|=
block|{
comment|/* TSC */
block|{
operator|.
name|pm_descr
operator|=
block|{
operator|.
name|pd_name
operator|=
literal|"TSC"
block|,
operator|.
name|pd_class
operator|=
name|PMC_CLASS_TSC
block|,
operator|.
name|pd_caps
operator|=
name|PMC_CAP_READ
block|,
operator|.
name|pd_width
operator|=
literal|64
block|}
block|,
operator|.
name|pm_pmc_msr
operator|=
literal|0x10
block|,
operator|.
name|pm_evsel_msr
operator|=
operator|~
literal|0
block|}
block|,
define|#
directive|define
name|P6_PMC_CAPS
value|(PMC_CAP_INTERRUPT | PMC_CAP_USER | PMC_CAP_SYSTEM | \     PMC_CAP_EDGE | PMC_CAP_THRESHOLD | PMC_CAP_READ | PMC_CAP_WRITE |	 \     PMC_CAP_INVERT | PMC_CAP_QUALIFIER)
comment|/* PMC 0 */
block|{
operator|.
name|pm_descr
operator|=
block|{
operator|.
name|pd_name
operator|=
literal|"P6-0"
block|,
operator|.
name|pd_class
operator|=
name|PMC_CLASS_P6
block|,
operator|.
name|pd_caps
operator|=
name|P6_PMC_CAPS
block|,
operator|.
name|pd_width
operator|=
literal|40
block|}
block|,
operator|.
name|pm_pmc_msr
operator|=
name|P6_MSR_PERFCTR0
block|,
operator|.
name|pm_evsel_msr
operator|=
name|P6_MSR_EVSEL0
block|}
block|,
comment|/* PMC 1 */
block|{
operator|.
name|pm_descr
operator|=
block|{
operator|.
name|pd_name
operator|=
literal|"P6-1"
block|,
operator|.
name|pd_class
operator|=
name|PMC_CLASS_P6
block|,
operator|.
name|pd_caps
operator|=
name|P6_PMC_CAPS
block|,
operator|.
name|pd_width
operator|=
literal|40
block|}
block|,
operator|.
name|pm_pmc_msr
operator|=
name|P6_MSR_PERFCTR1
block|,
operator|.
name|pm_evsel_msr
operator|=
name|P6_MSR_EVSEL1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|enum
name|pmc_cputype
name|p6_cputype
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * P6 Event descriptor  */
end_comment

begin_struct
struct|struct
name|p6_event_descr
block|{
specifier|const
name|enum
name|pmc_event
name|pm_event
decl_stmt|;
name|uint32_t
name|pm_evsel
decl_stmt|;
name|uint32_t
name|pm_flags
decl_stmt|;
name|uint32_t
name|pm_unitmask
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|p6_event_descr
name|p6_events
index|[]
init|=
block|{
define|#
directive|define
name|P6_EVDESCR
parameter_list|(
name|NAME
parameter_list|,
name|EVSEL
parameter_list|,
name|FLAGS
parameter_list|,
name|UMASK
parameter_list|)
define|\
value|{					\ 		.pm_event = PMC_EV_P6_##NAME,	\ 		.pm_evsel = (EVSEL),		\ 		.pm_flags = (FLAGS),		\ 		.pm_unitmask = (UMASK)		\ 	}
define|#
directive|define
name|P6F_P6
value|(1<< PMC_CPU_INTEL_P6)
define|#
directive|define
name|P6F_CL
value|(1<< PMC_CPU_INTEL_CL)
define|#
directive|define
name|P6F_PII
value|(1<< PMC_CPU_INTEL_PII)
define|#
directive|define
name|P6F_PIII
value|(1<< PMC_CPU_INTEL_PIII)
define|#
directive|define
name|P6F_PM
value|(1<< PMC_CPU_INTEL_PM)
define|#
directive|define
name|P6F_CTR0
value|0x0001
define|#
directive|define
name|P6F_CTR1
value|0x0002
define|#
directive|define
name|P6F_ALL_CPUS
value|(P6F_P6 | P6F_PII | P6F_CL | P6F_PIII | P6F_PM)
define|#
directive|define
name|P6F_ALL_CTRS
value|(P6F_CTR0 | P6F_CTR1)
define|#
directive|define
name|P6F_ALL
value|(P6F_ALL_CPUS | P6F_ALL_CTRS)
define|#
directive|define
name|P6_EVENT_VALID_FOR_CPU
parameter_list|(
name|P
parameter_list|,
name|CPU
parameter_list|)
value|((P)->pm_flags& (1<< (CPU)))
define|#
directive|define
name|P6_EVENT_VALID_FOR_CTR
parameter_list|(
name|P
parameter_list|,
name|CTR
parameter_list|)
value|((P)->pm_flags& (1<< (CTR)))
name|P6_EVDESCR
argument_list|(
name|DATA_MEM_REFS
argument_list|,
literal|0x43
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|DCU_LINES_IN
argument_list|,
literal|0x45
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|DCU_M_LINES_IN
argument_list|,
literal|0x46
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|DCU_M_LINES_OUT
argument_list|,
literal|0x47
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|DCU_MISS_OUTSTANDING
argument_list|,
literal|0x47
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|IFU_FETCH
argument_list|,
literal|0x80
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|IFU_FETCH_MISS
argument_list|,
literal|0x81
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|ITLB_MISS
argument_list|,
literal|0x85
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|IFU_MEM_STALL
argument_list|,
literal|0x86
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|ILD_STALL
argument_list|,
literal|0x87
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_IFETCH
argument_list|,
literal|0x28
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x0F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_LD
argument_list|,
literal|0x29
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x0F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_ST
argument_list|,
literal|0x2A
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x0F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_LINES_IN
argument_list|,
literal|0x24
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x0F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_LINES_OUT
argument_list|,
literal|0x26
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x0F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_M_LINES_INM
argument_list|,
literal|0x25
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_M_LINES_OUTM
argument_list|,
literal|0x27
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x0F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_RQSTS
argument_list|,
literal|0x2E
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x0F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_ADS
argument_list|,
literal|0x21
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_DBUS_BUSY
argument_list|,
literal|0x22
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|L2_DBUS_BUSY_RD
argument_list|,
literal|0x23
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_DRDY_CLOCKS
argument_list|,
literal|0x62
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_LOCK_CLOCKS
argument_list|,
literal|0x63
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_REQ_OUTSTANDING
argument_list|,
literal|0x60
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRAN_BRD
argument_list|,
literal|0x65
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRAN_RFO
argument_list|,
literal|0x66
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRANS_WB
argument_list|,
literal|0x67
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRAN_IFETCH
argument_list|,
literal|0x68
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRAN_INVAL
argument_list|,
literal|0x69
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRAN_PWR
argument_list|,
literal|0x6A
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRANS_P
argument_list|,
literal|0x6B
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRANS_IO
argument_list|,
literal|0x6C
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRAN_DEF
argument_list|,
literal|0x6D
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRAN_BURST
argument_list|,
literal|0x6E
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRAN_ANY
argument_list|,
literal|0x70
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_TRAN_MEM
argument_list|,
literal|0x6F
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x20
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_DATA_RCV
argument_list|,
literal|0x64
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_BNR_DRV
argument_list|,
literal|0x61
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_HIT_DRV
argument_list|,
literal|0x7A
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_HITM_DRV
argument_list|,
literal|0x7B
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BUS_SNOOP_STALL
argument_list|,
literal|0x7E
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|FLOPS
argument_list|,
literal|0xC1
argument_list|,
name|P6F_ALL_CPUS
operator||
name|P6F_CTR0
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|FP_COMPS_OPS_EXE
argument_list|,
literal|0x10
argument_list|,
name|P6F_ALL_CPUS
operator||
name|P6F_CTR0
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|FP_ASSIST
argument_list|,
literal|0x11
argument_list|,
name|P6F_ALL_CPUS
operator||
name|P6F_CTR1
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|MUL
argument_list|,
literal|0x12
argument_list|,
name|P6F_ALL_CPUS
operator||
name|P6F_CTR1
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|DIV
argument_list|,
literal|0x13
argument_list|,
name|P6F_ALL_CPUS
operator||
name|P6F_CTR1
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|CYCLES_DIV_BUSY
argument_list|,
literal|0x14
argument_list|,
name|P6F_ALL_CPUS
operator||
name|P6F_CTR0
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|LD_BLOCKS
argument_list|,
literal|0x03
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|SB_DRAINS
argument_list|,
literal|0x04
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|MISALIGN_MEM_REF
argument_list|,
literal|0x05
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_KNI_PREF_DISPATCHED
argument_list|,
literal|0x07
argument_list|,
name|P6F_PIII
operator||
name|P6F_ALL_CTRS
argument_list|,
literal|0x03
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_KNI_PREF_MISS
argument_list|,
literal|0x4B
argument_list|,
name|P6F_PIII
operator||
name|P6F_ALL_CTRS
argument_list|,
literal|0x03
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|INST_RETIRED
argument_list|,
literal|0xC0
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|UOPS_RETIRED
argument_list|,
literal|0xC2
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|INST_DECODED
argument_list|,
literal|0xD0
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_KNI_INST_RETIRED
argument_list|,
literal|0xD8
argument_list|,
name|P6F_PIII
operator||
name|P6F_ALL_CTRS
argument_list|,
literal|0x01
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_KNI_COMP_INST_RET
argument_list|,
literal|0xD9
argument_list|,
name|P6F_PIII
operator||
name|P6F_ALL_CTRS
argument_list|,
literal|0x01
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|HW_INT_RX
argument_list|,
literal|0xC8
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|CYCLES_INT_MASKED
argument_list|,
literal|0xC6
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|CYCLES_INT_PENDING_AND_MASKED
argument_list|,
literal|0xC7
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_INST_RETIRED
argument_list|,
literal|0xC4
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_MISS_PRED_RETIRED
argument_list|,
literal|0xC5
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_TAKEN_RETIRED
argument_list|,
literal|0xC9
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_MISS_PRED_TAKEN_RET
argument_list|,
literal|0xCA
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_INST_DECODED
argument_list|,
literal|0xE0
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BTB_MISSES
argument_list|,
literal|0xE2
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_BOGUS
argument_list|,
literal|0xE4
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BACLEARS
argument_list|,
literal|0xE6
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|RESOURCE_STALLS
argument_list|,
literal|0xA2
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|PARTIAL_RAT_STALLS
argument_list|,
literal|0xD2
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|SEGMENT_REG_LOADS
argument_list|,
literal|0x06
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|CPU_CLK_UNHALTED
argument_list|,
literal|0x79
argument_list|,
name|P6F_ALL
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|MMX_INSTR_EXEC
argument_list|,
literal|0xB0
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_CL
operator||
name|P6F_PII
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|MMX_SAT_INSTR_EXEC
argument_list|,
literal|0xB1
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PII
operator||
name|P6F_PIII
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|MMX_UOPS_EXEC
argument_list|,
literal|0xB2
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PII
operator||
name|P6F_PIII
argument_list|,
literal|0x0F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|MMX_INSTR_TYPE_EXEC
argument_list|,
literal|0xB3
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PII
operator||
name|P6F_PIII
argument_list|,
literal|0x3F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|FP_MMX_TRANS
argument_list|,
literal|0xCC
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PII
operator||
name|P6F_PIII
argument_list|,
literal|0x01
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|MMX_ASSIST
argument_list|,
literal|0xCD
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PII
operator||
name|P6F_PIII
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|MMX_INSTR_RET
argument_list|,
literal|0xCE
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PII
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|SEG_RENAME_STALLS
argument_list|,
literal|0xD4
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PII
operator||
name|P6F_PIII
argument_list|,
literal|0x0F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|SEG_REG_RENAMES
argument_list|,
literal|0xD5
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PII
operator||
name|P6F_PIII
argument_list|,
literal|0x0F
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|RET_SEG_RENAMES
argument_list|,
literal|0xD6
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PII
operator||
name|P6F_PIII
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_EST_TRANS
argument_list|,
literal|0x58
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x02
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_THERMAL_TRIP
argument_list|,
literal|0x59
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_INST_EXEC
argument_list|,
literal|0x88
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_MISSP_EXEC
argument_list|,
literal|0x89
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_BAC_MISSP_EXEC
argument_list|,
literal|0x8A
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_CND_EXEC
argument_list|,
literal|0x8B
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_CND_MISSP_EXEC
argument_list|,
literal|0x8C
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_IND_EXEC
argument_list|,
literal|0x8D
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_IND_MISSP_EXEC
argument_list|,
literal|0x8E
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_RET_EXEC
argument_list|,
literal|0x8F
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_RET_MISSP_EXEC
argument_list|,
literal|0x90
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_RET_BAC_MISSP_EXEC
argument_list|,
literal|0x91
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_CALL_EXEC
argument_list|,
literal|0x92
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_CALL_MISSP_EXEC
argument_list|,
literal|0x93
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|BR_IND_CALL_EXEC
argument_list|,
literal|0x94
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_SIMD_INSTR_RETIRED
argument_list|,
literal|0xCE
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_SYNCH_UOPS
argument_list|,
literal|0xD3
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_ESP_UOPS
argument_list|,
literal|0xD7
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_FUSED_UOPS_RET
argument_list|,
literal|0xDA
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x03
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_UNFUSION
argument_list|,
literal|0xDB
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_PREF_RQSTS_UP
argument_list|,
literal|0xF0
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_PREF_RQSTS_DN
argument_list|,
literal|0xD8
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x00
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
name|EMON_SSE_SSE2_INST_RETIRED
argument_list|,
literal|0xD8
argument_list|,
name|P6F_ALL_CTRS
operator||
name|P6F_PM
argument_list|,
literal|0x03
argument_list|)
block|,
name|P6_EVDESCR
argument_list|(
argument|EMON_SSE_SSE2_COMP_INST_RETIRED
argument_list|,
literal|0xD9
argument_list|,
argument|P6F_ALL_CTRS | P6F_PM
argument_list|,
literal|0x03
argument_list|)
undef|#
directive|undef
name|P6_EVDESCR
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|P6_NEVENTS
value|(PMC_EV_P6_LAST - PMC_EV_P6_FIRST + 1)
end_define

begin_function
specifier|static
specifier|const
name|struct
name|p6_event_descr
modifier|*
name|p6_find_event
parameter_list|(
name|enum
name|pmc_event
name|ev
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|P6_NEVENTS
condition|;
name|n
operator|++
control|)
if|if
condition|(
name|p6_events
index|[
name|n
index|]
operator|.
name|pm_event
operator|==
name|ev
condition|)
break|break;
if|if
condition|(
name|n
operator|==
name|P6_NEVENTS
condition|)
return|return
name|NULL
return|;
return|return
operator|&
name|p6_events
index|[
name|n
index|]
return|;
block|}
end_function

begin_comment
comment|/*  * Per-CPU data structure for P6 class CPUs  *  * [common stuff]  * [3 struct pmc_hw pointers]  * [3 struct pmc_hw structures]  */
end_comment

begin_struct
struct|struct
name|p6_cpu
block|{
name|struct
name|pmc_cpu
name|pc_common
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|pc_hwpmcs
index|[
name|P6_NPMCS
index|]
decl_stmt|;
name|struct
name|pmc_hw
name|pc_p6pmcs
index|[
name|P6_NPMCS
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|p6_init
parameter_list|(
name|int
name|cpu
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|struct
name|p6_cpu
modifier|*
name|pcs
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|mp_ncpus
argument_list|,
operator|(
literal|"[p6,%d] bad cpu %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|INI
argument_list|,
literal|0
argument_list|,
literal|"p6-init cpu=%d"
argument_list|,
name|cpu
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|pcs
argument_list|,
expr|struct
name|p6_cpu
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|p6_cpu
argument_list|)
argument_list|,
name|M_PMC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcs
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|phw
operator|=
name|pcs
operator|->
name|pc_p6pmcs
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|P6_NPMCS
condition|;
name|n
operator|++
operator|,
name|phw
operator|++
control|)
block|{
name|phw
operator|->
name|phw_state
operator|=
name|PMC_PHW_FLAG_IS_ENABLED
operator||
name|PMC_PHW_CPU_TO_STATE
argument_list|(
name|cpu
argument_list|)
operator||
name|PMC_PHW_INDEX_TO_STATE
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|phw
operator|->
name|phw_pmc
operator|=
name|NULL
expr_stmt|;
name|pcs
operator|->
name|pc_hwpmcs
index|[
name|n
index|]
operator|=
name|phw
expr_stmt|;
block|}
comment|/* Mark the TSC as shareable */
name|pcs
operator|->
name|pc_hwpmcs
index|[
literal|0
index|]
operator|->
name|phw_state
operator||=
name|PMC_PHW_FLAG_IS_SHAREABLE
expr_stmt|;
name|pmc_pcpu
index|[
name|cpu
index|]
operator|=
operator|(
expr|struct
name|pmc_cpu
operator|*
operator|)
name|pcs
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_cleanup
parameter_list|(
name|int
name|cpu
parameter_list|)
block|{
name|struct
name|pmc_cpu
modifier|*
name|pcs
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|mp_ncpus
argument_list|,
operator|(
literal|"[p6,%d] bad cpu %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|INI
argument_list|,
literal|0
argument_list|,
literal|"p6-cleanup cpu=%d"
argument_list|,
name|cpu
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pcs
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
operator|)
operator|!=
name|NULL
condition|)
name|FREE
argument_list|(
name|pcs
argument_list|,
name|M_PMC
argument_list|)
expr_stmt|;
name|pmc_pcpu
index|[
name|cpu
index|]
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_switch_in
parameter_list|(
name|struct
name|pmc_cpu
modifier|*
name|pc
parameter_list|,
name|struct
name|pmc_process
modifier|*
name|pp
parameter_list|)
block|{
operator|(
name|void
operator|)
name|pc
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|SWI
argument_list|,
literal|1
argument_list|,
literal|"pc=%p pp=%p enable-msr=%d"
argument_list|,
name|pc
argument_list|,
name|pp
argument_list|,
name|pp
operator|->
name|pp_flags
operator|&
name|PMC_PP_ENABLE_MSR_ACCESS
argument_list|)
expr_stmt|;
comment|/* allow the RDPMC instruction if needed */
if|if
condition|(
name|pp
operator|->
name|pp_flags
operator|&
name|PMC_PP_ENABLE_MSR_ACCESS
condition|)
name|load_cr4
argument_list|(
name|rcr4
argument_list|()
operator||
name|CR4_PCE
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|SWI
argument_list|,
literal|1
argument_list|,
literal|"cr4=0x%x"
argument_list|,
name|rcr4
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_switch_out
parameter_list|(
name|struct
name|pmc_cpu
modifier|*
name|pc
parameter_list|,
name|struct
name|pmc_process
modifier|*
name|pp
parameter_list|)
block|{
operator|(
name|void
operator|)
name|pc
expr_stmt|;
operator|(
name|void
operator|)
name|pp
expr_stmt|;
comment|/* can be NULL */
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|SWO
argument_list|,
literal|1
argument_list|,
literal|"pc=%p pp=%p cr4=0x%x"
argument_list|,
name|pc
argument_list|,
name|pp
argument_list|,
name|rcr4
argument_list|()
argument_list|)
expr_stmt|;
comment|/* always turn off the RDPMC instruction */
name|load_cr4
argument_list|(
name|rcr4
argument_list|()
operator|&
operator|~
name|CR4_PCE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_read_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|pmc_value_t
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|struct
name|p6pmc_descr
modifier|*
name|pd
decl_stmt|;
name|pmc_value_t
name|tmp
decl_stmt|;
name|phw
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_hwpmcs
index|[
name|ri
index|]
expr_stmt|;
name|pm
operator|=
name|phw
operator|->
name|phw_pmc
expr_stmt|;
name|pd
operator|=
operator|&
name|p6_pmcdesc
index|[
name|ri
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|pm
argument_list|,
operator|(
literal|"[p6,%d] cpu %d ri %d pmc not configured"
operator|,
name|__LINE__
operator|,
name|cpu
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
operator|==
name|PMC_CLASS_TSC
condition|)
return|return
literal|0
return|;
name|tmp
operator|=
name|rdmsr
argument_list|(
name|pd
operator|->
name|pm_pmc_msr
argument_list|)
operator|&
name|P6_PERFCTR_MASK
expr_stmt|;
if|if
condition|(
name|PMC_IS_SAMPLING_MODE
argument_list|(
name|PMC_TO_MODE
argument_list|(
name|pm
argument_list|)
argument_list|)
condition|)
operator|*
name|v
operator|=
operator|-
name|tmp
expr_stmt|;
else|else
operator|*
name|v
operator|=
name|tmp
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|REA
argument_list|,
literal|1
argument_list|,
literal|"p6-read cpu=%d ri=%d msr=0x%x -> v=%jx"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|,
name|pd
operator|->
name|pm_pmc_msr
argument_list|,
operator|*
name|v
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_write_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|pmc_value_t
name|v
parameter_list|)
block|{
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|struct
name|p6pmc_descr
modifier|*
name|pd
decl_stmt|;
name|phw
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_hwpmcs
index|[
name|ri
index|]
expr_stmt|;
name|pm
operator|=
name|phw
operator|->
name|phw_pmc
expr_stmt|;
name|pd
operator|=
operator|&
name|p6_pmcdesc
index|[
name|ri
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|pm
argument_list|,
operator|(
literal|"[p6,%d] cpu %d ri %d pmc not configured"
operator|,
name|__LINE__
operator|,
name|cpu
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
operator|==
name|PMC_CLASS_TSC
condition|)
return|return
literal|0
return|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|WRI
argument_list|,
literal|1
argument_list|,
literal|"p6-write cpu=%d ri=%d msr=0x%x v=%jx"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|,
name|pd
operator|->
name|pm_pmc_msr
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|PMC_IS_SAMPLING_MODE
argument_list|(
name|PMC_TO_MODE
argument_list|(
name|pm
argument_list|)
argument_list|)
condition|)
name|v
operator|=
operator|-
name|v
expr_stmt|;
name|wrmsr
argument_list|(
name|pd
operator|->
name|pm_pmc_msr
argument_list|,
name|v
operator|&
name|P6_PERFCTR_MASK
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_config_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc
modifier|*
name|pm
parameter_list|)
block|{
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|CFG
argument_list|,
literal|1
argument_list|,
literal|"p6-config cpu=%d ri=%d pm=%p"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|,
name|pm
argument_list|)
expr_stmt|;
name|phw
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_hwpmcs
index|[
name|ri
index|]
expr_stmt|;
name|phw
operator|->
name|phw_pmc
operator|=
name|pm
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Retrieve a configured PMC pointer from hardware state.  */
end_comment

begin_function
specifier|static
name|int
name|p6_get_config
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc
modifier|*
modifier|*
name|ppm
parameter_list|)
block|{
operator|*
name|ppm
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_hwpmcs
index|[
name|ri
index|]
operator|->
name|phw_pmc
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * A pmc may be allocated to a given row index if:  * - the event is valid for this CPU  * - the event is valid for this counter index  */
end_comment

begin_function
specifier|static
name|int
name|p6_allocate_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc
modifier|*
name|pm
parameter_list|,
specifier|const
name|struct
name|pmc_op_pmcallocate
modifier|*
name|a
parameter_list|)
block|{
name|uint32_t
name|allowed_unitmask
decl_stmt|,
name|caps
decl_stmt|,
name|config
decl_stmt|,
name|unitmask
decl_stmt|;
specifier|const
name|struct
name|p6pmc_descr
modifier|*
name|pd
decl_stmt|;
specifier|const
name|struct
name|p6_event_descr
modifier|*
name|pevent
decl_stmt|;
name|enum
name|pmc_event
name|ev
decl_stmt|;
operator|(
name|void
operator|)
name|cpu
expr_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|mp_ncpus
argument_list|,
operator|(
literal|"[p4,%d] illegal CPU %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|P6_NPMCS
argument_list|,
operator|(
literal|"[p4,%d] illegal row-index value %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|pd
operator|=
operator|&
name|p6_pmcdesc
index|[
name|ri
index|]
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|ALL
argument_list|,
literal|1
argument_list|,
literal|"p6-allocate ri=%d class=%d pmccaps=0x%x "
literal|"reqcaps=0x%x"
argument_list|,
name|ri
argument_list|,
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
argument_list|,
name|pd
operator|->
name|pm_descr
operator|.
name|pd_caps
argument_list|,
name|pm
operator|->
name|pm_caps
argument_list|)
expr_stmt|;
comment|/* check class */
if|if
condition|(
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
operator|!=
name|a
operator|->
name|pm_class
condition|)
return|return
name|EINVAL
return|;
comment|/* check requested capabilities */
name|caps
operator|=
name|a
operator|->
name|pm_caps
expr_stmt|;
if|if
condition|(
operator|(
name|pd
operator|->
name|pm_descr
operator|.
name|pd_caps
operator|&
name|caps
operator|)
operator|!=
name|caps
condition|)
return|return
name|EPERM
return|;
if|if
condition|(
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
operator|==
name|PMC_CLASS_TSC
condition|)
block|{
comment|/* TSC's are always allocated in system-wide counting mode */
if|if
condition|(
name|a
operator|->
name|pm_ev
operator|!=
name|PMC_EV_TSC_TSC
operator|||
name|a
operator|->
name|pm_mode
operator|!=
name|PMC_MODE_SC
condition|)
return|return
name|EINVAL
return|;
return|return
literal|0
return|;
block|}
comment|/* 	 * P6 class events 	 */
name|ev
operator|=
name|pm
operator|->
name|pm_event
expr_stmt|;
if|if
condition|(
name|ev
operator|<
name|PMC_EV_P6_FIRST
operator|||
name|ev
operator|>
name|PMC_EV_P6_LAST
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|(
name|pevent
operator|=
name|p6_find_event
argument_list|(
name|ev
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|ESRCH
return|;
if|if
condition|(
operator|!
name|P6_EVENT_VALID_FOR_CPU
argument_list|(
name|pevent
argument_list|,
name|p6_cputype
argument_list|)
operator|||
operator|!
name|P6_EVENT_VALID_FOR_CTR
argument_list|(
name|pevent
argument_list|,
operator|(
name|ri
operator|-
literal|1
operator|)
argument_list|)
condition|)
return|return
name|EINVAL
return|;
comment|/* For certain events, Pentium M differs from the stock P6 */
name|allowed_unitmask
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p6_cputype
operator|==
name|PMC_CPU_INTEL_PM
condition|)
block|{
if|if
condition|(
name|ev
operator|==
name|PMC_EV_P6_L2_LD
operator|||
name|ev
operator|==
name|PMC_EV_P6_L2_LINES_IN
operator|||
name|ev
operator|==
name|PMC_EV_P6_L2_LINES_OUT
condition|)
name|allowed_unitmask
operator|=
name|P6_EVSEL_TO_UMASK
argument_list|(
literal|0x3F
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ev
operator|==
name|PMC_EV_P6_L2_M_LINES_OUTM
condition|)
name|allowed_unitmask
operator|=
name|P6_EVSEL_TO_UMASK
argument_list|(
literal|0x30
argument_list|)
expr_stmt|;
block|}
else|else
name|allowed_unitmask
operator|=
name|P6_EVSEL_TO_UMASK
argument_list|(
name|pevent
operator|->
name|pm_unitmask
argument_list|)
expr_stmt|;
name|unitmask
operator|=
name|a
operator|->
name|pm_p6_config
operator|&
name|P6_EVSEL_UMASK_MASK
expr_stmt|;
if|if
condition|(
name|unitmask
operator|&
operator|~
name|allowed_unitmask
condition|)
comment|/* disallow reserved bits */
return|return
name|EINVAL
return|;
if|if
condition|(
name|ev
operator|==
name|PMC_EV_P6_MMX_UOPS_EXEC
condition|)
comment|/* hardcoded mask */
name|unitmask
operator|=
name|P6_EVSEL_TO_UMASK
argument_list|(
literal|0x0F
argument_list|)
expr_stmt|;
name|config
operator|=
literal|0
expr_stmt|;
name|config
operator||=
name|P6_EVSEL_EVENT_SELECT
argument_list|(
name|pevent
operator|->
name|pm_evsel
argument_list|)
expr_stmt|;
if|if
condition|(
name|unitmask
operator|&
operator|(
name|caps
operator|&
name|PMC_CAP_QUALIFIER
operator|)
condition|)
name|config
operator||=
name|unitmask
expr_stmt|;
if|if
condition|(
name|caps
operator|&
name|PMC_CAP_THRESHOLD
condition|)
name|config
operator||=
name|a
operator|->
name|pm_p6_config
operator|&
name|P6_EVSEL_CMASK_MASK
expr_stmt|;
comment|/* set at least one of the 'usr' or 'os' caps */
if|if
condition|(
name|caps
operator|&
name|PMC_CAP_USER
condition|)
name|config
operator||=
name|P6_EVSEL_USR
expr_stmt|;
if|if
condition|(
name|caps
operator|&
name|PMC_CAP_SYSTEM
condition|)
name|config
operator||=
name|P6_EVSEL_OS
expr_stmt|;
if|if
condition|(
operator|(
name|caps
operator|&
operator|(
name|PMC_CAP_USER
operator||
name|PMC_CAP_SYSTEM
operator|)
operator|)
operator|==
literal|0
condition|)
name|config
operator||=
operator|(
name|P6_EVSEL_USR
operator||
name|P6_EVSEL_OS
operator|)
expr_stmt|;
if|if
condition|(
name|caps
operator|&
name|PMC_CAP_EDGE
condition|)
name|config
operator||=
name|P6_EVSEL_E
expr_stmt|;
if|if
condition|(
name|caps
operator|&
name|PMC_CAP_INVERT
condition|)
name|config
operator||=
name|P6_EVSEL_INV
expr_stmt|;
if|if
condition|(
name|caps
operator|&
name|PMC_CAP_INTERRUPT
condition|)
name|config
operator||=
name|P6_EVSEL_INT
expr_stmt|;
name|pm
operator|->
name|pm_md
operator|.
name|pm_p6
operator|.
name|pm_p6_evsel
operator|=
name|config
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|ALL
argument_list|,
literal|2
argument_list|,
literal|"p6-allocate config=0x%x"
argument_list|,
name|config
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_release_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc
modifier|*
name|pm
parameter_list|)
block|{
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
operator|(
name|void
operator|)
name|pm
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|REL
argument_list|,
literal|1
argument_list|,
literal|"p6-release cpu=%d ri=%d pm=%p"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|,
name|pm
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|mp_ncpus
argument_list|,
operator|(
literal|"[p6,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|P6_NPMCS
argument_list|,
operator|(
literal|"[p6,%d] illegal row-index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|phw
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_hwpmcs
index|[
name|ri
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|phw
operator|->
name|phw_pmc
operator|==
name|NULL
argument_list|,
operator|(
literal|"[p6,%d] PHW pmc %p != pmc %p"
operator|,
name|__LINE__
operator|,
name|phw
operator|->
name|phw_pmc
operator|,
name|pm
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_start_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|)
block|{
name|uint32_t
name|config
decl_stmt|;
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
specifier|const
name|struct
name|p6pmc_descr
modifier|*
name|pd
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|mp_ncpus
argument_list|,
operator|(
literal|"[p6,%d] illegal CPU value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|P6_NPMCS
argument_list|,
operator|(
literal|"[p6,%d] illegal row-index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|phw
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_hwpmcs
index|[
name|ri
index|]
expr_stmt|;
name|pm
operator|=
name|phw
operator|->
name|phw_pmc
expr_stmt|;
name|pd
operator|=
operator|&
name|p6_pmcdesc
index|[
name|ri
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|pm
argument_list|,
operator|(
literal|"[p6,%d] starting cpu%d,ri%d with no pmc configured"
operator|,
name|__LINE__
operator|,
name|cpu
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|STA
argument_list|,
literal|1
argument_list|,
literal|"p6-start cpu=%d ri=%d"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
operator|==
name|PMC_CLASS_TSC
condition|)
return|return
literal|0
return|;
comment|/* TSC are always running */
name|KASSERT
argument_list|(
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
operator|==
name|PMC_CLASS_P6
argument_list|,
operator|(
literal|"[p6,%d] unknown PMC class %d"
operator|,
name|__LINE__
operator|,
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
operator|)
argument_list|)
expr_stmt|;
name|config
operator|=
name|pm
operator|->
name|pm_md
operator|.
name|pm_p6
operator|.
name|pm_p6_evsel
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|STA
argument_list|,
literal|2
argument_list|,
literal|"p6-start/2 cpu=%d ri=%d evselmsr=0x%x config=0x%x"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|,
name|pd
operator|->
name|pm_evsel_msr
argument_list|,
name|config
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|pm_evsel_msr
operator|==
name|P6_MSR_EVSEL0
condition|)
comment|/* CTR 0 */
name|wrmsr
argument_list|(
name|pd
operator|->
name|pm_evsel_msr
argument_list|,
name|config
operator||
name|P6_EVSEL_EN
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* CTR1 shares the enable bit CTR 0 */
name|wrmsr
argument_list|(
name|pd
operator|->
name|pm_evsel_msr
argument_list|,
name|config
argument_list|)
expr_stmt|;
name|wrmsr
argument_list|(
name|P6_MSR_EVSEL0
argument_list|,
name|rdmsr
argument_list|(
name|P6_MSR_EVSEL0
argument_list|)
operator||
name|P6_EVSEL_EN
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_stop_pmc
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|)
block|{
name|uint32_t
name|config
decl_stmt|;
name|struct
name|pmc
modifier|*
name|pm
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|struct
name|p6pmc_descr
modifier|*
name|pd
decl_stmt|;
name|KASSERT
argument_list|(
name|cpu
operator|>=
literal|0
operator|&&
name|cpu
operator|<
name|mp_ncpus
argument_list|,
operator|(
literal|"[p6,%d] illegal cpu value %d"
operator|,
name|__LINE__
operator|,
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|P6_NPMCS
argument_list|,
operator|(
literal|"[p6,%d] illegal row index %d"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
name|phw
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_hwpmcs
index|[
name|ri
index|]
expr_stmt|;
name|pm
operator|=
name|phw
operator|->
name|phw_pmc
expr_stmt|;
name|pd
operator|=
operator|&
name|p6_pmcdesc
index|[
name|ri
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|pm
argument_list|,
operator|(
literal|"[p6,%d] cpu%d ri%d no configured PMC to stop"
operator|,
name|__LINE__
operator|,
name|cpu
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
operator|==
name|PMC_CLASS_TSC
condition|)
return|return
literal|0
return|;
name|KASSERT
argument_list|(
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
operator|==
name|PMC_CLASS_P6
argument_list|,
operator|(
literal|"[p6,%d] unknown PMC class %d"
operator|,
name|__LINE__
operator|,
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
operator|)
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|STO
argument_list|,
literal|1
argument_list|,
literal|"p6-stop cpu=%d ri=%d"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|)
expr_stmt|;
comment|/* 	 * If CTR0 is being turned off but CTR1 is active, we need 	 * leave CTR0's EN field set.  If CTR1 is being stopped, it 	 * suffices to zero its EVSEL register. 	 */
if|if
condition|(
name|ri
operator|==
literal|1
operator|&&
name|pmc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_hwpmcs
index|[
literal|2
index|]
operator|->
name|phw_pmc
operator|!=
name|NULL
condition|)
name|config
operator|=
name|P6_EVSEL_EN
expr_stmt|;
else|else
name|config
operator|=
literal|0
expr_stmt|;
name|wrmsr
argument_list|(
name|pd
operator|->
name|pm_evsel_msr
argument_list|,
name|config
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|STO
argument_list|,
literal|2
argument_list|,
literal|"p6-stop/2 cpu=%d ri=%d config=0x%x"
argument_list|,
name|cpu
argument_list|,
name|ri
argument_list|,
name|config
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_intr
parameter_list|(
name|int
name|cpu
parameter_list|,
name|uintptr_t
name|eip
parameter_list|)
block|{
operator|(
name|void
operator|)
name|cpu
expr_stmt|;
operator|(
name|void
operator|)
name|eip
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_describe
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|ri
parameter_list|,
name|struct
name|pmc_info
modifier|*
name|pi
parameter_list|,
name|struct
name|pmc
modifier|*
modifier|*
name|ppmc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|size_t
name|copied
decl_stmt|;
name|struct
name|pmc_hw
modifier|*
name|phw
decl_stmt|;
name|struct
name|p6pmc_descr
modifier|*
name|pd
decl_stmt|;
name|phw
operator|=
name|pmc_pcpu
index|[
name|cpu
index|]
operator|->
name|pc_hwpmcs
index|[
name|ri
index|]
expr_stmt|;
name|pd
operator|=
operator|&
name|p6_pmcdesc
index|[
name|ri
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copystr
argument_list|(
name|pd
operator|->
name|pm_descr
operator|.
name|pd_name
argument_list|,
name|pi
operator|->
name|pm_name
argument_list|,
name|PMC_NAME_MAX
argument_list|,
operator|&
name|copied
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|pi
operator|->
name|pm_class
operator|=
name|pd
operator|->
name|pm_descr
operator|.
name|pd_class
expr_stmt|;
if|if
condition|(
name|phw
operator|->
name|phw_state
operator|&
name|PMC_PHW_FLAG_IS_ENABLED
condition|)
block|{
name|pi
operator|->
name|pm_enabled
operator|=
name|TRUE
expr_stmt|;
operator|*
name|ppmc
operator|=
name|phw
operator|->
name|phw_pmc
expr_stmt|;
block|}
else|else
block|{
name|pi
operator|->
name|pm_enabled
operator|=
name|FALSE
expr_stmt|;
operator|*
name|ppmc
operator|=
name|NULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p6_get_msr
parameter_list|(
name|int
name|ri
parameter_list|,
name|uint32_t
modifier|*
name|msr
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|ri
operator|>=
literal|0
operator|&&
name|ri
operator|<
name|P6_NPMCS
argument_list|,
operator|(
literal|"[p6,%d ri %d out of range"
operator|,
name|__LINE__
operator|,
name|ri
operator|)
argument_list|)
expr_stmt|;
operator|*
name|msr
operator|=
name|p6_pmcdesc
index|[
name|ri
index|]
operator|.
name|pm_pmc_msr
operator|-
name|P6_MSR_PERFCTR0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_initialize_p6
parameter_list|(
name|struct
name|pmc_mdep
modifier|*
name|pmc_mdep
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|strcmp
argument_list|(
name|cpu_vendor
argument_list|,
literal|"GenuineIntel"
argument_list|)
operator|==
literal|0
argument_list|,
operator|(
literal|"[p6,%d] Initializing non-intel processor"
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
name|PMCDBG
argument_list|(
name|MDP
argument_list|,
name|INI
argument_list|,
literal|1
argument_list|,
literal|"%s"
argument_list|,
literal|"p6-initialize"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pmc_mdep
operator|->
name|pmd_cputype
condition|)
block|{
comment|/* 		 * P6 Family Processors 		 */
case|case
name|PMC_CPU_INTEL_P6
case|:
case|case
name|PMC_CPU_INTEL_CL
case|:
case|case
name|PMC_CPU_INTEL_PII
case|:
case|case
name|PMC_CPU_INTEL_PIII
case|:
case|case
name|PMC_CPU_INTEL_PM
case|:
name|p6_cputype
operator|=
name|pmc_mdep
operator|->
name|pmd_cputype
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_npmc
operator|=
name|P6_NPMCS
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_classes
index|[
literal|1
index|]
operator|.
name|pm_class
operator|=
name|PMC_CLASS_P6
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_classes
index|[
literal|1
index|]
operator|.
name|pm_caps
operator|=
name|P6_PMC_CAPS
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_classes
index|[
literal|1
index|]
operator|.
name|pm_width
operator|=
literal|40
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_nclasspmcs
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_init
operator|=
name|p6_init
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_cleanup
operator|=
name|p6_cleanup
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_switch_in
operator|=
name|p6_switch_in
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_switch_out
operator|=
name|p6_switch_out
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_read_pmc
operator|=
name|p6_read_pmc
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_write_pmc
operator|=
name|p6_write_pmc
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_config_pmc
operator|=
name|p6_config_pmc
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_get_config
operator|=
name|p6_get_config
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_allocate_pmc
operator|=
name|p6_allocate_pmc
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_release_pmc
operator|=
name|p6_release_pmc
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_start_pmc
operator|=
name|p6_start_pmc
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_stop_pmc
operator|=
name|p6_stop_pmc
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_intr
operator|=
name|p6_intr
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_describe
operator|=
name|p6_describe
expr_stmt|;
name|pmc_mdep
operator|->
name|pmd_get_msr
operator|=
name|p6_get_msr
expr_stmt|;
comment|/* i386 */
break|break;
default|default:
name|KASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"[p6,%d] Unknown CPU type"
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) Paul Mackerras 2005.  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE AUTHOR BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,  * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,  * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS  * IN THE SOFTWARE.  *  * Authors:  *    Paul Mackerras<paulus@samba.org>  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_compat.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|COMPAT_FREEBSD32
end_ifdef

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm.h>
end_include

begin_comment
comment|/** @file drm_ioc32.c  * 32-bit ioctl compatibility routines for the DRM.  */
end_comment

begin_define
define|#
directive|define
name|DRM_IOCTL_VERSION32
value|DRM_IOWR(0x00, drm_version32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_GET_UNIQUE32
value|DRM_IOWR(0x01, drm_unique32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_GET_MAP32
value|DRM_IOWR(0x04, drm_map32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_GET_CLIENT32
value|DRM_IOWR(0x05, drm_client32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_GET_STATS32
value|DRM_IOR( 0x06, drm_stats32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_SET_UNIQUE32
value|DRM_IOW( 0x10, drm_unique32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_ADD_MAP32
value|DRM_IOWR(0x15, drm_map32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_ADD_BUFS32
value|DRM_IOWR(0x16, drm_buf_desc32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_MARK_BUFS32
value|DRM_IOW( 0x17, drm_buf_desc32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_INFO_BUFS32
value|DRM_IOWR(0x18, drm_buf_info32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_MAP_BUFS32
value|DRM_IOWR(0x19, drm_buf_map32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_FREE_BUFS32
value|DRM_IOW( 0x1a, drm_buf_free32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_RM_MAP32
value|DRM_IOW( 0x1b, drm_map32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_SET_SAREA_CTX32
value|DRM_IOW( 0x1c, drm_ctx_priv_map32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_GET_SAREA_CTX32
value|DRM_IOWR(0x1d, drm_ctx_priv_map32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_RES_CTX32
value|DRM_IOWR(0x26, drm_ctx_res32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_DMA32
value|DRM_IOWR(0x29, drm_dma32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_AGP_ENABLE32
value|DRM_IOW( 0x32, drm_agp_mode32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_AGP_INFO32
value|DRM_IOR( 0x33, drm_agp_info32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_AGP_ALLOC32
value|DRM_IOWR(0x34, drm_agp_buffer32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_AGP_FREE32
value|DRM_IOW( 0x35, drm_agp_buffer32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_AGP_BIND32
value|DRM_IOW( 0x36, drm_agp_binding32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_AGP_UNBIND32
value|DRM_IOW( 0x37, drm_agp_binding32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_SG_ALLOC32
value|DRM_IOW( 0x38, drm_scatter_gather32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_SG_FREE32
value|DRM_IOW( 0x39, drm_scatter_gather32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_UPDATE_DRAW32
value|DRM_IOW( 0x3f, drm_update_draw32_t)
end_define

begin_define
define|#
directive|define
name|DRM_IOCTL_WAIT_VBLANK32
value|DRM_IOWR(0x3a, drm_wait_vblank32_t)
end_define

begin_typedef
typedef|typedef
struct|struct
name|drm_version_32
block|{
name|int
name|version_major
decl_stmt|;
comment|/**< Major version */
name|int
name|version_minor
decl_stmt|;
comment|/**< Minor version */
name|int
name|version_patchlevel
decl_stmt|;
comment|/**< Patch level */
name|u32
name|name_len
decl_stmt|;
comment|/**< Length of name buffer */
name|u32
name|name
decl_stmt|;
comment|/**< Name of driver */
name|u32
name|date_len
decl_stmt|;
comment|/**< Length of date buffer */
name|u32
name|date
decl_stmt|;
comment|/**< User-space buffer to hold date */
name|u32
name|desc_len
decl_stmt|;
comment|/**< Length of desc buffer */
name|u32
name|desc
decl_stmt|;
comment|/**< User-space buffer to hold desc */
block|}
name|drm_version32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_version
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_version32_t
modifier|*
name|v32
init|=
name|data
decl_stmt|;
name|struct
name|drm_version
name|version
decl_stmt|;
name|int
name|err
decl_stmt|;
name|version
operator|.
name|name_len
operator|=
name|v32
operator|->
name|name_len
expr_stmt|;
name|version
operator|.
name|name
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|v32
operator|->
name|name
expr_stmt|;
name|version
operator|.
name|date_len
operator|=
name|v32
operator|->
name|date_len
expr_stmt|;
name|version
operator|.
name|date
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|v32
operator|->
name|date
expr_stmt|;
name|version
operator|.
name|desc_len
operator|=
name|v32
operator|->
name|desc_len
expr_stmt|;
name|version
operator|.
name|desc
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|v32
operator|->
name|desc
expr_stmt|;
name|err
operator|=
name|drm_version
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|version
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|v32
operator|->
name|version_major
operator|=
name|version
operator|.
name|version_major
expr_stmt|;
name|v32
operator|->
name|version_minor
operator|=
name|version
operator|.
name|version_minor
expr_stmt|;
name|v32
operator|->
name|version_patchlevel
operator|=
name|version
operator|.
name|version_patchlevel
expr_stmt|;
name|v32
operator|->
name|name_len
operator|=
name|version
operator|.
name|name_len
expr_stmt|;
name|v32
operator|->
name|date_len
operator|=
name|version
operator|.
name|date_len
expr_stmt|;
name|v32
operator|->
name|desc_len
operator|=
name|version
operator|.
name|desc_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_unique32
block|{
name|u32
name|unique_len
decl_stmt|;
comment|/**< Length of unique */
name|u32
name|unique
decl_stmt|;
comment|/**< Unique name for driver instantiation */
block|}
name|drm_unique32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_getunique
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_unique32_t
modifier|*
name|uq32
init|=
name|data
decl_stmt|;
name|struct
name|drm_unique
name|u
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u
operator|.
name|unique_len
operator|=
name|uq32
operator|->
name|unique_len
expr_stmt|;
name|u
operator|.
name|unique
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|uq32
operator|->
name|unique
expr_stmt|;
name|err
operator|=
name|drm_getunique
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|u
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|uq32
operator|->
name|unique_len
operator|=
name|u
operator|.
name|unique_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compat_drm_setunique
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_unique32_t
modifier|*
name|uq32
init|=
name|data
decl_stmt|;
name|struct
name|drm_unique
name|u
decl_stmt|;
name|u
operator|.
name|unique_len
operator|=
name|uq32
operator|->
name|unique_len
expr_stmt|;
name|u
operator|.
name|unique
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|uq32
operator|->
name|unique
expr_stmt|;
return|return
name|drm_setunique
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|u
argument_list|,
name|file_priv
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_map32
block|{
name|u32
name|offset
decl_stmt|;
comment|/**< Requested physical address (0 for SAREA)*/
name|u32
name|size
decl_stmt|;
comment|/**< Requested physical size (bytes) */
name|enum
name|drm_map_type
name|type
decl_stmt|;
comment|/**< Type of memory to map */
name|enum
name|drm_map_flags
name|flags
decl_stmt|;
comment|/**< Flags */
name|u32
name|handle
decl_stmt|;
comment|/**< User-space: "Handle" to pass to mmap() */
name|int
name|mtrr
decl_stmt|;
comment|/**< MTRR slot used */
block|}
name|drm_map32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_getmap
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_map32_t
modifier|*
name|m32
init|=
name|data
decl_stmt|;
name|struct
name|drm_map
name|map
decl_stmt|;
name|int
name|err
decl_stmt|;
name|void
modifier|*
name|handle
decl_stmt|;
name|map
operator|.
name|offset
operator|=
operator|(
name|unsigned
name|long
operator|)
name|m32
operator|->
name|offset
expr_stmt|;
name|err
operator|=
name|drm_getmap
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|map
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|m32
operator|->
name|offset
operator|=
name|map
operator|.
name|offset
expr_stmt|;
name|m32
operator|->
name|size
operator|=
name|map
operator|.
name|size
expr_stmt|;
name|m32
operator|->
name|type
operator|=
name|map
operator|.
name|type
expr_stmt|;
name|m32
operator|->
name|flags
operator|=
name|map
operator|.
name|flags
expr_stmt|;
name|handle
operator|=
name|map
operator|.
name|handle
expr_stmt|;
name|m32
operator|->
name|mtrr
operator|=
name|map
operator|.
name|mtrr
expr_stmt|;
name|m32
operator|->
name|handle
operator|=
operator|(
name|unsigned
name|long
operator|)
name|handle
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compat_drm_addmap
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_map32_t
modifier|*
name|m32
init|=
name|data
decl_stmt|;
name|struct
name|drm_map
name|map
decl_stmt|;
name|int
name|err
decl_stmt|;
name|void
modifier|*
name|handle
decl_stmt|;
name|map
operator|.
name|offset
operator|=
operator|(
name|unsigned
name|long
operator|)
name|m32
operator|->
name|offset
expr_stmt|;
name|map
operator|.
name|size
operator|=
operator|(
name|unsigned
name|long
operator|)
name|m32
operator|->
name|size
expr_stmt|;
name|map
operator|.
name|type
operator|=
name|m32
operator|->
name|type
expr_stmt|;
name|map
operator|.
name|flags
operator|=
name|m32
operator|->
name|flags
expr_stmt|;
name|err
operator|=
name|drm_addmap_ioctl
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|map
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|m32
operator|->
name|offset
operator|=
name|map
operator|.
name|offset
expr_stmt|;
name|m32
operator|->
name|mtrr
operator|=
name|map
operator|.
name|mtrr
expr_stmt|;
name|handle
operator|=
name|map
operator|.
name|handle
expr_stmt|;
name|m32
operator|->
name|handle
operator|=
operator|(
name|unsigned
name|long
operator|)
name|handle
expr_stmt|;
if|if
condition|(
name|m32
operator|->
name|handle
operator|!=
operator|(
name|unsigned
name|long
operator|)
name|handle
condition|)
name|DRM_DEBUG
argument_list|(
literal|"compat_drm_addmap truncated handle"
literal|" %p for type %d offset %x\n"
argument_list|,
name|handle
argument_list|,
name|m32
operator|->
name|type
argument_list|,
name|m32
operator|->
name|offset
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compat_drm_rmmap
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_map32_t
modifier|*
name|m32
init|=
name|data
decl_stmt|;
name|struct
name|drm_map
name|map
decl_stmt|;
name|map
operator|.
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|m32
operator|->
name|handle
expr_stmt|;
return|return
name|drm_rmmap_ioctl
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|map
argument_list|,
name|file_priv
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_client32
block|{
name|int
name|idx
decl_stmt|;
comment|/**< Which client desired? */
name|int
name|auth
decl_stmt|;
comment|/**< Is client authenticated? */
name|u32
name|pid
decl_stmt|;
comment|/**< Process ID */
name|u32
name|uid
decl_stmt|;
comment|/**< User ID */
name|u32
name|magic
decl_stmt|;
comment|/**< Magic */
name|u32
name|iocs
decl_stmt|;
comment|/**< Ioctl count */
block|}
name|drm_client32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_getclient
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_client32_t
modifier|*
name|c32
init|=
name|data
decl_stmt|;
name|struct
name|drm_client
name|client
decl_stmt|;
name|int
name|err
decl_stmt|;
name|client
operator|.
name|idx
operator|=
name|c32
operator|->
name|idx
expr_stmt|;
name|err
operator|=
name|drm_getclient
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|client
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|c32
operator|->
name|idx
operator|=
name|client
operator|.
name|idx
expr_stmt|;
name|c32
operator|->
name|auth
operator|=
name|client
operator|.
name|auth
expr_stmt|;
name|c32
operator|->
name|pid
operator|=
name|client
operator|.
name|pid
expr_stmt|;
name|c32
operator|->
name|uid
operator|=
name|client
operator|.
name|uid
expr_stmt|;
name|c32
operator|->
name|magic
operator|=
name|client
operator|.
name|magic
expr_stmt|;
name|c32
operator|->
name|iocs
operator|=
name|client
operator|.
name|iocs
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_stats32
block|{
name|u32
name|count
decl_stmt|;
struct|struct
block|{
name|u32
name|value
decl_stmt|;
name|enum
name|drm_stat_type
name|type
decl_stmt|;
block|}
name|data
index|[
literal|15
index|]
struct|;
block|}
name|drm_stats32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_getstats
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_stats32_t
modifier|*
name|s32
init|=
name|data
decl_stmt|;
name|struct
name|drm_stats
name|stats
decl_stmt|;
name|int
name|i
decl_stmt|,
name|err
decl_stmt|;
name|err
operator|=
name|drm_getstats
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|stats
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|s32
operator|->
name|count
operator|=
name|stats
operator|.
name|count
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|stats
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|s32
operator|->
name|data
index|[
name|i
index|]
operator|.
name|value
operator|=
name|stats
operator|.
name|data
index|[
name|i
index|]
operator|.
name|value
expr_stmt|;
name|s32
operator|->
name|data
index|[
name|i
index|]
operator|.
name|type
operator|=
name|stats
operator|.
name|data
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_buf_desc32
block|{
name|int
name|count
decl_stmt|;
comment|/**< Number of buffers of this size */
name|int
name|size
decl_stmt|;
comment|/**< Size in bytes */
name|int
name|low_mark
decl_stmt|;
comment|/**< Low water mark */
name|int
name|high_mark
decl_stmt|;
comment|/**< High water mark */
name|int
name|flags
decl_stmt|;
name|u32
name|agp_start
decl_stmt|;
comment|/**< Start address in the AGP aperture */
block|}
name|drm_buf_desc32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_addbufs
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_buf_desc32_t
modifier|*
name|b32
init|=
name|data
decl_stmt|;
name|struct
name|drm_buf_desc
name|buf
decl_stmt|;
name|int
name|err
decl_stmt|;
name|buf
operator|.
name|count
operator|=
name|b32
operator|->
name|count
expr_stmt|;
name|buf
operator|.
name|size
operator|=
name|b32
operator|->
name|size
expr_stmt|;
name|buf
operator|.
name|low_mark
operator|=
name|b32
operator|->
name|low_mark
expr_stmt|;
name|buf
operator|.
name|high_mark
operator|=
name|b32
operator|->
name|high_mark
expr_stmt|;
name|buf
operator|.
name|flags
operator|=
name|b32
operator|->
name|flags
expr_stmt|;
name|buf
operator|.
name|agp_start
operator|=
operator|(
name|unsigned
name|long
operator|)
name|b32
operator|->
name|agp_start
expr_stmt|;
name|err
operator|=
name|drm_addbufs
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|buf
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|b32
operator|->
name|count
operator|=
name|buf
operator|.
name|count
expr_stmt|;
name|b32
operator|->
name|size
operator|=
name|buf
operator|.
name|size
expr_stmt|;
name|b32
operator|->
name|low_mark
operator|=
name|buf
operator|.
name|low_mark
expr_stmt|;
name|b32
operator|->
name|high_mark
operator|=
name|buf
operator|.
name|high_mark
expr_stmt|;
name|b32
operator|->
name|flags
operator|=
name|buf
operator|.
name|flags
expr_stmt|;
name|b32
operator|->
name|agp_start
operator|=
name|buf
operator|.
name|agp_start
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compat_drm_markbufs
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_buf_desc32_t
modifier|*
name|b32
init|=
name|data
decl_stmt|;
name|struct
name|drm_buf_desc
name|buf
decl_stmt|;
name|buf
operator|.
name|size
operator|=
name|b32
operator|->
name|size
expr_stmt|;
name|buf
operator|.
name|low_mark
operator|=
name|b32
operator|->
name|low_mark
expr_stmt|;
name|buf
operator|.
name|high_mark
operator|=
name|b32
operator|->
name|high_mark
expr_stmt|;
return|return
name|drm_markbufs
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|buf
argument_list|,
name|file_priv
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_buf_info32
block|{
name|int
name|count
decl_stmt|;
comment|/**< Entries in list */
name|u32
name|list
decl_stmt|;
block|}
name|drm_buf_info32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_infobufs
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_buf_info32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|drm_buf_desc32_t
modifier|*
name|to
decl_stmt|;
name|struct
name|drm_buf_info
modifier|*
name|request
decl_stmt|;
name|struct
name|drm_buf_desc
modifier|*
name|list
decl_stmt|;
name|size_t
name|nbytes
decl_stmt|;
name|int
name|i
decl_stmt|,
name|err
decl_stmt|;
name|int
name|count
decl_stmt|,
name|actual
decl_stmt|;
name|count
operator|=
name|req32
operator|->
name|count
expr_stmt|;
name|to
operator|=
operator|(
name|drm_buf_desc32_t
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|->
name|list
expr_stmt|;
if|if
condition|(
name|count
operator|<
literal|0
condition|)
name|count
operator|=
literal|0
expr_stmt|;
name|nbytes
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
operator|+
name|count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|drm_buf_desc
argument_list|)
expr_stmt|;
name|request
operator|=
name|malloc
argument_list|(
name|nbytes
argument_list|,
name|DRM_MEM_BUFLISTS
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|request
condition|)
return|return
operator|-
name|EFAULT
return|;
name|list
operator|=
operator|(
expr|struct
name|drm_buf_desc
operator|*
operator|)
operator|(
name|request
operator|+
literal|1
operator|)
expr_stmt|;
name|request
operator|->
name|count
operator|=
name|count
expr_stmt|;
name|request
operator|->
name|list
operator|=
name|list
expr_stmt|;
name|err
operator|=
name|drm_infobufs
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|request
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|actual
operator|=
name|request
operator|->
name|count
expr_stmt|;
if|if
condition|(
name|count
operator|>=
name|actual
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|actual
condition|;
operator|++
name|i
control|)
block|{
name|to
index|[
name|i
index|]
operator|.
name|count
operator|=
name|list
index|[
name|i
index|]
operator|.
name|count
expr_stmt|;
name|to
index|[
name|i
index|]
operator|.
name|size
operator|=
name|list
index|[
name|i
index|]
operator|.
name|size
expr_stmt|;
name|to
index|[
name|i
index|]
operator|.
name|low_mark
operator|=
name|list
index|[
name|i
index|]
operator|.
name|low_mark
expr_stmt|;
name|to
index|[
name|i
index|]
operator|.
name|high_mark
operator|=
name|list
index|[
name|i
index|]
operator|.
name|high_mark
expr_stmt|;
name|to
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|list
index|[
name|i
index|]
operator|.
name|flags
expr_stmt|;
block|}
name|req32
operator|->
name|count
operator|=
name|actual
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_buf_pub32
block|{
name|int
name|idx
decl_stmt|;
comment|/**< Index into the master buffer list */
name|int
name|total
decl_stmt|;
comment|/**< Buffer size */
name|int
name|used
decl_stmt|;
comment|/**< Amount of buffer in use (for DMA) */
name|u32
name|address
decl_stmt|;
comment|/**< Address of buffer */
block|}
name|drm_buf_pub32_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|drm_buf_map32
block|{
name|int
name|count
decl_stmt|;
comment|/**< Length of the buffer list */
name|u32
name|virtual
decl_stmt|;
comment|/**< Mmap'd area in user-virtual */
name|u32
name|list
decl_stmt|;
comment|/**< Buffer information */
block|}
name|drm_buf_map32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_mapbufs
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_buf_map32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|drm_buf_pub32_t
modifier|*
name|list32
decl_stmt|;
name|struct
name|drm_buf_map
modifier|*
name|request
decl_stmt|;
name|struct
name|drm_buf_pub
modifier|*
name|list
decl_stmt|;
name|int
name|i
decl_stmt|,
name|err
decl_stmt|;
name|int
name|count
decl_stmt|,
name|actual
decl_stmt|;
name|size_t
name|nbytes
decl_stmt|;
name|count
operator|=
name|req32
operator|->
name|count
expr_stmt|;
name|list32
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|->
name|list
expr_stmt|;
if|if
condition|(
name|count
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|nbytes
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
operator|+
name|count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|drm_buf_pub
argument_list|)
expr_stmt|;
name|request
operator|=
name|malloc
argument_list|(
name|nbytes
argument_list|,
name|DRM_MEM_BUFLISTS
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|request
condition|)
return|return
operator|-
name|EFAULT
return|;
name|list
operator|=
operator|(
expr|struct
name|drm_buf_pub
operator|*
operator|)
operator|(
name|request
operator|+
literal|1
operator|)
expr_stmt|;
name|request
operator|->
name|count
operator|=
name|count
expr_stmt|;
name|request
operator|->
name|list
operator|=
name|list
expr_stmt|;
name|err
operator|=
name|drm_mapbufs
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|request
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|actual
operator|=
name|request
operator|->
name|count
expr_stmt|;
if|if
condition|(
name|count
operator|>=
name|actual
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|actual
condition|;
operator|++
name|i
control|)
block|{
name|list32
index|[
name|i
index|]
operator|.
name|idx
operator|=
name|list
index|[
name|i
index|]
operator|.
name|idx
expr_stmt|;
name|list32
index|[
name|i
index|]
operator|.
name|total
operator|=
name|list
index|[
name|i
index|]
operator|.
name|total
expr_stmt|;
name|list32
index|[
name|i
index|]
operator|.
name|used
operator|=
name|list
index|[
name|i
index|]
operator|.
name|used
expr_stmt|;
name|list32
index|[
name|i
index|]
operator|.
name|address
operator|=
operator|(
name|unsigned
name|long
operator|)
name|list
index|[
name|i
index|]
operator|.
name|address
expr_stmt|;
block|}
name|req32
operator|->
name|count
operator|=
name|actual
expr_stmt|;
name|req32
operator|->
name|virtual
operator|=
operator|(
name|unsigned
name|long
operator|)
name|request
operator|->
name|virtual
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_buf_free32
block|{
name|int
name|count
decl_stmt|;
name|u32
name|list
decl_stmt|;
block|}
name|drm_buf_free32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_freebufs
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_buf_free32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|struct
name|drm_buf_free
name|request
decl_stmt|;
name|request
operator|.
name|count
operator|=
name|req32
operator|->
name|count
expr_stmt|;
name|request
operator|.
name|list
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|->
name|list
expr_stmt|;
return|return
name|drm_freebufs
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_ctx_priv_map32
block|{
name|unsigned
name|int
name|ctx_id
decl_stmt|;
comment|/**< Context requesting private mapping */
name|u32
name|handle
decl_stmt|;
comment|/**< Handle of map */
block|}
name|drm_ctx_priv_map32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_setsareactx
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_ctx_priv_map32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|struct
name|drm_ctx_priv_map
name|request
decl_stmt|;
name|request
operator|.
name|ctx_id
operator|=
name|req32
operator|->
name|ctx_id
expr_stmt|;
name|request
operator|.
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|->
name|handle
expr_stmt|;
return|return
name|drm_setsareactx
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compat_drm_getsareactx
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_ctx_priv_map32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|struct
name|drm_ctx_priv_map
name|request
decl_stmt|;
name|int
name|err
decl_stmt|;
name|request
operator|.
name|ctx_id
operator|=
name|req32
operator|->
name|ctx_id
expr_stmt|;
name|err
operator|=
name|drm_getsareactx
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|req32
operator|->
name|handle
operator|=
operator|(
name|unsigned
name|long
operator|)
name|request
operator|.
name|handle
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_ctx_res32
block|{
name|int
name|count
decl_stmt|;
name|u32
name|contexts
decl_stmt|;
block|}
name|drm_ctx_res32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_resctx
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_ctx_res32_t
modifier|*
name|res32
init|=
name|data
decl_stmt|;
name|struct
name|drm_ctx_res
name|res
decl_stmt|;
name|int
name|err
decl_stmt|;
name|res
operator|.
name|count
operator|=
name|res32
operator|->
name|count
expr_stmt|;
name|res
operator|.
name|contexts
operator|=
operator|(
expr|struct
name|drm_ctx
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|res32
operator|->
name|contexts
expr_stmt|;
name|err
operator|=
name|drm_resctx
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|res
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|res32
operator|->
name|count
operator|=
name|res
operator|.
name|count
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_dma32
block|{
name|int
name|context
decl_stmt|;
comment|/**< Context handle */
name|int
name|send_count
decl_stmt|;
comment|/**< Number of buffers to send */
name|u32
name|send_indices
decl_stmt|;
comment|/**< List of handles to buffers */
name|u32
name|send_sizes
decl_stmt|;
comment|/**< Lengths of data to send */
name|enum
name|drm_dma_flags
name|flags
decl_stmt|;
comment|/**< Flags */
name|int
name|request_count
decl_stmt|;
comment|/**< Number of buffers requested */
name|int
name|request_size
decl_stmt|;
comment|/**< Desired size for buffers */
name|u32
name|request_indices
decl_stmt|;
comment|/**< Buffer information */
name|u32
name|request_sizes
decl_stmt|;
name|int
name|granted_count
decl_stmt|;
comment|/**< Number of buffers granted */
block|}
name|drm_dma32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_dma
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_dma32_t
modifier|*
name|d32
init|=
name|data
decl_stmt|;
name|struct
name|drm_dma
name|d
decl_stmt|;
name|int
name|err
decl_stmt|;
name|d
operator|.
name|context
operator|=
name|d32
operator|->
name|context
expr_stmt|;
name|d
operator|.
name|send_count
operator|=
name|d32
operator|->
name|send_count
expr_stmt|;
name|d
operator|.
name|send_indices
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|d32
operator|->
name|send_indices
expr_stmt|;
name|d
operator|.
name|send_sizes
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|d32
operator|->
name|send_sizes
expr_stmt|;
name|d
operator|.
name|flags
operator|=
name|d32
operator|->
name|flags
expr_stmt|;
name|d
operator|.
name|request_count
operator|=
name|d32
operator|->
name|request_count
expr_stmt|;
name|d
operator|.
name|request_indices
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|d32
operator|->
name|request_indices
expr_stmt|;
name|d
operator|.
name|request_sizes
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|d32
operator|->
name|request_sizes
expr_stmt|;
name|err
operator|=
name|drm_dma
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|d
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|d32
operator|->
name|request_size
operator|=
name|d
operator|.
name|request_size
expr_stmt|;
name|d32
operator|->
name|granted_count
operator|=
name|d
operator|.
name|granted_count
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_agp_mode32
block|{
name|u32
name|mode
decl_stmt|;
comment|/**< AGP mode */
block|}
name|drm_agp_mode32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_agp_enable
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_agp_mode32_t
modifier|*
name|m32
init|=
name|data
decl_stmt|;
name|struct
name|drm_agp_mode
name|mode
decl_stmt|;
name|mode
operator|.
name|mode
operator|=
name|m32
operator|->
name|mode
expr_stmt|;
return|return
name|drm_agp_enable_ioctl
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|mode
argument_list|,
name|file_priv
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_agp_info32
block|{
name|int
name|agp_version_major
decl_stmt|;
name|int
name|agp_version_minor
decl_stmt|;
name|u32
name|mode
decl_stmt|;
name|u32
name|aperture_base
decl_stmt|;
comment|/* physical address */
name|u32
name|aperture_size
decl_stmt|;
comment|/* bytes */
name|u32
name|memory_allowed
decl_stmt|;
comment|/* bytes */
name|u32
name|memory_used
decl_stmt|;
comment|/* PCI information */
name|unsigned
name|short
name|id_vendor
decl_stmt|;
name|unsigned
name|short
name|id_device
decl_stmt|;
block|}
name|drm_agp_info32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_agp_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_agp_info32_t
modifier|*
name|i32
init|=
name|data
decl_stmt|;
name|struct
name|drm_agp_info
name|info
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|drm_agp_info_ioctl
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|info
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|i32
operator|->
name|agp_version_major
operator|=
name|info
operator|.
name|agp_version_major
expr_stmt|;
name|i32
operator|->
name|agp_version_minor
operator|=
name|info
operator|.
name|agp_version_minor
expr_stmt|;
name|i32
operator|->
name|mode
operator|=
name|info
operator|.
name|mode
expr_stmt|;
name|i32
operator|->
name|aperture_base
operator|=
name|info
operator|.
name|aperture_base
expr_stmt|;
name|i32
operator|->
name|aperture_size
operator|=
name|info
operator|.
name|aperture_size
expr_stmt|;
name|i32
operator|->
name|memory_allowed
operator|=
name|info
operator|.
name|memory_allowed
expr_stmt|;
name|i32
operator|->
name|memory_used
operator|=
name|info
operator|.
name|memory_used
expr_stmt|;
name|i32
operator|->
name|id_vendor
operator|=
name|info
operator|.
name|id_vendor
expr_stmt|;
name|i32
operator|->
name|id_device
operator|=
name|info
operator|.
name|id_device
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_agp_buffer32
block|{
name|u32
name|size
decl_stmt|;
comment|/**< In bytes -- will round to page boundary */
name|u32
name|handle
decl_stmt|;
comment|/**< Used for binding / unbinding */
name|u32
name|type
decl_stmt|;
comment|/**< Type of memory to allocate */
name|u32
name|physical
decl_stmt|;
comment|/**< Physical used by i810 */
block|}
name|drm_agp_buffer32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_agp_alloc
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_agp_buffer32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|struct
name|drm_agp_buffer
name|request
decl_stmt|;
name|int
name|err
decl_stmt|;
name|request
operator|.
name|size
operator|=
name|req32
operator|->
name|size
expr_stmt|;
name|request
operator|.
name|type
operator|=
name|req32
operator|->
name|type
expr_stmt|;
name|err
operator|=
name|drm_agp_alloc_ioctl
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|req32
operator|->
name|handle
operator|=
name|request
operator|.
name|handle
expr_stmt|;
name|req32
operator|->
name|physical
operator|=
name|request
operator|.
name|physical
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compat_drm_agp_free
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_agp_buffer32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|struct
name|drm_agp_buffer
name|request
decl_stmt|;
name|request
operator|.
name|handle
operator|=
name|req32
operator|->
name|handle
expr_stmt|;
return|return
name|drm_agp_free_ioctl
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_agp_binding32
block|{
name|u32
name|handle
decl_stmt|;
comment|/**< From drm_agp_buffer */
name|u32
name|offset
decl_stmt|;
comment|/**< In bytes -- will round to page boundary */
block|}
name|drm_agp_binding32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_agp_bind
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_agp_binding32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|struct
name|drm_agp_binding
name|request
decl_stmt|;
name|request
operator|.
name|handle
operator|=
name|req32
operator|->
name|handle
expr_stmt|;
name|request
operator|.
name|offset
operator|=
name|req32
operator|->
name|offset
expr_stmt|;
return|return
name|drm_agp_bind_ioctl
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compat_drm_agp_unbind
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_agp_binding32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|struct
name|drm_agp_binding
name|request
decl_stmt|;
name|request
operator|.
name|handle
operator|=
name|req32
operator|->
name|handle
expr_stmt|;
return|return
name|drm_agp_unbind_ioctl
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_scatter_gather32
block|{
name|u32
name|size
decl_stmt|;
comment|/**< In bytes -- will round to page boundary */
name|u32
name|handle
decl_stmt|;
comment|/**< Used for mapping / unmapping */
block|}
name|drm_scatter_gather32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_sg_alloc
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_scatter_gather32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|struct
name|drm_scatter_gather
name|request
decl_stmt|;
name|int
name|err
decl_stmt|;
name|request
operator|.
name|size
operator|=
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|->
name|size
expr_stmt|;
name|err
operator|=
name|drm_sg_alloc_ioctl
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
comment|/* XXX not sure about the handle conversion here... */
name|req32
operator|->
name|handle
operator|=
operator|(
name|unsigned
name|long
operator|)
name|request
operator|.
name|handle
operator|>>
name|PAGE_SHIFT
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compat_drm_sg_free
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_scatter_gather32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|struct
name|drm_scatter_gather
name|request
decl_stmt|;
name|request
operator|.
name|handle
operator|=
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|->
name|handle
operator|<<
name|PAGE_SHIFT
expr_stmt|;
return|return
name|drm_sg_free
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_update_draw32
block|{
name|drm_drawable_t
name|handle
decl_stmt|;
name|unsigned
name|int
name|type
decl_stmt|;
name|unsigned
name|int
name|num
decl_stmt|;
comment|/* 64-bit version has a 32-bit pad here */
name|u64
name|data
decl_stmt|;
comment|/**< Pointer */
block|}
name|__attribute__
typedef|((
name|packed
typedef|))
name|drm_update_draw32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_update_draw
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_update_draw32_t
modifier|*
name|update32
init|=
name|data
decl_stmt|;
name|struct
name|drm_update_draw
name|request
decl_stmt|;
name|int
name|err
decl_stmt|;
name|request
operator|.
name|handle
operator|=
name|update32
operator|->
name|handle
expr_stmt|;
name|request
operator|.
name|type
operator|=
name|update32
operator|->
name|type
expr_stmt|;
name|request
operator|.
name|num
operator|=
name|update32
operator|->
name|num
expr_stmt|;
name|request
operator|.
name|data
operator|=
name|update32
operator|->
name|data
expr_stmt|;
name|err
operator|=
name|drm_update_draw
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_struct
struct|struct
name|drm_wait_vblank_request32
block|{
name|enum
name|drm_vblank_seq_type
name|type
decl_stmt|;
name|unsigned
name|int
name|sequence
decl_stmt|;
name|u32
name|signal
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|drm_wait_vblank_reply32
block|{
name|enum
name|drm_vblank_seq_type
name|type
decl_stmt|;
name|unsigned
name|int
name|sequence
decl_stmt|;
name|s32
name|tval_sec
decl_stmt|;
name|s32
name|tval_usec
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
union|union
name|drm_wait_vblank32
block|{
name|struct
name|drm_wait_vblank_request32
name|request
decl_stmt|;
name|struct
name|drm_wait_vblank_reply32
name|reply
decl_stmt|;
block|}
name|drm_wait_vblank32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_drm_wait_vblank
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_wait_vblank32_t
modifier|*
name|req32
init|=
name|data
decl_stmt|;
name|union
name|drm_wait_vblank
name|request
decl_stmt|;
name|int
name|err
decl_stmt|;
name|request
operator|.
name|request
operator|.
name|type
operator|=
name|req32
operator|->
name|request
operator|.
name|type
expr_stmt|;
name|request
operator|.
name|request
operator|.
name|sequence
operator|=
name|req32
operator|->
name|request
operator|.
name|sequence
expr_stmt|;
name|request
operator|.
name|request
operator|.
name|signal
operator|=
name|req32
operator|->
name|request
operator|.
name|signal
expr_stmt|;
name|err
operator|=
name|drm_wait_vblank
argument_list|(
name|dev
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|request
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|req32
operator|->
name|reply
operator|.
name|type
operator|=
name|request
operator|.
name|reply
operator|.
name|type
expr_stmt|;
name|req32
operator|->
name|reply
operator|.
name|sequence
operator|=
name|request
operator|.
name|reply
operator|.
name|sequence
expr_stmt|;
name|req32
operator|->
name|reply
operator|.
name|tval_sec
operator|=
name|request
operator|.
name|reply
operator|.
name|tval_sec
expr_stmt|;
name|req32
operator|->
name|reply
operator|.
name|tval_usec
operator|=
name|request
operator|.
name|reply
operator|.
name|tval_usec
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
name|drm_ioctl_desc_t
name|drm_compat_ioctls
index|[
literal|256
index|]
init|=
block|{
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_VERSION32
argument_list|,
name|compat_drm_version
argument_list|,
literal|0
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_GET_UNIQUE32
argument_list|,
name|compat_drm_getunique
argument_list|,
literal|0
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_GET_MAP32
argument_list|,
name|compat_drm_getmap
argument_list|,
literal|0
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_GET_CLIENT32
argument_list|,
name|compat_drm_getclient
argument_list|,
literal|0
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_GET_STATS32
argument_list|,
name|compat_drm_getstats
argument_list|,
literal|0
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_SET_UNIQUE32
argument_list|,
name|compat_drm_setunique
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_ADD_MAP32
argument_list|,
name|compat_drm_addmap
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_ADD_BUFS32
argument_list|,
name|compat_drm_addbufs
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_MARK_BUFS32
argument_list|,
name|compat_drm_markbufs
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_INFO_BUFS32
argument_list|,
name|compat_drm_infobufs
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_MAP_BUFS32
argument_list|,
name|compat_drm_mapbufs
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_FREE_BUFS32
argument_list|,
name|compat_drm_freebufs
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_RM_MAP32
argument_list|,
name|compat_drm_rmmap
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_SET_SAREA_CTX32
argument_list|,
name|compat_drm_setsareactx
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_GET_SAREA_CTX32
argument_list|,
name|compat_drm_getsareactx
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_RES_CTX32
argument_list|,
name|compat_drm_resctx
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_DMA32
argument_list|,
name|compat_drm_dma
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_AGP_ENABLE32
argument_list|,
name|compat_drm_agp_enable
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_AGP_INFO32
argument_list|,
name|compat_drm_agp_info
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_AGP_ALLOC32
argument_list|,
name|compat_drm_agp_alloc
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_AGP_FREE32
argument_list|,
name|compat_drm_agp_free
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_AGP_BIND32
argument_list|,
name|compat_drm_agp_bind
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_AGP_UNBIND32
argument_list|,
name|compat_drm_agp_unbind
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_SG_ALLOC32
argument_list|,
name|compat_drm_sg_alloc
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_SG_FREE32
argument_list|,
name|compat_drm_sg_free
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_UPDATE_DRAW32
argument_list|,
name|compat_drm_update_draw
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_IOCTL_WAIT_VBLANK32
argument_list|,
name|compat_drm_wait_vblank
argument_list|,
name|DRM_UNLOCKED
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


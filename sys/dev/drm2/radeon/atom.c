begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Author: Stanislaw Skowronek  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|ATOM_DEBUG
end_define

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"atom-names.h"
end_include

begin_include
include|#
directive|include
file|"atom-bits.h"
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_define
define|#
directive|define
name|ATOM_COND_ABOVE
value|0
end_define

begin_define
define|#
directive|define
name|ATOM_COND_ABOVEOREQUAL
value|1
end_define

begin_define
define|#
directive|define
name|ATOM_COND_ALWAYS
value|2
end_define

begin_define
define|#
directive|define
name|ATOM_COND_BELOW
value|3
end_define

begin_define
define|#
directive|define
name|ATOM_COND_BELOWOREQUAL
value|4
end_define

begin_define
define|#
directive|define
name|ATOM_COND_EQUAL
value|5
end_define

begin_define
define|#
directive|define
name|ATOM_COND_NOTEQUAL
value|6
end_define

begin_define
define|#
directive|define
name|ATOM_PORT_ATI
value|0
end_define

begin_define
define|#
directive|define
name|ATOM_PORT_PCI
value|1
end_define

begin_define
define|#
directive|define
name|ATOM_PORT_SYSIO
value|2
end_define

begin_define
define|#
directive|define
name|ATOM_UNIT_MICROSEC
value|0
end_define

begin_define
define|#
directive|define
name|ATOM_UNIT_MILLISEC
value|1
end_define

begin_define
define|#
directive|define
name|PLL_INDEX
value|2
end_define

begin_define
define|#
directive|define
name|PLL_DATA
value|3
end_define

begin_typedef
typedef|typedef
struct|struct
block|{
name|struct
name|atom_context
modifier|*
name|ctx
decl_stmt|;
name|uint32_t
modifier|*
name|ps
decl_stmt|,
modifier|*
name|ws
decl_stmt|;
name|int
name|ps_shift
decl_stmt|;
name|uint16_t
name|start
decl_stmt|;
name|unsigned
name|last_jump
decl_stmt|;
name|unsigned
name|long
name|last_jump_jiffies
decl_stmt|;
name|bool
name|abort
decl_stmt|;
block|}
name|atom_exec_context
typedef|;
end_typedef

begin_decl_stmt
name|int
name|atom_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|atom_execute_table_locked
parameter_list|(
name|struct
name|atom_context
modifier|*
name|ctx
parameter_list|,
name|int
name|index
parameter_list|,
name|uint32_t
modifier|*
name|params
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|uint32_t
name|atom_arg_mask
index|[
literal|8
index|]
init|=
block|{
literal|0xFFFFFFFF
block|,
literal|0xFFFF
block|,
literal|0xFFFF00
block|,
literal|0xFFFF0000
block|,
literal|0xFF
block|,
literal|0xFF00
block|,
literal|0xFF0000
block|,
literal|0xFF000000
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|atom_arg_shift
index|[
literal|8
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|8
block|,
literal|16
block|,
literal|0
block|,
literal|8
block|,
literal|16
block|,
literal|24
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|atom_dst_to_src
index|[
literal|8
index|]
index|[
literal|4
index|]
init|=
block|{
comment|/* translate destination alignment field to the source alignment encoding */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|0
block|}
block|,
block|{
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|}
block|,
block|{
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|}
block|,
block|{
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|}
block|,
block|{
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|atom_def_dst
index|[
literal|8
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|debug_depth
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|ATOM_DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|debug_print_spaces
parameter_list|(
name|int
name|n
parameter_list|)
block|{
while|while
condition|(
name|n
operator|--
condition|)
name|printf
argument_list|(
literal|"   "
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|ATOM_DEBUG_PRINT
parameter_list|(
modifier|...
parameter_list|)
value|do if (atom_debug) { printf(__FILE__ __VA_ARGS__); } while (0)
end_define

begin_define
define|#
directive|define
name|ATOM_SDEBUG_PRINT
parameter_list|(
modifier|...
parameter_list|)
value|do if (atom_debug) { printf(__FILE__); debug_print_spaces(debug_depth); printf(__VA_ARGS__); } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|ATOM_DEBUG_PRINT
parameter_list|(
modifier|...
parameter_list|)
value|do { } while (0)
end_define

begin_define
define|#
directive|define
name|ATOM_SDEBUG_PRINT
parameter_list|(
modifier|...
parameter_list|)
value|do { } while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|uint32_t
name|atom_iio_execute
parameter_list|(
name|struct
name|atom_context
modifier|*
name|ctx
parameter_list|,
name|int
name|base
parameter_list|,
name|uint32_t
name|index
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|ctx
operator|->
name|card
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|temp
init|=
literal|0xCDCDCDCD
decl_stmt|;
while|while
condition|(
literal|1
condition|)
switch|switch
condition|(
name|CU8
argument_list|(
name|base
argument_list|)
condition|)
block|{
case|case
name|ATOM_IIO_NOP
case|:
name|base
operator|++
expr_stmt|;
break|break;
case|case
name|ATOM_IIO_READ
case|:
name|temp
operator|=
name|ctx
operator|->
name|card
operator|->
name|ioreg_read
argument_list|(
name|ctx
operator|->
name|card
argument_list|,
name|CU16
argument_list|(
name|base
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|base
operator|+=
literal|3
expr_stmt|;
break|break;
case|case
name|ATOM_IIO_WRITE
case|:
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV515
condition|)
operator|(
name|void
operator|)
name|ctx
operator|->
name|card
operator|->
name|ioreg_read
argument_list|(
name|ctx
operator|->
name|card
argument_list|,
name|CU16
argument_list|(
name|base
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|card
operator|->
name|ioreg_write
argument_list|(
name|ctx
operator|->
name|card
argument_list|,
name|CU16
argument_list|(
name|base
operator|+
literal|1
argument_list|)
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|base
operator|+=
literal|3
expr_stmt|;
break|break;
case|case
name|ATOM_IIO_CLEAR
case|:
name|temp
operator|&=
operator|~
operator|(
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|CU8
argument_list|(
name|base
operator|+
literal|1
argument_list|)
operator|)
operator|)
operator|<<
name|CU8
argument_list|(
name|base
operator|+
literal|2
argument_list|)
operator|)
expr_stmt|;
name|base
operator|+=
literal|3
expr_stmt|;
break|break;
case|case
name|ATOM_IIO_SET
case|:
name|temp
operator||=
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|CU8
argument_list|(
name|base
operator|+
literal|1
argument_list|)
operator|)
operator|)
operator|<<
name|CU8
argument_list|(
name|base
operator|+
literal|2
argument_list|)
expr_stmt|;
name|base
operator|+=
literal|3
expr_stmt|;
break|break;
case|case
name|ATOM_IIO_MOVE_INDEX
case|:
name|temp
operator|&=
operator|~
operator|(
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|CU8
argument_list|(
name|base
operator|+
literal|1
argument_list|)
operator|)
operator|)
operator|<<
name|CU8
argument_list|(
name|base
operator|+
literal|3
argument_list|)
operator|)
expr_stmt|;
name|temp
operator||=
operator|(
operator|(
name|index
operator|>>
name|CU8
argument_list|(
name|base
operator|+
literal|2
argument_list|)
operator|)
operator|&
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|CU8
argument_list|(
name|base
operator|+
literal|1
argument_list|)
operator|)
operator|)
operator|)
operator|<<
name|CU8
argument_list|(
name|base
operator|+
literal|3
argument_list|)
expr_stmt|;
name|base
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|ATOM_IIO_MOVE_DATA
case|:
name|temp
operator|&=
operator|~
operator|(
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|CU8
argument_list|(
name|base
operator|+
literal|1
argument_list|)
operator|)
operator|)
operator|<<
name|CU8
argument_list|(
name|base
operator|+
literal|3
argument_list|)
operator|)
expr_stmt|;
name|temp
operator||=
operator|(
operator|(
name|data
operator|>>
name|CU8
argument_list|(
name|base
operator|+
literal|2
argument_list|)
operator|)
operator|&
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|CU8
argument_list|(
name|base
operator|+
literal|1
argument_list|)
operator|)
operator|)
operator|)
operator|<<
name|CU8
argument_list|(
name|base
operator|+
literal|3
argument_list|)
expr_stmt|;
name|base
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|ATOM_IIO_MOVE_ATTR
case|:
name|temp
operator|&=
operator|~
operator|(
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|CU8
argument_list|(
name|base
operator|+
literal|1
argument_list|)
operator|)
operator|)
operator|<<
name|CU8
argument_list|(
name|base
operator|+
literal|3
argument_list|)
operator|)
expr_stmt|;
name|temp
operator||=
operator|(
operator|(
name|ctx
operator|->
name|io_attr
operator|>>
name|CU8
argument_list|(
name|base
operator|+
literal|2
argument_list|)
operator|)
operator|&
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|CU8
argument_list|(
name|base
operator|+
literal|1
argument_list|)
operator|)
operator|)
operator|)
operator|<<
name|CU8
argument_list|(
name|base
operator|+
literal|3
argument_list|)
expr_stmt|;
name|base
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|ATOM_IIO_END
case|:
return|return
name|temp
return|;
default|default:
name|DRM_INFO
argument_list|(
literal|"Unknown IIO opcode.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|atom_get_src_int
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|uint8_t
name|attr
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|uint32_t
modifier|*
name|saved
parameter_list|,
name|int
name|print
parameter_list|)
block|{
name|uint32_t
name|idx
decl_stmt|,
name|val
init|=
literal|0xCDCDCDCD
decl_stmt|,
name|align
decl_stmt|,
name|arg
decl_stmt|;
name|struct
name|atom_context
modifier|*
name|gctx
init|=
name|ctx
operator|->
name|ctx
decl_stmt|;
name|arg
operator|=
name|attr
operator|&
literal|7
expr_stmt|;
name|align
operator|=
operator|(
name|attr
operator|>>
literal|3
operator|)
operator|&
literal|7
expr_stmt|;
switch|switch
condition|(
name|arg
condition|)
block|{
case|case
name|ATOM_ARG_REG
case|:
name|idx
operator|=
name|U16
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|print
condition|)
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"REG[0x%04X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
name|gctx
operator|->
name|reg_block
expr_stmt|;
switch|switch
condition|(
name|gctx
operator|->
name|io_mode
condition|)
block|{
case|case
name|ATOM_IO_MM
case|:
name|val
operator|=
name|gctx
operator|->
name|card
operator|->
name|reg_read
argument_list|(
name|gctx
operator|->
name|card
argument_list|,
name|idx
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_IO_PCI
case|:
name|DRM_INFO
argument_list|(
literal|"PCI registers are not implemented.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ATOM_IO_SYSIO
case|:
name|DRM_INFO
argument_list|(
literal|"SYSIO registers are not implemented.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
if|if
condition|(
operator|!
operator|(
name|gctx
operator|->
name|io_mode
operator|&
literal|0x80
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Bad IO mode.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|gctx
operator|->
name|iio
index|[
name|gctx
operator|->
name|io_mode
operator|&
literal|0x7F
index|]
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Undefined indirect IO read method %d.\n"
argument_list|,
name|gctx
operator|->
name|io_mode
operator|&
literal|0x7F
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|val
operator|=
name|atom_iio_execute
argument_list|(
name|gctx
argument_list|,
name|gctx
operator|->
name|iio
index|[
name|gctx
operator|->
name|io_mode
operator|&
literal|0x7F
index|]
argument_list|,
name|idx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ATOM_ARG_PS
case|:
name|idx
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
comment|/* get_unaligned_le32 avoids unaligned accesses from atombios 		 * tables, noticed on a DEC Alpha. */
name|val
operator|=
name|get_unaligned_le32
argument_list|(
operator|(
name|u32
operator|*
operator|)
operator|&
name|ctx
operator|->
name|ps
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|print
condition|)
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"PS[0x%02X,0x%04X]"
argument_list|,
name|idx
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_ARG_WS
case|:
name|idx
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|print
condition|)
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"WS[0x%02X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|idx
condition|)
block|{
case|case
name|ATOM_WS_QUOTIENT
case|:
name|val
operator|=
name|gctx
operator|->
name|divmul
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|ATOM_WS_REMAINDER
case|:
name|val
operator|=
name|gctx
operator|->
name|divmul
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|ATOM_WS_DATAPTR
case|:
name|val
operator|=
name|gctx
operator|->
name|data_block
expr_stmt|;
break|break;
case|case
name|ATOM_WS_SHIFT
case|:
name|val
operator|=
name|gctx
operator|->
name|shift
expr_stmt|;
break|break;
case|case
name|ATOM_WS_OR_MASK
case|:
name|val
operator|=
literal|1
operator|<<
name|gctx
operator|->
name|shift
expr_stmt|;
break|break;
case|case
name|ATOM_WS_AND_MASK
case|:
name|val
operator|=
operator|~
operator|(
literal|1
operator|<<
name|gctx
operator|->
name|shift
operator|)
expr_stmt|;
break|break;
case|case
name|ATOM_WS_FB_WINDOW
case|:
name|val
operator|=
name|gctx
operator|->
name|fb_base
expr_stmt|;
break|break;
case|case
name|ATOM_WS_ATTRIBUTES
case|:
name|val
operator|=
name|gctx
operator|->
name|io_attr
expr_stmt|;
break|break;
case|case
name|ATOM_WS_REGPTR
case|:
name|val
operator|=
name|gctx
operator|->
name|reg_block
expr_stmt|;
break|break;
default|default:
name|val
operator|=
name|ctx
operator|->
name|ws
index|[
name|idx
index|]
expr_stmt|;
block|}
break|break;
case|case
name|ATOM_ARG_ID
case|:
name|idx
operator|=
name|U16
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|print
condition|)
block|{
if|if
condition|(
name|gctx
operator|->
name|data_block
condition|)
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"ID[0x%04X+%04X]"
argument_list|,
name|idx
argument_list|,
name|gctx
operator|->
name|data_block
argument_list|)
expr_stmt|;
else|else
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"ID[0x%04X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
name|U32
argument_list|(
name|idx
operator|+
name|gctx
operator|->
name|data_block
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_ARG_FB
case|:
name|idx
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|gctx
operator|->
name|fb_base
operator|+
operator|(
name|idx
operator|*
literal|4
operator|)
operator|)
operator|>
name|gctx
operator|->
name|scratch_size_bytes
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ATOM: fb read beyond scratch region: %d vs. %d\n"
argument_list|,
name|gctx
operator|->
name|fb_base
operator|+
operator|(
name|idx
operator|*
literal|4
operator|)
argument_list|,
name|gctx
operator|->
name|scratch_size_bytes
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|val
operator|=
name|gctx
operator|->
name|scratch
index|[
operator|(
name|gctx
operator|->
name|fb_base
operator|/
literal|4
operator|)
operator|+
name|idx
index|]
expr_stmt|;
if|if
condition|(
name|print
condition|)
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"FB[0x%02X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_ARG_IMM
case|:
switch|switch
condition|(
name|align
condition|)
block|{
case|case
name|ATOM_SRC_DWORD
case|:
name|val
operator|=
name|U32
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|print
condition|)
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"IMM 0x%08X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|val
return|;
case|case
name|ATOM_SRC_WORD0
case|:
case|case
name|ATOM_SRC_WORD8
case|:
case|case
name|ATOM_SRC_WORD16
case|:
name|val
operator|=
name|U16
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|print
condition|)
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"IMM 0x%04X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|val
return|;
case|case
name|ATOM_SRC_BYTE0
case|:
case|case
name|ATOM_SRC_BYTE8
case|:
case|case
name|ATOM_SRC_BYTE16
case|:
case|case
name|ATOM_SRC_BYTE24
case|:
name|val
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|print
condition|)
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"IMM 0x%02X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
return|return
literal|0
return|;
case|case
name|ATOM_ARG_PLL
case|:
name|idx
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|print
condition|)
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"PLL[0x%02X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|val
operator|=
name|gctx
operator|->
name|card
operator|->
name|pll_read
argument_list|(
name|gctx
operator|->
name|card
argument_list|,
name|idx
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_ARG_MC
case|:
name|idx
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|print
condition|)
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"MC[0x%02X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|val
operator|=
name|gctx
operator|->
name|card
operator|->
name|mc_read
argument_list|(
name|gctx
operator|->
name|card
argument_list|,
name|idx
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|saved
condition|)
operator|*
name|saved
operator|=
name|val
expr_stmt|;
name|val
operator|&=
name|atom_arg_mask
index|[
name|align
index|]
expr_stmt|;
name|val
operator|>>=
name|atom_arg_shift
index|[
name|align
index|]
expr_stmt|;
if|if
condition|(
name|print
condition|)
switch|switch
condition|(
name|align
condition|)
block|{
case|case
name|ATOM_SRC_DWORD
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[31:0] -> 0x%08X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_WORD0
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[15:0] -> 0x%04X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_WORD8
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[23:8] -> 0x%04X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_WORD16
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[31:16] -> 0x%04X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_BYTE0
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[7:0] -> 0x%02X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_BYTE8
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[15:8] -> 0x%02X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_BYTE16
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[23:16] -> 0x%02X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_BYTE24
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[31:24] -> 0x%02X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_skip_src_int
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|uint8_t
name|attr
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|)
block|{
name|uint32_t
name|align
init|=
operator|(
name|attr
operator|>>
literal|3
operator|)
operator|&
literal|7
decl_stmt|,
name|arg
init|=
name|attr
operator|&
literal|7
decl_stmt|;
switch|switch
condition|(
name|arg
condition|)
block|{
case|case
name|ATOM_ARG_REG
case|:
case|case
name|ATOM_ARG_ID
case|:
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|ATOM_ARG_PLL
case|:
case|case
name|ATOM_ARG_MC
case|:
case|case
name|ATOM_ARG_PS
case|:
case|case
name|ATOM_ARG_WS
case|:
case|case
name|ATOM_ARG_FB
case|:
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
break|break;
case|case
name|ATOM_ARG_IMM
case|:
switch|switch
condition|(
name|align
condition|)
block|{
case|case
name|ATOM_SRC_DWORD
case|:
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|4
expr_stmt|;
return|return;
case|case
name|ATOM_SRC_WORD0
case|:
case|case
name|ATOM_SRC_WORD8
case|:
case|case
name|ATOM_SRC_WORD16
case|:
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
return|return;
case|case
name|ATOM_SRC_BYTE0
case|:
case|case
name|ATOM_SRC_BYTE8
case|:
case|case
name|ATOM_SRC_BYTE16
case|:
case|case
name|ATOM_SRC_BYTE24
case|:
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
return|return;
block|}
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|atom_get_src
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|uint8_t
name|attr
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|)
block|{
return|return
name|atom_get_src_int
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|atom_get_src_direct
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|uint8_t
name|align
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0xCDCDCDCD
decl_stmt|;
switch|switch
condition|(
name|align
condition|)
block|{
case|case
name|ATOM_SRC_DWORD
case|:
name|val
operator|=
name|U32
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_WORD0
case|:
case|case
name|ATOM_SRC_WORD8
case|:
case|case
name|ATOM_SRC_WORD16
case|:
name|val
operator|=
name|U16
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_BYTE0
case|:
case|case
name|ATOM_SRC_BYTE8
case|:
case|case
name|ATOM_SRC_BYTE16
case|:
case|case
name|ATOM_SRC_BYTE24
case|:
name|val
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
break|break;
block|}
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|atom_get_dst
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
name|arg
parameter_list|,
name|uint8_t
name|attr
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|uint32_t
modifier|*
name|saved
parameter_list|,
name|int
name|print
parameter_list|)
block|{
return|return
name|atom_get_src_int
argument_list|(
name|ctx
argument_list|,
name|arg
operator||
name|atom_dst_to_src
index|[
operator|(
name|attr
operator|>>
literal|3
operator|)
operator|&
literal|7
index|]
index|[
operator|(
name|attr
operator|>>
literal|6
operator|)
operator|&
literal|3
index|]
operator|<<
literal|3
argument_list|,
name|ptr
argument_list|,
name|saved
argument_list|,
name|print
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_skip_dst
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
name|arg
parameter_list|,
name|uint8_t
name|attr
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|)
block|{
name|atom_skip_src_int
argument_list|(
name|ctx
argument_list|,
name|arg
operator||
name|atom_dst_to_src
index|[
operator|(
name|attr
operator|>>
literal|3
operator|)
operator|&
literal|7
index|]
index|[
operator|(
name|attr
operator|>>
literal|6
operator|)
operator|&
literal|3
index|]
operator|<<
literal|3
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_put_dst
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
name|arg
parameter_list|,
name|uint8_t
name|attr
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|uint32_t
name|val
parameter_list|,
name|uint32_t
name|saved
parameter_list|)
block|{
name|uint32_t
name|align
init|=
name|atom_dst_to_src
index|[
operator|(
name|attr
operator|>>
literal|3
operator|)
operator|&
literal|7
index|]
index|[
operator|(
name|attr
operator|>>
literal|6
operator|)
operator|&
literal|3
index|]
decl_stmt|,
name|old_val
init|=
name|val
decl_stmt|,
name|idx
decl_stmt|;
name|struct
name|atom_context
modifier|*
name|gctx
init|=
name|ctx
operator|->
name|ctx
decl_stmt|;
name|old_val
operator|&=
name|atom_arg_mask
index|[
name|align
index|]
operator|>>
name|atom_arg_shift
index|[
name|align
index|]
expr_stmt|;
name|val
operator|<<=
name|atom_arg_shift
index|[
name|align
index|]
expr_stmt|;
name|val
operator|&=
name|atom_arg_mask
index|[
name|align
index|]
expr_stmt|;
name|saved
operator|&=
operator|~
name|atom_arg_mask
index|[
name|align
index|]
expr_stmt|;
name|val
operator||=
name|saved
expr_stmt|;
switch|switch
condition|(
name|arg
condition|)
block|{
case|case
name|ATOM_ARG_REG
case|:
name|idx
operator|=
name|U16
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"REG[0x%04X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
name|gctx
operator|->
name|reg_block
expr_stmt|;
switch|switch
condition|(
name|gctx
operator|->
name|io_mode
condition|)
block|{
case|case
name|ATOM_IO_MM
case|:
if|if
condition|(
name|idx
operator|==
literal|0
condition|)
name|gctx
operator|->
name|card
operator|->
name|reg_write
argument_list|(
name|gctx
operator|->
name|card
argument_list|,
name|idx
argument_list|,
name|val
operator|<<
literal|2
argument_list|)
expr_stmt|;
else|else
name|gctx
operator|->
name|card
operator|->
name|reg_write
argument_list|(
name|gctx
operator|->
name|card
argument_list|,
name|idx
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_IO_PCI
case|:
name|DRM_INFO
argument_list|(
literal|"PCI registers are not implemented.\n"
argument_list|)
expr_stmt|;
return|return;
case|case
name|ATOM_IO_SYSIO
case|:
name|DRM_INFO
argument_list|(
literal|"SYSIO registers are not implemented.\n"
argument_list|)
expr_stmt|;
return|return;
default|default:
if|if
condition|(
operator|!
operator|(
name|gctx
operator|->
name|io_mode
operator|&
literal|0x80
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Bad IO mode.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|gctx
operator|->
name|iio
index|[
name|gctx
operator|->
name|io_mode
operator|&
literal|0xFF
index|]
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Undefined indirect IO write method %d.\n"
argument_list|,
name|gctx
operator|->
name|io_mode
operator|&
literal|0x7F
argument_list|)
expr_stmt|;
return|return;
block|}
name|atom_iio_execute
argument_list|(
name|gctx
argument_list|,
name|gctx
operator|->
name|iio
index|[
name|gctx
operator|->
name|io_mode
operator|&
literal|0xFF
index|]
argument_list|,
name|idx
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ATOM_ARG_PS
case|:
name|idx
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"PS[0x%02X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ps
index|[
name|idx
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_ARG_WS
case|:
name|idx
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"WS[0x%02X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|idx
condition|)
block|{
case|case
name|ATOM_WS_QUOTIENT
case|:
name|gctx
operator|->
name|divmul
index|[
literal|0
index|]
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ATOM_WS_REMAINDER
case|:
name|gctx
operator|->
name|divmul
index|[
literal|1
index|]
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ATOM_WS_DATAPTR
case|:
name|gctx
operator|->
name|data_block
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ATOM_WS_SHIFT
case|:
name|gctx
operator|->
name|shift
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ATOM_WS_OR_MASK
case|:
case|case
name|ATOM_WS_AND_MASK
case|:
break|break;
case|case
name|ATOM_WS_FB_WINDOW
case|:
name|gctx
operator|->
name|fb_base
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ATOM_WS_ATTRIBUTES
case|:
name|gctx
operator|->
name|io_attr
operator|=
name|val
expr_stmt|;
break|break;
case|case
name|ATOM_WS_REGPTR
case|:
name|gctx
operator|->
name|reg_block
operator|=
name|val
expr_stmt|;
break|break;
default|default:
name|ctx
operator|->
name|ws
index|[
name|idx
index|]
operator|=
name|val
expr_stmt|;
block|}
break|break;
case|case
name|ATOM_ARG_FB
case|:
name|idx
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|gctx
operator|->
name|fb_base
operator|+
operator|(
name|idx
operator|*
literal|4
operator|)
operator|)
operator|>
name|gctx
operator|->
name|scratch_size_bytes
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ATOM: fb write beyond scratch region: %d vs. %d\n"
argument_list|,
name|gctx
operator|->
name|fb_base
operator|+
operator|(
name|idx
operator|*
literal|4
operator|)
argument_list|,
name|gctx
operator|->
name|scratch_size_bytes
argument_list|)
expr_stmt|;
block|}
else|else
name|gctx
operator|->
name|scratch
index|[
operator|(
name|gctx
operator|->
name|fb_base
operator|/
literal|4
operator|)
operator|+
name|idx
index|]
operator|=
name|val
expr_stmt|;
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"FB[0x%02X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_ARG_PLL
case|:
name|idx
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"PLL[0x%02X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|gctx
operator|->
name|card
operator|->
name|pll_write
argument_list|(
name|gctx
operator|->
name|card
argument_list|,
name|idx
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_ARG_MC
case|:
name|idx
operator|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
name|ATOM_DEBUG_PRINT
argument_list|(
literal|"MC[0x%02X]"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|gctx
operator|->
name|card
operator|->
name|mc_write
argument_list|(
name|gctx
operator|->
name|card
argument_list|,
name|idx
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|align
condition|)
block|{
case|case
name|ATOM_SRC_DWORD
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[31:0]<- 0x%08X\n"
argument_list|,
name|old_val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_WORD0
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[15:0]<- 0x%04X\n"
argument_list|,
name|old_val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_WORD8
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[23:8]<- 0x%04X\n"
argument_list|,
name|old_val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_WORD16
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[31:16]<- 0x%04X\n"
argument_list|,
name|old_val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_BYTE0
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[7:0]<- 0x%02X\n"
argument_list|,
name|old_val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_BYTE8
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[15:8]<- 0x%02X\n"
argument_list|,
name|old_val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_BYTE16
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[23:16]<- 0x%02X\n"
argument_list|,
name|old_val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_SRC_BYTE24
case|:
name|ATOM_DEBUG_PRINT
argument_list|(
literal|".[31:24]<- 0x%02X\n"
argument_list|,
name|old_val
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_add
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|dst
decl_stmt|,
name|src
decl_stmt|,
name|saved
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|dst
operator|+=
name|src
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|dst
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_and
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|dst
decl_stmt|,
name|src
decl_stmt|,
name|saved
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|dst
operator|&=
name|src
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|dst
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_beep
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|DRM_INFO
argument_list|(
literal|"ATOM BIOS beeped!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_calltable
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|int
name|idx
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|idx
operator|<
name|ATOM_TABLE_NAMES_CNT
condition|)
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   table: %d (%s)\n"
argument_list|,
name|idx
argument_list|,
name|atom_table_names
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
else|else
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   table: %d\n"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|U16
argument_list|(
name|ctx
operator|->
name|ctx
operator|->
name|cmd_table
operator|+
literal|4
operator|+
literal|2
operator|*
name|idx
argument_list|)
condition|)
name|r
operator|=
name|atom_execute_table_locked
argument_list|(
name|ctx
operator|->
name|ctx
argument_list|,
name|idx
argument_list|,
name|ctx
operator|->
name|ps
operator|+
name|ctx
operator|->
name|ps_shift
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|ctx
operator|->
name|abort
operator|=
name|true
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_clear
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|saved
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|attr
operator|&=
literal|0x38
expr_stmt|;
name|attr
operator||=
name|atom_def_dst
index|[
name|attr
operator|>>
literal|3
index|]
operator|<<
literal|6
expr_stmt|;
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
literal|0
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_compare
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|dst
decl_stmt|,
name|src
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src1: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src2: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ctx
operator|->
name|cs_equal
operator|=
operator|(
name|dst
operator|==
name|src
operator|)
expr_stmt|;
name|ctx
operator|->
name|ctx
operator|->
name|cs_above
operator|=
operator|(
name|dst
operator|>
name|src
operator|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   result: %s %s\n"
argument_list|,
name|ctx
operator|->
name|ctx
operator|->
name|cs_equal
condition|?
literal|"EQ"
else|:
literal|"NE"
argument_list|,
name|ctx
operator|->
name|ctx
operator|->
name|cs_above
condition|?
literal|"GT"
else|:
literal|"LE"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_delay
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|unsigned
name|count
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   count: %d\n"
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|==
name|ATOM_UNIT_MICROSEC
condition|)
name|DRM_UDELAY
argument_list|(
name|count
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|drm_can_sleep
argument_list|()
condition|)
name|DRM_MDELAY
argument_list|(
name|count
argument_list|)
expr_stmt|;
else|else
name|DRM_MSLEEP
argument_list|(
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_div
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|dst
decl_stmt|,
name|src
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src1: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src2: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
operator|!=
literal|0
condition|)
block|{
name|ctx
operator|->
name|ctx
operator|->
name|divmul
index|[
literal|0
index|]
operator|=
name|dst
operator|/
name|src
expr_stmt|;
name|ctx
operator|->
name|ctx
operator|->
name|divmul
index|[
literal|1
index|]
operator|=
name|dst
operator|%
name|src
expr_stmt|;
block|}
else|else
block|{
name|ctx
operator|->
name|ctx
operator|->
name|divmul
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|ctx
operator|->
name|divmul
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_eot
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
comment|/* functionally, a nop */
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_jump
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|int
name|execute
init|=
literal|0
decl_stmt|,
name|target
init|=
name|U16
argument_list|(
operator|*
name|ptr
argument_list|)
decl_stmt|;
name|unsigned
name|long
name|cjiffies
decl_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
switch|switch
condition|(
name|arg
condition|)
block|{
case|case
name|ATOM_COND_ABOVE
case|:
name|execute
operator|=
name|ctx
operator|->
name|ctx
operator|->
name|cs_above
expr_stmt|;
break|break;
case|case
name|ATOM_COND_ABOVEOREQUAL
case|:
name|execute
operator|=
name|ctx
operator|->
name|ctx
operator|->
name|cs_above
operator|||
name|ctx
operator|->
name|ctx
operator|->
name|cs_equal
expr_stmt|;
break|break;
case|case
name|ATOM_COND_ALWAYS
case|:
name|execute
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ATOM_COND_BELOW
case|:
name|execute
operator|=
operator|!
operator|(
name|ctx
operator|->
name|ctx
operator|->
name|cs_above
operator|||
name|ctx
operator|->
name|ctx
operator|->
name|cs_equal
operator|)
expr_stmt|;
break|break;
case|case
name|ATOM_COND_BELOWOREQUAL
case|:
name|execute
operator|=
operator|!
name|ctx
operator|->
name|ctx
operator|->
name|cs_above
expr_stmt|;
break|break;
case|case
name|ATOM_COND_EQUAL
case|:
name|execute
operator|=
name|ctx
operator|->
name|ctx
operator|->
name|cs_equal
expr_stmt|;
break|break;
case|case
name|ATOM_COND_NOTEQUAL
case|:
name|execute
operator|=
operator|!
name|ctx
operator|->
name|ctx
operator|->
name|cs_equal
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|arg
operator|!=
name|ATOM_COND_ALWAYS
condition|)
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   taken: %s\n"
argument_list|,
name|execute
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   target: 0x%04X\n"
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|execute
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|last_jump
operator|==
operator|(
name|ctx
operator|->
name|start
operator|+
name|target
operator|)
condition|)
block|{
name|cjiffies
operator|=
name|jiffies
expr_stmt|;
if|if
condition|(
name|time_after
argument_list|(
name|cjiffies
argument_list|,
name|ctx
operator|->
name|last_jump_jiffies
argument_list|)
condition|)
block|{
name|cjiffies
operator|-=
name|ctx
operator|->
name|last_jump_jiffies
expr_stmt|;
if|if
condition|(
operator|(
name|jiffies_to_msecs
argument_list|(
name|cjiffies
argument_list|)
operator|>
literal|5000
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"atombios stuck in loop for more than 5secs aborting\n"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|abort
operator|=
name|true
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* jiffies wrap around we will just wait a little longer */
name|ctx
operator|->
name|last_jump_jiffies
operator|=
name|jiffies
expr_stmt|;
block|}
block|}
else|else
block|{
name|ctx
operator|->
name|last_jump
operator|=
name|ctx
operator|->
name|start
operator|+
name|target
expr_stmt|;
name|ctx
operator|->
name|last_jump_jiffies
operator|=
name|jiffies
expr_stmt|;
block|}
operator|*
name|ptr
operator|=
name|ctx
operator|->
name|start
operator|+
name|target
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_mask
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|dst
decl_stmt|,
name|mask
decl_stmt|,
name|src
decl_stmt|,
name|saved
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mask
operator|=
name|atom_get_src_direct
argument_list|(
name|ctx
argument_list|,
operator|(
operator|(
name|attr
operator|>>
literal|3
operator|)
operator|&
literal|7
operator|)
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   mask: 0x%08x"
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|dst
operator|&=
name|mask
expr_stmt|;
name|dst
operator||=
name|src
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|dst
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_move
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|src
decl_stmt|,
name|saved
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|attr
operator|>>
literal|3
operator|)
operator|&
literal|7
operator|)
operator|!=
name|ATOM_SRC_DWORD
condition|)
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|atom_skip_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|saved
operator|=
literal|0xCDCDCDCD
expr_stmt|;
block|}
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|src
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_mul
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|dst
decl_stmt|,
name|src
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src1: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src2: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ctx
operator|->
name|divmul
index|[
literal|0
index|]
operator|=
name|dst
operator|*
name|src
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_nop
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
comment|/* nothing */
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_or
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|dst
decl_stmt|,
name|src
decl_stmt|,
name|saved
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|dst
operator||=
name|src
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|dst
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_postcard
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|val
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"POST card output: 0x%02X\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_repeat
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|DRM_INFO
argument_list|(
literal|"unimplemented!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_restorereg
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|DRM_INFO
argument_list|(
literal|"unimplemented!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_savereg
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|DRM_INFO
argument_list|(
literal|"unimplemented!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_setdatablock
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|int
name|idx
init|=
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
decl_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   block: %d\n"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|idx
condition|)
name|ctx
operator|->
name|ctx
operator|->
name|data_block
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|idx
operator|==
literal|255
condition|)
name|ctx
operator|->
name|ctx
operator|->
name|data_block
operator|=
name|ctx
operator|->
name|start
expr_stmt|;
else|else
name|ctx
operator|->
name|ctx
operator|->
name|data_block
operator|=
name|U16
argument_list|(
name|ctx
operator|->
name|ctx
operator|->
name|data_table
operator|+
literal|4
operator|+
literal|2
operator|*
name|idx
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   base: 0x%04X\n"
argument_list|,
name|ctx
operator|->
name|ctx
operator|->
name|data_block
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_setfbbase
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   fb_base: "
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ctx
operator|->
name|fb_base
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_setport
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|int
name|port
decl_stmt|;
switch|switch
condition|(
name|arg
condition|)
block|{
case|case
name|ATOM_PORT_ATI
case|:
name|port
operator|=
name|U16
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|<
name|ATOM_IO_NAMES_CNT
condition|)
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   port: %d (%s)\n"
argument_list|,
name|port
argument_list|,
name|atom_io_names
index|[
name|port
index|]
argument_list|)
expr_stmt|;
else|else
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   port: %d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
name|ctx
operator|->
name|ctx
operator|->
name|io_mode
operator|=
name|ATOM_IO_MM
expr_stmt|;
else|else
name|ctx
operator|->
name|ctx
operator|->
name|io_mode
operator|=
name|ATOM_IO_IIO
operator||
name|port
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|ATOM_PORT_PCI
case|:
name|ctx
operator|->
name|ctx
operator|->
name|io_mode
operator|=
name|ATOM_IO_PCI
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
break|break;
case|case
name|ATOM_PORT_SYSIO
case|:
name|ctx
operator|->
name|ctx
operator|->
name|io_mode
operator|=
name|ATOM_IO_SYSIO
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_setregblock
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|ctx
operator|->
name|ctx
operator|->
name|reg_block
operator|=
name|U16
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   base: 0x%04X\n"
argument_list|,
name|ctx
operator|->
name|ctx
operator|->
name|reg_block
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_shift_left
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|,
name|shift
decl_stmt|;
name|uint32_t
name|saved
decl_stmt|,
name|dst
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|attr
operator|&=
literal|0x38
expr_stmt|;
name|attr
operator||=
name|atom_def_dst
index|[
name|attr
operator|>>
literal|3
index|]
operator|<<
literal|6
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|shift
operator|=
name|atom_get_src_direct
argument_list|(
name|ctx
argument_list|,
name|ATOM_SRC_BYTE0
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   shift: %d\n"
argument_list|,
name|shift
argument_list|)
expr_stmt|;
name|dst
operator|<<=
name|shift
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|dst
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_shift_right
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|,
name|shift
decl_stmt|;
name|uint32_t
name|saved
decl_stmt|,
name|dst
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|attr
operator|&=
literal|0x38
expr_stmt|;
name|attr
operator||=
name|atom_def_dst
index|[
name|attr
operator|>>
literal|3
index|]
operator|<<
literal|6
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|shift
operator|=
name|atom_get_src_direct
argument_list|(
name|ctx
argument_list|,
name|ATOM_SRC_BYTE0
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   shift: %d\n"
argument_list|,
name|shift
argument_list|)
expr_stmt|;
name|dst
operator|>>=
name|shift
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|dst
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_shl
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|,
name|shift
decl_stmt|;
name|uint32_t
name|saved
decl_stmt|,
name|dst
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|uint32_t
name|dst_align
init|=
name|atom_dst_to_src
index|[
operator|(
name|attr
operator|>>
literal|3
operator|)
operator|&
literal|7
index|]
index|[
operator|(
name|attr
operator|>>
literal|6
operator|)
operator|&
literal|3
index|]
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* op needs to full dst value */
name|dst
operator|=
name|saved
expr_stmt|;
name|shift
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   shift: %d\n"
argument_list|,
name|shift
argument_list|)
expr_stmt|;
name|dst
operator|<<=
name|shift
expr_stmt|;
name|dst
operator|&=
name|atom_arg_mask
index|[
name|dst_align
index|]
expr_stmt|;
name|dst
operator|>>=
name|atom_arg_shift
index|[
name|dst_align
index|]
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|dst
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_shr
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|,
name|shift
decl_stmt|;
name|uint32_t
name|saved
decl_stmt|,
name|dst
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|uint32_t
name|dst_align
init|=
name|atom_dst_to_src
index|[
operator|(
name|attr
operator|>>
literal|3
operator|)
operator|&
literal|7
index|]
index|[
operator|(
name|attr
operator|>>
literal|6
operator|)
operator|&
literal|3
index|]
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* op needs to full dst value */
name|dst
operator|=
name|saved
expr_stmt|;
name|shift
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   shift: %d\n"
argument_list|,
name|shift
argument_list|)
expr_stmt|;
name|dst
operator|>>=
name|shift
expr_stmt|;
name|dst
operator|&=
name|atom_arg_mask
index|[
name|dst_align
index|]
expr_stmt|;
name|dst
operator|>>=
name|atom_arg_shift
index|[
name|dst_align
index|]
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|dst
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_sub
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|dst
decl_stmt|,
name|src
decl_stmt|,
name|saved
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|dst
operator|-=
name|src
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|dst
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_switch
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|src
decl_stmt|,
name|val
decl_stmt|,
name|target
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   switch: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
while|while
condition|(
name|U16
argument_list|(
operator|*
name|ptr
argument_list|)
operator|!=
name|ATOM_CASE_END
condition|)
if|if
condition|(
name|U8
argument_list|(
operator|*
name|ptr
argument_list|)
operator|==
name|ATOM_CASE_MAGIC
condition|)
block|{
operator|(
operator|*
name|ptr
operator|)
operator|++
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   case: "
argument_list|)
expr_stmt|;
name|val
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
operator|(
name|attr
operator|&
literal|0x38
operator|)
operator||
name|ATOM_ARG_IMM
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|target
operator|=
name|U16
argument_list|(
operator|*
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|src
condition|)
block|{
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   target: %04X\n"
argument_list|,
name|target
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|=
name|ctx
operator|->
name|start
operator|+
name|target
expr_stmt|;
return|return;
block|}
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"Bad case.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
operator|*
name|ptr
operator|)
operator|+=
literal|2
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_test
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|dst
decl_stmt|,
name|src
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src1: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src2: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ctx
operator|->
name|cs_equal
operator|=
operator|(
operator|(
name|dst
operator|&
name|src
operator|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   result: %s\n"
argument_list|,
name|ctx
operator|->
name|ctx
operator|->
name|cs_equal
condition|?
literal|"EQ"
else|:
literal|"NE"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_xor
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|uint8_t
name|attr
init|=
name|U8
argument_list|(
operator|(
operator|*
name|ptr
operator|)
operator|++
argument_list|)
decl_stmt|;
name|uint32_t
name|dst
decl_stmt|,
name|src
decl_stmt|,
name|saved
decl_stmt|;
name|int
name|dptr
init|=
operator|*
name|ptr
decl_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|dst
operator|=
name|atom_get_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|,
operator|&
name|saved
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   src: "
argument_list|)
expr_stmt|;
name|src
operator|=
name|atom_get_src
argument_list|(
name|ctx
argument_list|,
name|attr
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|dst
operator|^=
name|src
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"   dst: "
argument_list|)
expr_stmt|;
name|atom_put_dst
argument_list|(
name|ctx
argument_list|,
name|arg
argument_list|,
name|attr
argument_list|,
operator|&
name|dptr
argument_list|,
name|dst
argument_list|,
name|saved
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|atom_op_debug
parameter_list|(
name|atom_exec_context
modifier|*
name|ctx
parameter_list|,
name|int
modifier|*
name|ptr
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|DRM_INFO
argument_list|(
literal|"unimplemented!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
specifier|static
struct|struct
block|{
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|atom_exec_context
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
name|int
name|arg
decl_stmt|;
block|}
name|opcode_table
index|[
name|ATOM_OP_CNT
index|]
init|=
block|{
block|{
name|NULL
block|,
literal|0
block|}
block|,
block|{
name|atom_op_move
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_move
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_move
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_move
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_move
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_move
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_and
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_and
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_and
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_and
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_and
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_and
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_or
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_or
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_or
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_or
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_or
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_or
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_shift_left
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_shift_left
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_shift_left
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_shift_left
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_shift_left
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_shift_left
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_shift_right
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_shift_right
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_shift_right
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_shift_right
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_shift_right
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_shift_right
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_mul
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_mul
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_mul
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_mul
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_mul
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_mul
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_div
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_div
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_div
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_div
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_div
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_div
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_add
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_add
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_add
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_add
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_add
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_add
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_sub
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_sub
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_sub
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_sub
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_sub
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_sub
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_setport
block|,
name|ATOM_PORT_ATI
block|}
block|,
block|{
name|atom_op_setport
block|,
name|ATOM_PORT_PCI
block|}
block|,
block|{
name|atom_op_setport
block|,
name|ATOM_PORT_SYSIO
block|}
block|,
block|{
name|atom_op_setregblock
block|,
literal|0
block|}
block|,
block|{
name|atom_op_setfbbase
block|,
literal|0
block|}
block|,
block|{
name|atom_op_compare
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_compare
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_compare
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_compare
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_compare
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_compare
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_switch
block|,
literal|0
block|}
block|,
block|{
name|atom_op_jump
block|,
name|ATOM_COND_ALWAYS
block|}
block|,
block|{
name|atom_op_jump
block|,
name|ATOM_COND_EQUAL
block|}
block|,
block|{
name|atom_op_jump
block|,
name|ATOM_COND_BELOW
block|}
block|,
block|{
name|atom_op_jump
block|,
name|ATOM_COND_ABOVE
block|}
block|,
block|{
name|atom_op_jump
block|,
name|ATOM_COND_BELOWOREQUAL
block|}
block|,
block|{
name|atom_op_jump
block|,
name|ATOM_COND_ABOVEOREQUAL
block|}
block|,
block|{
name|atom_op_jump
block|,
name|ATOM_COND_NOTEQUAL
block|}
block|,
block|{
name|atom_op_test
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_test
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_test
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_test
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_test
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_test
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_delay
block|,
name|ATOM_UNIT_MILLISEC
block|}
block|,
block|{
name|atom_op_delay
block|,
name|ATOM_UNIT_MICROSEC
block|}
block|,
block|{
name|atom_op_calltable
block|,
literal|0
block|}
block|,
block|{
name|atom_op_repeat
block|,
literal|0
block|}
block|,
block|{
name|atom_op_clear
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_clear
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_clear
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_clear
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_clear
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_clear
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_nop
block|,
literal|0
block|}
block|,
block|{
name|atom_op_eot
block|,
literal|0
block|}
block|,
block|{
name|atom_op_mask
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_mask
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_mask
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_mask
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_mask
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_mask
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_postcard
block|,
literal|0
block|}
block|,
block|{
name|atom_op_beep
block|,
literal|0
block|}
block|,
block|{
name|atom_op_savereg
block|,
literal|0
block|}
block|,
block|{
name|atom_op_restorereg
block|,
literal|0
block|}
block|,
block|{
name|atom_op_setdatablock
block|,
literal|0
block|}
block|,
block|{
name|atom_op_xor
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_xor
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_xor
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_xor
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_xor
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_xor
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_shl
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_shl
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_shl
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_shl
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_shl
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_shl
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_shr
block|,
name|ATOM_ARG_REG
block|}
block|,
block|{
name|atom_op_shr
block|,
name|ATOM_ARG_PS
block|}
block|,
block|{
name|atom_op_shr
block|,
name|ATOM_ARG_WS
block|}
block|,
block|{
name|atom_op_shr
block|,
name|ATOM_ARG_FB
block|}
block|,
block|{
name|atom_op_shr
block|,
name|ATOM_ARG_PLL
block|}
block|,
block|{
name|atom_op_shr
block|,
name|ATOM_ARG_MC
block|}
block|,
block|{
name|atom_op_debug
block|,
literal|0
block|}
block|,}
struct|;
end_struct

begin_function
specifier|static
name|int
name|atom_execute_table_locked
parameter_list|(
name|struct
name|atom_context
modifier|*
name|ctx
parameter_list|,
name|int
name|index
parameter_list|,
name|uint32_t
modifier|*
name|params
parameter_list|)
block|{
name|int
name|base
init|=
name|CU16
argument_list|(
name|ctx
operator|->
name|cmd_table
operator|+
literal|4
operator|+
literal|2
operator|*
name|index
argument_list|)
decl_stmt|;
name|int
name|len
decl_stmt|,
name|ws
decl_stmt|,
name|ps
decl_stmt|,
name|ptr
decl_stmt|;
name|unsigned
name|char
name|op
decl_stmt|;
name|atom_exec_context
name|ectx
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|base
condition|)
return|return
operator|-
name|EINVAL
return|;
name|len
operator|=
name|CU16
argument_list|(
name|base
operator|+
name|ATOM_CT_SIZE_PTR
argument_list|)
expr_stmt|;
name|ws
operator|=
name|CU8
argument_list|(
name|base
operator|+
name|ATOM_CT_WS_PTR
argument_list|)
expr_stmt|;
name|ps
operator|=
name|CU8
argument_list|(
name|base
operator|+
name|ATOM_CT_PS_PTR
argument_list|)
operator|&
name|ATOM_CT_PS_MASK
expr_stmt|;
name|ptr
operator|=
name|base
operator|+
name|ATOM_CT_CODE_PTR
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|">> execute %04X (len %d, WS %d, PS %d)\n"
argument_list|,
name|base
argument_list|,
name|len
argument_list|,
name|ws
argument_list|,
name|ps
argument_list|)
expr_stmt|;
name|ectx
operator|.
name|ctx
operator|=
name|ctx
expr_stmt|;
name|ectx
operator|.
name|ps_shift
operator|=
name|ps
operator|/
literal|4
expr_stmt|;
name|ectx
operator|.
name|start
operator|=
name|base
expr_stmt|;
name|ectx
operator|.
name|ps
operator|=
name|params
expr_stmt|;
name|ectx
operator|.
name|abort
operator|=
name|false
expr_stmt|;
name|ectx
operator|.
name|last_jump
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ws
condition|)
name|ectx
operator|.
name|ws
operator|=
name|malloc
argument_list|(
literal|4
operator|*
name|ws
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
else|else
name|ectx
operator|.
name|ws
operator|=
name|NULL
expr_stmt|;
name|debug_depth
operator|++
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|op
operator|=
name|CU8
argument_list|(
name|ptr
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|<
name|ATOM_OP_NAMES_CNT
condition|)
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"%s @ 0x%04X\n"
argument_list|,
name|atom_op_names
index|[
name|op
index|]
argument_list|,
name|ptr
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"[%d] @ 0x%04X\n"
argument_list|,
name|op
argument_list|,
name|ptr
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ectx
operator|.
name|abort
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"atombios stuck executing %04X (len %d, WS %d, PS %d) @ 0x%04X\n"
argument_list|,
name|base
argument_list|,
name|len
argument_list|,
name|ws
argument_list|,
name|ps
argument_list|,
name|ptr
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|free
goto|;
block|}
if|if
condition|(
name|op
operator|<
name|ATOM_OP_CNT
operator|&&
name|op
operator|>
literal|0
condition|)
name|opcode_table
index|[
name|op
index|]
operator|.
name|func
argument_list|(
operator|&
name|ectx
argument_list|,
operator|&
name|ptr
argument_list|,
name|opcode_table
index|[
name|op
index|]
operator|.
name|arg
argument_list|)
expr_stmt|;
else|else
break|break;
if|if
condition|(
name|op
operator|==
name|ATOM_OP_EOT
condition|)
break|break;
block|}
name|debug_depth
operator|--
expr_stmt|;
name|ATOM_SDEBUG_PRINT
argument_list|(
literal|"<<\n"
argument_list|)
expr_stmt|;
name|free
label|:
if|if
condition|(
name|ws
condition|)
name|free
argument_list|(
name|ectx
operator|.
name|ws
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|atom_execute_table
parameter_list|(
name|struct
name|atom_context
modifier|*
name|ctx
parameter_list|,
name|int
name|index
parameter_list|,
name|uint32_t
modifier|*
name|params
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|ctx
operator|->
name|mutex
argument_list|)
expr_stmt|;
comment|/* reset reg block */
name|ctx
operator|->
name|reg_block
operator|=
literal|0
expr_stmt|;
comment|/* reset fb window */
name|ctx
operator|->
name|fb_base
operator|=
literal|0
expr_stmt|;
comment|/* reset io mode */
name|ctx
operator|->
name|io_mode
operator|=
name|ATOM_IO_MM
expr_stmt|;
name|r
operator|=
name|atom_execute_table_locked
argument_list|(
name|ctx
argument_list|,
name|index
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|ctx
operator|->
name|mutex
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|atom_iio_len
index|[]
init|=
block|{
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|3
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|atom_index_iio
parameter_list|(
name|struct
name|atom_context
modifier|*
name|ctx
parameter_list|,
name|int
name|base
parameter_list|)
block|{
name|ctx
operator|->
name|iio
operator|=
name|malloc
argument_list|(
literal|2
operator|*
literal|256
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
while|while
condition|(
name|CU8
argument_list|(
name|base
argument_list|)
operator|==
name|ATOM_IIO_START
condition|)
block|{
name|ctx
operator|->
name|iio
index|[
name|CU8
argument_list|(
name|base
operator|+
literal|1
argument_list|)
index|]
operator|=
name|base
operator|+
literal|2
expr_stmt|;
name|base
operator|+=
literal|2
expr_stmt|;
while|while
condition|(
name|CU8
argument_list|(
name|base
argument_list|)
operator|!=
name|ATOM_IIO_END
condition|)
name|base
operator|+=
name|atom_iio_len
index|[
name|CU8
argument_list|(
name|base
argument_list|)
index|]
expr_stmt|;
name|base
operator|+=
literal|3
expr_stmt|;
block|}
block|}
end_function

begin_function
name|struct
name|atom_context
modifier|*
name|atom_parse
parameter_list|(
name|struct
name|card_info
modifier|*
name|card
parameter_list|,
name|void
modifier|*
name|bios
parameter_list|)
block|{
name|int
name|base
decl_stmt|;
name|struct
name|atom_context
modifier|*
name|ctx
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|atom_context
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|char
name|name
index|[
literal|512
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|ctx
condition|)
return|return
name|NULL
return|;
name|ctx
operator|->
name|card
operator|=
name|card
expr_stmt|;
name|ctx
operator|->
name|bios
operator|=
name|bios
expr_stmt|;
if|if
condition|(
name|CU16
argument_list|(
literal|0
argument_list|)
operator|!=
name|ATOM_BIOS_MAGIC
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Invalid BIOS magic.\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ctx
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|CSTR
argument_list|(
name|ATOM_ATI_MAGIC_PTR
argument_list|)
argument_list|,
name|ATOM_ATI_MAGIC
argument_list|,
name|strlen
argument_list|(
name|ATOM_ATI_MAGIC
argument_list|)
argument_list|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Invalid ATI magic.\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ctx
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|base
operator|=
name|CU16
argument_list|(
name|ATOM_ROM_TABLE_PTR
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|CSTR
argument_list|(
name|base
operator|+
name|ATOM_ROM_MAGIC_PTR
argument_list|)
argument_list|,
name|ATOM_ROM_MAGIC
argument_list|,
name|strlen
argument_list|(
name|ATOM_ROM_MAGIC
argument_list|)
argument_list|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Invalid ATOM magic.\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ctx
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ctx
operator|->
name|cmd_table
operator|=
name|CU16
argument_list|(
name|base
operator|+
name|ATOM_ROM_CMD_PTR
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|data_table
operator|=
name|CU16
argument_list|(
name|base
operator|+
name|ATOM_ROM_DATA_PTR
argument_list|)
expr_stmt|;
name|atom_index_iio
argument_list|(
name|ctx
argument_list|,
name|CU16
argument_list|(
name|ctx
operator|->
name|data_table
operator|+
name|ATOM_DATA_IIO_PTR
argument_list|)
operator|+
literal|4
argument_list|)
expr_stmt|;
name|str
operator|=
name|CSTR
argument_list|(
name|CU16
argument_list|(
name|base
operator|+
name|ATOM_ROM_MSG_PTR
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|str
operator|&&
operator|(
operator|(
operator|*
name|str
operator|==
literal|'\n'
operator|)
operator|||
operator|(
operator|*
name|str
operator|==
literal|'\r'
operator|)
operator|)
condition|)
name|str
operator|++
expr_stmt|;
comment|/* name string isn't always 0 terminated */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|511
condition|;
name|i
operator|++
control|)
block|{
name|name
index|[
name|i
index|]
operator|=
name|str
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|name
index|[
name|i
index|]
operator|<
literal|'.'
operator|||
name|name
index|[
name|i
index|]
operator|>
literal|'z'
condition|)
block|{
name|name
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|DRM_INFO
argument_list|(
literal|"ATOM BIOS: %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|ctx
return|;
block|}
end_function

begin_function
name|int
name|atom_asic_init
parameter_list|(
name|struct
name|atom_context
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|ctx
operator|->
name|card
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|hwi
init|=
name|CU16
argument_list|(
name|ctx
operator|->
name|data_table
operator|+
name|ATOM_DATA_FWI_PTR
argument_list|)
decl_stmt|;
name|uint32_t
name|ps
index|[
literal|16
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
name|ps
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|ps
index|[
literal|0
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|CU32
argument_list|(
name|hwi
operator|+
name|ATOM_FWI_DEFSCLK_PTR
argument_list|)
argument_list|)
expr_stmt|;
name|ps
index|[
literal|1
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|CU32
argument_list|(
name|hwi
operator|+
name|ATOM_FWI_DEFMCLK_PTR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ps
index|[
literal|0
index|]
operator|||
operator|!
name|ps
index|[
literal|1
index|]
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|CU16
argument_list|(
name|ctx
operator|->
name|cmd_table
operator|+
literal|4
operator|+
literal|2
operator|*
name|ATOM_CMD_INIT
argument_list|)
condition|)
return|return
literal|1
return|;
name|ret
operator|=
name|atom_execute_table
argument_list|(
name|ctx
argument_list|,
name|ATOM_CMD_INIT
argument_list|,
name|ps
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|memset
argument_list|(
name|ps
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|<
name|CHIP_R600
condition|)
block|{
if|if
condition|(
name|CU16
argument_list|(
name|ctx
operator|->
name|cmd_table
operator|+
literal|4
operator|+
literal|2
operator|*
name|ATOM_CMD_SPDFANCNTL
argument_list|)
condition|)
name|atom_execute_table
argument_list|(
name|ctx
argument_list|,
name|ATOM_CMD_SPDFANCNTL
argument_list|,
name|ps
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|atom_destroy
parameter_list|(
name|struct
name|atom_context
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|ctx
operator|->
name|iio
condition|)
name|free
argument_list|(
name|ctx
operator|->
name|iio
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ctx
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|bool
name|atom_parse_data_header
parameter_list|(
name|struct
name|atom_context
modifier|*
name|ctx
parameter_list|,
name|int
name|index
parameter_list|,
name|uint16_t
modifier|*
name|size
parameter_list|,
name|uint8_t
modifier|*
name|frev
parameter_list|,
name|uint8_t
modifier|*
name|crev
parameter_list|,
name|uint16_t
modifier|*
name|data_start
parameter_list|)
block|{
name|int
name|offset
init|=
name|index
operator|*
literal|2
operator|+
literal|4
decl_stmt|;
name|int
name|idx
init|=
name|CU16
argument_list|(
name|ctx
operator|->
name|data_table
operator|+
name|offset
argument_list|)
decl_stmt|;
name|u16
modifier|*
name|mdt
init|=
operator|(
name|u16
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|ctx
operator|->
name|data_table
operator|+
literal|4
operator|)
decl_stmt|;
if|if
condition|(
operator|!
name|mdt
index|[
name|index
index|]
condition|)
return|return
name|false
return|;
if|if
condition|(
name|size
condition|)
operator|*
name|size
operator|=
name|CU16
argument_list|(
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|frev
condition|)
operator|*
name|frev
operator|=
name|CU8
argument_list|(
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|crev
condition|)
operator|*
name|crev
operator|=
name|CU8
argument_list|(
name|idx
operator|+
literal|3
argument_list|)
expr_stmt|;
operator|*
name|data_start
operator|=
name|idx
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
name|bool
name|atom_parse_cmd_header
parameter_list|(
name|struct
name|atom_context
modifier|*
name|ctx
parameter_list|,
name|int
name|index
parameter_list|,
name|uint8_t
modifier|*
name|frev
parameter_list|,
name|uint8_t
modifier|*
name|crev
parameter_list|)
block|{
name|int
name|offset
init|=
name|index
operator|*
literal|2
operator|+
literal|4
decl_stmt|;
name|int
name|idx
init|=
name|CU16
argument_list|(
name|ctx
operator|->
name|cmd_table
operator|+
name|offset
argument_list|)
decl_stmt|;
name|u16
modifier|*
name|mct
init|=
operator|(
name|u16
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|ctx
operator|->
name|cmd_table
operator|+
literal|4
operator|)
decl_stmt|;
if|if
condition|(
operator|!
name|mct
index|[
name|index
index|]
condition|)
return|return
name|false
return|;
if|if
condition|(
name|frev
condition|)
operator|*
name|frev
operator|=
name|CU8
argument_list|(
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|crev
condition|)
operator|*
name|crev
operator|=
name|CU8
argument_list|(
name|idx
operator|+
literal|3
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
name|int
name|atom_allocate_fb_scratch
parameter_list|(
name|struct
name|atom_context
modifier|*
name|ctx
parameter_list|)
block|{
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|VRAM_UsageByFirmware
argument_list|)
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|;
name|int
name|usage_bytes
init|=
literal|0
decl_stmt|;
name|struct
name|_ATOM_VRAM_USAGE_BY_FIRMWARE
modifier|*
name|firmware_usage
decl_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|ctx
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|firmware_usage
operator|=
operator|(
expr|struct
name|_ATOM_VRAM_USAGE_BY_FIRMWARE
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"atom firmware requested %08x %dkb\n"
argument_list|,
name|firmware_usage
operator|->
name|asFirmwareVramReserveInfo
index|[
literal|0
index|]
operator|.
name|ulStartAddrUsedByFirmware
argument_list|,
name|firmware_usage
operator|->
name|asFirmwareVramReserveInfo
index|[
literal|0
index|]
operator|.
name|usFirmwareUseInKb
argument_list|)
expr_stmt|;
name|usage_bytes
operator|=
name|firmware_usage
operator|->
name|asFirmwareVramReserveInfo
index|[
literal|0
index|]
operator|.
name|usFirmwareUseInKb
operator|*
literal|1024
expr_stmt|;
block|}
name|ctx
operator|->
name|scratch_size_bytes
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|usage_bytes
operator|==
literal|0
condition|)
name|usage_bytes
operator|=
literal|20
operator|*
literal|1024
expr_stmt|;
comment|/* allocate some scratch memory */
name|ctx
operator|->
name|scratch
operator|=
name|malloc
argument_list|(
name|usage_bytes
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctx
operator|->
name|scratch
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|ctx
operator|->
name|scratch_size_bytes
operator|=
name|usage_bytes
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


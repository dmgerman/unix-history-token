begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2007-8 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_define
define|#
directive|define
name|CURSOR_WIDTH
value|64
end_define

begin_define
define|#
directive|define
name|CURSOR_HEIGHT
value|64
end_define

begin_function
specifier|static
name|void
name|radeon_lock_cursor
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|bool
name|lock
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|crtc
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|uint32_t
name|cur_lock
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|cur_lock
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CUR_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock
condition|)
name|cur_lock
operator||=
name|EVERGREEN_CURSOR_UPDATE_LOCK
expr_stmt|;
else|else
name|cur_lock
operator|&=
operator|~
name|EVERGREEN_CURSOR_UPDATE_LOCK
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CUR_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|cur_lock
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|cur_lock
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1CUR_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock
condition|)
name|cur_lock
operator||=
name|AVIVO_D1CURSOR_UPDATE_LOCK
expr_stmt|;
else|else
name|cur_lock
operator|&=
operator|~
name|AVIVO_D1CURSOR_UPDATE_LOCK
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1CUR_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|cur_lock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cur_lock
operator|=
name|RREG32
argument_list|(
name|RADEON_CUR_OFFSET
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock
condition|)
name|cur_lock
operator||=
name|RADEON_CUR_LOCK
expr_stmt|;
else|else
name|cur_lock
operator|&=
operator|~
name|RADEON_CUR_LOCK
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CUR_OFFSET
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|cur_lock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_hide_cursor
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|crtc
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32_IDX
argument_list|(
name|EVERGREEN_CUR_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|EVERGREEN_CURSOR_MODE
argument_list|(
name|EVERGREEN_CURSOR_24_8_PRE_MULT
argument_list|)
operator||
name|EVERGREEN_CURSOR_URGENT_CONTROL
argument_list|(
name|EVERGREEN_CURSOR_URGENT_1_2
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32_IDX
argument_list|(
name|AVIVO_D1CUR_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|AVIVO_D1CURSOR_MODE_24BPP
operator|<<
name|AVIVO_D1CURSOR_MODE_SHIFT
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u32
name|reg
decl_stmt|;
switch|switch
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
block|{
case|case
literal|0
case|:
name|reg
operator|=
name|RADEON_CRTC_GEN_CNTL
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|reg
operator|=
name|RADEON_CRTC2_GEN_CNTL
expr_stmt|;
break|break;
default|default:
return|return;
block|}
name|WREG32_IDX
argument_list|(
name|reg
argument_list|,
name|RREG32_IDX
argument_list|(
name|reg
argument_list|)
operator|&
operator|~
name|RADEON_CRTC_CUR_EN
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_show_cursor
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|crtc
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_MM_INDEX
argument_list|,
name|EVERGREEN_CUR_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_MM_DATA
argument_list|,
name|EVERGREEN_CURSOR_EN
operator||
name|EVERGREEN_CURSOR_MODE
argument_list|(
name|EVERGREEN_CURSOR_24_8_PRE_MULT
argument_list|)
operator||
name|EVERGREEN_CURSOR_URGENT_CONTROL
argument_list|(
name|EVERGREEN_CURSOR_URGENT_1_2
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_MM_INDEX
argument_list|,
name|AVIVO_D1CUR_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_MM_DATA
argument_list|,
name|AVIVO_D1CURSOR_EN
operator||
operator|(
name|AVIVO_D1CURSOR_MODE_24BPP
operator|<<
name|AVIVO_D1CURSOR_MODE_SHIFT
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
block|{
case|case
literal|0
case|:
name|WREG32
argument_list|(
name|RADEON_MM_INDEX
argument_list|,
name|RADEON_CRTC_GEN_CNTL
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|WREG32
argument_list|(
name|RADEON_MM_INDEX
argument_list|,
name|RADEON_CRTC2_GEN_CNTL
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return;
block|}
name|WREG32_P
argument_list|(
name|RADEON_MM_DATA
argument_list|,
operator|(
name|RADEON_CRTC_CUR_EN
operator||
operator|(
name|RADEON_CRTC_CUR_MODE_24BPP
operator|<<
name|RADEON_CRTC_CUR_MODE_SHIFT
operator|)
operator|)
argument_list|,
operator|~
operator|(
name|RADEON_CRTC_CUR_EN
operator||
name|RADEON_CRTC_CUR_MODE_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_set_cursor
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|drm_gem_object
modifier|*
name|obj
parameter_list|,
name|uint64_t
name|gpu_addr
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|crtc
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|EVERGREEN_CUR_SURFACE_ADDRESS_HIGH
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|upper_32_bits
argument_list|(
name|gpu_addr
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CUR_SURFACE_ADDRESS
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|gpu_addr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
block|{
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
name|WREG32
argument_list|(
name|R700_D2CUR_SURFACE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|gpu_addr
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|R700_D1CUR_SURFACE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|gpu_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|AVIVO_D1CUR_SURFACE_ADDRESS
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|gpu_addr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_crtc
operator|->
name|legacy_cursor_offset
operator|=
name|gpu_addr
operator|-
name|radeon_crtc
operator|->
name|legacy_display_base_addr
expr_stmt|;
comment|/* offset is from DISP(2)_BASE_ADDRESS */
name|WREG32
argument_list|(
name|RADEON_CUR_OFFSET
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|radeon_crtc
operator|->
name|legacy_cursor_offset
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|radeon_crtc_cursor_set
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|,
name|uint32_t
name|handle
parameter_list|,
name|uint32_t
name|width
parameter_list|,
name|uint32_t
name|height
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|crtc
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_gem_object
modifier|*
name|obj
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|robj
decl_stmt|;
name|uint64_t
name|gpu_addr
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|handle
condition|)
block|{
comment|/* turn off cursor */
name|radeon_hide_cursor
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
goto|goto
name|unpin
goto|;
block|}
if|if
condition|(
operator|(
name|width
operator|>
name|CURSOR_WIDTH
operator|)
operator|||
operator|(
name|height
operator|>
name|CURSOR_HEIGHT
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad cursor width or height %d x %d\n"
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|obj
operator|=
name|drm_gem_object_lookup
argument_list|(
name|crtc
operator|->
name|dev
argument_list|,
name|file_priv
argument_list|,
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|obj
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Cannot find cursor object %x for crtc %d\n"
argument_list|,
name|handle
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOENT
return|;
block|}
name|robj
operator|=
name|gem_to_radeon_bo
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|ret
operator|=
name|radeon_bo_reserve
argument_list|(
name|robj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ret
operator|!=
literal|0
argument_list|)
condition|)
goto|goto
name|fail
goto|;
comment|/* Only 27 bit offset for legacy cursor */
name|ret
operator|=
name|radeon_bo_pin_restricted
argument_list|(
name|robj
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|?
literal|0
else|:
literal|1
operator|<<
literal|27
argument_list|,
operator|&
name|gpu_addr
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|robj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|radeon_crtc
operator|->
name|cursor_width
operator|=
name|width
expr_stmt|;
name|radeon_crtc
operator|->
name|cursor_height
operator|=
name|height
expr_stmt|;
name|radeon_lock_cursor
argument_list|(
name|crtc
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|radeon_set_cursor
argument_list|(
name|crtc
argument_list|,
name|obj
argument_list|,
name|gpu_addr
argument_list|)
expr_stmt|;
name|radeon_show_cursor
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
name|radeon_lock_cursor
argument_list|(
name|crtc
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|unpin
label|:
if|if
condition|(
name|radeon_crtc
operator|->
name|cursor_bo
condition|)
block|{
name|robj
operator|=
name|gem_to_radeon_bo
argument_list|(
name|radeon_crtc
operator|->
name|cursor_bo
argument_list|)
expr_stmt|;
name|ret
operator|=
name|radeon_bo_reserve
argument_list|(
name|robj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
name|ret
operator|==
literal|0
argument_list|)
condition|)
block|{
name|radeon_bo_unpin
argument_list|(
name|robj
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|robj
argument_list|)
expr_stmt|;
block|}
name|drm_gem_object_unreference_unlocked
argument_list|(
name|radeon_crtc
operator|->
name|cursor_bo
argument_list|)
expr_stmt|;
block|}
name|radeon_crtc
operator|->
name|cursor_bo
operator|=
name|obj
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
name|drm_gem_object_unreference_unlocked
argument_list|(
name|obj
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|radeon_crtc_cursor_move
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|crtc
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|xorigin
init|=
literal|0
decl_stmt|,
name|yorigin
init|=
literal|0
decl_stmt|;
name|int
name|w
init|=
name|radeon_crtc
operator|->
name|cursor_width
decl_stmt|;
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
comment|/* avivo cursor are offset into the total surface */
name|x
operator|+=
name|crtc
operator|->
name|x
expr_stmt|;
name|y
operator|+=
name|crtc
operator|->
name|y
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"x %d y %d c->x %d c->y %d\n"
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|crtc
operator|->
name|x
argument_list|,
name|crtc
operator|->
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
condition|)
block|{
name|xorigin
operator|=
name|min
argument_list|(
operator|-
name|x
argument_list|,
name|CURSOR_WIDTH
operator|-
literal|1
argument_list|)
expr_stmt|;
name|x
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|y
operator|<
literal|0
condition|)
block|{
name|yorigin
operator|=
name|min
argument_list|(
operator|-
name|y
argument_list|,
name|CURSOR_HEIGHT
operator|-
literal|1
argument_list|)
expr_stmt|;
name|y
operator|=
literal|0
expr_stmt|;
block|}
comment|/* fixed on DCE6 and newer */
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
operator|&&
operator|!
name|ASIC_IS_DCE6
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc_p
decl_stmt|;
comment|/* avivo cursor image can't end on 128 pixel boundary or 		 * go past the end of the frame if both crtcs are enabled 		 */
name|list_for_each_entry
argument_list|(
argument|crtc_p
argument_list|,
argument|&crtc->dev->mode_config.crtc_list
argument_list|,
argument|head
argument_list|)
block|{
if|if
condition|(
name|crtc_p
operator|->
name|enabled
condition|)
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|>
literal|1
condition|)
block|{
name|int
name|cursor_end
decl_stmt|,
name|frame_end
decl_stmt|;
name|cursor_end
operator|=
name|x
operator|-
name|xorigin
operator|+
name|w
expr_stmt|;
name|frame_end
operator|=
name|crtc
operator|->
name|x
operator|+
name|crtc
operator|->
name|mode
operator|.
name|crtc_hdisplay
expr_stmt|;
if|if
condition|(
name|cursor_end
operator|>=
name|frame_end
condition|)
block|{
name|w
operator|=
name|w
operator|-
operator|(
name|cursor_end
operator|-
name|frame_end
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|frame_end
operator|&
literal|0x7f
operator|)
condition|)
name|w
operator|--
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|cursor_end
operator|&
literal|0x7f
operator|)
condition|)
name|w
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|<=
literal|0
condition|)
block|{
name|w
operator|=
literal|1
expr_stmt|;
name|cursor_end
operator|=
name|x
operator|-
name|xorigin
operator|+
name|w
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cursor_end
operator|&
literal|0x7f
operator|)
condition|)
block|{
name|x
operator|--
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"%s: x(%d)< 0"
argument_list|,
name|__func__
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
name|radeon_lock_cursor
argument_list|(
name|crtc
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|EVERGREEN_CUR_POSITION
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CUR_HOT_SPOT
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|xorigin
operator|<<
literal|16
operator|)
operator||
name|yorigin
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CUR_SIZE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
operator|(
name|w
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|radeon_crtc
operator|->
name|cursor_height
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|AVIVO_D1CUR_POSITION
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1CUR_HOT_SPOT
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|xorigin
operator|<<
literal|16
operator|)
operator||
name|yorigin
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1CUR_SIZE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
operator|(
name|w
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|radeon_crtc
operator|->
name|cursor_height
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|crtc
operator|->
name|mode
operator|.
name|flags
operator|&
name|DRM_MODE_FLAG_DBLSCAN
condition|)
name|y
operator|*=
literal|2
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CUR_HORZ_VERT_OFF
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|RADEON_CUR_LOCK
operator||
operator|(
name|xorigin
operator|<<
literal|16
operator|)
operator||
name|yorigin
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CUR_HORZ_VERT_POSN
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|RADEON_CUR_LOCK
operator||
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
operator|)
argument_list|)
expr_stmt|;
comment|/* offset is from DISP(2)_BASE_ADDRESS */
name|WREG32
argument_list|(
name|RADEON_CUR_OFFSET
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|radeon_crtc
operator|->
name|legacy_cursor_offset
operator|+
operator|(
name|yorigin
operator|*
literal|256
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|radeon_lock_cursor
argument_list|(
name|crtc
argument_list|,
name|false
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon_reg.h"
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_comment
comment|/*  * BIOS.  */
end_comment

begin_comment
comment|/* If you boot an IGP board with a discrete card as the primary,  * the IGP rom is not accessible via the rom bar as the IGP rom is  * part of the system bios.  On boot, the system bios puts a  * copy of the igp rom at the start of vram if a discrete card is  * present.  */
end_comment

begin_function
specifier|static
name|bool
name|igp_read_bios_from_vram
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|drm_local_map_t
name|bios_map
decl_stmt|;
name|uint8_t
name|__iomem
modifier|*
name|bios
decl_stmt|;
name|resource_size_t
name|vram_base
decl_stmt|;
name|resource_size_t
name|size
init|=
literal|256
operator|*
literal|1024
decl_stmt|;
comment|/* ??? */
name|DRM_INFO
argument_list|(
literal|"%s: ===> Try IGP's VRAM...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
condition|)
if|if
condition|(
operator|!
name|radeon_card_posted
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"%s: not POSTed discrete card detected, skipping this method...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
name|vram_base
operator|=
name|drm_get_resource_start
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: VRAM base address: 0x%jx\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|uintmax_t
operator|)
name|vram_base
argument_list|)
expr_stmt|;
name|bios_map
operator|.
name|offset
operator|=
name|vram_base
expr_stmt|;
name|bios_map
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|bios_map
operator|.
name|type
operator|=
literal|0
expr_stmt|;
name|bios_map
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|bios_map
operator|.
name|mtrr
operator|=
literal|0
expr_stmt|;
name|drm_core_ioremap
argument_list|(
operator|&
name|bios_map
argument_list|,
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
if|if
condition|(
name|bios_map
operator|.
name|virtual
operator|==
name|NULL
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"%s: failed to ioremap\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|bios
operator|=
name|bios_map
operator|.
name|virtual
expr_stmt|;
name|size
operator|=
name|bios_map
operator|.
name|size
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: Map address: %p (%ju bytes)\n"
argument_list|,
name|__func__
argument_list|,
name|bios
argument_list|,
operator|(
name|uintmax_t
operator|)
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
operator|||
name|bios
index|[
literal|0
index|]
operator|!=
literal|0x55
operator|||
name|bios
index|[
literal|1
index|]
operator|!=
literal|0xaa
condition|)
block|{
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"%s: Incorrect BIOS size\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"%s: Incorrect BIOS signature: 0x%02X%02X\n"
argument_list|,
name|__func__
argument_list|,
name|bios
index|[
literal|0
index|]
argument_list|,
name|bios
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|drm_core_ioremapfree
argument_list|(
operator|&
name|bios_map
argument_list|,
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|rdev
operator|->
name|bios
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|bios
operator|==
name|NULL
condition|)
block|{
name|drm_core_ioremapfree
argument_list|(
operator|&
name|bios_map
argument_list|,
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|memcpy_fromio
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|bios
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|drm_core_ioremapfree
argument_list|(
operator|&
name|bios_map
argument_list|,
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_read_bios
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|device_t
name|vga_dev
decl_stmt|;
name|uint8_t
name|__iomem
modifier|*
name|bios
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: ===> Try PCI Expansion ROM...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|vga_dev
operator|=
name|device_get_parent
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
comment|/* XXX: some cards may return 0 for rom size? ddx has a workaround */
name|bios
operator|=
name|vga_pci_map_bios
argument_list|(
name|vga_dev
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bios
condition|)
block|{
return|return
name|false
return|;
block|}
name|DRM_INFO
argument_list|(
literal|"%s: Map address: %p (%zu bytes)\n"
argument_list|,
name|__func__
argument_list|,
name|bios
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
operator|||
name|bios
index|[
literal|0
index|]
operator|!=
literal|0x55
operator|||
name|bios
index|[
literal|1
index|]
operator|!=
literal|0xaa
condition|)
block|{
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"%s: Incorrect BIOS size\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"%s: Incorrect BIOS signature: 0x%02X%02X\n"
argument_list|,
name|__func__
argument_list|,
name|bios
index|[
literal|0
index|]
argument_list|,
name|bios
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|vga_pci_unmap_bios
argument_list|(
name|vga_dev
argument_list|,
name|bios
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|rdev
operator|->
name|bios
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|bios
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|vga_pci_unmap_bios
argument_list|(
name|vga_dev
argument_list|,
name|bios
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_comment
comment|/* ATRM is used to get the BIOS on the discrete cards in  * dual-gpu systems.  */
end_comment

begin_comment
comment|/* retrieve the ROM in 4k blocks */
end_comment

begin_define
define|#
directive|define
name|ATRM_BIOS_PAGE
value|4096
end_define

begin_comment
comment|/**  * radeon_atrm_call - fetch a chunk of the vbios  *  * @atrm_handle: acpi ATRM handle  * @bios: vbios image pointer  * @offset: offset of vbios image data to fetch  * @len: length of vbios image data to fetch  *  * Executes ATRM to fetch a chunk of the discrete  * vbios image on PX systems (all asics).  * Returns the length of the buffer fetched.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atrm_call
parameter_list|(
name|ACPI_HANDLE
name|atrm_handle
parameter_list|,
name|uint8_t
modifier|*
name|bios
parameter_list|,
name|int
name|offset
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_OBJECT
name|atrm_arg_elements
index|[
literal|2
index|]
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
name|ACPI_OBJECT_LIST
name|atrm_arg
decl_stmt|;
name|ACPI_BUFFER
name|buffer
init|=
block|{
name|ACPI_ALLOCATE_BUFFER
block|,
name|NULL
block|}
decl_stmt|;
name|atrm_arg
operator|.
name|Count
operator|=
literal|2
expr_stmt|;
name|atrm_arg
operator|.
name|Pointer
operator|=
operator|&
name|atrm_arg_elements
index|[
literal|0
index|]
expr_stmt|;
name|atrm_arg_elements
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|atrm_arg_elements
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|offset
expr_stmt|;
name|atrm_arg_elements
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|atrm_arg_elements
index|[
literal|1
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|len
expr_stmt|;
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|atrm_handle
argument_list|,
name|NULL
argument_list|,
operator|&
name|atrm_arg
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to evaluate ATRM got %s\n"
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENODEV
return|;
block|}
name|obj
operator|=
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|buffer
operator|.
name|Pointer
expr_stmt|;
name|memcpy
argument_list|(
name|bios
operator|+
name|offset
argument_list|,
name|obj
operator|->
name|Buffer
operator|.
name|Pointer
argument_list|,
name|obj
operator|->
name|Buffer
operator|.
name|Length
argument_list|)
expr_stmt|;
name|len
operator|=
name|obj
operator|->
name|Buffer
operator|.
name|Length
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|buffer
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_atrm_get_bios
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|int
name|size
init|=
literal|256
operator|*
literal|1024
decl_stmt|;
name|int
name|i
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|ACPI_HANDLE
name|dhandle
decl_stmt|,
name|atrm_handle
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|bool
name|found
init|=
name|false
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: ===> Try ATRM...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* ATRM is for the discrete card only */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"%s: IGP card detected, skipping this method...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
while|while
condition|(
operator|(
name|pdev
operator|=
name|pci_get_class
argument_list|(
name|PCI_CLASS_DISPLAY_VGA
operator|<<
literal|8
argument_list|,
name|pdev
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
if|if
condition|(
operator|(
name|dev
operator|=
name|pci_find_class
argument_list|(
name|PCIC_DISPLAY
argument_list|,
name|PCIS_DISPLAY_VGA
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"%s: pci_find_class() found: %d:%d:%d:%d, vendor=%04x, device=%04x\n"
argument_list|,
name|__func__
argument_list|,
name|pci_get_domain
argument_list|(
name|dev
argument_list|)
argument_list|,
name|pci_get_bus
argument_list|(
name|dev
argument_list|)
argument_list|,
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
argument_list|,
name|pci_get_function
argument_list|(
name|dev
argument_list|)
argument_list|,
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
argument_list|,
name|pci_get_device
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: Get ACPI device handle\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|dhandle
operator|=
name|acpi_get_handle
argument_list|(
name|dev
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
if|if
condition|(
operator|!
name|dhandle
condition|)
continue|continue;
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
if|if
condition|(
operator|!
name|dhandle
condition|)
return|return
name|false
return|;
name|DRM_INFO
argument_list|(
literal|"%s: Get ACPI handle for \"ATRM\"\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|status
operator|=
name|AcpiGetHandle
argument_list|(
name|dhandle
argument_list|,
literal|"ATRM"
argument_list|,
operator|&
name|atrm_handle
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|found
operator|=
name|true
expr_stmt|;
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
break|break;
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"%s: Failed to get \"ATRM\" handle: %s\n"
argument_list|,
name|__func__
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
return|return
name|false
return|;
name|rdev
operator|->
name|bios
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|bios
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Unable to allocate bios\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|/
name|ATRM_BIOS_PAGE
condition|;
name|i
operator|++
control|)
block|{
name|DRM_INFO
argument_list|(
literal|"%s: Call radeon_atrm_call()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ret
operator|=
name|radeon_atrm_call
argument_list|(
name|atrm_handle
argument_list|,
name|rdev
operator|->
name|bios
argument_list|,
operator|(
name|i
operator|*
name|ATRM_BIOS_PAGE
operator|)
argument_list|,
name|ATRM_BIOS_PAGE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
name|ATRM_BIOS_PAGE
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
literal|0
operator|||
name|rdev
operator|->
name|bios
index|[
literal|0
index|]
operator|!=
literal|0x55
operator|||
name|rdev
operator|->
name|bios
index|[
literal|1
index|]
operator|!=
literal|0xaa
condition|)
block|{
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"%s: Incorrect BIOS size\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"%s: Incorrect BIOS signature: 0x%02X%02X\n"
argument_list|,
name|__func__
argument_list|,
name|rdev
operator|->
name|bios
index|[
literal|0
index|]
argument_list|,
name|rdev
operator|->
name|bios
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
specifier|static
name|bool
name|ni_read_disabled_bios
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|bus_cntl
decl_stmt|;
name|u32
name|d1vga_control
decl_stmt|;
name|u32
name|d2vga_control
decl_stmt|;
name|u32
name|vga_render_control
decl_stmt|;
name|u32
name|rom_cntl
decl_stmt|;
name|bool
name|r
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: ===> Try disabled BIOS (ni)...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|bus_cntl
operator|=
name|RREG32
argument_list|(
name|R600_BUS_CNTL
argument_list|)
expr_stmt|;
name|d1vga_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|)
expr_stmt|;
name|d2vga_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|)
expr_stmt|;
name|vga_render_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|)
expr_stmt|;
name|rom_cntl
operator|=
name|RREG32
argument_list|(
name|R600_ROM_CNTL
argument_list|)
expr_stmt|;
comment|/* enable the rom */
name|WREG32
argument_list|(
name|R600_BUS_CNTL
argument_list|,
operator|(
name|bus_cntl
operator|&
operator|~
name|R600_BIOS_ROM_DIS
operator|)
argument_list|)
expr_stmt|;
comment|/* Disable VGA mode */
name|WREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|,
operator|(
name|d1vga_control
operator|&
operator|~
operator|(
name|AVIVO_DVGA_CONTROL_MODE_ENABLE
operator||
name|AVIVO_DVGA_CONTROL_TIMING_SELECT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|,
operator|(
name|d2vga_control
operator|&
operator|~
operator|(
name|AVIVO_DVGA_CONTROL_MODE_ENABLE
operator||
name|AVIVO_DVGA_CONTROL_TIMING_SELECT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|,
operator|(
name|vga_render_control
operator|&
operator|~
name|AVIVO_VGA_VSTATUS_CNTL_MASK
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_ROM_CNTL
argument_list|,
name|rom_cntl
operator||
name|R600_SCK_OVERWRITE
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_read_bios
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* restore regs */
name|WREG32
argument_list|(
name|R600_BUS_CNTL
argument_list|,
name|bus_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|,
name|d1vga_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|,
name|d2vga_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|,
name|vga_render_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_ROM_CNTL
argument_list|,
name|rom_cntl
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
specifier|static
name|bool
name|r700_read_disabled_bios
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|viph_control
decl_stmt|;
name|uint32_t
name|bus_cntl
decl_stmt|;
name|uint32_t
name|d1vga_control
decl_stmt|;
name|uint32_t
name|d2vga_control
decl_stmt|;
name|uint32_t
name|vga_render_control
decl_stmt|;
name|uint32_t
name|rom_cntl
decl_stmt|;
name|uint32_t
name|cg_spll_func_cntl
init|=
literal|0
decl_stmt|;
name|uint32_t
name|cg_spll_status
decl_stmt|;
name|bool
name|r
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: ===> Try disabled BIOS (r700)...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|viph_control
operator|=
name|RREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|)
expr_stmt|;
name|bus_cntl
operator|=
name|RREG32
argument_list|(
name|R600_BUS_CNTL
argument_list|)
expr_stmt|;
name|d1vga_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|)
expr_stmt|;
name|d2vga_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|)
expr_stmt|;
name|vga_render_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|)
expr_stmt|;
name|rom_cntl
operator|=
name|RREG32
argument_list|(
name|R600_ROM_CNTL
argument_list|)
expr_stmt|;
comment|/* disable VIP */
name|WREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|,
operator|(
name|viph_control
operator|&
operator|~
name|RADEON_VIPH_EN
operator|)
argument_list|)
expr_stmt|;
comment|/* enable the rom */
name|WREG32
argument_list|(
name|R600_BUS_CNTL
argument_list|,
operator|(
name|bus_cntl
operator|&
operator|~
name|R600_BIOS_ROM_DIS
operator|)
argument_list|)
expr_stmt|;
comment|/* Disable VGA mode */
name|WREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|,
operator|(
name|d1vga_control
operator|&
operator|~
operator|(
name|AVIVO_DVGA_CONTROL_MODE_ENABLE
operator||
name|AVIVO_DVGA_CONTROL_TIMING_SELECT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|,
operator|(
name|d2vga_control
operator|&
operator|~
operator|(
name|AVIVO_DVGA_CONTROL_MODE_ENABLE
operator||
name|AVIVO_DVGA_CONTROL_TIMING_SELECT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|,
operator|(
name|vga_render_control
operator|&
operator|~
name|AVIVO_VGA_VSTATUS_CNTL_MASK
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV730
condition|)
block|{
name|cg_spll_func_cntl
operator|=
name|RREG32
argument_list|(
name|R600_CG_SPLL_FUNC_CNTL
argument_list|)
expr_stmt|;
comment|/* enable bypass mode */
name|WREG32
argument_list|(
name|R600_CG_SPLL_FUNC_CNTL
argument_list|,
operator|(
name|cg_spll_func_cntl
operator||
name|R600_SPLL_BYPASS_EN
operator|)
argument_list|)
expr_stmt|;
comment|/* wait for SPLL_CHG_STATUS to change to 1 */
name|cg_spll_status
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|cg_spll_status
operator|&
name|R600_SPLL_CHG_STATUS
operator|)
condition|)
name|cg_spll_status
operator|=
name|RREG32
argument_list|(
name|R600_CG_SPLL_STATUS
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_ROM_CNTL
argument_list|,
operator|(
name|rom_cntl
operator|&
operator|~
name|R600_SCK_OVERWRITE
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
name|WREG32
argument_list|(
name|R600_ROM_CNTL
argument_list|,
operator|(
name|rom_cntl
operator||
name|R600_SCK_OVERWRITE
operator|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_read_bios
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* restore regs */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV730
condition|)
block|{
name|WREG32
argument_list|(
name|R600_CG_SPLL_FUNC_CNTL
argument_list|,
name|cg_spll_func_cntl
argument_list|)
expr_stmt|;
comment|/* wait for SPLL_CHG_STATUS to change to 1 */
name|cg_spll_status
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|cg_spll_status
operator|&
name|R600_SPLL_CHG_STATUS
operator|)
condition|)
name|cg_spll_status
operator|=
name|RREG32
argument_list|(
name|R600_CG_SPLL_STATUS
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|,
name|viph_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_BUS_CNTL
argument_list|,
name|bus_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|,
name|d1vga_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|,
name|d2vga_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|,
name|vga_render_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_ROM_CNTL
argument_list|,
name|rom_cntl
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
specifier|static
name|bool
name|r600_read_disabled_bios
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|viph_control
decl_stmt|;
name|uint32_t
name|bus_cntl
decl_stmt|;
name|uint32_t
name|d1vga_control
decl_stmt|;
name|uint32_t
name|d2vga_control
decl_stmt|;
name|uint32_t
name|vga_render_control
decl_stmt|;
name|uint32_t
name|rom_cntl
decl_stmt|;
name|uint32_t
name|general_pwrmgt
decl_stmt|;
name|uint32_t
name|low_vid_lower_gpio_cntl
decl_stmt|;
name|uint32_t
name|medium_vid_lower_gpio_cntl
decl_stmt|;
name|uint32_t
name|high_vid_lower_gpio_cntl
decl_stmt|;
name|uint32_t
name|ctxsw_vid_lower_gpio_cntl
decl_stmt|;
name|uint32_t
name|lower_gpio_enable
decl_stmt|;
name|bool
name|r
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: ===> Try disabled BIOS (r600)...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|viph_control
operator|=
name|RREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|)
expr_stmt|;
name|bus_cntl
operator|=
name|RREG32
argument_list|(
name|R600_BUS_CNTL
argument_list|)
expr_stmt|;
name|d1vga_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|)
expr_stmt|;
name|d2vga_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|)
expr_stmt|;
name|vga_render_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|)
expr_stmt|;
name|rom_cntl
operator|=
name|RREG32
argument_list|(
name|R600_ROM_CNTL
argument_list|)
expr_stmt|;
name|general_pwrmgt
operator|=
name|RREG32
argument_list|(
name|R600_GENERAL_PWRMGT
argument_list|)
expr_stmt|;
name|low_vid_lower_gpio_cntl
operator|=
name|RREG32
argument_list|(
name|R600_LOW_VID_LOWER_GPIO_CNTL
argument_list|)
expr_stmt|;
name|medium_vid_lower_gpio_cntl
operator|=
name|RREG32
argument_list|(
name|R600_MEDIUM_VID_LOWER_GPIO_CNTL
argument_list|)
expr_stmt|;
name|high_vid_lower_gpio_cntl
operator|=
name|RREG32
argument_list|(
name|R600_HIGH_VID_LOWER_GPIO_CNTL
argument_list|)
expr_stmt|;
name|ctxsw_vid_lower_gpio_cntl
operator|=
name|RREG32
argument_list|(
name|R600_CTXSW_VID_LOWER_GPIO_CNTL
argument_list|)
expr_stmt|;
name|lower_gpio_enable
operator|=
name|RREG32
argument_list|(
name|R600_LOWER_GPIO_ENABLE
argument_list|)
expr_stmt|;
comment|/* disable VIP */
name|WREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|,
operator|(
name|viph_control
operator|&
operator|~
name|RADEON_VIPH_EN
operator|)
argument_list|)
expr_stmt|;
comment|/* enable the rom */
name|WREG32
argument_list|(
name|R600_BUS_CNTL
argument_list|,
operator|(
name|bus_cntl
operator|&
operator|~
name|R600_BIOS_ROM_DIS
operator|)
argument_list|)
expr_stmt|;
comment|/* Disable VGA mode */
name|WREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|,
operator|(
name|d1vga_control
operator|&
operator|~
operator|(
name|AVIVO_DVGA_CONTROL_MODE_ENABLE
operator||
name|AVIVO_DVGA_CONTROL_TIMING_SELECT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|,
operator|(
name|d2vga_control
operator|&
operator|~
operator|(
name|AVIVO_DVGA_CONTROL_MODE_ENABLE
operator||
name|AVIVO_DVGA_CONTROL_TIMING_SELECT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|,
operator|(
name|vga_render_control
operator|&
operator|~
name|AVIVO_VGA_VSTATUS_CNTL_MASK
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_ROM_CNTL
argument_list|,
operator|(
operator|(
name|rom_cntl
operator|&
operator|~
name|R600_SCK_PRESCALE_CRYSTAL_CLK_MASK
operator|)
operator||
operator|(
literal|1
operator|<<
name|R600_SCK_PRESCALE_CRYSTAL_CLK_SHIFT
operator|)
operator||
name|R600_SCK_OVERWRITE
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_GENERAL_PWRMGT
argument_list|,
operator|(
name|general_pwrmgt
operator|&
operator|~
name|R600_OPEN_DRAIN_PADS
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_LOW_VID_LOWER_GPIO_CNTL
argument_list|,
operator|(
name|low_vid_lower_gpio_cntl
operator|&
operator|~
literal|0x400
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_MEDIUM_VID_LOWER_GPIO_CNTL
argument_list|,
operator|(
name|medium_vid_lower_gpio_cntl
operator|&
operator|~
literal|0x400
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_HIGH_VID_LOWER_GPIO_CNTL
argument_list|,
operator|(
name|high_vid_lower_gpio_cntl
operator|&
operator|~
literal|0x400
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_CTXSW_VID_LOWER_GPIO_CNTL
argument_list|,
operator|(
name|ctxsw_vid_lower_gpio_cntl
operator|&
operator|~
literal|0x400
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_LOWER_GPIO_ENABLE
argument_list|,
operator|(
name|lower_gpio_enable
operator||
literal|0x400
operator|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_read_bios
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* restore regs */
name|WREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|,
name|viph_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_BUS_CNTL
argument_list|,
name|bus_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|,
name|d1vga_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|,
name|d2vga_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|,
name|vga_render_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_ROM_CNTL
argument_list|,
name|rom_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_GENERAL_PWRMGT
argument_list|,
name|general_pwrmgt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_LOW_VID_LOWER_GPIO_CNTL
argument_list|,
name|low_vid_lower_gpio_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_MEDIUM_VID_LOWER_GPIO_CNTL
argument_list|,
name|medium_vid_lower_gpio_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_HIGH_VID_LOWER_GPIO_CNTL
argument_list|,
name|high_vid_lower_gpio_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_CTXSW_VID_LOWER_GPIO_CNTL
argument_list|,
name|ctxsw_vid_lower_gpio_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_LOWER_GPIO_ENABLE
argument_list|,
name|lower_gpio_enable
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
specifier|static
name|bool
name|avivo_read_disabled_bios
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|seprom_cntl1
decl_stmt|;
name|uint32_t
name|viph_control
decl_stmt|;
name|uint32_t
name|bus_cntl
decl_stmt|;
name|uint32_t
name|d1vga_control
decl_stmt|;
name|uint32_t
name|d2vga_control
decl_stmt|;
name|uint32_t
name|vga_render_control
decl_stmt|;
name|uint32_t
name|gpiopad_a
decl_stmt|;
name|uint32_t
name|gpiopad_en
decl_stmt|;
name|uint32_t
name|gpiopad_mask
decl_stmt|;
name|bool
name|r
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: ===> Try disabled BIOS (avivo)...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|seprom_cntl1
operator|=
name|RREG32
argument_list|(
name|RADEON_SEPROM_CNTL1
argument_list|)
expr_stmt|;
name|viph_control
operator|=
name|RREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|)
expr_stmt|;
name|bus_cntl
operator|=
name|RREG32
argument_list|(
name|RV370_BUS_CNTL
argument_list|)
expr_stmt|;
name|d1vga_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|)
expr_stmt|;
name|d2vga_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|)
expr_stmt|;
name|vga_render_control
operator|=
name|RREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|)
expr_stmt|;
name|gpiopad_a
operator|=
name|RREG32
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|)
expr_stmt|;
name|gpiopad_en
operator|=
name|RREG32
argument_list|(
name|RADEON_GPIOPAD_EN
argument_list|)
expr_stmt|;
name|gpiopad_mask
operator|=
name|RREG32
argument_list|(
name|RADEON_GPIOPAD_MASK
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_SEPROM_CNTL1
argument_list|,
operator|(
operator|(
name|seprom_cntl1
operator|&
operator|~
name|RADEON_SCK_PRESCALE_MASK
operator|)
operator||
operator|(
literal|0xc
operator|<<
name|RADEON_SCK_PRESCALE_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_GPIOPAD_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_GPIOPAD_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* disable VIP */
name|WREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|,
operator|(
name|viph_control
operator|&
operator|~
name|RADEON_VIPH_EN
operator|)
argument_list|)
expr_stmt|;
comment|/* enable the rom */
name|WREG32
argument_list|(
name|RV370_BUS_CNTL
argument_list|,
operator|(
name|bus_cntl
operator|&
operator|~
name|RV370_BUS_BIOS_DIS_ROM
operator|)
argument_list|)
expr_stmt|;
comment|/* Disable VGA mode */
name|WREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|,
operator|(
name|d1vga_control
operator|&
operator|~
operator|(
name|AVIVO_DVGA_CONTROL_MODE_ENABLE
operator||
name|AVIVO_DVGA_CONTROL_TIMING_SELECT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|,
operator|(
name|d2vga_control
operator|&
operator|~
operator|(
name|AVIVO_DVGA_CONTROL_MODE_ENABLE
operator||
name|AVIVO_DVGA_CONTROL_TIMING_SELECT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|,
operator|(
name|vga_render_control
operator|&
operator|~
name|AVIVO_VGA_VSTATUS_CNTL_MASK
operator|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_read_bios
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* restore regs */
name|WREG32
argument_list|(
name|RADEON_SEPROM_CNTL1
argument_list|,
name|seprom_cntl1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|,
name|viph_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RV370_BUS_CNTL
argument_list|,
name|bus_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1VGA_CONTROL
argument_list|,
name|d1vga_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D2VGA_CONTROL
argument_list|,
name|d2vga_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_VGA_RENDER_CONTROL
argument_list|,
name|vga_render_control
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|,
name|gpiopad_a
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_GPIOPAD_EN
argument_list|,
name|gpiopad_en
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_GPIOPAD_MASK
argument_list|,
name|gpiopad_mask
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
specifier|static
name|bool
name|legacy_read_disabled_bios
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|seprom_cntl1
decl_stmt|;
name|uint32_t
name|viph_control
decl_stmt|;
name|uint32_t
name|bus_cntl
decl_stmt|;
name|uint32_t
name|crtc_gen_cntl
decl_stmt|;
name|uint32_t
name|crtc2_gen_cntl
decl_stmt|;
name|uint32_t
name|crtc_ext_cntl
decl_stmt|;
name|uint32_t
name|fp2_gen_cntl
decl_stmt|;
name|bool
name|r
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: ===> Try disabled BIOS (legacy)...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|seprom_cntl1
operator|=
name|RREG32
argument_list|(
name|RADEON_SEPROM_CNTL1
argument_list|)
expr_stmt|;
name|viph_control
operator|=
name|RREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|bus_cntl
operator|=
name|RREG32
argument_list|(
name|RV370_BUS_CNTL
argument_list|)
expr_stmt|;
else|else
name|bus_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
expr_stmt|;
name|crtc_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|)
expr_stmt|;
name|crtc2_gen_cntl
operator|=
literal|0
expr_stmt|;
name|crtc_ext_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|)
expr_stmt|;
name|fp2_gen_cntl
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|PCI_DEVICE_ID_ATI_RADEON_QY
value|0x5159
if|if
condition|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
name|PCI_DEVICE_ID_ATI_RADEON_QY
condition|)
block|{
name|fp2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
operator|)
condition|)
block|{
name|crtc2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_SEPROM_CNTL1
argument_list|,
operator|(
operator|(
name|seprom_cntl1
operator|&
operator|~
name|RADEON_SCK_PRESCALE_MASK
operator|)
operator||
operator|(
literal|0xc
operator|<<
name|RADEON_SCK_PRESCALE_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* disable VIP */
name|WREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|,
operator|(
name|viph_control
operator|&
operator|~
name|RADEON_VIPH_EN
operator|)
argument_list|)
expr_stmt|;
comment|/* enable the rom */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|WREG32
argument_list|(
name|RV370_BUS_CNTL
argument_list|,
operator|(
name|bus_cntl
operator|&
operator|~
name|RV370_BUS_BIOS_DIS_ROM
operator|)
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|,
operator|(
name|bus_cntl
operator|&
operator|~
name|RADEON_BUS_BIOS_DIS_ROM
operator|)
argument_list|)
expr_stmt|;
comment|/* Turn off mem requests and CRTC for both controllers */
name|WREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|,
operator|(
operator|(
name|crtc_gen_cntl
operator|&
operator|~
name|RADEON_CRTC_EN
operator|)
operator||
operator|(
name|RADEON_CRTC_DISP_REQ_EN_B
operator||
name|RADEON_CRTC_EXT_DISP_EN
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
operator|)
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
operator|(
operator|(
name|crtc2_gen_cntl
operator|&
operator|~
name|RADEON_CRTC2_EN
operator|)
operator||
name|RADEON_CRTC2_DISP_REQ_EN_B
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Turn off CRTC */
name|WREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|,
operator|(
operator|(
name|crtc_ext_cntl
operator|&
operator|~
name|RADEON_CRTC_CRT_ON
operator|)
operator||
operator|(
name|RADEON_CRTC_SYNC_TRISTAT
operator||
name|RADEON_CRTC_DISPLAY_DIS
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
name|PCI_DEVICE_ID_ATI_RADEON_QY
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|,
operator|(
name|fp2_gen_cntl
operator|&
operator|~
name|RADEON_FP2_ON
operator|)
argument_list|)
expr_stmt|;
block|}
name|r
operator|=
name|radeon_read_bios
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* restore regs */
name|WREG32
argument_list|(
name|RADEON_SEPROM_CNTL1
argument_list|,
name|seprom_cntl1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|,
name|viph_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|WREG32
argument_list|(
name|RV370_BUS_CNTL
argument_list|,
name|bus_cntl
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|,
name|bus_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|,
name|crtc_gen_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
operator|)
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|crtc2_gen_cntl
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|,
name|crtc_ext_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
name|PCI_DEVICE_ID_ATI_RADEON_QY
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|,
name|fp2_gen_cntl
argument_list|)
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
specifier|static
name|bool
name|radeon_read_disabled_bios
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
return|return
name|igp_read_bios_from_vram
argument_list|(
name|rdev
argument_list|)
return|;
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_BARTS
condition|)
return|return
name|ni_read_disabled_bios
argument_list|(
name|rdev
argument_list|)
return|;
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
return|return
name|r700_read_disabled_bios
argument_list|(
name|rdev
argument_list|)
return|;
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
return|return
name|r600_read_disabled_bios
argument_list|(
name|rdev
argument_list|)
return|;
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RS600
condition|)
return|return
name|avivo_read_disabled_bios
argument_list|(
name|rdev
argument_list|)
return|;
else|else
return|return
name|legacy_read_disabled_bios
argument_list|(
name|rdev
argument_list|)
return|;
block|}
specifier|static
name|bool
name|radeon_acpi_vfct_bios
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|bool
name|ret
init|=
name|false
decl_stmt|;
name|ACPI_TABLE_HEADER
modifier|*
name|hdr
decl_stmt|;
name|ACPI_SIZE
name|tbl_size
decl_stmt|;
name|UEFI_ACPI_VFCT
modifier|*
name|vfct
decl_stmt|;
name|GOP_VBIOS_CONTENT
modifier|*
name|vbios
decl_stmt|;
name|VFCT_IMAGE_HEADER
modifier|*
name|vhdr
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: ===> Try VFCT...\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"%s: Get \"VFCT\" ACPI table\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|status
operator|=
name|AcpiGetTable
argument_list|(
literal|"VFCT"
argument_list|,
literal|1
argument_list|,
operator|&
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ACPI_SUCCESS
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"%s: Failed to get \"VFCT\" table: %s\n"
argument_list|,
name|__func__
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|tbl_size
operator|=
name|hdr
operator|->
name|Length
expr_stmt|;
if|if
condition|(
name|tbl_size
operator|<
sizeof|sizeof
argument_list|(
name|UEFI_ACPI_VFCT
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ACPI VFCT table present but broken (too short #1)\n"
argument_list|)
expr_stmt|;
goto|goto
name|out_unmap
goto|;
block|}
name|vfct
operator|=
operator|(
name|UEFI_ACPI_VFCT
operator|*
operator|)
name|hdr
expr_stmt|;
if|if
condition|(
name|vfct
operator|->
name|VBIOSImageOffset
operator|+
sizeof|sizeof
argument_list|(
name|VFCT_IMAGE_HEADER
argument_list|)
operator|>
name|tbl_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ACPI VFCT table present but broken (too short #2)\n"
argument_list|)
expr_stmt|;
goto|goto
name|out_unmap
goto|;
block|}
name|vbios
operator|=
operator|(
name|GOP_VBIOS_CONTENT
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|hdr
operator|+
name|vfct
operator|->
name|VBIOSImageOffset
operator|)
expr_stmt|;
name|vhdr
operator|=
operator|&
name|vbios
operator|->
name|VbiosHeader
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"ACPI VFCT contains a BIOS for %02x:%02x.%d %04x:%04x, size %d\n"
argument_list|,
name|vhdr
operator|->
name|PCIBus
argument_list|,
name|vhdr
operator|->
name|PCIDevice
argument_list|,
name|vhdr
operator|->
name|PCIFunction
argument_list|,
name|vhdr
operator|->
name|VendorID
argument_list|,
name|vhdr
operator|->
name|DeviceID
argument_list|,
name|vhdr
operator|->
name|ImageLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|vhdr
operator|->
name|PCIBus
operator|!=
name|rdev
operator|->
name|ddev
operator|->
name|pci_bus
operator|||
name|vhdr
operator|->
name|PCIDevice
operator|!=
name|rdev
operator|->
name|ddev
operator|->
name|pci_slot
operator|||
name|vhdr
operator|->
name|PCIFunction
operator|!=
name|rdev
operator|->
name|ddev
operator|->
name|pci_func
operator|||
name|vhdr
operator|->
name|VendorID
operator|!=
name|rdev
operator|->
name|ddev
operator|->
name|pci_vendor
operator|||
name|vhdr
operator|->
name|DeviceID
operator|!=
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"ACPI VFCT table is not for this card\n"
argument_list|)
expr_stmt|;
goto|goto
name|out_unmap
goto|;
block|}
empty_stmt|;
if|if
condition|(
name|vfct
operator|->
name|VBIOSImageOffset
operator|+
sizeof|sizeof
argument_list|(
name|VFCT_IMAGE_HEADER
argument_list|)
operator|+
name|vhdr
operator|->
name|ImageLength
operator|>
name|tbl_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ACPI VFCT image truncated\n"
argument_list|)
expr_stmt|;
goto|goto
name|out_unmap
goto|;
block|}
name|rdev
operator|->
name|bios
operator|=
name|malloc
argument_list|(
name|vhdr
operator|->
name|ImageLength
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
operator|&
name|vbios
operator|->
name|VbiosContent
argument_list|,
name|vhdr
operator|->
name|ImageLength
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|!
operator|!
name|rdev
operator|->
name|bios
expr_stmt|;
name|out_unmap
label|:
return|return
name|ret
return|;
block|}
name|bool
name|radeon_get_bios
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|bool
name|r
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|;
name|r
operator|=
name|radeon_atrm_get_bios
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|false
condition|)
name|r
operator|=
name|radeon_acpi_vfct_bios
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|false
condition|)
name|r
operator|=
name|igp_read_bios_from_vram
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|false
condition|)
name|r
operator|=
name|radeon_read_bios
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|false
condition|)
block|{
name|r
operator|=
name|radeon_read_disabled_bios
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|==
name|false
operator|||
name|rdev
operator|->
name|bios
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Unable to locate a BIOS ROM\n"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
return|return
name|false
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|bios
index|[
literal|0
index|]
operator|!=
literal|0x55
operator|||
name|rdev
operator|->
name|bios
index|[
literal|1
index|]
operator|!=
literal|0xaa
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"BIOS signature incorrect %x %x\n"
argument_list|,
name|rdev
operator|->
name|bios
index|[
literal|0
index|]
argument_list|,
name|rdev
operator|->
name|bios
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
goto|goto
name|free_bios
goto|;
block|}
name|tmp
operator|=
name|RBIOS16
argument_list|(
literal|0x18
argument_list|)
expr_stmt|;
if|if
condition|(
name|RBIOS8
argument_list|(
name|tmp
operator|+
literal|0x14
argument_list|)
operator|!=
literal|0x0
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Not an x86 BIOS ROM, not using.\n"
argument_list|)
expr_stmt|;
goto|goto
name|free_bios
goto|;
block|}
name|rdev
operator|->
name|bios_header_start
operator|=
name|RBIOS16
argument_list|(
literal|0x48
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|bios_header_start
condition|)
block|{
goto|goto
name|free_bios
goto|;
block|}
name|tmp
operator|=
name|rdev
operator|->
name|bios_header_start
operator|+
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|rdev
operator|->
name|bios
operator|+
name|tmp
argument_list|,
literal|"ATOM"
argument_list|,
literal|4
argument_list|)
operator|||
operator|!
name|memcmp
argument_list|(
name|rdev
operator|->
name|bios
operator|+
name|tmp
argument_list|,
literal|"MOTA"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|is_atom_bios
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
name|rdev
operator|->
name|is_atom_bios
operator|=
name|false
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"%sBIOS detected\n"
argument_list|,
name|rdev
operator|->
name|is_atom_bios
condition|?
literal|"ATOM"
else|:
literal|"COM"
argument_list|)
expr_stmt|;
return|return
name|true
return|;
name|free_bios
label|:
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

end_unit


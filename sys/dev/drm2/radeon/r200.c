begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon_reg.h"
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"r100d.h"
end_include

begin_include
include|#
directive|include
file|"r200_reg_safe.h"
end_include

begin_include
include|#
directive|include
file|"r100_track.h"
end_include

begin_function
specifier|static
name|int
name|r200_get_vtx_size_0
parameter_list|(
name|uint32_t
name|vtx_fmt_0
parameter_list|)
block|{
name|int
name|vtx_size
decl_stmt|,
name|i
decl_stmt|;
name|vtx_size
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_Z0
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_W0
condition|)
name|vtx_size
operator|++
expr_stmt|;
comment|/* blend weight */
if|if
condition|(
name|vtx_fmt_0
operator|&
operator|(
literal|0x7
operator|<<
name|R200_VTX_WEIGHT_COUNT_SHIFT
operator|)
condition|)
name|vtx_size
operator|+=
operator|(
name|vtx_fmt_0
operator|>>
name|R200_VTX_WEIGHT_COUNT_SHIFT
operator|)
operator|&
literal|0x7
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_PV_MATRIX_SEL
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_N0
condition|)
name|vtx_size
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_POINT_SIZE
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_DISCRETE_FOG
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_SHININESS_0
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_SHININESS_1
condition|)
name|vtx_size
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|int
name|color_size
init|=
operator|(
name|vtx_fmt_0
operator|>>
operator|(
literal|11
operator|+
literal|2
operator|*
name|i
operator|)
operator|)
operator|&
literal|0x3
decl_stmt|;
switch|switch
condition|(
name|color_size
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
literal|1
case|:
name|vtx_size
operator|++
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|vtx_size
operator|+=
literal|3
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|vtx_size
operator|+=
literal|4
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_XY1
condition|)
name|vtx_size
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_Z1
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_W1
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt_0
operator|&
name|R200_VTX_N1
condition|)
name|vtx_size
operator|+=
literal|3
expr_stmt|;
return|return
name|vtx_size
return|;
block|}
end_function

begin_function
name|int
name|r200_copy_dma
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint64_t
name|src_offset
parameter_list|,
name|uint64_t
name|dst_offset
parameter_list|,
name|unsigned
name|num_gpu_pages
parameter_list|,
name|struct
name|radeon_fence
modifier|*
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|uint32_t
name|cur_size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_loops
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
comment|/* radeon pitch is /64 */
name|size
operator|=
name|num_gpu_pages
operator|<<
name|RADEON_GPU_PAGE_SHIFT
expr_stmt|;
name|num_loops
operator|=
name|DIV_ROUND_UP
argument_list|(
name|size
argument_list|,
literal|0x1FFFFF
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|num_loops
operator|*
literal|4
operator|+
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: moving bo (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Must wait for 2D idle& clean before DMA or hangs might happen */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|1
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_loops
condition|;
name|i
operator|++
control|)
block|{
name|cur_size
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|cur_size
operator|>
literal|0x1FFFFF
condition|)
block|{
name|cur_size
operator|=
literal|0x1FFFFF
expr_stmt|;
block|}
name|size
operator|-=
name|cur_size
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
literal|0x720
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|src_offset
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|dst_offset
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|cur_size
operator||
operator|(
literal|1U
operator|<<
literal|31
operator|)
operator||
operator|(
literal|1
operator|<<
literal|30
operator|)
argument_list|)
expr_stmt|;
name|src_offset
operator|+=
name|cur_size
expr_stmt|;
name|dst_offset
operator|+=
name|cur_size
expr_stmt|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_WAIT_DMA_GUI_IDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|fence
condition|)
block|{
name|r
operator|=
name|radeon_fence_emit
argument_list|(
name|rdev
argument_list|,
name|fence
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r200_get_vtx_size_1
parameter_list|(
name|uint32_t
name|vtx_fmt_1
parameter_list|)
block|{
name|int
name|vtx_size
decl_stmt|,
name|i
decl_stmt|,
name|tex_size
decl_stmt|;
name|vtx_size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
name|tex_size
operator|=
operator|(
name|vtx_fmt_1
operator|>>
operator|(
name|i
operator|*
literal|3
operator|)
operator|)
operator|&
literal|0x7
expr_stmt|;
if|if
condition|(
name|tex_size
operator|>
literal|4
condition|)
continue|continue;
name|vtx_size
operator|+=
name|tex_size
expr_stmt|;
block|}
return|return
name|vtx_size
return|;
block|}
end_function

begin_function
name|int
name|r200_packet0_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|unsigned
name|idx
parameter_list|,
name|unsigned
name|reg
parameter_list|)
block|{
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|struct
name|r100_cs_track
modifier|*
name|track
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ib
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|r
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|face
decl_stmt|;
name|u32
name|tile_flags
init|=
literal|0
decl_stmt|;
name|u32
name|idx_value
decl_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
name|track
operator|=
operator|(
expr|struct
name|r100_cs_track
operator|*
operator|)
name|p
operator|->
name|track
expr_stmt|;
name|idx_value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|RADEON_CRTC_GUI_TRIG_VLINE
case|:
name|r
operator|=
name|r100_cs_packet_parse_vline
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
comment|/* FIXME: only allow PACKET3 blit? easier to check for out of 		 * range access */
case|case
name|RADEON_DST_PITCH_OFFSET
case|:
case|case
name|RADEON_SRC_PITCH_OFFSET
case|:
name|r
operator|=
name|r100_reloc_pitch_offset
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
case|case
name|RADEON_RB3D_DEPTHOFFSET
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|zb
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|zb
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_COLOROFFSET
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
break|break;
case|case
name|R200_PP_TXOFFSET_0
case|:
case|case
name|R200_PP_TXOFFSET_1
case|:
case|case
name|R200_PP_TXOFFSET_2
case|:
case|case
name|R200_PP_TXOFFSET_3
case|:
case|case
name|R200_PP_TXOFFSET_4
case|:
case|case
name|R200_PP_TXOFFSET_5
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|R200_PP_TXOFFSET_0
operator|)
operator|/
literal|24
expr_stmt|;
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|tile_flags
operator||=
name|R200_TXO_MACRO_TILE
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|tile_flags
operator||=
name|R200_TXO_MICRO_TILE
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|&
operator|~
operator|(
literal|0x7
operator|<<
literal|2
operator|)
expr_stmt|;
name|tmp
operator||=
name|tile_flags
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|tmp
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
block|}
else|else
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R200_PP_CUBIC_OFFSET_F1_0
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F2_0
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F3_0
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F4_0
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F5_0
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F1_1
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F2_1
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F3_1
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F4_1
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F5_1
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F1_2
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F2_2
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F3_2
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F4_2
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F5_2
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F1_3
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F2_3
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F3_3
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F4_3
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F5_3
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F1_4
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F2_4
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F3_4
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F4_4
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F5_4
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F1_5
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F2_5
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F3_5
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F4_5
case|:
case|case
name|R200_PP_CUBIC_OFFSET_F5_5
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|R200_PP_TXOFFSET_0
operator|)
operator|/
literal|24
expr_stmt|;
name|face
operator|=
operator|(
name|reg
operator|-
operator|(
operator|(
name|i
operator|*
literal|24
operator|)
operator|+
name|R200_PP_TXOFFSET_0
operator|)
operator|)
operator|/
literal|4
expr_stmt|;
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
name|face
operator|-
literal|1
index|]
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
name|face
operator|-
literal|1
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RE_WIDTH_HEIGHT
case|:
name|track
operator|->
name|maxy
operator|=
operator|(
operator|(
name|idx_value
operator|>>
literal|16
operator|)
operator|&
literal|0x7FF
operator|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_COLORPITCH
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|tile_flags
operator||=
name|RADEON_COLOR_TILE_ENABLE
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|tile_flags
operator||=
name|RADEON_COLOR_MICROTILE_ENABLE
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|&
operator|~
operator|(
literal|0x7
operator|<<
literal|16
operator|)
expr_stmt|;
name|tmp
operator||=
name|tile_flags
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|tmp
expr_stmt|;
block|}
else|else
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
expr_stmt|;
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|pitch
operator|=
name|idx_value
operator|&
name|RADEON_COLORPITCH_MASK
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_DEPTHPITCH
case|:
name|track
operator|->
name|zb
operator|.
name|pitch
operator|=
name|idx_value
operator|&
name|RADEON_DEPTHPITCH_MASK
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_CNTL
case|:
switch|switch
condition|(
operator|(
name|idx_value
operator|>>
name|RADEON_RB3D_COLOR_FORMAT_SHIFT
operator|)
operator|&
literal|0x1f
condition|)
block|{
case|case
literal|7
case|:
case|case
literal|8
case|:
case|case
literal|9
case|:
case|case
literal|11
case|:
case|case
literal|12
case|:
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|3
case|:
case|case
literal|4
case|:
case|case
literal|15
case|:
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|cpp
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|cpp
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid color buffer format (%d) !\n"
argument_list|,
operator|(
operator|(
name|idx_value
operator|>>
name|RADEON_RB3D_COLOR_FORMAT_SHIFT
operator|)
operator|&
literal|0x1f
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|idx_value
operator|&
name|RADEON_DEPTHXY_OFFSET_ENABLE
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No support for depth xy offset in kms\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|z_enabled
operator|=
operator|!
operator|!
operator|(
name|idx_value
operator|&
name|RADEON_Z_ENABLE
operator|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_ZSTENCILCNTL
case|:
switch|switch
condition|(
name|idx_value
operator|&
literal|0xf
condition|)
block|{
case|case
literal|0
case|:
name|track
operator|->
name|zb
operator|.
name|cpp
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
case|case
literal|3
case|:
case|case
literal|4
case|:
case|case
literal|5
case|:
case|case
literal|9
case|:
case|case
literal|11
case|:
name|track
operator|->
name|zb
operator|.
name|cpp
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_ZPASS_ADDR
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
break|break;
case|case
name|RADEON_PP_CNTL
case|:
block|{
name|uint32_t
name|temp
init|=
name|idx_value
operator|>>
literal|4
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|track
operator|->
name|num_texture
condition|;
name|i
operator|++
control|)
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|enabled
operator|=
operator|!
operator|!
operator|(
name|temp
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|RADEON_SE_VF_CNTL
case|:
name|track
operator|->
name|vap_vf_cntl
operator|=
name|idx_value
expr_stmt|;
break|break;
case|case
literal|0x210c
case|:
comment|/* VAP_VF_MAX_VTX_INDX */
name|track
operator|->
name|max_indx
operator|=
name|idx_value
operator|&
literal|0x00FFFFFFUL
expr_stmt|;
break|break;
case|case
name|R200_SE_VTX_FMT_0
case|:
name|track
operator|->
name|vtx_size
operator|=
name|r200_get_vtx_size_0
argument_list|(
name|idx_value
argument_list|)
expr_stmt|;
break|break;
case|case
name|R200_SE_VTX_FMT_1
case|:
name|track
operator|->
name|vtx_size
operator|+=
name|r200_get_vtx_size_1
argument_list|(
name|idx_value
argument_list|)
expr_stmt|;
break|break;
case|case
name|R200_PP_TXSIZE_0
case|:
case|case
name|R200_PP_TXSIZE_1
case|:
case|case
name|R200_PP_TXSIZE_2
case|:
case|case
name|R200_PP_TXSIZE_3
case|:
case|case
name|R200_PP_TXSIZE_4
case|:
case|case
name|R200_PP_TXSIZE_5
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|R200_PP_TXSIZE_0
operator|)
operator|/
literal|32
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|width
operator|=
operator|(
name|idx_value
operator|&
name|RADEON_TEX_USIZE_MASK
operator|)
operator|+
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|height
operator|=
operator|(
operator|(
name|idx_value
operator|&
name|RADEON_TEX_VSIZE_MASK
operator|)
operator|>>
name|RADEON_TEX_VSIZE_SHIFT
operator|)
operator|+
literal|1
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R200_PP_TXPITCH_0
case|:
case|case
name|R200_PP_TXPITCH_1
case|:
case|case
name|R200_PP_TXPITCH_2
case|:
case|case
name|R200_PP_TXPITCH_3
case|:
case|case
name|R200_PP_TXPITCH_4
case|:
case|case
name|R200_PP_TXPITCH_5
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|R200_PP_TXPITCH_0
operator|)
operator|/
literal|32
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|pitch
operator|=
name|idx_value
operator|+
literal|32
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R200_PP_TXFILTER_0
case|:
case|case
name|R200_PP_TXFILTER_1
case|:
case|case
name|R200_PP_TXFILTER_2
case|:
case|case
name|R200_PP_TXFILTER_3
case|:
case|case
name|R200_PP_TXFILTER_4
case|:
case|case
name|R200_PP_TXFILTER_5
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|R200_PP_TXFILTER_0
operator|)
operator|/
literal|32
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|num_levels
operator|=
operator|(
operator|(
name|idx_value
operator|&
name|R200_MAX_MIP_LEVEL_MASK
operator|)
operator|>>
name|R200_MAX_MIP_LEVEL_SHIFT
operator|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|idx_value
operator|>>
literal|23
operator|)
operator|&
literal|0x7
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|2
operator|||
name|tmp
operator|==
literal|6
condition|)
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|roundup_w
operator|=
name|false
expr_stmt|;
name|tmp
operator|=
operator|(
name|idx_value
operator|>>
literal|27
operator|)
operator|&
literal|0x7
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|2
operator|||
name|tmp
operator|==
literal|6
condition|)
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|roundup_h
operator|=
name|false
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R200_PP_TXMULTI_CTL_0
case|:
case|case
name|R200_PP_TXMULTI_CTL_1
case|:
case|case
name|R200_PP_TXMULTI_CTL_2
case|:
case|case
name|R200_PP_TXMULTI_CTL_3
case|:
case|case
name|R200_PP_TXMULTI_CTL_4
case|:
case|case
name|R200_PP_TXMULTI_CTL_5
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|R200_PP_TXMULTI_CTL_0
operator|)
operator|/
literal|32
expr_stmt|;
break|break;
case|case
name|R200_PP_TXFORMAT_X_0
case|:
case|case
name|R200_PP_TXFORMAT_X_1
case|:
case|case
name|R200_PP_TXFORMAT_X_2
case|:
case|case
name|R200_PP_TXFORMAT_X_3
case|:
case|case
name|R200_PP_TXFORMAT_X_4
case|:
case|case
name|R200_PP_TXFORMAT_X_5
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|R200_PP_TXFORMAT_X_0
operator|)
operator|/
literal|32
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|txdepth
operator|=
name|idx_value
operator|&
literal|0x7
expr_stmt|;
name|tmp
operator|=
operator|(
name|idx_value
operator|>>
literal|16
operator|)
operator|&
literal|0x3
expr_stmt|;
comment|/* 2D, 3D, CUBE */
switch|switch
condition|(
name|tmp
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|3
case|:
case|case
literal|4
case|:
case|case
literal|5
case|:
case|case
literal|6
case|:
case|case
literal|7
case|:
comment|/* 1D/2D */
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|tex_coord_type
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* CUBE */
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|tex_coord_type
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* 3D */
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|tex_coord_type
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R200_PP_TXFORMAT_0
case|:
case|case
name|R200_PP_TXFORMAT_1
case|:
case|case
name|R200_PP_TXFORMAT_2
case|:
case|case
name|R200_PP_TXFORMAT_3
case|:
case|case
name|R200_PP_TXFORMAT_4
case|:
case|case
name|R200_PP_TXFORMAT_5
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|R200_PP_TXFORMAT_0
operator|)
operator|/
literal|32
expr_stmt|;
if|if
condition|(
name|idx_value
operator|&
name|R200_TXFORMAT_NON_POWER2
condition|)
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|use_pitch
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|use_pitch
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|width
operator|=
literal|1
operator|<<
operator|(
operator|(
name|idx_value
operator|>>
name|RADEON_TXFORMAT_WIDTH_SHIFT
operator|)
operator|&
name|RADEON_TXFORMAT_WIDTH_MASK
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|height
operator|=
literal|1
operator|<<
operator|(
operator|(
name|idx_value
operator|>>
name|RADEON_TXFORMAT_HEIGHT_SHIFT
operator|)
operator|&
name|RADEON_TXFORMAT_HEIGHT_MASK
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|idx_value
operator|&
name|R200_TXFORMAT_LOOKUP_DISABLE
condition|)
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|lookup_disable
operator|=
name|true
expr_stmt|;
switch|switch
condition|(
operator|(
name|idx_value
operator|&
name|RADEON_TXFORMAT_FORMAT_MASK
operator|)
condition|)
block|{
case|case
name|R200_TXFORMAT_I8
case|:
case|case
name|R200_TXFORMAT_RGB332
case|:
case|case
name|R200_TXFORMAT_Y8
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|R200_TXFORMAT_AI88
case|:
case|case
name|R200_TXFORMAT_ARGB1555
case|:
case|case
name|R200_TXFORMAT_RGB565
case|:
case|case
name|R200_TXFORMAT_ARGB4444
case|:
case|case
name|R200_TXFORMAT_VYUY422
case|:
case|case
name|R200_TXFORMAT_YVYU422
case|:
case|case
name|R200_TXFORMAT_LDVDU655
case|:
case|case
name|R200_TXFORMAT_DVDU88
case|:
case|case
name|R200_TXFORMAT_AVYU4444
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|2
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|R200_TXFORMAT_ARGB8888
case|:
case|case
name|R200_TXFORMAT_RGBA8888
case|:
case|case
name|R200_TXFORMAT_ABGR8888
case|:
case|case
name|R200_TXFORMAT_BGR111110
case|:
case|case
name|R200_TXFORMAT_LDVDU8888
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|4
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|R200_TXFORMAT_DXT1
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_DXT1
expr_stmt|;
break|break;
case|case
name|R200_TXFORMAT_DXT23
case|:
case|case
name|R200_TXFORMAT_DXT45
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_DXT1
expr_stmt|;
break|break;
block|}
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
literal|4
index|]
operator|.
name|width
operator|=
literal|1
operator|<<
operator|(
operator|(
name|idx_value
operator|>>
literal|16
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
literal|4
index|]
operator|.
name|height
operator|=
literal|1
operator|<<
operator|(
operator|(
name|idx_value
operator|>>
literal|20
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R200_PP_CUBIC_FACES_0
case|:
case|case
name|R200_PP_CUBIC_FACES_1
case|:
case|case
name|R200_PP_CUBIC_FACES_2
case|:
case|case
name|R200_PP_CUBIC_FACES_3
case|:
case|case
name|R200_PP_CUBIC_FACES_4
case|:
case|case
name|R200_PP_CUBIC_FACES_5
case|:
name|tmp
operator|=
name|idx_value
expr_stmt|;
name|i
operator|=
operator|(
name|reg
operator|-
name|R200_PP_CUBIC_FACES_0
operator|)
operator|/
literal|32
expr_stmt|;
for|for
control|(
name|face
operator|=
literal|0
init|;
name|face
operator|<
literal|4
condition|;
name|face
operator|++
control|)
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|width
operator|=
literal|1
operator|<<
operator|(
operator|(
name|tmp
operator|>>
operator|(
name|face
operator|*
literal|8
operator|)
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|height
operator|=
literal|1
operator|<<
operator|(
operator|(
name|tmp
operator|>>
operator|(
operator|(
name|face
operator|*
literal|8
operator|)
operator|+
literal|4
operator|)
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
block|}
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Forbidden register 0x%04X in cs at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r200_set_safe_registers
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|reg_safe_bm
operator|=
name|r200_reg_safe_bm
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|reg_safe_bm_size
operator|=
name|DRM_ARRAY_SIZE
argument_list|(
name|r200_reg_safe_bm
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


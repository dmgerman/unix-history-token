begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"r600d.h"
end_include

begin_include
include|#
directive|include
file|"r600_reg_safe.h"
end_include

begin_include
include|#
directive|include
file|"r600_cp.h"
end_include

begin_include
include|#
directive|include
file|"r600_cs.h"
end_include

begin_function_decl
specifier|static
name|int
name|r600_cs_packet_next_reloc_mm
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_reloc
modifier|*
modifier|*
name|cs_reloc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|r600_cs_packet_next_reloc_nomm
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_reloc
modifier|*
modifier|*
name|cs_reloc
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
name|int
function_decl|(
modifier|*
name|next_reloc_t
function_decl|)
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
parameter_list|,
name|struct
name|radeon_cs_reloc
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_typedef

begin_decl_stmt
specifier|static
name|next_reloc_t
name|r600_cs_packet_next_reloc
init|=
operator|&
name|r600_cs_packet_next_reloc_mm
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|r600_cs_track
block|{
comment|/* configuration we miror so that we use same code btw kms/ums */
name|u32
name|group_size
decl_stmt|;
name|u32
name|nbanks
decl_stmt|;
name|u32
name|npipes
decl_stmt|;
comment|/* value we track */
name|u32
name|sq_config
decl_stmt|;
name|u32
name|log_nsamples
decl_stmt|;
name|u32
name|nsamples
decl_stmt|;
name|u32
name|cb_color_base_last
index|[
literal|8
index|]
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|cb_color_bo
index|[
literal|8
index|]
decl_stmt|;
name|u64
name|cb_color_bo_mc
index|[
literal|8
index|]
decl_stmt|;
name|u64
name|cb_color_bo_offset
index|[
literal|8
index|]
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|cb_color_frag_bo
index|[
literal|8
index|]
decl_stmt|;
name|u64
name|cb_color_frag_offset
index|[
literal|8
index|]
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|cb_color_tile_bo
index|[
literal|8
index|]
decl_stmt|;
name|u64
name|cb_color_tile_offset
index|[
literal|8
index|]
decl_stmt|;
name|u32
name|cb_color_mask
index|[
literal|8
index|]
decl_stmt|;
name|u32
name|cb_color_info
index|[
literal|8
index|]
decl_stmt|;
name|u32
name|cb_color_view
index|[
literal|8
index|]
decl_stmt|;
name|u32
name|cb_color_size_idx
index|[
literal|8
index|]
decl_stmt|;
comment|/* unused */
name|u32
name|cb_target_mask
decl_stmt|;
name|u32
name|cb_shader_mask
decl_stmt|;
comment|/* unused */
name|bool
name|is_resolve
decl_stmt|;
name|u32
name|cb_color_size
index|[
literal|8
index|]
decl_stmt|;
name|u32
name|vgt_strmout_en
decl_stmt|;
name|u32
name|vgt_strmout_buffer_en
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|vgt_strmout_bo
index|[
literal|4
index|]
decl_stmt|;
name|u64
name|vgt_strmout_bo_mc
index|[
literal|4
index|]
decl_stmt|;
comment|/* unused */
name|u32
name|vgt_strmout_bo_offset
index|[
literal|4
index|]
decl_stmt|;
name|u32
name|vgt_strmout_size
index|[
literal|4
index|]
decl_stmt|;
name|u32
name|db_depth_control
decl_stmt|;
name|u32
name|db_depth_info
decl_stmt|;
name|u32
name|db_depth_size_idx
decl_stmt|;
name|u32
name|db_depth_view
decl_stmt|;
name|u32
name|db_depth_size
decl_stmt|;
name|u32
name|db_offset
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|db_bo
decl_stmt|;
name|u64
name|db_bo_mc
decl_stmt|;
name|bool
name|sx_misc_kill_all_prims
decl_stmt|;
name|bool
name|cb_dirty
decl_stmt|;
name|bool
name|db_dirty
decl_stmt|;
name|bool
name|streamout_dirty
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|htile_bo
decl_stmt|;
name|u64
name|htile_offset
decl_stmt|;
name|u32
name|htile_surface
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|FMT_8_BIT
parameter_list|(
name|fmt
parameter_list|,
name|vc
parameter_list|)
value|[fmt] = { 1, 1, 1, vc, CHIP_R600 }
end_define

begin_define
define|#
directive|define
name|FMT_16_BIT
parameter_list|(
name|fmt
parameter_list|,
name|vc
parameter_list|)
value|[fmt] = { 1, 1, 2, vc, CHIP_R600 }
end_define

begin_define
define|#
directive|define
name|FMT_24_BIT
parameter_list|(
name|fmt
parameter_list|)
value|[fmt] = { 1, 1, 4,  0, CHIP_R600 }
end_define

begin_define
define|#
directive|define
name|FMT_32_BIT
parameter_list|(
name|fmt
parameter_list|,
name|vc
parameter_list|)
value|[fmt] = { 1, 1, 4, vc, CHIP_R600 }
end_define

begin_define
define|#
directive|define
name|FMT_48_BIT
parameter_list|(
name|fmt
parameter_list|)
value|[fmt] = { 1, 1, 8,  0, CHIP_R600 }
end_define

begin_define
define|#
directive|define
name|FMT_64_BIT
parameter_list|(
name|fmt
parameter_list|,
name|vc
parameter_list|)
value|[fmt] = { 1, 1, 8, vc, CHIP_R600 }
end_define

begin_define
define|#
directive|define
name|FMT_96_BIT
parameter_list|(
name|fmt
parameter_list|)
value|[fmt] = { 1, 1, 12, 0, CHIP_R600 }
end_define

begin_define
define|#
directive|define
name|FMT_128_BIT
parameter_list|(
name|fmt
parameter_list|,
name|vc
parameter_list|)
value|[fmt] = { 1, 1, 16,vc, CHIP_R600 }
end_define

begin_struct
struct|struct
name|gpu_formats
block|{
name|unsigned
name|blockwidth
decl_stmt|;
name|unsigned
name|blockheight
decl_stmt|;
name|unsigned
name|blocksize
decl_stmt|;
name|unsigned
name|valid_color
decl_stmt|;
name|enum
name|radeon_family
name|min_family
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|gpu_formats
name|color_formats_table
index|[]
init|=
block|{
comment|/* 8 bit */
name|FMT_8_BIT
argument_list|(
name|V_038004_COLOR_8
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_8_BIT
argument_list|(
name|V_038004_COLOR_4_4
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_8_BIT
argument_list|(
name|V_038004_COLOR_3_3_2
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_8_BIT
argument_list|(
name|V_038004_FMT_1
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 16-bit */
name|FMT_16_BIT
argument_list|(
name|V_038004_COLOR_16
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_16_BIT
argument_list|(
name|V_038004_COLOR_16_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_16_BIT
argument_list|(
name|V_038004_COLOR_8_8
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_16_BIT
argument_list|(
name|V_038004_COLOR_5_6_5
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_16_BIT
argument_list|(
name|V_038004_COLOR_6_5_5
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_16_BIT
argument_list|(
name|V_038004_COLOR_1_5_5_5
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_16_BIT
argument_list|(
name|V_038004_COLOR_4_4_4_4
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_16_BIT
argument_list|(
name|V_038004_COLOR_5_5_5_1
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 24-bit */
name|FMT_24_BIT
argument_list|(
name|V_038004_FMT_8_8_8
argument_list|)
block|,
comment|/* 32-bit */
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_32
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_32_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_16_16
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_16_16_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_8_24
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_8_24_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_24_8
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_24_8_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_10_11_11
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_10_11_11_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_11_11_10
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_11_11_10_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_2_10_10_10
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_8_8_8_8
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_COLOR_10_10_10_2
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_FMT_5_9_9_9_SHAREDEXP
argument_list|,
literal|0
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_FMT_32_AS_8
argument_list|,
literal|0
argument_list|)
block|,
name|FMT_32_BIT
argument_list|(
name|V_038004_FMT_32_AS_8_8
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 48-bit */
name|FMT_48_BIT
argument_list|(
name|V_038004_FMT_16_16_16
argument_list|)
block|,
name|FMT_48_BIT
argument_list|(
name|V_038004_FMT_16_16_16_FLOAT
argument_list|)
block|,
comment|/* 64-bit */
name|FMT_64_BIT
argument_list|(
name|V_038004_COLOR_X24_8_32_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_64_BIT
argument_list|(
name|V_038004_COLOR_32_32
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_64_BIT
argument_list|(
name|V_038004_COLOR_32_32_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_64_BIT
argument_list|(
name|V_038004_COLOR_16_16_16_16
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_64_BIT
argument_list|(
name|V_038004_COLOR_16_16_16_16_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_96_BIT
argument_list|(
name|V_038004_FMT_32_32_32
argument_list|)
block|,
name|FMT_96_BIT
argument_list|(
name|V_038004_FMT_32_32_32_FLOAT
argument_list|)
block|,
comment|/* 128-bit */
name|FMT_128_BIT
argument_list|(
name|V_038004_COLOR_32_32_32_32
argument_list|,
literal|1
argument_list|)
block|,
name|FMT_128_BIT
argument_list|(
name|V_038004_COLOR_32_32_32_32_FLOAT
argument_list|,
literal|1
argument_list|)
block|,
index|[
name|V_038004_FMT_GB_GR
index|]
operator|=
block|{
literal|2
block|,
literal|1
block|,
literal|4
block|,
literal|0
block|}
block|,
index|[
name|V_038004_FMT_BG_RG
index|]
operator|=
block|{
literal|2
block|,
literal|1
block|,
literal|4
block|,
literal|0
block|}
block|,
comment|/* block compressed formats */
index|[
name|V_038004_FMT_BC1
index|]
operator|=
block|{
literal|4
block|,
literal|4
block|,
literal|8
block|,
literal|0
block|}
block|,
index|[
name|V_038004_FMT_BC2
index|]
operator|=
block|{
literal|4
block|,
literal|4
block|,
literal|16
block|,
literal|0
block|}
block|,
index|[
name|V_038004_FMT_BC3
index|]
operator|=
block|{
literal|4
block|,
literal|4
block|,
literal|16
block|,
literal|0
block|}
block|,
index|[
name|V_038004_FMT_BC4
index|]
operator|=
block|{
literal|4
block|,
literal|4
block|,
literal|8
block|,
literal|0
block|}
block|,
index|[
name|V_038004_FMT_BC5
index|]
operator|=
block|{
literal|4
block|,
literal|4
block|,
literal|16
block|,
literal|0
block|}
block|,
index|[
name|V_038004_FMT_BC6
index|]
operator|=
block|{
literal|4
block|,
literal|4
block|,
literal|16
block|,
literal|0
block|,
name|CHIP_CEDAR
block|}
block|,
comment|/* Evergreen-only */
index|[
name|V_038004_FMT_BC7
index|]
operator|=
block|{
literal|4
block|,
literal|4
block|,
literal|16
block|,
literal|0
block|,
name|CHIP_CEDAR
block|}
block|,
comment|/* Evergreen-only */
comment|/* The other Evergreen formats */
index|[
name|V_038004_FMT_32_AS_32_32_32_32
index|]
operator|=
block|{
literal|1
block|,
literal|1
block|,
literal|4
block|,
literal|0
block|,
name|CHIP_CEDAR
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|bool
name|r600_fmt_is_valid_color
parameter_list|(
name|u32
name|format
parameter_list|)
block|{
if|if
condition|(
name|format
operator|>=
name|DRM_ARRAY_SIZE
argument_list|(
name|color_formats_table
argument_list|)
condition|)
return|return
name|false
return|;
if|if
condition|(
name|color_formats_table
index|[
name|format
index|]
operator|.
name|valid_color
condition|)
return|return
name|true
return|;
return|return
name|false
return|;
block|}
end_function

begin_function
name|bool
name|r600_fmt_is_valid_texture
parameter_list|(
name|u32
name|format
parameter_list|,
name|enum
name|radeon_family
name|family
parameter_list|)
block|{
if|if
condition|(
name|format
operator|>=
name|DRM_ARRAY_SIZE
argument_list|(
name|color_formats_table
argument_list|)
condition|)
return|return
name|false
return|;
if|if
condition|(
name|family
operator|<
name|color_formats_table
index|[
name|format
index|]
operator|.
name|min_family
condition|)
return|return
name|false
return|;
if|if
condition|(
name|color_formats_table
index|[
name|format
index|]
operator|.
name|blockwidth
operator|>
literal|0
condition|)
return|return
name|true
return|;
return|return
name|false
return|;
block|}
end_function

begin_function
name|int
name|r600_fmt_get_blocksize
parameter_list|(
name|u32
name|format
parameter_list|)
block|{
if|if
condition|(
name|format
operator|>=
name|DRM_ARRAY_SIZE
argument_list|(
name|color_formats_table
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
name|color_formats_table
index|[
name|format
index|]
operator|.
name|blocksize
return|;
block|}
end_function

begin_function
name|int
name|r600_fmt_get_nblocksx
parameter_list|(
name|u32
name|format
parameter_list|,
name|u32
name|w
parameter_list|)
block|{
name|unsigned
name|bw
decl_stmt|;
if|if
condition|(
name|format
operator|>=
name|DRM_ARRAY_SIZE
argument_list|(
name|color_formats_table
argument_list|)
condition|)
return|return
literal|0
return|;
name|bw
operator|=
name|color_formats_table
index|[
name|format
index|]
operator|.
name|blockwidth
expr_stmt|;
if|if
condition|(
name|bw
operator|==
literal|0
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|w
operator|+
name|bw
operator|-
literal|1
operator|)
operator|/
name|bw
return|;
block|}
end_function

begin_function
name|int
name|r600_fmt_get_nblocksy
parameter_list|(
name|u32
name|format
parameter_list|,
name|u32
name|h
parameter_list|)
block|{
name|unsigned
name|bh
decl_stmt|;
if|if
condition|(
name|format
operator|>=
name|DRM_ARRAY_SIZE
argument_list|(
name|color_formats_table
argument_list|)
condition|)
return|return
literal|0
return|;
name|bh
operator|=
name|color_formats_table
index|[
name|format
index|]
operator|.
name|blockheight
expr_stmt|;
if|if
condition|(
name|bh
operator|==
literal|0
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|h
operator|+
name|bh
operator|-
literal|1
operator|)
operator|/
name|bh
return|;
block|}
end_function

begin_struct
struct|struct
name|array_mode_checker
block|{
name|int
name|array_mode
decl_stmt|;
name|u32
name|group_size
decl_stmt|;
name|u32
name|nbanks
decl_stmt|;
name|u32
name|npipes
decl_stmt|;
name|u32
name|nsamples
decl_stmt|;
name|u32
name|blocksize
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* returns alignment in pixels for pitch/height/depth and bytes for base */
end_comment

begin_function
specifier|static
name|int
name|r600_get_array_mode_alignment
parameter_list|(
name|struct
name|array_mode_checker
modifier|*
name|values
parameter_list|,
name|u32
modifier|*
name|pitch_align
parameter_list|,
name|u32
modifier|*
name|height_align
parameter_list|,
name|u32
modifier|*
name|depth_align
parameter_list|,
name|u64
modifier|*
name|base_align
parameter_list|)
block|{
name|u32
name|tile_width
init|=
literal|8
decl_stmt|;
name|u32
name|tile_height
init|=
literal|8
decl_stmt|;
name|u32
name|macro_tile_width
init|=
name|values
operator|->
name|nbanks
decl_stmt|;
name|u32
name|macro_tile_height
init|=
name|values
operator|->
name|npipes
decl_stmt|;
name|u32
name|tile_bytes
init|=
name|tile_width
operator|*
name|tile_height
operator|*
name|values
operator|->
name|blocksize
operator|*
name|values
operator|->
name|nsamples
decl_stmt|;
name|u32
name|macro_tile_bytes
init|=
name|macro_tile_width
operator|*
name|macro_tile_height
operator|*
name|tile_bytes
decl_stmt|;
switch|switch
condition|(
name|values
operator|->
name|array_mode
condition|)
block|{
case|case
name|ARRAY_LINEAR_GENERAL
case|:
comment|/* technically tile_width/_height for pitch/height */
operator|*
name|pitch_align
operator|=
literal|1
expr_stmt|;
comment|/* tile_width */
operator|*
name|height_align
operator|=
literal|1
expr_stmt|;
comment|/* tile_height */
operator|*
name|depth_align
operator|=
literal|1
expr_stmt|;
operator|*
name|base_align
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ARRAY_LINEAR_ALIGNED
case|:
operator|*
name|pitch_align
operator|=
name|max
argument_list|(
operator|(
name|u32
operator|)
literal|64
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|values
operator|->
name|group_size
operator|/
name|values
operator|->
name|blocksize
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|height_align
operator|=
literal|1
expr_stmt|;
operator|*
name|depth_align
operator|=
literal|1
expr_stmt|;
operator|*
name|base_align
operator|=
name|values
operator|->
name|group_size
expr_stmt|;
break|break;
case|case
name|ARRAY_1D_TILED_THIN1
case|:
operator|*
name|pitch_align
operator|=
name|max
argument_list|(
operator|(
name|u32
operator|)
name|tile_width
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|values
operator|->
name|group_size
operator|/
operator|(
name|tile_height
operator|*
name|values
operator|->
name|blocksize
operator|*
name|values
operator|->
name|nsamples
operator|)
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|height_align
operator|=
name|tile_height
expr_stmt|;
operator|*
name|depth_align
operator|=
literal|1
expr_stmt|;
operator|*
name|base_align
operator|=
name|values
operator|->
name|group_size
expr_stmt|;
break|break;
case|case
name|ARRAY_2D_TILED_THIN1
case|:
operator|*
name|pitch_align
operator|=
name|max
argument_list|(
operator|(
name|u32
operator|)
name|macro_tile_width
operator|*
name|tile_width
argument_list|,
call|(
name|u32
call|)
argument_list|(
operator|(
name|values
operator|->
name|group_size
operator|*
name|values
operator|->
name|nbanks
operator|)
operator|/
operator|(
name|values
operator|->
name|blocksize
operator|*
name|values
operator|->
name|nsamples
operator|*
name|tile_width
operator|)
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|height_align
operator|=
name|macro_tile_height
operator|*
name|tile_height
expr_stmt|;
operator|*
name|depth_align
operator|=
literal|1
expr_stmt|;
operator|*
name|base_align
operator|=
name|max
argument_list|(
name|macro_tile_bytes
argument_list|,
operator|(
operator|*
name|pitch_align
operator|)
operator|*
name|values
operator|->
name|blocksize
operator|*
operator|(
operator|*
name|height_align
operator|)
operator|*
name|values
operator|->
name|nsamples
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_cs_track_init
parameter_list|(
name|struct
name|r600_cs_track
modifier|*
name|track
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* assume DX9 mode */
name|track
operator|->
name|sq_config
operator|=
name|DX9_CONSTS
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|track
operator|->
name|cb_color_base_last
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|cb_color_size
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|cb_color_size_idx
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|cb_color_info
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|cb_color_view
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_color_bo
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|cb_color_bo_offset
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_color_bo_mc
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_color_frag_bo
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|cb_color_frag_offset
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_color_tile_bo
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|cb_color_tile_offset
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_color_mask
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
block|}
name|track
operator|->
name|is_resolve
operator|=
name|false
expr_stmt|;
name|track
operator|->
name|nsamples
operator|=
literal|16
expr_stmt|;
name|track
operator|->
name|log_nsamples
operator|=
literal|4
expr_stmt|;
name|track
operator|->
name|cb_target_mask
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_shader_mask
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|db_bo
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|db_bo_mc
operator|=
literal|0xFFFFFFFF
expr_stmt|;
comment|/* assume the biggest format and that htile is enabled */
name|track
operator|->
name|db_depth_info
operator|=
literal|7
operator||
operator|(
literal|1
operator|<<
literal|25
operator|)
expr_stmt|;
name|track
operator|->
name|db_depth_view
operator|=
literal|0xFFFFC000
expr_stmt|;
name|track
operator|->
name|db_depth_size
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|db_depth_size_idx
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|db_depth_control
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|htile_bo
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|htile_offset
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|htile_surface
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|track
operator|->
name|vgt_strmout_size
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|vgt_strmout_bo
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|vgt_strmout_bo_offset
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|vgt_strmout_bo_mc
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
block|}
name|track
operator|->
name|streamout_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|sx_misc_kill_all_prims
operator|=
name|false
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_cs_track_validate_cb
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|int
name|i
parameter_list|)
block|{
name|struct
name|r600_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|u32
name|slice_tile_max
decl_stmt|,
name|size
decl_stmt|,
name|tmp
decl_stmt|;
name|u32
name|height
decl_stmt|,
name|height_align
decl_stmt|,
name|pitch
decl_stmt|,
name|pitch_align
decl_stmt|,
name|depth_align
decl_stmt|;
name|u64
name|base_offset
decl_stmt|,
name|base_align
decl_stmt|;
name|struct
name|array_mode_checker
name|array_check
decl_stmt|;
specifier|volatile
name|u32
modifier|*
name|ib
init|=
name|p
operator|->
name|ib
operator|.
name|ptr
decl_stmt|;
name|unsigned
name|array_mode
decl_stmt|;
name|u32
name|format
decl_stmt|;
comment|/* When resolve is used, the second colorbuffer has always 1 sample. */
name|unsigned
name|nsamples
init|=
name|track
operator|->
name|is_resolve
operator|&&
name|i
operator|==
literal|1
condition|?
literal|1
else|:
name|track
operator|->
name|nsamples
decl_stmt|;
name|size
operator|=
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb_color_bo
index|[
name|i
index|]
argument_list|)
operator|-
name|track
operator|->
name|cb_color_bo_offset
index|[
name|i
index|]
expr_stmt|;
name|format
operator|=
name|G_0280A0_FORMAT
argument_list|(
name|track
operator|->
name|cb_color_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r600_fmt_is_valid_color
argument_list|(
name|format
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d cb invalid format %d for %d (0x%08X)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|format
argument_list|,
name|i
argument_list|,
name|track
operator|->
name|cb_color_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* pitch in pixels */
name|pitch
operator|=
operator|(
name|G_028060_PITCH_TILE_MAX
argument_list|(
name|track
operator|->
name|cb_color_size
index|[
name|i
index|]
argument_list|)
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|slice_tile_max
operator|=
name|G_028060_SLICE_TILE_MAX
argument_list|(
name|track
operator|->
name|cb_color_size
index|[
name|i
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|slice_tile_max
operator|*=
literal|64
expr_stmt|;
name|height
operator|=
name|slice_tile_max
operator|/
name|pitch
expr_stmt|;
if|if
condition|(
name|height
operator|>
literal|8192
condition|)
name|height
operator|=
literal|8192
expr_stmt|;
name|array_mode
operator|=
name|G_0280A0_ARRAY_MODE
argument_list|(
name|track
operator|->
name|cb_color_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|base_offset
operator|=
name|track
operator|->
name|cb_color_bo_mc
index|[
name|i
index|]
operator|+
name|track
operator|->
name|cb_color_bo_offset
index|[
name|i
index|]
expr_stmt|;
name|array_check
operator|.
name|array_mode
operator|=
name|array_mode
expr_stmt|;
name|array_check
operator|.
name|group_size
operator|=
name|track
operator|->
name|group_size
expr_stmt|;
name|array_check
operator|.
name|nbanks
operator|=
name|track
operator|->
name|nbanks
expr_stmt|;
name|array_check
operator|.
name|npipes
operator|=
name|track
operator|->
name|npipes
expr_stmt|;
name|array_check
operator|.
name|nsamples
operator|=
name|nsamples
expr_stmt|;
name|array_check
operator|.
name|blocksize
operator|=
name|r600_fmt_get_blocksize
argument_list|(
name|format
argument_list|)
expr_stmt|;
if|if
condition|(
name|r600_get_array_mode_alignment
argument_list|(
operator|&
name|array_check
argument_list|,
operator|&
name|pitch_align
argument_list|,
operator|&
name|height_align
argument_list|,
operator|&
name|depth_align
argument_list|,
operator|&
name|base_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s invalid tiling %d for %d (0x%08X)\n"
argument_list|,
name|__func__
argument_list|,
name|G_0280A0_ARRAY_MODE
argument_list|(
name|track
operator|->
name|cb_color_info
index|[
name|i
index|]
argument_list|)
argument_list|,
name|i
argument_list|,
name|track
operator|->
name|cb_color_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|array_mode
condition|)
block|{
case|case
name|V_0280A0_ARRAY_LINEAR_GENERAL
case|:
break|break;
case|case
name|V_0280A0_ARRAY_LINEAR_ALIGNED
case|:
break|break;
case|case
name|V_0280A0_ARRAY_1D_TILED_THIN1
case|:
comment|/* avoid breaking userspace */
if|if
condition|(
name|height
operator|>
literal|7
condition|)
name|height
operator|&=
operator|~
literal|0x7
expr_stmt|;
break|break;
case|case
name|V_0280A0_ARRAY_2D_TILED_THIN1
case|:
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s invalid tiling %d for %d (0x%08X)\n"
argument_list|,
name|__func__
argument_list|,
name|G_0280A0_ARRAY_MODE
argument_list|(
name|track
operator|->
name|cb_color_info
index|[
name|i
index|]
argument_list|)
argument_list|,
name|i
argument_list|,
name|track
operator|->
name|cb_color_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|pitch
argument_list|,
name|pitch_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d cb pitch (%d, 0x%x, %d) invalid\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|pitch
argument_list|,
name|pitch_align
argument_list|,
name|array_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|height
argument_list|,
name|height_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d cb height (%d, 0x%x, %d) invalid\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|height
argument_list|,
name|height_align
argument_list|,
name|array_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|base_offset
argument_list|,
name|base_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s offset[%d] 0x%jx 0x%jx, %d not aligned\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|,
operator|(
name|uintmax_t
operator|)
name|base_offset
argument_list|,
operator|(
name|uintmax_t
operator|)
name|base_align
argument_list|,
name|array_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* check offset */
name|tmp
operator|=
name|r600_fmt_get_nblocksy
argument_list|(
name|format
argument_list|,
name|height
argument_list|)
operator|*
name|r600_fmt_get_nblocksx
argument_list|(
name|format
argument_list|,
name|pitch
argument_list|)
operator|*
name|r600_fmt_get_blocksize
argument_list|(
name|format
argument_list|)
operator|*
name|nsamples
expr_stmt|;
switch|switch
condition|(
name|array_mode
condition|)
block|{
default|default:
case|case
name|V_0280A0_ARRAY_LINEAR_GENERAL
case|:
case|case
name|V_0280A0_ARRAY_LINEAR_ALIGNED
case|:
name|tmp
operator|+=
name|track
operator|->
name|cb_color_view
index|[
name|i
index|]
operator|&
literal|0xFF
expr_stmt|;
break|break;
case|case
name|V_0280A0_ARRAY_1D_TILED_THIN1
case|:
case|case
name|V_0280A0_ARRAY_2D_TILED_THIN1
case|:
name|tmp
operator|+=
name|G_028080_SLICE_MAX
argument_list|(
name|track
operator|->
name|cb_color_view
index|[
name|i
index|]
argument_list|)
operator|*
name|tmp
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|tmp
operator|+
name|track
operator|->
name|cb_color_bo_offset
index|[
name|i
index|]
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb_color_bo
index|[
name|i
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|array_mode
operator|==
name|V_0280A0_ARRAY_LINEAR_GENERAL
condition|)
block|{
comment|/* the initial DDX does bad things with the CB size occasionally */
comment|/* it rounds up height too far for slice tile max but the BO is smaller */
comment|/* r600c,g also seem to flush at bad times in some apps resulting in 			 * bogus values here. So for linear just allow anything to avoid breaking 			 * broken userspace. 			 */
block|}
else|else
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s offset[%d] %d %ju %d %lu too big (%d %d) (%d %d %d)\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|,
name|array_mode
argument_list|,
operator|(
name|uintmax_t
operator|)
name|track
operator|->
name|cb_color_bo_offset
index|[
name|i
index|]
argument_list|,
name|tmp
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb_color_bo
index|[
name|i
index|]
argument_list|)
argument_list|,
name|pitch
argument_list|,
name|height
argument_list|,
name|r600_fmt_get_nblocksx
argument_list|(
name|format
argument_list|,
name|pitch
argument_list|)
argument_list|,
name|r600_fmt_get_nblocksy
argument_list|(
name|format
argument_list|,
name|height
argument_list|)
argument_list|,
name|r600_fmt_get_blocksize
argument_list|(
name|format
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
comment|/* limit max tile */
name|tmp
operator|=
operator|(
name|height
operator|*
name|pitch
operator|)
operator|>>
literal|6
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|slice_tile_max
condition|)
name|slice_tile_max
operator|=
name|tmp
expr_stmt|;
name|tmp
operator|=
name|S_028060_PITCH_TILE_MAX
argument_list|(
operator|(
name|pitch
operator|/
literal|8
operator|)
operator|-
literal|1
argument_list|)
operator||
name|S_028060_SLICE_TILE_MAX
argument_list|(
name|slice_tile_max
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ib
index|[
name|track
operator|->
name|cb_color_size_idx
index|[
name|i
index|]
index|]
operator|=
name|tmp
expr_stmt|;
comment|/* FMASK/CMASK */
switch|switch
condition|(
name|G_0280A0_TILE_MODE
argument_list|(
name|track
operator|->
name|cb_color_info
index|[
name|i
index|]
argument_list|)
condition|)
block|{
case|case
name|V_0280A0_TILE_DISABLE
case|:
break|break;
case|case
name|V_0280A0_FRAG_ENABLE
case|:
if|if
condition|(
name|track
operator|->
name|nsamples
operator|>
literal|1
condition|)
block|{
name|uint32_t
name|tile_max
init|=
name|G_028100_FMASK_TILE_MAX
argument_list|(
name|track
operator|->
name|cb_color_mask
index|[
name|i
index|]
argument_list|)
decl_stmt|;
comment|/* the tile size is 8x8, but the size is in units of bits. 			 * for bytes, do just * 8. */
name|uint32_t
name|bytes
init|=
name|track
operator|->
name|nsamples
operator|*
name|track
operator|->
name|log_nsamples
operator|*
literal|8
operator|*
operator|(
name|tile_max
operator|+
literal|1
operator|)
decl_stmt|;
if|if
condition|(
name|bytes
operator|+
name|track
operator|->
name|cb_color_frag_offset
index|[
name|i
index|]
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb_color_frag_bo
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s FMASK_TILE_MAX too large "
literal|"(tile_max=%u, bytes=%u, offset=%ju, bo_size=%lu)\n"
argument_list|,
name|__func__
argument_list|,
name|tile_max
argument_list|,
name|bytes
argument_list|,
operator|(
name|uintmax_t
operator|)
name|track
operator|->
name|cb_color_frag_offset
index|[
name|i
index|]
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb_color_frag_bo
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
comment|/* fall through */
case|case
name|V_0280A0_CLEAR_ENABLE
case|:
block|{
name|uint32_t
name|block_max
init|=
name|G_028100_CMASK_BLOCK_MAX
argument_list|(
name|track
operator|->
name|cb_color_mask
index|[
name|i
index|]
argument_list|)
decl_stmt|;
comment|/* One block = 128x128 pixels, one 8x8 tile has 4 bits.. 		 * (128*128) / (8*8) / 2 = 128 bytes per block. */
name|uint32_t
name|bytes
init|=
operator|(
name|block_max
operator|+
literal|1
operator|)
operator|*
literal|128
decl_stmt|;
if|if
condition|(
name|bytes
operator|+
name|track
operator|->
name|cb_color_tile_offset
index|[
name|i
index|]
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb_color_tile_bo
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s CMASK_BLOCK_MAX too large "
literal|"(block_max=%u, bytes=%u, offset=%ju, bo_size=%lu)\n"
argument_list|,
name|__func__
argument_list|,
name|block_max
argument_list|,
name|bytes
argument_list|,
operator|(
name|uintmax_t
operator|)
name|track
operator|->
name|cb_color_tile_offset
index|[
name|i
index|]
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb_color_tile_bo
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
block|}
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s invalid tile mode\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_cs_track_validate_db
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|r600_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|u32
name|nviews
decl_stmt|,
name|bpe
decl_stmt|,
name|ntiles
decl_stmt|,
name|size
decl_stmt|,
name|slice_tile_max
decl_stmt|,
name|tmp
decl_stmt|;
name|u32
name|height_align
decl_stmt|,
name|pitch_align
decl_stmt|,
name|depth_align
decl_stmt|;
name|u32
name|pitch
init|=
literal|8192
decl_stmt|;
name|u32
name|height
init|=
literal|8192
decl_stmt|;
name|u64
name|base_offset
decl_stmt|,
name|base_align
decl_stmt|;
name|struct
name|array_mode_checker
name|array_check
decl_stmt|;
name|int
name|array_mode
decl_stmt|;
specifier|volatile
name|u32
modifier|*
name|ib
init|=
name|p
operator|->
name|ib
operator|.
name|ptr
decl_stmt|;
if|if
condition|(
name|track
operator|->
name|db_bo
operator|==
name|NULL
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"z/stencil with no depth buffer\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|G_028010_FORMAT
argument_list|(
name|track
operator|->
name|db_depth_info
argument_list|)
condition|)
block|{
case|case
name|V_028010_DEPTH_16
case|:
name|bpe
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|V_028010_DEPTH_X8_24
case|:
case|case
name|V_028010_DEPTH_8_24
case|:
case|case
name|V_028010_DEPTH_X8_24_FLOAT
case|:
case|case
name|V_028010_DEPTH_8_24_FLOAT
case|:
case|case
name|V_028010_DEPTH_32_FLOAT
case|:
name|bpe
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|V_028010_DEPTH_X24_8_32_FLOAT
case|:
name|bpe
operator|=
literal|8
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"z/stencil with invalid format %d\n"
argument_list|,
name|G_028010_FORMAT
argument_list|(
name|track
operator|->
name|db_depth_info
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|track
operator|->
name|db_depth_size
operator|&
literal|0xFFFFFC00
operator|)
operator|==
literal|0xFFFFFC00
condition|)
block|{
if|if
condition|(
operator|!
name|track
operator|->
name|db_depth_size_idx
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"z/stencil buffer size not set\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_bo
argument_list|)
operator|-
name|track
operator|->
name|db_offset
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|/
name|bpe
operator|)
operator|>>
literal|6
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"z/stencil buffer too small (0x%08X %d %d %ld)\n"
argument_list|,
name|track
operator|->
name|db_depth_size
argument_list|,
name|bpe
argument_list|,
name|track
operator|->
name|db_offset
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_bo
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|track
operator|->
name|db_depth_size_idx
index|]
operator|=
name|S_028000_SLICE_TILE_MAX
argument_list|(
name|tmp
operator|-
literal|1
argument_list|)
operator||
operator|(
name|track
operator|->
name|db_depth_size
operator|&
literal|0x3FF
operator|)
expr_stmt|;
block|}
else|else
block|{
name|size
operator|=
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_bo
argument_list|)
expr_stmt|;
comment|/* pitch in pixels */
name|pitch
operator|=
operator|(
name|G_028000_PITCH_TILE_MAX
argument_list|(
name|track
operator|->
name|db_depth_size
argument_list|)
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|slice_tile_max
operator|=
name|G_028000_SLICE_TILE_MAX
argument_list|(
name|track
operator|->
name|db_depth_size
argument_list|)
operator|+
literal|1
expr_stmt|;
name|slice_tile_max
operator|*=
literal|64
expr_stmt|;
name|height
operator|=
name|slice_tile_max
operator|/
name|pitch
expr_stmt|;
if|if
condition|(
name|height
operator|>
literal|8192
condition|)
name|height
operator|=
literal|8192
expr_stmt|;
name|base_offset
operator|=
name|track
operator|->
name|db_bo_mc
operator|+
name|track
operator|->
name|db_offset
expr_stmt|;
name|array_mode
operator|=
name|G_028010_ARRAY_MODE
argument_list|(
name|track
operator|->
name|db_depth_info
argument_list|)
expr_stmt|;
name|array_check
operator|.
name|array_mode
operator|=
name|array_mode
expr_stmt|;
name|array_check
operator|.
name|group_size
operator|=
name|track
operator|->
name|group_size
expr_stmt|;
name|array_check
operator|.
name|nbanks
operator|=
name|track
operator|->
name|nbanks
expr_stmt|;
name|array_check
operator|.
name|npipes
operator|=
name|track
operator|->
name|npipes
expr_stmt|;
name|array_check
operator|.
name|nsamples
operator|=
name|track
operator|->
name|nsamples
expr_stmt|;
name|array_check
operator|.
name|blocksize
operator|=
name|bpe
expr_stmt|;
if|if
condition|(
name|r600_get_array_mode_alignment
argument_list|(
operator|&
name|array_check
argument_list|,
operator|&
name|pitch_align
argument_list|,
operator|&
name|height_align
argument_list|,
operator|&
name|depth_align
argument_list|,
operator|&
name|base_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s invalid tiling %d (0x%08X)\n"
argument_list|,
name|__func__
argument_list|,
name|G_028010_ARRAY_MODE
argument_list|(
name|track
operator|->
name|db_depth_info
argument_list|)
argument_list|,
name|track
operator|->
name|db_depth_info
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|array_mode
condition|)
block|{
case|case
name|V_028010_ARRAY_1D_TILED_THIN1
case|:
comment|/* don't break userspace */
name|height
operator|&=
operator|~
literal|0x7
expr_stmt|;
break|break;
case|case
name|V_028010_ARRAY_2D_TILED_THIN1
case|:
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s invalid tiling %d (0x%08X)\n"
argument_list|,
name|__func__
argument_list|,
name|G_028010_ARRAY_MODE
argument_list|(
name|track
operator|->
name|db_depth_info
argument_list|)
argument_list|,
name|track
operator|->
name|db_depth_info
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|pitch
argument_list|,
name|pitch_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d db pitch (%d, 0x%x, %d) invalid\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|pitch
argument_list|,
name|pitch_align
argument_list|,
name|array_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|height
argument_list|,
name|height_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d db height (%d, 0x%x, %d) invalid\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|height
argument_list|,
name|height_align
argument_list|,
name|array_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|base_offset
argument_list|,
name|base_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s offset 0x%jx, 0x%jx, %d not aligned\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|uintmax_t
operator|)
name|base_offset
argument_list|,
operator|(
name|uintmax_t
operator|)
name|base_align
argument_list|,
name|array_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ntiles
operator|=
name|G_028000_SLICE_TILE_MAX
argument_list|(
name|track
operator|->
name|db_depth_size
argument_list|)
operator|+
literal|1
expr_stmt|;
name|nviews
operator|=
name|G_028004_SLICE_MAX
argument_list|(
name|track
operator|->
name|db_depth_view
argument_list|)
operator|+
literal|1
expr_stmt|;
name|tmp
operator|=
name|ntiles
operator|*
name|bpe
operator|*
literal|64
operator|*
name|nviews
operator|*
name|track
operator|->
name|nsamples
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|+
name|track
operator|->
name|db_offset
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_bo
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"z/stencil buffer (%d) too small (0x%08X %d %d %d -> %u have %lu)\n"
argument_list|,
name|array_mode
argument_list|,
name|track
operator|->
name|db_depth_size
argument_list|,
name|ntiles
argument_list|,
name|nviews
argument_list|,
name|bpe
argument_list|,
name|tmp
operator|+
name|track
operator|->
name|db_offset
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_bo
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
comment|/* hyperz */
if|if
condition|(
name|G_028010_TILE_SURFACE_ENABLE
argument_list|(
name|track
operator|->
name|db_depth_info
argument_list|)
condition|)
block|{
name|unsigned
name|long
name|size
decl_stmt|;
name|unsigned
name|nbx
decl_stmt|,
name|nby
decl_stmt|;
if|if
condition|(
name|track
operator|->
name|htile_bo
operator|==
name|NULL
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d htile enabled without htile surface 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|db_depth_info
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|track
operator|->
name|db_depth_size
operator|&
literal|0xFFFFFC00
operator|)
operator|==
literal|0xFFFFFC00
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d htile can't be enabled with bogus db_depth_size 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|db_depth_size
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|nbx
operator|=
name|pitch
expr_stmt|;
name|nby
operator|=
name|height
expr_stmt|;
if|if
condition|(
name|G_028D24_LINEAR
argument_list|(
name|track
operator|->
name|htile_surface
argument_list|)
condition|)
block|{
comment|/* nbx must be 16 htiles aligned == 16 * 8 pixel aligned */
name|nbx
operator|=
name|roundup2
argument_list|(
name|nbx
argument_list|,
literal|16
operator|*
literal|8
argument_list|)
expr_stmt|;
comment|/* nby is npipes htiles aligned == npipes * 8 pixel aligned */
name|nby
operator|=
name|roundup
argument_list|(
name|nby
argument_list|,
name|track
operator|->
name|npipes
operator|*
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* always assume 8x8 htile */
comment|/* align is htile align * 8, htile align vary according to 			 * number of pipe and tile width and nby 			 */
switch|switch
condition|(
name|track
operator|->
name|npipes
condition|)
block|{
case|case
literal|8
case|:
comment|/* HTILE_WIDTH = 8& HTILE_HEIGHT = 8*/
name|nbx
operator|=
name|roundup2
argument_list|(
name|nbx
argument_list|,
literal|64
operator|*
literal|8
argument_list|)
expr_stmt|;
name|nby
operator|=
name|roundup2
argument_list|(
name|nby
argument_list|,
literal|64
operator|*
literal|8
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* HTILE_WIDTH = 8& HTILE_HEIGHT = 8*/
name|nbx
operator|=
name|roundup2
argument_list|(
name|nbx
argument_list|,
literal|64
operator|*
literal|8
argument_list|)
expr_stmt|;
name|nby
operator|=
name|roundup2
argument_list|(
name|nby
argument_list|,
literal|32
operator|*
literal|8
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* HTILE_WIDTH = 8& HTILE_HEIGHT = 8*/
name|nbx
operator|=
name|roundup2
argument_list|(
name|nbx
argument_list|,
literal|32
operator|*
literal|8
argument_list|)
expr_stmt|;
name|nby
operator|=
name|roundup2
argument_list|(
name|nby
argument_list|,
literal|32
operator|*
literal|8
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* HTILE_WIDTH = 8& HTILE_HEIGHT = 8*/
name|nbx
operator|=
name|roundup2
argument_list|(
name|nbx
argument_list|,
literal|32
operator|*
literal|8
argument_list|)
expr_stmt|;
name|nby
operator|=
name|roundup2
argument_list|(
name|nby
argument_list|,
literal|16
operator|*
literal|8
argument_list|)
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid num pipes %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|npipes
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
comment|/* compute number of htile */
name|nbx
operator|=
name|nbx
operator|>>
literal|3
expr_stmt|;
name|nby
operator|=
name|nby
operator|>>
literal|3
expr_stmt|;
comment|/* size must be aligned on npipes * 2K boundary */
name|size
operator|=
name|roundup
argument_list|(
name|nbx
operator|*
name|nby
operator|*
literal|4
argument_list|,
name|track
operator|->
name|npipes
operator|*
operator|(
literal|2
operator|<<
literal|10
operator|)
argument_list|)
expr_stmt|;
name|size
operator|+=
name|track
operator|->
name|htile_offset
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|htile_bo
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d htile surface too small %ld for %ld (%d %d)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|htile_bo
argument_list|)
argument_list|,
name|size
argument_list|,
name|nbx
argument_list|,
name|nby
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
name|track
operator|->
name|db_dirty
operator|=
name|false
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_cs_track_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|r600_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|r
decl_stmt|,
name|i
decl_stmt|;
comment|/* on legacy kernel we don't perform advanced check */
if|if
condition|(
name|p
operator|->
name|rdev
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* check streamout */
if|if
condition|(
name|track
operator|->
name|streamout_dirty
operator|&&
name|track
operator|->
name|vgt_strmout_en
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|track
operator|->
name|vgt_strmout_buffer_en
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
if|if
condition|(
name|track
operator|->
name|vgt_strmout_bo
index|[
name|i
index|]
condition|)
block|{
name|u64
name|offset
init|=
operator|(
name|u64
operator|)
name|track
operator|->
name|vgt_strmout_bo_offset
index|[
name|i
index|]
operator|+
operator|(
name|u64
operator|)
name|track
operator|->
name|vgt_strmout_size
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|offset
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|vgt_strmout_bo
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"streamout %d bo too small: 0x%jx, 0x%lx\n"
argument_list|,
name|i
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|vgt_strmout_bo
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"No buffer for streamout %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
name|track
operator|->
name|streamout_dirty
operator|=
name|false
expr_stmt|;
block|}
if|if
condition|(
name|track
operator|->
name|sx_misc_kill_all_prims
condition|)
return|return
literal|0
return|;
comment|/* check that we have a cb for each enabled target, we don't check 	 * shader_mask because it seems mesa isn't always setting it :( 	 */
if|if
condition|(
name|track
operator|->
name|cb_dirty
condition|)
block|{
name|tmp
operator|=
name|track
operator|->
name|cb_target_mask
expr_stmt|;
comment|/* We must check both colorbuffers for RESOLVE. */
if|if
condition|(
name|track
operator|->
name|is_resolve
condition|)
block|{
name|tmp
operator||=
literal|0xff
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|tmp
operator|>>
operator|(
name|i
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xF
condition|)
block|{
comment|/* at least one component is enabled */
if|if
condition|(
name|track
operator|->
name|cb_color_bo
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d mask 0x%08X | 0x%08X no cb for %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|cb_target_mask
argument_list|,
name|track
operator|->
name|cb_shader_mask
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* perform rewrite of CB_COLOR[0-7]_SIZE */
name|r
operator|=
name|r600_cs_track_validate_cb
argument_list|(
name|p
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
block|}
name|track
operator|->
name|cb_dirty
operator|=
name|false
expr_stmt|;
block|}
comment|/* Check depth buffer */
if|if
condition|(
name|track
operator|->
name|db_dirty
operator|&&
name|G_028010_FORMAT
argument_list|(
name|track
operator|->
name|db_depth_info
argument_list|)
operator|!=
name|V_028010_DEPTH_INVALID
operator|&&
operator|(
name|G_028800_STENCIL_ENABLE
argument_list|(
name|track
operator|->
name|db_depth_control
argument_list|)
operator|||
name|G_028800_Z_ENABLE
argument_list|(
name|track
operator|->
name|db_depth_control
argument_list|)
operator|)
condition|)
block|{
name|r
operator|=
name|r600_cs_track_validate_db
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * r600_cs_packet_parse() - parse cp packet and point ib index to next packet  * @parser:	parser structure holding parsing context.  * @pkt:	where to store packet informations  *  * Assume that chunk_ib_index is properly set. Will return -EINVAL  * if packet is bigger than remaining ib size. or if packets is unknown.  **/
end_comment

begin_function
specifier|static
name|int
name|r600_cs_packet_parse
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|unsigned
name|idx
parameter_list|)
block|{
name|struct
name|radeon_cs_chunk
modifier|*
name|ib_chunk
init|=
operator|&
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
decl_stmt|;
name|uint32_t
name|header
decl_stmt|;
if|if
condition|(
name|idx
operator|>=
name|ib_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Can not parse packet at %d after CS end %d !\n"
argument_list|,
name|idx
argument_list|,
name|ib_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|header
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|idx
operator|=
name|idx
expr_stmt|;
name|pkt
operator|->
name|type
operator|=
name|CP_PACKET_GET_TYPE
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|count
operator|=
name|CP_PACKET_GET_COUNT
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|one_reg_wr
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|type
condition|)
block|{
case|case
name|PACKET_TYPE0
case|:
name|pkt
operator|->
name|reg
operator|=
name|CP_PACKET0_GET_REG
argument_list|(
name|header
argument_list|)
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE3
case|:
name|pkt
operator|->
name|opcode
operator|=
name|CP_PACKET3_GET_OPCODE
argument_list|(
name|header
argument_list|)
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE2
case|:
name|pkt
operator|->
name|count
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet type %d at %d !\n"
argument_list|,
name|pkt
operator|->
name|type
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|pkt
operator|->
name|count
operator|+
literal|1
operator|+
name|pkt
operator|->
name|idx
operator|)
operator|>=
name|ib_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Packet (%d:%d:%d) end after CS buffer (%d) !\n"
argument_list|,
name|pkt
operator|->
name|idx
argument_list|,
name|pkt
operator|->
name|type
argument_list|,
name|pkt
operator|->
name|count
argument_list|,
name|ib_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * r600_cs_packet_next_reloc_mm() - parse next packet which should be reloc packet3  * @parser:		parser structure holding parsing context.  * @data:		pointer to relocation data  * @offset_start:	starting offset  * @offset_mask:	offset mask (to align start offset on)  * @reloc:		reloc informations  *  * Check next packet is relocation packet3, do bo validation and compute  * GPU offset using the provided start.  **/
end_comment

begin_function
specifier|static
name|int
name|r600_cs_packet_next_reloc_mm
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_reloc
modifier|*
modifier|*
name|cs_reloc
parameter_list|)
block|{
name|struct
name|radeon_cs_chunk
modifier|*
name|relocs_chunk
decl_stmt|;
name|struct
name|radeon_cs_packet
name|p3reloc
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|chunk_relocs_idx
operator|==
operator|-
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No relocation chunk !\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
operator|*
name|cs_reloc
operator|=
name|NULL
expr_stmt|;
name|relocs_chunk
operator|=
operator|&
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_relocs_idx
index|]
expr_stmt|;
name|r
operator|=
name|r600_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
name|p
operator|->
name|idx
operator|+=
name|p3reloc
operator|.
name|count
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|p3reloc
operator|.
name|type
operator|!=
name|PACKET_TYPE3
operator|||
name|p3reloc
operator|.
name|opcode
operator|!=
name|PACKET3_NOP
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No packet3 for relocation for packet at %d.\n"
argument_list|,
name|p3reloc
operator|.
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|idx
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|p3reloc
operator|.
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|>=
name|relocs_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Relocs at %d after relocations chunk end %d !\n"
argument_list|,
name|idx
argument_list|,
name|relocs_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* FIXME: we assume reloc size is 4 dwords */
operator|*
name|cs_reloc
operator|=
name|p
operator|->
name|relocs_ptr
index|[
operator|(
name|idx
operator|/
literal|4
operator|)
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * r600_cs_packet_next_reloc_nomm() - parse next packet which should be reloc packet3  * @parser:		parser structure holding parsing context.  * @data:		pointer to relocation data  * @offset_start:	starting offset  * @offset_mask:	offset mask (to align start offset on)  * @reloc:		reloc informations  *  * Check next packet is relocation packet3, do bo validation and compute  * GPU offset using the provided start.  **/
end_comment

begin_function
specifier|static
name|int
name|r600_cs_packet_next_reloc_nomm
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_reloc
modifier|*
modifier|*
name|cs_reloc
parameter_list|)
block|{
name|struct
name|radeon_cs_chunk
modifier|*
name|relocs_chunk
decl_stmt|;
name|struct
name|radeon_cs_packet
name|p3reloc
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|chunk_relocs_idx
operator|==
operator|-
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No relocation chunk !\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
operator|*
name|cs_reloc
operator|=
name|NULL
expr_stmt|;
name|relocs_chunk
operator|=
operator|&
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_relocs_idx
index|]
expr_stmt|;
name|r
operator|=
name|r600_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
name|p
operator|->
name|idx
operator|+=
name|p3reloc
operator|.
name|count
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|p3reloc
operator|.
name|type
operator|!=
name|PACKET_TYPE3
operator|||
name|p3reloc
operator|.
name|opcode
operator|!=
name|PACKET3_NOP
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No packet3 for relocation for packet at %d.\n"
argument_list|,
name|p3reloc
operator|.
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|idx
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|p3reloc
operator|.
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|>=
name|relocs_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Relocs at %d after relocations chunk end %d !\n"
argument_list|,
name|idx
argument_list|,
name|relocs_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
operator|*
name|cs_reloc
operator|=
name|p
operator|->
name|relocs
expr_stmt|;
operator|(
operator|*
name|cs_reloc
operator|)
operator|->
name|lobj
operator|.
name|gpu_offset
operator|=
operator|(
name|u64
operator|)
name|relocs_chunk
operator|->
name|kdata
index|[
name|idx
operator|+
literal|3
index|]
operator|<<
literal|32
expr_stmt|;
operator|(
operator|*
name|cs_reloc
operator|)
operator|->
name|lobj
operator|.
name|gpu_offset
operator||=
name|relocs_chunk
operator|->
name|kdata
index|[
name|idx
operator|+
literal|0
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * r600_cs_packet_next_is_pkt3_nop() - test if next packet is packet3 nop for reloc  * @parser:		parser structure holding parsing context.  *  * Check next packet is relocation packet3, do bo validation and compute  * GPU offset using the provided start.  **/
end_comment

begin_function
specifier|static
name|int
name|r600_cs_packet_next_is_pkt3_nop
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|radeon_cs_packet
name|p3reloc
decl_stmt|;
name|int
name|r
decl_stmt|;
name|r
operator|=
name|r600_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|p3reloc
operator|.
name|type
operator|!=
name|PACKET_TYPE3
operator|||
name|p3reloc
operator|.
name|opcode
operator|!=
name|PACKET3_NOP
condition|)
block|{
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * r600_cs_packet_next_vline() - parse userspace VLINE packet  * @parser:		parser structure holding parsing context.  *  * Userspace sends a special sequence for VLINE waits.  * PACKET0 - VLINE_START_END + value  * PACKET3 - WAIT_REG_MEM poll vline status reg  * RELOC (P3) - crtc_id in reloc.  *  * This function parses this and relocates the VLINE START END  * and WAIT_REG_MEM packets to the correct crtc.  * It also detects a switched off crtc and nulls out the  * wait in that case.  */
end_comment

begin_function
specifier|static
name|int
name|r600_cs_packet_parse_vline
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|drm_mode_object
modifier|*
name|obj
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|struct
name|radeon_cs_packet
name|p3reloc
decl_stmt|,
name|wait_reg_mem
decl_stmt|;
name|int
name|crtc_id
decl_stmt|;
name|int
name|r
decl_stmt|;
name|uint32_t
name|header
decl_stmt|,
name|h_idx
decl_stmt|,
name|reg
decl_stmt|,
name|wait_reg_mem_info
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ib
decl_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
comment|/* parse the WAIT_REG_MEM */
name|r
operator|=
name|r600_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|wait_reg_mem
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* check its a WAIT_REG_MEM */
if|if
condition|(
name|wait_reg_mem
operator|.
name|type
operator|!=
name|PACKET_TYPE3
operator|||
name|wait_reg_mem
operator|.
name|opcode
operator|!=
name|PACKET3_WAIT_REG_MEM
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline wait missing WAIT_REG_MEM segment\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|wait_reg_mem_info
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|wait_reg_mem
operator|.
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* bit 4 is reg (0) or mem (1) */
if|if
condition|(
name|wait_reg_mem_info
operator|&
literal|0x10
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline WAIT_REG_MEM waiting on MEM rather than REG\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* waiting for value to be equal */
if|if
condition|(
operator|(
name|wait_reg_mem_info
operator|&
literal|0x7
operator|)
operator|!=
literal|0x3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline WAIT_REG_MEM function not equal\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|wait_reg_mem
operator|.
name|idx
operator|+
literal|2
argument_list|)
operator|<<
literal|2
operator|)
operator|!=
name|AVIVO_D1MODE_VLINE_STATUS
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline WAIT_REG_MEM bad reg\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|wait_reg_mem
operator|.
name|idx
operator|+
literal|5
argument_list|)
operator|!=
name|AVIVO_D1MODE_VLINE_STAT
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline WAIT_REG_MEM bad bit mask\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* jump over the NOP */
name|r
operator|=
name|r600_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|,
name|p
operator|->
name|idx
operator|+
name|wait_reg_mem
operator|.
name|count
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|h_idx
operator|=
name|p
operator|->
name|idx
operator|-
literal|2
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
name|wait_reg_mem
operator|.
name|count
operator|+
literal|2
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
name|p3reloc
operator|.
name|count
operator|+
literal|2
expr_stmt|;
name|header
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|h_idx
argument_list|)
expr_stmt|;
name|crtc_id
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|h_idx
operator|+
literal|2
operator|+
literal|7
operator|+
literal|1
argument_list|)
expr_stmt|;
name|reg
operator|=
name|CP_PACKET0_GET_REG
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|obj
operator|=
name|drm_mode_object_find
argument_list|(
name|p
operator|->
name|rdev
operator|->
name|ddev
argument_list|,
name|crtc_id
argument_list|,
name|DRM_MODE_OBJECT_CRTC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|obj
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"cannot find crtc %d\n"
argument_list|,
name|crtc_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|crtc
operator|=
name|obj_to_crtc
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
name|crtc_id
operator|=
name|radeon_crtc
operator|->
name|crtc_id
expr_stmt|;
if|if
condition|(
operator|!
name|crtc
operator|->
name|enabled
condition|)
block|{
comment|/* if the CRTC isn't enabled - we need to nop out the WAIT_REG_MEM */
name|ib
index|[
name|h_idx
operator|+
literal|2
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|3
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|4
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|5
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|6
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|7
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|8
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|crtc_id
operator|==
literal|1
condition|)
block|{
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|AVIVO_D1MODE_VLINE_START_END
case|:
name|header
operator|&=
operator|~
name|R600_CP_PACKET0_REG_MASK
expr_stmt|;
name|header
operator||=
name|AVIVO_D2MODE_VLINE_START_END
operator|>>
literal|2
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"unknown crtc reloc\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|h_idx
index|]
operator|=
name|header
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|4
index|]
operator|=
name|AVIVO_D2MODE_VLINE_STATUS
operator|>>
literal|2
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_packet0_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|unsigned
name|idx
parameter_list|,
name|unsigned
name|reg
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|AVIVO_D1MODE_VLINE_START_END
case|:
name|r
operator|=
name|r600_cs_packet_parse_vline
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Forbidden register 0x%04X in cs at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_cs_parse_packet0
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|unsigned
name|reg
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|int
name|r
decl_stmt|;
name|idx
operator|=
name|pkt
operator|->
name|idx
operator|+
literal|1
expr_stmt|;
name|reg
operator|=
name|pkt
operator|->
name|reg
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|pkt
operator|->
name|count
condition|;
name|i
operator|++
operator|,
name|idx
operator|++
operator|,
name|reg
operator|+=
literal|4
control|)
block|{
name|r
operator|=
name|r600_packet0_check
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * r600_cs_check_reg() - check if register is authorized or not  * @parser: parser structure holding parsing context  * @reg: register we are testing  * @idx: index into the cs buffer  *  * This function will test against r600_reg_safe_bm and return 0  * if register is safe. If register is not flag as safe this function  * will test it against a list of register needind special handling.  */
end_comment

begin_function
specifier|static
name|int
name|r600_cs_check_reg
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u32
name|idx
parameter_list|)
block|{
name|struct
name|r600_cs_track
modifier|*
name|track
init|=
operator|(
expr|struct
name|r600_cs_track
operator|*
operator|)
name|p
operator|->
name|track
decl_stmt|;
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|u32
name|m
decl_stmt|,
name|i
decl_stmt|,
name|tmp
decl_stmt|,
modifier|*
name|ib
decl_stmt|;
name|int
name|r
decl_stmt|;
name|i
operator|=
operator|(
name|reg
operator|>>
literal|7
operator|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|DRM_ARRAY_SIZE
argument_list|(
name|r600_reg_safe_bm
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"forbidden register 0x%08x at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|m
operator|=
literal|1
operator|<<
operator|(
operator|(
name|reg
operator|>>
literal|2
operator|)
operator|&
literal|31
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|r600_reg_safe_bm
index|[
name|i
index|]
operator|&
name|m
operator|)
condition|)
return|return
literal|0
return|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
switch|switch
condition|(
name|reg
condition|)
block|{
comment|/* force following reg to 0 in an attempt to disable out buffer 	 * which will need us to better understand how it works to perform 	 * security check on it (Jerome) 	 */
case|case
name|R_0288A8_SQ_ESGS_RING_ITEMSIZE
case|:
case|case
name|R_008C44_SQ_ESGS_RING_SIZE
case|:
case|case
name|R_0288B0_SQ_ESTMP_RING_ITEMSIZE
case|:
case|case
name|R_008C54_SQ_ESTMP_RING_SIZE
case|:
case|case
name|R_0288C0_SQ_FBUF_RING_ITEMSIZE
case|:
case|case
name|R_008C74_SQ_FBUF_RING_SIZE
case|:
case|case
name|R_0288B4_SQ_GSTMP_RING_ITEMSIZE
case|:
case|case
name|R_008C5C_SQ_GSTMP_RING_SIZE
case|:
case|case
name|R_0288AC_SQ_GSVS_RING_ITEMSIZE
case|:
case|case
name|R_008C4C_SQ_GSVS_RING_SIZE
case|:
case|case
name|R_0288BC_SQ_PSTMP_RING_ITEMSIZE
case|:
case|case
name|R_008C6C_SQ_PSTMP_RING_SIZE
case|:
case|case
name|R_0288C4_SQ_REDUC_RING_ITEMSIZE
case|:
case|case
name|R_008C7C_SQ_REDUC_RING_SIZE
case|:
case|case
name|R_0288B8_SQ_VSTMP_RING_ITEMSIZE
case|:
case|case
name|R_008C64_SQ_VSTMP_RING_SIZE
case|:
case|case
name|R_0288C8_SQ_GS_VERT_ITEMSIZE
case|:
comment|/* get value to populate the IB don't remove */
name|tmp
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SQ_CONFIG
case|:
name|track
operator|->
name|sq_config
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_028800_DB_DEPTH_CONTROL
case|:
name|track
operator|->
name|db_depth_control
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_028010_DB_DEPTH_INFO
case|:
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
operator|&&
name|r600_cs_packet_next_is_pkt3_nop
argument_list|(
name|p
argument_list|)
condition|)
block|{
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|db_depth_info
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|&=
name|C_028010_ARRAY_MODE
expr_stmt|;
name|track
operator|->
name|db_depth_info
operator|&=
name|C_028010_ARRAY_MODE
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
block|{
name|ib
index|[
name|idx
index|]
operator||=
name|S_028010_ARRAY_MODE
argument_list|(
name|V_028010_ARRAY_2D_TILED_THIN1
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_depth_info
operator||=
name|S_028010_ARRAY_MODE
argument_list|(
name|V_028010_ARRAY_2D_TILED_THIN1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ib
index|[
name|idx
index|]
operator||=
name|S_028010_ARRAY_MODE
argument_list|(
name|V_028010_ARRAY_1D_TILED_THIN1
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_depth_info
operator||=
name|S_028010_ARRAY_MODE
argument_list|(
name|V_028010_ARRAY_1D_TILED_THIN1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|track
operator|->
name|db_depth_info
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
block|}
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_028004_DB_DEPTH_VIEW
case|:
name|track
operator|->
name|db_depth_view
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_028000_DB_DEPTH_SIZE
case|:
name|track
operator|->
name|db_depth_size
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_depth_size_idx
operator|=
name|idx
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_028AB0_VGT_STRMOUT_EN
case|:
name|track
operator|->
name|vgt_strmout_en
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|streamout_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_028B20_VGT_STRMOUT_BUFFER_EN
case|:
name|track
operator|->
name|vgt_strmout_buffer_en
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|streamout_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|VGT_STRMOUT_BUFFER_BASE_0
case|:
case|case
name|VGT_STRMOUT_BUFFER_BASE_1
case|:
case|case
name|VGT_STRMOUT_BUFFER_BASE_2
case|:
case|case
name|VGT_STRMOUT_BUFFER_BASE_3
case|:
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
operator|(
name|reg
operator|-
name|VGT_STRMOUT_BUFFER_BASE_0
operator|)
operator|/
literal|16
expr_stmt|;
name|track
operator|->
name|vgt_strmout_bo_offset
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|vgt_strmout_bo
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|vgt_strmout_bo_mc
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|track
operator|->
name|streamout_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|VGT_STRMOUT_BUFFER_SIZE_0
case|:
case|case
name|VGT_STRMOUT_BUFFER_SIZE_1
case|:
case|case
name|VGT_STRMOUT_BUFFER_SIZE_2
case|:
case|case
name|VGT_STRMOUT_BUFFER_SIZE_3
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|VGT_STRMOUT_BUFFER_SIZE_0
operator|)
operator|/
literal|16
expr_stmt|;
comment|/* size in register is DWs, convert to bytes */
name|track
operator|->
name|vgt_strmout_size
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|*
literal|4
expr_stmt|;
name|track
operator|->
name|streamout_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CP_COHER_BASE
case|:
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"missing reloc for CP_COHER_BASE "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_028238_CB_TARGET_MASK
case|:
name|track
operator|->
name|cb_target_mask
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_02823C_CB_SHADER_MASK
case|:
name|track
operator|->
name|cb_shader_mask
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
break|break;
case|case
name|R_028C04_PA_SC_AA_CONFIG
case|:
name|tmp
operator|=
name|G_028C04_MSAA_NUM_SAMPLES
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
argument_list|)
expr_stmt|;
name|track
operator|->
name|log_nsamples
operator|=
name|tmp
expr_stmt|;
name|track
operator|->
name|nsamples
operator|=
literal|1
operator|<<
name|tmp
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_028808_CB_COLOR_CONTROL
case|:
name|tmp
operator|=
name|G_028808_SPECIAL_OP
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
argument_list|)
expr_stmt|;
name|track
operator|->
name|is_resolve
operator|=
name|tmp
operator|==
name|V_028808_SPECIAL_RESOLVE_BOX
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_0280A0_CB_COLOR0_INFO
case|:
case|case
name|R_0280A4_CB_COLOR1_INFO
case|:
case|case
name|R_0280A8_CB_COLOR2_INFO
case|:
case|case
name|R_0280AC_CB_COLOR3_INFO
case|:
case|case
name|R_0280B0_CB_COLOR4_INFO
case|:
case|case
name|R_0280B4_CB_COLOR5_INFO
case|:
case|case
name|R_0280B8_CB_COLOR6_INFO
case|:
case|case
name|R_0280BC_CB_COLOR7_INFO
case|:
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
operator|&&
name|r600_cs_packet_next_is_pkt3_nop
argument_list|(
name|p
argument_list|)
condition|)
block|{
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG 0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
operator|(
name|reg
operator|-
name|R_0280A0_CB_COLOR0_INFO
operator|)
operator|/
literal|4
expr_stmt|;
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
block|{
name|ib
index|[
name|idx
index|]
operator||=
name|S_0280A0_ARRAY_MODE
argument_list|(
name|V_0280A0_ARRAY_2D_TILED_THIN1
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
operator||=
name|S_0280A0_ARRAY_MODE
argument_list|(
name|V_0280A0_ARRAY_2D_TILED_THIN1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
block|{
name|ib
index|[
name|idx
index|]
operator||=
name|S_0280A0_ARRAY_MODE
argument_list|(
name|V_0280A0_ARRAY_1D_TILED_THIN1
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
operator||=
name|S_0280A0_ARRAY_MODE
argument_list|(
name|V_0280A0_ARRAY_1D_TILED_THIN1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|tmp
operator|=
operator|(
name|reg
operator|-
name|R_0280A0_CB_COLOR0_INFO
operator|)
operator|/
literal|4
expr_stmt|;
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
block|}
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_028080_CB_COLOR0_VIEW
case|:
case|case
name|R_028084_CB_COLOR1_VIEW
case|:
case|case
name|R_028088_CB_COLOR2_VIEW
case|:
case|case
name|R_02808C_CB_COLOR3_VIEW
case|:
case|case
name|R_028090_CB_COLOR4_VIEW
case|:
case|case
name|R_028094_CB_COLOR5_VIEW
case|:
case|case
name|R_028098_CB_COLOR6_VIEW
case|:
case|case
name|R_02809C_CB_COLOR7_VIEW
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|R_028080_CB_COLOR0_VIEW
operator|)
operator|/
literal|4
expr_stmt|;
name|track
operator|->
name|cb_color_view
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_028060_CB_COLOR0_SIZE
case|:
case|case
name|R_028064_CB_COLOR1_SIZE
case|:
case|case
name|R_028068_CB_COLOR2_SIZE
case|:
case|case
name|R_02806C_CB_COLOR3_SIZE
case|:
case|case
name|R_028070_CB_COLOR4_SIZE
case|:
case|case
name|R_028074_CB_COLOR5_SIZE
case|:
case|case
name|R_028078_CB_COLOR6_SIZE
case|:
case|case
name|R_02807C_CB_COLOR7_SIZE
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|R_028060_CB_COLOR0_SIZE
operator|)
operator|/
literal|4
expr_stmt|;
name|track
operator|->
name|cb_color_size
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_size_idx
index|[
name|tmp
index|]
operator|=
name|idx
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
comment|/* This register were added late, there is userspace 		 * which does provide relocation for those but set 		 * 0 offset. In order to avoid breaking old userspace 		 * we detect this and set address to point to last 		 * CB_COLOR0_BASE, note that if userspace doesn't set 		 * CB_COLOR0_BASE before this register we will report 		 * error. Old userspace always set CB_COLOR0_BASE 		 * before any of this. 		 */
case|case
name|R_0280E0_CB_COLOR0_FRAG
case|:
case|case
name|R_0280E4_CB_COLOR1_FRAG
case|:
case|case
name|R_0280E8_CB_COLOR2_FRAG
case|:
case|case
name|R_0280EC_CB_COLOR3_FRAG
case|:
case|case
name|R_0280F0_CB_COLOR4_FRAG
case|:
case|case
name|R_0280F4_CB_COLOR5_FRAG
case|:
case|case
name|R_0280F8_CB_COLOR6_FRAG
case|:
case|case
name|R_0280FC_CB_COLOR7_FRAG
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|R_0280E0_CB_COLOR0_FRAG
operator|)
operator|/
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|r600_cs_packet_next_is_pkt3_nop
argument_list|(
name|p
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|track
operator|->
name|cb_color_base_last
index|[
name|tmp
index|]
condition|)
block|{
name|dev_err
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"Broken old userspace ? no cb_color0_base supplied before trying to write 0x%08X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|cb_color_frag_bo
index|[
name|tmp
index|]
operator|=
name|track
operator|->
name|cb_color_bo
index|[
name|tmp
index|]
expr_stmt|;
name|track
operator|->
name|cb_color_frag_offset
index|[
name|tmp
index|]
operator|=
name|track
operator|->
name|cb_color_bo_offset
index|[
name|tmp
index|]
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|track
operator|->
name|cb_color_base_last
index|[
name|tmp
index|]
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG 0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|cb_color_frag_bo
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|cb_color_frag_offset
index|[
name|tmp
index|]
operator|=
operator|(
name|u64
operator|)
name|ib
index|[
name|idx
index|]
operator|<<
literal|8
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|G_0280A0_TILE_MODE
argument_list|(
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
argument_list|)
condition|)
block|{
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|R_0280C0_CB_COLOR0_TILE
case|:
case|case
name|R_0280C4_CB_COLOR1_TILE
case|:
case|case
name|R_0280C8_CB_COLOR2_TILE
case|:
case|case
name|R_0280CC_CB_COLOR3_TILE
case|:
case|case
name|R_0280D0_CB_COLOR4_TILE
case|:
case|case
name|R_0280D4_CB_COLOR5_TILE
case|:
case|case
name|R_0280D8_CB_COLOR6_TILE
case|:
case|case
name|R_0280DC_CB_COLOR7_TILE
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|R_0280C0_CB_COLOR0_TILE
operator|)
operator|/
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|r600_cs_packet_next_is_pkt3_nop
argument_list|(
name|p
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|track
operator|->
name|cb_color_base_last
index|[
name|tmp
index|]
condition|)
block|{
name|dev_err
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"Broken old userspace ? no cb_color0_base supplied before trying to write 0x%08X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|cb_color_tile_bo
index|[
name|tmp
index|]
operator|=
name|track
operator|->
name|cb_color_bo
index|[
name|tmp
index|]
expr_stmt|;
name|track
operator|->
name|cb_color_tile_offset
index|[
name|tmp
index|]
operator|=
name|track
operator|->
name|cb_color_bo_offset
index|[
name|tmp
index|]
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|track
operator|->
name|cb_color_base_last
index|[
name|tmp
index|]
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG 0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|cb_color_tile_bo
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|cb_color_tile_offset
index|[
name|tmp
index|]
operator|=
operator|(
name|u64
operator|)
name|ib
index|[
name|idx
index|]
operator|<<
literal|8
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|G_0280A0_TILE_MODE
argument_list|(
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
argument_list|)
condition|)
block|{
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|R_028100_CB_COLOR0_MASK
case|:
case|case
name|R_028104_CB_COLOR1_MASK
case|:
case|case
name|R_028108_CB_COLOR2_MASK
case|:
case|case
name|R_02810C_CB_COLOR3_MASK
case|:
case|case
name|R_028110_CB_COLOR4_MASK
case|:
case|case
name|R_028114_CB_COLOR5_MASK
case|:
case|case
name|R_028118_CB_COLOR6_MASK
case|:
case|case
name|R_02811C_CB_COLOR7_MASK
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|R_028100_CB_COLOR0_MASK
operator|)
operator|/
literal|4
expr_stmt|;
name|track
operator|->
name|cb_color_mask
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|G_0280A0_TILE_MODE
argument_list|(
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
argument_list|)
condition|)
block|{
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|CB_COLOR0_BASE
case|:
case|case
name|CB_COLOR1_BASE
case|:
case|case
name|CB_COLOR2_BASE
case|:
case|case
name|CB_COLOR3_BASE
case|:
case|case
name|CB_COLOR4_BASE
case|:
case|case
name|CB_COLOR5_BASE
case|:
case|case
name|CB_COLOR6_BASE
case|:
case|case
name|CB_COLOR7_BASE
case|:
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
operator|(
name|reg
operator|-
name|CB_COLOR0_BASE
operator|)
operator|/
literal|4
expr_stmt|;
name|track
operator|->
name|cb_color_bo_offset
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_base_last
index|[
name|tmp
index|]
operator|=
name|ib
index|[
name|idx
index|]
expr_stmt|;
name|track
operator|->
name|cb_color_bo
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|cb_color_bo_mc
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_DEPTH_BASE
case|:
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|db_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_bo
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|db_bo_mc
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_HTILE_DATA_BASE
case|:
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|htile_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|htile_bo
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_HTILE_SURFACE
case|:
name|track
operator|->
name|htile_surface
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
comment|/* force 8x8 htile width and height */
name|ib
index|[
name|idx
index|]
operator||=
literal|3
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|SQ_PGM_START_FS
case|:
case|case
name|SQ_PGM_START_ES
case|:
case|case
name|SQ_PGM_START_VS
case|:
case|case
name|SQ_PGM_START_GS
case|:
case|case
name|SQ_PGM_START_PS
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_0
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_1
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_2
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_3
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_4
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_5
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_6
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_7
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_8
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_9
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_10
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_11
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_12
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_13
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_14
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_15
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_0
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_1
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_2
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_3
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_4
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_5
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_6
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_7
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_8
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_9
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_10
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_11
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_12
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_13
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_14
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_15
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_0
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_1
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_2
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_3
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_4
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_5
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_6
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_7
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_8
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_9
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_10
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_11
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_12
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_13
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_14
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_15
case|:
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
break|break;
case|case
name|SX_MEMORY_EXPORT_BASE
case|:
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONFIG_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
break|break;
case|case
name|SX_MISC
case|:
name|track
operator|->
name|sx_misc_kill_all_prims
operator|=
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|&
literal|0x1
operator|)
operator|!=
literal|0
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"forbidden register 0x%08x at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|unsigned
name|r600_mip_minify
parameter_list|(
name|unsigned
name|size
parameter_list|,
name|unsigned
name|level
parameter_list|)
block|{
name|unsigned
name|val
decl_stmt|;
name|val
operator|=
name|max
argument_list|(
literal|1U
argument_list|,
name|size
operator|>>
name|level
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|>
literal|0
condition|)
name|val
operator|=
name|roundup_pow_of_two
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_texture_size
parameter_list|(
name|unsigned
name|nfaces
parameter_list|,
name|unsigned
name|blevel
parameter_list|,
name|unsigned
name|llevel
parameter_list|,
name|unsigned
name|w0
parameter_list|,
name|unsigned
name|h0
parameter_list|,
name|unsigned
name|d0
parameter_list|,
name|unsigned
name|nsamples
parameter_list|,
name|unsigned
name|format
parameter_list|,
name|unsigned
name|block_align
parameter_list|,
name|unsigned
name|height_align
parameter_list|,
name|unsigned
name|base_align
parameter_list|,
name|unsigned
modifier|*
name|l0_size
parameter_list|,
name|unsigned
modifier|*
name|mipmap_size
parameter_list|)
block|{
name|unsigned
name|offset
decl_stmt|,
name|i
decl_stmt|,
name|level
decl_stmt|;
name|unsigned
name|width
decl_stmt|,
name|height
decl_stmt|,
name|depth
decl_stmt|,
name|size
decl_stmt|;
name|unsigned
name|blocksize
decl_stmt|;
name|unsigned
name|nbx
decl_stmt|,
name|nby
decl_stmt|;
name|unsigned
name|nlevels
init|=
name|llevel
operator|-
name|blevel
operator|+
literal|1
decl_stmt|;
operator|*
name|l0_size
operator|=
operator|-
literal|1
expr_stmt|;
name|blocksize
operator|=
name|r600_fmt_get_blocksize
argument_list|(
name|format
argument_list|)
expr_stmt|;
name|w0
operator|=
name|r600_mip_minify
argument_list|(
name|w0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|h0
operator|=
name|r600_mip_minify
argument_list|(
name|h0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|d0
operator|=
name|r600_mip_minify
argument_list|(
name|d0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|offset
operator|=
literal|0
operator|,
name|level
operator|=
name|blevel
init|;
name|i
operator|<
name|nlevels
condition|;
name|i
operator|++
operator|,
name|level
operator|++
control|)
block|{
name|width
operator|=
name|r600_mip_minify
argument_list|(
name|w0
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|nbx
operator|=
name|r600_fmt_get_nblocksx
argument_list|(
name|format
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|nbx
operator|=
name|roundup
argument_list|(
name|nbx
argument_list|,
name|block_align
argument_list|)
expr_stmt|;
name|height
operator|=
name|r600_mip_minify
argument_list|(
name|h0
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|nby
operator|=
name|r600_fmt_get_nblocksy
argument_list|(
name|format
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|nby
operator|=
name|roundup
argument_list|(
name|nby
argument_list|,
name|height_align
argument_list|)
expr_stmt|;
name|depth
operator|=
name|r600_mip_minify
argument_list|(
name|d0
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|size
operator|=
name|nbx
operator|*
name|nby
operator|*
name|blocksize
operator|*
name|nsamples
expr_stmt|;
if|if
condition|(
name|nfaces
condition|)
name|size
operator|*=
name|nfaces
expr_stmt|;
else|else
name|size
operator|*=
name|depth
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
operator|*
name|l0_size
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
operator|||
name|i
operator|==
literal|1
condition|)
name|offset
operator|=
name|roundup
argument_list|(
name|offset
argument_list|,
name|base_align
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|size
expr_stmt|;
block|}
operator|*
name|mipmap_size
operator|=
name|offset
expr_stmt|;
if|if
condition|(
name|llevel
operator|==
literal|0
condition|)
operator|*
name|mipmap_size
operator|=
operator|*
name|l0_size
expr_stmt|;
if|if
condition|(
operator|!
name|blevel
condition|)
operator|*
name|mipmap_size
operator|-=
operator|*
name|l0_size
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * r600_check_texture_resource() - check if register is authorized or not  * @p: parser structure holding parsing context  * @idx: index into the cs buffer  * @texture: texture's bo structure  * @mipmap: mipmap's bo structure  *  * This function will check that the resource has valid field and that  * the texture and mipmap bo object are big enough to cover this resource.  */
end_comment

begin_function
specifier|static
name|int
name|r600_check_texture_resource
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|u32
name|idx
parameter_list|,
name|struct
name|radeon_bo
modifier|*
name|texture
parameter_list|,
name|struct
name|radeon_bo
modifier|*
name|mipmap
parameter_list|,
name|u64
name|base_offset
parameter_list|,
name|u64
name|mip_offset
parameter_list|,
name|u32
name|tiling_flags
parameter_list|)
block|{
name|struct
name|r600_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|u32
name|dim
decl_stmt|,
name|nfaces
decl_stmt|,
name|llevel
decl_stmt|,
name|blevel
decl_stmt|,
name|w0
decl_stmt|,
name|h0
decl_stmt|,
name|d0
decl_stmt|;
name|u32
name|word0
decl_stmt|,
name|word1
decl_stmt|,
name|l0_size
decl_stmt|,
name|mipmap_size
decl_stmt|,
name|word2
decl_stmt|,
name|word3
decl_stmt|,
name|word4
decl_stmt|,
name|word5
decl_stmt|;
name|u32
name|height_align
decl_stmt|,
name|pitch
decl_stmt|,
name|pitch_align
decl_stmt|,
name|depth_align
decl_stmt|;
name|u32
name|barray
decl_stmt|,
name|larray
decl_stmt|;
name|u64
name|base_align
decl_stmt|;
name|struct
name|array_mode_checker
name|array_check
decl_stmt|;
name|u32
name|format
decl_stmt|;
name|bool
name|is_array
decl_stmt|;
comment|/* on legacy kernel we don't perform advanced check */
if|if
condition|(
name|p
operator|->
name|rdev
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* convert to bytes */
name|base_offset
operator|<<=
literal|8
expr_stmt|;
name|mip_offset
operator|<<=
literal|8
expr_stmt|;
name|word0
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|word0
operator||=
name|S_038000_TILE_MODE
argument_list|(
name|V_038000_ARRAY_2D_TILED_THIN1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|word0
operator||=
name|S_038000_TILE_MODE
argument_list|(
name|V_038000_ARRAY_1D_TILED_THIN1
argument_list|)
expr_stmt|;
block|}
name|word1
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|word2
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|word3
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|word4
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
expr_stmt|;
name|word5
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|5
argument_list|)
expr_stmt|;
name|dim
operator|=
name|G_038000_DIM
argument_list|(
name|word0
argument_list|)
expr_stmt|;
name|w0
operator|=
name|G_038000_TEX_WIDTH
argument_list|(
name|word0
argument_list|)
operator|+
literal|1
expr_stmt|;
name|pitch
operator|=
operator|(
name|G_038000_PITCH
argument_list|(
name|word0
argument_list|)
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|h0
operator|=
name|G_038004_TEX_HEIGHT
argument_list|(
name|word1
argument_list|)
operator|+
literal|1
expr_stmt|;
name|d0
operator|=
name|G_038004_TEX_DEPTH
argument_list|(
name|word1
argument_list|)
expr_stmt|;
name|format
operator|=
name|G_038004_DATA_FORMAT
argument_list|(
name|word1
argument_list|)
expr_stmt|;
name|blevel
operator|=
name|G_038010_BASE_LEVEL
argument_list|(
name|word4
argument_list|)
expr_stmt|;
name|llevel
operator|=
name|G_038014_LAST_LEVEL
argument_list|(
name|word5
argument_list|)
expr_stmt|;
comment|/* pitch in texels */
name|array_check
operator|.
name|array_mode
operator|=
name|G_038000_TILE_MODE
argument_list|(
name|word0
argument_list|)
expr_stmt|;
name|array_check
operator|.
name|group_size
operator|=
name|track
operator|->
name|group_size
expr_stmt|;
name|array_check
operator|.
name|nbanks
operator|=
name|track
operator|->
name|nbanks
expr_stmt|;
name|array_check
operator|.
name|npipes
operator|=
name|track
operator|->
name|npipes
expr_stmt|;
name|array_check
operator|.
name|nsamples
operator|=
literal|1
expr_stmt|;
name|array_check
operator|.
name|blocksize
operator|=
name|r600_fmt_get_blocksize
argument_list|(
name|format
argument_list|)
expr_stmt|;
name|nfaces
operator|=
literal|1
expr_stmt|;
name|is_array
operator|=
name|false
expr_stmt|;
switch|switch
condition|(
name|dim
condition|)
block|{
case|case
name|V_038000_SQ_TEX_DIM_1D
case|:
case|case
name|V_038000_SQ_TEX_DIM_2D
case|:
case|case
name|V_038000_SQ_TEX_DIM_3D
case|:
break|break;
case|case
name|V_038000_SQ_TEX_DIM_CUBEMAP
case|:
if|if
condition|(
name|p
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
name|nfaces
operator|=
literal|8
expr_stmt|;
else|else
name|nfaces
operator|=
literal|6
expr_stmt|;
break|break;
case|case
name|V_038000_SQ_TEX_DIM_1D_ARRAY
case|:
case|case
name|V_038000_SQ_TEX_DIM_2D_ARRAY
case|:
name|is_array
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|V_038000_SQ_TEX_DIM_2D_ARRAY_MSAA
case|:
name|is_array
operator|=
name|true
expr_stmt|;
comment|/* fall through */
case|case
name|V_038000_SQ_TEX_DIM_2D_MSAA
case|:
name|array_check
operator|.
name|nsamples
operator|=
literal|1
operator|<<
name|llevel
expr_stmt|;
name|llevel
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"this kernel doesn't support %d texture dim\n"
argument_list|,
name|G_038000_DIM
argument_list|(
name|word0
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|r600_fmt_is_valid_texture
argument_list|(
name|format
argument_list|,
name|p
operator|->
name|family
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d texture invalid format %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|format
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|r600_get_array_mode_alignment
argument_list|(
operator|&
name|array_check
argument_list|,
operator|&
name|pitch_align
argument_list|,
operator|&
name|height_align
argument_list|,
operator|&
name|depth_align
argument_list|,
operator|&
name|base_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d tex array mode (%d) invalid\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|G_038000_TILE_MODE
argument_list|(
name|word0
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* XXX check height as well... */
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|pitch
argument_list|,
name|pitch_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d tex pitch (%d, 0x%x, %d) invalid\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|pitch
argument_list|,
name|pitch_align
argument_list|,
name|G_038000_TILE_MODE
argument_list|(
name|word0
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|base_offset
argument_list|,
name|base_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d tex base offset (0x%jx, 0x%jx, %d) invalid\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|uintmax_t
operator|)
name|base_offset
argument_list|,
operator|(
name|uintmax_t
operator|)
name|base_align
argument_list|,
name|G_038000_TILE_MODE
argument_list|(
name|word0
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|mip_offset
argument_list|,
name|base_align
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d tex mip offset (0x%jx, 0x%jx, %d) invalid\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mip_offset
argument_list|,
operator|(
name|uintmax_t
operator|)
name|base_align
argument_list|,
name|G_038000_TILE_MODE
argument_list|(
name|word0
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|blevel
operator|>
name|llevel
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"texture blevel %d> llevel %d\n"
argument_list|,
name|blevel
argument_list|,
name|llevel
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|is_array
condition|)
block|{
name|barray
operator|=
name|G_038014_BASE_ARRAY
argument_list|(
name|word5
argument_list|)
expr_stmt|;
name|larray
operator|=
name|G_038014_LAST_ARRAY
argument_list|(
name|word5
argument_list|)
expr_stmt|;
name|nfaces
operator|=
name|larray
operator|-
name|barray
operator|+
literal|1
expr_stmt|;
block|}
name|r600_texture_size
argument_list|(
name|nfaces
argument_list|,
name|blevel
argument_list|,
name|llevel
argument_list|,
name|w0
argument_list|,
name|h0
argument_list|,
name|d0
argument_list|,
name|array_check
operator|.
name|nsamples
argument_list|,
name|format
argument_list|,
name|pitch_align
argument_list|,
name|height_align
argument_list|,
name|base_align
argument_list|,
operator|&
name|l0_size
argument_list|,
operator|&
name|mipmap_size
argument_list|)
expr_stmt|;
comment|/* using get ib will give us the offset into the texture bo */
if|if
condition|(
operator|(
name|l0_size
operator|+
name|word2
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|texture
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"texture bo too small ((%d %d) (%d %d) %d %d %d -> %d have %ld)\n"
argument_list|,
name|w0
argument_list|,
name|h0
argument_list|,
name|pitch_align
argument_list|,
name|height_align
argument_list|,
name|array_check
operator|.
name|array_mode
argument_list|,
name|format
argument_list|,
name|word2
argument_list|,
name|l0_size
argument_list|,
name|radeon_bo_size
argument_list|(
name|texture
argument_list|)
argument_list|)
expr_stmt|;
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"alignments %d %d %d %jd\n"
argument_list|,
name|pitch
argument_list|,
name|pitch_align
argument_list|,
name|height_align
argument_list|,
operator|(
name|uintmax_t
operator|)
name|base_align
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* using get ib will give us the offset into the mipmap bo */
if|if
condition|(
operator|(
name|mipmap_size
operator|+
name|word3
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|mipmap
argument_list|)
condition|)
block|{
comment|/*dev_warn(p->dev, "mipmap bo too small (%d %d %d %d %d %d -> %d have %ld)\n", 		  w0, h0, format, blevel, nlevels, word3, mipmap_size, radeon_bo_size(texture));*/
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|r600_is_safe_reg
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u32
name|idx
parameter_list|)
block|{
name|u32
name|m
decl_stmt|,
name|i
decl_stmt|;
name|i
operator|=
operator|(
name|reg
operator|>>
literal|7
operator|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|DRM_ARRAY_SIZE
argument_list|(
name|r600_reg_safe_bm
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"forbidden register 0x%08x at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|m
operator|=
literal|1
operator|<<
operator|(
operator|(
name|reg
operator|>>
literal|2
operator|)
operator|&
literal|31
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|r600_reg_safe_bm
index|[
name|i
index|]
operator|&
name|m
operator|)
condition|)
return|return
name|true
return|;
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"forbidden register 0x%08x at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_packet3_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|struct
name|r600_cs_track
modifier|*
name|track
decl_stmt|;
specifier|volatile
name|u32
modifier|*
name|ib
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|unsigned
name|start_reg
decl_stmt|,
name|end_reg
decl_stmt|,
name|reg
decl_stmt|;
name|int
name|r
decl_stmt|;
name|u32
name|idx_value
decl_stmt|;
name|track
operator|=
operator|(
expr|struct
name|r600_cs_track
operator|*
operator|)
name|p
operator|->
name|track
expr_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
name|idx
operator|=
name|pkt
operator|->
name|idx
operator|+
literal|1
expr_stmt|;
name|idx_value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|opcode
condition|)
block|{
case|case
name|PACKET3_SET_PREDICATION
case|:
block|{
name|int
name|pred_op
decl_stmt|;
name|int
name|tmp
decl_stmt|;
name|uint64_t
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET PREDICATION\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|pred_op
operator|=
operator|(
name|tmp
operator|>>
literal|16
operator|)
operator|&
literal|0x7
expr_stmt|;
comment|/* for the clear predicate operation */
if|if
condition|(
name|pred_op
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|pred_op
operator|>
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET PREDICATION operation %d\n"
argument_list|,
name|pred_op
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET PREDICATION\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
operator|(
name|idx_value
operator|&
literal|0xfffffff0
operator|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|tmp
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|0
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
operator|(
name|tmp
operator|&
literal|0xffffff00
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_START_3D_CMDBUF
case|:
if|if
condition|(
name|p
operator|->
name|family
operator|>=
name|CHIP_RV770
operator|||
name|pkt
operator|->
name|count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad START_3D\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_CONTEXT_CONTROL
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad CONTEXT_CONTROL\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_INDEX_TYPE
case|:
case|case
name|PACKET3_NUM_INSTANCES
case|:
if|if
condition|(
name|pkt
operator|->
name|count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad INDEX_TYPE/NUM_INSTANCES\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_DRAW_INDEX
case|:
block|{
name|uint64_t
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
name|idx_value
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|0
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|r
operator|=
name|r600_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
block|}
case|case
name|PACKET3_DRAW_INDEX_AUTO
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_AUTO\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_DRAW_INDEX_IMMD_BE
case|:
case|case
name|PACKET3_DRAW_INDEX_IMMD
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|<
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_IMMD\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_WAIT_REG_MEM
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|5
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad WAIT_REG_MEM\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* bit 4 is reg (0) or mem (1) */
if|if
condition|(
name|idx_value
operator|&
literal|0x10
condition|)
block|{
name|uint64_t
name|offset
decl_stmt|;
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad WAIT_REG_MEM\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xfffffff0
operator|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
operator|(
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|&
literal|0x3
operator|)
operator||
operator|(
name|offset
operator|&
literal|0xfffffff0
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_CP_DMA
case|:
block|{
name|u32
name|command
decl_stmt|,
name|size
decl_stmt|;
name|u64
name|offset
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad CP DMA\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|command
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
expr_stmt|;
name|size
operator|=
name|command
operator|&
literal|0x1fffff
expr_stmt|;
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_SAS
condition|)
block|{
comment|/* src address space is register */
name|DRM_ERROR
argument_list|(
literal|"CP DMA SAS not supported\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_SAIC
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA SAIC only supported for registers\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* src address space is memory */
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad CP DMA SRC\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
name|tmp
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|+
name|size
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"CP DMA src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|tmp
operator|+
name|size
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
operator|(
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|&
literal|0xffffff00
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_DAS
condition|)
block|{
comment|/* dst address space is register */
name|DRM_ERROR
argument_list|(
literal|"CP DMA DAS not supported\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
comment|/* dst address space is memory */
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_DAIC
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA DAIC only supported for registers\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad CP DMA DST\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
name|tmp
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|+
name|size
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"CP DMA dst buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|tmp
operator|+
name|size
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
break|break;
block|}
case|case
name|PACKET3_SURFACE_SYNC
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SURFACE_SYNC\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* 0xffffffff/0x0 is flush all cache flag */
if|if
condition|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|!=
literal|0xffffffff
operator|||
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SURFACE_SYNC\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_EVENT_WRITE
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|2
operator|&&
name|pkt
operator|->
name|count
operator|!=
literal|0
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|pkt
operator|->
name|count
condition|)
block|{
name|uint64_t
name|offset
decl_stmt|;
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xfffffff8
operator|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|offset
operator|&
literal|0xfffffff8
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_EVENT_WRITE_EOP
case|:
block|{
name|uint64_t
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE_EOP\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xfffffffc
operator|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|offset
operator|&
literal|0xfffffffc
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
operator|(
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|&
literal|0xffffff00
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
break|break;
block|}
case|case
name|PACKET3_SET_CONFIG_REG
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_CONFIG_REG_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_CONFIG_REG_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_CONFIG_REG_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_CONFIG_REG_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad PACKET3_SET_CONFIG_REG\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pkt
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
name|r
operator|=
name|r600_cs_check_reg
argument_list|(
name|p
argument_list|,
name|reg
argument_list|,
name|idx
operator|+
literal|1
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_SET_CONTEXT_REG
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_CONTEXT_REG_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_CONTEXT_REG_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_CONTEXT_REG_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_CONTEXT_REG_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad PACKET3_SET_CONTEXT_REG\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pkt
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
name|r
operator|=
name|r600_cs_check_reg
argument_list|(
name|p
argument_list|,
name|reg
argument_list|,
name|idx
operator|+
literal|1
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_SET_RESOURCE
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|%
literal|7
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_RESOURCE_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_RESOURCE_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_RESOURCE_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_RESOURCE_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|pkt
operator|->
name|count
operator|/
literal|7
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|radeon_bo
modifier|*
name|texture
decl_stmt|,
modifier|*
name|mipmap
decl_stmt|;
name|u32
name|size
decl_stmt|,
name|offset
decl_stmt|,
name|base_offset
decl_stmt|,
name|mip_offset
decl_stmt|;
switch|switch
condition|(
name|G__SQ_VTX_CONSTANT_TYPE
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|6
operator|+
literal|1
argument_list|)
argument_list|)
condition|)
block|{
case|case
name|SQ_TEX_VTX_VALID_TEXTURE
case|:
comment|/* tex base */
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|base_offset
operator|=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|0
index|]
operator||=
name|S_038000_TILE_MODE
argument_list|(
name|V_038000_ARRAY_2D_TILED_THIN1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|0
index|]
operator||=
name|S_038000_TILE_MODE
argument_list|(
name|V_038000_ARRAY_1D_TILED_THIN1
argument_list|)
expr_stmt|;
block|}
name|texture
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
comment|/* tex mip base */
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|mip_offset
operator|=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|mipmap
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|r
operator|=
name|r600_check_texture_resource
argument_list|(
name|p
argument_list|,
name|idx
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|1
argument_list|,
name|texture
argument_list|,
name|mipmap
argument_list|,
name|base_offset
operator|+
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|2
argument_list|)
argument_list|,
name|mip_offset
operator|+
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|3
argument_list|)
argument_list|,
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|2
index|]
operator|+=
name|base_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|3
index|]
operator|+=
name|mip_offset
expr_stmt|;
break|break;
case|case
name|SQ_TEX_VTX_VALID_BUFFER
case|:
block|{
name|uint64_t
name|offset64
decl_stmt|;
comment|/* vtx base */
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|0
argument_list|)
expr_stmt|;
name|size
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|1
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|&&
operator|(
name|size
operator|+
name|offset
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
comment|/* force size to size of the buffer */
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"vbo resource seems too big (%d) for the bo (%ld)\n"
argument_list|,
name|size
operator|+
name|offset
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|1
index|]
operator|=
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
operator|-
name|offset
expr_stmt|;
block|}
name|offset64
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|0
index|]
operator|=
name|offset64
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|2
index|]
operator|=
operator|(
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|2
index|]
operator|&
literal|0xffffff00
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|offset64
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
break|break;
block|}
case|case
name|SQ_TEX_VTX_INVALID_TEXTURE
case|:
case|case
name|SQ_TEX_VTX_INVALID_BUFFER
case|:
default|default:
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
break|break;
case|case
name|PACKET3_SET_ALU_CONST
case|:
if|if
condition|(
name|track
operator|->
name|sq_config
operator|&
name|DX9_CONSTS
condition|)
block|{
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_ALU_CONST_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_ALU_CONST_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_ALU_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_ALU_CONST_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_ALU_CONST\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
break|break;
case|case
name|PACKET3_SET_BOOL_CONST
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_BOOL_CONST_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_BOOL_CONST_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_BOOL_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_BOOL_CONST_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_BOOL_CONST\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_SET_LOOP_CONST
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_LOOP_CONST_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_LOOP_CONST_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_LOOP_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_LOOP_CONST_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_LOOP_CONST\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_SET_CTL_CONST
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_CTL_CONST_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_CTL_CONST_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_CTL_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_CTL_CONST_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_CTL_CONST\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_SET_SAMPLER
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|%
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_SAMPLER\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_SAMPLER_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_SAMPLER_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_SAMPLER_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_SAMPLER_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_SAMPLER\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_STRMOUT_BASE_UPDATE
case|:
comment|/* RS780 and RS880 also need this */
if|if
condition|(
name|p
operator|->
name|family
operator|<
name|CHIP_RS780
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"STRMOUT_BASE_UPDATE only supported on 7xx\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BASE_UPDATE packet count\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|idx_value
operator|>
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BASE_UPDATE index\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|{
name|u64
name|offset
decl_stmt|;
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BASE_UPDATE reloc\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|reloc
operator|->
name|robj
operator|!=
name|track
operator|->
name|vgt_strmout_bo
index|[
name|idx_value
index|]
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BASE_UPDATE, bo does not match\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|offset
operator|!=
name|track
operator|->
name|vgt_strmout_bo_offset
index|[
name|idx_value
index|]
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BASE_UPDATE, bo offset does not match: 0x%jx, 0x%x\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
argument_list|,
name|track
operator|->
name|vgt_strmout_bo_offset
index|[
name|idx_value
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|offset
operator|+
literal|4
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BASE_UPDATE bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|4
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_SURFACE_BASE_UPDATE
case|:
if|if
condition|(
name|p
operator|->
name|family
operator|>=
name|CHIP_RV770
operator|||
name|p
operator|->
name|family
operator|==
name|CHIP_R600
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SURFACE_BASE_UPDATE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|pkt
operator|->
name|count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SURFACE_BASE_UPDATE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_STRMOUT_BUFFER_UPDATE
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BUFFER_UPDATE (invalid count)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Updating memory at DST_ADDRESS. */
if|if
condition|(
name|idx_value
operator|&
literal|0x1
condition|)
block|{
name|u64
name|offset
decl_stmt|;
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BUFFER_UPDATE (missing dst reloc)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|offset
operator|+
literal|4
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BUFFER_UPDATE dst bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|4
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
comment|/* Reading data from SRC_ADDRESS. */
if|if
condition|(
operator|(
operator|(
name|idx_value
operator|>>
literal|1
operator|)
operator|&
literal|0x3
operator|)
operator|==
literal|2
condition|)
block|{
name|u64
name|offset
decl_stmt|;
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BUFFER_UPDATE (missing src reloc)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|offset
operator|+
literal|4
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BUFFER_UPDATE src bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|4
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|4
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_MEM_WRITE
case|:
block|{
name|u64
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad MEM_WRITE (invalid count)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad MEM_WRITE (missing reloc)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|0
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32UL
expr_stmt|;
if|if
condition|(
name|offset
operator|&
literal|0x7
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad MEM_WRITE (address not qwords aligned)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|offset
operator|+
literal|8
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad MEM_WRITE bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|8
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|0
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
break|break;
block|}
case|case
name|PACKET3_COPY_DW
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad COPY_DW (invalid count)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|idx_value
operator|&
literal|0x1
condition|)
block|{
name|u64
name|offset
decl_stmt|;
comment|/* SRC is memory. */
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad COPY_DW (missing src reloc)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|offset
operator|+
literal|4
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad COPY_DW src bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|4
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
comment|/* SRC is a reg. */
name|reg
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|r600_is_safe_reg
argument_list|(
name|p
argument_list|,
name|reg
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|idx_value
operator|&
literal|0x2
condition|)
block|{
name|u64
name|offset
decl_stmt|;
comment|/* DST is memory. */
name|r
operator|=
name|r600_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad COPY_DW (missing dst reloc)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|offset
operator|+
literal|4
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad COPY_DW dst bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|4
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|4
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
comment|/* DST is a reg. */
name|reg
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|r600_is_safe_reg
argument_list|(
name|p
argument_list|,
name|reg
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_NOP
case|:
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Packet3 opcode %x not supported\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r600_cs_parse
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|radeon_cs_packet
name|pkt
decl_stmt|;
name|struct
name|r600_cs_track
modifier|*
name|track
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|track
operator|==
name|NULL
condition|)
block|{
comment|/* initialize tracker, we are in kms */
name|track
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|track
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|track
operator|==
name|NULL
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|r600_cs_track_init
argument_list|(
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<
name|CHIP_RV770
condition|)
block|{
name|track
operator|->
name|npipes
operator|=
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|tiling_npipes
expr_stmt|;
name|track
operator|->
name|nbanks
operator|=
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|tiling_nbanks
expr_stmt|;
name|track
operator|->
name|group_size
operator|=
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|tiling_group_size
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RV740
condition|)
block|{
name|track
operator|->
name|npipes
operator|=
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|tiling_npipes
expr_stmt|;
name|track
operator|->
name|nbanks
operator|=
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|tiling_nbanks
expr_stmt|;
name|track
operator|->
name|group_size
operator|=
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|tiling_group_size
expr_stmt|;
block|}
name|p
operator|->
name|track
operator|=
name|track
expr_stmt|;
block|}
do|do
block|{
name|r
operator|=
name|r600_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
name|r
return|;
block|}
name|p
operator|->
name|idx
operator|+=
name|pkt
operator|.
name|count
operator|+
literal|2
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|.
name|type
condition|)
block|{
case|case
name|PACKET_TYPE0
case|:
name|r
operator|=
name|r600_cs_parse_packet0
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|)
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE2
case|:
break|break;
case|case
name|PACKET_TYPE3
case|:
name|r
operator|=
name|r600_packet3_check
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet type %d !\n"
argument_list|,
name|pkt
operator|.
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|r
condition|)
block|{
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
do|while
condition|(
name|p
operator|->
name|idx
operator|<
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
operator|.
name|length_dw
condition|)
do|;
if|#
directive|if
literal|0
block|for (r = 0; r< p->ib.length_dw; r++) { 		DRM_INFO("%05d  0x%08X\n", r, p->ib.ptr[r]); 		DRM_MDELAY(1); 	}
endif|#
directive|endif
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_cs_parser_relocs_legacy
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
name|p
operator|->
name|chunk_relocs_idx
operator|==
operator|-
literal|1
condition|)
block|{
return|return
literal|0
return|;
block|}
name|p
operator|->
name|relocs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_cs_reloc
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|relocs
operator|==
name|NULL
condition|)
block|{
return|return
operator|-
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * cs_parser_fini() - clean parser states  * @parser:	parser structure holding parsing context.  * @error:	error number  *  * If error is set than unvalidate buffer, otherwise just free memory  * used by parsing context.  **/
end_comment

begin_function
specifier|static
name|void
name|r600_cs_parser_fini
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|parser
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|free
argument_list|(
name|parser
operator|->
name|relocs
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|parser
operator|->
name|nchunks
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|parser
operator|->
name|chunks
index|[
name|i
index|]
operator|.
name|kdata
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
name|parser
operator|->
name|rdev
operator|&&
operator|(
name|parser
operator|->
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
condition|)
block|{
name|free
argument_list|(
name|parser
operator|->
name|chunks
index|[
name|i
index|]
operator|.
name|kpage
index|[
literal|0
index|]
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|parser
operator|->
name|chunks
index|[
name|i
index|]
operator|.
name|kpage
index|[
literal|1
index|]
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|parser
operator|->
name|chunks
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|parser
operator|->
name|chunks_array
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|parser
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_cs_legacy
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|filp
parameter_list|,
name|unsigned
name|family
parameter_list|,
name|u32
modifier|*
name|ib
parameter_list|,
name|int
modifier|*
name|l
parameter_list|)
block|{
name|struct
name|radeon_cs_parser
name|parser
decl_stmt|;
name|struct
name|radeon_cs_chunk
modifier|*
name|ib_chunk
decl_stmt|;
name|struct
name|r600_cs_track
modifier|*
name|track
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* initialize tracker */
name|track
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|track
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|track
operator|==
name|NULL
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|r600_cs_track_init
argument_list|(
name|track
argument_list|)
expr_stmt|;
name|r600_cs_legacy_get_tiling_conf
argument_list|(
name|dev
argument_list|,
operator|&
name|track
operator|->
name|npipes
argument_list|,
operator|&
name|track
operator|->
name|nbanks
argument_list|,
operator|&
name|track
operator|->
name|group_size
argument_list|)
expr_stmt|;
comment|/* initialize parser */
name|memset
argument_list|(
operator|&
name|parser
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_cs_parser
argument_list|)
argument_list|)
expr_stmt|;
name|parser
operator|.
name|filp
operator|=
name|filp
expr_stmt|;
name|parser
operator|.
name|dev
operator|=
name|dev
operator|->
name|device
expr_stmt|;
name|parser
operator|.
name|rdev
operator|=
name|NULL
expr_stmt|;
name|parser
operator|.
name|family
operator|=
name|family
expr_stmt|;
name|parser
operator|.
name|track
operator|=
name|track
expr_stmt|;
name|parser
operator|.
name|ib
operator|.
name|ptr
operator|=
name|ib
expr_stmt|;
name|r
operator|=
name|radeon_cs_parser_init
argument_list|(
operator|&
name|parser
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to initialize parser !\n"
argument_list|)
expr_stmt|;
name|r600_cs_parser_fini
argument_list|(
operator|&
name|parser
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|r600_cs_parser_relocs_legacy
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to parse relocation !\n"
argument_list|)
expr_stmt|;
name|r600_cs_parser_fini
argument_list|(
operator|&
name|parser
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Copy the packet into the IB, the parser will read from the 	 * input memory (cached) and write to the IB (which can be 	 * uncached). */
name|ib_chunk
operator|=
operator|&
name|parser
operator|.
name|chunks
index|[
name|parser
operator|.
name|chunk_ib_idx
index|]
expr_stmt|;
name|parser
operator|.
name|ib
operator|.
name|length_dw
operator|=
name|ib_chunk
operator|->
name|length_dw
expr_stmt|;
operator|*
name|l
operator|=
name|parser
operator|.
name|ib
operator|.
name|length_dw
expr_stmt|;
name|r
operator|=
name|r600_cs_parse
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid command stream !\n"
argument_list|)
expr_stmt|;
name|r600_cs_parser_fini
argument_list|(
operator|&
name|parser
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_cs_finish_pages
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid command stream !\n"
argument_list|)
expr_stmt|;
name|r600_cs_parser_fini
argument_list|(
operator|&
name|parser
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r600_cs_parser_fini
argument_list|(
operator|&
name|parser
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|r600_cs_legacy_init
parameter_list|(
name|void
parameter_list|)
block|{
name|r600_cs_packet_next_reloc
operator|=
operator|&
name|r600_cs_packet_next_reloc_nomm
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  DMA  */
end_comment

begin_comment
comment|/**  * r600_dma_cs_next_reloc() - parse next reloc  * @p:		parser structure holding parsing context.  * @cs_reloc:		reloc informations  *  * Return the next reloc, do bo validation and compute  * GPU offset using the provided start.  **/
end_comment

begin_function
name|int
name|r600_dma_cs_next_reloc
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_reloc
modifier|*
modifier|*
name|cs_reloc
parameter_list|)
block|{
name|struct
name|radeon_cs_chunk
modifier|*
name|relocs_chunk
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
operator|*
name|cs_reloc
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|chunk_relocs_idx
operator|==
operator|-
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No relocation chunk !\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|relocs_chunk
operator|=
operator|&
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_relocs_idx
index|]
expr_stmt|;
name|idx
operator|=
name|p
operator|->
name|dma_reloc_idx
expr_stmt|;
if|if
condition|(
name|idx
operator|>=
name|p
operator|->
name|nrelocs
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Relocs at %d after relocations chunk end %d !\n"
argument_list|,
name|idx
argument_list|,
name|p
operator|->
name|nrelocs
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
operator|*
name|cs_reloc
operator|=
name|p
operator|->
name|relocs_ptr
index|[
name|idx
index|]
expr_stmt|;
name|p
operator|->
name|dma_reloc_idx
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|GET_DMA_CMD
parameter_list|(
name|h
parameter_list|)
value|(((h)& 0xf0000000)>> 28)
end_define

begin_define
define|#
directive|define
name|GET_DMA_COUNT
parameter_list|(
name|h
parameter_list|)
value|((h)& 0x0000ffff)
end_define

begin_define
define|#
directive|define
name|GET_DMA_T
parameter_list|(
name|h
parameter_list|)
value|(((h)& 0x00800000)>> 23)
end_define

begin_comment
comment|/**  * r600_dma_cs_parse() - parse the DMA IB  * @p:		parser structure holding parsing context.  *  * Parses the DMA IB from the CS ioctl and updates  * the GPU addresses based on the reloc information and  * checks for errors. (R6xx-R7xx)  * Returns 0 for success and an error on failure.  **/
end_comment

begin_function
name|int
name|r600_dma_cs_parse
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|radeon_cs_chunk
modifier|*
name|ib_chunk
init|=
operator|&
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
decl_stmt|;
name|struct
name|radeon_cs_reloc
modifier|*
name|src_reloc
decl_stmt|,
modifier|*
name|dst_reloc
decl_stmt|;
name|u32
name|header
decl_stmt|,
name|cmd
decl_stmt|,
name|count
decl_stmt|,
name|tiled
decl_stmt|;
specifier|volatile
name|u32
modifier|*
name|ib
init|=
name|p
operator|->
name|ib
operator|.
name|ptr
decl_stmt|;
name|u32
name|idx
decl_stmt|,
name|idx_value
decl_stmt|;
name|u64
name|src_offset
decl_stmt|,
name|dst_offset
decl_stmt|;
name|int
name|r
decl_stmt|;
do|do
block|{
if|if
condition|(
name|p
operator|->
name|idx
operator|>=
name|ib_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Can not parse packet at %d after CS end %d !\n"
argument_list|,
name|p
operator|->
name|idx
argument_list|,
name|ib_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|idx
operator|=
name|p
operator|->
name|idx
expr_stmt|;
name|header
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|GET_DMA_CMD
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|count
operator|=
name|GET_DMA_COUNT
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|tiled
operator|=
name|GET_DMA_T
argument_list|(
name|header
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|DMA_PACKET_WRITE
case|:
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|dst_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_WRITE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|tiled
condition|)
block|{
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator|<<=
literal|8
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
name|count
operator|+
literal|5
expr_stmt|;
block|}
else|else
block|{
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
name|count
operator|+
literal|3
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA write buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|DMA_PACKET_COPY
case|:
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|src_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|dst_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|tiled
condition|)
block|{
name|idx_value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
comment|/* detile bit */
if|if
condition|(
name|idx_value
operator|&
operator|(
literal|1U
operator|<<
literal|31
operator|)
condition|)
block|{
comment|/* tiled src, linear dst */
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|src_offset
operator|<<=
literal|8
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|5
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|6
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|5
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|6
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
comment|/* linear src, tiled dst */
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|5
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|6
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|5
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|6
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator|<<=
literal|8
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
name|p
operator|->
name|idx
operator|+=
literal|7
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|p
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
block|{
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|4
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|5
expr_stmt|;
block|}
else|else
block|{
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|&
literal|0xff0000
argument_list|)
operator|)
operator|<<
literal|16
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|+=
operator|(
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
operator|)
operator|<<
literal|16
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|4
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA copy src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA write dst buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|DMA_PACKET_CONSTANT_FILL
case|:
if|if
condition|(
name|p
operator|->
name|family
operator|<
name|CHIP_RV770
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Constant Fill is 7xx only !\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|dst_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_WRITE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|&
literal|0x00ff0000
argument_list|)
operator|)
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA constant fill buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|+=
operator|(
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|<<
literal|16
operator|)
operator|&
literal|0x00ff0000
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|DMA_PACKET_NOP
case|:
name|p
operator|->
name|idx
operator|+=
literal|1
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet type %d at %d !\n"
argument_list|,
name|cmd
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
do|while
condition|(
name|p
operator|->
name|idx
operator|<
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
operator|.
name|length_dw
condition|)
do|;
if|#
directive|if
literal|0
block|for (r = 0; r< p->ib->length_dw; r++) { 		DRM_INFO("%05d  0x%08X\n", r, p->ib.ptr[r]); 		DRM_MDELAY(1); 	}
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2007-8 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_edid.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iic.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iiconf.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iicbus.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"iicbus_if.h"
end_include

begin_include
include|#
directive|include
file|"iicbb_if.h"
end_include

begin_comment
comment|/**  * radeon_ddc_probe  *  */
end_comment

begin_function
name|bool
name|radeon_ddc_probe
parameter_list|(
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
parameter_list|,
name|bool
name|use_aux
parameter_list|)
block|{
name|u8
name|out
init|=
literal|0x0
decl_stmt|;
name|u8
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|iic_msg
name|msgs
index|[]
init|=
block|{
block|{
operator|.
name|slave
operator|=
name|DDC_ADDR
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
literal|0
block|,
operator|.
name|len
operator|=
literal|1
block|,
operator|.
name|buf
operator|=
operator|&
name|out
block|, 		}
block|,
block|{
operator|.
name|slave
operator|=
name|DDC_ADDR
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
name|IIC_M_RD
block|,
operator|.
name|len
operator|=
literal|8
block|,
operator|.
name|buf
operator|=
name|buf
block|, 		}
block|}
decl_stmt|;
comment|/* on hw with routers, select right port */
if|if
condition|(
name|radeon_connector
operator|->
name|router
operator|.
name|ddc_valid
condition|)
name|radeon_router_select_ddc_port
argument_list|(
name|radeon_connector
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_aux
condition|)
block|{
name|struct
name|radeon_connector_atom_dig
modifier|*
name|dig
init|=
name|radeon_connector
operator|->
name|con_priv
decl_stmt|;
name|ret
operator|=
name|iicbus_transfer
argument_list|(
name|dig
operator|->
name|dp_i2c_bus
operator|->
name|adapter
argument_list|,
name|msgs
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|iicbus_transfer
argument_list|(
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|adapter
argument_list|,
name|msgs
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
comment|/* Couldn't find an accessible DDC on this connector */
return|return
name|false
return|;
comment|/* Probe also for valid EDID header 	 * EDID header starts with: 	 * 0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00. 	 * Only the first 6 bytes must be valid as 	 * drm_edid_block_valid() can fix the last 2 bytes */
if|if
condition|(
name|drm_edid_header_is_valid
argument_list|(
name|buf
argument_list|)
operator|<
literal|6
condition|)
block|{
comment|/* Couldn't find an accessible EDID on this 		 * connector */
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_comment
comment|/* bit banging i2c */
end_comment

begin_function
specifier|static
name|int
name|radeon_iicbb_pre_xfer
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|i2c
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
init|=
operator|&
name|i2c
operator|->
name|rec
decl_stmt|;
name|uint32_t
name|temp
decl_stmt|;
comment|/* RV410 appears to have a bug where the hw i2c in reset 	 * holds the i2c port in a bad state - switch hw i2c away before 	 * doing DDC - do this for all r200s/r300s/r400s for safety sake 	 */
if|if
condition|(
name|rec
operator|->
name|hw_capable
condition|)
block|{
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R200
operator|)
operator|&&
operator|!
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|u32
name|reg
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV350
condition|)
name|reg
operator|=
name|RADEON_GPIO_MONID
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R350
operator|)
condition|)
name|reg
operator|=
name|RADEON_GPIO_DVI_DDC
expr_stmt|;
else|else
name|reg
operator|=
name|RADEON_GPIO_CRT2_DDC
expr_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|rdev
operator|->
name|dc_hw_i2c_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|rec
operator|->
name|a_clk_reg
operator|==
name|reg
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_DVI_I2C_CNTL_0
argument_list|,
operator|(
name|RADEON_I2C_SOFT_RST
operator||
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|RADEON_DVI_I2C_CNTL_0
argument_list|,
operator|(
name|RADEON_I2C_SOFT_RST
operator||
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|sx_xunlock
argument_list|(
operator|&
name|rdev
operator|->
name|dc_hw_i2c_mutex
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* switch the pads to ddc mode */
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
operator|&&
name|rec
operator|->
name|hw_capable
condition|)
block|{
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|)
expr_stmt|;
name|temp
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|16
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
comment|/* clear the output pin values */
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|a_clk_reg
argument_list|)
operator|&
operator|~
name|rec
operator|->
name|a_clk_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|a_clk_reg
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|a_data_reg
argument_list|)
operator|&
operator|~
name|rec
operator|->
name|a_data_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|a_data_reg
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/* set the pins to input */
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|en_clk_reg
argument_list|)
operator|&
operator|~
name|rec
operator|->
name|en_clk_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|en_clk_reg
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|en_data_reg
argument_list|)
operator|&
operator|~
name|rec
operator|->
name|en_data_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|en_data_reg
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/* mask the gpio pins for software use */
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|)
operator||
name|rec
operator|->
name|mask_clk_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|)
expr_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_data_reg
argument_list|)
operator||
name|rec
operator|->
name|mask_data_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|mask_data_reg
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_data_reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_iicbb_post_xfer
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|i2c
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
init|=
operator|&
name|i2c
operator|->
name|rec
decl_stmt|;
name|uint32_t
name|temp
decl_stmt|;
comment|/* unmask the gpio pins for software use */
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|)
operator|&
operator|~
name|rec
operator|->
name|mask_clk_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|)
expr_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_data_reg
argument_list|)
operator|&
operator|~
name|rec
operator|->
name|mask_data_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|mask_data_reg
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_data_reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_iicbb_get_clock
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|i2c
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
init|=
operator|&
name|i2c
operator|->
name|rec
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
comment|/* read the value off the pin */
name|val
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|y_clk_reg
argument_list|)
expr_stmt|;
name|val
operator|&=
name|rec
operator|->
name|y_clk_mask
expr_stmt|;
return|return
operator|(
name|val
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_iicbb_get_data
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|i2c
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
init|=
operator|&
name|i2c
operator|->
name|rec
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
comment|/* read the value off the pin */
name|val
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|y_data_reg
argument_list|)
expr_stmt|;
name|val
operator|&=
name|rec
operator|->
name|y_data_mask
expr_stmt|;
return|return
operator|(
name|val
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_iicbb_set_clock
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|clock
parameter_list|)
block|{
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|i2c
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
init|=
operator|&
name|i2c
operator|->
name|rec
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
comment|/* set pin direction */
name|val
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|en_clk_reg
argument_list|)
operator|&
operator|~
name|rec
operator|->
name|en_clk_mask
expr_stmt|;
name|val
operator||=
name|clock
condition|?
literal|0
else|:
name|rec
operator|->
name|en_clk_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|en_clk_reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_iicbb_set_data
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|data
parameter_list|)
block|{
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|i2c
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
init|=
operator|&
name|i2c
operator|->
name|rec
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
comment|/* set pin direction */
name|val
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|en_data_reg
argument_list|)
operator|&
operator|~
name|rec
operator|->
name|en_data_mask
expr_stmt|;
name|val
operator||=
name|data
condition|?
literal|0
else|:
name|rec
operator|->
name|en_data_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|en_data_reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_iicbb_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_iicbb_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
decl_stmt|;
name|device_t
name|iic_dev
decl_stmt|;
name|i2c
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|i2c
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* add generic bit-banging code */
name|iic_dev
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"iicbb"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iic_dev
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_quiet
argument_list|(
name|iic_dev
argument_list|)
expr_stmt|;
comment|/* attach and probe added child */
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_iicbb_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
comment|/* detach bit-banding code. */
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* delete bit-banding code. */
name|device_delete_children
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_iicbb_reset
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|speed
parameter_list|,
name|u_char
name|addr
parameter_list|,
name|u_char
modifier|*
name|oldaddr
parameter_list|)
block|{
comment|/* Not sure what to do here. */
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|radeon_iicbb_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|radeon_iicbb_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|radeon_iicbb_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|radeon_iicbb_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_add_child
argument_list|,
name|bus_generic_add_child
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_print_child
argument_list|,
name|bus_generic_print_child
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbb_reset
argument_list|,
name|radeon_iicbb_reset
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbb_pre_xfer
argument_list|,
name|radeon_iicbb_pre_xfer
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbb_post_xfer
argument_list|,
name|radeon_iicbb_post_xfer
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbb_setsda
argument_list|,
name|radeon_iicbb_set_data
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbb_setscl
argument_list|,
name|radeon_iicbb_set_clock
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbb_getsda
argument_list|,
name|radeon_iicbb_get_data
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbb_getscl
argument_list|,
name|radeon_iicbb_get_clock
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|radeon_iicbb_driver
init|=
block|{
literal|"radeon_iicbb"
block|,
name|radeon_iicbb_methods
block|,
literal|0
comment|/* softc will be allocated by parent */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|radeon_iicbb_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE_ORDERED
argument_list|(
name|radeon_iicbb
argument_list|,
name|drmn
argument_list|,
name|radeon_iicbb_driver
argument_list|,
name|radeon_iicbb_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SI_ORDER_FIRST
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|iicbb
argument_list|,
name|radeon_iicbb
argument_list|,
name|iicbb_driver
argument_list|,
name|iicbb_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* hw i2c */
end_comment

begin_function
specifier|static
name|u32
name|radeon_get_i2c_prescale
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|sclk
init|=
name|rdev
operator|->
name|pm
operator|.
name|current_sclk
decl_stmt|;
name|u32
name|prescale
init|=
literal|0
decl_stmt|;
name|u32
name|nm
decl_stmt|;
name|u8
name|n
decl_stmt|,
name|m
decl_stmt|,
name|loop
decl_stmt|;
name|int
name|i2c_clock
decl_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_R100
case|:
case|case
name|CHIP_RV100
case|:
case|case
name|CHIP_RS100
case|:
case|case
name|CHIP_RV200
case|:
case|case
name|CHIP_RS200
case|:
case|case
name|CHIP_R200
case|:
case|case
name|CHIP_RV250
case|:
case|case
name|CHIP_RS300
case|:
case|case
name|CHIP_RV280
case|:
case|case
name|CHIP_R300
case|:
case|case
name|CHIP_R350
case|:
case|case
name|CHIP_RV350
case|:
name|i2c_clock
operator|=
literal|60
expr_stmt|;
name|nm
operator|=
operator|(
name|sclk
operator|*
literal|10
operator|)
operator|/
operator|(
name|i2c_clock
operator|*
literal|4
operator|)
expr_stmt|;
for|for
control|(
name|loop
operator|=
literal|1
init|;
name|loop
operator|<
literal|255
condition|;
name|loop
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|nm
operator|/
name|loop
operator|)
operator|<
name|loop
condition|)
break|break;
block|}
name|n
operator|=
name|loop
operator|-
literal|1
expr_stmt|;
name|m
operator|=
name|loop
operator|-
literal|2
expr_stmt|;
name|prescale
operator|=
name|m
operator||
operator|(
name|n
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
case|case
name|CHIP_RV380
case|:
case|case
name|CHIP_RS400
case|:
case|case
name|CHIP_RS480
case|:
case|case
name|CHIP_R420
case|:
case|case
name|CHIP_R423
case|:
case|case
name|CHIP_RV410
case|:
name|prescale
operator|=
operator|(
operator|(
operator|(
name|sclk
operator|*
literal|10
operator|)
operator|/
operator|(
literal|4
operator|*
literal|128
operator|*
literal|100
operator|)
operator|+
literal|1
operator|)
operator|<<
literal|8
operator|)
operator|+
literal|128
expr_stmt|;
break|break;
case|case
name|CHIP_RS600
case|:
case|case
name|CHIP_RS690
case|:
case|case
name|CHIP_RS740
case|:
comment|/* todo */
break|break;
case|case
name|CHIP_RV515
case|:
case|case
name|CHIP_R520
case|:
case|case
name|CHIP_RV530
case|:
case|case
name|CHIP_RV560
case|:
case|case
name|CHIP_RV570
case|:
case|case
name|CHIP_R580
case|:
name|i2c_clock
operator|=
literal|50
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R520
condition|)
name|prescale
operator|=
operator|(
literal|127
operator|<<
literal|8
operator|)
operator|+
operator|(
operator|(
name|sclk
operator|*
literal|10
operator|)
operator|/
operator|(
literal|4
operator|*
literal|127
operator|*
name|i2c_clock
operator|)
operator|)
expr_stmt|;
else|else
name|prescale
operator|=
operator|(
operator|(
operator|(
name|sclk
operator|*
literal|10
operator|)
operator|/
operator|(
literal|4
operator|*
literal|128
operator|*
literal|100
operator|)
operator|+
literal|1
operator|)
operator|<<
literal|8
operator|)
operator|+
literal|128
expr_stmt|;
break|break;
case|case
name|CHIP_R600
case|:
case|case
name|CHIP_RV610
case|:
case|case
name|CHIP_RV630
case|:
case|case
name|CHIP_RV670
case|:
comment|/* todo */
break|break;
case|case
name|CHIP_RV620
case|:
case|case
name|CHIP_RV635
case|:
case|case
name|CHIP_RS780
case|:
case|case
name|CHIP_RS880
case|:
case|case
name|CHIP_RV770
case|:
case|case
name|CHIP_RV730
case|:
case|case
name|CHIP_RV710
case|:
case|case
name|CHIP_RV740
case|:
comment|/* todo */
break|break;
case|case
name|CHIP_CEDAR
case|:
case|case
name|CHIP_REDWOOD
case|:
case|case
name|CHIP_JUNIPER
case|:
case|case
name|CHIP_CYPRESS
case|:
case|case
name|CHIP_HEMLOCK
case|:
comment|/* todo */
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"i2c: unhandled radeon chip\n"
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|prescale
return|;
block|}
end_function

begin_comment
comment|/* hw i2c engine for r1xx-4xx hardware  * hw can buffer up to 15 bytes  */
end_comment

begin_function
specifier|static
name|int
name|r100_hw_i2c_xfer
parameter_list|(
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
parameter_list|,
name|struct
name|iic_msg
modifier|*
name|msgs
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|i2c
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
init|=
operator|&
name|i2c
operator|->
name|rec
decl_stmt|;
name|struct
name|iic_msg
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|u32
name|prescale
decl_stmt|;
name|u32
name|i2c_cntl_0
decl_stmt|,
name|i2c_cntl_1
decl_stmt|,
name|i2c_data
decl_stmt|;
name|u32
name|tmp
decl_stmt|,
name|reg
decl_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|rdev
operator|->
name|dc_hw_i2c_mutex
argument_list|)
expr_stmt|;
comment|/* take the pm lock since we need a constant sclk */
name|sx_xlock
argument_list|(
operator|&
name|rdev
operator|->
name|pm
operator|.
name|mutex
argument_list|)
expr_stmt|;
name|prescale
operator|=
name|radeon_get_i2c_prescale
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
operator|(
name|prescale
operator|<<
name|RADEON_I2C_PRESCALE_SHIFT
operator|)
operator||
name|RADEON_I2C_DRIVE_EN
operator||
name|RADEON_I2C_START
operator||
name|RADEON_I2C_STOP
operator||
name|RADEON_I2C_GO
operator|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|,
name|tmp
operator||
name|ATOM_S6_HW_I2C_BUSY_STATE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rec
operator|->
name|mm_i2c
condition|)
block|{
name|i2c_cntl_0
operator|=
name|RADEON_I2C_CNTL_0
expr_stmt|;
name|i2c_cntl_1
operator|=
name|RADEON_I2C_CNTL_1
expr_stmt|;
name|i2c_data
operator|=
name|RADEON_I2C_DATA
expr_stmt|;
block|}
else|else
block|{
name|i2c_cntl_0
operator|=
name|RADEON_DVI_I2C_CNTL_0
expr_stmt|;
name|i2c_cntl_1
operator|=
name|RADEON_DVI_I2C_CNTL_1
expr_stmt|;
name|i2c_data
operator|=
name|RADEON_DVI_I2C_DATA
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_R100
case|:
case|case
name|CHIP_RV100
case|:
case|case
name|CHIP_RS100
case|:
case|case
name|CHIP_RV200
case|:
case|case
name|CHIP_RS200
case|:
case|case
name|CHIP_RS300
case|:
switch|switch
condition|(
name|rec
operator|->
name|mask_clk_reg
condition|)
block|{
case|case
name|RADEON_GPIO_DVI_DDC
case|:
comment|/* no gpio select bit */
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"gpio not supported with hw i2c\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
case|case
name|CHIP_R200
case|:
comment|/* only bit 4 on r200 */
switch|switch
condition|(
name|rec
operator|->
name|mask_clk_reg
condition|)
block|{
case|case
name|RADEON_GPIO_DVI_DDC
case|:
name|reg
operator||=
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_GPIO_MONID
case|:
name|reg
operator||=
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC3
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"gpio not supported with hw i2c\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
case|case
name|CHIP_RV250
case|:
case|case
name|CHIP_RV280
case|:
comment|/* bits 3 and 4 */
switch|switch
condition|(
name|rec
operator|->
name|mask_clk_reg
condition|)
block|{
case|case
name|RADEON_GPIO_DVI_DDC
case|:
name|reg
operator||=
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_GPIO_VGA_DDC
case|:
name|reg
operator||=
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC2
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_GPIO_CRT2_DDC
case|:
name|reg
operator||=
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC3
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"gpio not supported with hw i2c\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
case|case
name|CHIP_R300
case|:
case|case
name|CHIP_R350
case|:
comment|/* only bit 4 on r300/r350 */
switch|switch
condition|(
name|rec
operator|->
name|mask_clk_reg
condition|)
block|{
case|case
name|RADEON_GPIO_VGA_DDC
case|:
name|reg
operator||=
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_GPIO_DVI_DDC
case|:
name|reg
operator||=
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC3
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"gpio not supported with hw i2c\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
case|case
name|CHIP_RV350
case|:
case|case
name|CHIP_RV380
case|:
case|case
name|CHIP_R420
case|:
case|case
name|CHIP_R423
case|:
case|case
name|CHIP_RV410
case|:
case|case
name|CHIP_RS400
case|:
case|case
name|CHIP_RS480
case|:
comment|/* bits 3 and 4 */
switch|switch
condition|(
name|rec
operator|->
name|mask_clk_reg
condition|)
block|{
case|case
name|RADEON_GPIO_VGA_DDC
case|:
name|reg
operator||=
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_GPIO_DVI_DDC
case|:
name|reg
operator||=
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC2
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_GPIO_MONID
case|:
name|reg
operator||=
name|R200_DVI_I2C_PIN_SEL
argument_list|(
name|R200_SEL_DDC3
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"gpio not supported with hw i2c\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"unsupported asic\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
break|break;
block|}
block|}
comment|/* check for bus probe */
name|p
operator|=
operator|&
name|msgs
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|num
operator|==
literal|1
operator|)
operator|&&
operator|(
name|p
operator|->
name|len
operator|==
literal|0
operator|)
condition|)
block|{
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
operator|(
name|RADEON_I2C_DONE
operator||
name|RADEON_I2C_NACK
operator||
name|RADEON_I2C_HALT
operator||
name|RADEON_I2C_SOFT_RST
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_data
argument_list|,
operator|(
name|p
operator|->
name|slave
operator|<<
literal|1
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_1
argument_list|,
operator|(
operator|(
literal|1
operator|<<
name|RADEON_I2C_DATA_COUNT_SHIFT
operator|)
operator||
operator|(
literal|1
operator|<<
name|RADEON_I2C_ADDR_COUNT_SHIFT
operator|)
operator||
name|RADEON_I2C_EN
operator||
operator|(
literal|48
operator|<<
name|RADEON_I2C_TIME_LIMIT_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|32
condition|;
name|k
operator|++
control|)
block|{
name|DRM_UDELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|i2c_cntl_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_I2C_GO
condition|)
continue|continue;
name|tmp
operator|=
name|RREG32
argument_list|(
name|i2c_cntl_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_I2C_DONE
condition|)
break|break;
else|else
block|{
name|DRM_DEBUG
argument_list|(
literal|"i2c write error 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
name|tmp
operator||
name|RADEON_I2C_ABORT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
goto|goto
name|done
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
operator|&
name|msgs
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|p
operator|->
name|len
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|p
operator|->
name|flags
operator|&
name|IIC_M_RD
condition|)
block|{
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
operator|(
name|RADEON_I2C_DONE
operator||
name|RADEON_I2C_NACK
operator||
name|RADEON_I2C_HALT
operator||
name|RADEON_I2C_SOFT_RST
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_data
argument_list|,
operator|(
operator|(
name|p
operator|->
name|slave
operator|<<
literal|1
operator|)
operator|&
literal|0xff
operator|)
operator||
literal|0x1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_1
argument_list|,
operator|(
operator|(
literal|1
operator|<<
name|RADEON_I2C_DATA_COUNT_SHIFT
operator|)
operator||
operator|(
literal|1
operator|<<
name|RADEON_I2C_ADDR_COUNT_SHIFT
operator|)
operator||
name|RADEON_I2C_EN
operator||
operator|(
literal|48
operator|<<
name|RADEON_I2C_TIME_LIMIT_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
name|reg
operator||
name|RADEON_I2C_RECEIVE
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|32
condition|;
name|k
operator|++
control|)
block|{
name|DRM_UDELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|i2c_cntl_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_I2C_GO
condition|)
continue|continue;
name|tmp
operator|=
name|RREG32
argument_list|(
name|i2c_cntl_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_I2C_DONE
condition|)
break|break;
else|else
block|{
name|DRM_DEBUG
argument_list|(
literal|"i2c read error 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
name|tmp
operator||
name|RADEON_I2C_ABORT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|p
operator|->
name|buf
index|[
name|j
index|]
operator|=
name|RREG32
argument_list|(
name|i2c_data
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
operator|(
name|RADEON_I2C_DONE
operator||
name|RADEON_I2C_NACK
operator||
name|RADEON_I2C_HALT
operator||
name|RADEON_I2C_SOFT_RST
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_data
argument_list|,
operator|(
name|p
operator|->
name|slave
operator|<<
literal|1
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_data
argument_list|,
name|p
operator|->
name|buf
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_1
argument_list|,
operator|(
operator|(
literal|1
operator|<<
name|RADEON_I2C_DATA_COUNT_SHIFT
operator|)
operator||
operator|(
literal|1
operator|<<
name|RADEON_I2C_ADDR_COUNT_SHIFT
operator|)
operator||
name|RADEON_I2C_EN
operator||
operator|(
literal|48
operator|<<
name|RADEON_I2C_TIME_LIMIT_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|32
condition|;
name|k
operator|++
control|)
block|{
name|DRM_UDELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|i2c_cntl_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_I2C_GO
condition|)
continue|continue;
name|tmp
operator|=
name|RREG32
argument_list|(
name|i2c_cntl_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_I2C_DONE
condition|)
break|break;
else|else
block|{
name|DRM_DEBUG
argument_list|(
literal|"i2c write error 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
name|tmp
operator||
name|RADEON_I2C_ABORT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
block|}
block|}
block|}
name|done
label|:
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|i2c_cntl_0
argument_list|,
operator|(
name|RADEON_I2C_DONE
operator||
name|RADEON_I2C_NACK
operator||
name|RADEON_I2C_HALT
operator||
name|RADEON_I2C_SOFT_RST
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|ATOM_S6_HW_I2C_BUSY_STATE
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|sx_xunlock
argument_list|(
operator|&
name|rdev
operator|->
name|pm
operator|.
name|mutex
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|rdev
operator|->
name|dc_hw_i2c_mutex
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* hw i2c engine for r5xx hardware  * hw can buffer up to 15 bytes  */
end_comment

begin_function
specifier|static
name|int
name|r500_hw_i2c_xfer
parameter_list|(
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
parameter_list|,
name|struct
name|iic_msg
modifier|*
name|msgs
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|i2c
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
init|=
operator|&
name|i2c
operator|->
name|rec
decl_stmt|;
name|struct
name|iic_msg
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|remaining
decl_stmt|,
name|current_count
decl_stmt|,
name|buffer_offset
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|u32
name|prescale
decl_stmt|;
name|u32
name|tmp
decl_stmt|,
name|reg
decl_stmt|;
name|u32
name|saved1
decl_stmt|,
name|saved2
decl_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|rdev
operator|->
name|dc_hw_i2c_mutex
argument_list|)
expr_stmt|;
comment|/* take the pm lock since we need a constant sclk */
name|sx_xlock
argument_list|(
operator|&
name|rdev
operator|->
name|pm
operator|.
name|mutex
argument_list|)
expr_stmt|;
name|prescale
operator|=
name|radeon_get_i2c_prescale
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* clear gpio mask bits */
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|rec
operator|->
name|mask_clk_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_clk_reg
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_data_reg
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|rec
operator|->
name|mask_data_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|mask_data_reg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|mask_data_reg
argument_list|)
expr_stmt|;
comment|/* clear pin values */
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|a_clk_reg
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|rec
operator|->
name|a_clk_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|a_clk_reg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|a_clk_reg
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|a_data_reg
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|rec
operator|->
name|a_data_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|a_data_reg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|a_data_reg
argument_list|)
expr_stmt|;
comment|/* set the pins to input */
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|en_clk_reg
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|rec
operator|->
name|en_clk_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|en_clk_reg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|en_clk_reg
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|en_data_reg
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|rec
operator|->
name|en_data_mask
expr_stmt|;
name|WREG32
argument_list|(
name|rec
operator|->
name|en_data_reg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|rec
operator|->
name|en_data_reg
argument_list|)
expr_stmt|;
comment|/* */
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|,
name|tmp
operator||
name|ATOM_S6_HW_I2C_BUSY_STATE
argument_list|)
expr_stmt|;
name|saved1
operator|=
name|RREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL1
argument_list|)
expr_stmt|;
name|saved2
operator|=
name|RREG32
argument_list|(
literal|0x494
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x494
argument_list|,
name|saved2
operator||
literal|0x1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_ARBITRATION
argument_list|,
name|AVIVO_DC_I2C_SW_WANTS_TO_USE_I2C
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|50
condition|;
name|i
operator|++
control|)
block|{
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|RREG32
argument_list|(
name|AVIVO_DC_I2C_ARBITRATION
argument_list|)
operator|&
name|AVIVO_DC_I2C_SW_CAN_USE_I2C
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
literal|50
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to get i2c bus\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EBUSY
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|reg
operator|=
name|AVIVO_DC_I2C_START
operator||
name|AVIVO_DC_I2C_STOP
operator||
name|AVIVO_DC_I2C_EN
expr_stmt|;
switch|switch
condition|(
name|rec
operator|->
name|mask_clk_reg
condition|)
block|{
case|case
name|AVIVO_DC_GPIO_DDC1_MASK
case|:
name|reg
operator||=
name|AVIVO_DC_I2C_PIN_SELECT
argument_list|(
name|AVIVO_SEL_DDC1
argument_list|)
expr_stmt|;
break|break;
case|case
name|AVIVO_DC_GPIO_DDC2_MASK
case|:
name|reg
operator||=
name|AVIVO_DC_I2C_PIN_SELECT
argument_list|(
name|AVIVO_SEL_DDC2
argument_list|)
expr_stmt|;
break|break;
case|case
name|AVIVO_DC_GPIO_DDC3_MASK
case|:
name|reg
operator||=
name|AVIVO_DC_I2C_PIN_SELECT
argument_list|(
name|AVIVO_SEL_DDC3
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"gpio not supported with hw i2c\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* check for bus probe */
name|p
operator|=
operator|&
name|msgs
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|num
operator|==
literal|1
operator|)
operator|&&
operator|(
name|p
operator|->
name|len
operator|==
literal|0
operator|)
condition|)
block|{
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|,
operator|(
name|AVIVO_DC_I2C_DONE
operator||
name|AVIVO_DC_I2C_NACK
operator||
name|AVIVO_DC_I2C_HALT
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
name|AVIVO_DC_I2C_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_DATA
argument_list|,
operator|(
name|p
operator|->
name|slave
operator|<<
literal|1
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL3
argument_list|,
name|AVIVO_DC_I2C_TIME_LIMIT
argument_list|(
literal|48
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL2
argument_list|,
operator|(
name|AVIVO_DC_I2C_ADDR_COUNT
argument_list|(
literal|1
argument_list|)
operator||
name|AVIVO_DC_I2C_DATA_COUNT
argument_list|(
literal|1
argument_list|)
operator||
operator|(
name|prescale
operator|<<
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|,
name|AVIVO_DC_I2C_GO
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|200
condition|;
name|j
operator|++
control|)
block|{
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|AVIVO_DC_I2C_GO
condition|)
continue|continue;
name|tmp
operator|=
name|RREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|AVIVO_DC_I2C_DONE
condition|)
break|break;
else|else
block|{
name|DRM_DEBUG
argument_list|(
literal|"i2c write error 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
name|AVIVO_DC_I2C_ABORT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
goto|goto
name|done
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
operator|&
name|msgs
index|[
name|i
index|]
expr_stmt|;
name|remaining
operator|=
name|p
operator|->
name|len
expr_stmt|;
name|buffer_offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|flags
operator|&
name|IIC_M_RD
condition|)
block|{
while|while
condition|(
name|remaining
condition|)
block|{
if|if
condition|(
name|remaining
operator|>
literal|15
condition|)
name|current_count
operator|=
literal|15
expr_stmt|;
else|else
name|current_count
operator|=
name|remaining
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|,
operator|(
name|AVIVO_DC_I2C_DONE
operator||
name|AVIVO_DC_I2C_NACK
operator||
name|AVIVO_DC_I2C_HALT
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
name|AVIVO_DC_I2C_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_DATA
argument_list|,
operator|(
operator|(
name|p
operator|->
name|slave
operator|<<
literal|1
operator|)
operator|&
literal|0xff
operator|)
operator||
literal|0x1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL3
argument_list|,
name|AVIVO_DC_I2C_TIME_LIMIT
argument_list|(
literal|48
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL2
argument_list|,
operator|(
name|AVIVO_DC_I2C_ADDR_COUNT
argument_list|(
literal|1
argument_list|)
operator||
name|AVIVO_DC_I2C_DATA_COUNT
argument_list|(
name|current_count
argument_list|)
operator||
operator|(
name|prescale
operator|<<
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL1
argument_list|,
name|reg
operator||
name|AVIVO_DC_I2C_RECEIVE
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|,
name|AVIVO_DC_I2C_GO
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|200
condition|;
name|j
operator|++
control|)
block|{
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|AVIVO_DC_I2C_GO
condition|)
continue|continue;
name|tmp
operator|=
name|RREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|AVIVO_DC_I2C_DONE
condition|)
break|break;
else|else
block|{
name|DRM_DEBUG
argument_list|(
literal|"i2c read error 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
name|AVIVO_DC_I2C_ABORT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|current_count
condition|;
name|j
operator|++
control|)
name|p
operator|->
name|buf
index|[
name|buffer_offset
operator|+
name|j
index|]
operator|=
name|RREG32
argument_list|(
name|AVIVO_DC_I2C_DATA
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|remaining
operator|-=
name|current_count
expr_stmt|;
name|buffer_offset
operator|+=
name|current_count
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|remaining
condition|)
block|{
if|if
condition|(
name|remaining
operator|>
literal|15
condition|)
name|current_count
operator|=
literal|15
expr_stmt|;
else|else
name|current_count
operator|=
name|remaining
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|,
operator|(
name|AVIVO_DC_I2C_DONE
operator||
name|AVIVO_DC_I2C_NACK
operator||
name|AVIVO_DC_I2C_HALT
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
name|AVIVO_DC_I2C_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_DATA
argument_list|,
operator|(
name|p
operator|->
name|slave
operator|<<
literal|1
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|current_count
condition|;
name|j
operator|++
control|)
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_DATA
argument_list|,
name|p
operator|->
name|buf
index|[
name|buffer_offset
operator|+
name|j
index|]
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL3
argument_list|,
name|AVIVO_DC_I2C_TIME_LIMIT
argument_list|(
literal|48
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL2
argument_list|,
operator|(
name|AVIVO_DC_I2C_ADDR_COUNT
argument_list|(
literal|1
argument_list|)
operator||
name|AVIVO_DC_I2C_DATA_COUNT
argument_list|(
name|current_count
argument_list|)
operator||
operator|(
name|prescale
operator|<<
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|,
name|AVIVO_DC_I2C_GO
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|200
condition|;
name|j
operator|++
control|)
block|{
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|AVIVO_DC_I2C_GO
condition|)
continue|continue;
name|tmp
operator|=
name|RREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|AVIVO_DC_I2C_DONE
condition|)
break|break;
else|else
block|{
name|DRM_DEBUG
argument_list|(
literal|"i2c write error 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
name|AVIVO_DC_I2C_ABORT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|remaining
operator|-=
name|current_count
expr_stmt|;
name|buffer_offset
operator|+=
name|current_count
expr_stmt|;
block|}
block|}
block|}
name|done
label|:
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_STATUS1
argument_list|,
operator|(
name|AVIVO_DC_I2C_DONE
operator||
name|AVIVO_DC_I2C_NACK
operator||
name|AVIVO_DC_I2C_HALT
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
name|AVIVO_DC_I2C_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_ARBITRATION
argument_list|,
name|AVIVO_DC_I2C_SW_DONE_USING_I2C
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_I2C_CONTROL1
argument_list|,
name|saved1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x494
argument_list|,
name|saved2
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|ATOM_S6_HW_I2C_BUSY_STATE
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|rdev
operator|->
name|pm
operator|.
name|mutex
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|rdev
operator|->
name|dc_hw_i2c_mutex
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_hw_i2c_xfer
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|iic_msg
modifier|*
name|msgs
parameter_list|,
name|uint32_t
name|num
parameter_list|)
block|{
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|i2c
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
init|=
operator|&
name|i2c
operator|->
name|rec
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_R100
case|:
case|case
name|CHIP_RV100
case|:
case|case
name|CHIP_RS100
case|:
case|case
name|CHIP_RV200
case|:
case|case
name|CHIP_RS200
case|:
case|case
name|CHIP_R200
case|:
case|case
name|CHIP_RV250
case|:
case|case
name|CHIP_RS300
case|:
case|case
name|CHIP_RV280
case|:
case|case
name|CHIP_R300
case|:
case|case
name|CHIP_R350
case|:
case|case
name|CHIP_RV350
case|:
case|case
name|CHIP_RV380
case|:
case|case
name|CHIP_R420
case|:
case|case
name|CHIP_R423
case|:
case|case
name|CHIP_RV410
case|:
case|case
name|CHIP_RS400
case|:
case|case
name|CHIP_RS480
case|:
name|ret
operator|=
name|r100_hw_i2c_xfer
argument_list|(
name|i2c
argument_list|,
name|msgs
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHIP_RS600
case|:
case|case
name|CHIP_RS690
case|:
case|case
name|CHIP_RS740
case|:
comment|/* XXX fill in hw i2c implementation */
break|break;
case|case
name|CHIP_RV515
case|:
case|case
name|CHIP_R520
case|:
case|case
name|CHIP_RV530
case|:
case|case
name|CHIP_RV560
case|:
case|case
name|CHIP_RV570
case|:
case|case
name|CHIP_R580
case|:
if|if
condition|(
name|rec
operator|->
name|mm_i2c
condition|)
name|ret
operator|=
name|r100_hw_i2c_xfer
argument_list|(
name|i2c
argument_list|,
name|msgs
argument_list|,
name|num
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|r500_hw_i2c_xfer
argument_list|(
name|i2c
argument_list|,
name|msgs
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHIP_R600
case|:
case|case
name|CHIP_RV610
case|:
case|case
name|CHIP_RV630
case|:
case|case
name|CHIP_RV670
case|:
comment|/* XXX fill in hw i2c implementation */
break|break;
case|case
name|CHIP_RV620
case|:
case|case
name|CHIP_RV635
case|:
case|case
name|CHIP_RS780
case|:
case|case
name|CHIP_RS880
case|:
case|case
name|CHIP_RV770
case|:
case|case
name|CHIP_RV730
case|:
case|case
name|CHIP_RV710
case|:
case|case
name|CHIP_RV740
case|:
comment|/* XXX fill in hw i2c implementation */
break|break;
case|case
name|CHIP_CEDAR
case|:
case|case
name|CHIP_REDWOOD
case|:
case|case
name|CHIP_JUNIPER
case|:
case|case
name|CHIP_CYPRESS
case|:
case|case
name|CHIP_HEMLOCK
case|:
comment|/* XXX fill in hw i2c implementation */
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"i2c: unhandled radeon chip\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_hw_i2c_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|BUS_PROBE_SPECIFIC
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_hw_i2c_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
decl_stmt|;
name|device_t
name|iic_dev
decl_stmt|;
name|i2c
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|i2c
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* add generic bit-banging code */
name|iic_dev
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"iicbus"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iic_dev
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_quiet
argument_list|(
name|iic_dev
argument_list|)
expr_stmt|;
comment|/* attach and probe added child */
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_hw_i2c_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
comment|/* detach bit-banding code. */
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* delete bit-banding code. */
name|device_delete_children
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_hw_i2c_reset
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|speed
parameter_list|,
name|u_char
name|addr
parameter_list|,
name|u_char
modifier|*
name|oldaddr
parameter_list|)
block|{
comment|/* Not sure what to do here. */
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|radeon_hw_i2c_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|radeon_hw_i2c_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|radeon_hw_i2c_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|radeon_hw_i2c_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_reset
argument_list|,
name|radeon_hw_i2c_reset
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|iicbus_transfer
argument_list|,
name|radeon_hw_i2c_xfer
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|radeon_hw_i2c_driver
init|=
block|{
literal|"radeon_hw_i2c"
block|,
name|radeon_hw_i2c_methods
block|,
literal|0
comment|/* softc will be allocated by parent */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|radeon_hw_i2c_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE_ORDERED
argument_list|(
name|radeon_hw_i2c
argument_list|,
name|drm
argument_list|,
name|radeon_hw_i2c_driver
argument_list|,
name|radeon_hw_i2c_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SI_ORDER_FIRST
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|iicbus
argument_list|,
name|radeon_hw_i2c
argument_list|,
name|iicbus_driver
argument_list|,
name|iicbus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|struct
name|radeon_i2c_chan
modifier|*
name|radeon_i2c_create
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
decl_stmt|;
name|device_t
name|iicbus_dev
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* don't add the mm_i2c bus unless hw_i2c is enabled */
if|if
condition|(
name|rec
operator|->
name|mm_i2c
operator|&&
operator|(
name|radeon_hw_i2c
operator|==
literal|0
operator|)
condition|)
return|return
name|NULL
return|;
name|i2c
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_i2c_chan
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2c
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* 	 * Grab Giant before messing with newbus devices, just in case 	 * we do not hold it already. 	 */
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|i2c
operator|->
name|rec
operator|=
operator|*
name|rec
expr_stmt|;
name|i2c
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
if|if
condition|(
name|rec
operator|->
name|mm_i2c
operator|||
operator|(
name|rec
operator|->
name|hw_capable
operator|&&
name|radeon_hw_i2c
operator|&&
operator|(
operator|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RS480
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV515
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_R580
operator|)
operator|)
operator|)
operator|)
condition|)
block|{
comment|/* set the radeon hw i2c adapter */
name|snprintf
argument_list|(
name|i2c
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|i2c
operator|->
name|name
argument_list|)
argument_list|,
literal|"Radeon i2c hw bus %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|iicbus_dev
operator|=
name|device_add_child
argument_list|(
name|dev
operator|->
name|device
argument_list|,
literal|"radeon_hw_i2c"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iicbus_dev
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to create bridge for hw i2c %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
name|device_quiet
argument_list|(
name|iicbus_dev
argument_list|)
expr_stmt|;
name|device_set_softc
argument_list|(
name|iicbus_dev
argument_list|,
name|i2c
argument_list|)
expr_stmt|;
name|ret
operator|=
name|device_probe_and_attach
argument_list|(
name|iicbus_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Attach failed for bridge for hw i2c %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|device_delete_child
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|iicbus_dev
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
name|i2c
operator|->
name|adapter
operator|=
name|device_find_child
argument_list|(
name|iicbus_dev
argument_list|,
literal|"iicbus"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2c
operator|->
name|adapter
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"hw i2c bridge doesn't have iicbus child\n"
argument_list|)
expr_stmt|;
name|device_delete_child
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|iicbus_dev
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|rec
operator|->
name|hw_capable
operator|&&
name|radeon_hw_i2c
operator|&&
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
comment|/* hw i2c using atom */
name|snprintf
argument_list|(
name|i2c
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|i2c
operator|->
name|name
argument_list|)
argument_list|,
literal|"Radeon i2c hw bus %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|iicbus_dev
operator|=
name|device_add_child
argument_list|(
name|dev
operator|->
name|device
argument_list|,
literal|"radeon_atom_hw_i2c"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iicbus_dev
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to create bridge for hw i2c %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
name|device_quiet
argument_list|(
name|iicbus_dev
argument_list|)
expr_stmt|;
name|device_set_softc
argument_list|(
name|iicbus_dev
argument_list|,
name|i2c
argument_list|)
expr_stmt|;
name|ret
operator|=
name|device_probe_and_attach
argument_list|(
name|iicbus_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Attach failed for bridge for hw i2c %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|device_delete_child
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|iicbus_dev
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
name|i2c
operator|->
name|adapter
operator|=
name|device_find_child
argument_list|(
name|iicbus_dev
argument_list|,
literal|"iicbus"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2c
operator|->
name|adapter
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"hw i2c bridge doesn't have iicbus child\n"
argument_list|)
expr_stmt|;
name|device_delete_child
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|iicbus_dev
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
block|}
else|else
block|{
name|device_t
name|iicbb_dev
decl_stmt|;
comment|/* set the radeon bit adapter */
name|snprintf
argument_list|(
name|i2c
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|i2c
operator|->
name|name
argument_list|)
argument_list|,
literal|"Radeon i2c bit bus %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|iicbus_dev
operator|=
name|device_add_child
argument_list|(
name|dev
operator|->
name|device
argument_list|,
literal|"radeon_iicbb"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iicbus_dev
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to create bridge for bb i2c %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
name|device_quiet
argument_list|(
name|iicbus_dev
argument_list|)
expr_stmt|;
name|device_set_softc
argument_list|(
name|iicbus_dev
argument_list|,
name|i2c
argument_list|)
expr_stmt|;
name|ret
operator|=
name|device_probe_and_attach
argument_list|(
name|iicbus_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Attach failed for bridge for bb i2c %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|device_delete_child
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|iicbus_dev
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
name|iicbb_dev
operator|=
name|device_find_child
argument_list|(
name|iicbus_dev
argument_list|,
literal|"iicbb"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iicbb_dev
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bb i2c bridge doesn't have iicbb child\n"
argument_list|)
expr_stmt|;
name|device_delete_child
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|iicbus_dev
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
name|i2c
operator|->
name|adapter
operator|=
name|device_find_child
argument_list|(
name|iicbb_dev
argument_list|,
literal|"iicbus"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2c
operator|->
name|adapter
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bbbus bridge doesn't have iicbus grandchild\n"
argument_list|)
expr_stmt|;
name|device_delete_child
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|iicbus_dev
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
block|}
name|i2c
operator|->
name|iic_bus
operator|=
name|iicbus_dev
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
return|return
name|i2c
return|;
name|out_free
label|:
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|i2c
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|radeon_i2c_chan
modifier|*
name|radeon_i2c_create_dp
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|i2c
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_i2c_chan
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2c
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|i2c
operator|->
name|rec
operator|=
operator|*
name|rec
expr_stmt|;
name|i2c
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|snprintf
argument_list|(
name|i2c
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|i2c
operator|->
name|name
argument_list|)
argument_list|,
literal|"Radeon aux bus %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|iic_dp_aux_add_bus
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|i2c
operator|->
name|name
argument_list|,
name|radeon_dp_i2c_aux_ch
argument_list|,
name|i2c
argument_list|,
operator|&
name|i2c
operator|->
name|iic_bus
argument_list|,
operator|&
name|i2c
operator|->
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Failed to register i2c %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
return|return
name|i2c
return|;
name|out_free
label|:
name|free
argument_list|(
name|i2c
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|radeon_i2c_destroy
parameter_list|(
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c
parameter_list|)
block|{
if|if
condition|(
operator|!
name|i2c
condition|)
return|return;
if|if
condition|(
name|i2c
operator|->
name|iic_bus
operator|!=
name|NULL
condition|)
block|{
name|int
name|ret
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|ret
operator|=
name|device_delete_child
argument_list|(
name|i2c
operator|->
name|dev
operator|->
name|device
argument_list|,
name|i2c
operator|->
name|iic_bus
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ret
operator|==
literal|0
argument_list|,
operator|(
literal|"unable to detach iic bus %s: %d"
operator|,
name|i2c
operator|->
name|name
operator|,
name|ret
operator|)
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|i2c
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Add the default buses */
end_comment

begin_function
name|void
name|radeon_i2c_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_i2c_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_i2c_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* remove all the buses */
end_comment

begin_function
name|void
name|radeon_i2c_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_MAX_I2C_BUS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|i2c_bus
index|[
name|i
index|]
condition|)
block|{
name|radeon_i2c_destroy
argument_list|(
name|rdev
operator|->
name|i2c_bus
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|i2c_bus
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* Add additional buses */
end_comment

begin_function
name|void
name|radeon_i2c_add
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|rec
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_MAX_I2C_BUS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|i2c_bus
index|[
name|i
index|]
condition|)
block|{
name|rdev
operator|->
name|i2c_bus
index|[
name|i
index|]
operator|=
name|radeon_i2c_create
argument_list|(
name|dev
argument_list|,
name|rec
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
end_function

begin_comment
comment|/* looks up bus based on id */
end_comment

begin_function
name|struct
name|radeon_i2c_chan
modifier|*
name|radeon_i2c_lookup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|i2c_bus
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_MAX_I2C_BUS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|i2c_bus
index|[
name|i
index|]
operator|&&
operator|(
name|rdev
operator|->
name|i2c_bus
index|[
name|i
index|]
operator|->
name|rec
operator|.
name|i2c_id
operator|==
name|i2c_bus
operator|->
name|i2c_id
operator|)
condition|)
block|{
return|return
name|rdev
operator|->
name|i2c_bus
index|[
name|i
index|]
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|drm_encoder
modifier|*
name|radeon_best_encoder
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|radeon_i2c_get_byte
parameter_list|(
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c_bus
parameter_list|,
name|u8
name|slave_addr
parameter_list|,
name|u8
name|addr
parameter_list|,
name|u8
modifier|*
name|val
parameter_list|)
block|{
name|u8
name|out_buf
index|[
literal|2
index|]
decl_stmt|;
name|u8
name|in_buf
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|iic_msg
name|msgs
index|[]
init|=
block|{
block|{
operator|.
name|slave
operator|=
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
literal|0
block|,
operator|.
name|len
operator|=
literal|1
block|,
operator|.
name|buf
operator|=
name|out_buf
block|, 		}
block|,
block|{
operator|.
name|slave
operator|=
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
name|IIC_M_RD
block|,
operator|.
name|len
operator|=
literal|1
block|,
operator|.
name|buf
operator|=
name|in_buf
block|, 		}
block|}
decl_stmt|;
name|out_buf
index|[
literal|0
index|]
operator|=
name|addr
expr_stmt|;
name|out_buf
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iicbus_transfer
argument_list|(
name|i2c_bus
operator|->
name|adapter
argument_list|,
name|msgs
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|val
operator|=
name|in_buf
index|[
literal|0
index|]
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"val = 0x%02x\n"
argument_list|,
operator|*
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG
argument_list|(
literal|"i2c 0x%02x 0x%02x read failed\n"
argument_list|,
name|addr
argument_list|,
operator|*
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|radeon_i2c_put_byte
parameter_list|(
name|struct
name|radeon_i2c_chan
modifier|*
name|i2c_bus
parameter_list|,
name|u8
name|slave_addr
parameter_list|,
name|u8
name|addr
parameter_list|,
name|u8
name|val
parameter_list|)
block|{
name|uint8_t
name|out_buf
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|iic_msg
name|msg
init|=
block|{
operator|.
name|slave
operator|=
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
literal|0
block|,
operator|.
name|len
operator|=
literal|2
block|,
operator|.
name|buf
operator|=
name|out_buf
block|, 	}
decl_stmt|;
name|out_buf
index|[
literal|0
index|]
operator|=
name|addr
expr_stmt|;
name|out_buf
index|[
literal|1
index|]
operator|=
name|val
expr_stmt|;
if|if
condition|(
name|iicbus_transfer
argument_list|(
name|i2c_bus
operator|->
name|adapter
argument_list|,
operator|&
name|msg
argument_list|,
literal|1
argument_list|)
operator|!=
literal|0
condition|)
name|DRM_DEBUG
argument_list|(
literal|"i2c 0x%02x 0x%02x write failed\n"
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ddc router switching */
end_comment

begin_function
name|void
name|radeon_router_select_ddc_port
parameter_list|(
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
parameter_list|)
block|{
name|u8
name|val
decl_stmt|;
if|if
condition|(
operator|!
name|radeon_connector
operator|->
name|router
operator|.
name|ddc_valid
condition|)
return|return;
if|if
condition|(
operator|!
name|radeon_connector
operator|->
name|router_bus
condition|)
return|return;
name|radeon_i2c_get_byte
argument_list|(
name|radeon_connector
operator|->
name|router_bus
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|i2c_addr
argument_list|,
literal|0x3
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|radeon_connector
operator|->
name|router
operator|.
name|ddc_mux_control_pin
expr_stmt|;
name|radeon_i2c_put_byte
argument_list|(
name|radeon_connector
operator|->
name|router_bus
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|i2c_addr
argument_list|,
literal|0x3
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|radeon_i2c_get_byte
argument_list|(
name|radeon_connector
operator|->
name|router_bus
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|i2c_addr
argument_list|,
literal|0x1
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|radeon_connector
operator|->
name|router
operator|.
name|ddc_mux_control_pin
expr_stmt|;
name|val
operator||=
name|radeon_connector
operator|->
name|router
operator|.
name|ddc_mux_state
expr_stmt|;
name|radeon_i2c_put_byte
argument_list|(
name|radeon_connector
operator|->
name|router_bus
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|i2c_addr
argument_list|,
literal|0x1
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* clock/data router switching */
end_comment

begin_function
name|void
name|radeon_router_select_cd_port
parameter_list|(
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
parameter_list|)
block|{
name|u8
name|val
decl_stmt|;
if|if
condition|(
operator|!
name|radeon_connector
operator|->
name|router
operator|.
name|cd_valid
condition|)
return|return;
if|if
condition|(
operator|!
name|radeon_connector
operator|->
name|router_bus
condition|)
return|return;
name|radeon_i2c_get_byte
argument_list|(
name|radeon_connector
operator|->
name|router_bus
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|i2c_addr
argument_list|,
literal|0x3
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|radeon_connector
operator|->
name|router
operator|.
name|cd_mux_control_pin
expr_stmt|;
name|radeon_i2c_put_byte
argument_list|(
name|radeon_connector
operator|->
name|router_bus
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|i2c_addr
argument_list|,
literal|0x3
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|radeon_i2c_get_byte
argument_list|(
name|radeon_connector
operator|->
name|router_bus
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|i2c_addr
argument_list|,
literal|0x1
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|radeon_connector
operator|->
name|router
operator|.
name|cd_mux_control_pin
expr_stmt|;
name|val
operator||=
name|radeon_connector
operator|->
name|router
operator|.
name|cd_mux_state
expr_stmt|;
name|radeon_i2c_put_byte
argument_list|(
name|radeon_connector
operator|->
name|router_bus
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|i2c_addr
argument_list|,
literal|0x1
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


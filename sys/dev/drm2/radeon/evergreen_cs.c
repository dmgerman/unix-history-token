begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2010 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"evergreend.h"
end_include

begin_include
include|#
directive|include
file|"evergreen_reg_safe.h"
end_include

begin_include
include|#
directive|include
file|"cayman_reg_safe.h"
end_include

begin_include
include|#
directive|include
file|"r600_cs.h"
end_include

begin_define
define|#
directive|define
name|MAX
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(((a)>(b))?(a):(b))
end_define

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(((a)<(b))?(a):(b))
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|FREEBSD_WIP
end_ifdef

begin_comment
comment|/* FreeBSD: to please GCC 4.2. */
end_comment

begin_function_decl
name|int
name|r600_dma_cs_next_reloc
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_reloc
modifier|*
modifier|*
name|cs_reloc
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|evergreen_cs_packet_next_reloc
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_reloc
modifier|*
modifier|*
name|cs_reloc
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|evergreen_cs_track
block|{
name|u32
name|group_size
decl_stmt|;
name|u32
name|nbanks
decl_stmt|;
name|u32
name|npipes
decl_stmt|;
name|u32
name|row_size
decl_stmt|;
comment|/* value we track */
name|u32
name|nsamples
decl_stmt|;
comment|/* unused */
name|struct
name|radeon_bo
modifier|*
name|cb_color_bo
index|[
literal|12
index|]
decl_stmt|;
name|u32
name|cb_color_bo_offset
index|[
literal|12
index|]
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|cb_color_fmask_bo
index|[
literal|8
index|]
decl_stmt|;
comment|/* unused */
name|struct
name|radeon_bo
modifier|*
name|cb_color_cmask_bo
index|[
literal|8
index|]
decl_stmt|;
comment|/* unused */
name|u32
name|cb_color_info
index|[
literal|12
index|]
decl_stmt|;
name|u32
name|cb_color_view
index|[
literal|12
index|]
decl_stmt|;
name|u32
name|cb_color_pitch
index|[
literal|12
index|]
decl_stmt|;
name|u32
name|cb_color_slice
index|[
literal|12
index|]
decl_stmt|;
name|u32
name|cb_color_slice_idx
index|[
literal|12
index|]
decl_stmt|;
name|u32
name|cb_color_attrib
index|[
literal|12
index|]
decl_stmt|;
name|u32
name|cb_color_cmask_slice
index|[
literal|8
index|]
decl_stmt|;
comment|/* unused */
name|u32
name|cb_color_fmask_slice
index|[
literal|8
index|]
decl_stmt|;
comment|/* unused */
name|u32
name|cb_target_mask
decl_stmt|;
name|u32
name|cb_shader_mask
decl_stmt|;
comment|/* unused */
name|u32
name|vgt_strmout_config
decl_stmt|;
name|u32
name|vgt_strmout_buffer_config
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|vgt_strmout_bo
index|[
literal|4
index|]
decl_stmt|;
name|u32
name|vgt_strmout_bo_offset
index|[
literal|4
index|]
decl_stmt|;
name|u32
name|vgt_strmout_size
index|[
literal|4
index|]
decl_stmt|;
name|u32
name|db_depth_control
decl_stmt|;
name|u32
name|db_depth_view
decl_stmt|;
name|u32
name|db_depth_slice
decl_stmt|;
name|u32
name|db_depth_size
decl_stmt|;
name|u32
name|db_z_info
decl_stmt|;
name|u32
name|db_z_read_offset
decl_stmt|;
name|u32
name|db_z_write_offset
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|db_z_read_bo
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|db_z_write_bo
decl_stmt|;
name|u32
name|db_s_info
decl_stmt|;
name|u32
name|db_s_read_offset
decl_stmt|;
name|u32
name|db_s_write_offset
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|db_s_read_bo
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|db_s_write_bo
decl_stmt|;
name|bool
name|sx_misc_kill_all_prims
decl_stmt|;
name|bool
name|cb_dirty
decl_stmt|;
name|bool
name|db_dirty
decl_stmt|;
name|bool
name|streamout_dirty
decl_stmt|;
name|u32
name|htile_offset
decl_stmt|;
name|u32
name|htile_surface
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|htile_bo
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|u32
name|evergreen_cs_get_aray_mode
parameter_list|(
name|u32
name|tiling_flags
parameter_list|)
block|{
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
return|return
name|ARRAY_2D_TILED_THIN1
return|;
elseif|else
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
return|return
name|ARRAY_1D_TILED_THIN1
return|;
else|else
return|return
name|ARRAY_LINEAR_GENERAL
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|evergreen_cs_get_num_banks
parameter_list|(
name|u32
name|nbanks
parameter_list|)
block|{
switch|switch
condition|(
name|nbanks
condition|)
block|{
case|case
literal|2
case|:
return|return
name|ADDR_SURF_2_BANK
return|;
case|case
literal|4
case|:
return|return
name|ADDR_SURF_4_BANK
return|;
case|case
literal|8
case|:
default|default:
return|return
name|ADDR_SURF_8_BANK
return|;
case|case
literal|16
case|:
return|return
name|ADDR_SURF_16_BANK
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|evergreen_cs_track_init
parameter_list|(
name|struct
name|evergreen_cs_track
modifier|*
name|track
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|track
operator|->
name|cb_color_fmask_bo
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|cb_color_cmask_bo
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|cb_color_cmask_slice
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|cb_color_fmask_slice
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|12
condition|;
name|i
operator|++
control|)
block|{
name|track
operator|->
name|cb_color_bo
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|cb_color_bo_offset
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_color_info
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|cb_color_view
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_color_pitch
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|cb_color_slice
index|[
name|i
index|]
operator|=
literal|0xfffffff
expr_stmt|;
name|track
operator|->
name|cb_color_slice_idx
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|track
operator|->
name|cb_target_mask
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_shader_mask
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|db_depth_slice
operator|=
literal|0xffffffff
expr_stmt|;
name|track
operator|->
name|db_depth_view
operator|=
literal|0xFFFFC000
expr_stmt|;
name|track
operator|->
name|db_depth_size
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|db_depth_control
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|db_z_info
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|db_z_read_offset
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|db_z_write_offset
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|db_z_read_bo
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|db_z_write_bo
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|db_s_info
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|db_s_read_offset
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|db_s_write_offset
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|db_s_read_bo
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|db_s_write_bo
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|htile_bo
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|htile_offset
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|track
operator|->
name|htile_surface
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|track
operator|->
name|vgt_strmout_size
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|vgt_strmout_bo
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|vgt_strmout_bo_offset
index|[
name|i
index|]
operator|=
literal|0xFFFFFFFF
expr_stmt|;
block|}
name|track
operator|->
name|streamout_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|sx_misc_kill_all_prims
operator|=
name|false
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|eg_surface
block|{
comment|/* value gathered from cs */
name|unsigned
name|nbx
decl_stmt|;
name|unsigned
name|nby
decl_stmt|;
name|unsigned
name|format
decl_stmt|;
name|unsigned
name|mode
decl_stmt|;
name|unsigned
name|nbanks
decl_stmt|;
name|unsigned
name|bankw
decl_stmt|;
name|unsigned
name|bankh
decl_stmt|;
name|unsigned
name|tsplit
decl_stmt|;
name|unsigned
name|mtilea
decl_stmt|;
name|unsigned
name|nsamples
decl_stmt|;
comment|/* output value */
name|unsigned
name|bpe
decl_stmt|;
name|unsigned
name|layer_size
decl_stmt|;
name|unsigned
name|palign
decl_stmt|;
name|unsigned
name|halign
decl_stmt|;
name|unsigned
name|long
name|base_align
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|evergreen_surface_check_linear
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|eg_surface
modifier|*
name|surf
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|surf
operator|->
name|layer_size
operator|=
name|surf
operator|->
name|nbx
operator|*
name|surf
operator|->
name|nby
operator|*
name|surf
operator|->
name|bpe
operator|*
name|surf
operator|->
name|nsamples
expr_stmt|;
name|surf
operator|->
name|base_align
operator|=
name|surf
operator|->
name|bpe
expr_stmt|;
name|surf
operator|->
name|palign
operator|=
literal|1
expr_stmt|;
name|surf
operator|->
name|halign
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_surface_check_linear_aligned
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|eg_surface
modifier|*
name|surf
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|struct
name|evergreen_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|unsigned
name|palign
decl_stmt|;
name|palign
operator|=
name|MAX
argument_list|(
literal|64
argument_list|,
name|track
operator|->
name|group_size
operator|/
name|surf
operator|->
name|bpe
argument_list|)
expr_stmt|;
name|surf
operator|->
name|layer_size
operator|=
name|surf
operator|->
name|nbx
operator|*
name|surf
operator|->
name|nby
operator|*
name|surf
operator|->
name|bpe
operator|*
name|surf
operator|->
name|nsamples
expr_stmt|;
name|surf
operator|->
name|base_align
operator|=
name|track
operator|->
name|group_size
expr_stmt|;
name|surf
operator|->
name|palign
operator|=
name|palign
expr_stmt|;
name|surf
operator|->
name|halign
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|surf
operator|->
name|nbx
operator|&
operator|(
name|palign
operator|-
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|prefix
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s pitch %d invalid must be aligned with %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|nbx
argument_list|,
name|palign
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_surface_check_1d
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|eg_surface
modifier|*
name|surf
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|struct
name|evergreen_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|unsigned
name|palign
decl_stmt|;
name|palign
operator|=
name|track
operator|->
name|group_size
operator|/
operator|(
literal|8
operator|*
name|surf
operator|->
name|bpe
operator|*
name|surf
operator|->
name|nsamples
operator|)
expr_stmt|;
name|palign
operator|=
name|MAX
argument_list|(
literal|8
argument_list|,
name|palign
argument_list|)
expr_stmt|;
name|surf
operator|->
name|layer_size
operator|=
name|surf
operator|->
name|nbx
operator|*
name|surf
operator|->
name|nby
operator|*
name|surf
operator|->
name|bpe
expr_stmt|;
name|surf
operator|->
name|base_align
operator|=
name|track
operator|->
name|group_size
expr_stmt|;
name|surf
operator|->
name|palign
operator|=
name|palign
expr_stmt|;
name|surf
operator|->
name|halign
operator|=
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|surf
operator|->
name|nbx
operator|&
operator|(
name|palign
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|prefix
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s pitch %d invalid must be aligned with %d (%d %d %d)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|nbx
argument_list|,
name|palign
argument_list|,
name|track
operator|->
name|group_size
argument_list|,
name|surf
operator|->
name|bpe
argument_list|,
name|surf
operator|->
name|nsamples
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|surf
operator|->
name|nby
operator|&
operator|(
literal|8
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|prefix
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s height %d invalid must be aligned with 8\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|nby
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_surface_check_2d
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|eg_surface
modifier|*
name|surf
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|struct
name|evergreen_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|unsigned
name|palign
decl_stmt|,
name|halign
decl_stmt|,
name|tileb
decl_stmt|,
name|slice_pt
decl_stmt|;
name|unsigned
name|mtile_pr
decl_stmt|,
name|mtile_ps
decl_stmt|,
name|mtileb
decl_stmt|;
name|tileb
operator|=
literal|64
operator|*
name|surf
operator|->
name|bpe
operator|*
name|surf
operator|->
name|nsamples
expr_stmt|;
name|slice_pt
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tileb
operator|>
name|surf
operator|->
name|tsplit
condition|)
block|{
name|slice_pt
operator|=
name|tileb
operator|/
name|surf
operator|->
name|tsplit
expr_stmt|;
block|}
name|tileb
operator|=
name|tileb
operator|/
name|slice_pt
expr_stmt|;
comment|/* macro tile width& height */
name|palign
operator|=
operator|(
literal|8
operator|*
name|surf
operator|->
name|bankw
operator|*
name|track
operator|->
name|npipes
operator|)
operator|*
name|surf
operator|->
name|mtilea
expr_stmt|;
name|halign
operator|=
operator|(
literal|8
operator|*
name|surf
operator|->
name|bankh
operator|*
name|surf
operator|->
name|nbanks
operator|)
operator|/
name|surf
operator|->
name|mtilea
expr_stmt|;
name|mtileb
operator|=
operator|(
name|palign
operator|/
literal|8
operator|)
operator|*
operator|(
name|halign
operator|/
literal|8
operator|)
operator|*
name|tileb
expr_stmt|;
name|mtile_pr
operator|=
name|surf
operator|->
name|nbx
operator|/
name|palign
expr_stmt|;
name|mtile_ps
operator|=
operator|(
name|mtile_pr
operator|*
name|surf
operator|->
name|nby
operator|)
operator|/
name|halign
expr_stmt|;
name|surf
operator|->
name|layer_size
operator|=
name|mtile_ps
operator|*
name|mtileb
operator|*
name|slice_pt
expr_stmt|;
name|surf
operator|->
name|base_align
operator|=
operator|(
name|palign
operator|/
literal|8
operator|)
operator|*
operator|(
name|halign
operator|/
literal|8
operator|)
operator|*
name|tileb
expr_stmt|;
name|surf
operator|->
name|palign
operator|=
name|palign
expr_stmt|;
name|surf
operator|->
name|halign
operator|=
name|halign
expr_stmt|;
if|if
condition|(
operator|(
name|surf
operator|->
name|nbx
operator|&
operator|(
name|palign
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|prefix
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s pitch %d invalid must be aligned with %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|nbx
argument_list|,
name|palign
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|surf
operator|->
name|nby
operator|&
operator|(
name|halign
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|prefix
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s height %d invalid must be aligned with %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|nby
argument_list|,
name|halign
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_surface_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|eg_surface
modifier|*
name|surf
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
comment|/* some common value computed here */
name|surf
operator|->
name|bpe
operator|=
name|r600_fmt_get_blocksize
argument_list|(
name|surf
operator|->
name|format
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|surf
operator|->
name|mode
condition|)
block|{
case|case
name|ARRAY_LINEAR_GENERAL
case|:
return|return
name|evergreen_surface_check_linear
argument_list|(
name|p
argument_list|,
name|surf
argument_list|,
name|prefix
argument_list|)
return|;
case|case
name|ARRAY_LINEAR_ALIGNED
case|:
return|return
name|evergreen_surface_check_linear_aligned
argument_list|(
name|p
argument_list|,
name|surf
argument_list|,
name|prefix
argument_list|)
return|;
case|case
name|ARRAY_1D_TILED_THIN1
case|:
return|return
name|evergreen_surface_check_1d
argument_list|(
name|p
argument_list|,
name|surf
argument_list|,
name|prefix
argument_list|)
return|;
case|case
name|ARRAY_2D_TILED_THIN1
case|:
return|return
name|evergreen_surface_check_2d
argument_list|(
name|p
argument_list|,
name|surf
argument_list|,
name|prefix
argument_list|)
return|;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s invalid array mode %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_surface_value_conv_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|eg_surface
modifier|*
name|surf
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
switch|switch
condition|(
name|surf
operator|->
name|mode
condition|)
block|{
case|case
name|ARRAY_2D_TILED_THIN1
case|:
break|break;
case|case
name|ARRAY_LINEAR_GENERAL
case|:
case|case
name|ARRAY_LINEAR_ALIGNED
case|:
case|case
name|ARRAY_1D_TILED_THIN1
case|:
return|return
literal|0
return|;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s invalid array mode %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|surf
operator|->
name|nbanks
condition|)
block|{
case|case
literal|0
case|:
name|surf
operator|->
name|nbanks
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|surf
operator|->
name|nbanks
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|surf
operator|->
name|nbanks
operator|=
literal|8
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|surf
operator|->
name|nbanks
operator|=
literal|16
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s invalid number of banks %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|nbanks
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|surf
operator|->
name|bankw
condition|)
block|{
case|case
literal|0
case|:
name|surf
operator|->
name|bankw
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|surf
operator|->
name|bankw
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|surf
operator|->
name|bankw
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|surf
operator|->
name|bankw
operator|=
literal|8
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s invalid bankw %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|bankw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|surf
operator|->
name|bankh
condition|)
block|{
case|case
literal|0
case|:
name|surf
operator|->
name|bankh
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|surf
operator|->
name|bankh
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|surf
operator|->
name|bankh
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|surf
operator|->
name|bankh
operator|=
literal|8
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s invalid bankh %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|bankh
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|surf
operator|->
name|mtilea
condition|)
block|{
case|case
literal|0
case|:
name|surf
operator|->
name|mtilea
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|surf
operator|->
name|mtilea
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|surf
operator|->
name|mtilea
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|surf
operator|->
name|mtilea
operator|=
literal|8
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s invalid macro tile aspect %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|mtilea
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|surf
operator|->
name|tsplit
condition|)
block|{
case|case
literal|0
case|:
name|surf
operator|->
name|tsplit
operator|=
literal|64
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|surf
operator|->
name|tsplit
operator|=
literal|128
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|surf
operator|->
name|tsplit
operator|=
literal|256
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|surf
operator|->
name|tsplit
operator|=
literal|512
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|surf
operator|->
name|tsplit
operator|=
literal|1024
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|surf
operator|->
name|tsplit
operator|=
literal|2048
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|surf
operator|->
name|tsplit
operator|=
literal|4096
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d %s invalid tile split %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|prefix
argument_list|,
name|surf
operator|->
name|tsplit
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_cs_track_validate_cb
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|unsigned
name|id
parameter_list|)
block|{
name|struct
name|evergreen_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|struct
name|eg_surface
name|surf
decl_stmt|;
name|unsigned
name|pitch
decl_stmt|,
name|slice
decl_stmt|,
name|mslice
decl_stmt|;
name|unsigned
name|long
name|offset
decl_stmt|;
name|int
name|r
decl_stmt|;
name|mslice
operator|=
name|G_028C6C_SLICE_MAX
argument_list|(
name|track
operator|->
name|cb_color_view
index|[
name|id
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|pitch
operator|=
name|track
operator|->
name|cb_color_pitch
index|[
name|id
index|]
expr_stmt|;
name|slice
operator|=
name|track
operator|->
name|cb_color_slice
index|[
name|id
index|]
expr_stmt|;
name|surf
operator|.
name|nbx
operator|=
operator|(
name|pitch
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|surf
operator|.
name|nby
operator|=
operator|(
operator|(
name|slice
operator|+
literal|1
operator|)
operator|*
literal|64
operator|)
operator|/
name|surf
operator|.
name|nbx
expr_stmt|;
name|surf
operator|.
name|mode
operator|=
name|G_028C70_ARRAY_MODE
argument_list|(
name|track
operator|->
name|cb_color_info
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|format
operator|=
name|G_028C70_FORMAT
argument_list|(
name|track
operator|->
name|cb_color_info
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|tsplit
operator|=
name|G_028C74_TILE_SPLIT
argument_list|(
name|track
operator|->
name|cb_color_attrib
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nbanks
operator|=
name|G_028C74_NUM_BANKS
argument_list|(
name|track
operator|->
name|cb_color_attrib
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|bankw
operator|=
name|G_028C74_BANK_WIDTH
argument_list|(
name|track
operator|->
name|cb_color_attrib
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|bankh
operator|=
name|G_028C74_BANK_HEIGHT
argument_list|(
name|track
operator|->
name|cb_color_attrib
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|mtilea
operator|=
name|G_028C74_MACRO_TILE_ASPECT
argument_list|(
name|track
operator|->
name|cb_color_attrib
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nsamples
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|r600_fmt_is_valid_color
argument_list|(
name|surf
operator|.
name|format
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d cb invalid format %d for %d (0x%08x)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|format
argument_list|,
name|id
argument_list|,
name|track
operator|->
name|cb_color_info
index|[
name|id
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_surface_value_conv_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
literal|"cb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
name|r
operator|=
name|evergreen_surface_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
literal|"cb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d cb[%d] invalid (0x%08x 0x%08x 0x%08x 0x%08x)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|id
argument_list|,
name|track
operator|->
name|cb_color_pitch
index|[
name|id
index|]
argument_list|,
name|track
operator|->
name|cb_color_slice
index|[
name|id
index|]
argument_list|,
name|track
operator|->
name|cb_color_attrib
index|[
name|id
index|]
argument_list|,
name|track
operator|->
name|cb_color_info
index|[
name|id
index|]
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|offset
operator|=
name|track
operator|->
name|cb_color_bo_offset
index|[
name|id
index|]
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|offset
operator|&
operator|(
name|surf
operator|.
name|base_align
operator|-
literal|1
operator|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d cb[%d] bo base %ld not aligned with %ld\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|id
argument_list|,
name|offset
argument_list|,
name|surf
operator|.
name|base_align
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|surf
operator|.
name|layer_size
operator|*
name|mslice
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb_color_bo
index|[
name|id
index|]
argument_list|)
condition|)
block|{
comment|/* old ddx are broken they allocate bo with w*h*bpp but 		 * program slice with ALIGN(h, 8), catch this and patch 		 * command stream. 		 */
if|if
condition|(
operator|!
name|surf
operator|.
name|mode
condition|)
block|{
specifier|volatile
name|u32
modifier|*
name|ib
init|=
name|p
operator|->
name|ib
operator|.
name|ptr
decl_stmt|;
name|unsigned
name|long
name|tmp
decl_stmt|,
name|nby
decl_stmt|,
name|bsize
decl_stmt|,
name|size
decl_stmt|,
name|min
init|=
literal|0
decl_stmt|;
comment|/* find the height the ddx wants */
if|if
condition|(
name|surf
operator|.
name|nby
operator|>
literal|8
condition|)
block|{
name|min
operator|=
name|surf
operator|.
name|nby
operator|-
literal|8
expr_stmt|;
block|}
name|bsize
operator|=
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb_color_bo
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|track
operator|->
name|cb_color_bo_offset
index|[
name|id
index|]
operator|<<
literal|8
expr_stmt|;
for|for
control|(
name|nby
operator|=
name|surf
operator|.
name|nby
init|;
name|nby
operator|>
name|min
condition|;
name|nby
operator|--
control|)
block|{
name|size
operator|=
name|nby
operator|*
name|surf
operator|.
name|nbx
operator|*
name|surf
operator|.
name|bpe
operator|*
name|surf
operator|.
name|nsamples
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|+
name|size
operator|*
name|mslice
operator|)
operator|<=
name|bsize
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|nby
operator|>
name|min
condition|)
block|{
name|surf
operator|.
name|nby
operator|=
name|nby
expr_stmt|;
name|slice
operator|=
operator|(
operator|(
name|nby
operator|*
name|surf
operator|.
name|nbx
operator|)
operator|/
literal|64
operator|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|evergreen_surface_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
literal|"cb"
argument_list|)
condition|)
block|{
comment|/* check if this one works */
name|tmp
operator|+=
name|surf
operator|.
name|layer_size
operator|*
name|mslice
expr_stmt|;
if|if
condition|(
name|tmp
operator|<=
name|bsize
condition|)
block|{
name|ib
index|[
name|track
operator|->
name|cb_color_slice_idx
index|[
name|id
index|]
index|]
operator|=
name|slice
expr_stmt|;
goto|goto
name|old_ddx_ok
goto|;
block|}
block|}
block|}
block|}
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d cb[%d] bo too small (layer size %d, "
literal|"offset %d, max layer %d, bo size %ld, slice %d)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|id
argument_list|,
name|surf
operator|.
name|layer_size
argument_list|,
name|track
operator|->
name|cb_color_bo_offset
index|[
name|id
index|]
operator|<<
literal|8
argument_list|,
name|mslice
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb_color_bo
index|[
name|id
index|]
argument_list|)
argument_list|,
name|slice
argument_list|)
expr_stmt|;
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d problematic surf: (%d %d) (%d %d %d %d %d %d %d)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|nbx
argument_list|,
name|surf
operator|.
name|nby
argument_list|,
name|surf
operator|.
name|mode
argument_list|,
name|surf
operator|.
name|bpe
argument_list|,
name|surf
operator|.
name|nsamples
argument_list|,
name|surf
operator|.
name|bankw
argument_list|,
name|surf
operator|.
name|bankh
argument_list|,
name|surf
operator|.
name|tsplit
argument_list|,
name|surf
operator|.
name|mtilea
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|old_ddx_ok
label|:
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_cs_track_validate_htile
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|unsigned
name|nbx
parameter_list|,
name|unsigned
name|nby
parameter_list|)
block|{
name|struct
name|evergreen_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|unsigned
name|long
name|size
decl_stmt|;
if|if
condition|(
name|track
operator|->
name|htile_bo
operator|==
name|NULL
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d htile enabled without htile surface 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|G_028ABC_LINEAR
argument_list|(
name|track
operator|->
name|htile_surface
argument_list|)
condition|)
block|{
comment|/* pitch must be 16 htiles aligned == 16 * 8 pixel aligned */
name|nbx
operator|=
name|roundup
argument_list|(
name|nbx
argument_list|,
literal|16
operator|*
literal|8
argument_list|)
expr_stmt|;
comment|/* height is npipes htiles aligned == npipes * 8 pixel aligned */
name|nby
operator|=
name|roundup
argument_list|(
name|nby
argument_list|,
name|track
operator|->
name|npipes
operator|*
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* always assume 8x8 htile */
comment|/* align is htile align * 8, htile align vary according to 		 * number of pipe and tile width and nby 		 */
switch|switch
condition|(
name|track
operator|->
name|npipes
condition|)
block|{
case|case
literal|8
case|:
comment|/* HTILE_WIDTH = 8& HTILE_HEIGHT = 8*/
name|nbx
operator|=
name|roundup
argument_list|(
name|nbx
argument_list|,
literal|64
operator|*
literal|8
argument_list|)
expr_stmt|;
name|nby
operator|=
name|roundup
argument_list|(
name|nby
argument_list|,
literal|64
operator|*
literal|8
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* HTILE_WIDTH = 8& HTILE_HEIGHT = 8*/
name|nbx
operator|=
name|roundup
argument_list|(
name|nbx
argument_list|,
literal|64
operator|*
literal|8
argument_list|)
expr_stmt|;
name|nby
operator|=
name|roundup
argument_list|(
name|nby
argument_list|,
literal|32
operator|*
literal|8
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* HTILE_WIDTH = 8& HTILE_HEIGHT = 8*/
name|nbx
operator|=
name|roundup
argument_list|(
name|nbx
argument_list|,
literal|32
operator|*
literal|8
argument_list|)
expr_stmt|;
name|nby
operator|=
name|roundup
argument_list|(
name|nby
argument_list|,
literal|32
operator|*
literal|8
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* HTILE_WIDTH = 8& HTILE_HEIGHT = 8*/
name|nbx
operator|=
name|roundup
argument_list|(
name|nbx
argument_list|,
literal|32
operator|*
literal|8
argument_list|)
expr_stmt|;
name|nby
operator|=
name|roundup
argument_list|(
name|nby
argument_list|,
literal|16
operator|*
literal|8
argument_list|)
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid num pipes %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|npipes
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
comment|/* compute number of htile */
name|nbx
operator|=
name|nbx
operator|>>
literal|3
expr_stmt|;
name|nby
operator|=
name|nby
operator|>>
literal|3
expr_stmt|;
comment|/* size must be aligned on npipes * 2K boundary */
name|size
operator|=
name|roundup
argument_list|(
name|nbx
operator|*
name|nby
operator|*
literal|4
argument_list|,
name|track
operator|->
name|npipes
operator|*
operator|(
literal|2
operator|<<
literal|10
operator|)
argument_list|)
expr_stmt|;
name|size
operator|+=
name|track
operator|->
name|htile_offset
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|htile_bo
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d htile surface too small %ld for %ld (%d %d)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|htile_bo
argument_list|)
argument_list|,
name|size
argument_list|,
name|nbx
argument_list|,
name|nby
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_cs_track_validate_stencil
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|evergreen_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|struct
name|eg_surface
name|surf
decl_stmt|;
name|unsigned
name|pitch
decl_stmt|,
name|slice
decl_stmt|,
name|mslice
decl_stmt|;
name|unsigned
name|long
name|offset
decl_stmt|;
name|int
name|r
decl_stmt|;
name|mslice
operator|=
name|G_028008_SLICE_MAX
argument_list|(
name|track
operator|->
name|db_depth_view
argument_list|)
operator|+
literal|1
expr_stmt|;
name|pitch
operator|=
name|G_028058_PITCH_TILE_MAX
argument_list|(
name|track
operator|->
name|db_depth_size
argument_list|)
expr_stmt|;
name|slice
operator|=
name|track
operator|->
name|db_depth_slice
expr_stmt|;
name|surf
operator|.
name|nbx
operator|=
operator|(
name|pitch
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|surf
operator|.
name|nby
operator|=
operator|(
operator|(
name|slice
operator|+
literal|1
operator|)
operator|*
literal|64
operator|)
operator|/
name|surf
operator|.
name|nbx
expr_stmt|;
name|surf
operator|.
name|mode
operator|=
name|G_028040_ARRAY_MODE
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|format
operator|=
name|G_028044_FORMAT
argument_list|(
name|track
operator|->
name|db_s_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|tsplit
operator|=
name|G_028044_TILE_SPLIT
argument_list|(
name|track
operator|->
name|db_s_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nbanks
operator|=
name|G_028040_NUM_BANKS
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|bankw
operator|=
name|G_028040_BANK_WIDTH
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|bankh
operator|=
name|G_028040_BANK_HEIGHT
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|mtilea
operator|=
name|G_028040_MACRO_TILE_ASPECT
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nsamples
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|surf
operator|.
name|format
operator|!=
literal|1
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d stencil invalid format %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|format
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* replace by color format so we can use same code */
name|surf
operator|.
name|format
operator|=
name|V_028C70_COLOR_8
expr_stmt|;
name|r
operator|=
name|evergreen_surface_value_conv_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
literal|"stencil"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
name|r
operator|=
name|evergreen_surface_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
comment|/* old userspace doesn't compute proper depth/stencil alignment 		 * check that alignment against a bigger byte per elements and 		 * only report if that alignment is wrong too. 		 */
name|surf
operator|.
name|format
operator|=
name|V_028C70_COLOR_8_8_8_8
expr_stmt|;
name|r
operator|=
name|evergreen_surface_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
literal|"stencil"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d stencil invalid (0x%08x 0x%08x 0x%08x 0x%08x)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|db_depth_size
argument_list|,
name|track
operator|->
name|db_depth_slice
argument_list|,
name|track
operator|->
name|db_s_info
argument_list|,
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
name|offset
operator|=
name|track
operator|->
name|db_s_read_offset
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|offset
operator|&
operator|(
name|surf
operator|.
name|base_align
operator|-
literal|1
operator|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d stencil read bo base %ld not aligned with %ld\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|offset
argument_list|,
name|surf
operator|.
name|base_align
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|surf
operator|.
name|layer_size
operator|*
name|mslice
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_s_read_bo
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d stencil read bo too small (layer size %d, "
literal|"offset %ld, max layer %d, bo size %ld)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|layer_size
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|track
operator|->
name|db_s_read_offset
operator|<<
literal|8
argument_list|,
name|mslice
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_s_read_bo
argument_list|)
argument_list|)
expr_stmt|;
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d stencil invalid (0x%08x 0x%08x 0x%08x 0x%08x)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|db_depth_size
argument_list|,
name|track
operator|->
name|db_depth_slice
argument_list|,
name|track
operator|->
name|db_s_info
argument_list|,
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|track
operator|->
name|db_s_write_offset
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|offset
operator|&
operator|(
name|surf
operator|.
name|base_align
operator|-
literal|1
operator|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d stencil write bo base %ld not aligned with %ld\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|offset
argument_list|,
name|surf
operator|.
name|base_align
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|surf
operator|.
name|layer_size
operator|*
name|mslice
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_s_write_bo
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d stencil write bo too small (layer size %d, "
literal|"offset %ld, max layer %d, bo size %ld)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|layer_size
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|track
operator|->
name|db_s_write_offset
operator|<<
literal|8
argument_list|,
name|mslice
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_s_write_bo
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* hyperz */
if|if
condition|(
name|G_028040_TILE_SURFACE_ENABLE
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
condition|)
block|{
name|r
operator|=
name|evergreen_cs_track_validate_htile
argument_list|(
name|p
argument_list|,
name|surf
operator|.
name|nbx
argument_list|,
name|surf
operator|.
name|nby
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_cs_track_validate_depth
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|evergreen_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|struct
name|eg_surface
name|surf
decl_stmt|;
name|unsigned
name|pitch
decl_stmt|,
name|slice
decl_stmt|,
name|mslice
decl_stmt|;
name|unsigned
name|long
name|offset
decl_stmt|;
name|int
name|r
decl_stmt|;
name|mslice
operator|=
name|G_028008_SLICE_MAX
argument_list|(
name|track
operator|->
name|db_depth_view
argument_list|)
operator|+
literal|1
expr_stmt|;
name|pitch
operator|=
name|G_028058_PITCH_TILE_MAX
argument_list|(
name|track
operator|->
name|db_depth_size
argument_list|)
expr_stmt|;
name|slice
operator|=
name|track
operator|->
name|db_depth_slice
expr_stmt|;
name|surf
operator|.
name|nbx
operator|=
operator|(
name|pitch
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|surf
operator|.
name|nby
operator|=
operator|(
operator|(
name|slice
operator|+
literal|1
operator|)
operator|*
literal|64
operator|)
operator|/
name|surf
operator|.
name|nbx
expr_stmt|;
name|surf
operator|.
name|mode
operator|=
name|G_028040_ARRAY_MODE
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|format
operator|=
name|G_028040_FORMAT
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|tsplit
operator|=
name|G_028040_TILE_SPLIT
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nbanks
operator|=
name|G_028040_NUM_BANKS
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|bankw
operator|=
name|G_028040_BANK_WIDTH
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|bankh
operator|=
name|G_028040_BANK_HEIGHT
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|mtilea
operator|=
name|G_028040_MACRO_TILE_ASPECT
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nsamples
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|surf
operator|.
name|format
condition|)
block|{
case|case
name|V_028040_Z_16
case|:
name|surf
operator|.
name|format
operator|=
name|V_028C70_COLOR_16
expr_stmt|;
break|break;
case|case
name|V_028040_Z_24
case|:
case|case
name|V_028040_Z_32_FLOAT
case|:
name|surf
operator|.
name|format
operator|=
name|V_028C70_COLOR_8_8_8_8
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d depth invalid format %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|format
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_surface_value_conv_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
literal|"depth"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d depth invalid (0x%08x 0x%08x 0x%08x)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|db_depth_size
argument_list|,
name|track
operator|->
name|db_depth_slice
argument_list|,
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|evergreen_surface_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
literal|"depth"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d depth invalid (0x%08x 0x%08x 0x%08x)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|db_depth_size
argument_list|,
name|track
operator|->
name|db_depth_slice
argument_list|,
name|track
operator|->
name|db_z_info
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|offset
operator|=
name|track
operator|->
name|db_z_read_offset
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|offset
operator|&
operator|(
name|surf
operator|.
name|base_align
operator|-
literal|1
operator|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d stencil read bo base %ld not aligned with %ld\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|offset
argument_list|,
name|surf
operator|.
name|base_align
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|surf
operator|.
name|layer_size
operator|*
name|mslice
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_z_read_bo
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d depth read bo too small (layer size %d, "
literal|"offset %ld, max layer %d, bo size %ld)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|layer_size
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|track
operator|->
name|db_z_read_offset
operator|<<
literal|8
argument_list|,
name|mslice
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_z_read_bo
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|track
operator|->
name|db_z_write_offset
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|offset
operator|&
operator|(
name|surf
operator|.
name|base_align
operator|-
literal|1
operator|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d stencil write bo base %ld not aligned with %ld\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|offset
argument_list|,
name|surf
operator|.
name|base_align
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|surf
operator|.
name|layer_size
operator|*
name|mslice
expr_stmt|;
if|if
condition|(
name|offset
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_z_write_bo
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d depth write bo too small (layer size %d, "
literal|"offset %ld, max layer %d, bo size %ld)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|layer_size
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|track
operator|->
name|db_z_write_offset
operator|<<
literal|8
argument_list|,
name|mslice
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|db_z_write_bo
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* hyperz */
if|if
condition|(
name|G_028040_TILE_SURFACE_ENABLE
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
condition|)
block|{
name|r
operator|=
name|evergreen_cs_track_validate_htile
argument_list|(
name|p
argument_list|,
name|surf
operator|.
name|nbx
argument_list|,
name|surf
operator|.
name|nby
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_cs_track_validate_texture
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_bo
modifier|*
name|texture
parameter_list|,
name|struct
name|radeon_bo
modifier|*
name|mipmap
parameter_list|,
name|unsigned
name|idx
parameter_list|)
block|{
name|struct
name|eg_surface
name|surf
decl_stmt|;
name|unsigned
name|long
name|toffset
decl_stmt|,
name|moffset
decl_stmt|;
name|unsigned
name|dim
decl_stmt|,
name|llevel
decl_stmt|,
name|mslice
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|,
name|depth
decl_stmt|,
name|i
decl_stmt|;
name|u32
name|texdw
index|[
literal|8
index|]
decl_stmt|;
name|int
name|r
decl_stmt|;
name|texdw
index|[
literal|0
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|0
argument_list|)
expr_stmt|;
name|texdw
index|[
literal|1
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|texdw
index|[
literal|2
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
name|texdw
index|[
literal|3
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
expr_stmt|;
name|texdw
index|[
literal|4
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
expr_stmt|;
name|texdw
index|[
literal|5
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|5
argument_list|)
expr_stmt|;
name|texdw
index|[
literal|6
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|6
argument_list|)
expr_stmt|;
name|texdw
index|[
literal|7
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|7
argument_list|)
expr_stmt|;
name|dim
operator|=
name|G_030000_DIM
argument_list|(
name|texdw
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|llevel
operator|=
name|G_030014_LAST_LEVEL
argument_list|(
name|texdw
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|mslice
operator|=
name|G_030014_LAST_ARRAY
argument_list|(
name|texdw
index|[
literal|5
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|width
operator|=
name|G_030000_TEX_WIDTH
argument_list|(
name|texdw
index|[
literal|0
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|height
operator|=
name|G_030004_TEX_HEIGHT
argument_list|(
name|texdw
index|[
literal|1
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|depth
operator|=
name|G_030004_TEX_DEPTH
argument_list|(
name|texdw
index|[
literal|1
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|surf
operator|.
name|format
operator|=
name|G_03001C_DATA_FORMAT
argument_list|(
name|texdw
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nbx
operator|=
operator|(
name|G_030000_PITCH
argument_list|(
name|texdw
index|[
literal|0
index|]
argument_list|)
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|surf
operator|.
name|nbx
operator|=
name|r600_fmt_get_nblocksx
argument_list|(
name|surf
operator|.
name|format
argument_list|,
name|surf
operator|.
name|nbx
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nby
operator|=
name|r600_fmt_get_nblocksy
argument_list|(
name|surf
operator|.
name|format
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|surf
operator|.
name|mode
operator|=
name|G_030004_ARRAY_MODE
argument_list|(
name|texdw
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|tsplit
operator|=
name|G_030018_TILE_SPLIT
argument_list|(
name|texdw
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nbanks
operator|=
name|G_03001C_NUM_BANKS
argument_list|(
name|texdw
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|bankw
operator|=
name|G_03001C_BANK_WIDTH
argument_list|(
name|texdw
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|bankh
operator|=
name|G_03001C_BANK_HEIGHT
argument_list|(
name|texdw
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|mtilea
operator|=
name|G_03001C_MACRO_TILE_ASPECT
argument_list|(
name|texdw
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nsamples
operator|=
literal|1
expr_stmt|;
name|toffset
operator|=
name|texdw
index|[
literal|2
index|]
operator|<<
literal|8
expr_stmt|;
name|moffset
operator|=
name|texdw
index|[
literal|3
index|]
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
operator|!
name|r600_fmt_is_valid_texture
argument_list|(
name|surf
operator|.
name|format
argument_list|,
name|p
operator|->
name|family
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d texture invalid format %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|format
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|dim
condition|)
block|{
case|case
name|V_030000_SQ_TEX_DIM_1D
case|:
case|case
name|V_030000_SQ_TEX_DIM_2D
case|:
case|case
name|V_030000_SQ_TEX_DIM_CUBEMAP
case|:
case|case
name|V_030000_SQ_TEX_DIM_1D_ARRAY
case|:
case|case
name|V_030000_SQ_TEX_DIM_2D_ARRAY
case|:
name|depth
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|V_030000_SQ_TEX_DIM_2D_MSAA
case|:
case|case
name|V_030000_SQ_TEX_DIM_2D_ARRAY_MSAA
case|:
name|surf
operator|.
name|nsamples
operator|=
literal|1
operator|<<
name|llevel
expr_stmt|;
name|llevel
operator|=
literal|0
expr_stmt|;
name|depth
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|V_030000_SQ_TEX_DIM_3D
case|:
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d texture invalid dimension %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|dim
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_surface_value_conv_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
literal|"texture"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
comment|/* align height */
name|evergreen_surface_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nby
operator|=
name|roundup
argument_list|(
name|surf
operator|.
name|nby
argument_list|,
name|surf
operator|.
name|halign
argument_list|)
expr_stmt|;
name|r
operator|=
name|evergreen_surface_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
literal|"texture"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d texture invalid 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|texdw
index|[
literal|0
index|]
argument_list|,
name|texdw
index|[
literal|1
index|]
argument_list|,
name|texdw
index|[
literal|4
index|]
argument_list|,
name|texdw
index|[
literal|5
index|]
argument_list|,
name|texdw
index|[
literal|6
index|]
argument_list|,
name|texdw
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* check texture size */
if|if
condition|(
name|toffset
operator|&
operator|(
name|surf
operator|.
name|base_align
operator|-
literal|1
operator|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d texture bo base %ld not aligned with %ld\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|toffset
argument_list|,
name|surf
operator|.
name|base_align
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|moffset
operator|&
operator|(
name|surf
operator|.
name|base_align
operator|-
literal|1
operator|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d mipmap bo base %ld not aligned with %ld\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|moffset
argument_list|,
name|surf
operator|.
name|base_align
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|dim
operator|==
name|SQ_TEX_DIM_3D
condition|)
block|{
name|toffset
operator|+=
name|surf
operator|.
name|layer_size
operator|*
name|depth
expr_stmt|;
block|}
else|else
block|{
name|toffset
operator|+=
name|surf
operator|.
name|layer_size
operator|*
name|mslice
expr_stmt|;
block|}
if|if
condition|(
name|toffset
operator|>
name|radeon_bo_size
argument_list|(
name|texture
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d texture bo too small (layer size %d, "
literal|"offset %ld, max layer %d, depth %d, bo size %ld) (%d %d)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|layer_size
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|texdw
index|[
literal|2
index|]
operator|<<
literal|8
argument_list|,
name|mslice
argument_list|,
name|depth
argument_list|,
name|radeon_bo_size
argument_list|(
name|texture
argument_list|)
argument_list|,
name|surf
operator|.
name|nbx
argument_list|,
name|surf
operator|.
name|nby
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|mipmap
condition|)
block|{
if|if
condition|(
name|llevel
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%i got NULL MIP_ADDRESS relocation\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
return|return
literal|0
return|;
comment|/* everything's ok */
block|}
block|}
comment|/* check mipmap size */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|llevel
condition|;
name|i
operator|++
control|)
block|{
name|unsigned
name|w
decl_stmt|,
name|h
decl_stmt|,
name|d
decl_stmt|;
name|w
operator|=
name|r600_mip_minify
argument_list|(
name|width
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|h
operator|=
name|r600_mip_minify
argument_list|(
name|height
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|d
operator|=
name|r600_mip_minify
argument_list|(
name|depth
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nbx
operator|=
name|r600_fmt_get_nblocksx
argument_list|(
name|surf
operator|.
name|format
argument_list|,
name|w
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nby
operator|=
name|r600_fmt_get_nblocksy
argument_list|(
name|surf
operator|.
name|format
argument_list|,
name|h
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|surf
operator|.
name|mode
condition|)
block|{
case|case
name|ARRAY_2D_TILED_THIN1
case|:
if|if
condition|(
name|surf
operator|.
name|nbx
operator|<
name|surf
operator|.
name|palign
operator|||
name|surf
operator|.
name|nby
operator|<
name|surf
operator|.
name|halign
condition|)
block|{
name|surf
operator|.
name|mode
operator|=
name|ARRAY_1D_TILED_THIN1
expr_stmt|;
block|}
comment|/* recompute alignment */
name|evergreen_surface_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|ARRAY_LINEAR_GENERAL
case|:
case|case
name|ARRAY_LINEAR_ALIGNED
case|:
case|case
name|ARRAY_1D_TILED_THIN1
case|:
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid array mode %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|surf
operator|.
name|nbx
operator|=
name|roundup
argument_list|(
name|surf
operator|.
name|nbx
argument_list|,
name|surf
operator|.
name|palign
argument_list|)
expr_stmt|;
name|surf
operator|.
name|nby
operator|=
name|roundup
argument_list|(
name|surf
operator|.
name|nby
argument_list|,
name|surf
operator|.
name|halign
argument_list|)
expr_stmt|;
name|r
operator|=
name|evergreen_surface_check
argument_list|(
name|p
argument_list|,
operator|&
name|surf
argument_list|,
literal|"mipmap"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
if|if
condition|(
name|dim
operator|==
name|SQ_TEX_DIM_3D
condition|)
block|{
name|moffset
operator|+=
name|surf
operator|.
name|layer_size
operator|*
name|d
expr_stmt|;
block|}
else|else
block|{
name|moffset
operator|+=
name|surf
operator|.
name|layer_size
operator|*
name|mslice
expr_stmt|;
block|}
if|if
condition|(
name|moffset
operator|>
name|radeon_bo_size
argument_list|(
name|mipmap
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d mipmap [%d] bo too small (layer size %d, "
literal|"offset %ld, coffset %ld, max layer %d, depth %d, "
literal|"bo size %ld) level0 (%d %d %d)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|i
argument_list|,
name|surf
operator|.
name|layer_size
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|texdw
index|[
literal|3
index|]
operator|<<
literal|8
argument_list|,
name|moffset
argument_list|,
name|mslice
argument_list|,
name|d
argument_list|,
name|radeon_bo_size
argument_list|(
name|mipmap
argument_list|)
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|depth
argument_list|)
expr_stmt|;
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d problematic surf: (%d %d) (%d %d %d %d %d %d %d)\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|surf
operator|.
name|nbx
argument_list|,
name|surf
operator|.
name|nby
argument_list|,
name|surf
operator|.
name|mode
argument_list|,
name|surf
operator|.
name|bpe
argument_list|,
name|surf
operator|.
name|nsamples
argument_list|,
name|surf
operator|.
name|bankw
argument_list|,
name|surf
operator|.
name|bankh
argument_list|,
name|surf
operator|.
name|tsplit
argument_list|,
name|surf
operator|.
name|mtilea
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_cs_track_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|evergreen_cs_track
modifier|*
name|track
init|=
name|p
operator|->
name|track
decl_stmt|;
name|unsigned
name|tmp
decl_stmt|,
name|i
decl_stmt|;
name|int
name|r
decl_stmt|;
name|unsigned
name|buffer_mask
init|=
literal|0
decl_stmt|;
comment|/* check streamout */
if|if
condition|(
name|track
operator|->
name|streamout_dirty
operator|&&
name|track
operator|->
name|vgt_strmout_config
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|track
operator|->
name|vgt_strmout_config
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|buffer_mask
operator||=
operator|(
name|track
operator|->
name|vgt_strmout_buffer_config
operator|>>
operator|(
name|i
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|buffer_mask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
if|if
condition|(
name|track
operator|->
name|vgt_strmout_bo
index|[
name|i
index|]
condition|)
block|{
name|u64
name|offset
init|=
operator|(
name|u64
operator|)
name|track
operator|->
name|vgt_strmout_bo_offset
index|[
name|i
index|]
operator|+
operator|(
name|u64
operator|)
name|track
operator|->
name|vgt_strmout_size
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|offset
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|vgt_strmout_bo
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"streamout %d bo too small: 0x%jx, 0x%lx\n"
argument_list|,
name|i
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|vgt_strmout_bo
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"No buffer for streamout %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
name|track
operator|->
name|streamout_dirty
operator|=
name|false
expr_stmt|;
block|}
if|if
condition|(
name|track
operator|->
name|sx_misc_kill_all_prims
condition|)
return|return
literal|0
return|;
comment|/* check that we have a cb for each enabled target 	 */
if|if
condition|(
name|track
operator|->
name|cb_dirty
condition|)
block|{
name|tmp
operator|=
name|track
operator|->
name|cb_target_mask
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|tmp
operator|>>
operator|(
name|i
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xF
condition|)
block|{
comment|/* at least one component is enabled */
if|if
condition|(
name|track
operator|->
name|cb_color_bo
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d mask 0x%08X | 0x%08X no cb for %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|track
operator|->
name|cb_target_mask
argument_list|,
name|track
operator|->
name|cb_shader_mask
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* check cb */
name|r
operator|=
name|evergreen_cs_track_validate_cb
argument_list|(
name|p
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
block|}
block|}
name|track
operator|->
name|cb_dirty
operator|=
name|false
expr_stmt|;
block|}
if|if
condition|(
name|track
operator|->
name|db_dirty
condition|)
block|{
comment|/* Check stencil buffer */
if|if
condition|(
name|G_028044_FORMAT
argument_list|(
name|track
operator|->
name|db_s_info
argument_list|)
operator|!=
name|V_028044_STENCIL_INVALID
operator|&&
name|G_028800_STENCIL_ENABLE
argument_list|(
name|track
operator|->
name|db_depth_control
argument_list|)
condition|)
block|{
name|r
operator|=
name|evergreen_cs_track_validate_stencil
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
comment|/* Check depth buffer */
if|if
condition|(
name|G_028040_FORMAT
argument_list|(
name|track
operator|->
name|db_z_info
argument_list|)
operator|!=
name|V_028040_Z_INVALID
operator|&&
name|G_028800_Z_ENABLE
argument_list|(
name|track
operator|->
name|db_depth_control
argument_list|)
condition|)
block|{
name|r
operator|=
name|evergreen_cs_track_validate_depth
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
name|track
operator|->
name|db_dirty
operator|=
name|false
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * evergreen_cs_packet_parse() - parse cp packet and point ib index to next packet  * @parser:	parser structure holding parsing context.  * @pkt:	where to store packet informations  *  * Assume that chunk_ib_index is properly set. Will return -EINVAL  * if packet is bigger than remaining ib size. or if packets is unknown.  **/
end_comment

begin_function
specifier|static
name|int
name|evergreen_cs_packet_parse
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|unsigned
name|idx
parameter_list|)
block|{
name|struct
name|radeon_cs_chunk
modifier|*
name|ib_chunk
init|=
operator|&
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
decl_stmt|;
name|uint32_t
name|header
decl_stmt|;
if|if
condition|(
name|idx
operator|>=
name|ib_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Can not parse packet at %d after CS end %d !\n"
argument_list|,
name|idx
argument_list|,
name|ib_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|header
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|idx
operator|=
name|idx
expr_stmt|;
name|pkt
operator|->
name|type
operator|=
name|CP_PACKET_GET_TYPE
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|count
operator|=
name|CP_PACKET_GET_COUNT
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|one_reg_wr
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|type
condition|)
block|{
case|case
name|PACKET_TYPE0
case|:
name|pkt
operator|->
name|reg
operator|=
name|CP_PACKET0_GET_REG
argument_list|(
name|header
argument_list|)
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE3
case|:
name|pkt
operator|->
name|opcode
operator|=
name|CP_PACKET3_GET_OPCODE
argument_list|(
name|header
argument_list|)
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE2
case|:
name|pkt
operator|->
name|count
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet type %d at %d !\n"
argument_list|,
name|pkt
operator|->
name|type
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|pkt
operator|->
name|count
operator|+
literal|1
operator|+
name|pkt
operator|->
name|idx
operator|)
operator|>=
name|ib_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Packet (%d:%d:%d) end after CS buffer (%d) !\n"
argument_list|,
name|pkt
operator|->
name|idx
argument_list|,
name|pkt
operator|->
name|type
argument_list|,
name|pkt
operator|->
name|count
argument_list|,
name|ib_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * evergreen_cs_packet_next_reloc() - parse next packet which should be reloc packet3  * @parser:		parser structure holding parsing context.  * @data:		pointer to relocation data  * @offset_start:	starting offset  * @offset_mask:	offset mask (to align start offset on)  * @reloc:		reloc informations  *  * Check next packet is relocation packet3, do bo validation and compute  * GPU offset using the provided start.  **/
end_comment

begin_function
specifier|static
name|int
name|evergreen_cs_packet_next_reloc
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_reloc
modifier|*
modifier|*
name|cs_reloc
parameter_list|)
block|{
name|struct
name|radeon_cs_chunk
modifier|*
name|relocs_chunk
decl_stmt|;
name|struct
name|radeon_cs_packet
name|p3reloc
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|chunk_relocs_idx
operator|==
operator|-
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No relocation chunk !\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
operator|*
name|cs_reloc
operator|=
name|NULL
expr_stmt|;
name|relocs_chunk
operator|=
operator|&
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_relocs_idx
index|]
expr_stmt|;
name|r
operator|=
name|evergreen_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
name|p
operator|->
name|idx
operator|+=
name|p3reloc
operator|.
name|count
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|p3reloc
operator|.
name|type
operator|!=
name|PACKET_TYPE3
operator|||
name|p3reloc
operator|.
name|opcode
operator|!=
name|PACKET3_NOP
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No packet3 for relocation for packet at %d.\n"
argument_list|,
name|p3reloc
operator|.
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|idx
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|p3reloc
operator|.
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|>=
name|relocs_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Relocs at %d after relocations chunk end %d !\n"
argument_list|,
name|idx
argument_list|,
name|relocs_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* FIXME: we assume reloc size is 4 dwords */
operator|*
name|cs_reloc
operator|=
name|p
operator|->
name|relocs_ptr
index|[
operator|(
name|idx
operator|/
literal|4
operator|)
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * evergreen_cs_packet_next_is_pkt3_nop() - test if the next packet is NOP  * @p:		structure holding the parser context.  *  * Check if the next packet is a relocation packet3.  **/
end_comment

begin_function
specifier|static
name|bool
name|evergreen_cs_packet_next_is_pkt3_nop
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|radeon_cs_packet
name|p3reloc
decl_stmt|;
name|int
name|r
decl_stmt|;
name|r
operator|=
name|evergreen_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|false
return|;
block|}
if|if
condition|(
name|p3reloc
operator|.
name|type
operator|!=
name|PACKET_TYPE3
operator|||
name|p3reloc
operator|.
name|opcode
operator|!=
name|PACKET3_NOP
condition|)
block|{
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_comment
comment|/**  * evergreen_cs_packet_next_vline() - parse userspace VLINE packet  * @parser:		parser structure holding parsing context.  *  * Userspace sends a special sequence for VLINE waits.  * PACKET0 - VLINE_START_END + value  * PACKET3 - WAIT_REG_MEM poll vline status reg  * RELOC (P3) - crtc_id in reloc.  *  * This function parses this and relocates the VLINE START END  * and WAIT_REG_MEM packets to the correct crtc.  * It also detects a switched off crtc and nulls out the  * wait in that case.  */
end_comment

begin_function
specifier|static
name|int
name|evergreen_cs_packet_parse_vline
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|drm_mode_object
modifier|*
name|obj
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|struct
name|radeon_cs_packet
name|p3reloc
decl_stmt|,
name|wait_reg_mem
decl_stmt|;
name|int
name|crtc_id
decl_stmt|;
name|int
name|r
decl_stmt|;
name|uint32_t
name|header
decl_stmt|,
name|h_idx
decl_stmt|,
name|reg
decl_stmt|,
name|wait_reg_mem_info
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ib
decl_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
comment|/* parse the WAIT_REG_MEM */
name|r
operator|=
name|evergreen_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|wait_reg_mem
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* check its a WAIT_REG_MEM */
if|if
condition|(
name|wait_reg_mem
operator|.
name|type
operator|!=
name|PACKET_TYPE3
operator|||
name|wait_reg_mem
operator|.
name|opcode
operator|!=
name|PACKET3_WAIT_REG_MEM
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline wait missing WAIT_REG_MEM segment\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|wait_reg_mem_info
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|wait_reg_mem
operator|.
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* bit 4 is reg (0) or mem (1) */
if|if
condition|(
name|wait_reg_mem_info
operator|&
literal|0x10
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline WAIT_REG_MEM waiting on MEM rather than REG\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* waiting for value to be equal */
if|if
condition|(
operator|(
name|wait_reg_mem_info
operator|&
literal|0x7
operator|)
operator|!=
literal|0x3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline WAIT_REG_MEM function not equal\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|wait_reg_mem
operator|.
name|idx
operator|+
literal|2
argument_list|)
operator|<<
literal|2
operator|)
operator|!=
name|EVERGREEN_VLINE_STATUS
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline WAIT_REG_MEM bad reg\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|wait_reg_mem
operator|.
name|idx
operator|+
literal|5
argument_list|)
operator|!=
name|EVERGREEN_VLINE_STAT
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline WAIT_REG_MEM bad bit mask\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* jump over the NOP */
name|r
operator|=
name|evergreen_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|,
name|p
operator|->
name|idx
operator|+
name|wait_reg_mem
operator|.
name|count
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|h_idx
operator|=
name|p
operator|->
name|idx
operator|-
literal|2
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
name|wait_reg_mem
operator|.
name|count
operator|+
literal|2
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
name|p3reloc
operator|.
name|count
operator|+
literal|2
expr_stmt|;
name|header
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|h_idx
argument_list|)
expr_stmt|;
name|crtc_id
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|h_idx
operator|+
literal|2
operator|+
literal|7
operator|+
literal|1
argument_list|)
expr_stmt|;
name|reg
operator|=
name|CP_PACKET0_GET_REG
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|obj
operator|=
name|drm_mode_object_find
argument_list|(
name|p
operator|->
name|rdev
operator|->
name|ddev
argument_list|,
name|crtc_id
argument_list|,
name|DRM_MODE_OBJECT_CRTC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|obj
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"cannot find crtc %d\n"
argument_list|,
name|crtc_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|crtc
operator|=
name|obj_to_crtc
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
name|crtc_id
operator|=
name|radeon_crtc
operator|->
name|crtc_id
expr_stmt|;
if|if
condition|(
operator|!
name|crtc
operator|->
name|enabled
condition|)
block|{
comment|/* if the CRTC isn't enabled - we need to nop out the WAIT_REG_MEM */
name|ib
index|[
name|h_idx
operator|+
literal|2
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|3
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|4
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|5
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|6
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|7
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|8
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|EVERGREEN_VLINE_START_END
case|:
name|header
operator|&=
operator|~
name|R600_CP_PACKET0_REG_MASK
expr_stmt|;
name|header
operator||=
operator|(
name|EVERGREEN_VLINE_START_END
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
operator|)
operator|>>
literal|2
expr_stmt|;
name|ib
index|[
name|h_idx
index|]
operator|=
name|header
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|4
index|]
operator|=
operator|(
name|EVERGREEN_VLINE_STATUS
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
operator|)
operator|>>
literal|2
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"unknown crtc reloc\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_packet0_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|unsigned
name|idx
parameter_list|,
name|unsigned
name|reg
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|EVERGREEN_VLINE_START_END
case|:
name|r
operator|=
name|evergreen_cs_packet_parse_vline
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Forbidden register 0x%04X in cs at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_cs_parse_packet0
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|unsigned
name|reg
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|int
name|r
decl_stmt|;
name|idx
operator|=
name|pkt
operator|->
name|idx
operator|+
literal|1
expr_stmt|;
name|reg
operator|=
name|pkt
operator|->
name|reg
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|pkt
operator|->
name|count
condition|;
name|i
operator|++
operator|,
name|idx
operator|++
operator|,
name|reg
operator|+=
literal|4
control|)
block|{
name|r
operator|=
name|evergreen_packet0_check
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * evergreen_cs_check_reg() - check if register is authorized or not  * @parser: parser structure holding parsing context  * @reg: register we are testing  * @idx: index into the cs buffer  *  * This function will test against evergreen_reg_safe_bm and return 0  * if register is safe. If register is not flag as safe this function  * will test it against a list of register needind special handling.  */
end_comment

begin_function
specifier|static
name|int
name|evergreen_cs_check_reg
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u32
name|idx
parameter_list|)
block|{
name|struct
name|evergreen_cs_track
modifier|*
name|track
init|=
operator|(
expr|struct
name|evergreen_cs_track
operator|*
operator|)
name|p
operator|->
name|track
decl_stmt|;
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|u32
name|last_reg
decl_stmt|;
name|u32
name|m
decl_stmt|,
name|i
decl_stmt|,
name|tmp
decl_stmt|,
modifier|*
name|ib
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
name|last_reg
operator|=
name|ARRAY_SIZE
argument_list|(
name|cayman_reg_safe_bm
argument_list|)
expr_stmt|;
else|else
name|last_reg
operator|=
name|ARRAY_SIZE
argument_list|(
name|evergreen_reg_safe_bm
argument_list|)
expr_stmt|;
name|i
operator|=
operator|(
name|reg
operator|>>
literal|7
operator|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|last_reg
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"forbidden register 0x%08x at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|m
operator|=
literal|1
operator|<<
operator|(
operator|(
name|reg
operator|>>
literal|2
operator|)
operator|&
literal|31
operator|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|cayman_reg_safe_bm
index|[
name|i
index|]
operator|&
name|m
operator|)
condition|)
return|return
literal|0
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|evergreen_reg_safe_bm
index|[
name|i
index|]
operator|&
name|m
operator|)
condition|)
return|return
literal|0
return|;
block|}
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
switch|switch
condition|(
name|reg
condition|)
block|{
comment|/* force following reg to 0 in an attempt to disable out buffer 	 * which will need us to better understand how it works to perform 	 * security check on it (Jerome) 	 */
case|case
name|SQ_ESGS_RING_SIZE
case|:
case|case
name|SQ_GSVS_RING_SIZE
case|:
case|case
name|SQ_ESTMP_RING_SIZE
case|:
case|case
name|SQ_GSTMP_RING_SIZE
case|:
case|case
name|SQ_HSTMP_RING_SIZE
case|:
case|case
name|SQ_LSTMP_RING_SIZE
case|:
case|case
name|SQ_PSTMP_RING_SIZE
case|:
case|case
name|SQ_VSTMP_RING_SIZE
case|:
case|case
name|SQ_ESGS_RING_ITEMSIZE
case|:
case|case
name|SQ_ESTMP_RING_ITEMSIZE
case|:
case|case
name|SQ_GSTMP_RING_ITEMSIZE
case|:
case|case
name|SQ_GSVS_RING_ITEMSIZE
case|:
case|case
name|SQ_GS_VERT_ITEMSIZE
case|:
case|case
name|SQ_GS_VERT_ITEMSIZE_1
case|:
case|case
name|SQ_GS_VERT_ITEMSIZE_2
case|:
case|case
name|SQ_GS_VERT_ITEMSIZE_3
case|:
case|case
name|SQ_GSVS_RING_OFFSET_1
case|:
case|case
name|SQ_GSVS_RING_OFFSET_2
case|:
case|case
name|SQ_GSVS_RING_OFFSET_3
case|:
case|case
name|SQ_HSTMP_RING_ITEMSIZE
case|:
case|case
name|SQ_LSTMP_RING_ITEMSIZE
case|:
case|case
name|SQ_PSTMP_RING_ITEMSIZE
case|:
case|case
name|SQ_VSTMP_RING_ITEMSIZE
case|:
case|case
name|VGT_TF_RING_SIZE
case|:
comment|/* get value to populate the IB don't remove */
comment|/*tmp =radeon_get_ib_value(p, idx); 		  ib[idx] = 0;*/
break|break;
case|case
name|SQ_ESGS_RING_BASE
case|:
case|case
name|SQ_GSVS_RING_BASE
case|:
case|case
name|SQ_ESTMP_RING_BASE
case|:
case|case
name|SQ_GSTMP_RING_BASE
case|:
case|case
name|SQ_HSTMP_RING_BASE
case|:
case|case
name|SQ_LSTMP_RING_BASE
case|:
case|case
name|SQ_PSTMP_RING_BASE
case|:
case|case
name|SQ_VSTMP_RING_BASE
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
break|break;
case|case
name|DB_DEPTH_CONTROL
case|:
name|track
operator|->
name|db_depth_control
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CAYMAN_DB_EQAA
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<
name|CHIP_CAYMAN
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|CAYMAN_DB_DEPTH_INFO
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<
name|CHIP_CAYMAN
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|DB_Z_INFO
case|:
name|track
operator|->
name|db_z_info
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|&=
operator|~
name|Z_ARRAY_MODE
argument_list|(
literal|0xf
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_z_info
operator|&=
operator|~
name|Z_ARRAY_MODE
argument_list|(
literal|0xf
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator||=
name|Z_ARRAY_MODE
argument_list|(
name|evergreen_cs_get_aray_mode
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|)
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_z_info
operator||=
name|Z_ARRAY_MODE
argument_list|(
name|evergreen_cs_get_aray_mode
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
block|{
name|unsigned
name|bankw
decl_stmt|,
name|bankh
decl_stmt|,
name|mtaspect
decl_stmt|,
name|tile_split
decl_stmt|;
name|evergreen_tiling_fields
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|,
operator|&
name|bankw
argument_list|,
operator|&
name|bankh
argument_list|,
operator|&
name|mtaspect
argument_list|,
operator|&
name|tile_split
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator||=
name|DB_NUM_BANKS
argument_list|(
name|evergreen_cs_get_num_banks
argument_list|(
name|track
operator|->
name|nbanks
argument_list|)
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator||=
name|DB_TILE_SPLIT
argument_list|(
name|tile_split
argument_list|)
operator||
name|DB_BANK_WIDTH
argument_list|(
name|bankw
argument_list|)
operator||
name|DB_BANK_HEIGHT
argument_list|(
name|bankh
argument_list|)
operator||
name|DB_MACRO_TILE_ASPECT
argument_list|(
name|mtaspect
argument_list|)
expr_stmt|;
block|}
block|}
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_STENCIL_INFO
case|:
name|track
operator|->
name|db_s_info
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_DEPTH_VIEW
case|:
name|track
operator|->
name|db_depth_view
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_DEPTH_SIZE
case|:
name|track
operator|->
name|db_depth_size
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R_02805C_DB_DEPTH_SLICE
case|:
name|track
operator|->
name|db_depth_slice
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_Z_READ_BASE
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|db_z_read_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_z_read_bo
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_Z_WRITE_BASE
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|db_z_write_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_z_write_bo
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_STENCIL_READ_BASE
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|db_s_read_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_s_read_bo
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_STENCIL_WRITE_BASE
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|db_s_write_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|db_s_write_bo
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|VGT_STRMOUT_CONFIG
case|:
name|track
operator|->
name|vgt_strmout_config
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|streamout_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|VGT_STRMOUT_BUFFER_CONFIG
case|:
name|track
operator|->
name|vgt_strmout_buffer_config
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|streamout_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|VGT_STRMOUT_BUFFER_BASE_0
case|:
case|case
name|VGT_STRMOUT_BUFFER_BASE_1
case|:
case|case
name|VGT_STRMOUT_BUFFER_BASE_2
case|:
case|case
name|VGT_STRMOUT_BUFFER_BASE_3
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
operator|(
name|reg
operator|-
name|VGT_STRMOUT_BUFFER_BASE_0
operator|)
operator|/
literal|16
expr_stmt|;
name|track
operator|->
name|vgt_strmout_bo_offset
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|vgt_strmout_bo
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|streamout_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|VGT_STRMOUT_BUFFER_SIZE_0
case|:
case|case
name|VGT_STRMOUT_BUFFER_SIZE_1
case|:
case|case
name|VGT_STRMOUT_BUFFER_SIZE_2
case|:
case|case
name|VGT_STRMOUT_BUFFER_SIZE_3
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|VGT_STRMOUT_BUFFER_SIZE_0
operator|)
operator|/
literal|16
expr_stmt|;
comment|/* size in register is DWs, convert to bytes */
name|track
operator|->
name|vgt_strmout_size
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|*
literal|4
expr_stmt|;
name|track
operator|->
name|streamout_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CP_COHER_BASE
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"missing reloc for CP_COHER_BASE "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
case|case
name|CB_TARGET_MASK
case|:
name|track
operator|->
name|cb_target_mask
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_SHADER_MASK
case|:
name|track
operator|->
name|cb_shader_mask
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|PA_SC_AA_CONFIG
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|&
name|MSAA_NUM_SAMPLES_MASK
expr_stmt|;
name|track
operator|->
name|nsamples
operator|=
literal|1
operator|<<
name|tmp
expr_stmt|;
break|break;
case|case
name|CAYMAN_PA_SC_AA_CONFIG
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<
name|CHIP_CAYMAN
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|&
name|CAYMAN_MSAA_NUM_SAMPLES_MASK
expr_stmt|;
name|track
operator|->
name|nsamples
operator|=
literal|1
operator|<<
name|tmp
expr_stmt|;
break|break;
case|case
name|CB_COLOR0_VIEW
case|:
case|case
name|CB_COLOR1_VIEW
case|:
case|case
name|CB_COLOR2_VIEW
case|:
case|case
name|CB_COLOR3_VIEW
case|:
case|case
name|CB_COLOR4_VIEW
case|:
case|case
name|CB_COLOR5_VIEW
case|:
case|case
name|CB_COLOR6_VIEW
case|:
case|case
name|CB_COLOR7_VIEW
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|CB_COLOR0_VIEW
operator|)
operator|/
literal|0x3c
expr_stmt|;
name|track
operator|->
name|cb_color_view
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR8_VIEW
case|:
case|case
name|CB_COLOR9_VIEW
case|:
case|case
name|CB_COLOR10_VIEW
case|:
case|case
name|CB_COLOR11_VIEW
case|:
name|tmp
operator|=
operator|(
operator|(
name|reg
operator|-
name|CB_COLOR8_VIEW
operator|)
operator|/
literal|0x1c
operator|)
operator|+
literal|8
expr_stmt|;
name|track
operator|->
name|cb_color_view
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR0_INFO
case|:
case|case
name|CB_COLOR1_INFO
case|:
case|case
name|CB_COLOR2_INFO
case|:
case|case
name|CB_COLOR3_INFO
case|:
case|case
name|CB_COLOR4_INFO
case|:
case|case
name|CB_COLOR5_INFO
case|:
case|case
name|CB_COLOR6_INFO
case|:
case|case
name|CB_COLOR7_INFO
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|CB_COLOR0_INFO
operator|)
operator|/
literal|0x3c
expr_stmt|;
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator||=
name|CB_ARRAY_MODE
argument_list|(
name|evergreen_cs_get_aray_mode
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|)
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
operator||=
name|CB_ARRAY_MODE
argument_list|(
name|evergreen_cs_get_aray_mode
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR8_INFO
case|:
case|case
name|CB_COLOR9_INFO
case|:
case|case
name|CB_COLOR10_INFO
case|:
case|case
name|CB_COLOR11_INFO
case|:
name|tmp
operator|=
operator|(
operator|(
name|reg
operator|-
name|CB_COLOR8_INFO
operator|)
operator|/
literal|0x1c
operator|)
operator|+
literal|8
expr_stmt|;
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator||=
name|CB_ARRAY_MODE
argument_list|(
name|evergreen_cs_get_aray_mode
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|)
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_info
index|[
name|tmp
index|]
operator||=
name|CB_ARRAY_MODE
argument_list|(
name|evergreen_cs_get_aray_mode
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR0_PITCH
case|:
case|case
name|CB_COLOR1_PITCH
case|:
case|case
name|CB_COLOR2_PITCH
case|:
case|case
name|CB_COLOR3_PITCH
case|:
case|case
name|CB_COLOR4_PITCH
case|:
case|case
name|CB_COLOR5_PITCH
case|:
case|case
name|CB_COLOR6_PITCH
case|:
case|case
name|CB_COLOR7_PITCH
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|CB_COLOR0_PITCH
operator|)
operator|/
literal|0x3c
expr_stmt|;
name|track
operator|->
name|cb_color_pitch
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR8_PITCH
case|:
case|case
name|CB_COLOR9_PITCH
case|:
case|case
name|CB_COLOR10_PITCH
case|:
case|case
name|CB_COLOR11_PITCH
case|:
name|tmp
operator|=
operator|(
operator|(
name|reg
operator|-
name|CB_COLOR8_PITCH
operator|)
operator|/
literal|0x1c
operator|)
operator|+
literal|8
expr_stmt|;
name|track
operator|->
name|cb_color_pitch
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR0_SLICE
case|:
case|case
name|CB_COLOR1_SLICE
case|:
case|case
name|CB_COLOR2_SLICE
case|:
case|case
name|CB_COLOR3_SLICE
case|:
case|case
name|CB_COLOR4_SLICE
case|:
case|case
name|CB_COLOR5_SLICE
case|:
case|case
name|CB_COLOR6_SLICE
case|:
case|case
name|CB_COLOR7_SLICE
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|CB_COLOR0_SLICE
operator|)
operator|/
literal|0x3c
expr_stmt|;
name|track
operator|->
name|cb_color_slice
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_slice_idx
index|[
name|tmp
index|]
operator|=
name|idx
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR8_SLICE
case|:
case|case
name|CB_COLOR9_SLICE
case|:
case|case
name|CB_COLOR10_SLICE
case|:
case|case
name|CB_COLOR11_SLICE
case|:
name|tmp
operator|=
operator|(
operator|(
name|reg
operator|-
name|CB_COLOR8_SLICE
operator|)
operator|/
literal|0x1c
operator|)
operator|+
literal|8
expr_stmt|;
name|track
operator|->
name|cb_color_slice
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_slice_idx
index|[
name|tmp
index|]
operator|=
name|idx
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR0_ATTRIB
case|:
case|case
name|CB_COLOR1_ATTRIB
case|:
case|case
name|CB_COLOR2_ATTRIB
case|:
case|case
name|CB_COLOR3_ATTRIB
case|:
case|case
name|CB_COLOR4_ATTRIB
case|:
case|case
name|CB_COLOR5_ATTRIB
case|:
case|case
name|CB_COLOR6_ATTRIB
case|:
case|case
name|CB_COLOR7_ATTRIB
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
block|{
name|unsigned
name|bankw
decl_stmt|,
name|bankh
decl_stmt|,
name|mtaspect
decl_stmt|,
name|tile_split
decl_stmt|;
name|evergreen_tiling_fields
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|,
operator|&
name|bankw
argument_list|,
operator|&
name|bankh
argument_list|,
operator|&
name|mtaspect
argument_list|,
operator|&
name|tile_split
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator||=
name|CB_NUM_BANKS
argument_list|(
name|evergreen_cs_get_num_banks
argument_list|(
name|track
operator|->
name|nbanks
argument_list|)
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator||=
name|CB_TILE_SPLIT
argument_list|(
name|tile_split
argument_list|)
operator||
name|CB_BANK_WIDTH
argument_list|(
name|bankw
argument_list|)
operator||
name|CB_BANK_HEIGHT
argument_list|(
name|bankh
argument_list|)
operator||
name|CB_MACRO_TILE_ASPECT
argument_list|(
name|mtaspect
argument_list|)
expr_stmt|;
block|}
block|}
name|tmp
operator|=
operator|(
operator|(
name|reg
operator|-
name|CB_COLOR0_ATTRIB
operator|)
operator|/
literal|0x3c
operator|)
expr_stmt|;
name|track
operator|->
name|cb_color_attrib
index|[
name|tmp
index|]
operator|=
name|ib
index|[
name|idx
index|]
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR8_ATTRIB
case|:
case|case
name|CB_COLOR9_ATTRIB
case|:
case|case
name|CB_COLOR10_ATTRIB
case|:
case|case
name|CB_COLOR11_ATTRIB
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
block|{
name|unsigned
name|bankw
decl_stmt|,
name|bankh
decl_stmt|,
name|mtaspect
decl_stmt|,
name|tile_split
decl_stmt|;
name|evergreen_tiling_fields
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|,
operator|&
name|bankw
argument_list|,
operator|&
name|bankh
argument_list|,
operator|&
name|mtaspect
argument_list|,
operator|&
name|tile_split
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator||=
name|CB_NUM_BANKS
argument_list|(
name|evergreen_cs_get_num_banks
argument_list|(
name|track
operator|->
name|nbanks
argument_list|)
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator||=
name|CB_TILE_SPLIT
argument_list|(
name|tile_split
argument_list|)
operator||
name|CB_BANK_WIDTH
argument_list|(
name|bankw
argument_list|)
operator||
name|CB_BANK_HEIGHT
argument_list|(
name|bankh
argument_list|)
operator||
name|CB_MACRO_TILE_ASPECT
argument_list|(
name|mtaspect
argument_list|)
expr_stmt|;
block|}
block|}
name|tmp
operator|=
operator|(
operator|(
name|reg
operator|-
name|CB_COLOR8_ATTRIB
operator|)
operator|/
literal|0x1c
operator|)
operator|+
literal|8
expr_stmt|;
name|track
operator|->
name|cb_color_attrib
index|[
name|tmp
index|]
operator|=
name|ib
index|[
name|idx
index|]
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR0_FMASK
case|:
case|case
name|CB_COLOR1_FMASK
case|:
case|case
name|CB_COLOR2_FMASK
case|:
case|case
name|CB_COLOR3_FMASK
case|:
case|case
name|CB_COLOR4_FMASK
case|:
case|case
name|CB_COLOR5_FMASK
case|:
case|case
name|CB_COLOR6_FMASK
case|:
case|case
name|CB_COLOR7_FMASK
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|CB_COLOR0_FMASK
operator|)
operator|/
literal|0x3c
expr_stmt|;
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG 0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_fmask_bo
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
break|break;
case|case
name|CB_COLOR0_CMASK
case|:
case|case
name|CB_COLOR1_CMASK
case|:
case|case
name|CB_COLOR2_CMASK
case|:
case|case
name|CB_COLOR3_CMASK
case|:
case|case
name|CB_COLOR4_CMASK
case|:
case|case
name|CB_COLOR5_CMASK
case|:
case|case
name|CB_COLOR6_CMASK
case|:
case|case
name|CB_COLOR7_CMASK
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|CB_COLOR0_CMASK
operator|)
operator|/
literal|0x3c
expr_stmt|;
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG 0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_cmask_bo
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
break|break;
case|case
name|CB_COLOR0_FMASK_SLICE
case|:
case|case
name|CB_COLOR1_FMASK_SLICE
case|:
case|case
name|CB_COLOR2_FMASK_SLICE
case|:
case|case
name|CB_COLOR3_FMASK_SLICE
case|:
case|case
name|CB_COLOR4_FMASK_SLICE
case|:
case|case
name|CB_COLOR5_FMASK_SLICE
case|:
case|case
name|CB_COLOR6_FMASK_SLICE
case|:
case|case
name|CB_COLOR7_FMASK_SLICE
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|CB_COLOR0_FMASK_SLICE
operator|)
operator|/
literal|0x3c
expr_stmt|;
name|track
operator|->
name|cb_color_fmask_slice
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
break|break;
case|case
name|CB_COLOR0_CMASK_SLICE
case|:
case|case
name|CB_COLOR1_CMASK_SLICE
case|:
case|case
name|CB_COLOR2_CMASK_SLICE
case|:
case|case
name|CB_COLOR3_CMASK_SLICE
case|:
case|case
name|CB_COLOR4_CMASK_SLICE
case|:
case|case
name|CB_COLOR5_CMASK_SLICE
case|:
case|case
name|CB_COLOR6_CMASK_SLICE
case|:
case|case
name|CB_COLOR7_CMASK_SLICE
case|:
name|tmp
operator|=
operator|(
name|reg
operator|-
name|CB_COLOR0_CMASK_SLICE
operator|)
operator|/
literal|0x3c
expr_stmt|;
name|track
operator|->
name|cb_color_cmask_slice
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
break|break;
case|case
name|CB_COLOR0_BASE
case|:
case|case
name|CB_COLOR1_BASE
case|:
case|case
name|CB_COLOR2_BASE
case|:
case|case
name|CB_COLOR3_BASE
case|:
case|case
name|CB_COLOR4_BASE
case|:
case|case
name|CB_COLOR5_BASE
case|:
case|case
name|CB_COLOR6_BASE
case|:
case|case
name|CB_COLOR7_BASE
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
operator|(
name|reg
operator|-
name|CB_COLOR0_BASE
operator|)
operator|/
literal|0x3c
expr_stmt|;
name|track
operator|->
name|cb_color_bo_offset
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_bo
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_COLOR8_BASE
case|:
case|case
name|CB_COLOR9_BASE
case|:
case|case
name|CB_COLOR10_BASE
case|:
case|case
name|CB_COLOR11_BASE
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
operator|(
operator|(
name|reg
operator|-
name|CB_COLOR8_BASE
operator|)
operator|/
literal|0x1c
operator|)
operator|+
literal|8
expr_stmt|;
name|track
operator|->
name|cb_color_bo_offset
index|[
name|tmp
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|cb_color_bo
index|[
name|tmp
index|]
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_HTILE_DATA_BASE
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|htile_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|track
operator|->
name|htile_bo
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|DB_HTILE_SURFACE
case|:
comment|/* 8x8 only */
name|track
operator|->
name|htile_surface
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
comment|/* force 8x8 htile width and height */
name|ib
index|[
name|idx
index|]
operator||=
literal|3
expr_stmt|;
name|track
operator|->
name|db_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|CB_IMMED0_BASE
case|:
case|case
name|CB_IMMED1_BASE
case|:
case|case
name|CB_IMMED2_BASE
case|:
case|case
name|CB_IMMED3_BASE
case|:
case|case
name|CB_IMMED4_BASE
case|:
case|case
name|CB_IMMED5_BASE
case|:
case|case
name|CB_IMMED6_BASE
case|:
case|case
name|CB_IMMED7_BASE
case|:
case|case
name|CB_IMMED8_BASE
case|:
case|case
name|CB_IMMED9_BASE
case|:
case|case
name|CB_IMMED10_BASE
case|:
case|case
name|CB_IMMED11_BASE
case|:
case|case
name|SQ_PGM_START_FS
case|:
case|case
name|SQ_PGM_START_ES
case|:
case|case
name|SQ_PGM_START_VS
case|:
case|case
name|SQ_PGM_START_GS
case|:
case|case
name|SQ_PGM_START_PS
case|:
case|case
name|SQ_PGM_START_HS
case|:
case|case
name|SQ_PGM_START_LS
case|:
case|case
name|SQ_CONST_MEM_BASE
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_0
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_1
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_2
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_3
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_4
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_5
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_6
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_7
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_8
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_9
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_10
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_11
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_12
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_13
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_14
case|:
case|case
name|SQ_ALU_CONST_CACHE_GS_15
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_0
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_1
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_2
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_3
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_4
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_5
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_6
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_7
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_8
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_9
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_10
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_11
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_12
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_13
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_14
case|:
case|case
name|SQ_ALU_CONST_CACHE_PS_15
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_0
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_1
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_2
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_3
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_4
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_5
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_6
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_7
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_8
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_9
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_10
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_11
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_12
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_13
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_14
case|:
case|case
name|SQ_ALU_CONST_CACHE_VS_15
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_0
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_1
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_2
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_3
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_4
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_5
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_6
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_7
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_8
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_9
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_10
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_11
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_12
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_13
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_14
case|:
case|case
name|SQ_ALU_CONST_CACHE_HS_15
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_0
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_1
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_2
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_3
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_4
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_5
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_6
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_7
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_8
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_9
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_10
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_11
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_12
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_13
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_14
case|:
case|case
name|SQ_ALU_CONST_CACHE_LS_15
case|:
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
break|break;
case|case
name|SX_MEMORY_EXPORT_BASE
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONFIG_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONFIG_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
break|break;
case|case
name|CAYMAN_SX_SCATTER_EXPORT_BASE
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<
name|CHIP_CAYMAN
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"bad SET_CONTEXT_REG "
literal|"0x%04X\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
break|break;
case|case
name|SX_MISC
case|:
name|track
operator|->
name|sx_misc_kill_all_prims
operator|=
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|&
literal|0x1
operator|)
operator|!=
literal|0
expr_stmt|;
break|break;
default|default:
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"forbidden register 0x%08x at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|evergreen_is_safe_reg
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u32
name|idx
parameter_list|)
block|{
name|u32
name|last_reg
decl_stmt|,
name|m
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
name|last_reg
operator|=
name|ARRAY_SIZE
argument_list|(
name|cayman_reg_safe_bm
argument_list|)
expr_stmt|;
else|else
name|last_reg
operator|=
name|ARRAY_SIZE
argument_list|(
name|evergreen_reg_safe_bm
argument_list|)
expr_stmt|;
name|i
operator|=
operator|(
name|reg
operator|>>
literal|7
operator|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|last_reg
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"forbidden register 0x%08x at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|m
operator|=
literal|1
operator|<<
operator|(
operator|(
name|reg
operator|>>
literal|2
operator|)
operator|&
literal|31
operator|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|cayman_reg_safe_bm
index|[
name|i
index|]
operator|&
name|m
operator|)
condition|)
return|return
name|true
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|evergreen_reg_safe_bm
index|[
name|i
index|]
operator|&
name|m
operator|)
condition|)
return|return
name|true
return|;
block|}
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"forbidden register 0x%08x at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_packet3_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|struct
name|evergreen_cs_track
modifier|*
name|track
decl_stmt|;
specifier|volatile
name|u32
modifier|*
name|ib
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|unsigned
name|start_reg
decl_stmt|,
name|end_reg
decl_stmt|,
name|reg
decl_stmt|;
name|int
name|r
decl_stmt|;
name|u32
name|idx_value
decl_stmt|;
name|track
operator|=
operator|(
expr|struct
name|evergreen_cs_track
operator|*
operator|)
name|p
operator|->
name|track
expr_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
name|idx
operator|=
name|pkt
operator|->
name|idx
operator|+
literal|1
expr_stmt|;
name|idx_value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|opcode
condition|)
block|{
case|case
name|PACKET3_SET_PREDICATION
case|:
block|{
name|int
name|pred_op
decl_stmt|;
name|int
name|tmp
decl_stmt|;
name|uint64_t
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET PREDICATION\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|pred_op
operator|=
operator|(
name|tmp
operator|>>
literal|16
operator|)
operator|&
literal|0x7
expr_stmt|;
comment|/* for the clear predicate operation */
if|if
condition|(
name|pred_op
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|pred_op
operator|>
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET PREDICATION operation %d\n"
argument_list|,
name|pred_op
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET PREDICATION\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
operator|(
name|idx_value
operator|&
literal|0xfffffff0
operator|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|tmp
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|0
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
operator|(
name|tmp
operator|&
literal|0xffffff00
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_CONTEXT_CONTROL
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad CONTEXT_CONTROL\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_INDEX_TYPE
case|:
case|case
name|PACKET3_NUM_INSTANCES
case|:
case|case
name|PACKET3_CLEAR_STATE
case|:
if|if
condition|(
name|pkt
operator|->
name|count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad INDEX_TYPE/NUM_INSTANCES/CLEAR_STATE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|CAYMAN_PACKET3_DEALLOC_STATE
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<
name|CHIP_CAYMAN
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad PACKET3_DEALLOC_STATE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|pkt
operator|->
name|count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad INDEX_TYPE/NUM_INSTANCES/CLEAR_STATE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_INDEX_BASE
case|:
block|{
name|uint64_t
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad INDEX_BASE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad INDEX_BASE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
name|idx_value
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|0
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|r
operator|=
name|evergreen_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
block|}
case|case
name|PACKET3_DRAW_INDEX
case|:
block|{
name|uint64_t
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
name|idx_value
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|0
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|r
operator|=
name|evergreen_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
block|}
case|case
name|PACKET3_DRAW_INDEX_2
case|:
block|{
name|uint64_t
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_2\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_2\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|r
operator|=
name|evergreen_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
block|}
case|case
name|PACKET3_DRAW_INDEX_AUTO
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_AUTO\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_DRAW_INDEX_MULTI_AUTO
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_MULTI_AUTO\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_DRAW_INDEX_IMMD
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|<
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_IMMD\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_DRAW_INDEX_OFFSET
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_OFFSET\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_DRAW_INDEX_OFFSET_2
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_OFFSET_2\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_DISPATCH_DIRECT
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DISPATCH_DIRECT\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_DISPATCH_INDIRECT
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DISPATCH_INDIRECT\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DISPATCH_INDIRECT\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|0
index|]
operator|=
name|idx_value
operator|+
call|(
name|u32
call|)
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|r
operator|=
name|evergreen_cs_track_check
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"%s:%d invalid cmd stream\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_WAIT_REG_MEM
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|5
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad WAIT_REG_MEM\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* bit 4 is reg (0) or mem (1) */
if|if
condition|(
name|idx_value
operator|&
literal|0x10
condition|)
block|{
name|uint64_t
name|offset
decl_stmt|;
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad WAIT_REG_MEM\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xfffffffc
operator|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
operator|(
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|&
literal|0x3
operator|)
operator||
operator|(
name|offset
operator|&
literal|0xfffffffc
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_CP_DMA
case|:
block|{
name|u32
name|command
decl_stmt|,
name|size
decl_stmt|,
name|info
decl_stmt|;
name|u64
name|offset
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad CP DMA\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|command
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
expr_stmt|;
name|size
operator|=
name|command
operator|&
literal|0x1fffff
expr_stmt|;
name|info
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
operator|(
name|info
operator|&
literal|0x60000000
operator|)
operator|>>
literal|29
operator|)
operator|!=
literal|0
operator|)
operator|||
comment|/* src = GDS or DATA */
operator|(
operator|(
operator|(
name|info
operator|&
literal|0x00300000
operator|)
operator|>>
literal|20
operator|)
operator|!=
literal|0
operator|)
operator|||
comment|/* dst = GDS */
operator|(
operator|(
operator|(
operator|(
name|info
operator|&
literal|0x00300000
operator|)
operator|>>
literal|20
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_DAS
operator|)
operator|)
operator|||
comment|/* dst = register */
operator|(
operator|(
operator|(
operator|(
name|info
operator|&
literal|0x60000000
operator|)
operator|>>
literal|29
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_SAS
operator|)
operator|)
condition|)
block|{
comment|/* src = register */
comment|/* non mem to mem copies requires dw aligned count */
if|if
condition|(
name|size
operator|%
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA command requires dw count alignment\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_SAS
condition|)
block|{
comment|/* src address space is register */
comment|/* GDS is ok */
if|if
condition|(
operator|(
operator|(
name|info
operator|&
literal|0x60000000
operator|)
operator|>>
literal|29
operator|)
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA SAS not supported\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_SAIC
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA SAIC only supported for registers\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* src address space is memory */
if|if
condition|(
operator|(
operator|(
name|info
operator|&
literal|0x60000000
operator|)
operator|>>
literal|29
operator|)
operator|==
literal|0
condition|)
block|{
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad CP DMA SRC\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
name|tmp
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|+
name|size
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"CP DMA src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|tmp
operator|+
name|size
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
operator|(
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|&
literal|0xffffff00
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|info
operator|&
literal|0x60000000
operator|)
operator|>>
literal|29
operator|)
operator|!=
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad CP DMA SRC_SEL\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_DAS
condition|)
block|{
comment|/* dst address space is register */
comment|/* GDS is ok */
if|if
condition|(
operator|(
operator|(
name|info
operator|&
literal|0x00300000
operator|)
operator|>>
literal|20
operator|)
operator|!=
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA DAS not supported\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
comment|/* dst address space is memory */
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_DAIC
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA DAIC only supported for registers\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
operator|(
name|info
operator|&
literal|0x00300000
operator|)
operator|>>
literal|20
operator|)
operator|==
literal|0
condition|)
block|{
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad CP DMA DST\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
name|tmp
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|+
name|size
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"CP DMA dst buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|tmp
operator|+
name|size
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
name|DRM_ERROR
argument_list|(
literal|"bad CP DMA DST_SEL\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
break|break;
block|}
case|case
name|PACKET3_SURFACE_SYNC
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SURFACE_SYNC\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* 0xffffffff/0x0 is flush all cache flag */
if|if
condition|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|!=
literal|0xffffffff
operator|||
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SURFACE_SYNC\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_EVENT_WRITE
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|2
operator|&&
name|pkt
operator|->
name|count
operator|!=
literal|0
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|pkt
operator|->
name|count
condition|)
block|{
name|uint64_t
name|offset
decl_stmt|;
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xfffffff8
operator|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|offset
operator|&
literal|0xfffffff8
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_EVENT_WRITE_EOP
case|:
block|{
name|uint64_t
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE_EOP\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE_EOP\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xfffffffc
operator|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|offset
operator|&
literal|0xfffffffc
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
operator|(
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|&
literal|0xffffff00
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
break|break;
block|}
case|case
name|PACKET3_EVENT_WRITE_EOS
case|:
block|{
name|uint64_t
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE_EOS\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE_EOS\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xfffffffc
operator|)
operator|+
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|offset
operator|&
literal|0xfffffffc
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
operator|(
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|&
literal|0xffffff00
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
break|break;
block|}
case|case
name|PACKET3_SET_CONFIG_REG
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_CONFIG_REG_START
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_CONFIG_REG_START
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_CONFIG_REG_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_CONFIG_REG_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad PACKET3_SET_CONFIG_REG\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pkt
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
name|r
operator|=
name|evergreen_cs_check_reg
argument_list|(
name|p
argument_list|,
name|reg
argument_list|,
name|idx
operator|+
literal|1
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_SET_CONTEXT_REG
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_CONTEXT_REG_START
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_CONTEXT_REG_START
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_CONTEXT_REG_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_CONTEXT_REG_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad PACKET3_SET_CONTEXT_REG\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pkt
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
name|r
operator|=
name|evergreen_cs_check_reg
argument_list|(
name|p
argument_list|,
name|reg
argument_list|,
name|idx
operator|+
literal|1
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_SET_RESOURCE
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|%
literal|8
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_RESOURCE_START
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_RESOURCE_START
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_RESOURCE_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_RESOURCE_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|pkt
operator|->
name|count
operator|/
literal|8
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|radeon_bo
modifier|*
name|texture
decl_stmt|,
modifier|*
name|mipmap
decl_stmt|;
name|u32
name|toffset
decl_stmt|,
name|moffset
decl_stmt|;
name|u32
name|size
decl_stmt|,
name|offset
decl_stmt|,
name|mip_address
decl_stmt|,
name|tex_dim
decl_stmt|;
switch|switch
condition|(
name|G__SQ_CONSTANT_TYPE
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|7
argument_list|)
argument_list|)
condition|)
block|{
case|case
name|SQ_TEX_VTX_VALID_TEXTURE
case|:
comment|/* tex base */
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE (tex)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|1
index|]
operator||=
name|TEX_ARRAY_MODE
argument_list|(
name|evergreen_cs_get_aray_mode
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
block|{
name|unsigned
name|bankw
decl_stmt|,
name|bankh
decl_stmt|,
name|mtaspect
decl_stmt|,
name|tile_split
decl_stmt|;
name|evergreen_tiling_fields
argument_list|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
argument_list|,
operator|&
name|bankw
argument_list|,
operator|&
name|bankh
argument_list|,
operator|&
name|mtaspect
argument_list|,
operator|&
name|tile_split
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|6
index|]
operator||=
name|TEX_TILE_SPLIT
argument_list|(
name|tile_split
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|7
index|]
operator||=
name|TEX_BANK_WIDTH
argument_list|(
name|bankw
argument_list|)
operator||
name|TEX_BANK_HEIGHT
argument_list|(
name|bankh
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|mtaspect
argument_list|)
operator||
name|TEX_NUM_BANKS
argument_list|(
name|evergreen_cs_get_num_banks
argument_list|(
name|track
operator|->
name|nbanks
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|texture
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|toffset
operator|=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* tex mip base */
name|tex_dim
operator|=
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|0
index|]
operator|&
literal|0x7
expr_stmt|;
name|mip_address
operator|=
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|3
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|tex_dim
operator|==
name|SQ_TEX_DIM_2D_MSAA
operator|||
name|tex_dim
operator|==
name|SQ_TEX_DIM_2D_ARRAY_MSAA
operator|)
operator|&&
operator|!
name|mip_address
operator|&&
operator|!
name|evergreen_cs_packet_next_is_pkt3_nop
argument_list|(
name|p
argument_list|)
condition|)
block|{
comment|/* MIP_ADDRESS should point to FMASK for an MSAA texture. 					 * It should be 0 if FMASK is disabled. */
name|moffset
operator|=
literal|0
expr_stmt|;
name|mipmap
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE (tex)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|moffset
operator|=
call|(
name|u32
call|)
argument_list|(
operator|(
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|mipmap
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
block|}
name|r
operator|=
name|evergreen_cs_track_validate_texture
argument_list|(
name|p
argument_list|,
name|texture
argument_list|,
name|mipmap
argument_list|,
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|2
index|]
operator|+=
name|toffset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|3
index|]
operator|+=
name|moffset
expr_stmt|;
break|break;
case|case
name|SQ_TEX_VTX_VALID_BUFFER
case|:
block|{
name|uint64_t
name|offset64
decl_stmt|;
comment|/* vtx base */
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE (vtx)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|0
argument_list|)
expr_stmt|;
name|size
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|&&
operator|(
name|size
operator|+
name|offset
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
comment|/* force size to size of the buffer */
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"vbo resource seems too big for the bo\n"
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|1
index|]
operator|=
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
operator|-
name|offset
expr_stmt|;
block|}
name|offset64
operator|=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|+
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|0
index|]
operator|=
name|offset64
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|2
index|]
operator|=
operator|(
name|ib
index|[
name|idx
operator|+
literal|1
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|+
literal|2
index|]
operator|&
literal|0xffffff00
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|offset64
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
break|break;
block|}
case|case
name|SQ_TEX_VTX_INVALID_TEXTURE
case|:
case|case
name|SQ_TEX_VTX_INVALID_BUFFER
case|:
default|default:
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
break|break;
case|case
name|PACKET3_SET_ALU_CONST
case|:
comment|/* XXX fix me ALU const buffers only */
break|break;
case|case
name|PACKET3_SET_BOOL_CONST
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_BOOL_CONST_START
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_BOOL_CONST_START
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_BOOL_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_BOOL_CONST_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_BOOL_CONST\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_SET_LOOP_CONST
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_LOOP_CONST_START
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_LOOP_CONST_START
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_LOOP_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_LOOP_CONST_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_LOOP_CONST\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_SET_CTL_CONST
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_CTL_CONST_START
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_CTL_CONST_START
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_CTL_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_CTL_CONST_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_CTL_CONST\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_SET_SAMPLER
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|%
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_SAMPLER\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_SAMPLER_START
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_SAMPLER_START
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_SAMPLER_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_SAMPLER_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_SAMPLER\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_STRMOUT_BUFFER_UPDATE
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BUFFER_UPDATE (invalid count)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Updating memory at DST_ADDRESS. */
if|if
condition|(
name|idx_value
operator|&
literal|0x1
condition|)
block|{
name|u64
name|offset
decl_stmt|;
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BUFFER_UPDATE (missing dst reloc)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|offset
operator|+
literal|4
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BUFFER_UPDATE dst bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|4
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
comment|/* Reading data from SRC_ADDRESS. */
if|if
condition|(
operator|(
operator|(
name|idx_value
operator|>>
literal|1
operator|)
operator|&
literal|0x3
operator|)
operator|==
literal|2
condition|)
block|{
name|u64
name|offset
decl_stmt|;
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BUFFER_UPDATE (missing src reloc)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|offset
operator|+
literal|4
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad STRMOUT_BUFFER_UPDATE src bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|4
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|4
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
break|break;
case|case
name|PACKET3_MEM_WRITE
case|:
block|{
name|u64
name|offset
decl_stmt|;
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad MEM_WRITE (invalid count)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad MEM_WRITE (missing reloc)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|0
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32UL
expr_stmt|;
if|if
condition|(
name|offset
operator|&
literal|0x7
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad MEM_WRITE (address not qwords aligned)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|offset
operator|+
literal|8
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad MEM_WRITE bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|8
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|0
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
break|break;
block|}
case|case
name|PACKET3_COPY_DW
case|:
if|if
condition|(
name|pkt
operator|->
name|count
operator|!=
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad COPY_DW (invalid count)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|idx_value
operator|&
literal|0x1
condition|)
block|{
name|u64
name|offset
decl_stmt|;
comment|/* SRC is memory. */
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad COPY_DW (missing src reloc)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|offset
operator|+
literal|4
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad COPY_DW src bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|4
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
comment|/* SRC is a reg. */
name|reg
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|evergreen_is_safe_reg
argument_list|(
name|p
argument_list|,
name|reg
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|idx_value
operator|&
literal|0x2
condition|)
block|{
name|u64
name|offset
decl_stmt|;
comment|/* DST is memory. */
name|r
operator|=
name|evergreen_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad COPY_DW (missing dst reloc)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
expr_stmt|;
name|offset
operator|+=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|offset
operator|+
literal|4
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad COPY_DW dst bo too small: 0x%jx, 0x%lx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|offset
operator|+
literal|4
argument_list|,
name|radeon_bo_size
argument_list|(
name|reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|offset
operator|+=
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|=
name|offset
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|4
index|]
operator|=
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
comment|/* DST is a reg. */
name|reg
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|evergreen_is_safe_reg
argument_list|(
name|p
argument_list|,
name|reg
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_NOP
case|:
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Packet3 opcode %x not supported\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|evergreen_cs_parse
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|radeon_cs_packet
name|pkt
decl_stmt|;
name|struct
name|evergreen_cs_track
modifier|*
name|track
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|track
operator|==
name|NULL
condition|)
block|{
comment|/* initialize tracker, we are in kms */
name|track
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|track
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|track
operator|==
name|NULL
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|evergreen_cs_track_init
argument_list|(
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
name|tmp
operator|=
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
expr_stmt|;
else|else
name|tmp
operator|=
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
expr_stmt|;
switch|switch
condition|(
name|tmp
operator|&
literal|0xf
condition|)
block|{
case|case
literal|0
case|:
name|track
operator|->
name|npipes
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|1
case|:
default|default:
name|track
operator|->
name|npipes
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|track
operator|->
name|npipes
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|track
operator|->
name|npipes
operator|=
literal|8
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
operator|(
name|tmp
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
condition|)
block|{
case|case
literal|0
case|:
name|track
operator|->
name|nbanks
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|1
case|:
default|default:
name|track
operator|->
name|nbanks
operator|=
literal|8
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|track
operator|->
name|nbanks
operator|=
literal|16
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
operator|(
name|tmp
operator|&
literal|0xf00
operator|)
operator|>>
literal|8
condition|)
block|{
case|case
literal|0
case|:
name|track
operator|->
name|group_size
operator|=
literal|256
expr_stmt|;
break|break;
case|case
literal|1
case|:
default|default:
name|track
operator|->
name|group_size
operator|=
literal|512
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
operator|(
name|tmp
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
condition|)
block|{
case|case
literal|0
case|:
name|track
operator|->
name|row_size
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|1
case|:
default|default:
name|track
operator|->
name|row_size
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|track
operator|->
name|row_size
operator|=
literal|4
expr_stmt|;
break|break;
block|}
name|p
operator|->
name|track
operator|=
name|track
expr_stmt|;
block|}
do|do
block|{
name|r
operator|=
name|evergreen_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
name|r
return|;
block|}
name|p
operator|->
name|idx
operator|+=
name|pkt
operator|.
name|count
operator|+
literal|2
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|.
name|type
condition|)
block|{
case|case
name|PACKET_TYPE0
case|:
name|r
operator|=
name|evergreen_cs_parse_packet0
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|)
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE2
case|:
break|break;
case|case
name|PACKET_TYPE3
case|:
name|r
operator|=
name|evergreen_packet3_check
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet type %d !\n"
argument_list|,
name|pkt
operator|.
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|r
condition|)
block|{
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
do|while
condition|(
name|p
operator|->
name|idx
operator|<
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
operator|.
name|length_dw
condition|)
do|;
if|#
directive|if
literal|0
block|for (r = 0; r< p->ib.length_dw; r++) { 		DRM_INFO("%05d  0x%08X\n", r, p->ib.ptr[r]); 		mdelay(1); 	}
endif|#
directive|endif
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  DMA  */
end_comment

begin_define
define|#
directive|define
name|GET_DMA_CMD
parameter_list|(
name|h
parameter_list|)
value|(((h)& 0xf0000000)>> 28)
end_define

begin_define
define|#
directive|define
name|GET_DMA_COUNT
parameter_list|(
name|h
parameter_list|)
value|((h)& 0x000fffff)
end_define

begin_define
define|#
directive|define
name|GET_DMA_T
parameter_list|(
name|h
parameter_list|)
value|(((h)& 0x00800000)>> 23)
end_define

begin_define
define|#
directive|define
name|GET_DMA_NEW
parameter_list|(
name|h
parameter_list|)
value|(((h)& 0x04000000)>> 26)
end_define

begin_define
define|#
directive|define
name|GET_DMA_MISC
parameter_list|(
name|h
parameter_list|)
value|(((h)& 0x0700000)>> 20)
end_define

begin_comment
comment|/**  * evergreen_dma_cs_parse() - parse the DMA IB  * @p:		parser structure holding parsing context.  *  * Parses the DMA IB from the CS ioctl and updates  * the GPU addresses based on the reloc information and  * checks for errors. (Evergreen-Cayman)  * Returns 0 for success and an error on failure.  **/
end_comment

begin_function
name|int
name|evergreen_dma_cs_parse
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|radeon_cs_chunk
modifier|*
name|ib_chunk
init|=
operator|&
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
decl_stmt|;
name|struct
name|radeon_cs_reloc
modifier|*
name|src_reloc
decl_stmt|,
modifier|*
name|dst_reloc
decl_stmt|,
modifier|*
name|dst2_reloc
decl_stmt|;
name|u32
name|header
decl_stmt|,
name|cmd
decl_stmt|,
name|count
decl_stmt|,
name|tiled
decl_stmt|,
name|new_cmd
decl_stmt|,
name|misc
decl_stmt|;
specifier|volatile
name|u32
modifier|*
name|ib
init|=
name|p
operator|->
name|ib
operator|.
name|ptr
decl_stmt|;
name|u32
name|idx
decl_stmt|,
name|idx_value
decl_stmt|;
name|u64
name|src_offset
decl_stmt|,
name|dst_offset
decl_stmt|,
name|dst2_offset
decl_stmt|;
name|int
name|r
decl_stmt|;
do|do
block|{
if|if
condition|(
name|p
operator|->
name|idx
operator|>=
name|ib_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Can not parse packet at %d after CS end %d !\n"
argument_list|,
name|p
operator|->
name|idx
argument_list|,
name|ib_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|idx
operator|=
name|p
operator|->
name|idx
expr_stmt|;
name|header
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|GET_DMA_CMD
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|count
operator|=
name|GET_DMA_COUNT
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|tiled
operator|=
name|GET_DMA_T
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|new_cmd
operator|=
name|GET_DMA_NEW
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|misc
operator|=
name|GET_DMA_MISC
argument_list|(
name|header
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|DMA_PACKET_WRITE
case|:
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|dst_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_WRITE\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|tiled
condition|)
block|{
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator|<<=
literal|8
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
name|count
operator|+
literal|7
expr_stmt|;
block|}
else|else
block|{
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
name|count
operator|+
literal|3
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA write buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|DMA_PACKET_COPY
case|:
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|src_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|dst_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|tiled
condition|)
block|{
name|idx_value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_cmd
condition|)
block|{
switch|switch
condition|(
name|misc
condition|)
block|{
case|case
literal|0
case|:
comment|/* L2T, frame to fields */
if|if
condition|(
name|idx_value
operator|&
operator|(
literal|1U
operator|<<
literal|31
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad L2T, frame to fields DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|dst2_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad L2T, frame to fields DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator|<<=
literal|8
expr_stmt|;
name|dst2_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
name|dst2_offset
operator|<<=
literal|8
expr_stmt|;
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|8
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|9
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, frame to fields src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, frame to fields buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst2_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst2_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, frame to fields buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst2_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst2_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst2_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|8
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|9
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|10
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* L2T, T2L partial */
if|if
condition|(
name|p
operator|->
name|family
operator|<
name|CHIP_CAYMAN
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"L2T, T2L Partial is cayman only !\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* detile bit */
if|if
condition|(
name|idx_value
operator|&
operator|(
literal|1U
operator|<<
literal|31
operator|)
condition|)
block|{
comment|/* tiled src, linear dst */
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|7
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|8
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
comment|/* linear src, tiled dst */
name|ib
index|[
name|idx
operator|+
literal|7
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|8
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
name|p
operator|->
name|idx
operator|+=
literal|12
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* L2T, broadcast */
if|if
condition|(
name|idx_value
operator|&
operator|(
literal|1U
operator|<<
literal|31
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad L2T, broadcast DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|dst2_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad L2T, broadcast DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator|<<=
literal|8
expr_stmt|;
name|dst2_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
name|dst2_offset
operator|<<=
literal|8
expr_stmt|;
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|8
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|9
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, broadcast src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, broadcast dst buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst2_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst2_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, broadcast dst2 buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst2_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst2_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst2_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|8
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|9
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|10
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* L2T, T2L */
comment|/* detile bit */
if|if
condition|(
name|idx_value
operator|&
operator|(
literal|1U
operator|<<
literal|31
operator|)
condition|)
block|{
comment|/* tiled src, linear dst */
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|src_offset
operator|<<=
literal|8
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|7
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|8
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|7
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|8
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
comment|/* linear src, tiled dst */
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|7
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|8
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|7
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|8
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator|<<=
literal|8
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, T2L src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, T2L dst buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|p
operator|->
name|idx
operator|+=
literal|9
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* T2T partial */
if|if
condition|(
name|p
operator|->
name|family
operator|<
name|CHIP_CAYMAN
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"L2T, T2L Partial is cayman only !\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|4
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|13
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* L2T, broadcast */
if|if
condition|(
name|idx_value
operator|&
operator|(
literal|1U
operator|<<
literal|31
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad L2T, broadcast DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|dst2_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad L2T, broadcast DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator|<<=
literal|8
expr_stmt|;
name|dst2_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
name|dst2_offset
operator|<<=
literal|8
expr_stmt|;
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|8
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|9
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, broadcast src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, broadcast dst buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst2_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst2_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, broadcast dst2 buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst2_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst2_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst2_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|8
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|9
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|10
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_COPY misc %u\n"
argument_list|,
name|misc
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|misc
condition|)
block|{
case|case
literal|0
case|:
comment|/* detile bit */
if|if
condition|(
name|idx_value
operator|&
operator|(
literal|1U
operator|<<
literal|31
operator|)
condition|)
block|{
comment|/* tiled src, linear dst */
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|src_offset
operator|<<=
literal|8
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|7
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|8
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|7
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|8
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
comment|/* linear src, tiled dst */
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|7
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|8
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|7
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|8
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator|<<=
literal|8
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, broadcast src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2T, broadcast dst buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|p
operator|->
name|idx
operator|+=
literal|9
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_COPY misc %u\n"
argument_list|,
name|misc
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|new_cmd
condition|)
block|{
switch|switch
condition|(
name|misc
condition|)
block|{
case|case
literal|0
case|:
comment|/* L2L, byte */
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|src_offset
operator|+
name|count
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2L, byte src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|src_offset
operator|+
name|count
argument_list|,
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
name|count
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2L, byte dst buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
name|count
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|4
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|5
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* L2L, partial */
if|if
condition|(
name|p
operator|->
name|family
operator|<
name|CHIP_CAYMAN
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"L2L Partial is cayman only !\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|4
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|5
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|9
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* L2L, dw, broadcast */
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|dst2_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad L2L, dw, broadcast DMA_PACKET_COPY\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|dst2_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
name|dst2_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|5
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|6
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2L, dw, broadcast src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2L, dw, broadcast dst buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst2_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst2_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2L, dw, broadcast dst2 buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst2_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst2_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst2_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|4
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|5
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst2_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|6
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|7
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_COPY misc %u\n"
argument_list|,
name|misc
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
comment|/* L2L, dw */
name|src_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
name|src_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|4
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2L, dw src buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|src_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|src_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA L2L, dw dst buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|4
index|]
operator|+=
name|upper_32_bits
argument_list|(
name|src_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|5
expr_stmt|;
block|}
block|}
break|break;
case|case
name|DMA_PACKET_CONSTANT_FILL
case|:
name|r
operator|=
name|r600_dma_cs_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|dst_reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_CONSTANT_FILL\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dst_offset
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dst_offset
operator||=
operator|(
call|(
name|u64
call|)
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
operator|&
literal|0x00ff0000
argument_list|)
operator|)
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
operator|(
name|dst_offset
operator|+
operator|(
name|count
operator|*
literal|4
operator|)
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|p
operator|->
name|dev
argument_list|,
literal|"DMA constant fill buffer too small (%ju %lu)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|dst_offset
argument_list|,
name|radeon_bo_size
argument_list|(
name|dst_reloc
operator|->
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|+=
call|(
name|u32
call|)
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|+=
operator|(
name|upper_32_bits
argument_list|(
name|dst_reloc
operator|->
name|lobj
operator|.
name|gpu_offset
argument_list|)
operator|<<
literal|16
operator|)
operator|&
literal|0x00ff0000
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|DMA_PACKET_NOP
case|:
name|p
operator|->
name|idx
operator|+=
literal|1
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet type %d at %d !\n"
argument_list|,
name|cmd
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
do|while
condition|(
name|p
operator|->
name|idx
operator|<
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
operator|.
name|length_dw
condition|)
do|;
if|#
directive|if
literal|0
block|for (r = 0; r< p->ib->length_dw; r++) { 		DRM_INFO("%05d  0x%08X\n", r, p->ib.ptr[r]); 		mdelay(1); 	}
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* vm parser */
end_comment

begin_function
specifier|static
name|bool
name|evergreen_vm_reg_valid
parameter_list|(
name|u32
name|reg
parameter_list|)
block|{
comment|/* context regs are fine */
if|if
condition|(
name|reg
operator|>=
literal|0x28000
condition|)
return|return
name|true
return|;
comment|/* check config regs */
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|WAIT_UNTIL
case|:
case|case
name|GRBM_GFX_INDEX
case|:
case|case
name|CP_STRMOUT_CNTL
case|:
case|case
name|CP_COHER_CNTL
case|:
case|case
name|CP_COHER_SIZE
case|:
case|case
name|VGT_VTX_VECT_EJECT_REG
case|:
case|case
name|VGT_CACHE_INVALIDATION
case|:
case|case
name|VGT_GS_VERTEX_REUSE
case|:
case|case
name|VGT_PRIMITIVE_TYPE
case|:
case|case
name|VGT_INDEX_TYPE
case|:
case|case
name|VGT_NUM_INDICES
case|:
case|case
name|VGT_NUM_INSTANCES
case|:
case|case
name|VGT_COMPUTE_DIM_X
case|:
case|case
name|VGT_COMPUTE_DIM_Y
case|:
case|case
name|VGT_COMPUTE_DIM_Z
case|:
case|case
name|VGT_COMPUTE_START_X
case|:
case|case
name|VGT_COMPUTE_START_Y
case|:
case|case
name|VGT_COMPUTE_START_Z
case|:
case|case
name|VGT_COMPUTE_INDEX
case|:
case|case
name|VGT_COMPUTE_THREAD_GROUP_SIZE
case|:
case|case
name|VGT_HS_OFFCHIP_PARAM
case|:
case|case
name|PA_CL_ENHANCE
case|:
case|case
name|PA_SU_LINE_STIPPLE_VALUE
case|:
case|case
name|PA_SC_LINE_STIPPLE_STATE
case|:
case|case
name|PA_SC_ENHANCE
case|:
case|case
name|SQ_DYN_GPR_CNTL_PS_FLUSH_REQ
case|:
case|case
name|SQ_DYN_GPR_SIMD_LOCK_EN
case|:
case|case
name|SQ_CONFIG
case|:
case|case
name|SQ_GPR_RESOURCE_MGMT_1
case|:
case|case
name|SQ_GLOBAL_GPR_RESOURCE_MGMT_1
case|:
case|case
name|SQ_GLOBAL_GPR_RESOURCE_MGMT_2
case|:
case|case
name|SQ_CONST_MEM_BASE
case|:
case|case
name|SQ_STATIC_THREAD_MGMT_1
case|:
case|case
name|SQ_STATIC_THREAD_MGMT_2
case|:
case|case
name|SQ_STATIC_THREAD_MGMT_3
case|:
case|case
name|SPI_CONFIG_CNTL
case|:
case|case
name|SPI_CONFIG_CNTL_1
case|:
case|case
name|TA_CNTL_AUX
case|:
case|case
name|DB_DEBUG
case|:
case|case
name|DB_DEBUG2
case|:
case|case
name|DB_DEBUG3
case|:
case|case
name|DB_DEBUG4
case|:
case|case
name|DB_WATERMARKS
case|:
case|case
name|TD_PS_BORDER_COLOR_INDEX
case|:
case|case
name|TD_PS_BORDER_COLOR_RED
case|:
case|case
name|TD_PS_BORDER_COLOR_GREEN
case|:
case|case
name|TD_PS_BORDER_COLOR_BLUE
case|:
case|case
name|TD_PS_BORDER_COLOR_ALPHA
case|:
case|case
name|TD_VS_BORDER_COLOR_INDEX
case|:
case|case
name|TD_VS_BORDER_COLOR_RED
case|:
case|case
name|TD_VS_BORDER_COLOR_GREEN
case|:
case|case
name|TD_VS_BORDER_COLOR_BLUE
case|:
case|case
name|TD_VS_BORDER_COLOR_ALPHA
case|:
case|case
name|TD_GS_BORDER_COLOR_INDEX
case|:
case|case
name|TD_GS_BORDER_COLOR_RED
case|:
case|case
name|TD_GS_BORDER_COLOR_GREEN
case|:
case|case
name|TD_GS_BORDER_COLOR_BLUE
case|:
case|case
name|TD_GS_BORDER_COLOR_ALPHA
case|:
case|case
name|TD_HS_BORDER_COLOR_INDEX
case|:
case|case
name|TD_HS_BORDER_COLOR_RED
case|:
case|case
name|TD_HS_BORDER_COLOR_GREEN
case|:
case|case
name|TD_HS_BORDER_COLOR_BLUE
case|:
case|case
name|TD_HS_BORDER_COLOR_ALPHA
case|:
case|case
name|TD_LS_BORDER_COLOR_INDEX
case|:
case|case
name|TD_LS_BORDER_COLOR_RED
case|:
case|case
name|TD_LS_BORDER_COLOR_GREEN
case|:
case|case
name|TD_LS_BORDER_COLOR_BLUE
case|:
case|case
name|TD_LS_BORDER_COLOR_ALPHA
case|:
case|case
name|TD_CS_BORDER_COLOR_INDEX
case|:
case|case
name|TD_CS_BORDER_COLOR_RED
case|:
case|case
name|TD_CS_BORDER_COLOR_GREEN
case|:
case|case
name|TD_CS_BORDER_COLOR_BLUE
case|:
case|case
name|TD_CS_BORDER_COLOR_ALPHA
case|:
case|case
name|SQ_ESGS_RING_SIZE
case|:
case|case
name|SQ_GSVS_RING_SIZE
case|:
case|case
name|SQ_ESTMP_RING_SIZE
case|:
case|case
name|SQ_GSTMP_RING_SIZE
case|:
case|case
name|SQ_HSTMP_RING_SIZE
case|:
case|case
name|SQ_LSTMP_RING_SIZE
case|:
case|case
name|SQ_PSTMP_RING_SIZE
case|:
case|case
name|SQ_VSTMP_RING_SIZE
case|:
case|case
name|SQ_ESGS_RING_ITEMSIZE
case|:
case|case
name|SQ_ESTMP_RING_ITEMSIZE
case|:
case|case
name|SQ_GSTMP_RING_ITEMSIZE
case|:
case|case
name|SQ_GSVS_RING_ITEMSIZE
case|:
case|case
name|SQ_GS_VERT_ITEMSIZE
case|:
case|case
name|SQ_GS_VERT_ITEMSIZE_1
case|:
case|case
name|SQ_GS_VERT_ITEMSIZE_2
case|:
case|case
name|SQ_GS_VERT_ITEMSIZE_3
case|:
case|case
name|SQ_GSVS_RING_OFFSET_1
case|:
case|case
name|SQ_GSVS_RING_OFFSET_2
case|:
case|case
name|SQ_GSVS_RING_OFFSET_3
case|:
case|case
name|SQ_HSTMP_RING_ITEMSIZE
case|:
case|case
name|SQ_LSTMP_RING_ITEMSIZE
case|:
case|case
name|SQ_PSTMP_RING_ITEMSIZE
case|:
case|case
name|SQ_VSTMP_RING_ITEMSIZE
case|:
case|case
name|VGT_TF_RING_SIZE
case|:
case|case
name|SQ_ESGS_RING_BASE
case|:
case|case
name|SQ_GSVS_RING_BASE
case|:
case|case
name|SQ_ESTMP_RING_BASE
case|:
case|case
name|SQ_GSTMP_RING_BASE
case|:
case|case
name|SQ_HSTMP_RING_BASE
case|:
case|case
name|SQ_LSTMP_RING_BASE
case|:
case|case
name|SQ_PSTMP_RING_BASE
case|:
case|case
name|SQ_VSTMP_RING_BASE
case|:
case|case
name|CAYMAN_VGT_OFFCHIP_LDS_BASE
case|:
case|case
name|CAYMAN_SQ_EX_ALLOC_TABLE_SLOTS
case|:
return|return
name|true
return|;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid register 0x%x in CS\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_vm_packet3_check
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
modifier|*
name|ib
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|u32
name|idx
init|=
name|pkt
operator|->
name|idx
operator|+
literal|1
decl_stmt|;
name|u32
name|idx_value
init|=
name|ib
index|[
name|idx
index|]
decl_stmt|;
name|u32
name|start_reg
decl_stmt|,
name|end_reg
decl_stmt|,
name|reg
decl_stmt|,
name|i
decl_stmt|;
name|u32
name|command
decl_stmt|,
name|info
decl_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|opcode
condition|)
block|{
case|case
name|PACKET3_NOP
case|:
case|case
name|PACKET3_SET_BASE
case|:
case|case
name|PACKET3_CLEAR_STATE
case|:
case|case
name|PACKET3_INDEX_BUFFER_SIZE
case|:
case|case
name|PACKET3_DISPATCH_DIRECT
case|:
case|case
name|PACKET3_DISPATCH_INDIRECT
case|:
case|case
name|PACKET3_MODE_CONTROL
case|:
case|case
name|PACKET3_SET_PREDICATION
case|:
case|case
name|PACKET3_COND_EXEC
case|:
case|case
name|PACKET3_PRED_EXEC
case|:
case|case
name|PACKET3_DRAW_INDIRECT
case|:
case|case
name|PACKET3_DRAW_INDEX_INDIRECT
case|:
case|case
name|PACKET3_INDEX_BASE
case|:
case|case
name|PACKET3_DRAW_INDEX_2
case|:
case|case
name|PACKET3_CONTEXT_CONTROL
case|:
case|case
name|PACKET3_DRAW_INDEX_OFFSET
case|:
case|case
name|PACKET3_INDEX_TYPE
case|:
case|case
name|PACKET3_DRAW_INDEX
case|:
case|case
name|PACKET3_DRAW_INDEX_AUTO
case|:
case|case
name|PACKET3_DRAW_INDEX_IMMD
case|:
case|case
name|PACKET3_NUM_INSTANCES
case|:
case|case
name|PACKET3_DRAW_INDEX_MULTI_AUTO
case|:
case|case
name|PACKET3_STRMOUT_BUFFER_UPDATE
case|:
case|case
name|PACKET3_DRAW_INDEX_OFFSET_2
case|:
case|case
name|PACKET3_DRAW_INDEX_MULTI_ELEMENT
case|:
case|case
name|PACKET3_MPEG_INDEX
case|:
case|case
name|PACKET3_WAIT_REG_MEM
case|:
case|case
name|PACKET3_MEM_WRITE
case|:
case|case
name|PACKET3_SURFACE_SYNC
case|:
case|case
name|PACKET3_EVENT_WRITE
case|:
case|case
name|PACKET3_EVENT_WRITE_EOP
case|:
case|case
name|PACKET3_EVENT_WRITE_EOS
case|:
case|case
name|PACKET3_SET_CONTEXT_REG
case|:
case|case
name|PACKET3_SET_BOOL_CONST
case|:
case|case
name|PACKET3_SET_LOOP_CONST
case|:
case|case
name|PACKET3_SET_RESOURCE
case|:
case|case
name|PACKET3_SET_SAMPLER
case|:
case|case
name|PACKET3_SET_CTL_CONST
case|:
case|case
name|PACKET3_SET_RESOURCE_OFFSET
case|:
case|case
name|PACKET3_SET_CONTEXT_REG_INDIRECT
case|:
case|case
name|PACKET3_SET_RESOURCE_INDIRECT
case|:
case|case
name|CAYMAN_PACKET3_DEALLOC_STATE
case|:
break|break;
case|case
name|PACKET3_COND_WRITE
case|:
if|if
condition|(
name|idx_value
operator|&
literal|0x100
condition|)
block|{
name|reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|5
index|]
operator|*
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|evergreen_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_COPY_DW
case|:
if|if
condition|(
name|idx_value
operator|&
literal|0x2
condition|)
block|{
name|reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|*
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|evergreen_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_SET_CONFIG_REG
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_CONFIG_REG_START
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_CONFIG_REG_START
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_CONFIG_REG_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_CONFIG_REG_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad PACKET3_SET_CONFIG_REG\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pkt
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|evergreen_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_CP_DMA
case|:
name|command
operator|=
name|ib
index|[
name|idx
operator|+
literal|4
index|]
expr_stmt|;
name|info
operator|=
name|ib
index|[
name|idx
operator|+
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|(
operator|(
operator|(
name|info
operator|&
literal|0x60000000
operator|)
operator|>>
literal|29
operator|)
operator|!=
literal|0
operator|)
operator|||
comment|/* src = GDS or DATA */
operator|(
operator|(
operator|(
name|info
operator|&
literal|0x00300000
operator|)
operator|>>
literal|20
operator|)
operator|!=
literal|0
operator|)
operator|||
comment|/* dst = GDS */
operator|(
operator|(
operator|(
operator|(
name|info
operator|&
literal|0x00300000
operator|)
operator|>>
literal|20
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_DAS
operator|)
operator|)
operator|||
comment|/* dst = register */
operator|(
operator|(
operator|(
operator|(
name|info
operator|&
literal|0x60000000
operator|)
operator|>>
literal|29
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_SAS
operator|)
operator|)
condition|)
block|{
comment|/* src = register */
comment|/* non mem to mem copies requires dw aligned count */
if|if
condition|(
operator|(
name|command
operator|&
literal|0x1fffff
operator|)
operator|%
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA command requires dw count alignment\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_SAS
condition|)
block|{
comment|/* src address space is register */
if|if
condition|(
operator|(
operator|(
name|info
operator|&
literal|0x60000000
operator|)
operator|>>
literal|29
operator|)
operator|==
literal|0
condition|)
block|{
name|start_reg
operator|=
name|idx_value
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_SAIC
condition|)
block|{
name|reg
operator|=
name|start_reg
expr_stmt|;
if|if
condition|(
operator|!
name|evergreen_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA Bad SRC register\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|command
operator|&
literal|0x1fffff
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|evergreen_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA Bad SRC register\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
block|}
block|}
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_DAS
condition|)
block|{
comment|/* dst address space is register */
if|if
condition|(
operator|(
operator|(
name|info
operator|&
literal|0x00300000
operator|)
operator|>>
literal|20
operator|)
operator|==
literal|0
condition|)
block|{
name|start_reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_DAIC
condition|)
block|{
name|reg
operator|=
name|start_reg
expr_stmt|;
if|if
condition|(
operator|!
name|evergreen_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA Bad DST register\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|command
operator|&
literal|0x1fffff
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|evergreen_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA Bad DST register\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
block|}
block|}
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|evergreen_ib_parse
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|u32
name|idx
init|=
literal|0
decl_stmt|;
name|struct
name|radeon_cs_packet
name|pkt
decl_stmt|;
do|do
block|{
name|pkt
operator|.
name|idx
operator|=
name|idx
expr_stmt|;
name|pkt
operator|.
name|type
operator|=
name|CP_PACKET_GET_TYPE
argument_list|(
name|ib
operator|->
name|ptr
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|pkt
operator|.
name|count
operator|=
name|CP_PACKET_GET_COUNT
argument_list|(
name|ib
operator|->
name|ptr
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|pkt
operator|.
name|one_reg_wr
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|.
name|type
condition|)
block|{
case|case
name|PACKET_TYPE0
case|:
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Packet0 not allowed!\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE2
case|:
name|idx
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE3
case|:
name|pkt
operator|.
name|opcode
operator|=
name|CP_PACKET3_GET_OPCODE
argument_list|(
name|ib
operator|->
name|ptr
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|ret
operator|=
name|evergreen_vm_packet3_check
argument_list|(
name|rdev
argument_list|,
name|ib
operator|->
name|ptr
argument_list|,
operator|&
name|pkt
argument_list|)
expr_stmt|;
name|idx
operator|+=
name|pkt
operator|.
name|count
operator|+
literal|2
expr_stmt|;
break|break;
default|default:
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Unknown packet type %d !\n"
argument_list|,
name|pkt
operator|.
name|type
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ret
condition|)
break|break;
block|}
do|while
condition|(
name|idx
operator|<
name|ib
operator|->
name|length_dw
condition|)
do|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * evergreen_dma_ib_parse() - parse the DMA IB for VM  * @rdev: radeon_device pointer  * @ib:	radeon_ib pointer  *  * Parses the DMA IB from the VM CS ioctl  * checks for errors. (Cayman-SI)  * Returns 0 for success and an error on failure.  **/
end_comment

begin_function
name|int
name|evergreen_dma_ib_parse
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|u32
name|idx
init|=
literal|0
decl_stmt|;
name|u32
name|header
decl_stmt|,
name|cmd
decl_stmt|,
name|count
decl_stmt|,
name|tiled
decl_stmt|,
name|new_cmd
decl_stmt|,
name|misc
decl_stmt|;
do|do
block|{
name|header
operator|=
name|ib
operator|->
name|ptr
index|[
name|idx
index|]
expr_stmt|;
name|cmd
operator|=
name|GET_DMA_CMD
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|count
operator|=
name|GET_DMA_COUNT
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|tiled
operator|=
name|GET_DMA_T
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|new_cmd
operator|=
name|GET_DMA_NEW
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|misc
operator|=
name|GET_DMA_MISC
argument_list|(
name|header
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|DMA_PACKET_WRITE
case|:
if|if
condition|(
name|tiled
condition|)
name|idx
operator|+=
name|count
operator|+
literal|7
expr_stmt|;
else|else
name|idx
operator|+=
name|count
operator|+
literal|3
expr_stmt|;
break|break;
case|case
name|DMA_PACKET_COPY
case|:
if|if
condition|(
name|tiled
condition|)
block|{
if|if
condition|(
name|new_cmd
condition|)
block|{
switch|switch
condition|(
name|misc
condition|)
block|{
case|case
literal|0
case|:
comment|/* L2T, frame to fields */
name|idx
operator|+=
literal|10
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* L2T, T2L partial */
name|idx
operator|+=
literal|12
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* L2T, broadcast */
name|idx
operator|+=
literal|10
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* L2T, T2L */
name|idx
operator|+=
literal|9
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* T2T partial */
name|idx
operator|+=
literal|13
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* L2T, broadcast */
name|idx
operator|+=
literal|10
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_COPY misc %u\n"
argument_list|,
name|misc
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|misc
condition|)
block|{
case|case
literal|0
case|:
name|idx
operator|+=
literal|9
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_COPY misc %u\n"
argument_list|,
name|misc
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|new_cmd
condition|)
block|{
switch|switch
condition|(
name|misc
condition|)
block|{
case|case
literal|0
case|:
comment|/* L2L, byte */
name|idx
operator|+=
literal|5
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* L2L, partial */
name|idx
operator|+=
literal|9
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* L2L, dw, broadcast */
name|idx
operator|+=
literal|7
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"bad DMA_PACKET_COPY misc %u\n"
argument_list|,
name|misc
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
comment|/* L2L, dw */
name|idx
operator|+=
literal|5
expr_stmt|;
block|}
block|}
break|break;
case|case
name|DMA_PACKET_CONSTANT_FILL
case|:
name|idx
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|DMA_PACKET_NOP
case|:
name|idx
operator|+=
literal|1
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet type %d at %d !\n"
argument_list|,
name|cmd
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
do|while
condition|(
name|idx
operator|<
name|ib
operator|->
name|length_dw
condition|)
do|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**  * \file radeon_ioc32.c  *  * 32-bit ioctl compatibility routines for the Radeon DRM.  *  * \author Paul Mackerras<paulus@samba.org>  *  * Copyright (C) Paul Mackerras 2005  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE AUTHOR BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,  * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,  * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS  * IN THE SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<linux/compat.h>
end_include

begin_include
include|#
directive|include
file|<drm/drmP.h>
end_include

begin_include
include|#
directive|include
file|<drm/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon_drv.h"
end_include

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_init32
block|{
name|int
name|func
decl_stmt|;
name|u32
name|sarea_priv_offset
decl_stmt|;
name|int
name|is_pci
decl_stmt|;
name|int
name|cp_mode
decl_stmt|;
name|int
name|gart_size
decl_stmt|;
name|int
name|ring_size
decl_stmt|;
name|int
name|usec_timeout
decl_stmt|;
name|unsigned
name|int
name|fb_bpp
decl_stmt|;
name|unsigned
name|int
name|front_offset
decl_stmt|,
name|front_pitch
decl_stmt|;
name|unsigned
name|int
name|back_offset
decl_stmt|,
name|back_pitch
decl_stmt|;
name|unsigned
name|int
name|depth_bpp
decl_stmt|;
name|unsigned
name|int
name|depth_offset
decl_stmt|,
name|depth_pitch
decl_stmt|;
name|u32
name|fb_offset
decl_stmt|;
name|u32
name|mmio_offset
decl_stmt|;
name|u32
name|ring_offset
decl_stmt|;
name|u32
name|ring_rptr_offset
decl_stmt|;
name|u32
name|buffers_offset
decl_stmt|;
name|u32
name|gart_textures_offset
decl_stmt|;
block|}
name|drm_radeon_init32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_radeon_cp_init
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|drm_radeon_init32_t
name|init32
decl_stmt|;
name|drm_radeon_init_t
name|__user
modifier|*
name|init
decl_stmt|;
if|if
condition|(
name|copy_from_user
argument_list|(
operator|&
name|init32
argument_list|,
operator|(
name|void
name|__user
operator|*
operator|)
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|init32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|init
operator|=
name|compat_alloc_user_space
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|init
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|access_ok
argument_list|(
name|VERIFY_WRITE
argument_list|,
name|init
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|init
argument_list|)
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|func
argument_list|,
operator|&
name|init
operator|->
name|func
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|sarea_priv_offset
argument_list|,
operator|&
name|init
operator|->
name|sarea_priv_offset
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|is_pci
argument_list|,
operator|&
name|init
operator|->
name|is_pci
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|cp_mode
argument_list|,
operator|&
name|init
operator|->
name|cp_mode
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|gart_size
argument_list|,
operator|&
name|init
operator|->
name|gart_size
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|ring_size
argument_list|,
operator|&
name|init
operator|->
name|ring_size
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|usec_timeout
argument_list|,
operator|&
name|init
operator|->
name|usec_timeout
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|fb_bpp
argument_list|,
operator|&
name|init
operator|->
name|fb_bpp
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|front_offset
argument_list|,
operator|&
name|init
operator|->
name|front_offset
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|front_pitch
argument_list|,
operator|&
name|init
operator|->
name|front_pitch
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|back_offset
argument_list|,
operator|&
name|init
operator|->
name|back_offset
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|back_pitch
argument_list|,
operator|&
name|init
operator|->
name|back_pitch
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|depth_bpp
argument_list|,
operator|&
name|init
operator|->
name|depth_bpp
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|depth_offset
argument_list|,
operator|&
name|init
operator|->
name|depth_offset
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|depth_pitch
argument_list|,
operator|&
name|init
operator|->
name|depth_pitch
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|fb_offset
argument_list|,
operator|&
name|init
operator|->
name|fb_offset
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|mmio_offset
argument_list|,
operator|&
name|init
operator|->
name|mmio_offset
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|ring_offset
argument_list|,
operator|&
name|init
operator|->
name|ring_offset
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|ring_rptr_offset
argument_list|,
operator|&
name|init
operator|->
name|ring_rptr_offset
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|buffers_offset
argument_list|,
operator|&
name|init
operator|->
name|buffers_offset
argument_list|)
operator|||
name|__put_user
argument_list|(
name|init32
operator|.
name|gart_textures_offset
argument_list|,
operator|&
name|init
operator|->
name|gart_textures_offset
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
name|drm_ioctl
argument_list|(
name|file
argument_list|,
name|DRM_IOCTL_RADEON_CP_INIT
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|init
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_clear32
block|{
name|unsigned
name|int
name|flags
decl_stmt|;
name|unsigned
name|int
name|clear_color
decl_stmt|;
name|unsigned
name|int
name|clear_depth
decl_stmt|;
name|unsigned
name|int
name|color_mask
decl_stmt|;
name|unsigned
name|int
name|depth_mask
decl_stmt|;
comment|/* misnamed field:  should be stencil */
name|u32
name|depth_boxes
decl_stmt|;
block|}
name|drm_radeon_clear32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_radeon_cp_clear
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|drm_radeon_clear32_t
name|clr32
decl_stmt|;
name|drm_radeon_clear_t
name|__user
modifier|*
name|clr
decl_stmt|;
if|if
condition|(
name|copy_from_user
argument_list|(
operator|&
name|clr32
argument_list|,
operator|(
name|void
name|__user
operator|*
operator|)
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|clr32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|clr
operator|=
name|compat_alloc_user_space
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|clr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|access_ok
argument_list|(
name|VERIFY_WRITE
argument_list|,
name|clr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|clr
argument_list|)
argument_list|)
operator|||
name|__put_user
argument_list|(
name|clr32
operator|.
name|flags
argument_list|,
operator|&
name|clr
operator|->
name|flags
argument_list|)
operator|||
name|__put_user
argument_list|(
name|clr32
operator|.
name|clear_color
argument_list|,
operator|&
name|clr
operator|->
name|clear_color
argument_list|)
operator|||
name|__put_user
argument_list|(
name|clr32
operator|.
name|clear_depth
argument_list|,
operator|&
name|clr
operator|->
name|clear_depth
argument_list|)
operator|||
name|__put_user
argument_list|(
name|clr32
operator|.
name|color_mask
argument_list|,
operator|&
name|clr
operator|->
name|color_mask
argument_list|)
operator|||
name|__put_user
argument_list|(
name|clr32
operator|.
name|depth_mask
argument_list|,
operator|&
name|clr
operator|->
name|depth_mask
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
name|void
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|clr32
operator|.
name|depth_boxes
argument_list|,
operator|&
name|clr
operator|->
name|depth_boxes
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
name|drm_ioctl
argument_list|(
name|file
argument_list|,
name|DRM_IOCTL_RADEON_CLEAR
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|clr
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_stipple32
block|{
name|u32
name|mask
decl_stmt|;
block|}
name|drm_radeon_stipple32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_radeon_cp_stipple
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|drm_radeon_stipple32_t
name|__user
modifier|*
name|argp
init|=
operator|(
name|void
name|__user
operator|*
operator|)
name|arg
decl_stmt|;
name|drm_radeon_stipple_t
name|__user
modifier|*
name|request
decl_stmt|;
name|u32
name|mask
decl_stmt|;
if|if
condition|(
name|get_user
argument_list|(
name|mask
argument_list|,
operator|&
name|argp
operator|->
name|mask
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|request
operator|=
name|compat_alloc_user_space
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|access_ok
argument_list|(
name|VERIFY_WRITE
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
name|unsigned
name|int
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|mask
argument_list|,
operator|&
name|request
operator|->
name|mask
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
name|drm_ioctl
argument_list|(
name|file
argument_list|,
name|DRM_IOCTL_RADEON_STIPPLE
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|request
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_tex_image32
block|{
name|unsigned
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
comment|/* Blit coordinates */
name|unsigned
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|u32
name|data
decl_stmt|;
block|}
name|drm_radeon_tex_image32_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_texture32
block|{
name|unsigned
name|int
name|offset
decl_stmt|;
name|int
name|pitch
decl_stmt|;
name|int
name|format
decl_stmt|;
name|int
name|width
decl_stmt|;
comment|/* Texture image coordinates */
name|int
name|height
decl_stmt|;
name|u32
name|image
decl_stmt|;
block|}
name|drm_radeon_texture32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_radeon_cp_texture
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|drm_radeon_texture32_t
name|req32
decl_stmt|;
name|drm_radeon_texture_t
name|__user
modifier|*
name|request
decl_stmt|;
name|drm_radeon_tex_image32_t
name|img32
decl_stmt|;
name|drm_radeon_tex_image_t
name|__user
modifier|*
name|image
decl_stmt|;
if|if
condition|(
name|copy_from_user
argument_list|(
operator|&
name|req32
argument_list|,
operator|(
name|void
name|__user
operator|*
operator|)
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|req32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
if|if
condition|(
name|req32
operator|.
name|image
operator|==
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|copy_from_user
argument_list|(
operator|&
name|img32
argument_list|,
operator|(
name|void
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|.
name|image
argument_list|,
sizeof|sizeof
argument_list|(
name|img32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|request
operator|=
name|compat_alloc_user_space
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|image
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|access_ok
argument_list|(
name|VERIFY_WRITE
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|image
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|image
operator|=
operator|(
name|drm_radeon_tex_image_t
name|__user
operator|*
operator|)
operator|(
name|request
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|__put_user
argument_list|(
name|req32
operator|.
name|offset
argument_list|,
operator|&
name|request
operator|->
name|offset
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|pitch
argument_list|,
operator|&
name|request
operator|->
name|pitch
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|format
argument_list|,
operator|&
name|request
operator|->
name|format
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|width
argument_list|,
operator|&
name|request
operator|->
name|width
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|height
argument_list|,
operator|&
name|request
operator|->
name|height
argument_list|)
operator|||
name|__put_user
argument_list|(
name|image
argument_list|,
operator|&
name|request
operator|->
name|image
argument_list|)
operator|||
name|__put_user
argument_list|(
name|img32
operator|.
name|x
argument_list|,
operator|&
name|image
operator|->
name|x
argument_list|)
operator|||
name|__put_user
argument_list|(
name|img32
operator|.
name|y
argument_list|,
operator|&
name|image
operator|->
name|y
argument_list|)
operator|||
name|__put_user
argument_list|(
name|img32
operator|.
name|width
argument_list|,
operator|&
name|image
operator|->
name|width
argument_list|)
operator|||
name|__put_user
argument_list|(
name|img32
operator|.
name|height
argument_list|,
operator|&
name|image
operator|->
name|height
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
specifier|const
name|void
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|img32
operator|.
name|data
argument_list|,
operator|&
name|image
operator|->
name|data
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
name|drm_ioctl
argument_list|(
name|file
argument_list|,
name|DRM_IOCTL_RADEON_TEXTURE
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|request
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_vertex2_32
block|{
name|int
name|idx
decl_stmt|;
comment|/* Index of vertex buffer */
name|int
name|discard
decl_stmt|;
comment|/* Client finished with buffer? */
name|int
name|nr_states
decl_stmt|;
name|u32
name|state
decl_stmt|;
name|int
name|nr_prims
decl_stmt|;
name|u32
name|prim
decl_stmt|;
block|}
name|drm_radeon_vertex2_32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_radeon_cp_vertex2
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|drm_radeon_vertex2_32_t
name|req32
decl_stmt|;
name|drm_radeon_vertex2_t
name|__user
modifier|*
name|request
decl_stmt|;
if|if
condition|(
name|copy_from_user
argument_list|(
operator|&
name|req32
argument_list|,
operator|(
name|void
name|__user
operator|*
operator|)
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|req32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|request
operator|=
name|compat_alloc_user_space
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|access_ok
argument_list|(
name|VERIFY_WRITE
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|idx
argument_list|,
operator|&
name|request
operator|->
name|idx
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|discard
argument_list|,
operator|&
name|request
operator|->
name|discard
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|nr_states
argument_list|,
operator|&
name|request
operator|->
name|nr_states
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
name|void
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|.
name|state
argument_list|,
operator|&
name|request
operator|->
name|state
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|nr_prims
argument_list|,
operator|&
name|request
operator|->
name|nr_prims
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
name|void
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|.
name|prim
argument_list|,
operator|&
name|request
operator|->
name|prim
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
name|drm_ioctl
argument_list|(
name|file
argument_list|,
name|DRM_IOCTL_RADEON_VERTEX2
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|request
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_cmd_buffer32
block|{
name|int
name|bufsz
decl_stmt|;
name|u32
name|buf
decl_stmt|;
name|int
name|nbox
decl_stmt|;
name|u32
name|boxes
decl_stmt|;
block|}
name|drm_radeon_cmd_buffer32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_radeon_cp_cmdbuf
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|drm_radeon_cmd_buffer32_t
name|req32
decl_stmt|;
name|drm_radeon_cmd_buffer_t
name|__user
modifier|*
name|request
decl_stmt|;
if|if
condition|(
name|copy_from_user
argument_list|(
operator|&
name|req32
argument_list|,
operator|(
name|void
name|__user
operator|*
operator|)
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|req32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|request
operator|=
name|compat_alloc_user_space
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|access_ok
argument_list|(
name|VERIFY_WRITE
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|bufsz
argument_list|,
operator|&
name|request
operator|->
name|bufsz
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
name|void
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|.
name|buf
argument_list|,
operator|&
name|request
operator|->
name|buf
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|nbox
argument_list|,
operator|&
name|request
operator|->
name|nbox
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
name|void
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|.
name|boxes
argument_list|,
operator|&
name|request
operator|->
name|boxes
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
name|drm_ioctl
argument_list|(
name|file
argument_list|,
name|DRM_IOCTL_RADEON_CMDBUF
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|request
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_getparam32
block|{
name|int
name|param
decl_stmt|;
name|u32
name|value
decl_stmt|;
block|}
name|drm_radeon_getparam32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_radeon_cp_getparam
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|drm_radeon_getparam32_t
name|req32
decl_stmt|;
name|drm_radeon_getparam_t
name|__user
modifier|*
name|request
decl_stmt|;
if|if
condition|(
name|copy_from_user
argument_list|(
operator|&
name|req32
argument_list|,
operator|(
name|void
name|__user
operator|*
operator|)
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|req32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|request
operator|=
name|compat_alloc_user_space
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|access_ok
argument_list|(
name|VERIFY_WRITE
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|param
argument_list|,
operator|&
name|request
operator|->
name|param
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
name|void
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|.
name|value
argument_list|,
operator|&
name|request
operator|->
name|value
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
name|drm_ioctl
argument_list|(
name|file
argument_list|,
name|DRM_IOCTL_RADEON_GETPARAM
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|request
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_mem_alloc32
block|{
name|int
name|region
decl_stmt|;
name|int
name|alignment
decl_stmt|;
name|int
name|size
decl_stmt|;
name|u32
name|region_offset
decl_stmt|;
comment|/* offset from start of fb or GART */
block|}
name|drm_radeon_mem_alloc32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_radeon_mem_alloc
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|drm_radeon_mem_alloc32_t
name|req32
decl_stmt|;
name|drm_radeon_mem_alloc_t
name|__user
modifier|*
name|request
decl_stmt|;
if|if
condition|(
name|copy_from_user
argument_list|(
operator|&
name|req32
argument_list|,
operator|(
name|void
name|__user
operator|*
operator|)
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|req32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|request
operator|=
name|compat_alloc_user_space
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|access_ok
argument_list|(
name|VERIFY_WRITE
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|region
argument_list|,
operator|&
name|request
operator|->
name|region
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|alignment
argument_list|,
operator|&
name|request
operator|->
name|alignment
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|size
argument_list|,
operator|&
name|request
operator|->
name|size
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
name|int
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|.
name|region_offset
argument_list|,
operator|&
name|request
operator|->
name|region_offset
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
name|drm_ioctl
argument_list|(
name|file
argument_list|,
name|DRM_IOCTL_RADEON_ALLOC
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|request
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_irq_emit32
block|{
name|u32
name|irq_seq
decl_stmt|;
block|}
name|drm_radeon_irq_emit32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_radeon_irq_emit
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|drm_radeon_irq_emit32_t
name|req32
decl_stmt|;
name|drm_radeon_irq_emit_t
name|__user
modifier|*
name|request
decl_stmt|;
if|if
condition|(
name|copy_from_user
argument_list|(
operator|&
name|req32
argument_list|,
operator|(
name|void
name|__user
operator|*
operator|)
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|req32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|request
operator|=
name|compat_alloc_user_space
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|access_ok
argument_list|(
name|VERIFY_WRITE
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
name|int
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|.
name|irq_seq
argument_list|,
operator|&
name|request
operator|->
name|irq_seq
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
name|drm_ioctl
argument_list|(
name|file
argument_list|,
name|DRM_IOCTL_RADEON_IRQ_EMIT
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|request
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* The two 64-bit arches where alignof(u64)==4 in 32-bit code */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_X86_64
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_IA64
argument_list|)
end_if

begin_typedef
typedef|typedef
struct|struct
name|drm_radeon_setparam32
block|{
name|int
name|param
decl_stmt|;
name|u64
name|value
decl_stmt|;
block|}
name|__attribute__
typedef|((
name|packed
typedef|))
name|drm_radeon_setparam32_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|compat_radeon_cp_setparam
parameter_list|(
name|struct
name|file
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|drm_radeon_setparam32_t
name|req32
decl_stmt|;
name|drm_radeon_setparam_t
name|__user
modifier|*
name|request
decl_stmt|;
if|if
condition|(
name|copy_from_user
argument_list|(
operator|&
name|req32
argument_list|,
operator|(
name|void
name|__user
operator|*
operator|)
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|req32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|request
operator|=
name|compat_alloc_user_space
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|access_ok
argument_list|(
name|VERIFY_WRITE
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|request
argument_list|)
argument_list|)
operator|||
name|__put_user
argument_list|(
name|req32
operator|.
name|param
argument_list|,
operator|&
name|request
operator|->
name|param
argument_list|)
operator|||
name|__put_user
argument_list|(
operator|(
name|void
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req32
operator|.
name|value
argument_list|,
operator|&
name|request
operator|->
name|value
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
name|drm_ioctl
argument_list|(
name|file
argument_list|,
name|DRM_IOCTL_RADEON_SETPARAM
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|request
argument_list|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|compat_radeon_cp_setparam
value|NULL
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* X86_64 || IA64 */
end_comment

begin_decl_stmt
specifier|static
name|drm_ioctl_compat_t
modifier|*
name|radeon_compat_ioctls
index|[]
init|=
block|{
index|[
name|DRM_RADEON_CP_INIT
index|]
operator|=
name|compat_radeon_cp_init
block|,
index|[
name|DRM_RADEON_CLEAR
index|]
operator|=
name|compat_radeon_cp_clear
block|,
index|[
name|DRM_RADEON_STIPPLE
index|]
operator|=
name|compat_radeon_cp_stipple
block|,
index|[
name|DRM_RADEON_TEXTURE
index|]
operator|=
name|compat_radeon_cp_texture
block|,
index|[
name|DRM_RADEON_VERTEX2
index|]
operator|=
name|compat_radeon_cp_vertex2
block|,
index|[
name|DRM_RADEON_CMDBUF
index|]
operator|=
name|compat_radeon_cp_cmdbuf
block|,
index|[
name|DRM_RADEON_GETPARAM
index|]
operator|=
name|compat_radeon_cp_getparam
block|,
index|[
name|DRM_RADEON_SETPARAM
index|]
operator|=
name|compat_radeon_cp_setparam
block|,
index|[
name|DRM_RADEON_ALLOC
index|]
operator|=
name|compat_radeon_mem_alloc
block|,
index|[
name|DRM_RADEON_IRQ_EMIT
index|]
operator|=
name|compat_radeon_irq_emit
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * Called whenever a 32-bit process running under a 64-bit kernel  * performs an ioctl on /dev/dri/card<n>.  *  * \param filp file pointer.  * \param cmd command.  * \param arg user argument.  * \return zero on success or negative number on failure.  */
end_comment

begin_function
name|long
name|radeon_compat_ioctl
parameter_list|(
name|struct
name|file
modifier|*
name|filp
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|unsigned
name|int
name|nr
init|=
name|DRM_IOCTL_NR
argument_list|(
name|cmd
argument_list|)
decl_stmt|;
name|drm_ioctl_compat_t
modifier|*
name|fn
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|nr
operator|<
name|DRM_COMMAND_BASE
condition|)
return|return
name|drm_compat_ioctl
argument_list|(
name|filp
argument_list|,
name|cmd
argument_list|,
name|arg
argument_list|)
return|;
if|if
condition|(
name|nr
operator|<
name|DRM_COMMAND_BASE
operator|+
name|DRM_ARRAY_SIZE
argument_list|(
name|radeon_compat_ioctls
argument_list|)
condition|)
name|fn
operator|=
name|radeon_compat_ioctls
index|[
name|nr
operator|-
name|DRM_COMMAND_BASE
index|]
expr_stmt|;
if|if
condition|(
name|fn
operator|!=
name|NULL
condition|)
name|ret
operator|=
call|(
modifier|*
name|fn
call|)
argument_list|(
name|filp
argument_list|,
name|cmd
argument_list|,
name|arg
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|drm_ioctl
argument_list|(
name|filp
argument_list|,
name|cmd
argument_list|,
name|arg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|long
name|radeon_kms_compat_ioctl
parameter_list|(
name|struct
name|file
modifier|*
name|filp
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|unsigned
name|long
name|arg
parameter_list|)
block|{
name|unsigned
name|int
name|nr
init|=
name|DRM_IOCTL_NR
argument_list|(
name|cmd
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|nr
operator|<
name|DRM_COMMAND_BASE
condition|)
return|return
name|drm_compat_ioctl
argument_list|(
name|filp
argument_list|,
name|cmd
argument_list|,
name|arg
argument_list|)
return|;
name|ret
operator|=
name|drm_ioctl
argument_list|(
name|filp
argument_list|,
name|cmd
argument_list|,
name|arg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


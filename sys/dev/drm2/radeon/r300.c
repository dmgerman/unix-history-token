begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc_helper.h>
end_include

begin_include
include|#
directive|include
file|"radeon_reg.h"
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"r100_track.h"
end_include

begin_include
include|#
directive|include
file|"r300d.h"
end_include

begin_include
include|#
directive|include
file|"rv350d.h"
end_include

begin_include
include|#
directive|include
file|"r300_reg_safe.h"
end_include

begin_comment
comment|/* This files gather functions specifics to: r300,r350,rv350,rv370,rv380  *  * GPU Errata:  * - HOST_PATH_CNTL: r300 family seems to dislike write to HOST_PATH_CNTL  *   using MMIO to flush host path read cache, this lead to HARDLOCKUP.  *   However, scheduling such write to the ring seems harmless, i suspect  *   the CP read collide with the flush somehow, or maybe the MC, hard to  *   tell. (Jerome Glisse)  */
end_comment

begin_comment
comment|/*  * rv370,rv380 PCIE GART  */
end_comment

begin_function_decl
specifier|static
name|int
name|rv370_debugfs_pcie_gart_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|rv370_pcie_gart_tlb_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Workaround HW bug do flush 2 times */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|)
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|,
name|tmp
operator||
name|RADEON_PCIE_TX_GART_INVALIDATE_TLB
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|)
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|mb
argument_list|()
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|R300_PTE_WRITEABLE
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|R300_PTE_READABLE
value|(1<< 3)
end_define

begin_function
name|int
name|rv370_pcie_gart_set_page
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|i
parameter_list|,
name|uint64_t
name|addr
parameter_list|)
block|{
specifier|volatile
name|uint32_t
modifier|*
name|ptr
init|=
name|rdev
operator|->
name|gart
operator|.
name|ptr
decl_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
operator|||
name|i
operator|>
name|rdev
operator|->
name|gart
operator|.
name|num_gpu_pages
condition|)
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
name|addr
operator|=
operator|(
name|lower_32_bits
argument_list|(
name|addr
argument_list|)
operator|>>
literal|8
operator|)
operator||
operator|(
operator|(
name|upper_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xff
operator|)
operator|<<
literal|24
operator|)
operator||
name|R300_PTE_WRITEABLE
operator||
name|R300_PTE_READABLE
expr_stmt|;
comment|/* on x86 we want this to be CPU endian, on powerpc 	 * on powerpc without HW swappers, it'll get swapped on way 	 * into VRAM - so no need for cpu_to_le32 on VRAM tables */
name|ptr
operator|+=
name|i
expr_stmt|;
operator|*
name|ptr
operator|=
operator|(
name|uint32_t
operator|)
name|addr
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rv370_pcie_gart_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|robj
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"RV370 PCIE GART already initialized\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Initialize common gart structure */
name|r
operator|=
name|radeon_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|rv370_debugfs_pcie_gart_info_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
name|DRM_ERROR
argument_list|(
literal|"Failed to register debugfs file for PCIE gart !\n"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|table_size
operator|=
name|rdev
operator|->
name|gart
operator|.
name|num_gpu_pages
operator|*
literal|4
expr_stmt|;
name|rdev
operator|->
name|asic
operator|->
name|gart
operator|.
name|tlb_flush
operator|=
operator|&
name|rv370_pcie_gart_tlb_flush
expr_stmt|;
name|rdev
operator|->
name|asic
operator|->
name|gart
operator|.
name|set_page
operator|=
operator|&
name|rv370_pcie_gart_set_page
expr_stmt|;
return|return
name|radeon_gart_table_vram_alloc
argument_list|(
name|rdev
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|rv370_pcie_gart_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|table_addr
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"No VRAM object for PCIE GART.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_gart_table_vram_pin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|radeon_gart_restore
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* discard memory request outside of configured range */
name|tmp
operator|=
name|RADEON_PCIE_TX_GART_UNMAPPED_ACCESS_DISCARD
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_START_LO
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|&
operator|~
name|RADEON_GPU_PAGE_MASK
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_END_LO
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_START_HI
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_END_HI
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|table_addr
operator|=
name|rdev
operator|->
name|gart
operator|.
name|table_addr
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_BASE
argument_list|,
name|table_addr
argument_list|)
expr_stmt|;
comment|/* FIXME: setup default page */
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_DISCARD_RD_ADDR_LO
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_DISCARD_RD_ADDR_HI
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Clear error */
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_ERROR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|RADEON_PCIE_TX_GART_EN
expr_stmt|;
name|tmp
operator||=
name|RADEON_PCIE_TX_GART_UNMAPPED_ACCESS_DISCARD
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|rv370_pcie_gart_tlb_flush
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"PCIE GART of %uM enabled (table at 0x%016llX).\n"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|table_addr
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|ready
operator|=
name|true
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|rv370_pcie_gart_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_START_LO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_END_LO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_START_HI
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_END_HI
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|RADEON_PCIE_TX_GART_UNMAPPED_ACCESS_DISCARD
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|,
name|tmp
operator|&
operator|~
name|RADEON_PCIE_TX_GART_EN
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_unpin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rv370_pcie_gart_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|radeon_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv370_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_free
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r300_fence_ring_emit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_fence
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|fence
operator|->
name|ring
index|]
decl_stmt|;
comment|/* Who ever call radeon_fence_emit should call ring_lock and ask 	 * for enough space (today caller are ib schedule and buffer move) */
comment|/* Write SC register so SC& US assert idle */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_RE_SCISSORS_TL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_RE_SCISSORS_BR
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Flush 3D cache */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_RB3D_DC_FLUSH
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_RB3D_ZCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_ZC_FLUSH
argument_list|)
expr_stmt|;
comment|/* Wait until IDLE& CLEAN */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|RADEON_WAIT_3D_IDLECLEAN
operator||
name|RADEON_WAIT_2D_IDLECLEAN
operator||
name|RADEON_WAIT_DMA_GUI_IDLE
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|hdp_cntl
operator||
name|RADEON_HDP_READ_BUFFER_INVALIDATE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|hdp_cntl
argument_list|)
expr_stmt|;
comment|/* Emit fence sequence& fire IRQ */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|rdev
operator|->
name|fence_drv
index|[
name|fence
operator|->
name|ring
index|]
operator|.
name|scratch_reg
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|fence
operator|->
name|seq
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_GEN_INT_STATUS
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_SW_INT_FIRE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r300_ring_start
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|unsigned
name|gb_tile_config
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* Sub pixel 1/12 so we can have 4K rendering according to doc */
name|gb_tile_config
operator|=
operator|(
name|R300_ENABLE_TILING
operator||
name|R300_TILE_SIZE_16
operator|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|num_gb_pipes
condition|)
block|{
case|case
literal|2
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_R300
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_R420_3P
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_R420
expr_stmt|;
break|break;
case|case
literal|1
case|:
default|default:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_RV350
expr_stmt|;
break|break;
block|}
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_ISYNC_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_ISYNC_ANY2D_IDLE3D
operator||
name|RADEON_ISYNC_ANY3D_IDLE2D
operator||
name|RADEON_ISYNC_WAIT_IDLEGUI
operator||
name|RADEON_ISYNC_CPSCRATCH_IDLEGUI
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_GB_TILE_CONFIG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|gb_tile_config
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_WAIT_2D_IDLECLEAN
operator||
name|RADEON_WAIT_3D_IDLECLEAN
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_DST_PIPE_CONFIG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_PIPE_AUTO_CONFIG
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_GB_SELECT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_GB_ENABLE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_RB3D_DC_FLUSH
operator||
name|R300_RB3D_DC_FREE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_RB3D_ZCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_ZC_FLUSH
operator||
name|R300_ZC_FREE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_WAIT_2D_IDLECLEAN
operator||
name|RADEON_WAIT_3D_IDLECLEAN
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_GB_AA_CONFIG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_RB3D_DC_FLUSH
operator||
name|R300_RB3D_DC_FREE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_RB3D_ZCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_ZC_FLUSH
operator||
name|R300_ZC_FREE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_GB_MSPOS0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
literal|6
operator|<<
name|R300_MS_X0_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MS_Y0_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MS_X1_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MS_Y1_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MS_X2_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MS_Y2_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MSBD0_Y_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MSBD0_X_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_GB_MSPOS1
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
literal|6
operator|<<
name|R300_MS_X3_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MS_Y3_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MS_X4_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MS_Y4_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MS_X5_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MS_Y5_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|R300_MSBD1_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_GA_ENHANCE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_GA_DEADLOCK_CNTL
operator||
name|R300_GA_FASTSYNC_CNTL
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_GA_POLY_MODE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_FRONT_PTYPE_TRIANGE
operator||
name|R300_BACK_PTYPE_TRIANGE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_GA_ROUND_MODE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_GEOMETRY_ROUND_NEAREST
operator||
name|R300_COLOR_ROUND_NEAREST
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r300_errata
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|rdev
operator|->
name|pll_errata
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
operator|&&
operator|(
name|RREG32
argument_list|(
name|RADEON_CONFIG_CNTL
argument_list|)
operator|&
name|RADEON_CFG_ATI_REV_ID_MASK
operator|)
operator|==
name|RADEON_CFG_ATI_REV_A11
condition|)
block|{
name|rdev
operator|->
name|pll_errata
operator||=
name|CHIP_ERRATA_R300_CG
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|r300_mc_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
comment|/* read MC_STATUS */
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MC_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|R300_MC_IDLE
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r300_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|gb_tile_config
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
operator|&&
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|!=
literal|0x4144
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R350
operator|&&
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|!=
literal|0x4148
operator|)
condition|)
block|{
comment|/* r300,r350 */
name|rdev
operator|->
name|num_gb_pipes
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
comment|/* rv350,rv370,rv380,r300 AD, r350 AH */
name|rdev
operator|->
name|num_gb_pipes
operator|=
literal|1
expr_stmt|;
block|}
name|rdev
operator|->
name|num_z_pipes
operator|=
literal|1
expr_stmt|;
name|gb_tile_config
operator|=
operator|(
name|R300_ENABLE_TILING
operator||
name|R300_TILE_SIZE_16
operator|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|num_gb_pipes
condition|)
block|{
case|case
literal|2
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_R300
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_R420_3P
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_R420
expr_stmt|;
break|break;
default|default:
case|case
literal|1
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_RV350
expr_stmt|;
break|break;
block|}
name|WREG32
argument_list|(
name|R300_GB_TILE_CONFIG
argument_list|,
name|gb_tile_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|r100_gui_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to wait GUI idle while "
literal|"programming pipes. Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
name|tmp
operator|=
name|RREG32
argument_list|(
name|R300_DST_PIPE_CONFIG
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R300_DST_PIPE_CONFIG
argument_list|,
name|tmp
operator||
name|R300_PIPE_AUTO_CONFIG
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R300_RB2D_DSTCACHE_MODE
argument_list|,
name|R300_DC_AUTOFLUSH_ENABLE
operator||
name|R300_DC_DC_DISABLE_IGNORE_PE
argument_list|)
expr_stmt|;
if|if
condition|(
name|r100_gui_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to wait GUI idle while "
literal|"programming pipes. Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r300_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to wait MC idle while "
literal|"programming pipes. Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
name|DRM_INFO
argument_list|(
literal|"radeon: %d quad pipes, %d Z pipes initialized.\n"
argument_list|,
name|rdev
operator|->
name|num_gb_pipes
argument_list|,
name|rdev
operator|->
name|num_z_pipes
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r300_asic_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|r100_mc_save
name|save
decl_stmt|;
name|u32
name|status
decl_stmt|,
name|tmp
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|G_000E40_GUI_ACTIVE
argument_list|(
name|status
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
name|r100_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%s:%d) RBBM_STATUS=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* stop CP */
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|tmp
operator||
name|RADEON_RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_RPTR_WR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* save PCI state */
name|pci_save_state
argument_list|(
name|device_get_parent
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* disable bus mastering */
name|r100_bm_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
name|S_0000F0_SOFT_RESET_VAP
argument_list|(
literal|1
argument_list|)
operator||
name|S_0000F0_SOFT_RESET_GA
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%s:%d) RBBM_STATUS=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* resetting the CP seems to be problematic sometimes it end up 	 * hard locking the computer, but it's necessary for successful 	 * reset more test& playing is needed on R3XX/R4XX to find a 	 * reliable (if any solution) 	 */
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
name|S_0000F0_SOFT_RESET_CP
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%s:%d) RBBM_STATUS=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* restore PCI& busmastering */
name|pci_restore_state
argument_list|(
name|device_get_parent
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|r100_enable_bm
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Check if GPU is idle */
if|if
condition|(
name|G_000E40_GA_BUSY
argument_list|(
name|status
argument_list|)
operator|||
name|G_000E40_VAP_BUSY
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed to reset GPU\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset succeed\n"
argument_list|)
expr_stmt|;
name|r100_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * r300,r350,rv350,rv380 VRAM info  */
end_comment

begin_function
name|void
name|r300_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u64
name|base
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* DDR for all card after R300& IGP */
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MEM_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|R300_MEM_NUM_CHANNELS_MASK
expr_stmt|;
switch|switch
condition|(
name|tmp
condition|)
block|{
case|case
literal|0
case|:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|64
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|256
expr_stmt|;
break|break;
default|default:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
break|break;
block|}
name|r100_vram_init_sizes
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|base
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_base
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
name|base
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_NB_TOM
argument_list|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
expr_stmt|;
name|radeon_vram_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_base_align
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
condition|)
name|radeon_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rv370_set_pcie_lanes
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|lanes
parameter_list|)
block|{
name|uint32_t
name|link_width_cntl
decl_stmt|,
name|mask
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
operator|)
condition|)
return|return;
comment|/* FIXME wait for idle */
switch|switch
condition|(
name|lanes
condition|)
block|{
case|case
literal|0
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X0
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X1
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X2
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X4
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X8
expr_stmt|;
break|break;
case|case
literal|12
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X12
expr_stmt|;
break|break;
case|case
literal|16
case|:
default|default:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X16
expr_stmt|;
break|break;
block|}
name|link_width_cntl
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|link_width_cntl
operator|&
name|RADEON_PCIE_LC_LINK_WIDTH_RD_MASK
operator|)
operator|==
operator|(
name|mask
operator|<<
name|RADEON_PCIE_LC_LINK_WIDTH_RD_SHIFT
operator|)
condition|)
return|return;
name|link_width_cntl
operator|&=
operator|~
operator|(
name|RADEON_PCIE_LC_LINK_WIDTH_MASK
operator||
name|RADEON_PCIE_LC_RECONFIG_NOW
operator||
name|RADEON_PCIE_LC_RECONFIG_LATER
operator||
name|RADEON_PCIE_LC_SHORT_RECONFIG_EN
operator|)
expr_stmt|;
name|link_width_cntl
operator||=
name|mask
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
name|WREG32_PCIE
argument_list|(
name|RADEON_PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
operator|(
name|link_width_cntl
operator||
name|RADEON_PCIE_LC_RECONFIG_NOW
operator|)
argument_list|)
expr_stmt|;
comment|/* wait for lane set to complete */
name|link_width_cntl
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
while|while
condition|(
name|link_width_cntl
operator|==
literal|0xffffffff
condition|)
name|link_width_cntl
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rv370_get_pcie_lanes
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|link_width_cntl
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
operator|)
condition|)
return|return
literal|0
return|;
comment|/* FIXME wait for idle */
name|link_width_cntl
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|link_width_cntl
operator|&
name|RADEON_PCIE_LC_LINK_WIDTH_RD_MASK
operator|)
operator|>>
name|RADEON_PCIE_LC_LINK_WIDTH_RD_SHIFT
condition|)
block|{
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X0
case|:
return|return
literal|0
return|;
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X1
case|:
return|return
literal|1
return|;
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X2
case|:
return|return
literal|2
return|;
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X4
case|:
return|return
literal|4
return|;
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X8
case|:
return|return
literal|8
return|;
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X16
case|:
default|default:
return|return
literal|16
return|;
block|}
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
end_if

begin_function
specifier|static
name|int
name|rv370_debugfs_pcie_gart_info
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_info_node
modifier|*
name|node
init|=
operator|(
expr|struct
name|drm_info_node
operator|*
operator|)
name|m
operator|->
name|private
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|node
operator|->
name|minor
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"PCIE_TX_GART_CNTL 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_BASE
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"PCIE_TX_GART_BASE 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_START_LO
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"PCIE_TX_GART_START_LO 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_START_HI
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"PCIE_TX_GART_START_HI 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_END_LO
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"PCIE_TX_GART_END_LO 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_END_HI
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"PCIE_TX_GART_END_HI 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_ERROR
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"PCIE_TX_GART_ERROR 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|drm_info_list
name|rv370_pcie_gart_info_list
index|[]
init|=
block|{
block|{
literal|"rv370_pcie_gart_info"
block|,
name|rv370_debugfs_pcie_gart_info
block|,
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|rv370_debugfs_pcie_gart_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
return|return
name|radeon_debugfs_add_files
argument_list|(
name|rdev
argument_list|,
name|rv370_pcie_gart_info_list
argument_list|,
literal|1
argument_list|)
return|;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|r300_packet0_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|unsigned
name|idx
parameter_list|,
name|unsigned
name|reg
parameter_list|)
block|{
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|struct
name|r100_cs_track
modifier|*
name|track
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ib
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|,
name|tile_flags
init|=
literal|0
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|int
name|r
decl_stmt|;
name|u32
name|idx_value
decl_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
name|track
operator|=
operator|(
expr|struct
name|r100_cs_track
operator|*
operator|)
name|p
operator|->
name|track
expr_stmt|;
name|idx_value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|AVIVO_D1MODE_VLINE_START_END
case|:
case|case
name|RADEON_CRTC_GUI_TRIG_VLINE
case|:
name|r
operator|=
name|r100_cs_packet_parse_vline
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
case|case
name|RADEON_DST_PITCH_OFFSET
case|:
case|case
name|RADEON_SRC_PITCH_OFFSET
case|:
name|r
operator|=
name|r100_reloc_pitch_offset
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
case|case
name|R300_RB3D_COLOROFFSET0
case|:
case|case
name|R300_RB3D_COLOROFFSET1
case|:
case|case
name|R300_RB3D_COLOROFFSET2
case|:
case|case
name|R300_RB3D_COLOROFFSET3
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|R300_RB3D_COLOROFFSET0
operator|)
operator|>>
literal|2
expr_stmt|;
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
break|break;
case|case
name|R300_ZB_DEPTHOFFSET
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|zb
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|zb
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
break|break;
case|case
name|R300_TX_OFFSET_0
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|4
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|8
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|12
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|16
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|20
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|24
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|28
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|32
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|36
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|40
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|44
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|48
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|52
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|56
case|:
case|case
name|R300_TX_OFFSET_0
operator|+
literal|60
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|R300_TX_OFFSET_0
operator|)
operator|>>
literal|2
expr_stmt|;
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
condition|)
block|{
name|ib
index|[
name|idx
index|]
operator|=
operator|(
name|idx_value
operator|&
literal|31
operator|)
operator||
comment|/* keep the 1st 5 bits */
operator|(
operator|(
name|idx_value
operator|&
operator|~
literal|31
operator|)
operator|+
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|tile_flags
operator||=
name|R300_TXO_MACRO_TILE
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|tile_flags
operator||=
name|R300_TXO_MICRO_TILE
expr_stmt|;
elseif|else
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO_SQUARE
condition|)
name|tile_flags
operator||=
name|R300_TXO_MICRO_TILE_SQUARE
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|tmp
operator||=
name|tile_flags
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|tmp
expr_stmt|;
block|}
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
comment|/* Tracked registers */
case|case
literal|0x2084
case|:
comment|/* VAP_VF_CNTL */
name|track
operator|->
name|vap_vf_cntl
operator|=
name|idx_value
expr_stmt|;
break|break;
case|case
literal|0x20B4
case|:
comment|/* VAP_VTX_SIZE */
name|track
operator|->
name|vtx_size
operator|=
name|idx_value
operator|&
literal|0x7F
expr_stmt|;
break|break;
case|case
literal|0x2134
case|:
comment|/* VAP_VF_MAX_VTX_INDX */
name|track
operator|->
name|max_indx
operator|=
name|idx_value
operator|&
literal|0x00FFFFFFUL
expr_stmt|;
break|break;
case|case
literal|0x2088
case|:
comment|/* VAP_ALT_NUM_VERTICES - only valid on r500 */
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<
name|CHIP_RV515
condition|)
goto|goto
name|fail
goto|;
name|track
operator|->
name|vap_alt_nverts
operator|=
name|idx_value
operator|&
literal|0xFFFFFF
expr_stmt|;
break|break;
case|case
literal|0x43E4
case|:
comment|/* SC_SCISSOR1 */
name|track
operator|->
name|maxy
operator|=
operator|(
operator|(
name|idx_value
operator|>>
literal|13
operator|)
operator|&
literal|0x1FFF
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<
name|CHIP_RV515
condition|)
block|{
name|track
operator|->
name|maxy
operator|-=
literal|1440
expr_stmt|;
block|}
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x4E00
case|:
comment|/* RB3D_CCTL */
if|if
condition|(
operator|(
name|idx_value
operator|&
operator|(
literal|1
operator|<<
literal|10
operator|)
operator|)
operator|&&
comment|/* CMASK_ENABLE */
name|p
operator|->
name|rdev
operator|->
name|cmask_filp
operator|!=
name|p
operator|->
name|filp
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid RB3D_CCTL: Cannot enable CMASK.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|num_cb
operator|=
operator|(
operator|(
name|idx_value
operator|>>
literal|5
operator|)
operator|&
literal|0x3
operator|)
operator|+
literal|1
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x4E38
case|:
case|case
literal|0x4E3C
case|:
case|case
literal|0x4E40
case|:
case|case
literal|0x4E44
case|:
comment|/* RB3D_COLORPITCH0 */
comment|/* RB3D_COLORPITCH1 */
comment|/* RB3D_COLORPITCH2 */
comment|/* RB3D_COLORPITCH3 */
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|tile_flags
operator||=
name|R300_COLOR_TILE_ENABLE
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|tile_flags
operator||=
name|R300_COLOR_MICROTILE_ENABLE
expr_stmt|;
elseif|else
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO_SQUARE
condition|)
name|tile_flags
operator||=
name|R300_COLOR_MICROTILE_SQUARE_ENABLE
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|&
operator|~
operator|(
literal|0x7
operator|<<
literal|16
operator|)
expr_stmt|;
name|tmp
operator||=
name|tile_flags
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|tmp
expr_stmt|;
block|}
name|i
operator|=
operator|(
name|reg
operator|-
literal|0x4E38
operator|)
operator|>>
literal|2
expr_stmt|;
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|pitch
operator|=
name|idx_value
operator|&
literal|0x3FFE
expr_stmt|;
switch|switch
condition|(
operator|(
operator|(
name|idx_value
operator|>>
literal|21
operator|)
operator|&
literal|0xF
operator|)
condition|)
block|{
case|case
literal|9
case|:
case|case
literal|11
case|:
case|case
literal|12
case|:
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|3
case|:
case|case
literal|4
case|:
case|case
literal|13
case|:
case|case
literal|15
case|:
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<
name|CHIP_RV515
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid color buffer format (%d)!\n"
argument_list|,
operator|(
operator|(
name|idx_value
operator|>>
literal|21
operator|)
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Pass through. */
case|case
literal|6
case|:
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|10
case|:
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|8
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|16
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid color buffer format (%d) !\n"
argument_list|,
operator|(
operator|(
name|idx_value
operator|>>
literal|21
operator|)
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x4F00
case|:
comment|/* ZB_CNTL */
if|if
condition|(
name|idx_value
operator|&
literal|2
condition|)
block|{
name|track
operator|->
name|z_enabled
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
name|track
operator|->
name|z_enabled
operator|=
name|false
expr_stmt|;
block|}
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x4F10
case|:
comment|/* ZB_FORMAT */
switch|switch
condition|(
operator|(
name|idx_value
operator|&
literal|0xF
operator|)
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|1
case|:
name|track
operator|->
name|zb
operator|.
name|cpp
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|track
operator|->
name|zb
operator|.
name|cpp
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid z buffer format (%d) !\n"
argument_list|,
operator|(
name|idx_value
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x4F24
case|:
comment|/* ZB_DEPTHPITCH */
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|tile_flags
operator||=
name|R300_DEPTHMACROTILE_ENABLE
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|tile_flags
operator||=
name|R300_DEPTHMICROTILE_TILED
expr_stmt|;
elseif|else
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO_SQUARE
condition|)
name|tile_flags
operator||=
name|R300_DEPTHMICROTILE_TILED_SQUARE
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|&
operator|~
operator|(
literal|0x7
operator|<<
literal|16
operator|)
expr_stmt|;
name|tmp
operator||=
name|tile_flags
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|tmp
expr_stmt|;
block|}
name|track
operator|->
name|zb
operator|.
name|pitch
operator|=
name|idx_value
operator|&
literal|0x3FFC
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x4104
case|:
comment|/* TX_ENABLE */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|bool
name|enabled
decl_stmt|;
name|enabled
operator|=
operator|!
operator|!
operator|(
name|idx_value
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|enabled
operator|=
name|enabled
expr_stmt|;
block|}
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x44C0
case|:
case|case
literal|0x44C4
case|:
case|case
literal|0x44C8
case|:
case|case
literal|0x44CC
case|:
case|case
literal|0x44D0
case|:
case|case
literal|0x44D4
case|:
case|case
literal|0x44D8
case|:
case|case
literal|0x44DC
case|:
case|case
literal|0x44E0
case|:
case|case
literal|0x44E4
case|:
case|case
literal|0x44E8
case|:
case|case
literal|0x44EC
case|:
case|case
literal|0x44F0
case|:
case|case
literal|0x44F4
case|:
case|case
literal|0x44F8
case|:
case|case
literal|0x44FC
case|:
comment|/* TX_FORMAT1_[0-15] */
name|i
operator|=
operator|(
name|reg
operator|-
literal|0x44C0
operator|)
operator|>>
literal|2
expr_stmt|;
name|tmp
operator|=
operator|(
name|idx_value
operator|>>
literal|25
operator|)
operator|&
literal|0x3
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|tex_coord_type
operator|=
name|tmp
expr_stmt|;
switch|switch
condition|(
operator|(
name|idx_value
operator|&
literal|0x1F
operator|)
condition|)
block|{
case|case
name|R300_TX_FORMAT_X8
case|:
case|case
name|R300_TX_FORMAT_Y4X4
case|:
case|case
name|R300_TX_FORMAT_Z3Y3X2
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|R300_TX_FORMAT_X16
case|:
case|case
name|R300_TX_FORMAT_FL_I16
case|:
case|case
name|R300_TX_FORMAT_Y8X8
case|:
case|case
name|R300_TX_FORMAT_Z5Y6X5
case|:
case|case
name|R300_TX_FORMAT_Z6Y5X5
case|:
case|case
name|R300_TX_FORMAT_W4Z4Y4X4
case|:
case|case
name|R300_TX_FORMAT_W1Z5Y5X5
case|:
case|case
name|R300_TX_FORMAT_D3DMFT_CxV8U8
case|:
case|case
name|R300_TX_FORMAT_B8G8_B8G8
case|:
case|case
name|R300_TX_FORMAT_G8R8_G8B8
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|2
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|R300_TX_FORMAT_Y16X16
case|:
case|case
name|R300_TX_FORMAT_FL_I16A16
case|:
case|case
name|R300_TX_FORMAT_Z11Y11X10
case|:
case|case
name|R300_TX_FORMAT_Z10Y11X11
case|:
case|case
name|R300_TX_FORMAT_W8Z8Y8X8
case|:
case|case
name|R300_TX_FORMAT_W2Z10Y10X10
case|:
case|case
literal|0x17
case|:
case|case
name|R300_TX_FORMAT_FL_I32
case|:
case|case
literal|0x1e
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|4
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|R300_TX_FORMAT_W16Z16Y16X16
case|:
case|case
name|R300_TX_FORMAT_FL_R16G16B16A16
case|:
case|case
name|R300_TX_FORMAT_FL_I32A32
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|8
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|R300_TX_FORMAT_FL_R32G32B32A32
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|16
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|R300_TX_FORMAT_DXT1
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_DXT1
expr_stmt|;
break|break;
case|case
name|R300_TX_FORMAT_ATI2N
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|<
name|CHIP_R420
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid texture format %u\n"
argument_list|,
operator|(
name|idx_value
operator|&
literal|0x1F
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* The same rules apply as for DXT3/5. */
comment|/* Pass through. */
case|case
name|R300_TX_FORMAT_DXT3
case|:
case|case
name|R300_TX_FORMAT_DXT5
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_DXT35
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid texture format %u\n"
argument_list|,
operator|(
name|idx_value
operator|&
literal|0x1F
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x4400
case|:
case|case
literal|0x4404
case|:
case|case
literal|0x4408
case|:
case|case
literal|0x440C
case|:
case|case
literal|0x4410
case|:
case|case
literal|0x4414
case|:
case|case
literal|0x4418
case|:
case|case
literal|0x441C
case|:
case|case
literal|0x4420
case|:
case|case
literal|0x4424
case|:
case|case
literal|0x4428
case|:
case|case
literal|0x442C
case|:
case|case
literal|0x4430
case|:
case|case
literal|0x4434
case|:
case|case
literal|0x4438
case|:
case|case
literal|0x443C
case|:
comment|/* TX_FILTER0_[0-15] */
name|i
operator|=
operator|(
name|reg
operator|-
literal|0x4400
operator|)
operator|>>
literal|2
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|&
literal|0x7
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|2
operator|||
name|tmp
operator|==
literal|4
operator|||
name|tmp
operator|==
literal|6
condition|)
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|roundup_w
operator|=
name|false
expr_stmt|;
block|}
name|tmp
operator|=
operator|(
name|idx_value
operator|>>
literal|3
operator|)
operator|&
literal|0x7
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|2
operator|||
name|tmp
operator|==
literal|4
operator|||
name|tmp
operator|==
literal|6
condition|)
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|roundup_h
operator|=
name|false
expr_stmt|;
block|}
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x4500
case|:
case|case
literal|0x4504
case|:
case|case
literal|0x4508
case|:
case|case
literal|0x450C
case|:
case|case
literal|0x4510
case|:
case|case
literal|0x4514
case|:
case|case
literal|0x4518
case|:
case|case
literal|0x451C
case|:
case|case
literal|0x4520
case|:
case|case
literal|0x4524
case|:
case|case
literal|0x4528
case|:
case|case
literal|0x452C
case|:
case|case
literal|0x4530
case|:
case|case
literal|0x4534
case|:
case|case
literal|0x4538
case|:
case|case
literal|0x453C
case|:
comment|/* TX_FORMAT2_[0-15] */
name|i
operator|=
operator|(
name|reg
operator|-
literal|0x4500
operator|)
operator|>>
literal|2
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|&
literal|0x3FFF
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|pitch
operator|=
name|tmp
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV515
condition|)
block|{
name|tmp
operator|=
operator|(
operator|(
name|idx_value
operator|>>
literal|15
operator|)
operator|&
literal|1
operator|)
operator|<<
literal|11
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|width_11
operator|=
name|tmp
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|idx_value
operator|>>
literal|16
operator|)
operator|&
literal|1
operator|)
operator|<<
literal|11
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|height_11
operator|=
name|tmp
expr_stmt|;
comment|/* ATI1N */
if|if
condition|(
name|idx_value
operator|&
operator|(
literal|1
operator|<<
literal|14
operator|)
condition|)
block|{
comment|/* The same rules apply as for DXT1. */
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_DXT1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|idx_value
operator|&
operator|(
literal|1
operator|<<
literal|14
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Forbidden bit TXFORMAT_MSB\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x4480
case|:
case|case
literal|0x4484
case|:
case|case
literal|0x4488
case|:
case|case
literal|0x448C
case|:
case|case
literal|0x4490
case|:
case|case
literal|0x4494
case|:
case|case
literal|0x4498
case|:
case|case
literal|0x449C
case|:
case|case
literal|0x44A0
case|:
case|case
literal|0x44A4
case|:
case|case
literal|0x44A8
case|:
case|case
literal|0x44AC
case|:
case|case
literal|0x44B0
case|:
case|case
literal|0x44B4
case|:
case|case
literal|0x44B8
case|:
case|case
literal|0x44BC
case|:
comment|/* TX_FORMAT0_[0-15] */
name|i
operator|=
operator|(
name|reg
operator|-
literal|0x4480
operator|)
operator|>>
literal|2
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|&
literal|0x7FF
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|width
operator|=
name|tmp
operator|+
literal|1
expr_stmt|;
name|tmp
operator|=
operator|(
name|idx_value
operator|>>
literal|11
operator|)
operator|&
literal|0x7FF
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|height
operator|=
name|tmp
operator|+
literal|1
expr_stmt|;
name|tmp
operator|=
operator|(
name|idx_value
operator|>>
literal|26
operator|)
operator|&
literal|0xF
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|num_levels
operator|=
name|tmp
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|&
operator|(
literal|1U
operator|<<
literal|31
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|use_pitch
operator|=
operator|!
operator|!
name|tmp
expr_stmt|;
name|tmp
operator|=
operator|(
name|idx_value
operator|>>
literal|22
operator|)
operator|&
literal|0xF
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|txdepth
operator|=
name|tmp
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R300_ZB_ZPASS_ADDR
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
break|break;
case|case
literal|0x4e0c
case|:
comment|/* RB3D_COLOR_CHANNEL_MASK */
name|track
operator|->
name|color_channel_mask
operator|=
name|idx_value
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x43a4
case|:
comment|/* SC_HYPERZ_EN */
comment|/* r300c emits this register - we need to disable hyperz for it 		 * without complaining */
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|hyperz_filp
operator|!=
name|p
operator|->
name|filp
condition|)
block|{
if|if
condition|(
name|idx_value
operator|&
literal|0x1
condition|)
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|&
operator|~
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|0x4f1c
case|:
comment|/* ZB_BW_CNTL */
name|track
operator|->
name|zb_cb_clear
operator|=
operator|!
operator|!
operator|(
name|idx_value
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
operator|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|hyperz_filp
operator|!=
name|p
operator|->
name|filp
condition|)
block|{
if|if
condition|(
name|idx_value
operator|&
operator|(
name|R300_HIZ_ENABLE
operator||
name|R300_RD_COMP_ENABLE
operator||
name|R300_WR_COMP_ENABLE
operator||
name|R300_FAST_FILL_ENABLE
operator|)
condition|)
goto|goto
name|fail
goto|;
block|}
break|break;
case|case
literal|0x4e04
case|:
comment|/* RB3D_BLENDCNTL */
name|track
operator|->
name|blend_read_enable
operator|=
operator|!
operator|!
operator|(
name|idx_value
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R300_RB3D_AARESOLVE_OFFSET
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|aa
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|aa
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|track
operator|->
name|aa_dirty
operator|=
name|true
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
break|break;
case|case
name|R300_RB3D_AARESOLVE_PITCH
case|:
name|track
operator|->
name|aa
operator|.
name|pitch
operator|=
name|idx_value
operator|&
literal|0x3FFE
expr_stmt|;
name|track
operator|->
name|aa_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|R300_RB3D_AARESOLVE_CTL
case|:
name|track
operator|->
name|aaresolve
operator|=
name|idx_value
operator|&
literal|0x1
expr_stmt|;
name|track
operator|->
name|aa_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|0x4f30
case|:
comment|/* ZB_MASK_OFFSET */
case|case
literal|0x4f34
case|:
comment|/* ZB_ZMASK_PITCH */
case|case
literal|0x4f44
case|:
comment|/* ZB_HIZ_OFFSET */
case|case
literal|0x4f54
case|:
comment|/* ZB_HIZ_PITCH */
if|if
condition|(
name|idx_value
operator|&&
operator|(
name|p
operator|->
name|rdev
operator|->
name|hyperz_filp
operator|!=
name|p
operator|->
name|filp
operator|)
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
literal|0x4028
case|:
if|if
condition|(
name|idx_value
operator|&&
operator|(
name|p
operator|->
name|rdev
operator|->
name|hyperz_filp
operator|!=
name|p
operator|->
name|filp
operator|)
condition|)
goto|goto
name|fail
goto|;
comment|/* GB_Z_PEQ_CONFIG */
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV350
condition|)
break|break;
goto|goto
name|fail
goto|;
break|break;
case|case
literal|0x4be8
case|:
comment|/* valid register only on RV530 */
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV530
condition|)
break|break;
comment|/* fallthrough do not move */
default|default:
goto|goto
name|fail
goto|;
block|}
return|return
literal|0
return|;
name|fail
label|:
name|DRM_ERROR
argument_list|(
literal|"Forbidden register 0x%04X in cs at %d (val=%08x)\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|,
name|idx_value
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r300_packet3_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|struct
name|r100_cs_track
modifier|*
name|track
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ib
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|int
name|r
decl_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
name|idx
operator|=
name|pkt
operator|->
name|idx
operator|+
literal|1
expr_stmt|;
name|track
operator|=
operator|(
expr|struct
name|r100_cs_track
operator|*
operator|)
name|p
operator|->
name|track
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|opcode
condition|)
block|{
case|case
name|PACKET3_3D_LOAD_VBPNTR
case|:
name|r
operator|=
name|r100_packet3_load_vbpntr
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
case|case
name|PACKET3_INDX_BUFFER
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for packet3 %d\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check_pkt3_indx_buffer
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|,
name|reloc
operator|->
name|robj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
break|break;
comment|/* Draw packet */
case|case
name|PACKET3_3D_DRAW_IMMD
case|:
comment|/* Number of dwords is vtx_size * (num_vertices - 1) 		 * PRIM_WALK must be equal to 3 vertex data in embedded 		 * in cmd stream */
if|if
condition|(
operator|(
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|>>
literal|4
operator|)
operator|&
literal|0x3
operator|)
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"PRIM_WALK must be 3 for IMMD draw\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|track
operator|->
name|immd_dwords
operator|=
name|pkt
operator|->
name|count
operator|-
literal|1
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_3D_DRAW_IMMD_2
case|:
comment|/* Number of dwords is vtx_size * (num_vertices - 1) 		 * PRIM_WALK must be equal to 3 vertex data in embedded 		 * in cmd stream */
if|if
condition|(
operator|(
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|>>
literal|4
operator|)
operator|&
literal|0x3
operator|)
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"PRIM_WALK must be 3 for IMMD draw\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|immd_dwords
operator|=
name|pkt
operator|->
name|count
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_3D_DRAW_VBUF
case|:
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_3D_DRAW_VBUF_2
case|:
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_3D_DRAW_INDX
case|:
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_3D_DRAW_INDX_2
case|:
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
break|break;
case|case
name|PACKET3_3D_CLEAR_HIZ
case|:
case|case
name|PACKET3_3D_CLEAR_ZMASK
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|hyperz_filp
operator|!=
name|p
operator|->
name|filp
condition|)
return|return
operator|-
name|EINVAL
return|;
break|break;
case|case
name|PACKET3_3D_CLEAR_CMASK
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|cmask_filp
operator|!=
name|p
operator|->
name|filp
condition|)
return|return
operator|-
name|EINVAL
return|;
break|break;
case|case
name|PACKET3_NOP
case|:
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Packet3 opcode %x not supported\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r300_cs_parse
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|radeon_cs_packet
name|pkt
decl_stmt|;
name|struct
name|r100_cs_track
modifier|*
name|track
decl_stmt|;
name|int
name|r
decl_stmt|;
name|track
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|track
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|track
operator|==
name|NULL
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|r100_cs_track_clear
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|track
expr_stmt|;
do|do
block|{
name|r
operator|=
name|r100_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
name|r
return|;
block|}
name|p
operator|->
name|idx
operator|+=
name|pkt
operator|.
name|count
operator|+
literal|2
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|.
name|type
condition|)
block|{
case|case
name|PACKET_TYPE0
case|:
name|r
operator|=
name|r100_cs_parse_packet0
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|,
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|reg_safe_bm
argument_list|,
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|reg_safe_bm_size
argument_list|,
operator|&
name|r300_packet0_check
argument_list|)
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE2
case|:
break|break;
case|case
name|PACKET_TYPE3
case|:
name|r
operator|=
name|r300_packet3_check
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet type %d !\n"
argument_list|,
name|pkt
operator|.
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|r
condition|)
block|{
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
do|while
condition|(
name|p
operator|->
name|idx
operator|<
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
operator|.
name|length_dw
condition|)
do|;
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r300_set_reg_safe
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|reg_safe_bm
operator|=
name|r300_reg_safe_bm
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|reg_safe_bm_size
operator|=
name|DRM_ARRAY_SIZE
argument_list|(
name|r300_reg_safe_bm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r300_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|r100_mc_save
name|save
decl_stmt|;
name|int
name|r
decl_stmt|;
name|r
operator|=
name|r100_debugfs_mc_info_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Failed to create r100_mc debugfs file.\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Stops all mc clients */
name|r100_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|WREG32
argument_list|(
name|R_00014C_MC_AGP_LOCATION
argument_list|,
name|S_00014C_MC_AGP_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|16
argument_list|)
operator||
name|S_00014C_MC_AGP_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000170_AGP_BASE
argument_list|,
name|lower_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|agp_base
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_00015C_AGP_BASE_2
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|agp_base
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|R_00014C_MC_AGP_LOCATION
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000170_AGP_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_00015C_AGP_BASE_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Wait for mc idle */
if|if
condition|(
name|r300_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
name|DRM_INFO
argument_list|(
literal|"Failed to wait MC idle before programming MC.\n"
argument_list|)
expr_stmt|;
comment|/* Program MC, should be a 32bits limited address space */
name|WREG32
argument_list|(
name|R_000148_MC_FB_LOCATION
argument_list|,
name|S_000148_MC_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
operator||
name|S_000148_MC_FB_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|r100_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r300_clock_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
name|radeon_dynclks
operator|!=
operator|-
literal|1
operator|&&
name|radeon_dynclks
condition|)
name|radeon_legacy_set_clock_gating
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* We need to force on some of the block */
name|tmp
operator|=
name|RREG32_PLL
argument_list|(
name|R_00000D_SCLK_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|S_00000D_FORCE_CP
argument_list|(
literal|1
argument_list|)
operator||
name|S_00000D_FORCE_VIP
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV350
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV380
operator|)
condition|)
name|tmp
operator||=
name|S_00000D_FORCE_VAP
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|R_00000D_SCLK_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|r300_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* set common regs */
name|r100_set_common_regs
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* program mc */
name|r300_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock */
name|r300_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GPU configuration (# pipes, ...) */
name|r300_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GART (initialize after TTM so we can allocate 	 * memory through TTM but finalize after TTM) */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
block|{
name|r
operator|=
name|rv370_pcie_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R350
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV350
condition|)
name|r100_enable_bm
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
block|{
name|r
operator|=
name|r100_pci_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|r100_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|hdp_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
comment|/* 1M ring buffer */
name|r
operator|=
name|r100_cp_init
argument_list|(
name|rdev
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r300_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Make sur GART are not working */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|rv370_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
name|r100_pci_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock before doing reset */
name|r300_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* post */
name|radeon_combios_asic_init
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* Resume clock after posting */
name|r300_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|r300_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|r300_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r100_cp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_irq_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|rv370_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
name|r100_pci_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r300_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|rv370_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
name|r100_pci_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_agp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r300_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Disable VGA */
name|r100_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize scratch registers */
name|radeon_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* TODO: disable VGA need to use VGA request */
comment|/* restore some register to sane defaults */
name|r100_restore_sanity
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* BIOS*/
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting combios for RS400/RS480 GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
name|r
operator|=
name|radeon_combios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* check if cards are posted or not */
if|if
condition|(
name|radeon_boot_test_post_card
argument_list|(
name|rdev
argument_list|)
operator|==
name|false
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Set asic errata */
name|r300_errata
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* initialize AGP */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|r
operator|=
name|radeon_agp_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_agp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* initialize memory controller */
name|r300_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
block|{
name|r
operator|=
name|rv370_pcie_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
block|{
name|r
operator|=
name|r100_pci_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
name|r300_set_reg_safe
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|r300_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
comment|/* Somethings want wront with the accel init stop accel */
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|rv370_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
name|r100_pci_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_agp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


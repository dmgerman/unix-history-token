begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2007-8 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc_helper.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_function
specifier|static
name|void
name|radeon_legacy_encoder_disable
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|struct
name|drm_encoder_helper_funcs
modifier|*
name|encoder_funcs
decl_stmt|;
name|encoder_funcs
operator|=
name|encoder
operator|->
name|helper_private
expr_stmt|;
name|encoder_funcs
operator|->
name|dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_OFF
argument_list|)
expr_stmt|;
name|radeon_encoder
operator|->
name|active_device
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_lvds_update
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|lvds_gen_cntl
decl_stmt|,
name|lvds_pll_cntl
decl_stmt|,
name|pixclks_cntl
decl_stmt|,
name|disp_pwr_man
decl_stmt|;
name|int
name|panel_pwr_delay
init|=
literal|2000
decl_stmt|;
name|bool
name|is_mac
init|=
name|false
decl_stmt|;
name|uint8_t
name|backlight_level
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|lvds_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|)
expr_stmt|;
name|backlight_level
operator|=
operator|(
name|lvds_gen_cntl
operator|>>
name|RADEON_LVDS_BL_MOD_LEVEL_SHIFT
operator|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|enc_priv
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|struct
name|radeon_encoder_atom_dig
modifier|*
name|lvds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|panel_pwr_delay
operator|=
name|lvds
operator|->
name|panel_pwr_delay
expr_stmt|;
if|if
condition|(
name|lvds
operator|->
name|bl_dev
condition|)
name|backlight_level
operator|=
name|lvds
operator|->
name|backlight_level
expr_stmt|;
block|}
else|else
block|{
name|struct
name|radeon_encoder_lvds
modifier|*
name|lvds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|panel_pwr_delay
operator|=
name|lvds
operator|->
name|panel_pwr_delay
expr_stmt|;
if|if
condition|(
name|lvds
operator|->
name|bl_dev
condition|)
name|backlight_level
operator|=
name|lvds
operator|->
name|backlight_level
expr_stmt|;
block|}
block|}
comment|/* macs (and possibly some x86 oem systems?) wire up LVDS strangely 	 * Taken from radeonfb. 	 */
if|if
condition|(
operator|(
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|==
name|CT_IBOOK
operator|)
operator|||
operator|(
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|==
name|CT_POWERBOOK_EXTERNAL
operator|)
operator|||
operator|(
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|==
name|CT_POWERBOOK_INTERNAL
operator|)
operator|||
operator|(
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|==
name|CT_POWERBOOK_VGA
operator|)
condition|)
name|is_mac
operator|=
name|true
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|DRM_MODE_DPMS_ON
case|:
name|disp_pwr_man
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_PWR_MAN
argument_list|)
expr_stmt|;
name|disp_pwr_man
operator||=
name|RADEON_AUTO_PWRUP_EN
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_PWR_MAN
argument_list|,
name|disp_pwr_man
argument_list|)
expr_stmt|;
name|lvds_pll_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_LVDS_PLL_CNTL
argument_list|)
expr_stmt|;
name|lvds_pll_cntl
operator||=
name|RADEON_LVDS_PLL_EN
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_LVDS_PLL_CNTL
argument_list|,
name|lvds_pll_cntl
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|lvds_pll_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_LVDS_PLL_CNTL
argument_list|)
expr_stmt|;
name|lvds_pll_cntl
operator|&=
operator|~
name|RADEON_LVDS_PLL_RESET
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_LVDS_PLL_CNTL
argument_list|,
name|lvds_pll_cntl
argument_list|)
expr_stmt|;
name|lvds_gen_cntl
operator|&=
operator|~
operator|(
name|RADEON_LVDS_DISPLAY_DIS
operator||
name|RADEON_LVDS_BL_MOD_LEVEL_MASK
operator|)
expr_stmt|;
name|lvds_gen_cntl
operator||=
operator|(
name|RADEON_LVDS_ON
operator||
name|RADEON_LVDS_EN
operator||
name|RADEON_LVDS_DIGON
operator||
name|RADEON_LVDS_BLON
operator||
operator|(
name|backlight_level
operator|<<
name|RADEON_LVDS_BL_MOD_LEVEL_SHIFT
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|is_mac
condition|)
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_BL_MOD_EN
expr_stmt|;
name|DRM_MDELAY
argument_list|(
name|panel_pwr_delay
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|,
name|lvds_gen_cntl
argument_list|)
expr_stmt|;
break|break;
case|case
name|DRM_MODE_DPMS_STANDBY
case|:
case|case
name|DRM_MODE_DPMS_SUSPEND
case|:
case|case
name|DRM_MODE_DPMS_OFF
case|:
name|pixclks_cntl
operator|=
name|RREG32_PLL
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|,
literal|0
argument_list|,
operator|~
name|RADEON_PIXCLK_LVDS_ALWAYS_ONb
argument_list|)
expr_stmt|;
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_DISPLAY_DIS
expr_stmt|;
if|if
condition|(
name|is_mac
condition|)
block|{
name|lvds_gen_cntl
operator|&=
operator|~
name|RADEON_LVDS_BL_MOD_EN
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|,
name|lvds_gen_cntl
argument_list|)
expr_stmt|;
name|lvds_gen_cntl
operator|&=
operator|~
operator|(
name|RADEON_LVDS_ON
operator||
name|RADEON_LVDS_EN
operator|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|,
name|lvds_gen_cntl
argument_list|)
expr_stmt|;
name|lvds_gen_cntl
operator|&=
operator|~
operator|(
name|RADEON_LVDS_ON
operator||
name|RADEON_LVDS_BLON
operator||
name|RADEON_LVDS_EN
operator||
name|RADEON_LVDS_DIGON
operator|)
expr_stmt|;
block|}
name|DRM_MDELAY
argument_list|(
name|panel_pwr_delay
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|,
name|lvds_gen_cntl
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|,
name|pixclks_cntl
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
name|panel_pwr_delay
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_encoder_dpms_scratch_regs
argument_list|(
name|encoder
argument_list|,
operator|(
name|mode
operator|==
name|DRM_MODE_DPMS_ON
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_encoder_dpms_scratch_regs
argument_list|(
name|encoder
argument_list|,
operator|(
name|mode
operator|==
name|DRM_MODE_DPMS_ON
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_lvds_dpms
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|enc_priv
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|struct
name|radeon_encoder_atom_dig
modifier|*
name|lvds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|lvds
operator|->
name|dpms_mode
operator|=
name|mode
expr_stmt|;
block|}
else|else
block|{
name|struct
name|radeon_encoder_lvds
modifier|*
name|lvds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|lvds
operator|->
name|dpms_mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
name|radeon_legacy_lvds_update
argument_list|(
name|encoder
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_lvds_prepare
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atom_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|radeon_legacy_lvds_dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_OFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_lvds_commit
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|radeon_legacy_lvds_dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atom_output_lock
argument_list|(
name|encoder
argument_list|,
name|false
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_output_lock
argument_list|(
name|encoder
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_lvds_mode_set
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|encoder
operator|->
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|lvds_pll_cntl
decl_stmt|,
name|lvds_gen_cntl
decl_stmt|,
name|lvds_ss_gen_cntl
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|lvds_pll_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_LVDS_PLL_CNTL
argument_list|)
expr_stmt|;
name|lvds_pll_cntl
operator|&=
operator|~
name|RADEON_LVDS_PLL_EN
expr_stmt|;
name|lvds_ss_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_LVDS_SS_GEN_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
comment|/* LVDS_GEN_CNTL parameters are computed in LVDSEncoderControl 		 * need to call that on resume to set up the reg properly. 		 */
name|radeon_encoder
operator|->
name|pixel_clock
operator|=
name|adjusted_mode
operator|->
name|clock
expr_stmt|;
name|atombios_digital_setup
argument_list|(
name|encoder
argument_list|,
name|PANEL_ENCODER_ACTION_ENABLE
argument_list|)
expr_stmt|;
name|lvds_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|radeon_encoder_lvds
modifier|*
name|lvds
init|=
operator|(
expr|struct
name|radeon_encoder_lvds
operator|*
operator|)
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
if|if
condition|(
name|lvds
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"bios LVDS_GEN_CNTL: 0x%x\n"
argument_list|,
name|lvds
operator|->
name|lvds_gen_cntl
argument_list|)
expr_stmt|;
name|lvds_gen_cntl
operator|=
name|lvds
operator|->
name|lvds_gen_cntl
expr_stmt|;
name|lvds_ss_gen_cntl
operator|&=
operator|~
operator|(
operator|(
literal|0xf
operator|<<
name|RADEON_LVDS_PWRSEQ_DELAY1_SHIFT
operator|)
operator||
operator|(
literal|0xf
operator|<<
name|RADEON_LVDS_PWRSEQ_DELAY2_SHIFT
operator|)
operator|)
expr_stmt|;
name|lvds_ss_gen_cntl
operator||=
operator|(
operator|(
name|lvds
operator|->
name|panel_digon_delay
operator|<<
name|RADEON_LVDS_PWRSEQ_DELAY1_SHIFT
operator|)
operator||
operator|(
name|lvds
operator|->
name|panel_blon_delay
operator|<<
name|RADEON_LVDS_PWRSEQ_DELAY2_SHIFT
operator|)
operator|)
expr_stmt|;
block|}
else|else
name|lvds_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|)
expr_stmt|;
block|}
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_DISPLAY_DIS
expr_stmt|;
name|lvds_gen_cntl
operator|&=
operator|~
operator|(
name|RADEON_LVDS_ON
operator||
name|RADEON_LVDS_BLON
operator||
name|RADEON_LVDS_EN
operator||
name|RADEON_LVDS_RST_FM
operator|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
name|lvds_pll_cntl
operator|&=
operator|~
operator|(
name|R300_LVDS_SRC_SEL_MASK
operator|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|radeon_encoder
operator|->
name|rmx_type
operator|!=
name|RMX_OFF
condition|)
name|lvds_pll_cntl
operator||=
name|R300_LVDS_SRC_SEL_RMX
expr_stmt|;
block|}
else|else
name|lvds_gen_cntl
operator|&=
operator|~
name|RADEON_LVDS_SEL_CRTC2
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
name|lvds_pll_cntl
operator||=
name|R300_LVDS_SRC_SEL_CRTC2
expr_stmt|;
else|else
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_SEL_CRTC2
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|,
name|lvds_gen_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_LVDS_PLL_CNTL
argument_list|,
name|lvds_pll_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_LVDS_SS_GEN_CNTL
argument_list|,
name|lvds_ss_gen_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV410
condition|)
name|WREG32
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_encoder_crtc_scratch_regs
argument_list|(
name|encoder
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_encoder_crtc_scratch_regs
argument_list|(
name|encoder
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_legacy_mode_fixup
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
specifier|const
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
comment|/* set the active encoder to connector routing */
name|radeon_encoder_set_active_device
argument_list|(
name|encoder
argument_list|)
expr_stmt|;
name|drm_mode_set_crtcinfo
argument_list|(
name|adjusted_mode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* get the native mode for LVDS */
if|if
condition|(
name|radeon_encoder
operator|->
name|active_device
operator|&
operator|(
name|ATOM_DEVICE_LCD_SUPPORT
operator|)
condition|)
name|radeon_panel_mode_fixup
argument_list|(
name|encoder
argument_list|,
name|adjusted_mode
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_helper_funcs
name|radeon_legacy_lvds_helper_funcs
init|=
block|{
operator|.
name|dpms
operator|=
name|radeon_legacy_lvds_dpms
block|,
operator|.
name|mode_fixup
operator|=
name|radeon_legacy_mode_fixup
block|,
operator|.
name|prepare
operator|=
name|radeon_legacy_lvds_prepare
block|,
operator|.
name|mode_set
operator|=
name|radeon_legacy_lvds_mode_set
block|,
operator|.
name|commit
operator|=
name|radeon_legacy_lvds_commit
block|,
operator|.
name|disable
operator|=
name|radeon_legacy_encoder_disable
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|u8
name|radeon_legacy_get_backlight_level
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|radeon_encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u8
name|backlight_level
decl_stmt|;
name|backlight_level
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|)
operator|>>
name|RADEON_LVDS_BL_MOD_LEVEL_SHIFT
operator|)
operator|&
literal|0xff
expr_stmt|;
return|return
name|backlight_level
return|;
block|}
end_function

begin_function
name|void
name|radeon_legacy_set_backlight_level
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
parameter_list|,
name|u8
name|level
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|radeon_encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|dpms_mode
init|=
name|DRM_MODE_DPMS_ON
decl_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|enc_priv
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|struct
name|radeon_encoder_atom_dig
modifier|*
name|lvds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
if|if
condition|(
name|lvds
operator|->
name|backlight_level
operator|>
literal|0
condition|)
name|dpms_mode
operator|=
name|lvds
operator|->
name|dpms_mode
expr_stmt|;
else|else
name|dpms_mode
operator|=
name|DRM_MODE_DPMS_OFF
expr_stmt|;
name|lvds
operator|->
name|backlight_level
operator|=
name|level
expr_stmt|;
block|}
else|else
block|{
name|struct
name|radeon_encoder_lvds
modifier|*
name|lvds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
if|if
condition|(
name|lvds
operator|->
name|backlight_level
operator|>
literal|0
condition|)
name|dpms_mode
operator|=
name|lvds
operator|->
name|dpms_mode
expr_stmt|;
else|else
name|dpms_mode
operator|=
name|DRM_MODE_DPMS_OFF
expr_stmt|;
name|lvds
operator|->
name|backlight_level
operator|=
name|level
expr_stmt|;
block|}
block|}
name|radeon_legacy_lvds_update
argument_list|(
operator|&
name|radeon_encoder
operator|->
name|base
argument_list|,
name|dpms_mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_BACKLIGHT_CLASS_DEVICE
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_BACKLIGHT_CLASS_DEVICE_MODULE
argument_list|)
end_if

begin_function
specifier|static
name|uint8_t
name|radeon_legacy_lvds_level
parameter_list|(
name|struct
name|backlight_device
modifier|*
name|bd
parameter_list|)
block|{
name|struct
name|radeon_backlight_privdata
modifier|*
name|pdata
init|=
name|bl_get_data
argument_list|(
name|bd
argument_list|)
decl_stmt|;
name|uint8_t
name|level
decl_stmt|;
comment|/* Convert brightness to hardware level */
if|if
condition|(
name|bd
operator|->
name|props
operator|.
name|brightness
operator|<
literal|0
condition|)
name|level
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|bd
operator|->
name|props
operator|.
name|brightness
operator|>
name|RADEON_MAX_BL_LEVEL
condition|)
name|level
operator|=
name|RADEON_MAX_BL_LEVEL
expr_stmt|;
else|else
name|level
operator|=
name|bd
operator|->
name|props
operator|.
name|brightness
expr_stmt|;
if|if
condition|(
name|pdata
operator|->
name|negative
condition|)
name|level
operator|=
name|RADEON_MAX_BL_LEVEL
operator|-
name|level
expr_stmt|;
return|return
name|level
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_legacy_backlight_update_status
parameter_list|(
name|struct
name|backlight_device
modifier|*
name|bd
parameter_list|)
block|{
name|struct
name|radeon_backlight_privdata
modifier|*
name|pdata
init|=
name|bl_get_data
argument_list|(
name|bd
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|pdata
operator|->
name|encoder
decl_stmt|;
name|radeon_legacy_set_backlight_level
argument_list|(
name|radeon_encoder
argument_list|,
name|radeon_legacy_lvds_level
argument_list|(
name|bd
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_legacy_backlight_get_brightness
parameter_list|(
name|struct
name|backlight_device
modifier|*
name|bd
parameter_list|)
block|{
name|struct
name|radeon_backlight_privdata
modifier|*
name|pdata
init|=
name|bl_get_data
argument_list|(
name|bd
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|pdata
operator|->
name|encoder
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|radeon_encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint8_t
name|backlight_level
decl_stmt|;
name|backlight_level
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|)
operator|>>
name|RADEON_LVDS_BL_MOD_LEVEL_SHIFT
operator|)
operator|&
literal|0xff
expr_stmt|;
return|return
name|pdata
operator|->
name|negative
condition|?
name|RADEON_MAX_BL_LEVEL
operator|-
name|backlight_level
else|:
name|backlight_level
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|backlight_ops
name|radeon_backlight_ops
init|=
block|{
operator|.
name|get_brightness
operator|=
name|radeon_legacy_backlight_get_brightness
block|,
operator|.
name|update_status
operator|=
name|radeon_legacy_backlight_update_status
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|radeon_legacy_backlight_init
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
parameter_list|,
name|struct
name|drm_connector
modifier|*
name|drm_connector
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|radeon_encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|backlight_device
modifier|*
name|bd
decl_stmt|;
name|struct
name|backlight_properties
name|props
decl_stmt|;
name|struct
name|radeon_backlight_privdata
modifier|*
name|pdata
decl_stmt|;
name|uint8_t
name|backlight_level
decl_stmt|;
name|char
name|bl_name
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|radeon_encoder
operator|->
name|enc_priv
condition|)
return|return;
ifdef|#
directive|ifdef
name|CONFIG_PMAC_BACKLIGHT
if|if
condition|(
operator|!
name|pmac_has_backlight_type
argument_list|(
literal|"ati"
argument_list|)
operator|&&
operator|!
name|pmac_has_backlight_type
argument_list|(
literal|"mnca"
argument_list|)
condition|)
return|return;
endif|#
directive|endif
name|pdata
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_backlight_privdata
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pdata
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Memory allocation failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|memset
argument_list|(
operator|&
name|props
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|props
argument_list|)
argument_list|)
expr_stmt|;
name|props
operator|.
name|max_brightness
operator|=
name|RADEON_MAX_BL_LEVEL
expr_stmt|;
name|props
operator|.
name|type
operator|=
name|BACKLIGHT_RAW
expr_stmt|;
name|snprintf
argument_list|(
name|bl_name
argument_list|,
sizeof|sizeof
argument_list|(
name|bl_name
argument_list|)
argument_list|,
literal|"radeon_bl%d"
argument_list|,
name|dev
operator|->
name|primary
operator|->
name|index
argument_list|)
expr_stmt|;
name|bd
operator|=
name|backlight_device_register
argument_list|(
name|bl_name
argument_list|,
operator|&
name|drm_connector
operator|->
name|kdev
argument_list|,
name|pdata
argument_list|,
operator|&
name|radeon_backlight_ops
argument_list|,
operator|&
name|props
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|bd
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Backlight registration failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|pdata
operator|->
name|encoder
operator|=
name|radeon_encoder
expr_stmt|;
name|backlight_level
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|)
operator|>>
name|RADEON_LVDS_BL_MOD_LEVEL_SHIFT
operator|)
operator|&
literal|0xff
expr_stmt|;
comment|/* First, try to detect backlight level sense based on the assumption 	 * that firmware set it up at full brightness 	 */
if|if
condition|(
name|backlight_level
operator|==
literal|0
condition|)
name|pdata
operator|->
name|negative
operator|=
name|true
expr_stmt|;
elseif|else
if|if
condition|(
name|backlight_level
operator|==
literal|0xff
condition|)
name|pdata
operator|->
name|negative
operator|=
name|false
expr_stmt|;
else|else
block|{
comment|/* XXX hack... maybe some day we can figure out in what direction 		 * backlight should work on a given panel? 		 */
name|pdata
operator|->
name|negative
operator|=
operator|(
name|rdev
operator|->
name|family
operator|!=
name|CHIP_RV200
operator|&&
name|rdev
operator|->
name|family
operator|!=
name|CHIP_RV250
operator|&&
name|rdev
operator|->
name|family
operator|!=
name|CHIP_RV280
operator|&&
name|rdev
operator|->
name|family
operator|!=
name|CHIP_RV350
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_PMAC_BACKLIGHT
name|pdata
operator|->
name|negative
operator|=
operator|(
name|pdata
operator|->
name|negative
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook4,3"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook6,3"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook6,5"
argument_list|)
operator|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|struct
name|radeon_encoder_atom_dig
modifier|*
name|lvds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|lvds
operator|->
name|bl_dev
operator|=
name|bd
expr_stmt|;
block|}
else|else
block|{
name|struct
name|radeon_encoder_lvds
modifier|*
name|lvds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|lvds
operator|->
name|bl_dev
operator|=
name|bd
expr_stmt|;
block|}
name|bd
operator|->
name|props
operator|.
name|brightness
operator|=
name|radeon_legacy_backlight_get_brightness
argument_list|(
name|bd
argument_list|)
expr_stmt|;
name|bd
operator|->
name|props
operator|.
name|power
operator|=
name|FB_BLANK_UNBLANK
expr_stmt|;
name|backlight_update_status
argument_list|(
name|bd
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"radeon legacy LVDS backlight initialized\n"
argument_list|)
expr_stmt|;
return|return;
name|error
label|:
name|free
argument_list|(
name|pdata
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_backlight_exit
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|radeon_encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|backlight_device
modifier|*
name|bd
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|radeon_encoder
operator|->
name|enc_priv
condition|)
return|return;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|struct
name|radeon_encoder_atom_dig
modifier|*
name|lvds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|bd
operator|=
name|lvds
operator|->
name|bl_dev
expr_stmt|;
name|lvds
operator|->
name|bl_dev
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|struct
name|radeon_encoder_lvds
modifier|*
name|lvds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|bd
operator|=
name|lvds
operator|->
name|bl_dev
expr_stmt|;
name|lvds
operator|->
name|bl_dev
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|bd
condition|)
block|{
name|struct
name|radeon_backlight_privdata
modifier|*
name|pdata
decl_stmt|;
name|pdata
operator|=
name|bl_get_data
argument_list|(
name|bd
argument_list|)
expr_stmt|;
name|backlight_device_unregister
argument_list|(
name|bd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pdata
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"radeon legacy LVDS backlight unloaded\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !CONFIG_BACKLIGHT_CLASS_DEVICE */
end_comment

begin_function
name|void
name|radeon_legacy_backlight_init
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_connector
modifier|*
name|drm_connector
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_backlight_exit
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|)
block|{ }
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|radeon_lvds_enc_destroy
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|enc_priv
condition|)
block|{
name|radeon_legacy_backlight_exit
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|radeon_encoder
operator|->
name|enc_priv
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
name|drm_encoder_cleanup
argument_list|(
name|encoder
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|radeon_encoder
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_funcs
name|radeon_legacy_lvds_enc_funcs
init|=
block|{
operator|.
name|destroy
operator|=
name|radeon_lvds_enc_destroy
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|radeon_legacy_primary_dac_dpms
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|crtc_ext_cntl
init|=
name|RREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|)
decl_stmt|;
name|uint32_t
name|dac_cntl
init|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL
argument_list|)
decl_stmt|;
name|uint32_t
name|dac_macro_cntl
init|=
name|RREG32
argument_list|(
name|RADEON_DAC_MACRO_CNTL
argument_list|)
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|DRM_MODE_DPMS_ON
case|:
name|crtc_ext_cntl
operator||=
name|RADEON_CRTC_CRT_ON
expr_stmt|;
name|dac_cntl
operator|&=
operator|~
name|RADEON_DAC_PDWN
expr_stmt|;
name|dac_macro_cntl
operator|&=
operator|~
operator|(
name|RADEON_DAC_PDWN_R
operator||
name|RADEON_DAC_PDWN_G
operator||
name|RADEON_DAC_PDWN_B
operator|)
expr_stmt|;
break|break;
case|case
name|DRM_MODE_DPMS_STANDBY
case|:
case|case
name|DRM_MODE_DPMS_SUSPEND
case|:
case|case
name|DRM_MODE_DPMS_OFF
case|:
name|crtc_ext_cntl
operator|&=
operator|~
name|RADEON_CRTC_CRT_ON
expr_stmt|;
name|dac_cntl
operator||=
name|RADEON_DAC_PDWN
expr_stmt|;
name|dac_macro_cntl
operator||=
operator|(
name|RADEON_DAC_PDWN_R
operator||
name|RADEON_DAC_PDWN_G
operator||
name|RADEON_DAC_PDWN_B
operator|)
expr_stmt|;
break|break;
block|}
comment|/* handled in radeon_crtc_dpms() */
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
operator|)
condition|)
name|WREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|,
name|crtc_ext_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL
argument_list|,
name|dac_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_MACRO_CNTL
argument_list|,
name|dac_macro_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_encoder_dpms_scratch_regs
argument_list|(
name|encoder
argument_list|,
operator|(
name|mode
operator|==
name|DRM_MODE_DPMS_ON
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_encoder_dpms_scratch_regs
argument_list|(
name|encoder
argument_list|,
operator|(
name|mode
operator|==
name|DRM_MODE_DPMS_ON
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_primary_dac_prepare
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atom_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|radeon_legacy_primary_dac_dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_OFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_primary_dac_commit
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|radeon_legacy_primary_dac_dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atom_output_lock
argument_list|(
name|encoder
argument_list|,
name|false
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_output_lock
argument_list|(
name|encoder
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_primary_dac_mode_set
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|encoder
operator|->
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|disp_output_cntl
decl_stmt|,
name|dac_cntl
decl_stmt|,
name|dac2_cntl
decl_stmt|,
name|dac_macro_cntl
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
operator|||
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|disp_output_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|)
operator|&
operator|~
operator|(
name|RADEON_DISP_DAC_SOURCE_MASK
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|,
name|disp_output_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dac2_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
operator|&
operator|~
operator|(
name|RADEON_DAC2_DAC_CLK_SEL
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|dac2_cntl
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
operator|||
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|disp_output_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|)
operator|&
operator|~
operator|(
name|RADEON_DISP_DAC_SOURCE_MASK
operator|)
expr_stmt|;
name|disp_output_cntl
operator||=
name|RADEON_DISP_DAC_SOURCE_CRTC2
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|,
name|disp_output_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dac2_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
operator||
name|RADEON_DAC2_DAC_CLK_SEL
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|dac2_cntl
argument_list|)
expr_stmt|;
block|}
block|}
name|dac_cntl
operator|=
operator|(
name|RADEON_DAC_MASK_ALL
operator||
name|RADEON_DAC_VGA_ADR_EN
operator||
comment|/* TODO 6-bits */
name|RADEON_DAC_8BIT_EN
operator|)
expr_stmt|;
name|WREG32_P
argument_list|(
name|RADEON_DAC_CNTL
argument_list|,
name|dac_cntl
argument_list|,
name|RADEON_DAC_RANGE_CNTL
operator||
name|RADEON_DAC_BLANKING
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|enc_priv
condition|)
block|{
name|struct
name|radeon_encoder_primary_dac
modifier|*
name|p_dac
init|=
operator|(
expr|struct
name|radeon_encoder_primary_dac
operator|*
operator|)
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|dac_macro_cntl
operator|=
name|p_dac
operator|->
name|ps2_pdac_adj
expr_stmt|;
block|}
else|else
name|dac_macro_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_MACRO_CNTL
argument_list|)
expr_stmt|;
name|dac_macro_cntl
operator||=
name|RADEON_DAC_PDWN_R
operator||
name|RADEON_DAC_PDWN_G
operator||
name|RADEON_DAC_PDWN_B
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_MACRO_CNTL
argument_list|,
name|dac_macro_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_encoder_crtc_scratch_regs
argument_list|(
name|encoder
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_encoder_crtc_scratch_regs
argument_list|(
name|encoder
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|drm_connector_status
name|radeon_legacy_primary_dac_detect
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|vclk_ecp_cntl
decl_stmt|,
name|crtc_ext_cntl
decl_stmt|;
name|uint32_t
name|dac_ext_cntl
decl_stmt|,
name|dac_cntl
decl_stmt|,
name|dac_macro_cntl
decl_stmt|,
name|tmp
decl_stmt|;
name|enum
name|drm_connector_status
name|found
init|=
name|connector_status_disconnected
decl_stmt|;
name|bool
name|color
init|=
name|true
decl_stmt|;
comment|/* just don't bother on RN50 those chip are often connected to remoting 	 * console hw and often we get failure to load detect those. So to make 	 * everyone happy report the encoder as always connected. 	 */
if|if
condition|(
name|ASIC_IS_RN50
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
return|return
name|connector_status_connected
return|;
block|}
comment|/* save the regs we need */
name|vclk_ecp_cntl
operator|=
name|RREG32_PLL
argument_list|(
name|RADEON_VCLK_ECP_CNTL
argument_list|)
expr_stmt|;
name|crtc_ext_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|)
expr_stmt|;
name|dac_ext_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_EXT_CNTL
argument_list|)
expr_stmt|;
name|dac_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL
argument_list|)
expr_stmt|;
name|dac_macro_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_MACRO_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|vclk_ecp_cntl
operator|&
operator|~
operator|(
name|RADEON_PIXCLK_ALWAYS_ONb
operator||
name|RADEON_PIXCLK_DAC_ALWAYS_ONb
operator|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|RADEON_VCLK_ECP_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|crtc_ext_cntl
operator||
name|RADEON_CRTC_CRT_ON
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RADEON_DAC_FORCE_BLANK_OFF_EN
operator||
name|RADEON_DAC_FORCE_DATA_EN
expr_stmt|;
if|if
condition|(
name|color
condition|)
name|tmp
operator||=
name|RADEON_DAC_FORCE_DATA_SEL_RGB
expr_stmt|;
else|else
name|tmp
operator||=
name|RADEON_DAC_FORCE_DATA_SEL_G
expr_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
name|tmp
operator||=
operator|(
literal|0x1b6
operator|<<
name|RADEON_DAC_FORCE_DATA_SHIFT
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ASIC_IS_RV100
argument_list|(
name|rdev
argument_list|)
condition|)
name|tmp
operator||=
operator|(
literal|0x1ac
operator|<<
name|RADEON_DAC_FORCE_DATA_SHIFT
operator|)
expr_stmt|;
else|else
name|tmp
operator||=
operator|(
literal|0x180
operator|<<
name|RADEON_DAC_FORCE_DATA_SHIFT
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_EXT_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|dac_cntl
operator|&
operator|~
operator|(
name|RADEON_DAC_RANGE_CNTL_MASK
operator||
name|RADEON_DAC_PDWN
operator|)
expr_stmt|;
name|tmp
operator||=
name|RADEON_DAC_RANGE_CNTL_PS2
operator||
name|RADEON_DAC_CMP_EN
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|dac_macro_cntl
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RADEON_DAC_PDWN_R
operator||
name|RADEON_DAC_PDWN_G
operator||
name|RADEON_DAC_PDWN_B
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_MACRO_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL
argument_list|)
operator|&
name|RADEON_DAC_CMP_OUTPUT
condition|)
name|found
operator|=
name|connector_status_connected
expr_stmt|;
comment|/* restore the regs we used */
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL
argument_list|,
name|dac_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_MACRO_CNTL
argument_list|,
name|dac_macro_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_EXT_CNTL
argument_list|,
name|dac_ext_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|,
name|crtc_ext_cntl
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|RADEON_VCLK_ECP_CNTL
argument_list|,
name|vclk_ecp_cntl
argument_list|)
expr_stmt|;
return|return
name|found
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_helper_funcs
name|radeon_legacy_primary_dac_helper_funcs
init|=
block|{
operator|.
name|dpms
operator|=
name|radeon_legacy_primary_dac_dpms
block|,
operator|.
name|mode_fixup
operator|=
name|radeon_legacy_mode_fixup
block|,
operator|.
name|prepare
operator|=
name|radeon_legacy_primary_dac_prepare
block|,
operator|.
name|mode_set
operator|=
name|radeon_legacy_primary_dac_mode_set
block|,
operator|.
name|commit
operator|=
name|radeon_legacy_primary_dac_commit
block|,
operator|.
name|detect
operator|=
name|radeon_legacy_primary_dac_detect
block|,
operator|.
name|disable
operator|=
name|radeon_legacy_encoder_disable
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_funcs
name|radeon_legacy_primary_dac_enc_funcs
init|=
block|{
operator|.
name|destroy
operator|=
name|radeon_enc_destroy
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|radeon_legacy_tmds_int_dpms
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|fp_gen_cntl
init|=
name|RREG32
argument_list|(
name|RADEON_FP_GEN_CNTL
argument_list|)
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|DRM_MODE_DPMS_ON
case|:
name|fp_gen_cntl
operator||=
operator|(
name|RADEON_FP_FPON
operator||
name|RADEON_FP_TMDS_EN
operator|)
expr_stmt|;
break|break;
case|case
name|DRM_MODE_DPMS_STANDBY
case|:
case|case
name|DRM_MODE_DPMS_SUSPEND
case|:
case|case
name|DRM_MODE_DPMS_OFF
case|:
name|fp_gen_cntl
operator|&=
operator|~
operator|(
name|RADEON_FP_FPON
operator||
name|RADEON_FP_TMDS_EN
operator|)
expr_stmt|;
break|break;
block|}
name|WREG32
argument_list|(
name|RADEON_FP_GEN_CNTL
argument_list|,
name|fp_gen_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_encoder_dpms_scratch_regs
argument_list|(
name|encoder
argument_list|,
operator|(
name|mode
operator|==
name|DRM_MODE_DPMS_ON
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_encoder_dpms_scratch_regs
argument_list|(
name|encoder
argument_list|,
operator|(
name|mode
operator|==
name|DRM_MODE_DPMS_ON
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_tmds_int_prepare
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atom_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|radeon_legacy_tmds_int_dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_OFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_tmds_int_commit
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|radeon_legacy_tmds_int_dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atom_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_tmds_int_mode_set
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|encoder
operator|->
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|,
name|tmds_pll_cntl
decl_stmt|,
name|tmds_transmitter_cntl
decl_stmt|,
name|fp_gen_cntl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|tmds_pll_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_TMDS_PLL_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
literal|0xfffff
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV280
condition|)
block|{
comment|/* bit 22 of TMDS_PLL_CNTL is read-back inverted */
name|tmp
operator|^=
operator|(
literal|1
operator|<<
literal|22
operator|)
expr_stmt|;
name|tmds_pll_cntl
operator|^=
operator|(
literal|1
operator|<<
literal|22
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|enc_priv
condition|)
block|{
name|struct
name|radeon_encoder_int_tmds
modifier|*
name|tmds
init|=
operator|(
expr|struct
name|radeon_encoder_int_tmds
operator|*
operator|)
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
call|(
name|uint32_t
call|)
argument_list|(
name|mode
operator|->
name|clock
operator|/
literal|10
argument_list|)
operator|<
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
condition|)
block|{
name|tmp
operator|=
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV280
operator|)
condition|)
block|{
if|if
condition|(
name|tmp
operator|&
literal|0xfff00000
condition|)
name|tmds_pll_cntl
operator|=
name|tmp
expr_stmt|;
else|else
block|{
name|tmds_pll_cntl
operator|&=
literal|0xfff00000
expr_stmt|;
name|tmds_pll_cntl
operator||=
name|tmp
expr_stmt|;
block|}
block|}
else|else
name|tmds_pll_cntl
operator|=
name|tmp
expr_stmt|;
name|tmds_transmitter_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_TMDS_TRANSMITTER_CNTL
argument_list|)
operator|&
operator|~
operator|(
name|RADEON_TMDS_TRANSMITTER_PLLRST
operator|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R100
operator|||
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
name|tmds_transmitter_cntl
operator|&=
operator|~
operator|(
name|RADEON_TMDS_TRANSMITTER_PLLEN
operator|)
expr_stmt|;
else|else
comment|/* RV chips got this bit reversed */
name|tmds_transmitter_cntl
operator||=
name|RADEON_TMDS_TRANSMITTER_PLLEN
expr_stmt|;
name|fp_gen_cntl
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_FP_GEN_CNTL
argument_list|)
operator||
operator|(
name|RADEON_FP_CRTC_DONT_SHADOW_VPAR
operator||
name|RADEON_FP_CRTC_DONT_SHADOW_HEND
operator|)
operator|)
expr_stmt|;
name|fp_gen_cntl
operator|&=
operator|~
operator|(
name|RADEON_FP_FPON
operator||
name|RADEON_FP_TMDS_EN
operator|)
expr_stmt|;
name|fp_gen_cntl
operator|&=
operator|~
operator|(
name|RADEON_FP_RMX_HVSYNC_CONTROL_EN
operator||
name|RADEON_FP_DFP_SYNC_SEL
operator||
name|RADEON_FP_CRT_SYNC_SEL
operator||
name|RADEON_FP_CRTC_LOCK_8DOT
operator||
name|RADEON_FP_USE_SHADOW_EN
operator||
name|RADEON_FP_CRTC_USE_SHADOW_VEND
operator||
name|RADEON_FP_CRT_SYNC_ALT
operator|)
expr_stmt|;
if|if
condition|(
literal|1
condition|)
comment|/*  FIXME rgbBits == 8 */
name|fp_gen_cntl
operator||=
name|RADEON_FP_PANEL_FORMAT
expr_stmt|;
comment|/* 24 bit format */
else|else
name|fp_gen_cntl
operator|&=
operator|~
name|RADEON_FP_PANEL_FORMAT
expr_stmt|;
comment|/* 18 bit format */
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
block|{
name|fp_gen_cntl
operator|&=
operator|~
name|R200_FP_SOURCE_SEL_MASK
expr_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|rmx_type
operator|!=
name|RMX_OFF
condition|)
name|fp_gen_cntl
operator||=
name|R200_FP_SOURCE_SEL_RMX
expr_stmt|;
else|else
name|fp_gen_cntl
operator||=
name|R200_FP_SOURCE_SEL_CRTC1
expr_stmt|;
block|}
else|else
name|fp_gen_cntl
operator|&=
operator|~
name|RADEON_FP_SEL_CRTC2
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
block|{
name|fp_gen_cntl
operator|&=
operator|~
name|R200_FP_SOURCE_SEL_MASK
expr_stmt|;
name|fp_gen_cntl
operator||=
name|R200_FP_SOURCE_SEL_CRTC2
expr_stmt|;
block|}
else|else
name|fp_gen_cntl
operator||=
name|RADEON_FP_SEL_CRTC2
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_TMDS_PLL_CNTL
argument_list|,
name|tmds_pll_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TMDS_TRANSMITTER_CNTL
argument_list|,
name|tmds_transmitter_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP_GEN_CNTL
argument_list|,
name|fp_gen_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_encoder_crtc_scratch_regs
argument_list|(
name|encoder
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_encoder_crtc_scratch_regs
argument_list|(
name|encoder
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_helper_funcs
name|radeon_legacy_tmds_int_helper_funcs
init|=
block|{
operator|.
name|dpms
operator|=
name|radeon_legacy_tmds_int_dpms
block|,
operator|.
name|mode_fixup
operator|=
name|radeon_legacy_mode_fixup
block|,
operator|.
name|prepare
operator|=
name|radeon_legacy_tmds_int_prepare
block|,
operator|.
name|mode_set
operator|=
name|radeon_legacy_tmds_int_mode_set
block|,
operator|.
name|commit
operator|=
name|radeon_legacy_tmds_int_commit
block|,
operator|.
name|disable
operator|=
name|radeon_legacy_encoder_disable
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_funcs
name|radeon_legacy_tmds_int_enc_funcs
init|=
block|{
operator|.
name|destroy
operator|=
name|radeon_enc_destroy
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|radeon_legacy_tmds_ext_dpms
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|fp2_gen_cntl
init|=
name|RREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|)
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|DRM_MODE_DPMS_ON
case|:
name|fp2_gen_cntl
operator|&=
operator|~
name|RADEON_FP2_BLANK_EN
expr_stmt|;
name|fp2_gen_cntl
operator||=
operator|(
name|RADEON_FP2_ON
operator||
name|RADEON_FP2_DVO_EN
operator|)
expr_stmt|;
break|break;
case|case
name|DRM_MODE_DPMS_STANDBY
case|:
case|case
name|DRM_MODE_DPMS_SUSPEND
case|:
case|case
name|DRM_MODE_DPMS_OFF
case|:
name|fp2_gen_cntl
operator||=
name|RADEON_FP2_BLANK_EN
expr_stmt|;
name|fp2_gen_cntl
operator|&=
operator|~
operator|(
name|RADEON_FP2_ON
operator||
name|RADEON_FP2_DVO_EN
operator|)
expr_stmt|;
break|break;
block|}
name|WREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|,
name|fp2_gen_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_encoder_dpms_scratch_regs
argument_list|(
name|encoder
argument_list|,
operator|(
name|mode
operator|==
name|DRM_MODE_DPMS_ON
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_encoder_dpms_scratch_regs
argument_list|(
name|encoder
argument_list|,
operator|(
name|mode
operator|==
name|DRM_MODE_DPMS_ON
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_tmds_ext_prepare
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atom_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|radeon_legacy_tmds_ext_dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_OFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_tmds_ext_commit
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|radeon_legacy_tmds_ext_dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atom_output_lock
argument_list|(
name|encoder
argument_list|,
name|false
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_output_lock
argument_list|(
name|encoder
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_tmds_ext_mode_set
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|encoder
operator|->
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|fp2_gen_cntl
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|radeon_encoder
operator|->
name|pixel_clock
operator|=
name|adjusted_mode
operator|->
name|clock
expr_stmt|;
name|atombios_dvo_setup
argument_list|(
name|encoder
argument_list|,
name|ATOM_ENABLE
argument_list|)
expr_stmt|;
name|fp2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fp2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
condition|)
comment|/*  FIXME rgbBits == 8 */
name|fp2_gen_cntl
operator||=
name|RADEON_FP2_PANEL_FORMAT
expr_stmt|;
comment|/* 24 bit format, */
else|else
name|fp2_gen_cntl
operator|&=
operator|~
name|RADEON_FP2_PANEL_FORMAT
expr_stmt|;
comment|/* 18 bit format, */
name|fp2_gen_cntl
operator|&=
operator|~
operator|(
name|RADEON_FP2_ON
operator||
name|RADEON_FP2_DVO_EN
operator||
name|RADEON_FP2_DVO_RATE_SEL_SDR
operator|)
expr_stmt|;
comment|/* XXX: these are oem specific */
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x4850
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1028
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x2001
operator|)
condition|)
comment|/* Dell Inspiron 8600 */
name|fp2_gen_cntl
operator||=
name|R300_FP2_DVO_CLOCK_MODE_SINGLE
expr_stmt|;
else|else
name|fp2_gen_cntl
operator||=
name|RADEON_FP2_PAD_FLOP_EN
operator||
name|R300_FP2_DVO_CLOCK_MODE_SINGLE
expr_stmt|;
comment|/*if (mode->clock> 165000) 			  fp2_gen_cntl |= R300_FP2_DVO_DUAL_CHANNEL_EN;*/
block|}
if|if
condition|(
operator|!
name|radeon_combios_external_tmds_setup
argument_list|(
name|encoder
argument_list|)
condition|)
name|radeon_external_tmds_setup
argument_list|(
name|encoder
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
operator|)
operator|||
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|fp2_gen_cntl
operator|&=
operator|~
name|R200_FP2_SOURCE_SEL_MASK
expr_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|rmx_type
operator|!=
name|RMX_OFF
condition|)
name|fp2_gen_cntl
operator||=
name|R200_FP2_SOURCE_SEL_RMX
expr_stmt|;
else|else
name|fp2_gen_cntl
operator||=
name|R200_FP2_SOURCE_SEL_CRTC1
expr_stmt|;
block|}
else|else
name|fp2_gen_cntl
operator|&=
operator|~
name|RADEON_FP2_SRC_SEL_CRTC2
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
operator|)
operator|||
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|fp2_gen_cntl
operator|&=
operator|~
name|R200_FP2_SOURCE_SEL_MASK
expr_stmt|;
name|fp2_gen_cntl
operator||=
name|R200_FP2_SOURCE_SEL_CRTC2
expr_stmt|;
block|}
else|else
name|fp2_gen_cntl
operator||=
name|RADEON_FP2_SRC_SEL_CRTC2
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|,
name|fp2_gen_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_encoder_crtc_scratch_regs
argument_list|(
name|encoder
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_encoder_crtc_scratch_regs
argument_list|(
name|encoder
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_ext_tmds_enc_destroy
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
comment|/* don't destroy the i2c bus record here, this will be done in radeon_i2c_fini */
name|free
argument_list|(
name|radeon_encoder
operator|->
name|enc_priv
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|drm_encoder_cleanup
argument_list|(
name|encoder
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|radeon_encoder
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_helper_funcs
name|radeon_legacy_tmds_ext_helper_funcs
init|=
block|{
operator|.
name|dpms
operator|=
name|radeon_legacy_tmds_ext_dpms
block|,
operator|.
name|mode_fixup
operator|=
name|radeon_legacy_mode_fixup
block|,
operator|.
name|prepare
operator|=
name|radeon_legacy_tmds_ext_prepare
block|,
operator|.
name|mode_set
operator|=
name|radeon_legacy_tmds_ext_mode_set
block|,
operator|.
name|commit
operator|=
name|radeon_legacy_tmds_ext_commit
block|,
operator|.
name|disable
operator|=
name|radeon_legacy_encoder_disable
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_funcs
name|radeon_legacy_tmds_ext_enc_funcs
init|=
block|{
operator|.
name|destroy
operator|=
name|radeon_ext_tmds_enc_destroy
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|radeon_legacy_tv_dac_dpms
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|fp2_gen_cntl
init|=
literal|0
decl_stmt|,
name|crtc2_gen_cntl
init|=
literal|0
decl_stmt|,
name|tv_dac_cntl
init|=
literal|0
decl_stmt|;
name|uint32_t
name|tv_master_cntl
init|=
literal|0
decl_stmt|;
name|bool
name|is_tv
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|is_tv
operator|=
name|radeon_encoder
operator|->
name|active_device
operator|&
name|ATOM_DEVICE_TV_SUPPORT
condition|?
name|true
else|:
name|false
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
name|fp2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|is_tv
condition|)
name|tv_master_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_MASTER_CNTL
argument_list|)
expr_stmt|;
else|else
name|crtc2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|)
expr_stmt|;
name|tv_dac_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|DRM_MODE_DPMS_ON
case|:
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
block|{
name|fp2_gen_cntl
operator||=
operator|(
name|RADEON_FP2_ON
operator||
name|RADEON_FP2_DVO_EN
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|is_tv
condition|)
name|tv_master_cntl
operator||=
name|RADEON_TV_ON
expr_stmt|;
else|else
name|crtc2_gen_cntl
operator||=
name|RADEON_CRTC2_CRT2_ON
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R420
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R423
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV410
condition|)
name|tv_dac_cntl
operator|&=
operator|~
operator|(
name|R420_TV_DAC_RDACPD
operator||
name|R420_TV_DAC_GDACPD
operator||
name|R420_TV_DAC_BDACPD
operator||
name|RADEON_TV_DAC_BGSLEEP
operator|)
expr_stmt|;
else|else
name|tv_dac_cntl
operator|&=
operator|~
operator|(
name|RADEON_TV_DAC_RDACPD
operator||
name|RADEON_TV_DAC_GDACPD
operator||
name|RADEON_TV_DAC_BDACPD
operator||
name|RADEON_TV_DAC_BGSLEEP
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|DRM_MODE_DPMS_STANDBY
case|:
case|case
name|DRM_MODE_DPMS_SUSPEND
case|:
case|case
name|DRM_MODE_DPMS_OFF
case|:
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
name|fp2_gen_cntl
operator|&=
operator|~
operator|(
name|RADEON_FP2_ON
operator||
name|RADEON_FP2_DVO_EN
operator|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|is_tv
condition|)
name|tv_master_cntl
operator|&=
operator|~
name|RADEON_TV_ON
expr_stmt|;
else|else
name|crtc2_gen_cntl
operator|&=
operator|~
name|RADEON_CRTC2_CRT2_ON
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R420
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R423
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV410
condition|)
name|tv_dac_cntl
operator||=
operator|(
name|R420_TV_DAC_RDACPD
operator||
name|R420_TV_DAC_GDACPD
operator||
name|R420_TV_DAC_BDACPD
operator||
name|RADEON_TV_DAC_BGSLEEP
operator|)
expr_stmt|;
else|else
name|tv_dac_cntl
operator||=
operator|(
name|RADEON_TV_DAC_RDACPD
operator||
name|RADEON_TV_DAC_GDACPD
operator||
name|RADEON_TV_DAC_BDACPD
operator||
name|RADEON_TV_DAC_BGSLEEP
operator|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|,
name|fp2_gen_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|is_tv
condition|)
name|WREG32
argument_list|(
name|RADEON_TV_MASTER_CNTL
argument_list|,
name|tv_master_cntl
argument_list|)
expr_stmt|;
comment|/* handled in radeon_crtc_dpms() */
elseif|else
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
operator|)
condition|)
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|crtc2_gen_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|tv_dac_cntl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_encoder_dpms_scratch_regs
argument_list|(
name|encoder
argument_list|,
operator|(
name|mode
operator|==
name|DRM_MODE_DPMS_ON
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_encoder_dpms_scratch_regs
argument_list|(
name|encoder
argument_list|,
operator|(
name|mode
operator|==
name|DRM_MODE_DPMS_ON
operator|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_tv_dac_prepare
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atom_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|radeon_legacy_tv_dac_dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_OFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_tv_dac_commit
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|encoder
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|radeon_legacy_tv_dac_dpms
argument_list|(
name|encoder
argument_list|,
name|DRM_MODE_DPMS_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atom_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_output_lock
argument_list|(
name|encoder
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_tv_dac_mode_set
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|encoder
operator|->
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|tv_dac
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|uint32_t
name|tv_dac_cntl
decl_stmt|,
name|gpiopad_a
init|=
literal|0
decl_stmt|,
name|dac2_cntl
decl_stmt|,
name|disp_output_cntl
init|=
literal|0
decl_stmt|;
name|uint32_t
name|disp_hw_debug
init|=
literal|0
decl_stmt|,
name|fp2_gen_cntl
init|=
literal|0
decl_stmt|,
name|disp_tv_out_cntl
init|=
literal|0
decl_stmt|;
name|bool
name|is_tv
init|=
name|false
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|is_tv
operator|=
name|radeon_encoder
operator|->
name|active_device
operator|&
name|ATOM_DEVICE_TV_SUPPORT
condition|?
name|true
else|:
name|false
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|!=
name|CHIP_R200
condition|)
block|{
name|tv_dac_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R420
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R423
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV410
condition|)
block|{
name|tv_dac_cntl
operator|&=
operator|~
operator|(
name|RADEON_TV_DAC_STD_MASK
operator||
name|RADEON_TV_DAC_BGADJ_MASK
operator||
name|R420_TV_DAC_DACADJ_MASK
operator||
name|R420_TV_DAC_RDACPD
operator||
name|R420_TV_DAC_GDACPD
operator||
name|R420_TV_DAC_BDACPD
operator||
name|R420_TV_DAC_TVENABLE
operator|)
expr_stmt|;
block|}
else|else
block|{
name|tv_dac_cntl
operator|&=
operator|~
operator|(
name|RADEON_TV_DAC_STD_MASK
operator||
name|RADEON_TV_DAC_BGADJ_MASK
operator||
name|RADEON_TV_DAC_DACADJ_MASK
operator||
name|RADEON_TV_DAC_RDACPD
operator||
name|RADEON_TV_DAC_GDACPD
operator||
name|RADEON_TV_DAC_BDACPD
operator|)
expr_stmt|;
block|}
name|tv_dac_cntl
operator||=
name|RADEON_TV_DAC_NBLANK
operator||
name|RADEON_TV_DAC_NHOLD
expr_stmt|;
if|if
condition|(
name|is_tv
condition|)
block|{
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_M
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_60
condition|)
name|tv_dac_cntl
operator||=
name|tv_dac
operator|->
name|ntsc_tvdac_adj
expr_stmt|;
else|else
name|tv_dac_cntl
operator||=
name|tv_dac
operator|->
name|pal_tvdac_adj
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
condition|)
name|tv_dac_cntl
operator||=
name|RADEON_TV_DAC_STD_NTSC
expr_stmt|;
else|else
name|tv_dac_cntl
operator||=
name|RADEON_TV_DAC_STD_PAL
expr_stmt|;
block|}
else|else
name|tv_dac_cntl
operator||=
operator|(
name|RADEON_TV_DAC_STD_PS2
operator||
name|tv_dac
operator|->
name|ps2_tvdac_adj
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|tv_dac_cntl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|gpiopad_a
operator|=
name|RREG32
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|)
operator||
literal|1
expr_stmt|;
name|disp_output_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|!=
name|CHIP_R200
condition|)
name|disp_hw_debug
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_HW_DEBUG
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
name|fp2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R200
condition|)
name|disp_tv_out_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_TV_OUT_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_tv
condition|)
block|{
name|uint32_t
name|dac_cntl
decl_stmt|;
name|dac_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL
argument_list|)
expr_stmt|;
name|dac_cntl
operator|&=
operator|~
name|RADEON_DAC_TVO_EN
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL
argument_list|,
name|dac_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
name|gpiopad_a
operator|=
name|RREG32
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|)
operator|&
operator|~
literal|1
expr_stmt|;
name|dac2_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
operator|&
operator|~
name|RADEON_DAC2_DAC2_CLK_SEL
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|disp_output_cntl
operator|&=
operator|~
name|RADEON_DISP_TVDAC_SOURCE_MASK
expr_stmt|;
name|disp_output_cntl
operator||=
operator|(
name|RADEON_DISP_TVDAC_SOURCE_CRTC
operator||
name|RADEON_DISP_TV_SOURCE_CRTC
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R200
condition|)
block|{
name|disp_tv_out_cntl
operator|&=
operator|~
name|RADEON_DISP_TV_PATH_SRC_CRTC2
expr_stmt|;
block|}
else|else
block|{
name|disp_hw_debug
operator||=
name|RADEON_CRT2_DISP1_SEL
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|disp_output_cntl
operator|&=
operator|~
name|RADEON_DISP_TVDAC_SOURCE_MASK
expr_stmt|;
name|disp_output_cntl
operator||=
name|RADEON_DISP_TV_SOURCE_CRTC
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R200
condition|)
block|{
name|disp_tv_out_cntl
operator||=
name|RADEON_DISP_TV_PATH_SRC_CRTC2
expr_stmt|;
block|}
else|else
block|{
name|disp_hw_debug
operator|&=
operator|~
name|RADEON_CRT2_DISP1_SEL
expr_stmt|;
block|}
block|}
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|dac2_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dac2_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
operator||
name|RADEON_DAC2_DAC2_CLK_SEL
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|disp_output_cntl
operator|&=
operator|~
name|RADEON_DISP_TVDAC_SOURCE_MASK
expr_stmt|;
name|disp_output_cntl
operator||=
name|RADEON_DISP_TVDAC_SOURCE_CRTC
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
block|{
name|fp2_gen_cntl
operator|&=
operator|~
operator|(
name|R200_FP2_SOURCE_SEL_MASK
operator||
name|RADEON_FP2_DVO_RATE_SEL_SDR
operator|)
expr_stmt|;
block|}
else|else
name|disp_hw_debug
operator||=
name|RADEON_CRT2_DISP1_SEL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|disp_output_cntl
operator|&=
operator|~
name|RADEON_DISP_TVDAC_SOURCE_MASK
expr_stmt|;
name|disp_output_cntl
operator||=
name|RADEON_DISP_TVDAC_SOURCE_CRTC2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
block|{
name|fp2_gen_cntl
operator|&=
operator|~
operator|(
name|R200_FP2_SOURCE_SEL_MASK
operator||
name|RADEON_FP2_DVO_RATE_SEL_SDR
operator|)
expr_stmt|;
name|fp2_gen_cntl
operator||=
name|R200_FP2_SOURCE_SEL_CRTC2
expr_stmt|;
block|}
else|else
name|disp_hw_debug
operator|&=
operator|~
name|RADEON_CRT2_DISP1_SEL
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|dac2_cntl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32_P
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|,
name|gpiopad_a
argument_list|,
operator|~
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|,
name|disp_output_cntl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|!=
name|CHIP_R200
condition|)
name|WREG32
argument_list|(
name|RADEON_DISP_HW_DEBUG
argument_list|,
name|disp_hw_debug
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
name|WREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|,
name|fp2_gen_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R200
condition|)
name|WREG32
argument_list|(
name|RADEON_DISP_TV_OUT_CNTL
argument_list|,
name|disp_tv_out_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_tv
condition|)
name|radeon_legacy_tv_mode_set
argument_list|(
name|encoder
argument_list|,
name|mode
argument_list|,
name|adjusted_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_atombios_encoder_crtc_scratch_regs
argument_list|(
name|encoder
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
else|else
name|radeon_combios_encoder_crtc_scratch_regs
argument_list|(
name|encoder
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|r300_legacy_tv_detect
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|crtc2_gen_cntl
decl_stmt|,
name|tv_dac_cntl
decl_stmt|,
name|dac_cntl2
decl_stmt|,
name|dac_ext_cntl
decl_stmt|;
name|uint32_t
name|disp_output_cntl
decl_stmt|,
name|gpiopad_a
decl_stmt|,
name|tmp
decl_stmt|;
name|bool
name|found
init|=
name|false
decl_stmt|;
comment|/* save regs needed */
name|gpiopad_a
operator|=
name|RREG32
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|)
expr_stmt|;
name|dac_cntl2
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
expr_stmt|;
name|crtc2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|)
expr_stmt|;
name|dac_ext_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_EXT_CNTL
argument_list|)
expr_stmt|;
name|tv_dac_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
expr_stmt|;
name|disp_output_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|)
expr_stmt|;
name|WREG32_P
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|,
literal|0
argument_list|,
operator|~
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|RADEON_DAC2_DAC2_CLK_SEL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|RADEON_CRTC2_CRT2_ON
operator||
name|RADEON_CRTC2_VSYNC_TRISTAT
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|disp_output_cntl
operator|&
operator|~
name|RADEON_DISP_TVDAC_SOURCE_MASK
expr_stmt|;
name|tmp
operator||=
name|RADEON_DISP_TVDAC_SOURCE_CRTC2
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_EXT_CNTL
argument_list|,
name|RADEON_DAC2_FORCE_BLANK_OFF_EN
operator||
name|RADEON_DAC2_FORCE_DATA_EN
operator||
name|RADEON_DAC_FORCE_DATA_SEL_RGB
operator||
operator|(
literal|0xec
operator|<<
name|RADEON_DAC_FORCE_DATA_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|RADEON_TV_DAC_STD_NTSC
operator||
operator|(
literal|8
operator|<<
name|RADEON_TV_DAC_BGADJ_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|RADEON_TV_DAC_DACADJ_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|RADEON_TV_DAC_NBLANK
operator||
name|RADEON_TV_DAC_NHOLD
operator||
name|RADEON_TV_MONITOR_DETECT_EN
operator||
name|RADEON_TV_DAC_STD_NTSC
operator||
operator|(
literal|8
operator|<<
name|RADEON_TV_DAC_BGADJ_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|RADEON_TV_DAC_DACADJ_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
name|RADEON_TV_DAC_GDACDET
operator|)
operator|!=
literal|0
condition|)
block|{
name|found
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"S-video TV connection detected\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|tmp
operator|&
name|RADEON_TV_DAC_BDACDET
operator|)
operator|!=
literal|0
condition|)
block|{
name|found
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Composite TV connection detected\n"
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|tv_dac_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_EXT_CNTL
argument_list|,
name|dac_ext_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|crtc2_gen_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|,
name|disp_output_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|dac_cntl2
argument_list|)
expr_stmt|;
name|WREG32_P
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|,
name|gpiopad_a
argument_list|,
operator|~
literal|1
argument_list|)
expr_stmt|;
return|return
name|found
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_legacy_tv_detect
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|tv_dac_cntl
decl_stmt|,
name|dac_cntl2
decl_stmt|;
name|uint32_t
name|config_cntl
decl_stmt|,
name|tv_pre_dac_mux_cntl
decl_stmt|,
name|tv_master_cntl
decl_stmt|,
name|tmp
decl_stmt|;
name|bool
name|found
init|=
name|false
decl_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
name|r300_legacy_tv_detect
argument_list|(
name|encoder
argument_list|,
name|connector
argument_list|)
return|;
name|dac_cntl2
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
expr_stmt|;
name|tv_master_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_MASTER_CNTL
argument_list|)
expr_stmt|;
name|tv_dac_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
expr_stmt|;
name|config_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CONFIG_CNTL
argument_list|)
expr_stmt|;
name|tv_pre_dac_mux_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_PRE_DAC_MUX_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|dac_cntl2
operator|&
operator|~
name|RADEON_DAC2_DAC2_CLK_SEL
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|tv_master_cntl
operator||
name|RADEON_TV_ON
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RADEON_TV_ASYNC_RST
operator||
name|RADEON_RESTART_PHASE_FIX
operator||
name|RADEON_CRT_FIFO_CE_EN
operator||
name|RADEON_TV_FIFO_CE_EN
operator||
name|RADEON_RE_SYNC_NOW_SEL_MASK
operator|)
expr_stmt|;
name|tmp
operator||=
name|RADEON_TV_FIFO_ASYNC_RST
operator||
name|RADEON_CRT_ASYNC_RST
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_MASTER_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RADEON_TV_DAC_NBLANK
operator||
name|RADEON_TV_DAC_NHOLD
operator||
name|RADEON_TV_MONITOR_DETECT_EN
operator||
name|RADEON_TV_DAC_STD_NTSC
operator||
operator|(
literal|8
operator|<<
name|RADEON_TV_DAC_BGADJ_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|config_cntl
operator|&
name|RADEON_CFG_ATI_REV_ID_MASK
condition|)
name|tmp
operator||=
operator|(
literal|4
operator|<<
name|RADEON_TV_DAC_DACADJ_SHIFT
operator|)
expr_stmt|;
else|else
name|tmp
operator||=
operator|(
literal|8
operator|<<
name|RADEON_TV_DAC_DACADJ_SHIFT
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RADEON_C_GRN_EN
operator||
name|RADEON_CMP_BLU_EN
operator||
name|RADEON_RED_MX_FORCE_DAC_DATA
operator||
name|RADEON_GRN_MX_FORCE_DAC_DATA
operator||
name|RADEON_BLU_MX_FORCE_DAC_DATA
operator||
operator|(
literal|0x109
operator|<<
name|RADEON_TV_FORCE_DAC_DATA_SHIFT
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_PRE_DAC_MUX_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_TV_DAC_GDACDET
condition|)
block|{
name|found
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"S-video TV connection detected\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|tmp
operator|&
name|RADEON_TV_DAC_BDACDET
operator|)
operator|!=
literal|0
condition|)
block|{
name|found
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Composite TV connection detected\n"
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_TV_PRE_DAC_MUX_CNTL
argument_list|,
name|tv_pre_dac_mux_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|tv_dac_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_MASTER_CNTL
argument_list|,
name|tv_master_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|dac_cntl2
argument_list|)
expr_stmt|;
return|return
name|found
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_legacy_ext_dac_detect
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|gpio_monid
decl_stmt|,
name|fp2_gen_cntl
decl_stmt|,
name|disp_output_cntl
decl_stmt|,
name|crtc2_gen_cntl
decl_stmt|;
name|uint32_t
name|disp_lin_trans_grph_a
decl_stmt|,
name|disp_lin_trans_grph_b
decl_stmt|,
name|disp_lin_trans_grph_c
decl_stmt|;
name|uint32_t
name|disp_lin_trans_grph_d
decl_stmt|,
name|disp_lin_trans_grph_e
decl_stmt|,
name|disp_lin_trans_grph_f
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|,
name|crtc2_h_total_disp
decl_stmt|,
name|crtc2_v_total_disp
decl_stmt|;
name|uint32_t
name|crtc2_h_sync_strt_wid
decl_stmt|,
name|crtc2_v_sync_strt_wid
decl_stmt|;
name|bool
name|found
init|=
name|false
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* save the regs we need */
name|gpio_monid
operator|=
name|RREG32
argument_list|(
name|RADEON_GPIO_MONID
argument_list|)
expr_stmt|;
name|fp2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|)
expr_stmt|;
name|disp_output_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|)
expr_stmt|;
name|crtc2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|)
expr_stmt|;
name|disp_lin_trans_grph_a
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_A
argument_list|)
expr_stmt|;
name|disp_lin_trans_grph_b
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_B
argument_list|)
expr_stmt|;
name|disp_lin_trans_grph_c
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_C
argument_list|)
expr_stmt|;
name|disp_lin_trans_grph_d
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_D
argument_list|)
expr_stmt|;
name|disp_lin_trans_grph_e
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_E
argument_list|)
expr_stmt|;
name|disp_lin_trans_grph_f
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_F
argument_list|)
expr_stmt|;
name|crtc2_h_total_disp
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_H_TOTAL_DISP
argument_list|)
expr_stmt|;
name|crtc2_v_total_disp
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_V_TOTAL_DISP
argument_list|)
expr_stmt|;
name|crtc2_h_sync_strt_wid
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_H_SYNC_STRT_WID
argument_list|)
expr_stmt|;
name|crtc2_v_sync_strt_wid
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_V_SYNC_STRT_WID
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_GPIO_MONID
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|RADEON_GPIO_A_0
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_GPIO_MONID
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|,
operator|(
name|RADEON_FP2_ON
operator||
name|RADEON_FP2_PANEL_FORMAT
operator||
name|R200_FP2_SOURCE_SEL_TRANS_UNIT
operator||
name|RADEON_FP2_DVO_EN
operator||
name|R200_FP2_DVO_RATE_SEL_SDR
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|,
operator|(
name|RADEON_DISP_DAC_SOURCE_RMX
operator||
name|RADEON_DISP_TRANS_MATRIX_GRAPHICS
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
operator|(
name|RADEON_CRTC2_EN
operator||
name|RADEON_CRTC2_DISP_REQ_EN_B
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_A
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_B
argument_list|,
literal|0x000003f0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_C
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_D
argument_list|,
literal|0x000003f0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_E
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_F
argument_list|,
literal|0x000003f0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_H_TOTAL_DISP
argument_list|,
literal|0x01000008
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_H_SYNC_STRT_WID
argument_list|,
literal|0x00000800
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_V_TOTAL_DISP
argument_list|,
literal|0x00080001
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_V_SYNC_STRT_WID
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|200
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_GPIO_MONID
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_GPIO_Y_0
condition|)
name|found
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|found
condition|)
break|break;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drm_can_sleep
argument_list|()
condition|)
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
else|else
name|DRM_MSLEEP
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* restore the regs we used */
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_A
argument_list|,
name|disp_lin_trans_grph_a
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_B
argument_list|,
name|disp_lin_trans_grph_b
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_C
argument_list|,
name|disp_lin_trans_grph_c
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_D
argument_list|,
name|disp_lin_trans_grph_d
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_E
argument_list|,
name|disp_lin_trans_grph_e
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_LIN_TRANS_GRPH_F
argument_list|,
name|disp_lin_trans_grph_f
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_H_TOTAL_DISP
argument_list|,
name|crtc2_h_total_disp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_V_TOTAL_DISP
argument_list|,
name|crtc2_v_total_disp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_H_SYNC_STRT_WID
argument_list|,
name|crtc2_h_sync_strt_wid
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_V_SYNC_STRT_WID
argument_list|,
name|crtc2_v_sync_strt_wid
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|crtc2_gen_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|,
name|disp_output_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|,
name|fp2_gen_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_GPIO_MONID
argument_list|,
name|gpio_monid
argument_list|)
expr_stmt|;
return|return
name|found
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|drm_connector_status
name|radeon_legacy_tv_dac_detect
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|crtc2_gen_cntl
init|=
literal|0
decl_stmt|,
name|tv_dac_cntl
decl_stmt|,
name|dac_cntl2
decl_stmt|,
name|dac_ext_cntl
decl_stmt|;
name|uint32_t
name|gpiopad_a
init|=
literal|0
decl_stmt|,
name|pixclks_cntl
decl_stmt|,
name|tmp
decl_stmt|;
name|uint32_t
name|disp_output_cntl
init|=
literal|0
decl_stmt|,
name|disp_hw_debug
init|=
literal|0
decl_stmt|,
name|crtc_ext_cntl
init|=
literal|0
decl_stmt|;
name|enum
name|drm_connector_status
name|found
init|=
name|connector_status_disconnected
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|tv_dac
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|bool
name|color
init|=
name|true
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
decl_stmt|;
comment|/* find out if crtc2 is in use or if this encoder is using it */
name|list_for_each_entry
argument_list|(
argument|crtc
argument_list|,
argument|&dev->mode_config.crtc_list
argument_list|,
argument|head
argument_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|1
operator|)
operator|&&
name|crtc
operator|->
name|enabled
condition|)
block|{
if|if
condition|(
name|encoder
operator|->
name|crtc
operator|!=
name|crtc
condition|)
block|{
return|return
name|connector_status_disconnected
return|;
block|}
block|}
block|}
if|if
condition|(
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_SVIDEO
operator|||
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_Composite
operator|||
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_9PinDIN
condition|)
block|{
name|bool
name|tv_detect
decl_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|active_device
operator|&&
operator|!
operator|(
name|radeon_encoder
operator|->
name|active_device
operator|&
name|ATOM_DEVICE_TV_SUPPORT
operator|)
condition|)
return|return
name|connector_status_disconnected
return|;
name|tv_detect
operator|=
name|radeon_legacy_tv_detect
argument_list|(
name|encoder
argument_list|,
name|connector
argument_list|)
expr_stmt|;
if|if
condition|(
name|tv_detect
operator|&&
name|tv_dac
condition|)
name|found
operator|=
name|connector_status_connected
expr_stmt|;
return|return
name|found
return|;
block|}
comment|/* don't probe if the encoder is being used for something else not CRT related */
if|if
condition|(
name|radeon_encoder
operator|->
name|active_device
operator|&&
operator|!
operator|(
name|radeon_encoder
operator|->
name|active_device
operator|&
name|ATOM_DEVICE_CRT_SUPPORT
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"not detecting due to %08x\n"
argument_list|,
name|radeon_encoder
operator|->
name|active_device
argument_list|)
expr_stmt|;
return|return
name|connector_status_disconnected
return|;
block|}
comment|/* R200 uses an external DAC for secondary DAC */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
condition|)
block|{
if|if
condition|(
name|radeon_legacy_ext_dac_detect
argument_list|(
name|encoder
argument_list|,
name|connector
argument_list|)
condition|)
name|found
operator|=
name|connector_status_connected
expr_stmt|;
return|return
name|found
return|;
block|}
comment|/* save the regs we need */
name|pixclks_cntl
operator|=
name|RREG32_PLL
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
condition|)
block|{
name|crtc_ext_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|gpiopad_a
operator|=
name|RREG32
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|)
expr_stmt|;
name|disp_output_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|disp_hw_debug
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_HW_DEBUG
argument_list|)
expr_stmt|;
block|}
name|crtc2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|)
expr_stmt|;
block|}
name|tv_dac_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
expr_stmt|;
name|dac_ext_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_EXT_CNTL
argument_list|)
expr_stmt|;
name|dac_cntl2
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|pixclks_cntl
operator|&
operator|~
operator|(
name|RADEON_PIX2CLK_ALWAYS_ONb
operator||
name|RADEON_PIX2CLK_DAC_ALWAYS_ONb
operator|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
condition|)
block|{
name|tmp
operator|=
name|crtc_ext_cntl
operator||
name|RADEON_CRTC_CRT_ON
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|crtc2_gen_cntl
operator|&
operator|~
name|RADEON_CRTC2_PIX_WIDTH_MASK
expr_stmt|;
name|tmp
operator||=
name|RADEON_CRTC2_CRT2_ON
operator||
operator|(
literal|2
operator|<<
name|RADEON_CRTC2_PIX_WIDTH_SHIFT
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32_P
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|,
literal|1
argument_list|,
operator|~
literal|1
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|disp_output_cntl
operator|&
operator|~
name|RADEON_DISP_TVDAC_SOURCE_MASK
expr_stmt|;
name|tmp
operator||=
name|RADEON_DISP_TVDAC_SOURCE_CRTC2
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|disp_hw_debug
operator|&
operator|~
name|RADEON_CRT2_DISP1_SEL
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_HW_DEBUG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
name|tmp
operator|=
name|RADEON_TV_DAC_NBLANK
operator||
name|RADEON_TV_DAC_NHOLD
operator||
name|RADEON_TV_MONITOR_DETECT_EN
operator||
name|RADEON_TV_DAC_STD_PS2
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RADEON_DAC2_FORCE_BLANK_OFF_EN
operator||
name|RADEON_DAC2_FORCE_DATA_EN
expr_stmt|;
if|if
condition|(
name|color
condition|)
name|tmp
operator||=
name|RADEON_DAC_FORCE_DATA_SEL_RGB
expr_stmt|;
else|else
name|tmp
operator||=
name|RADEON_DAC_FORCE_DATA_SEL_G
expr_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
name|tmp
operator||=
operator|(
literal|0x1b6
operator|<<
name|RADEON_DAC_FORCE_DATA_SHIFT
operator|)
expr_stmt|;
else|else
name|tmp
operator||=
operator|(
literal|0x180
operator|<<
name|RADEON_DAC_FORCE_DATA_SHIFT
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_EXT_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|dac_cntl2
operator||
name|RADEON_DAC2_DAC2_CLK_SEL
operator||
name|RADEON_DAC2_CMP_EN
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
operator|&
name|RADEON_DAC2_CMP_OUT_B
condition|)
name|found
operator|=
name|connector_status_connected
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
operator|&
name|RADEON_DAC2_CMP_OUTPUT
condition|)
name|found
operator|=
name|connector_status_connected
expr_stmt|;
block|}
comment|/* restore regs we used */
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|dac_cntl2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_EXT_CNTL
argument_list|,
name|dac_ext_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|tv_dac_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|,
name|crtc_ext_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|crtc2_gen_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_DISP_OUTPUT_CNTL
argument_list|,
name|disp_output_cntl
argument_list|)
expr_stmt|;
name|WREG32_P
argument_list|(
name|RADEON_GPIOPAD_A
argument_list|,
name|gpiopad_a
argument_list|,
operator|~
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|RADEON_DISP_HW_DEBUG
argument_list|,
name|disp_hw_debug
argument_list|)
expr_stmt|;
block|}
block|}
name|WREG32_PLL
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|,
name|pixclks_cntl
argument_list|)
expr_stmt|;
return|return
name|found
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_helper_funcs
name|radeon_legacy_tv_dac_helper_funcs
init|=
block|{
operator|.
name|dpms
operator|=
name|radeon_legacy_tv_dac_dpms
block|,
operator|.
name|mode_fixup
operator|=
name|radeon_legacy_mode_fixup
block|,
operator|.
name|prepare
operator|=
name|radeon_legacy_tv_dac_prepare
block|,
operator|.
name|mode_set
operator|=
name|radeon_legacy_tv_dac_mode_set
block|,
operator|.
name|commit
operator|=
name|radeon_legacy_tv_dac_commit
block|,
operator|.
name|detect
operator|=
name|radeon_legacy_tv_dac_detect
block|,
operator|.
name|disable
operator|=
name|radeon_legacy_encoder_disable
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_funcs
name|radeon_legacy_tv_dac_enc_funcs
init|=
block|{
operator|.
name|destroy
operator|=
name|radeon_enc_destroy
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|radeon_encoder_int_tmds
modifier|*
name|radeon_legacy_get_tmds_info
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder_int_tmds
modifier|*
name|tmds
init|=
name|NULL
decl_stmt|;
name|bool
name|ret
decl_stmt|;
name|tmds
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_encoder_int_tmds
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmds
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|ret
operator|=
name|radeon_atombios_get_tmds_info
argument_list|(
name|encoder
argument_list|,
name|tmds
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|radeon_legacy_get_tmds_info_from_combios
argument_list|(
name|encoder
argument_list|,
name|tmds
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|false
condition|)
name|radeon_legacy_get_tmds_info_from_table
argument_list|(
name|encoder
argument_list|,
name|tmds
argument_list|)
expr_stmt|;
return|return
name|tmds
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radeon_encoder_ext_tmds
modifier|*
name|radeon_legacy_get_ext_tmds_info
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder_ext_tmds
modifier|*
name|tmds
init|=
name|NULL
decl_stmt|;
name|bool
name|ret
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
return|return
name|NULL
return|;
name|tmds
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_encoder_ext_tmds
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmds
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|radeon_legacy_get_ext_tmds_info_from_combios
argument_list|(
name|encoder
argument_list|,
name|tmds
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|false
condition|)
name|radeon_legacy_get_ext_tmds_info_from_table
argument_list|(
name|encoder
argument_list|,
name|tmds
argument_list|)
expr_stmt|;
return|return
name|tmds
return|;
block|}
end_function

begin_function
name|void
name|radeon_add_legacy_encoder
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|uint32_t
name|encoder_enum
parameter_list|,
name|uint32_t
name|supported_device
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_encoder
modifier|*
name|encoder
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
decl_stmt|;
comment|/* see if we already added it */
name|list_for_each_entry
argument_list|(
argument|encoder
argument_list|,
argument|&dev->mode_config.encoder_list
argument_list|,
argument|head
argument_list|)
block|{
name|radeon_encoder
operator|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|encoder_enum
operator|==
name|encoder_enum
condition|)
block|{
name|radeon_encoder
operator|->
name|devices
operator||=
name|supported_device
expr_stmt|;
return|return;
block|}
block|}
comment|/* add a new one */
name|radeon_encoder
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_encoder
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|radeon_encoder
condition|)
return|return;
name|encoder
operator|=
operator|&
name|radeon_encoder
operator|->
name|base
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
condition|)
name|encoder
operator|->
name|possible_crtcs
operator|=
literal|0x1
expr_stmt|;
else|else
name|encoder
operator|->
name|possible_crtcs
operator|=
literal|0x3
expr_stmt|;
name|radeon_encoder
operator|->
name|enc_priv
operator|=
name|NULL
expr_stmt|;
name|radeon_encoder
operator|->
name|encoder_enum
operator|=
name|encoder_enum
expr_stmt|;
name|radeon_encoder
operator|->
name|encoder_id
operator|=
operator|(
name|encoder_enum
operator|&
name|OBJECT_ID_MASK
operator|)
operator|>>
name|OBJECT_ID_SHIFT
expr_stmt|;
name|radeon_encoder
operator|->
name|devices
operator|=
name|supported_device
expr_stmt|;
name|radeon_encoder
operator|->
name|rmx_type
operator|=
name|RMX_OFF
expr_stmt|;
switch|switch
condition|(
name|radeon_encoder
operator|->
name|encoder_id
condition|)
block|{
case|case
name|ENCODER_OBJECT_ID_INTERNAL_LVDS
case|:
name|encoder
operator|->
name|possible_crtcs
operator|=
literal|0x1
expr_stmt|;
name|drm_encoder_init
argument_list|(
name|dev
argument_list|,
name|encoder
argument_list|,
operator|&
name|radeon_legacy_lvds_enc_funcs
argument_list|,
name|DRM_MODE_ENCODER_LVDS
argument_list|)
expr_stmt|;
name|drm_encoder_helper_add
argument_list|(
name|encoder
argument_list|,
operator|&
name|radeon_legacy_lvds_helper_funcs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_encoder
operator|->
name|enc_priv
operator|=
name|radeon_atombios_get_lvds_info
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
else|else
name|radeon_encoder
operator|->
name|enc_priv
operator|=
name|radeon_combios_get_lvds_info
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
name|radeon_encoder
operator|->
name|rmx_type
operator|=
name|RMX_FULL
expr_stmt|;
break|break;
case|case
name|ENCODER_OBJECT_ID_INTERNAL_TMDS1
case|:
name|drm_encoder_init
argument_list|(
name|dev
argument_list|,
name|encoder
argument_list|,
operator|&
name|radeon_legacy_tmds_int_enc_funcs
argument_list|,
name|DRM_MODE_ENCODER_TMDS
argument_list|)
expr_stmt|;
name|drm_encoder_helper_add
argument_list|(
name|encoder
argument_list|,
operator|&
name|radeon_legacy_tmds_int_helper_funcs
argument_list|)
expr_stmt|;
name|radeon_encoder
operator|->
name|enc_priv
operator|=
name|radeon_legacy_get_tmds_info
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
break|break;
case|case
name|ENCODER_OBJECT_ID_INTERNAL_DAC1
case|:
name|drm_encoder_init
argument_list|(
name|dev
argument_list|,
name|encoder
argument_list|,
operator|&
name|radeon_legacy_primary_dac_enc_funcs
argument_list|,
name|DRM_MODE_ENCODER_DAC
argument_list|)
expr_stmt|;
name|drm_encoder_helper_add
argument_list|(
name|encoder
argument_list|,
operator|&
name|radeon_legacy_primary_dac_helper_funcs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_encoder
operator|->
name|enc_priv
operator|=
name|radeon_atombios_get_primary_dac_info
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
else|else
name|radeon_encoder
operator|->
name|enc_priv
operator|=
name|radeon_combios_get_primary_dac_info
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
break|break;
case|case
name|ENCODER_OBJECT_ID_INTERNAL_DAC2
case|:
name|drm_encoder_init
argument_list|(
name|dev
argument_list|,
name|encoder
argument_list|,
operator|&
name|radeon_legacy_tv_dac_enc_funcs
argument_list|,
name|DRM_MODE_ENCODER_TVDAC
argument_list|)
expr_stmt|;
name|drm_encoder_helper_add
argument_list|(
name|encoder
argument_list|,
operator|&
name|radeon_legacy_tv_dac_helper_funcs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_encoder
operator|->
name|enc_priv
operator|=
name|radeon_atombios_get_tv_dac_info
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
else|else
name|radeon_encoder
operator|->
name|enc_priv
operator|=
name|radeon_combios_get_tv_dac_info
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
break|break;
case|case
name|ENCODER_OBJECT_ID_INTERNAL_DVO1
case|:
name|drm_encoder_init
argument_list|(
name|dev
argument_list|,
name|encoder
argument_list|,
operator|&
name|radeon_legacy_tmds_ext_enc_funcs
argument_list|,
name|DRM_MODE_ENCODER_TMDS
argument_list|)
expr_stmt|;
name|drm_encoder_helper_add
argument_list|(
name|encoder
argument_list|,
operator|&
name|radeon_legacy_tmds_ext_helper_funcs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|is_atom_bios
condition|)
name|radeon_encoder
operator|->
name|enc_priv
operator|=
name|radeon_legacy_get_ext_tmds_info
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

end_unit


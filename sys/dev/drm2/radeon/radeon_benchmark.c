begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon_reg.h"
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_define
define|#
directive|define
name|RADEON_BENCHMARK_COPY_BLIT
value|1
end_define

begin_define
define|#
directive|define
name|RADEON_BENCHMARK_COPY_DMA
value|0
end_define

begin_define
define|#
directive|define
name|RADEON_BENCHMARK_ITERATIONS
value|1024
end_define

begin_define
define|#
directive|define
name|RADEON_BENCHMARK_COMMON_MODES_N
value|17
end_define

begin_function
specifier|static
name|int
name|radeon_benchmark_do_move
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|unsigned
name|size
parameter_list|,
name|uint64_t
name|saddr
parameter_list|,
name|uint64_t
name|daddr
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|unsigned
name|long
name|start_jiffies
decl_stmt|;
name|unsigned
name|long
name|end_jiffies
decl_stmt|;
name|struct
name|radeon_fence
modifier|*
name|fence
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|r
decl_stmt|;
name|start_jiffies
operator|=
name|jiffies
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|flag
condition|)
block|{
case|case
name|RADEON_BENCHMARK_COPY_DMA
case|:
name|r
operator|=
name|radeon_copy_dma
argument_list|(
name|rdev
argument_list|,
name|saddr
argument_list|,
name|daddr
argument_list|,
name|size
operator|/
name|RADEON_GPU_PAGE_SIZE
argument_list|,
operator|&
name|fence
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_BENCHMARK_COPY_BLIT
case|:
name|r
operator|=
name|radeon_copy_blit
argument_list|(
name|rdev
argument_list|,
name|saddr
argument_list|,
name|daddr
argument_list|,
name|size
operator|/
name|RADEON_GPU_PAGE_SIZE
argument_list|,
operator|&
name|fence
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown copy method\n"
argument_list|)
expr_stmt|;
name|r
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
if|if
condition|(
name|r
condition|)
goto|goto
name|exit_do_move
goto|;
name|r
operator|=
name|radeon_fence_wait
argument_list|(
name|fence
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
goto|goto
name|exit_do_move
goto|;
name|radeon_fence_unref
argument_list|(
operator|&
name|fence
argument_list|)
expr_stmt|;
block|}
name|end_jiffies
operator|=
name|jiffies
expr_stmt|;
name|r
operator|=
name|jiffies_to_msecs
argument_list|(
name|end_jiffies
operator|-
name|start_jiffies
argument_list|)
expr_stmt|;
name|exit_do_move
label|:
if|if
condition|(
name|fence
condition|)
name|radeon_fence_unref
argument_list|(
operator|&
name|fence
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_benchmark_log_results
parameter_list|(
name|int
name|n
parameter_list|,
name|unsigned
name|size
parameter_list|,
name|unsigned
name|int
name|time
parameter_list|,
name|unsigned
name|sdomain
parameter_list|,
name|unsigned
name|ddomain
parameter_list|,
name|char
modifier|*
name|kind
parameter_list|)
block|{
name|unsigned
name|int
name|throughput
init|=
operator|(
name|n
operator|*
operator|(
name|size
operator|>>
literal|10
operator|)
operator|)
operator|/
name|time
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"radeon: %s %u bo moves of %u kB from"
literal|" %d to %d in %u ms, throughput: %u Mb/s or %u MB/s\n"
argument_list|,
name|kind
argument_list|,
name|n
argument_list|,
name|size
operator|>>
literal|10
argument_list|,
name|sdomain
argument_list|,
name|ddomain
argument_list|,
name|time
argument_list|,
name|throughput
operator|*
literal|8
argument_list|,
name|throughput
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_benchmark_move
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|unsigned
name|size
parameter_list|,
name|unsigned
name|sdomain
parameter_list|,
name|unsigned
name|ddomain
parameter_list|)
block|{
name|struct
name|radeon_bo
modifier|*
name|dobj
init|=
name|NULL
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|sobj
init|=
name|NULL
decl_stmt|;
name|uint64_t
name|saddr
decl_stmt|,
name|daddr
decl_stmt|;
name|int
name|r
decl_stmt|,
name|n
decl_stmt|;
name|int
name|time
decl_stmt|;
name|n
operator|=
name|RADEON_BENCHMARK_ITERATIONS
expr_stmt|;
name|r
operator|=
name|radeon_bo_create
argument_list|(
name|rdev
argument_list|,
name|size
argument_list|,
name|PAGE_SIZE
argument_list|,
name|true
argument_list|,
name|sdomain
argument_list|,
name|NULL
argument_list|,
operator|&
name|sobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
goto|goto
name|out_cleanup
goto|;
block|}
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|sobj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
goto|goto
name|out_cleanup
goto|;
name|r
operator|=
name|radeon_bo_pin
argument_list|(
name|sobj
argument_list|,
name|sdomain
argument_list|,
operator|&
name|saddr
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|sobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
goto|goto
name|out_cleanup
goto|;
block|}
name|r
operator|=
name|radeon_bo_create
argument_list|(
name|rdev
argument_list|,
name|size
argument_list|,
name|PAGE_SIZE
argument_list|,
name|true
argument_list|,
name|ddomain
argument_list|,
name|NULL
argument_list|,
operator|&
name|dobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
goto|goto
name|out_cleanup
goto|;
block|}
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|dobj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
goto|goto
name|out_cleanup
goto|;
name|r
operator|=
name|radeon_bo_pin
argument_list|(
name|dobj
argument_list|,
name|ddomain
argument_list|,
operator|&
name|daddr
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|dobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
goto|goto
name|out_cleanup
goto|;
block|}
comment|/* r100 doesn't have dma engine so skip the test */
comment|/* also, VRAM-to-VRAM test doesn't make much sense for DMA */
comment|/* skip it as well if domains are the same */
if|if
condition|(
operator|(
name|rdev
operator|->
name|asic
operator|->
name|copy
operator|.
name|dma
operator|)
operator|&&
operator|(
name|sdomain
operator|!=
name|ddomain
operator|)
condition|)
block|{
name|time
operator|=
name|radeon_benchmark_do_move
argument_list|(
name|rdev
argument_list|,
name|size
argument_list|,
name|saddr
argument_list|,
name|daddr
argument_list|,
name|RADEON_BENCHMARK_COPY_DMA
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|time
operator|<
literal|0
condition|)
goto|goto
name|out_cleanup
goto|;
if|if
condition|(
name|time
operator|>
literal|0
condition|)
name|radeon_benchmark_log_results
argument_list|(
name|n
argument_list|,
name|size
argument_list|,
name|time
argument_list|,
name|sdomain
argument_list|,
name|ddomain
argument_list|,
literal|"dma"
argument_list|)
expr_stmt|;
block|}
name|time
operator|=
name|radeon_benchmark_do_move
argument_list|(
name|rdev
argument_list|,
name|size
argument_list|,
name|saddr
argument_list|,
name|daddr
argument_list|,
name|RADEON_BENCHMARK_COPY_BLIT
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|time
operator|<
literal|0
condition|)
goto|goto
name|out_cleanup
goto|;
if|if
condition|(
name|time
operator|>
literal|0
condition|)
name|radeon_benchmark_log_results
argument_list|(
name|n
argument_list|,
name|size
argument_list|,
name|time
argument_list|,
name|sdomain
argument_list|,
name|ddomain
argument_list|,
literal|"blit"
argument_list|)
expr_stmt|;
name|out_cleanup
label|:
if|if
condition|(
name|sobj
condition|)
block|{
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|sobj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
name|r
operator|==
literal|0
argument_list|)
condition|)
block|{
name|radeon_bo_unpin
argument_list|(
name|sobj
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|sobj
argument_list|)
expr_stmt|;
block|}
name|radeon_bo_unref
argument_list|(
operator|&
name|sobj
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dobj
condition|)
block|{
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|dobj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
name|r
operator|==
literal|0
argument_list|)
condition|)
block|{
name|radeon_bo_unpin
argument_list|(
name|dobj
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|dobj
argument_list|)
expr_stmt|;
block|}
name|radeon_bo_unref
argument_list|(
operator|&
name|dobj
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Error while benchmarking BO move.\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|radeon_benchmark
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|test_number
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|common_modes
index|[
name|RADEON_BENCHMARK_COMMON_MODES_N
index|]
init|=
block|{
literal|640
operator|*
literal|480
operator|*
literal|4
block|,
literal|720
operator|*
literal|480
operator|*
literal|4
block|,
literal|800
operator|*
literal|600
operator|*
literal|4
block|,
literal|848
operator|*
literal|480
operator|*
literal|4
block|,
literal|1024
operator|*
literal|768
operator|*
literal|4
block|,
literal|1152
operator|*
literal|768
operator|*
literal|4
block|,
literal|1280
operator|*
literal|720
operator|*
literal|4
block|,
literal|1280
operator|*
literal|800
operator|*
literal|4
block|,
literal|1280
operator|*
literal|854
operator|*
literal|4
block|,
literal|1280
operator|*
literal|960
operator|*
literal|4
block|,
literal|1280
operator|*
literal|1024
operator|*
literal|4
block|,
literal|1440
operator|*
literal|900
operator|*
literal|4
block|,
literal|1400
operator|*
literal|1050
operator|*
literal|4
block|,
literal|1680
operator|*
literal|1050
operator|*
literal|4
block|,
literal|1600
operator|*
literal|1200
operator|*
literal|4
block|,
literal|1920
operator|*
literal|1080
operator|*
literal|4
block|,
literal|1920
operator|*
literal|1200
operator|*
literal|4
block|}
decl_stmt|;
switch|switch
condition|(
name|test_number
condition|)
block|{
case|case
literal|1
case|:
comment|/* simple test, VRAM to GTT and GTT to VRAM */
name|radeon_benchmark_move
argument_list|(
name|rdev
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|,
name|RADEON_GEM_DOMAIN_GTT
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|)
expr_stmt|;
name|radeon_benchmark_move
argument_list|(
name|rdev
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|RADEON_GEM_DOMAIN_GTT
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* simple test, VRAM to VRAM */
name|radeon_benchmark_move
argument_list|(
name|rdev
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* GTT to VRAM, buffer size sweep, powers of 2 */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|16384
condition|;
name|i
operator|<<=
literal|1
control|)
name|radeon_benchmark_move
argument_list|(
name|rdev
argument_list|,
name|i
operator|*
name|RADEON_GPU_PAGE_SIZE
argument_list|,
name|RADEON_GEM_DOMAIN_GTT
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* VRAM to GTT, buffer size sweep, powers of 2 */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|16384
condition|;
name|i
operator|<<=
literal|1
control|)
name|radeon_benchmark_move
argument_list|(
name|rdev
argument_list|,
name|i
operator|*
name|RADEON_GPU_PAGE_SIZE
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|RADEON_GEM_DOMAIN_GTT
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* VRAM to VRAM, buffer size sweep, powers of 2 */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|16384
condition|;
name|i
operator|<<=
literal|1
control|)
name|radeon_benchmark_move
argument_list|(
name|rdev
argument_list|,
name|i
operator|*
name|RADEON_GPU_PAGE_SIZE
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* GTT to VRAM, buffer size sweep, common modes */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_BENCHMARK_COMMON_MODES_N
condition|;
name|i
operator|++
control|)
name|radeon_benchmark_move
argument_list|(
name|rdev
argument_list|,
name|common_modes
index|[
name|i
index|]
argument_list|,
name|RADEON_GEM_DOMAIN_GTT
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* VRAM to GTT, buffer size sweep, common modes */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_BENCHMARK_COMMON_MODES_N
condition|;
name|i
operator|++
control|)
name|radeon_benchmark_move
argument_list|(
name|rdev
argument_list|,
name|common_modes
index|[
name|i
index|]
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|RADEON_GEM_DOMAIN_GTT
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* VRAM to VRAM, buffer size sweep, common modes */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_BENCHMARK_COMMON_MODES_N
condition|;
name|i
operator|++
control|)
name|radeon_benchmark_move
argument_list|(
name|rdev
argument_list|,
name|common_modes
index|[
name|i
index|]
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown benchmark\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


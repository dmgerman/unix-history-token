begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2010 Red Hat Inc.  * Author : Dave Airlie<airlied@redhat.com>  *  * Licensed under GPLv2  *  * ATPX support for both Intel/ATI  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/include/acpi.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon_acpi.h"
end_include

begin_include
include|#
directive|include
file|"radeon_drv.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
end_ifdef

begin_struct
struct|struct
name|radeon_atpx_functions
block|{
name|bool
name|px_params
decl_stmt|;
name|bool
name|power_cntl
decl_stmt|;
name|bool
name|disp_mux_cntl
decl_stmt|;
name|bool
name|i2c_mux_cntl
decl_stmt|;
name|bool
name|switch_start
decl_stmt|;
name|bool
name|switch_end
decl_stmt|;
name|bool
name|disp_connectors_mapping
decl_stmt|;
name|bool
name|disp_detetion_ports
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|radeon_atpx
block|{
name|ACPI_HANDLE
name|handle
decl_stmt|;
name|struct
name|radeon_atpx_functions
name|functions
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
specifier|static
struct|struct
name|radeon_atpx_priv
block|{
name|bool
name|atpx_detected
decl_stmt|;
comment|/* handle for device - and atpx */
name|ACPI_HANDLE
name|dhandle
decl_stmt|;
name|struct
name|radeon_atpx
name|atpx
decl_stmt|;
block|}
name|radeon_atpx_priv
struct|;
end_struct

begin_struct
struct|struct
name|atpx_verify_interface
block|{
name|u16
name|size
decl_stmt|;
comment|/* structure size in bytes (includes size field) */
name|u16
name|version
decl_stmt|;
comment|/* version */
name|u32
name|function_bits
decl_stmt|;
comment|/* supported functions bit vector */
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|atpx_power_control
block|{
name|u16
name|size
decl_stmt|;
name|u8
name|dgpu_state
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|atpx_mux
block|{
name|u16
name|size
decl_stmt|;
name|u16
name|mux
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/**  * radeon_atpx_call - call an ATPX method  *  * @handle: acpi handle  * @function: the ATPX function to execute  * @params: ATPX function params  *  * Executes the requested ATPX function (all asics).  * Returns a pointer to the acpi output buffer.  */
end_comment

begin_function
specifier|static
name|ACPI_OBJECT
modifier|*
name|radeon_atpx_call
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|int
name|function
parameter_list|,
name|ACPI_BUFFER
modifier|*
name|params
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_OBJECT
name|atpx_arg_elements
index|[
literal|2
index|]
decl_stmt|;
name|ACPI_OBJECT_LIST
name|atpx_arg
decl_stmt|;
name|ACPI_BUFFER
name|buffer
init|=
block|{
name|ACPI_ALLOCATE_BUFFER
block|,
name|NULL
block|}
decl_stmt|;
name|atpx_arg
operator|.
name|Count
operator|=
literal|2
expr_stmt|;
name|atpx_arg
operator|.
name|Pointer
operator|=
operator|&
name|atpx_arg_elements
index|[
literal|0
index|]
expr_stmt|;
name|atpx_arg_elements
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|atpx_arg_elements
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|function
expr_stmt|;
if|if
condition|(
name|params
condition|)
block|{
name|atpx_arg_elements
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_BUFFER
expr_stmt|;
name|atpx_arg_elements
index|[
literal|1
index|]
operator|.
name|Buffer
operator|.
name|Length
operator|=
name|params
operator|->
name|Length
expr_stmt|;
name|atpx_arg_elements
index|[
literal|1
index|]
operator|.
name|Buffer
operator|.
name|Pointer
operator|=
name|params
operator|->
name|Pointer
expr_stmt|;
block|}
else|else
block|{
comment|/* We need a second fake parameter */
name|atpx_arg_elements
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|atpx_arg_elements
index|[
literal|1
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0
expr_stmt|;
block|}
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|handle
argument_list|,
name|NULL
argument_list|,
operator|&
name|atpx_arg
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
comment|/* Fail only if calling the method fails and ATPX is supported */
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
operator|&&
name|status
operator|!=
name|AE_NOT_FOUND
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to evaluate ATPX got %s\n"
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|buffer
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|buffer
operator|.
name|Pointer
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_parse_functions - parse supported functions  *  * @f: supported functions struct  * @mask: supported functions mask from ATPX  *  * Use the supported functions mask from ATPX function  * ATPX_FUNCTION_VERIFY_INTERFACE to determine what functions  * are supported (all asics).  */
end_comment

begin_function
specifier|static
name|void
name|radeon_atpx_parse_functions
parameter_list|(
name|struct
name|radeon_atpx_functions
modifier|*
name|f
parameter_list|,
name|u32
name|mask
parameter_list|)
block|{
name|f
operator|->
name|px_params
operator|=
name|mask
operator|&
name|ATPX_GET_PX_PARAMETERS_SUPPORTED
expr_stmt|;
name|f
operator|->
name|power_cntl
operator|=
name|mask
operator|&
name|ATPX_POWER_CONTROL_SUPPORTED
expr_stmt|;
name|f
operator|->
name|disp_mux_cntl
operator|=
name|mask
operator|&
name|ATPX_DISPLAY_MUX_CONTROL_SUPPORTED
expr_stmt|;
name|f
operator|->
name|i2c_mux_cntl
operator|=
name|mask
operator|&
name|ATPX_I2C_MUX_CONTROL_SUPPORTED
expr_stmt|;
name|f
operator|->
name|switch_start
operator|=
name|mask
operator|&
name|ATPX_GRAPHICS_DEVICE_SWITCH_START_NOTIFICATION_SUPPORTED
expr_stmt|;
name|f
operator|->
name|switch_end
operator|=
name|mask
operator|&
name|ATPX_GRAPHICS_DEVICE_SWITCH_END_NOTIFICATION_SUPPORTED
expr_stmt|;
name|f
operator|->
name|disp_connectors_mapping
operator|=
name|mask
operator|&
name|ATPX_GET_DISPLAY_CONNECTORS_MAPPING_SUPPORTED
expr_stmt|;
name|f
operator|->
name|disp_detetion_ports
operator|=
name|mask
operator|&
name|ATPX_GET_DISPLAY_DETECTION_PORTS_SUPPORTED
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_verify_interface - verify ATPX  *  * @handle: acpi handle  * @atpx: radeon atpx struct  *  * Execute the ATPX_FUNCTION_VERIFY_INTERFACE ATPX function  * to initialize ATPX and determine what features are supported  * (all asics).  * returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atpx_verify_interface
parameter_list|(
name|struct
name|radeon_atpx
modifier|*
name|atpx
parameter_list|)
block|{
name|ACPI_OBJECT
modifier|*
name|info
decl_stmt|;
name|struct
name|atpx_verify_interface
name|output
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|info
operator|=
name|radeon_atpx_call
argument_list|(
name|atpx
operator|->
name|handle
argument_list|,
name|ATPX_FUNCTION_VERIFY_INTERFACE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
condition|)
return|return
operator|-
name|EIO
return|;
name|memset
argument_list|(
operator|&
name|output
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|output
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
operator|*
operator|(
name|u16
operator|*
operator|)
name|info
operator|->
name|Buffer
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
name|size
operator|<
literal|8
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ATPX buffer is too small: %zu\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|size
operator|=
name|min
argument_list|(
sizeof|sizeof
argument_list|(
name|output
argument_list|)
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|output
argument_list|,
name|info
operator|->
name|Buffer
operator|.
name|Pointer
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* TODO: check version? */
name|DRM_INFO
argument_list|(
literal|"ATPX version %u\n"
argument_list|,
name|output
operator|.
name|version
argument_list|)
expr_stmt|;
name|radeon_atpx_parse_functions
argument_list|(
operator|&
name|atpx
operator|->
name|functions
argument_list|,
name|output
operator|.
name|function_bits
argument_list|)
expr_stmt|;
name|out
label|:
name|AcpiOsFree
argument_list|(
name|info
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_set_discrete_state - power up/down discrete GPU  *  * @atpx: atpx info struct  * @state: discrete GPU state (0 = power down, 1 = power up)  *  * Execute the ATPX_FUNCTION_POWER_CONTROL ATPX function to  * power down/up the discrete GPU (all asics).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atpx_set_discrete_state
parameter_list|(
name|struct
name|radeon_atpx
modifier|*
name|atpx
parameter_list|,
name|u8
name|state
parameter_list|)
block|{
name|ACPI_BUFFER
name|params
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|info
decl_stmt|;
name|struct
name|atpx_power_control
name|input
decl_stmt|;
if|if
condition|(
name|atpx
operator|->
name|functions
operator|.
name|power_cntl
condition|)
block|{
name|input
operator|.
name|size
operator|=
literal|3
expr_stmt|;
name|input
operator|.
name|dgpu_state
operator|=
name|state
expr_stmt|;
name|params
operator|.
name|Length
operator|=
name|input
operator|.
name|size
expr_stmt|;
name|params
operator|.
name|Pointer
operator|=
operator|&
name|input
expr_stmt|;
name|info
operator|=
name|radeon_atpx_call
argument_list|(
name|atpx
operator|->
name|handle
argument_list|,
name|ATPX_FUNCTION_POWER_CONTROL
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
condition|)
return|return
operator|-
name|EIO
return|;
name|AcpiOsFree
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_switch_disp_mux - switch display mux  *  * @atpx: atpx info struct  * @mux_id: mux state (0 = integrated GPU, 1 = discrete GPU)  *  * Execute the ATPX_FUNCTION_DISPLAY_MUX_CONTROL ATPX function to  * switch the display mux between the discrete GPU and integrated GPU  * (all asics).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atpx_switch_disp_mux
parameter_list|(
name|struct
name|radeon_atpx
modifier|*
name|atpx
parameter_list|,
name|u16
name|mux_id
parameter_list|)
block|{
name|ACPI_BUFFER
name|params
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|info
decl_stmt|;
name|struct
name|atpx_mux
name|input
decl_stmt|;
if|if
condition|(
name|atpx
operator|->
name|functions
operator|.
name|disp_mux_cntl
condition|)
block|{
name|input
operator|.
name|size
operator|=
literal|4
expr_stmt|;
name|input
operator|.
name|mux
operator|=
name|mux_id
expr_stmt|;
name|params
operator|.
name|Length
operator|=
name|input
operator|.
name|size
expr_stmt|;
name|params
operator|.
name|Pointer
operator|=
operator|&
name|input
expr_stmt|;
name|info
operator|=
name|radeon_atpx_call
argument_list|(
name|atpx
operator|->
name|handle
argument_list|,
name|ATPX_FUNCTION_DISPLAY_MUX_CONTROL
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
condition|)
return|return
operator|-
name|EIO
return|;
name|AcpiOsFree
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_switch_i2c_mux - switch i2c/hpd mux  *  * @atpx: atpx info struct  * @mux_id: mux state (0 = integrated GPU, 1 = discrete GPU)  *  * Execute the ATPX_FUNCTION_I2C_MUX_CONTROL ATPX function to  * switch the i2c/hpd mux between the discrete GPU and integrated GPU  * (all asics).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atpx_switch_i2c_mux
parameter_list|(
name|struct
name|radeon_atpx
modifier|*
name|atpx
parameter_list|,
name|u16
name|mux_id
parameter_list|)
block|{
name|ACPI_BUFFER
name|params
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|info
decl_stmt|;
name|struct
name|atpx_mux
name|input
decl_stmt|;
if|if
condition|(
name|atpx
operator|->
name|functions
operator|.
name|i2c_mux_cntl
condition|)
block|{
name|input
operator|.
name|size
operator|=
literal|4
expr_stmt|;
name|input
operator|.
name|mux
operator|=
name|mux_id
expr_stmt|;
name|params
operator|.
name|Length
operator|=
name|input
operator|.
name|size
expr_stmt|;
name|params
operator|.
name|Pointer
operator|=
operator|&
name|input
expr_stmt|;
name|info
operator|=
name|radeon_atpx_call
argument_list|(
name|atpx
operator|->
name|handle
argument_list|,
name|ATPX_FUNCTION_I2C_MUX_CONTROL
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
condition|)
return|return
operator|-
name|EIO
return|;
name|AcpiOsFree
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_switch_start - notify the sbios of a GPU switch  *  * @atpx: atpx info struct  * @mux_id: mux state (0 = integrated GPU, 1 = discrete GPU)  *  * Execute the ATPX_FUNCTION_GRAPHICS_DEVICE_SWITCH_START_NOTIFICATION ATPX  * function to notify the sbios that a switch between the discrete GPU and  * integrated GPU has begun (all asics).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atpx_switch_start
parameter_list|(
name|struct
name|radeon_atpx
modifier|*
name|atpx
parameter_list|,
name|u16
name|mux_id
parameter_list|)
block|{
name|ACPI_BUFFER
name|params
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|info
decl_stmt|;
name|struct
name|atpx_mux
name|input
decl_stmt|;
if|if
condition|(
name|atpx
operator|->
name|functions
operator|.
name|switch_start
condition|)
block|{
name|input
operator|.
name|size
operator|=
literal|4
expr_stmt|;
name|input
operator|.
name|mux
operator|=
name|mux_id
expr_stmt|;
name|params
operator|.
name|Length
operator|=
name|input
operator|.
name|size
expr_stmt|;
name|params
operator|.
name|Pointer
operator|=
operator|&
name|input
expr_stmt|;
name|info
operator|=
name|radeon_atpx_call
argument_list|(
name|atpx
operator|->
name|handle
argument_list|,
name|ATPX_FUNCTION_GRAPHICS_DEVICE_SWITCH_START_NOTIFICATION
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
condition|)
return|return
operator|-
name|EIO
return|;
name|AcpiOsFree
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_switch_end - notify the sbios of a GPU switch  *  * @atpx: atpx info struct  * @mux_id: mux state (0 = integrated GPU, 1 = discrete GPU)  *  * Execute the ATPX_FUNCTION_GRAPHICS_DEVICE_SWITCH_END_NOTIFICATION ATPX  * function to notify the sbios that a switch between the discrete GPU and  * integrated GPU has ended (all asics).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atpx_switch_end
parameter_list|(
name|struct
name|radeon_atpx
modifier|*
name|atpx
parameter_list|,
name|u16
name|mux_id
parameter_list|)
block|{
name|ACPI_BUFFER
name|params
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|info
decl_stmt|;
name|struct
name|atpx_mux
name|input
decl_stmt|;
if|if
condition|(
name|atpx
operator|->
name|functions
operator|.
name|switch_end
condition|)
block|{
name|input
operator|.
name|size
operator|=
literal|4
expr_stmt|;
name|input
operator|.
name|mux
operator|=
name|mux_id
expr_stmt|;
name|params
operator|.
name|Length
operator|=
name|input
operator|.
name|size
expr_stmt|;
name|params
operator|.
name|Pointer
operator|=
operator|&
name|input
expr_stmt|;
name|info
operator|=
name|radeon_atpx_call
argument_list|(
name|atpx
operator|->
name|handle
argument_list|,
name|ATPX_FUNCTION_GRAPHICS_DEVICE_SWITCH_END_NOTIFICATION
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
condition|)
return|return
operator|-
name|EIO
return|;
name|AcpiOsFree
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_switchto - switch to the requested GPU  *  * @id: GPU to switch to  *  * Execute the necessary ATPX functions to switch between the discrete GPU and  * integrated GPU (all asics).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atpx_switchto
parameter_list|(
name|enum
name|vga_switcheroo_client_id
name|id
parameter_list|)
block|{
name|u16
name|gpu_id
decl_stmt|;
if|if
condition|(
name|id
operator|==
name|VGA_SWITCHEROO_IGD
condition|)
name|gpu_id
operator|=
name|ATPX_INTEGRATED_GPU
expr_stmt|;
else|else
name|gpu_id
operator|=
name|ATPX_DISCRETE_GPU
expr_stmt|;
name|radeon_atpx_switch_start
argument_list|(
operator|&
name|radeon_atpx_priv
operator|.
name|atpx
argument_list|,
name|gpu_id
argument_list|)
expr_stmt|;
name|radeon_atpx_switch_disp_mux
argument_list|(
operator|&
name|radeon_atpx_priv
operator|.
name|atpx
argument_list|,
name|gpu_id
argument_list|)
expr_stmt|;
name|radeon_atpx_switch_i2c_mux
argument_list|(
operator|&
name|radeon_atpx_priv
operator|.
name|atpx
argument_list|,
name|gpu_id
argument_list|)
expr_stmt|;
name|radeon_atpx_switch_end
argument_list|(
operator|&
name|radeon_atpx_priv
operator|.
name|atpx
argument_list|,
name|gpu_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_power_state - power down/up the requested GPU  *  * @id: GPU to power down/up  * @state: requested power state (0 = off, 1 = on)  *  * Execute the necessary ATPX function to power down/up the discrete GPU  * (all asics).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atpx_power_state
parameter_list|(
name|enum
name|vga_switcheroo_client_id
name|id
parameter_list|,
name|enum
name|vga_switcheroo_state
name|state
parameter_list|)
block|{
comment|/* on w500 ACPI can't change intel gpu state */
if|if
condition|(
name|id
operator|==
name|VGA_SWITCHEROO_IGD
condition|)
return|return
literal|0
return|;
name|radeon_atpx_set_discrete_state
argument_list|(
operator|&
name|radeon_atpx_priv
operator|.
name|atpx
argument_list|,
name|state
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_pci_probe_handle - look up the ATPX handle  *  * @pdev: pci device  *  * Look up the ATPX handles (all asics).  * Returns true if the handles are found, false if not.  */
end_comment

begin_function
specifier|static
name|bool
name|radeon_atpx_pci_probe_handle
parameter_list|(
name|struct
name|pci_dev
modifier|*
name|pdev
parameter_list|)
block|{
name|ACPI_HANDLE
name|dhandle
decl_stmt|,
name|atpx_handle
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|dhandle
operator|=
name|DEVICE_ACPI_HANDLE
argument_list|(
operator|&
name|pdev
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dhandle
condition|)
return|return
name|false
return|;
name|status
operator|=
name|AcpiGetHandle
argument_list|(
name|dhandle
argument_list|,
literal|"ATPX"
argument_list|,
operator|&
name|atpx_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
return|return
name|false
return|;
name|radeon_atpx_priv
operator|.
name|dhandle
operator|=
name|dhandle
expr_stmt|;
name|radeon_atpx_priv
operator|.
name|atpx
operator|.
name|handle
operator|=
name|atpx_handle
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_init - verify the ATPX interface  *  * Verify the ATPX interface (all asics).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atpx_init
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* set up the ATPX handle */
return|return
name|radeon_atpx_verify_interface
argument_list|(
operator|&
name|radeon_atpx_priv
operator|.
name|atpx
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atpx_get_client_id - get the client id  *  * @pdev: pci device  *  * look up whether we are the integrated or discrete GPU (all asics).  * Returns the client id.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atpx_get_client_id
parameter_list|(
name|struct
name|pci_dev
modifier|*
name|pdev
parameter_list|)
block|{
if|if
condition|(
name|radeon_atpx_priv
operator|.
name|dhandle
operator|==
name|DEVICE_ACPI_HANDLE
argument_list|(
operator|&
name|pdev
operator|->
name|dev
argument_list|)
condition|)
return|return
name|VGA_SWITCHEROO_IGD
return|;
else|else
return|return
name|VGA_SWITCHEROO_DIS
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|vga_switcheroo_handler
name|radeon_atpx_handler
init|=
block|{
operator|.
name|switchto
operator|=
name|radeon_atpx_switchto
block|,
operator|.
name|power_state
operator|=
name|radeon_atpx_power_state
block|,
operator|.
name|init
operator|=
name|radeon_atpx_init
block|,
operator|.
name|get_client_id
operator|=
name|radeon_atpx_get_client_id
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * radeon_atpx_detect - detect whether we have PX  *  * Check if we have a PX system (all asics).  * Returns true if we have a PX system, false if not.  */
end_comment

begin_function
specifier|static
name|bool
name|radeon_atpx_detect
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|acpi_method_name
index|[
literal|255
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ACPI_BUFFER
name|buffer
init|=
block|{
sizeof|sizeof
argument_list|(
name|acpi_method_name
argument_list|)
block|,
name|acpi_method_name
block|}
decl_stmt|;
name|struct
name|pci_dev
modifier|*
name|pdev
init|=
name|NULL
decl_stmt|;
name|bool
name|has_atpx
init|=
name|false
decl_stmt|;
name|int
name|vga_count
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|pdev
operator|=
name|pci_get_class
argument_list|(
name|PCI_CLASS_DISPLAY_VGA
operator|<<
literal|8
argument_list|,
name|pdev
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|vga_count
operator|++
expr_stmt|;
name|has_atpx
operator||=
operator|(
name|radeon_atpx_pci_probe_handle
argument_list|(
name|pdev
argument_list|)
operator|==
name|true
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|has_atpx
operator|&&
name|vga_count
operator|==
literal|2
condition|)
block|{
name|AcpiGetName
argument_list|(
name|radeon_atpx_priv
operator|.
name|atpx
operator|.
name|handle
argument_list|,
name|ACPI_FULL_PATHNAME
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"VGA switcheroo: detected switching method %s handle\n"
argument_list|,
name|acpi_method_name
argument_list|)
expr_stmt|;
name|radeon_atpx_priv
operator|.
name|atpx_detected
operator|=
name|true
expr_stmt|;
return|return
name|true
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DUMBBELL_WIP */
end_comment

begin_comment
comment|/**  * radeon_register_atpx_handler - register with vga_switcheroo  *  * Register the PX callbacks with vga_switcheroo (all asics).  */
end_comment

begin_function
name|void
name|radeon_register_atpx_handler
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
name|bool
name|r
decl_stmt|;
comment|/* detect if we have any ATPX + 2 VGA in the system */
name|r
operator|=
name|radeon_atpx_detect
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
return|return;
name|vga_switcheroo_register_handler
argument_list|(
operator|&
name|radeon_atpx_handler
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
block|}
end_function

begin_comment
comment|/**  * radeon_unregister_atpx_handler - unregister with vga_switcheroo  *  * Unregister the PX callbacks with vga_switcheroo (all asics).  */
end_comment

begin_function
name|void
name|radeon_unregister_atpx_handler
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
name|vga_switcheroo_unregister_handler
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
block|}
end_function

end_unit


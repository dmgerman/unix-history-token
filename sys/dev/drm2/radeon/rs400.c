begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"rs400d.h"
end_include

begin_comment
comment|/* This files gather functions specifics to : rs400,rs480 */
end_comment

begin_function_decl
specifier|static
name|int
name|rs400_debugfs_pcie_gart_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|rs400_gart_adjust_size
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* Check gart size */
switch|switch
condition|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
condition|)
block|{
case|case
literal|32
case|:
case|case
literal|64
case|:
case|case
literal|128
case|:
case|case
literal|256
case|:
case|case
literal|512
case|:
case|case
literal|1024
case|:
case|case
literal|2048
case|:
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unable to use IGP GART size %uM\n"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"Valid GART size for IGP are 32M,64M,128M,256M,512M,1G,2G\n"
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"Forcing to 32M GART size\n"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|=
literal|32
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
name|void
name|rs400_gart_tlb_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|unsigned
name|int
name|timeout
init|=
name|rdev
operator|->
name|usec_timeout
decl_stmt|;
name|WREG32_MC
argument_list|(
name|RS480_GART_CACHE_CNTRL
argument_list|,
name|RS480_GART_CACHE_INVALIDATE
argument_list|)
expr_stmt|;
do|do
block|{
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS480_GART_CACHE_CNTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
name|RS480_GART_CACHE_INVALIDATE
operator|)
operator|==
literal|0
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|timeout
operator|--
expr_stmt|;
block|}
do|while
condition|(
name|timeout
operator|>
literal|0
condition|)
do|;
name|WREG32_MC
argument_list|(
name|RS480_GART_CACHE_CNTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rs400_gart_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|ptr
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"RS400 GART already initialized\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Check gart size */
switch|switch
condition|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
condition|)
block|{
case|case
literal|32
case|:
case|case
literal|64
case|:
case|case
literal|128
case|:
case|case
literal|256
case|:
case|case
literal|512
case|:
case|case
literal|1024
case|:
case|case
literal|2048
case|:
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Initialize common gart structure */
name|r
operator|=
name|radeon_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
if|if
condition|(
name|rs400_debugfs_pcie_gart_info_init
argument_list|(
name|rdev
argument_list|)
condition|)
name|DRM_ERROR
argument_list|(
literal|"Failed to register debugfs file for RS400 GART !\n"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|table_size
operator|=
name|rdev
operator|->
name|gart
operator|.
name|num_gpu_pages
operator|*
literal|4
expr_stmt|;
return|return
name|radeon_gart_table_ram_alloc
argument_list|(
name|rdev
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|rs400_gart_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|size_reg
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|radeon_gart_restore
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS690_AIC_CTRL_SCRATCH
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|RS690_DIS_OUT_OF_PCI_GART_ACCESS
expr_stmt|;
name|WREG32_MC
argument_list|(
name|RS690_AIC_CTRL_SCRATCH
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Check gart size */
switch|switch
condition|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
condition|)
block|{
case|case
literal|32
case|:
name|size_reg
operator|=
name|RS480_VA_SIZE_32MB
expr_stmt|;
break|break;
case|case
literal|64
case|:
name|size_reg
operator|=
name|RS480_VA_SIZE_64MB
expr_stmt|;
break|break;
case|case
literal|128
case|:
name|size_reg
operator|=
name|RS480_VA_SIZE_128MB
expr_stmt|;
break|break;
case|case
literal|256
case|:
name|size_reg
operator|=
name|RS480_VA_SIZE_256MB
expr_stmt|;
break|break;
case|case
literal|512
case|:
name|size_reg
operator|=
name|RS480_VA_SIZE_512MB
expr_stmt|;
break|break;
case|case
literal|1024
case|:
name|size_reg
operator|=
name|RS480_VA_SIZE_1GB
expr_stmt|;
break|break;
case|case
literal|2048
case|:
name|size_reg
operator|=
name|RS480_VA_SIZE_2GB
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* It should be fine to program it to max value */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS690
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS740
operator|)
condition|)
block|{
name|WREG32_MC
argument_list|(
name|RS690_MCCFG_AGP_BASE
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|RS690_MCCFG_AGP_BASE_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|RADEON_AGP_BASE
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RS480_AGP_BASE_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|tmp
operator|=
name|REG_SET
argument_list|(
name|RS690_MC_AGP_TOP
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|REG_SET
argument_list|(
name|RS690_MC_AGP_START
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS740
operator|)
condition|)
block|{
name|WREG32_MC
argument_list|(
name|RS690_MCCFG_AGP_LOCATION
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
operator|&
operator|~
name|RS600_BUS_MASTER_DIS
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|RADEON_MC_AGP_LOCATION
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
operator|&
operator|~
name|RADEON_BUS_MASTER_DIS
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
comment|/* Table should be in 32bits address space so ignore bits above. */
name|tmp
operator|=
operator|(
name|u32
operator|)
name|rdev
operator|->
name|gart
operator|.
name|table_addr
operator|&
literal|0xfffff000
expr_stmt|;
name|tmp
operator||=
operator|(
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
operator|&
literal|0xff
operator|)
operator|<<
literal|4
expr_stmt|;
name|WREG32_MC
argument_list|(
name|RS480_GART_BASE
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* TODO: more tweaking here */
name|WREG32_MC
argument_list|(
name|RS480_GART_FEATURE_ID
argument_list|,
operator|(
name|RS480_TLB_ENABLE
operator||
name|RS480_GTW_LAC_EN
operator||
name|RS480_1LEVEL_GART
operator|)
argument_list|)
expr_stmt|;
comment|/* Disable snooping */
name|WREG32_MC
argument_list|(
name|RS480_AGP_MODE_CNTL
argument_list|,
operator|(
literal|1
operator|<<
name|RS480_REQ_TYPE_SNOOP_SHIFT
operator|)
operator||
name|RS480_REQ_TYPE_SNOOP_DIS
argument_list|)
expr_stmt|;
comment|/* Disable AGP mode */
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS740
operator|)
condition|)
block|{
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS690_MC_NB_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RS690_HIDE_MMCFG_BAR
operator||
name|RS690_AGPMODE30
operator||
name|RS690_AGP30ENHANCED
operator|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|RS690_MC_NB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|RS480_MC_MISC_CNTL
argument_list|,
operator|(
name|RS480_GART_INDEX_REG_EN
operator||
name|RS690_BLOCK_GFX_D3_EN
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32_MC
argument_list|(
name|RS480_MC_MISC_CNTL
argument_list|,
name|RS480_GART_INDEX_REG_EN
argument_list|)
expr_stmt|;
block|}
comment|/* Enable gart */
name|WREG32_MC
argument_list|(
name|RS480_AGP_ADDRESS_SPACE_SIZE
argument_list|,
operator|(
name|RS480_GART_EN
operator||
name|size_reg
operator|)
argument_list|)
expr_stmt|;
name|rs400_gart_tlb_flush
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"PCIE GART of %uM enabled (table at 0x%016llX).\n"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|ready
operator|=
name|true
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|rs400_gart_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS690_AIC_CTRL_SCRATCH
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|RS690_DIS_OUT_OF_PCI_GART_ACCESS
expr_stmt|;
name|WREG32_MC
argument_list|(
name|RS690_AIC_CTRL_SCRATCH
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|RS480_AGP_ADDRESS_SPACE_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rs400_gart_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|radeon_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs400_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_table_ram_free
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|RS400_PTE_WRITEABLE
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|RS400_PTE_READABLE
value|(1<< 3)
end_define

begin_function
name|int
name|rs400_gart_set_page
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|i
parameter_list|,
name|uint64_t
name|addr
parameter_list|)
block|{
name|uint32_t
name|entry
decl_stmt|;
name|u32
modifier|*
name|gtt
init|=
name|rdev
operator|->
name|gart
operator|.
name|ptr
decl_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
operator|||
name|i
operator|>
name|rdev
operator|->
name|gart
operator|.
name|num_gpu_pages
condition|)
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
name|entry
operator|=
operator|(
name|lower_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xfffff000
operator|)
operator||
operator|(
operator|(
name|upper_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xff
operator|)
operator|<<
literal|4
operator|)
operator||
name|RS400_PTE_WRITEABLE
operator||
name|RS400_PTE_READABLE
expr_stmt|;
name|entry
operator|=
name|cpu_to_le32
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|gtt
index|[
name|i
index|]
operator|=
name|entry
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rs400_mc_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
comment|/* read MC_STATUS */
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MC_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_MC_IDLE
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs400_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* FIXME: is this correct ? */
name|r420_pipes_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs400_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"rs400: Failed to wait MC idle while "
literal|"programming pipes. Bad things might happen. %08x\n"
argument_list|,
name|RREG32
argument_list|(
name|RADEON_MC_STATUS
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rs400_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u64
name|base
decl_stmt|;
name|rs400_gart_adjust_size
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|igp_sideport_enabled
operator|=
name|radeon_combios_sideport_present
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* DDR for all card after R300& IGP */
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
name|r100_vram_init_sizes
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|base
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_NB_TOM
argument_list|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
expr_stmt|;
name|radeon_vram_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_base_align
operator|=
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|-
literal|1
expr_stmt|;
name|radeon_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|rs400_mc_rreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|)
block|{
name|uint32_t
name|r
decl_stmt|;
name|WREG32
argument_list|(
name|RS480_NB_MC_INDEX
argument_list|,
name|reg
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|r
operator|=
name|RREG32
argument_list|(
name|RS480_NB_MC_DATA
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RS480_NB_MC_INDEX
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|rs400_mc_wreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|v
parameter_list|)
block|{
name|WREG32
argument_list|(
name|RS480_NB_MC_INDEX
argument_list|,
operator|(
operator|(
name|reg
operator|)
operator|&
literal|0xff
operator|)
operator||
name|RS480_NB_MC_IND_WR_EN
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RS480_NB_MC_DATA
argument_list|,
operator|(
name|v
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RS480_NB_MC_INDEX
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
end_if

begin_function
specifier|static
name|int
name|rs400_debugfs_gart_info
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_info_node
modifier|*
name|node
init|=
operator|(
expr|struct
name|drm_info_node
operator|*
operator|)
name|m
operator|->
name|private
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|node
operator|->
name|minor
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"HOST_PATH_CNTL 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"BUS_CNTL 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS690_AIC_CTRL_SCRATCH
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"AIC_CTRL_SCRATCH 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS690
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS740
operator|)
condition|)
block|{
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS690_MCCFG_AGP_BASE
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MCCFG_AGP_BASE 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS690_MCCFG_AGP_BASE_2
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MCCFG_AGP_BASE_2 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS690_MCCFG_AGP_LOCATION
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MCCFG_AGP_LOCATION 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS690_MCCFG_FB_LOCATION
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MCCFG_FB_LOCATION 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RS690_HDP_FB_LOCATION
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"HDP_FB_LOCATION 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_AGP_BASE
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"AGP_BASE 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RS480_AGP_BASE_2
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"AGP_BASE_2 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MC_AGP_LOCATION
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MC_AGP_LOCATION 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS480_GART_BASE
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_BASE 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS480_GART_FEATURE_ID
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_FEATURE_ID 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS480_AGP_MODE_CNTL
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"AGP_MODE_CONTROL 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS480_MC_MISC_CNTL
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MC_MISC_CNTL 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x5F
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MC_MISC_UMA_CNTL 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS480_AGP_ADDRESS_SPACE_SIZE
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"AGP_ADDRESS_SPACE_SIZE 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RS480_GART_CACHE_CNTRL
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_CACHE_CNTRL 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x3B
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MC_GART_ERROR_ADDRESS 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x3C
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MC_GART_ERROR_ADDRESS_HI 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x30
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_ERROR_0 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x31
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_ERROR_1 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x32
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_ERROR_2 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x33
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_ERROR_3 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x34
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_ERROR_4 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x35
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_ERROR_5 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x36
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_ERROR_6 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
literal|0x37
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GART_ERROR_7 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|drm_info_list
name|rs400_gart_info_list
index|[]
init|=
block|{
block|{
literal|"rs400_gart_info"
block|,
name|rs400_debugfs_gart_info
block|,
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|rs400_debugfs_pcie_gart_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
return|return
name|radeon_debugfs_add_files
argument_list|(
name|rdev
argument_list|,
name|rs400_gart_info_list
argument_list|,
literal|1
argument_list|)
return|;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|rs400_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|r100_mc_save
name|save
decl_stmt|;
comment|/* Stops all mc clients */
name|r100_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
comment|/* Wait for mc idle */
if|if
condition|(
name|rs400_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"rs400: Wait MC idle timeout before updating MC.\n"
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000148_MC_FB_LOCATION
argument_list|,
name|S_000148_MC_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
operator||
name|S_000148_MC_FB_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|r100_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs400_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|r100_set_common_regs
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs400_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock */
name|r300_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GPU configuration (# pipes, ...) */
name|rs400_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_enable_bm
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GART (initialize after TTM so we can allocate 	 * memory through TTM but finalize after TTM) */
name|r
operator|=
name|rs400_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|r100_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|hdp_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
comment|/* 1M ring buffer */
name|r
operator|=
name|r100_cp_init
argument_list|(
name|rdev
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rs400_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Make sur GART are not working */
name|rs400_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock before doing reset */
name|r300_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* setup MC before calling post tables */
name|rs400_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* post */
name|radeon_combios_asic_init
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* Resume clock after posting */
name|r300_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|rs400_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|rs400_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r100_cp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_irq_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs400_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|rs400_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs400_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rs400_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Disable VGA */
name|r100_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize scratch registers */
name|radeon_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* TODO: disable VGA need to use VGA request */
comment|/* restore some register to sane defaults */
name|r100_restore_sanity
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* BIOS*/
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting combios for RS400/RS480 GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
name|r
operator|=
name|radeon_combios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* check if cards are posted or not */
if|if
condition|(
name|radeon_boot_test_post_card
argument_list|(
name|rdev
argument_list|)
operator|==
name|false
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* initialize memory controller */
name|rs400_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|rs400_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r300_set_reg_safe
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|rs400_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
comment|/* Somethings want wront with the accel init stop accel */
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs400_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


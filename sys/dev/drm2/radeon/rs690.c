begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"rs690d.h"
end_include

begin_function
name|int
name|rs690_mc_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
comment|/* read MC_STATUS */
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R_000090_MC_SYSTEM_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|G_000090_MC_SYSTEM_IDLE
argument_list|(
name|tmp
argument_list|)
condition|)
return|return
literal|0
return|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs690_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* FIXME: is this correct ? */
name|r420_pipes_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs690_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to wait MC idle while "
literal|"programming pipes. Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_union
union|union
name|igp_info
block|{
name|struct
name|_ATOM_INTEGRATED_SYSTEM_INFO
name|info
decl_stmt|;
name|struct
name|_ATOM_INTEGRATED_SYSTEM_INFO_V2
name|info_v2
decl_stmt|;
block|}
union|;
end_union

begin_function
name|void
name|rs690_pm_info
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|IntegratedSystemInfo
argument_list|)
decl_stmt|;
name|union
name|igp_info
modifier|*
name|info
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|fixed20_12
name|tmp
decl_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|info
operator|=
operator|(
expr|union
name|igp_info
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
comment|/* Get various system informations from bios */
switch|switch
condition|(
name|crev
condition|)
block|{
case|case
literal|1
case|:
name|tmp
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_sideport_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|le32_to_cpu
argument_list|(
name|info
operator|->
name|info
operator|.
name|ulBootUpMemoryClock
argument_list|)
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_sideport_mclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|igp_sideport_mclk
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|le16_to_cpu
argument_list|(
name|info
operator|->
name|info
operator|.
name|usK8MemoryClock
argument_list|)
condition|)
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|le16_to_cpu
argument_list|(
name|info
operator|->
name|info
operator|.
name|usK8MemoryClock
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|400
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_clk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|le16_to_cpu
argument_list|(
name|info
operator|->
name|info
operator|.
name|usFSBClock
argument_list|)
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_width
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|info
operator|->
name|info
operator|.
name|ucHTLinkWidth
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tmp
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_sideport_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|le32_to_cpu
argument_list|(
name|info
operator|->
name|info_v2
operator|.
name|ulBootUpSidePortClock
argument_list|)
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_sideport_mclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|igp_sideport_mclk
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|le32_to_cpu
argument_list|(
name|info
operator|->
name|info_v2
operator|.
name|ulBootUpUMAClock
argument_list|)
condition|)
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|le32_to_cpu
argument_list|(
name|info
operator|->
name|info_v2
operator|.
name|ulBootUpUMAClock
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
condition|)
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
argument_list|)
expr_stmt|;
else|else
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|66700
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_clk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|le32_to_cpu
argument_list|(
name|info
operator|->
name|info_v2
operator|.
name|ulHTLinkFreq
argument_list|)
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_clk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_clk
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_width
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|le16_to_cpu
argument_list|(
name|info
operator|->
name|info_v2
operator|.
name|usMinHTLinkWidth
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* We assume the slower possible clock ie worst case */
name|rdev
operator|->
name|pm
operator|.
name|igp_sideport_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_clk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_width
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"No integrated system info for your GPU, using safe default\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
comment|/* We assume the slower possible clock ie worst case */
name|rdev
operator|->
name|pm
operator|.
name|igp_sideport_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_clk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_width
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"No integrated system info for your GPU, using safe default\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Compute various bandwidth */
comment|/* k8_bandwidth = (memory_clk / 2) * 2 * 8 * 0.5 = memory_clk * 4  */
name|tmp
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|k8_bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|igp_system_mclk
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* ht_bandwidth = ht_clk * 2 * ht_width / 8 * 0.8 	 *              = ht_clk * ht_width / 5 	 */
name|tmp
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|ht_bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_clk
argument_list|,
name|rdev
operator|->
name|pm
operator|.
name|igp_ht_link_width
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|ht_bandwidth
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|ht_bandwidth
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|.
name|full
operator|<
name|rdev
operator|->
name|pm
operator|.
name|max_bandwidth
operator|.
name|full
condition|)
block|{
comment|/* HT link is a limiting factor */
name|rdev
operator|->
name|pm
operator|.
name|max_bandwidth
operator|.
name|full
operator|=
name|tmp
operator|.
name|full
expr_stmt|;
block|}
comment|/* sideport_bandwidth = (sideport_clk / 2) * 2 * 2 * 0.7 	 *                    = (sideport_clk * 14) / 10 	 */
name|tmp
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|14
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|sideport_bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|igp_sideport_mclk
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|sideport_bandwidth
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|sideport_bandwidth
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs690_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u64
name|base
decl_stmt|;
name|rs400_gart_adjust_size
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|=
name|RREG32
argument_list|(
name|RADEON_CONFIG_MEMSIZE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|mc_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|aper_base
operator|=
name|drm_get_resource_start
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|aper_size
operator|=
name|drm_get_resource_len
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_size
expr_stmt|;
name|base
operator|=
name|RREG32_MC
argument_list|(
name|R_000100_MCCFG_FB_LOCATION
argument_list|)
expr_stmt|;
name|base
operator|=
name|G_000100_MC_FB_START
argument_list|(
name|base
argument_list|)
operator|<<
literal|16
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|igp_sideport_enabled
operator|=
name|radeon_atombios_sideport_present
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs690_pm_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_vram_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_base_align
operator|=
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|-
literal|1
expr_stmt|;
name|radeon_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rs690_line_buffer_adjust
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode1
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode2
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
comment|/* 	 * Line Buffer Setup 	 * There is a single line buffer shared by both display controllers. 	 * R_006520_DC_LB_MEMORY_SPLIT controls how that line buffer is shared between 	 * the display controllers.  The paritioning can either be done 	 * manually or via one of four preset allocations specified in bits 1:0: 	 *  0 - line buffer is divided in half and shared between crtc 	 *  1 - D1 gets 3/4 of the line buffer, D2 gets 1/4 	 *  2 - D1 gets the whole buffer 	 *  3 - D1 gets 1/4 of the line buffer, D2 gets 3/4 	 * Setting bit 2 of R_006520_DC_LB_MEMORY_SPLIT controls switches to manual 	 * allocation mode. In manual allocation mode, D1 always starts at 0, 	 * D1 end/2 is specified in bits 14:4; D2 allocation follows D1. 	 */
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_006520_DC_LB_MEMORY_SPLIT
argument_list|)
operator|&
name|C_006520_DC_LB_MEMORY_SPLIT
expr_stmt|;
name|tmp
operator|&=
operator|~
name|C_006520_DC_LB_MEMORY_SPLIT_MODE
expr_stmt|;
comment|/* auto */
if|if
condition|(
name|mode1
operator|&&
name|mode2
condition|)
block|{
if|if
condition|(
name|mode1
operator|->
name|hdisplay
operator|>
name|mode2
operator|->
name|hdisplay
condition|)
block|{
if|if
condition|(
name|mode1
operator|->
name|hdisplay
operator|>
literal|2560
condition|)
name|tmp
operator||=
name|V_006520_DC_LB_MEMORY_SPLIT_D1_3Q_D2_1Q
expr_stmt|;
else|else
name|tmp
operator||=
name|V_006520_DC_LB_MEMORY_SPLIT_D1HALF_D2HALF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode2
operator|->
name|hdisplay
operator|>
name|mode1
operator|->
name|hdisplay
condition|)
block|{
if|if
condition|(
name|mode2
operator|->
name|hdisplay
operator|>
literal|2560
condition|)
name|tmp
operator||=
name|V_006520_DC_LB_MEMORY_SPLIT_D1_1Q_D2_3Q
expr_stmt|;
else|else
name|tmp
operator||=
name|V_006520_DC_LB_MEMORY_SPLIT_D1HALF_D2HALF
expr_stmt|;
block|}
else|else
name|tmp
operator||=
name|V_006520_DC_LB_MEMORY_SPLIT_D1HALF_D2HALF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode1
condition|)
block|{
name|tmp
operator||=
name|V_006520_DC_LB_MEMORY_SPLIT_D1_ONLY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode2
condition|)
block|{
name|tmp
operator||=
name|V_006520_DC_LB_MEMORY_SPLIT_D1_1Q_D2_3Q
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|R_006520_DC_LB_MEMORY_SPLIT
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|rs690_watermark
block|{
name|u32
name|lb_request_fifo_depth
decl_stmt|;
name|fixed20_12
name|num_line_pair
decl_stmt|;
name|fixed20_12
name|estimated_width
decl_stmt|;
name|fixed20_12
name|worst_case_latency
decl_stmt|;
name|fixed20_12
name|consumption_rate
decl_stmt|;
name|fixed20_12
name|active_time
decl_stmt|;
name|fixed20_12
name|dbpp
decl_stmt|;
name|fixed20_12
name|priority_mark_max
decl_stmt|;
name|fixed20_12
name|priority_mark
decl_stmt|;
name|fixed20_12
name|sclk
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|rs690_crtc_bandwidth_compute
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|rs690_watermark
modifier|*
name|wm
parameter_list|)
block|{
name|struct
name|drm_display_mode
modifier|*
name|mode
init|=
operator|&
name|crtc
operator|->
name|base
operator|.
name|mode
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
name|fixed20_12
name|pclk
decl_stmt|,
name|request_fifo_depth
decl_stmt|,
name|tolerable_latency
decl_stmt|,
name|estimated_width
decl_stmt|;
name|fixed20_12
name|consumption_time
decl_stmt|,
name|line_time
decl_stmt|,
name|chunk_time
decl_stmt|,
name|read_delay_latency
decl_stmt|;
if|if
condition|(
operator|!
name|crtc
operator|->
name|base
operator|.
name|enabled
condition|)
block|{
comment|/* FIXME: wouldn't it better to set priority mark to maximum */
name|wm
operator|->
name|lb_request_fifo_depth
operator|=
literal|4
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|crtc
operator|->
name|vsc
operator|.
name|full
operator|>
name|dfixed_const
argument_list|(
literal|2
argument_list|)
condition|)
name|wm
operator|->
name|num_line_pair
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
argument_list|)
expr_stmt|;
else|else
name|wm
operator|->
name|num_line_pair
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mode
operator|->
name|crtc_hdisplay
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|256
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|request_fifo_depth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|wm
operator|->
name|num_line_pair
argument_list|)
expr_stmt|;
name|request_fifo_depth
operator|.
name|full
operator|=
name|dfixed_ceil
argument_list|(
name|request_fifo_depth
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|.
name|full
operator|<
name|dfixed_const
argument_list|(
literal|4
argument_list|)
condition|)
block|{
name|wm
operator|->
name|lb_request_fifo_depth
operator|=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|wm
operator|->
name|lb_request_fifo_depth
operator|=
name|dfixed_trunc
argument_list|(
name|request_fifo_depth
argument_list|)
expr_stmt|;
block|}
comment|/* Determine consumption rate 	 *  pclk = pixel clock period(ns) = 1000 / (mode.clock / 1000) 	 *  vtaps = number of vertical taps, 	 *  vsc = vertical scaling ratio, defined as source/destination 	 *  hsc = horizontal scaling ration, defined as source/destination 	 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mode
operator|->
name|clock
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|pclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|crtc
operator|->
name|rmx_type
operator|!=
name|RMX_OFF
condition|)
block|{
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|crtc
operator|->
name|vsc
operator|.
name|full
operator|>
name|b
operator|.
name|full
condition|)
name|b
operator|.
name|full
operator|=
name|crtc
operator|->
name|vsc
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|crtc
operator|->
name|hsc
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|consumption_time
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|pclk
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|consumption_time
operator|.
name|full
operator|=
name|pclk
operator|.
name|full
expr_stmt|;
block|}
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|wm
operator|->
name|consumption_rate
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|consumption_time
argument_list|)
expr_stmt|;
comment|/* Determine line time 	 *  LineTime = total time for one line of displayhtotal 	 *  LineTime = total number of horizontal pixels 	 *  pclk = pixel clock period(ns) 	 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|crtc
operator|->
name|base
operator|.
name|mode
operator|.
name|crtc_htotal
argument_list|)
expr_stmt|;
name|line_time
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|pclk
argument_list|)
expr_stmt|;
comment|/* Determine active time 	 *  ActiveTime = time of active region of display within one line, 	 *  hactive = total number of horizontal active pixels 	 *  htotal = total number of horizontal pixels 	 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|crtc
operator|->
name|base
operator|.
name|mode
operator|.
name|crtc_htotal
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|crtc
operator|->
name|base
operator|.
name|mode
operator|.
name|crtc_hdisplay
argument_list|)
expr_stmt|;
name|wm
operator|->
name|active_time
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|line_time
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|wm
operator|->
name|active_time
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm
operator|->
name|active_time
argument_list|,
name|a
argument_list|)
expr_stmt|;
comment|/* Maximun bandwidth is the minimun bandwidth of all component */
name|rdev
operator|->
name|pm
operator|.
name|max_bandwidth
operator|=
name|rdev
operator|->
name|pm
operator|.
name|core_bandwidth
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|igp_sideport_enabled
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|max_bandwidth
operator|.
name|full
operator|>
name|rdev
operator|->
name|pm
operator|.
name|sideport_bandwidth
operator|.
name|full
operator|&&
name|rdev
operator|->
name|pm
operator|.
name|sideport_bandwidth
operator|.
name|full
condition|)
name|rdev
operator|->
name|pm
operator|.
name|max_bandwidth
operator|=
name|rdev
operator|->
name|pm
operator|.
name|sideport_bandwidth
expr_stmt|;
name|read_delay_latency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|370
operator|*
literal|800
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|igp_sideport_mclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|read_delay_latency
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|read_delay_latency
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|read_delay_latency
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|read_delay_latency
argument_list|,
name|a
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|max_bandwidth
operator|.
name|full
operator|>
name|rdev
operator|->
name|pm
operator|.
name|k8_bandwidth
operator|.
name|full
operator|&&
name|rdev
operator|->
name|pm
operator|.
name|k8_bandwidth
operator|.
name|full
condition|)
name|rdev
operator|->
name|pm
operator|.
name|max_bandwidth
operator|=
name|rdev
operator|->
name|pm
operator|.
name|k8_bandwidth
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|max_bandwidth
operator|.
name|full
operator|>
name|rdev
operator|->
name|pm
operator|.
name|ht_bandwidth
operator|.
name|full
operator|&&
name|rdev
operator|->
name|pm
operator|.
name|ht_bandwidth
operator|.
name|full
condition|)
name|rdev
operator|->
name|pm
operator|.
name|max_bandwidth
operator|=
name|rdev
operator|->
name|pm
operator|.
name|ht_bandwidth
expr_stmt|;
name|read_delay_latency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|5000
argument_list|)
expr_stmt|;
block|}
comment|/* sclk = system clocks(ns) = 1000 / max_bandwidth / 16 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|sclk
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|max_bandwidth
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|sclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|rdev
operator|->
name|pm
operator|.
name|sclk
argument_list|)
expr_stmt|;
comment|/* Determine chunk time 	 * ChunkTime = the time it takes the DCP to send one chunk of data 	 * to the LB which consists of pipeline delay and inter chunk gap 	 * sclk = system clock(ns) 	 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|256
operator|*
literal|13
argument_list|)
expr_stmt|;
name|chunk_time
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|rdev
operator|->
name|pm
operator|.
name|sclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|chunk_time
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|chunk_time
argument_list|,
name|a
argument_list|)
expr_stmt|;
comment|/* Determine the worst case latency 	 * NumLinePair = Number of line pairs to request(1=2 lines, 2=4 lines) 	 * WorstCaseLatency = worst case time from urgent to when the MC starts 	 *                    to return data 	 * READ_DELAY_IDLE_MAX = constant of 1us 	 * ChunkTime = time it takes the DCP to send one chunk of data to the LB 	 *             which consists of pipeline delay and inter chunk gap 	 */
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|wm
operator|->
name|num_line_pair
argument_list|)
operator|>
literal|1
condition|)
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|wm
operator|->
name|worst_case_latency
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|chunk_time
argument_list|)
expr_stmt|;
name|wm
operator|->
name|worst_case_latency
operator|.
name|full
operator|+=
name|read_delay_latency
operator|.
name|full
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|wm
operator|->
name|worst_case_latency
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|chunk_time
argument_list|)
expr_stmt|;
name|wm
operator|->
name|worst_case_latency
operator|.
name|full
operator|+=
name|read_delay_latency
operator|.
name|full
expr_stmt|;
block|}
comment|/* Determine the tolerable latency 	 * TolerableLatency = Any given request has only 1 line time 	 *                    for the data to be returned 	 * LBRequestFifoDepth = Number of chunk requests the LB can 	 *                      put into the request FIFO for a display 	 *  LineTime = total time for one line of display 	 *  ChunkTime = the time it takes the DCP to send one chunk 	 *              of data to the LB which consists of 	 *  pipeline delay and inter chunk gap 	 */
if|if
condition|(
operator|(
literal|2
operator|+
name|wm
operator|->
name|lb_request_fifo_depth
operator|)
operator|>=
name|dfixed_trunc
argument_list|(
name|request_fifo_depth
argument_list|)
condition|)
block|{
name|tolerable_latency
operator|.
name|full
operator|=
name|line_time
operator|.
name|full
expr_stmt|;
block|}
else|else
block|{
name|tolerable_latency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|lb_request_fifo_depth
operator|-
literal|2
argument_list|)
expr_stmt|;
name|tolerable_latency
operator|.
name|full
operator|=
name|request_fifo_depth
operator|.
name|full
operator|-
name|tolerable_latency
operator|.
name|full
expr_stmt|;
name|tolerable_latency
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|tolerable_latency
argument_list|,
name|chunk_time
argument_list|)
expr_stmt|;
name|tolerable_latency
operator|.
name|full
operator|=
name|line_time
operator|.
name|full
operator|-
name|tolerable_latency
operator|.
name|full
expr_stmt|;
block|}
comment|/* We assume worst case 32bits (4 bytes) */
name|wm
operator|->
name|dbpp
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|4
operator|*
literal|8
argument_list|)
expr_stmt|;
comment|/* Determine the maximum priority mark 	 *  width = viewport width in pixels 	 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark_max
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|crtc
operator|->
name|base
operator|.
name|mode
operator|.
name|crtc_hdisplay
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark_max
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm
operator|->
name|priority_mark_max
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark_max
operator|.
name|full
operator|=
name|dfixed_ceil
argument_list|(
name|wm
operator|->
name|priority_mark_max
argument_list|)
expr_stmt|;
comment|/* Determine estimated width */
name|estimated_width
operator|.
name|full
operator|=
name|tolerable_latency
operator|.
name|full
operator|-
name|wm
operator|->
name|worst_case_latency
operator|.
name|full
expr_stmt|;
name|estimated_width
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|estimated_width
argument_list|,
name|consumption_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|estimated_width
argument_list|)
operator|>
name|crtc
operator|->
name|base
operator|.
name|mode
operator|.
name|crtc_hdisplay
condition|)
block|{
name|wm
operator|->
name|priority_mark
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|estimated_width
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark
operator|.
name|full
operator|=
name|dfixed_ceil
argument_list|(
name|wm
operator|->
name|priority_mark
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark
operator|.
name|full
operator|=
name|wm
operator|->
name|priority_mark_max
operator|.
name|full
operator|-
name|wm
operator|->
name|priority_mark
operator|.
name|full
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|rs690_bandwidth_update
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_display_mode
modifier|*
name|mode0
init|=
name|NULL
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|mode1
init|=
name|NULL
decl_stmt|;
name|struct
name|rs690_watermark
name|wm0
decl_stmt|;
name|struct
name|rs690_watermark
name|wm1
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|u32
name|d1mode_priority_a_cnt
init|=
name|S_006548_D1MODE_PRIORITY_A_OFF
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|u32
name|d2mode_priority_a_cnt
init|=
name|S_006548_D1MODE_PRIORITY_A_OFF
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|fixed20_12
name|priority_mark02
decl_stmt|,
name|priority_mark12
decl_stmt|,
name|fill_rate
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|,
name|b
decl_stmt|;
name|radeon_update_display_priority
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
name|mode0
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
name|mode1
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
comment|/* 	 * Set display0/1 priority up in the memory controller for 	 * modes if the user specifies HIGH for displaypriority 	 * option. 	 */
if|if
condition|(
operator|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
operator|)
operator|&&
operator|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS740
operator|)
operator|)
condition|)
block|{
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R_000104_MC_INIT_MISC_LAT_TIMER
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|C_000104_MC_DISP0R_INIT_LAT
expr_stmt|;
name|tmp
operator|&=
name|C_000104_MC_DISP1R_INIT_LAT
expr_stmt|;
if|if
condition|(
name|mode0
condition|)
name|tmp
operator||=
name|S_000104_MC_DISP0R_INIT_LAT
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode1
condition|)
name|tmp
operator||=
name|S_000104_MC_DISP1R_INIT_LAT
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000104_MC_INIT_MISC_LAT_TIMER
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|rs690_line_buffer_adjust
argument_list|(
name|rdev
argument_list|,
name|mode0
argument_list|,
name|mode1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS740
operator|)
condition|)
name|WREG32
argument_list|(
name|R_006C9C_DCP_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS780
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS880
operator|)
condition|)
name|WREG32
argument_list|(
name|R_006C9C_DCP_CONTROL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|rs690_crtc_bandwidth_compute
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
argument_list|,
operator|&
name|wm0
argument_list|)
expr_stmt|;
name|rs690_crtc_bandwidth_compute
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
argument_list|,
operator|&
name|wm1
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|wm0
operator|.
name|lb_request_fifo_depth
operator|-
literal|1
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|wm1
operator|.
name|lb_request_fifo_depth
operator|-
literal|1
operator|)
operator|<<
literal|16
expr_stmt|;
name|WREG32
argument_list|(
name|R_006D58_LB_MAX_REQ_OUTSTANDING
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode0
operator|&&
name|mode1
condition|)
block|{
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|wm0
operator|.
name|dbpp
argument_list|)
operator|>
literal|64
condition|)
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm0
operator|.
name|dbpp
argument_list|,
name|wm0
operator|.
name|num_line_pair
argument_list|)
expr_stmt|;
else|else
name|a
operator|.
name|full
operator|=
name|wm0
operator|.
name|num_line_pair
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|wm1
operator|.
name|dbpp
argument_list|)
operator|>
literal|64
condition|)
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm1
operator|.
name|dbpp
argument_list|,
name|wm1
operator|.
name|num_line_pair
argument_list|)
expr_stmt|;
else|else
name|b
operator|.
name|full
operator|=
name|wm1
operator|.
name|num_line_pair
operator|.
name|full
expr_stmt|;
name|a
operator|.
name|full
operator|+=
name|b
operator|.
name|full
expr_stmt|;
name|fill_rate
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm0
operator|.
name|sclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|wm0
operator|.
name|consumption_rate
operator|.
name|full
operator|>
name|fill_rate
operator|.
name|full
condition|)
block|{
name|b
operator|.
name|full
operator|=
name|wm0
operator|.
name|consumption_rate
operator|.
name|full
operator|-
name|fill_rate
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|wm0
operator|.
name|active_time
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm0
operator|.
name|worst_case_latency
argument_list|,
name|wm0
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|a
operator|.
name|full
operator|+
name|b
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark02
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm0
operator|.
name|worst_case_latency
argument_list|,
name|wm0
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark02
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wm1
operator|.
name|consumption_rate
operator|.
name|full
operator|>
name|fill_rate
operator|.
name|full
condition|)
block|{
name|b
operator|.
name|full
operator|=
name|wm1
operator|.
name|consumption_rate
operator|.
name|full
operator|-
name|fill_rate
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|wm1
operator|.
name|active_time
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm1
operator|.
name|worst_case_latency
argument_list|,
name|wm1
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|a
operator|.
name|full
operator|+
name|b
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark12
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm1
operator|.
name|worst_case_latency
argument_list|,
name|wm1
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark12
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wm0
operator|.
name|priority_mark
operator|.
name|full
operator|>
name|priority_mark02
operator|.
name|full
condition|)
name|priority_mark02
operator|.
name|full
operator|=
name|wm0
operator|.
name|priority_mark
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|wm0
operator|.
name|priority_mark_max
operator|.
name|full
operator|>
name|priority_mark02
operator|.
name|full
condition|)
name|priority_mark02
operator|.
name|full
operator|=
name|wm0
operator|.
name|priority_mark_max
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|wm1
operator|.
name|priority_mark
operator|.
name|full
operator|>
name|priority_mark12
operator|.
name|full
condition|)
name|priority_mark12
operator|.
name|full
operator|=
name|wm1
operator|.
name|priority_mark
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|wm1
operator|.
name|priority_mark_max
operator|.
name|full
operator|>
name|priority_mark12
operator|.
name|full
condition|)
name|priority_mark12
operator|.
name|full
operator|=
name|wm1
operator|.
name|priority_mark_max
operator|.
name|full
expr_stmt|;
name|d1mode_priority_a_cnt
operator|=
name|dfixed_trunc
argument_list|(
name|priority_mark02
argument_list|)
expr_stmt|;
name|d2mode_priority_a_cnt
operator|=
name|dfixed_trunc
argument_list|(
name|priority_mark12
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
condition|)
block|{
name|d1mode_priority_a_cnt
operator||=
name|S_006548_D1MODE_PRIORITY_A_ALWAYS_ON
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|d2mode_priority_a_cnt
operator||=
name|S_006D48_D2MODE_PRIORITY_A_ALWAYS_ON
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|mode0
condition|)
block|{
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|wm0
operator|.
name|dbpp
argument_list|)
operator|>
literal|64
condition|)
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm0
operator|.
name|dbpp
argument_list|,
name|wm0
operator|.
name|num_line_pair
argument_list|)
expr_stmt|;
else|else
name|a
operator|.
name|full
operator|=
name|wm0
operator|.
name|num_line_pair
operator|.
name|full
expr_stmt|;
name|fill_rate
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm0
operator|.
name|sclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|wm0
operator|.
name|consumption_rate
operator|.
name|full
operator|>
name|fill_rate
operator|.
name|full
condition|)
block|{
name|b
operator|.
name|full
operator|=
name|wm0
operator|.
name|consumption_rate
operator|.
name|full
operator|-
name|fill_rate
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|wm0
operator|.
name|active_time
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm0
operator|.
name|worst_case_latency
argument_list|,
name|wm0
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|a
operator|.
name|full
operator|+
name|b
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark02
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm0
operator|.
name|worst_case_latency
argument_list|,
name|wm0
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark02
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wm0
operator|.
name|priority_mark
operator|.
name|full
operator|>
name|priority_mark02
operator|.
name|full
condition|)
name|priority_mark02
operator|.
name|full
operator|=
name|wm0
operator|.
name|priority_mark
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|wm0
operator|.
name|priority_mark_max
operator|.
name|full
operator|>
name|priority_mark02
operator|.
name|full
condition|)
name|priority_mark02
operator|.
name|full
operator|=
name|wm0
operator|.
name|priority_mark_max
operator|.
name|full
expr_stmt|;
name|d1mode_priority_a_cnt
operator|=
name|dfixed_trunc
argument_list|(
name|priority_mark02
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
condition|)
name|d1mode_priority_a_cnt
operator||=
name|S_006548_D1MODE_PRIORITY_A_ALWAYS_ON
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode1
condition|)
block|{
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|wm1
operator|.
name|dbpp
argument_list|)
operator|>
literal|64
condition|)
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm1
operator|.
name|dbpp
argument_list|,
name|wm1
operator|.
name|num_line_pair
argument_list|)
expr_stmt|;
else|else
name|a
operator|.
name|full
operator|=
name|wm1
operator|.
name|num_line_pair
operator|.
name|full
expr_stmt|;
name|fill_rate
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm1
operator|.
name|sclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|wm1
operator|.
name|consumption_rate
operator|.
name|full
operator|>
name|fill_rate
operator|.
name|full
condition|)
block|{
name|b
operator|.
name|full
operator|=
name|wm1
operator|.
name|consumption_rate
operator|.
name|full
operator|-
name|fill_rate
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|wm1
operator|.
name|active_time
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm1
operator|.
name|worst_case_latency
argument_list|,
name|wm1
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|a
operator|.
name|full
operator|+
name|b
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark12
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm1
operator|.
name|worst_case_latency
argument_list|,
name|wm1
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark12
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wm1
operator|.
name|priority_mark
operator|.
name|full
operator|>
name|priority_mark12
operator|.
name|full
condition|)
name|priority_mark12
operator|.
name|full
operator|=
name|wm1
operator|.
name|priority_mark
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|wm1
operator|.
name|priority_mark_max
operator|.
name|full
operator|>
name|priority_mark12
operator|.
name|full
condition|)
name|priority_mark12
operator|.
name|full
operator|=
name|wm1
operator|.
name|priority_mark_max
operator|.
name|full
expr_stmt|;
name|d2mode_priority_a_cnt
operator|=
name|dfixed_trunc
argument_list|(
name|priority_mark12
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
condition|)
name|d2mode_priority_a_cnt
operator||=
name|S_006D48_D2MODE_PRIORITY_A_ALWAYS_ON
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|R_006548_D1MODE_PRIORITY_A_CNT
argument_list|,
name|d1mode_priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_00654C_D1MODE_PRIORITY_B_CNT
argument_list|,
name|d1mode_priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_006D48_D2MODE_PRIORITY_A_CNT
argument_list|,
name|d2mode_priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_006D4C_D2MODE_PRIORITY_B_CNT
argument_list|,
name|d2mode_priority_a_cnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|rs690_mc_rreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|)
block|{
name|uint32_t
name|r
decl_stmt|;
name|WREG32
argument_list|(
name|R_000078_MC_INDEX
argument_list|,
name|S_000078_MC_IND_ADDR
argument_list|(
name|reg
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|RREG32
argument_list|(
name|R_00007C_MC_DATA
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000078_MC_INDEX
argument_list|,
operator|~
name|C_000078_MC_IND_ADDR
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|rs690_mc_wreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|v
parameter_list|)
block|{
name|WREG32
argument_list|(
name|R_000078_MC_INDEX
argument_list|,
name|S_000078_MC_IND_ADDR
argument_list|(
name|reg
argument_list|)
operator||
name|S_000078_MC_IND_WR_EN
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_00007C_MC_DATA
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000078_MC_INDEX
argument_list|,
literal|0x7F
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs690_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|rv515_mc_save
name|save
decl_stmt|;
comment|/* Stops all mc clients */
name|rv515_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
comment|/* Wait for mc idle */
if|if
condition|(
name|rs690_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait MC idle timeout before updating MC.\n"
argument_list|)
expr_stmt|;
comment|/* Program MC, should be a 32bits limited address space */
name|WREG32_MC
argument_list|(
name|R_000100_MCCFG_FB_LOCATION
argument_list|,
name|S_000100_MC_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
operator||
name|S_000100_MC_FB_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000134_HDP_FB_LOCATION
argument_list|,
name|S_000134_HDP_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|rv515_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs690_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|rs690_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GPU configuration (# pipes, ...) */
name|rs690_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GART (initialize after TTM so we can allocate 	 * memory through TTM but finalize after TTM) */
name|r
operator|=
name|rs400_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|rs600_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|hdp_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
comment|/* 1M ring buffer */
name|r
operator|=
name|r100_cp_init
argument_list|(
name|rdev
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|r600_audio_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing audio\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rs690_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Make sur GART are not working */
name|rs400_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock before doing reset */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* post */
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
comment|/* Resume clock after posting */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|rs690_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|rs690_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_audio_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_cp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs600_irq_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs400_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|rs690_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_audio_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs400_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rs690_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Disable VGA */
name|rv515_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize scratch registers */
name|radeon_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* restore some register to sane defaults */
name|r100_restore_sanity
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* TODO: disable VGA need to use VGA request */
comment|/* BIOS*/
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|r
operator|=
name|radeon_atombios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
else|else
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting atombios for RV515 GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* check if cards are posted or not */
if|if
condition|(
name|radeon_boot_test_post_card
argument_list|(
name|rdev
argument_list|)
operator|==
name|false
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* initialize memory controller */
name|rs690_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv515_debugfs
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|rs400_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rs600_set_safe_registers
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|rs690_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
comment|/* Somethings want wront with the accel init stop accel */
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs400_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


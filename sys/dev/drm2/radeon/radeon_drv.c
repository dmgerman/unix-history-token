begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**  * \file radeon_drv.c  * ATI Radeon driver  *  * \author Gareth Hughes<gareth@valinux.com>  */
end_comment

begin_comment
comment|/*  * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon_drv.h"
end_include

begin_include
include|#
directive|include
file|"radeon_gem.h"
end_include

begin_include
include|#
directive|include
file|"radeon_kms.h"
end_include

begin_include
include|#
directive|include
file|"radeon_irq_kms.h"
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_pciids.h>
end_include

begin_include
include|#
directive|include
file|"fb_if.h"
end_include

begin_comment
comment|/*  * KMS wrapper.  * - 2.0.0 - initial interface  * - 2.1.0 - add square tiling interface  * - 2.2.0 - add r6xx/r7xx const buffer support  * - 2.3.0 - add MSPOS + 3D texture + r500 VAP regs  * - 2.4.0 - add crtc id query  * - 2.5.0 - add get accel 2 to work around ddx breakage for evergreen  * - 2.6.0 - add tiling config query (r6xx+), add initial HiZ support (r300->r500)  *   2.7.0 - fixups for r600 2D tiling support. (no external ABI change), add eg dyn gpr regs  *   2.8.0 - pageflip support, r500 US_FORMAT regs. r500 ARGB2101010 colorbuf, r300->r500 CMASK, clock crystal query  *   2.9.0 - r600 tiling (s3tc,rgtc) working, SET_PREDICATION packet 3 on r600 + eg, backend query  *   2.10.0 - fusion 2D tiling  *   2.11.0 - backend map, initial compute support for the CS checker  *   2.12.0 - RADEON_CS_KEEP_TILING_FLAGS  *   2.13.0 - virtual memory support, streamout  *   2.14.0 - add evergreen tiling informations  *   2.15.0 - add max_pipes query  *   2.16.0 - fix evergreen 2D tiled surface calculation  *   2.17.0 - add STRMOUT_BASE_UPDATE for r7xx  *   2.18.0 - r600-eg: allow "invalid" DB formats  *   2.19.0 - r600-eg: MSAA textures  *   2.20.0 - r600-si: RADEON_INFO_TIMESTAMP query  *   2.21.0 - r600-r700: FMASK and CMASK  *   2.22.0 - r600 only: RESOLVE_BOX allowed  *   2.23.0 - allow STRMOUT_BASE_UPDATE on RS780 and RS880  *   2.24.0 - eg only: allow MIP_ADDRESS=0 for MSAA textures  *   2.25.0 - eg+: new info request for num SE and num SH  *   2.26.0 - r600-eg: fix htile size computation  *   2.27.0 - r600-SI: Add CS ioctl support for async DMA  *   2.28.0 - r600-eg: Add MEM_WRITE packet support  *   2.29.0 - R500 FP16 color clear registers  */
end_comment

begin_define
define|#
directive|define
name|KMS_DRIVER_MAJOR
value|2
end_define

begin_define
define|#
directive|define
name|KMS_DRIVER_MINOR
value|29
end_define

begin_define
define|#
directive|define
name|KMS_DRIVER_PATCHLEVEL
value|0
end_define

begin_function_decl
name|int
name|radeon_suspend_kms
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|radeon_resume_kms
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|radeon_get_crtc_scanoutpos
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|int
name|crtc
parameter_list|,
name|int
modifier|*
name|vpos
parameter_list|,
name|int
modifier|*
name|hpos
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|struct
name|drm_ioctl_desc
name|radeon_ioctls_kms
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|radeon_max_kms_ioctl
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FREEBSD_WIP
end_ifdef

begin_function_decl
name|int
name|radeon_mmap
parameter_list|(
name|struct
name|file
modifier|*
name|filp
parameter_list|,
name|struct
name|vm_area_struct
modifier|*
name|vma
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FREEBSD_WIP */
end_comment

begin_function_decl
name|int
name|radeon_mode_dumb_mmap
parameter_list|(
name|struct
name|drm_file
modifier|*
name|filp
parameter_list|,
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|uint32_t
name|handle
parameter_list|,
name|uint64_t
modifier|*
name|offset_p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|radeon_mode_dumb_create
parameter_list|(
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|,
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_mode_create_dumb
modifier|*
name|args
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|radeon_mode_dumb_destroy
parameter_list|(
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|,
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|uint32_t
name|handle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|dma_buf
modifier|*
name|radeon_gem_prime_export
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_gem_object
modifier|*
name|obj
parameter_list|,
name|int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|drm_gem_object
modifier|*
name|radeon_gem_prime_import
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|dma_buf
modifier|*
name|dma_buf
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
end_if

begin_function_decl
name|int
name|radeon_debugfs_init
parameter_list|(
name|struct
name|drm_minor
modifier|*
name|minor
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|radeon_debugfs_cleanup
parameter_list|(
name|struct
name|drm_minor
modifier|*
name|minor
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|radeon_no_wb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_modeset
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_dynclks
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_r4xx_atom
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_agpmode
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_vram_limit
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_gart_size
init|=
literal|512
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default gart size */
end_comment

begin_decl_stmt
name|int
name|radeon_benchmarking
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_testing
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_connector_table
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_tv
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_audio
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_disp_priority
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_hw_i2c
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_pcie_gen2
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_msi
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radeon_lockup_timeout
init|=
literal|10000
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.no_wb"
argument_list|,
operator|&
name|radeon_no_wb
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|no_wb
argument_list|,
literal|"Disable AGP writeback for scratch registers"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|no_wb
argument_list|,
name|radeon_no_wb
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.modeset"
argument_list|,
operator|&
name|radeon_modeset
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|modeset
argument_list|,
literal|"Disable/Enable modesetting"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|modeset
argument_list|,
name|radeon_modeset
argument_list|,
name|int
argument_list|,
literal|0400
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.dynclks"
argument_list|,
operator|&
name|radeon_dynclks
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|dynclks
argument_list|,
literal|"Disable/Enable dynamic clocks"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|dynclks
argument_list|,
name|radeon_dynclks
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.r4xx_atom"
argument_list|,
operator|&
name|radeon_r4xx_atom
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|r4xx_atom
argument_list|,
literal|"Enable ATOMBIOS modesetting for R4xx"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|r4xx_atom
argument_list|,
name|radeon_r4xx_atom
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.vramlimit"
argument_list|,
operator|&
name|radeon_vram_limit
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|vramlimit
argument_list|,
literal|"Restrict VRAM for testing"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|vramlimit
argument_list|,
name|radeon_vram_limit
argument_list|,
name|int
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.agpmode"
argument_list|,
operator|&
name|radeon_agpmode
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|agpmode
argument_list|,
literal|"AGP Mode (-1 == PCI)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|agpmode
argument_list|,
name|radeon_agpmode
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.gartsize"
argument_list|,
operator|&
name|radeon_gart_size
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|gartsize
argument_list|,
literal|"Size of PCIE/IGP gart to setup in megabytes (32, 64, etc)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|gartsize
argument_list|,
name|radeon_gart_size
argument_list|,
name|int
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.benchmark"
argument_list|,
operator|&
name|radeon_benchmarking
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|benchmark
argument_list|,
literal|"Run benchmark"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|benchmark
argument_list|,
name|radeon_benchmarking
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.test"
argument_list|,
operator|&
name|radeon_testing
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|test
argument_list|,
literal|"Run tests"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|test
argument_list|,
name|radeon_testing
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.connector_table"
argument_list|,
operator|&
name|radeon_connector_table
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|connector_table
argument_list|,
literal|"Force connector table"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|connector_table
argument_list|,
name|radeon_connector_table
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.tv"
argument_list|,
operator|&
name|radeon_tv
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|tv
argument_list|,
literal|"TV enable (0 = disable)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|tv
argument_list|,
name|radeon_tv
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.audio"
argument_list|,
operator|&
name|radeon_audio
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|audio
argument_list|,
literal|"Audio enable (1 = enable)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|audio
argument_list|,
name|radeon_audio
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.disp_priority"
argument_list|,
operator|&
name|radeon_disp_priority
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|disp_priority
argument_list|,
literal|"Display Priority (0 = auto, 1 = normal, 2 = high)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|disp_priority
argument_list|,
name|radeon_disp_priority
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.hw_i2c"
argument_list|,
operator|&
name|radeon_hw_i2c
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|hw_i2c
argument_list|,
literal|"hw i2c engine enable (0 = disable)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|hw_i2c
argument_list|,
name|radeon_hw_i2c
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.pcie_gen2"
argument_list|,
operator|&
name|radeon_pcie_gen2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|pcie_gen2
argument_list|,
literal|"PCIE Gen2 mode (-1 = auto, 0 = disable, 1 = enable)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|pcie_gen2
argument_list|,
name|radeon_pcie_gen2
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.msi"
argument_list|,
operator|&
name|radeon_msi
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|msi
argument_list|,
literal|"MSI support (1 = enable, 0 = disable, -1 = auto)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|msi
argument_list|,
name|radeon_msi
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.radeon.lockup_timeout"
argument_list|,
operator|&
name|radeon_lockup_timeout
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|lockup_timeout
argument_list|,
literal|"GPU lockup timeout in ms (defaul 10000 = 10 seconds, 0 = disable)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|lockup_timeout
argument_list|,
name|radeon_lockup_timeout
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|drm_pci_id_list_t
name|pciidlist
index|[]
init|=
block|{
name|radeon_PCI_IDS
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|drm_driver
name|kms_driver
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|radeon_sysctl_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
parameter_list|,
name|struct
name|sysctl_oid
modifier|*
name|top
parameter_list|)
block|{
return|return
name|drm_add_busid_modesetting
argument_list|(
name|dev
argument_list|,
name|ctx
argument_list|,
name|top
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|drm_driver
name|kms_driver
init|=
block|{
operator|.
name|driver_features
operator|=
name|DRIVER_USE_AGP
operator||
name|DRIVER_USE_MTRR
operator||
name|DRIVER_PCI_DMA
operator||
name|DRIVER_SG
operator||
name|DRIVER_HAVE_IRQ
operator||
name|DRIVER_HAVE_DMA
operator||
name|DRIVER_IRQ_SHARED
operator||
name|DRIVER_GEM
operator||
name|DRIVER_PRIME
block|,
ifdef|#
directive|ifdef
name|FREEBSD_WIP
operator|.
name|dev_priv_size
operator|=
literal|0
block|,
endif|#
directive|endif
comment|/* FREEBSD_WIP */
operator|.
name|load
operator|=
name|radeon_driver_load_kms
block|,
operator|.
name|firstopen
operator|=
name|radeon_driver_firstopen_kms
block|,
operator|.
name|open
operator|=
name|radeon_driver_open_kms
block|,
operator|.
name|preclose
operator|=
name|radeon_driver_preclose_kms
block|,
operator|.
name|postclose
operator|=
name|radeon_driver_postclose_kms
block|,
operator|.
name|lastclose
operator|=
name|radeon_driver_lastclose_kms
block|,
operator|.
name|unload
operator|=
name|radeon_driver_unload_kms
block|,
ifdef|#
directive|ifdef
name|FREEBSD_WIP
operator|.
name|suspend
operator|=
name|radeon_suspend_kms
block|,
operator|.
name|resume
operator|=
name|radeon_resume_kms
block|,
endif|#
directive|endif
comment|/* FREEBSD_WIP */
operator|.
name|get_vblank_counter
operator|=
name|radeon_get_vblank_counter_kms
block|,
operator|.
name|enable_vblank
operator|=
name|radeon_enable_vblank_kms
block|,
operator|.
name|disable_vblank
operator|=
name|radeon_disable_vblank_kms
block|,
operator|.
name|get_vblank_timestamp
operator|=
name|radeon_get_vblank_timestamp_kms
block|,
operator|.
name|get_scanout_position
operator|=
name|radeon_get_crtc_scanoutpos
block|,
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
operator|.
name|debugfs_init
operator|=
name|radeon_debugfs_init
block|,
operator|.
name|debugfs_cleanup
operator|=
name|radeon_debugfs_cleanup
block|,
endif|#
directive|endif
operator|.
name|irq_preinstall
operator|=
name|radeon_driver_irq_preinstall_kms
block|,
operator|.
name|irq_postinstall
operator|=
name|radeon_driver_irq_postinstall_kms
block|,
operator|.
name|irq_uninstall
operator|=
name|radeon_driver_irq_uninstall_kms
block|,
operator|.
name|irq_handler
operator|=
name|radeon_driver_irq_handler_kms
block|,
operator|.
name|sysctl_init
operator|=
name|radeon_sysctl_init
block|,
operator|.
name|ioctls
operator|=
name|radeon_ioctls_kms
block|,
operator|.
name|gem_init_object
operator|=
name|radeon_gem_object_init
block|,
operator|.
name|gem_free_object
operator|=
name|radeon_gem_object_free
block|,
operator|.
name|gem_open_object
operator|=
name|radeon_gem_object_open
block|,
operator|.
name|gem_close_object
operator|=
name|radeon_gem_object_close
block|,
operator|.
name|dma_ioctl
operator|=
name|radeon_dma_ioctl_kms
block|,
operator|.
name|dumb_create
operator|=
name|radeon_mode_dumb_create
block|,
operator|.
name|dumb_map_offset
operator|=
name|radeon_mode_dumb_mmap
block|,
operator|.
name|dumb_destroy
operator|=
name|radeon_mode_dumb_destroy
block|,
ifdef|#
directive|ifdef
name|FREEBSD_WIP
operator|.
name|fops
operator|=
operator|&
name|radeon_driver_kms_fops
block|,
endif|#
directive|endif
comment|/* FREEBSD_WIP */
ifdef|#
directive|ifdef
name|FREEBSD_WIP
operator|.
name|prime_handle_to_fd
operator|=
name|drm_gem_prime_handle_to_fd
block|,
operator|.
name|prime_fd_to_handle
operator|=
name|drm_gem_prime_fd_to_handle
block|,
operator|.
name|gem_prime_export
operator|=
name|radeon_gem_prime_export
block|,
operator|.
name|gem_prime_import
operator|=
name|radeon_gem_prime_import
block|,
endif|#
directive|endif
comment|/* FREEBSD_WIP */
operator|.
name|name
operator|=
name|DRIVER_NAME
block|,
operator|.
name|desc
operator|=
name|DRIVER_DESC
block|,
operator|.
name|date
operator|=
name|DRIVER_DATE
block|,
operator|.
name|major
operator|=
name|KMS_DRIVER_MAJOR
block|,
operator|.
name|minor
operator|=
name|KMS_DRIVER_MINOR
block|,
operator|.
name|patchlevel
operator|=
name|KMS_DRIVER_PATCHLEVEL
block|, }
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FREEBSD_WIP
end_ifdef

begin_function
specifier|static
name|int
name|__init
name|radeon_init
parameter_list|(
name|void
parameter_list|)
block|{
name|driver
operator|=
operator|&
name|driver_old
expr_stmt|;
name|pdriver
operator|=
operator|&
name|radeon_pci_driver
expr_stmt|;
name|driver
operator|->
name|num_ioctls
operator|=
name|radeon_max_ioctl
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_VGA_CONSOLE
if|if
condition|(
name|vgacon_text_force
argument_list|()
operator|&&
name|radeon_modeset
operator|==
operator|-
literal|1
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"VGACON disable radeon kernel modesetting.\n"
argument_list|)
expr_stmt|;
name|driver
operator|=
operator|&
name|driver_old
expr_stmt|;
name|pdriver
operator|=
operator|&
name|radeon_pci_driver
expr_stmt|;
name|driver
operator|->
name|driver_features
operator|&=
operator|~
name|DRIVER_MODESET
expr_stmt|;
name|radeon_modeset
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* if enabled by default */
if|if
condition|(
name|radeon_modeset
operator|==
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_DRM_RADEON_KMS
name|DRM_INFO
argument_list|(
literal|"radeon defaulting to kernel modesetting.\n"
argument_list|)
expr_stmt|;
name|radeon_modeset
operator|=
literal|1
expr_stmt|;
else|#
directive|else
name|DRM_INFO
argument_list|(
literal|"radeon defaulting to userspace modesetting.\n"
argument_list|)
expr_stmt|;
name|radeon_modeset
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|radeon_modeset
operator|==
literal|1
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"radeon kernel modesetting enabled.\n"
argument_list|)
expr_stmt|;
name|driver
operator|=
operator|&
name|kms_driver
expr_stmt|;
name|pdriver
operator|=
operator|&
name|radeon_kms_pci_driver
expr_stmt|;
name|driver
operator|->
name|driver_features
operator||=
name|DRIVER_MODESET
expr_stmt|;
name|driver
operator|->
name|num_ioctls
operator|=
name|radeon_max_kms_ioctl
expr_stmt|;
name|radeon_register_atpx_handler
argument_list|()
expr_stmt|;
block|}
comment|/* if the vga console setting is enabled still 	 * let modprobe override it */
return|return
name|drm_pci_init
argument_list|(
name|driver
argument_list|,
name|pdriver
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__exit
name|radeon_exit
parameter_list|(
name|void
parameter_list|)
block|{
name|drm_pci_exit
argument_list|(
name|driver
argument_list|,
name|pdriver
argument_list|)
expr_stmt|;
name|radeon_unregister_atpx_handler
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FREEBSD_WIP */
end_comment

begin_comment
comment|/* =================================================================== */
end_comment

begin_function
specifier|static
name|int
name|radeon_probe
parameter_list|(
name|device_t
name|kdev
parameter_list|)
block|{
return|return
operator|(
operator|-
name|drm_probe_helper
argument_list|(
name|kdev
argument_list|,
name|pciidlist
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_attach
parameter_list|(
name|device_t
name|kdev
parameter_list|)
block|{
if|if
condition|(
name|radeon_modeset
operator|==
literal|1
condition|)
block|{
name|kms_driver
operator|.
name|driver_features
operator||=
name|DRIVER_MODESET
expr_stmt|;
name|kms_driver
operator|.
name|num_ioctls
operator|=
name|radeon_max_kms_ioctl
expr_stmt|;
ifdef|#
directive|ifdef
name|COMPAT_FREEBSD32
name|kms_driver
operator|.
name|compat_ioctls
operator|=
name|radeon_compat_ioctls
expr_stmt|;
name|kms_driver
operator|.
name|num_compat_ioctls
operator|=
operator|&
name|radeon_num_compat_ioctls
expr_stmt|;
endif|#
directive|endif
name|radeon_register_atpx_handler
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
operator|-
name|drm_attach_helper
argument_list|(
name|kdev
argument_list|,
name|pciidlist
argument_list|,
operator|&
name|kms_driver
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_suspend
parameter_list|(
name|device_t
name|kdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|dev
operator|=
name|device_get_softc
argument_list|(
name|kdev
argument_list|)
expr_stmt|;
name|ret
operator|=
name|radeon_suspend_kms
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|(
operator|-
name|ret
operator|)
return|;
name|ret
operator|=
name|bus_generic_suspend
argument_list|(
name|kdev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_resume
parameter_list|(
name|device_t
name|kdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|dev
operator|=
name|device_get_softc
argument_list|(
name|kdev
argument_list|)
expr_stmt|;
name|ret
operator|=
name|radeon_resume_kms
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|(
operator|-
name|ret
operator|)
return|;
name|ret
operator|=
name|bus_generic_resume
argument_list|(
name|kdev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function_decl
specifier|extern
name|struct
name|fb_info
modifier|*
name|radeon_fb_helper_getinfo
parameter_list|(
name|device_t
name|kdev
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|radeon_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|radeon_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|radeon_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|radeon_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|radeon_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|drm_generic_detach
argument_list|)
block|,
comment|/* Framebuffer service methods */
name|DEVMETHOD
argument_list|(
name|fb_getinfo
argument_list|,
name|radeon_fb_helper_getinfo
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|radeon_driver
init|=
block|{
literal|"drmn"
block|,
name|radeon_methods
block|,
expr|sizeof
operator|(
expr|struct
name|drm_device
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|devclass_t
name|drm_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE_ORDERED
argument_list|(
name|radeonkms
argument_list|,
name|vgapci
argument_list|,
name|radeon_driver
argument_list|,
name|drm_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|SI_ORDER_ANY
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|radeonkms
argument_list|,
name|drmn
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|radeonkms
argument_list|,
name|agp
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|radeonkms
argument_list|,
name|iicbus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|radeonkms
argument_list|,
name|iic
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|radeonkms
argument_list|,
name|iicbb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|radeonkms
argument_list|,
name|firmware
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


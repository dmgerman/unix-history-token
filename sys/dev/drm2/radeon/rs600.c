begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_comment
comment|/* RS600 / Radeon X1250/X1270 integrated GPU  *  * This file gather function specific to RS600 which is the IGP of  * the X1250/X1270 family supporting intel CPU (while RS690/RS740  * is the X1250/X1270 supporting AMD CPU). The display engine are  * the avivo one, bios is an atombios, 3D block are the one of the  * R4XX family. The GART is different from the RS400 one and is very  * close to the one of the R600 family (R600 likely being an evolution  * of the RS600 GART block).  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"rs600d.h"
end_include

begin_include
include|#
directive|include
file|"rs600_reg_safe.h"
end_include

begin_function_decl
specifier|static
name|void
name|rs600_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|crtc_offsets
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
name|AVIVO_D2CRTC_H_TOTAL
operator|-
name|AVIVO_D1CRTC_H_TOTAL
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|avivo_wait_for_vblank
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|crtc
operator|>=
name|rdev
operator|->
name|num_crtc
condition|)
return|return;
if|if
condition|(
name|RREG32
argument_list|(
name|AVIVO_D1CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|crtc
index|]
argument_list|)
operator|&
name|AVIVO_CRTC_EN
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|AVIVO_D1CRTC_STATUS
operator|+
name|crtc_offsets
index|[
name|crtc
index|]
argument_list|)
operator|&
name|AVIVO_D1CRTC_V_BLANK
operator|)
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|AVIVO_D1CRTC_STATUS
operator|+
name|crtc_offsets
index|[
name|crtc
index|]
argument_list|)
operator|&
name|AVIVO_D1CRTC_V_BLANK
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|rs600_pre_page_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
comment|/* enable the pflip int */
name|radeon_irq_kms_pflip_irq_get
argument_list|(
name|rdev
argument_list|,
name|crtc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rs600_post_page_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
comment|/* disable the pflip int */
name|radeon_irq_kms_pflip_irq_put
argument_list|(
name|rdev
argument_list|,
name|crtc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u32
name|rs600_page_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc_id
parameter_list|,
name|u64
name|crtc_base
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|crtc_id
index|]
decl_stmt|;
name|u32
name|tmp
init|=
name|RREG32
argument_list|(
name|AVIVO_D1GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Lock the graphics update lock */
name|tmp
operator||=
name|AVIVO_D1GRPH_UPDATE_LOCK
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* update the scanout addresses */
name|WREG32
argument_list|(
name|AVIVO_D1GRPH_SECONDARY_SURFACE_ADDRESS
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|u32
operator|)
name|crtc_base
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1GRPH_PRIMARY_SURFACE_ADDRESS
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|u32
operator|)
name|crtc_base
argument_list|)
expr_stmt|;
comment|/* Wait for update_pending to go high. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|AVIVO_D1GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
operator|&
name|AVIVO_D1GRPH_SURFACE_UPDATE_PENDING
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"Update pending now high. Unlocking vupdate_lock.\n"
argument_list|)
expr_stmt|;
comment|/* Unlock the lock, so double-buffering can take place inside vblank */
name|tmp
operator|&=
operator|~
name|AVIVO_D1GRPH_UPDATE_LOCK
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Return current update_pending status: */
return|return
name|RREG32
argument_list|(
name|AVIVO_D1GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
operator|&
name|AVIVO_D1GRPH_SURFACE_UPDATE_PENDING
return|;
block|}
end_function

begin_function
name|void
name|rs600_pm_misc
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|requested_index
init|=
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
decl_stmt|;
name|struct
name|radeon_power_state
modifier|*
name|ps
init|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|requested_index
index|]
decl_stmt|;
name|struct
name|radeon_voltage
modifier|*
name|voltage
init|=
operator|&
name|ps
operator|->
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
decl_stmt|;
name|u32
name|tmp
decl_stmt|,
name|dyn_pwrmgt_sclk_length
decl_stmt|,
name|dyn_sclk_vol_cntl
decl_stmt|;
name|u32
name|hdp_dyn_cntl
decl_stmt|,
comment|/*mc_host_dyn_cntl,*/
name|dyn_backbias_cntl
decl_stmt|;
if|if
condition|(
operator|(
name|voltage
operator|->
name|type
operator|==
name|VOLTAGE_GPIO
operator|)
operator|&&
operator|(
name|voltage
operator|->
name|gpio
operator|.
name|valid
operator|)
condition|)
block|{
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_SUPPORT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|voltage
operator|->
name|gpio
operator|.
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|voltage
operator|->
name|active_high
condition|)
name|tmp
operator||=
name|voltage
operator|->
name|gpio
operator|.
name|mask
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
operator|(
name|voltage
operator|->
name|gpio
operator|.
name|mask
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|voltage
operator|->
name|gpio
operator|.
name|reg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|voltage
operator|->
name|delay
condition|)
name|DRM_UDELAY
argument_list|(
name|voltage
operator|->
name|delay
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|voltage
operator|->
name|gpio
operator|.
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|voltage
operator|->
name|active_high
condition|)
name|tmp
operator|&=
operator|~
name|voltage
operator|->
name|gpio
operator|.
name|mask
expr_stmt|;
else|else
name|tmp
operator||=
name|voltage
operator|->
name|gpio
operator|.
name|mask
expr_stmt|;
name|WREG32
argument_list|(
name|voltage
operator|->
name|gpio
operator|.
name|reg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|voltage
operator|->
name|delay
condition|)
name|DRM_UDELAY
argument_list|(
name|voltage
operator|->
name|delay
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|voltage
operator|->
name|type
operator|==
name|VOLTAGE_VDDC
condition|)
name|radeon_atom_set_voltage
argument_list|(
name|rdev
argument_list|,
name|voltage
operator|->
name|vddc_id
argument_list|,
name|SET_VOLTAGE_TYPE_ASIC_VDDC
argument_list|)
expr_stmt|;
name|dyn_pwrmgt_sclk_length
operator|=
name|RREG32_PLL
argument_list|(
name|DYN_PWRMGT_SCLK_LENGTH
argument_list|)
expr_stmt|;
name|dyn_pwrmgt_sclk_length
operator|&=
operator|~
name|REDUCED_POWER_SCLK_HILEN
argument_list|(
literal|0xf
argument_list|)
expr_stmt|;
name|dyn_pwrmgt_sclk_length
operator|&=
operator|~
name|REDUCED_POWER_SCLK_LOLEN
argument_list|(
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_ASIC_REDUCED_SPEED_SCLK_EN
condition|)
block|{
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_DYNAMIC_CLOCK_DIVIDER_BY_2
condition|)
block|{
name|dyn_pwrmgt_sclk_length
operator||=
name|REDUCED_POWER_SCLK_HILEN
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|dyn_pwrmgt_sclk_length
operator||=
name|REDUCED_POWER_SCLK_LOLEN
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_DYNAMIC_CLOCK_DIVIDER_BY_4
condition|)
block|{
name|dyn_pwrmgt_sclk_length
operator||=
name|REDUCED_POWER_SCLK_HILEN
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|dyn_pwrmgt_sclk_length
operator||=
name|REDUCED_POWER_SCLK_LOLEN
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|dyn_pwrmgt_sclk_length
operator||=
name|REDUCED_POWER_SCLK_HILEN
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dyn_pwrmgt_sclk_length
operator||=
name|REDUCED_POWER_SCLK_LOLEN
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|WREG32_PLL
argument_list|(
name|DYN_PWRMGT_SCLK_LENGTH
argument_list|,
name|dyn_pwrmgt_sclk_length
argument_list|)
expr_stmt|;
name|dyn_sclk_vol_cntl
operator|=
name|RREG32_PLL
argument_list|(
name|DYN_SCLK_VOL_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_ASIC_DYNAMIC_VOLTAGE_EN
condition|)
block|{
name|dyn_sclk_vol_cntl
operator||=
name|IO_CG_VOLTAGE_DROP
expr_stmt|;
if|if
condition|(
name|voltage
operator|->
name|delay
condition|)
block|{
name|dyn_sclk_vol_cntl
operator||=
name|VOLTAGE_DROP_SYNC
expr_stmt|;
name|dyn_sclk_vol_cntl
operator||=
name|VOLTAGE_DELAY_SEL
argument_list|(
name|voltage
operator|->
name|delay
argument_list|)
expr_stmt|;
block|}
else|else
name|dyn_sclk_vol_cntl
operator|&=
operator|~
name|VOLTAGE_DROP_SYNC
expr_stmt|;
block|}
else|else
name|dyn_sclk_vol_cntl
operator|&=
operator|~
name|IO_CG_VOLTAGE_DROP
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|DYN_SCLK_VOL_CNTL
argument_list|,
name|dyn_sclk_vol_cntl
argument_list|)
expr_stmt|;
name|hdp_dyn_cntl
operator|=
name|RREG32_PLL
argument_list|(
name|HDP_DYN_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_DYNAMIC_HDP_BLOCK_EN
condition|)
name|hdp_dyn_cntl
operator|&=
operator|~
name|HDP_FORCEON
expr_stmt|;
else|else
name|hdp_dyn_cntl
operator||=
name|HDP_FORCEON
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|HDP_DYN_CNTL
argument_list|,
name|hdp_dyn_cntl
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* mc_host_dyn seems to cause hangs from time to time */
block|mc_host_dyn_cntl = RREG32_PLL(MC_HOST_DYN_CNTL); 	if (ps->misc& ATOM_PM_MISCINFO_DYNAMIC_MC_HOST_BLOCK_EN) 		mc_host_dyn_cntl&= ~MC_HOST_FORCEON; 	else 		mc_host_dyn_cntl |= MC_HOST_FORCEON; 	WREG32_PLL(MC_HOST_DYN_CNTL, mc_host_dyn_cntl);
endif|#
directive|endif
name|dyn_backbias_cntl
operator|=
name|RREG32_PLL
argument_list|(
name|DYN_BACKBIAS_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO2_DYNAMIC_BACK_BIAS_EN
condition|)
name|dyn_backbias_cntl
operator||=
name|IO_CG_BACKBIAS_EN
expr_stmt|;
else|else
name|dyn_backbias_cntl
operator|&=
operator|~
name|IO_CG_BACKBIAS_EN
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|DYN_BACKBIAS_CNTL
argument_list|,
name|dyn_backbias_cntl
argument_list|)
expr_stmt|;
comment|/* set pcie lanes */
if|if
condition|(
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
operator|)
operator|&&
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
operator|&&
name|rdev
operator|->
name|asic
operator|->
name|pm
operator|.
name|set_pcie_lanes
operator|&&
operator|(
name|ps
operator|->
name|pcie_lanes
operator|!=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
index|]
operator|.
name|pcie_lanes
operator|)
condition|)
block|{
name|radeon_set_pcie_lanes
argument_list|(
name|rdev
argument_list|,
name|ps
operator|->
name|pcie_lanes
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"Setting: p: %d\n"
argument_list|,
name|ps
operator|->
name|pcie_lanes
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|rs600_pm_prepare
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|ddev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* disable any active CRTCs */
name|list_for_each_entry
argument_list|(
argument|crtc
argument_list|,
argument|&ddev->mode_config.crtc_list
argument_list|,
argument|head
argument_list|)
block|{
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|enabled
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1CRTC_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|AVIVO_CRTC_DISP_READ_REQUEST_DISABLE
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1CRTC_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|rs600_pm_finish
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|ddev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* enable any active CRTCs */
name|list_for_each_entry
argument_list|(
argument|crtc
argument_list|,
argument|&ddev->mode_config.crtc_list
argument_list|,
argument|head
argument_list|)
block|{
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|enabled
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1CRTC_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|AVIVO_CRTC_DISP_READ_REQUEST_DISABLE
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1CRTC_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* hpd for digital panel detect/disconnect */
end_comment

begin_function
name|bool
name|rs600_hpd_sense
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|enum
name|radeon_hpd_id
name|hpd
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|bool
name|connected
init|=
name|false
decl_stmt|;
switch|switch
condition|(
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_007D04_DC_HOT_PLUG_DETECT1_INT_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|G_007D04_DC_HOT_PLUG_DETECT1_SENSE
argument_list|(
name|tmp
argument_list|)
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_007D14_DC_HOT_PLUG_DETECT2_INT_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|G_007D14_DC_HOT_PLUG_DETECT2_SENSE
argument_list|(
name|tmp
argument_list|)
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|connected
return|;
block|}
end_function

begin_function
name|void
name|rs600_hpd_set_polarity
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|enum
name|radeon_hpd_id
name|hpd
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|bool
name|connected
init|=
name|rs600_hpd_sense
argument_list|(
name|rdev
argument_list|,
name|hpd
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_007D08_DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|S_007D08_DC_HOT_PLUG_DETECT1_INT_POLARITY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
else|else
name|tmp
operator||=
name|S_007D08_DC_HOT_PLUG_DETECT1_INT_POLARITY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_007D08_DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_007D18_DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|S_007D18_DC_HOT_PLUG_DETECT2_INT_POLARITY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
else|else
name|tmp
operator||=
name|S_007D18_DC_HOT_PLUG_DETECT2_INT_POLARITY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_007D18_DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|void
name|rs600_hpd_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|unsigned
name|enable
init|=
literal|0
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|connector
argument_list|,
argument|&dev->mode_config.connector_list
argument_list|,
argument|head
argument_list|)
block|{
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
init|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|WREG32
argument_list|(
name|R_007D00_DC_HOT_PLUG_DETECT1_CONTROL
argument_list|,
name|S_007D00_DC_HOT_PLUG_DETECT1_EN
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|WREG32
argument_list|(
name|R_007D10_DC_HOT_PLUG_DETECT2_CONTROL
argument_list|,
name|S_007D10_DC_HOT_PLUG_DETECT2_EN
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|enable
operator||=
literal|1
operator|<<
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
expr_stmt|;
name|radeon_hpd_set_polarity
argument_list|(
name|rdev
argument_list|,
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
argument_list|)
expr_stmt|;
block|}
name|radeon_irq_kms_enable_hpd
argument_list|(
name|rdev
argument_list|,
name|enable
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rs600_hpd_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|unsigned
name|disable
init|=
literal|0
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|connector
argument_list|,
argument|&dev->mode_config.connector_list
argument_list|,
argument|head
argument_list|)
block|{
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
init|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|WREG32
argument_list|(
name|R_007D00_DC_HOT_PLUG_DETECT1_CONTROL
argument_list|,
name|S_007D00_DC_HOT_PLUG_DETECT1_EN
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|WREG32
argument_list|(
name|R_007D10_DC_HOT_PLUG_DETECT2_CONTROL
argument_list|,
name|S_007D10_DC_HOT_PLUG_DETECT2_EN
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|disable
operator||=
literal|1
operator|<<
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
expr_stmt|;
block|}
name|radeon_irq_kms_disable_hpd
argument_list|(
name|rdev
argument_list|,
name|disable
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rs600_asic_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|rv515_mc_save
name|save
decl_stmt|;
name|u32
name|status
decl_stmt|,
name|tmp
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|G_000E40_GUI_ACTIVE
argument_list|(
name|status
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|/* Stops all mc clients */
name|rv515_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%s:%d) RBBM_STATUS=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* stop CP */
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|tmp
operator||
name|RADEON_RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_RPTR_WR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|pci_save_state
argument_list|(
name|device_get_parent
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* disable bus mastering */
name|pci_disable_busmaster
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* reset GA+VAP */
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
name|S_0000F0_SOFT_RESET_VAP
argument_list|(
literal|1
argument_list|)
operator||
name|S_0000F0_SOFT_RESET_GA
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%s:%d) RBBM_STATUS=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* reset CP */
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
name|S_0000F0_SOFT_RESET_CP
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%s:%d) RBBM_STATUS=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* reset MC */
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
name|S_0000F0_SOFT_RESET_MC
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%s:%d) RBBM_STATUS=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* restore PCI& busmastering */
name|pci_restore_state
argument_list|(
name|device_get_parent
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check if GPU is idle */
if|if
condition|(
name|G_000E40_GA_BUSY
argument_list|(
name|status
argument_list|)
operator|||
name|G_000E40_VAP_BUSY
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed to reset GPU\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset succeed\n"
argument_list|)
expr_stmt|;
name|rv515_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * GART.  */
end_comment

begin_function
name|void
name|rs600_gart_tlb_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|C_000100_INVALIDATE_ALL_L1_TLBS
operator|&
name|C_000100_INVALIDATE_L2_CACHE
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|S_000100_INVALIDATE_ALL_L1_TLBS
argument_list|(
literal|1
argument_list|)
operator||
name|S_000100_INVALIDATE_L2_CACHE
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|C_000100_INVALIDATE_ALL_L1_TLBS
operator|&
name|C_000100_INVALIDATE_L2_CACHE
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs600_gart_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|robj
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"RS600 GART already initialized\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Initialize common gart structure */
name|r
operator|=
name|radeon_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
name|rdev
operator|->
name|gart
operator|.
name|table_size
operator|=
name|rdev
operator|->
name|gart
operator|.
name|num_gpu_pages
operator|*
literal|8
expr_stmt|;
return|return
name|radeon_gart_table_vram_alloc
argument_list|(
name|rdev
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs600_gart_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|r
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"No VRAM object for PCIE GART.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_gart_table_vram_pin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|radeon_gart_restore
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Enable bus master */
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
operator|&
operator|~
name|RS600_BUS_MASTER_DIS
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* FIXME: setup default page */
name|WREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|,
operator|(
name|S_000100_EFFECTIVE_L2_CACHE_SIZE
argument_list|(
literal|6
argument_list|)
operator||
name|S_000100_EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|6
argument_list|)
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|19
condition|;
name|i
operator|++
control|)
block|{
name|WREG32_MC
argument_list|(
name|R_00016C_MC_PT0_CLIENT0_CNTL
operator|+
name|i
argument_list|,
name|S_00016C_ENABLE_TRANSLATION_MODE_OVERRIDE
argument_list|(
literal|1
argument_list|)
operator||
name|S_00016C_SYSTEM_ACCESS_MODE_MASK
argument_list|(
name|V_00016C_SYSTEM_ACCESS_MODE_NOT_IN_SYS
argument_list|)
operator||
name|S_00016C_SYSTEM_APERTURE_UNMAPPED_ACCESS
argument_list|(
name|V_00016C_SYSTEM_APERTURE_UNMAPPED_PASSTHROUGH
argument_list|)
operator||
name|S_00016C_EFFECTIVE_L1_CACHE_SIZE
argument_list|(
literal|3
argument_list|)
operator||
name|S_00016C_ENABLE_FRAGMENT_PROCESSING
argument_list|(
literal|1
argument_list|)
operator||
name|S_00016C_EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* enable first context */
name|WREG32_MC
argument_list|(
name|R_000102_MC_PT0_CONTEXT0_CNTL
argument_list|,
name|S_000102_ENABLE_PAGE_TABLE
argument_list|(
literal|1
argument_list|)
operator||
name|S_000102_PAGE_TABLE_DEPTH
argument_list|(
name|V_000102_PAGE_TABLE_FLAT
argument_list|)
argument_list|)
expr_stmt|;
comment|/* disable all other contexts */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|WREG32_MC
argument_list|(
name|R_000102_MC_PT0_CONTEXT0_CNTL
operator|+
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* setup the page table */
name|WREG32_MC
argument_list|(
name|R_00012C_MC_PT0_CONTEXT0_FLAT_BASE_ADDR
argument_list|,
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_00013C_MC_PT0_CONTEXT0_FLAT_START_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_00014C_MC_PT0_CONTEXT0_FLAT_END_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_00011C_MC_PT0_CONTEXT0_DEFAULT_READ_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* System context maps to VRAM space */
name|WREG32_MC
argument_list|(
name|R_000112_MC_PT0_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000114_MC_PT0_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_end
argument_list|)
expr_stmt|;
comment|/* enable page tables */
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|,
operator|(
name|tmp
operator||
name|S_000100_ENABLE_PT
argument_list|(
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R_000009_MC_CNTL1
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000009_MC_CNTL1
argument_list|,
operator|(
name|tmp
operator||
name|S_000009_ENABLE_PAGE_TABLES
argument_list|(
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|rs600_gart_tlb_flush
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"PCIE GART of %uM enabled (table at 0x%016llX).\n"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|ready
operator|=
name|true
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs600_gart_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
comment|/* FIXME: disable out of gart access */
name|WREG32_MC
argument_list|(
name|R_000100_MC_PT0_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R_000009_MC_CNTL1
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000009_MC_CNTL1
argument_list|,
name|tmp
operator|&
name|C_000009_ENABLE_PAGE_TABLES
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_unpin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs600_gart_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|radeon_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs600_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_free
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|R600_PTE_VALID
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|R600_PTE_SYSTEM
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|R600_PTE_SNOOPED
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|R600_PTE_READABLE
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|R600_PTE_WRITEABLE
value|(1<< 6)
end_define

begin_function
name|int
name|rs600_gart_set_page
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|i
parameter_list|,
name|uint64_t
name|addr
parameter_list|)
block|{
name|uint64_t
modifier|*
name|ptr
init|=
name|rdev
operator|->
name|gart
operator|.
name|ptr
decl_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
operator|||
name|i
operator|>
name|rdev
operator|->
name|gart
operator|.
name|num_gpu_pages
condition|)
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
name|addr
operator|=
name|addr
operator|&
literal|0xFFFFFFFFFFFFF000ULL
expr_stmt|;
name|addr
operator||=
name|R600_PTE_VALID
operator||
name|R600_PTE_SYSTEM
operator||
name|R600_PTE_SNOOPED
expr_stmt|;
name|addr
operator||=
name|R600_PTE_READABLE
operator||
name|R600_PTE_WRITEABLE
expr_stmt|;
name|ptr
index|[
name|i
index|]
operator|=
name|addr
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rs600_irq_set
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
init|=
literal|0
decl_stmt|;
name|uint32_t
name|mode_int
init|=
literal|0
decl_stmt|;
name|u32
name|hpd1
init|=
name|RREG32
argument_list|(
name|R_007D08_DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|)
operator|&
operator|~
name|S_007D08_DC_HOT_PLUG_DETECT1_INT_EN
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|u32
name|hpd2
init|=
name|RREG32
argument_list|(
name|R_007D18_DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|)
operator|&
operator|~
name|S_007D18_DC_HOT_PLUG_DETECT2_INT_EN
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|u32
name|hdmi0
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE2
argument_list|(
name|rdev
argument_list|)
condition|)
name|hdmi0
operator|=
name|RREG32
argument_list|(
name|R_007408_HDMI0_AUDIO_PACKET_CONTROL
argument_list|)
operator|&
operator|~
name|S_007408_HDMI0_AZ_FORMAT_WTRIG_MASK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
else|else
name|hdmi0
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|irq
operator|.
name|installed
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Can't enable IRQ/MSI because no handler is installed\n"
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000040_GEN_INT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|)
condition|)
block|{
name|tmp
operator||=
name|S_000040_SW_INT_EN
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|0
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|mode_int
operator||=
name|S_006540_D1MODE_VBLANK_INT_MASK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|1
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|mode_int
operator||=
name|S_006540_D2MODE_VBLANK_INT_MASK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|0
index|]
condition|)
block|{
name|hpd1
operator||=
name|S_007D08_DC_HOT_PLUG_DETECT1_INT_EN
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|1
index|]
condition|)
block|{
name|hpd2
operator||=
name|S_007D18_DC_HOT_PLUG_DETECT2_INT_EN
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|afmt
index|[
literal|0
index|]
condition|)
block|{
name|hdmi0
operator||=
name|S_007408_HDMI0_AZ_FORMAT_WTRIG_MASK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|R_000040_GEN_INT_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_006540_DxMODE_INT_MASK
argument_list|,
name|mode_int
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_007D08_DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|,
name|hpd1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_007D18_DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|,
name|hpd2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE2
argument_list|(
name|rdev
argument_list|)
condition|)
name|WREG32
argument_list|(
name|R_007408_HDMI0_AUDIO_PACKET_CONTROL
argument_list|,
name|hdmi0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|u32
name|rs600_irq_ack
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|irqs
init|=
name|RREG32
argument_list|(
name|R_000044_GEN_INT_STATUS
argument_list|)
decl_stmt|;
name|uint32_t
name|irq_mask
init|=
name|S_000044_SW_INT
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
name|G_000044_DISPLAY_INT_STAT
argument_list|(
name|irqs
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
operator|=
name|RREG32
argument_list|(
name|R_007EDC_DISP_INTERRUPT_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|G_007EDC_LB_D1_VBLANK_INTERRUPT
argument_list|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|R_006534_D1MODE_VBLANK_STATUS
argument_list|,
name|S_006534_D1MODE_VBLANK_ACK
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|G_007EDC_LB_D2_VBLANK_INTERRUPT
argument_list|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|R_006D34_D2MODE_VBLANK_STATUS
argument_list|,
name|S_006D34_D2MODE_VBLANK_ACK
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|G_007EDC_DC_HOT_PLUG_DETECT1_INTERRUPT
argument_list|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_007D08_DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|S_007D08_DC_HOT_PLUG_DETECT1_INT_ACK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_007D08_DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|G_007EDC_DC_HOT_PLUG_DETECT2_INTERRUPT
argument_list|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_007D18_DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|S_007D18_DC_HOT_PLUG_DETECT2_INT_ACK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_007D18_DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ASIC_IS_DCE2
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|hdmi0_status
operator|=
name|RREG32
argument_list|(
name|R_007404_HDMI0_STATUS
argument_list|)
operator|&
name|S_007404_HDMI0_AZ_FORMAT_WTRIG
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|G_007404_HDMI0_AZ_FORMAT_WTRIG
argument_list|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|hdmi0_status
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_007408_HDMI0_AUDIO_PACKET_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|S_007408_HDMI0_AZ_FORMAT_WTRIG_ACK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_007408_HDMI0_AUDIO_PACKET_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|hdmi0_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|irqs
condition|)
block|{
name|WREG32
argument_list|(
name|R_000044_GEN_INT_STATUS
argument_list|,
name|irqs
argument_list|)
expr_stmt|;
block|}
return|return
name|irqs
operator|&
name|irq_mask
return|;
block|}
end_function

begin_function
name|void
name|rs600_irq_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|hdmi0
init|=
name|RREG32
argument_list|(
name|R_007408_HDMI0_AUDIO_PACKET_CONTROL
argument_list|)
operator|&
operator|~
name|S_007408_HDMI0_AZ_FORMAT_WTRIG_MASK
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|WREG32
argument_list|(
name|R_007408_HDMI0_AUDIO_PACKET_CONTROL
argument_list|,
name|hdmi0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000040_GEN_INT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_006540_DxMODE_INT_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Wait and acknowledge irq */
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|rs600_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|irqreturn_t
name|rs600_irq_process
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|status
decl_stmt|,
name|msi_rearm
decl_stmt|;
name|bool
name|queue_hotplug
init|=
name|false
decl_stmt|;
name|bool
name|queue_hdmi
init|=
name|false
decl_stmt|;
name|status
operator|=
name|rs600_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
operator|&&
operator|!
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
operator|&&
operator|!
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|hdmi0_status
condition|)
block|{
return|return
name|IRQ_NONE
return|;
block|}
while|while
condition|(
name|status
operator|||
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
operator|||
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|hdmi0_status
condition|)
block|{
comment|/* SW interrupt */
if|if
condition|(
name|G_000044_SW_INT
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
block|}
comment|/* Vertical blank interrupts */
if|if
condition|(
name|G_007EDC_LB_D1_VBLANK_INTERRUPT
argument_list|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
argument_list|)
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|0
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|0
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|G_007EDC_LB_D2_VBLANK_INTERRUPT
argument_list|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
argument_list|)
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|1
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|1
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|G_007EDC_DC_HOT_PLUG_DETECT1_INTERRUPT
argument_list|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
argument_list|)
condition|)
block|{
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"HPD1\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|G_007EDC_DC_HOT_PLUG_DETECT2_INTERRUPT
argument_list|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|disp_int
argument_list|)
condition|)
block|{
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"HPD2\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|G_007404_HDMI0_AZ_FORMAT_WTRIG
argument_list|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r500
operator|.
name|hdmi0_status
argument_list|)
condition|)
block|{
name|queue_hdmi
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"HDMI0\n"
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|rs600_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|queue_hotplug
condition|)
name|taskqueue_enqueue
argument_list|(
name|rdev
operator|->
name|tq
argument_list|,
operator|&
name|rdev
operator|->
name|hotplug_work
argument_list|)
expr_stmt|;
if|if
condition|(
name|queue_hdmi
condition|)
name|taskqueue_enqueue
argument_list|(
name|rdev
operator|->
name|tq
argument_list|,
operator|&
name|rdev
operator|->
name|audio_work
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|msi_enabled
condition|)
block|{
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_RS600
case|:
case|case
name|CHIP_RS690
case|:
case|case
name|CHIP_RS740
case|:
name|msi_rearm
operator|=
name|RREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
operator|&
operator|~
name|RS600_MSI_REARM
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|,
name|msi_rearm
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|,
name|msi_rearm
operator||
name|RS600_MSI_REARM
argument_list|)
expr_stmt|;
break|break;
default|default:
name|WREG32
argument_list|(
name|RADEON_MSI_REARM_EN
argument_list|,
name|RV370_MSI_REARM_EN
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
name|IRQ_HANDLED
return|;
block|}
end_function

begin_function
name|u32
name|rs600_get_vblank_counter
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
if|if
condition|(
name|crtc
operator|==
literal|0
condition|)
return|return
name|RREG32
argument_list|(
name|R_0060A4_D1CRTC_STATUS_FRAME_COUNT
argument_list|)
return|;
else|else
return|return
name|RREG32
argument_list|(
name|R_0068A4_D2CRTC_STATUS_FRAME_COUNT
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|rs600_mc_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|G_000000_MC_IDLE
argument_list|(
name|RREG32_MC
argument_list|(
name|R_000000_MC_STATUS
argument_list|)
argument_list|)
condition|)
return|return
literal|0
return|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs600_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r420_pipes_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Wait for mc idle */
if|if
condition|(
name|rs600_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait MC idle timeout before updating MC.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs600_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u64
name|base
decl_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|aper_base
operator|=
name|drm_get_resource_start
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|aper_size
operator|=
name|drm_get_resource_len
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|=
name|RREG32
argument_list|(
name|RADEON_CONFIG_MEMSIZE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|mc_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_size
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|igp_sideport_enabled
operator|=
name|radeon_atombios_sideport_present
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|base
operator|=
name|RREG32_MC
argument_list|(
name|R_000004_MC_FB_LOCATION
argument_list|)
expr_stmt|;
name|base
operator|=
name|G_000004_MC_FB_START
argument_list|(
name|base
argument_list|)
operator|<<
literal|16
expr_stmt|;
name|radeon_vram_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_base_align
operator|=
literal|0
expr_stmt|;
name|radeon_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rs600_bandwidth_update
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_display_mode
modifier|*
name|mode0
init|=
name|NULL
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|mode1
init|=
name|NULL
decl_stmt|;
name|u32
name|d1mode_priority_a_cnt
decl_stmt|,
name|d2mode_priority_a_cnt
decl_stmt|;
comment|/* FIXME: implement full support */
name|radeon_update_display_priority
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
name|mode0
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
name|mode1
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
name|rs690_line_buffer_adjust
argument_list|(
name|rdev
argument_list|,
name|mode0
argument_list|,
name|mode1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
condition|)
block|{
name|d1mode_priority_a_cnt
operator|=
name|RREG32
argument_list|(
name|R_006548_D1MODE_PRIORITY_A_CNT
argument_list|)
expr_stmt|;
name|d2mode_priority_a_cnt
operator|=
name|RREG32
argument_list|(
name|R_006D48_D2MODE_PRIORITY_A_CNT
argument_list|)
expr_stmt|;
name|d1mode_priority_a_cnt
operator||=
name|S_006548_D1MODE_PRIORITY_A_ALWAYS_ON
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|d2mode_priority_a_cnt
operator||=
name|S_006D48_D2MODE_PRIORITY_A_ALWAYS_ON
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_006548_D1MODE_PRIORITY_A_CNT
argument_list|,
name|d1mode_priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_00654C_D1MODE_PRIORITY_B_CNT
argument_list|,
name|d1mode_priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_006D48_D2MODE_PRIORITY_A_CNT
argument_list|,
name|d2mode_priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_006D4C_D2MODE_PRIORITY_B_CNT
argument_list|,
name|d2mode_priority_a_cnt
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|uint32_t
name|rs600_mc_rreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|)
block|{
name|WREG32
argument_list|(
name|R_000070_MC_IND_INDEX
argument_list|,
name|S_000070_MC_IND_ADDR
argument_list|(
name|reg
argument_list|)
operator||
name|S_000070_MC_IND_CITF_ARB0
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|RREG32
argument_list|(
name|R_000074_MC_IND_DATA
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|rs600_mc_wreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|v
parameter_list|)
block|{
name|WREG32
argument_list|(
name|R_000070_MC_IND_INDEX
argument_list|,
name|S_000070_MC_IND_ADDR
argument_list|(
name|reg
argument_list|)
operator||
name|S_000070_MC_IND_CITF_ARB0
argument_list|(
literal|1
argument_list|)
operator||
name|S_000070_MC_IND_WR_EN
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000074_MC_IND_DATA
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs600_debugfs
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|r100_debugfs_rbbm_init
argument_list|(
name|rdev
argument_list|)
condition|)
name|DRM_ERROR
argument_list|(
literal|"Failed to register debugfs file for RBBM !\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rs600_set_safe_registers
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|reg_safe_bm
operator|=
name|rs600_reg_safe_bm
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|reg_safe_bm_size
operator|=
name|DRM_ARRAY_SIZE
argument_list|(
name|rs600_reg_safe_bm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs600_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|rv515_mc_save
name|save
decl_stmt|;
comment|/* Stops all mc clients */
name|rv515_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
comment|/* Wait for mc idle */
if|if
condition|(
name|rs600_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait MC idle timeout before updating MC.\n"
argument_list|)
expr_stmt|;
comment|/* FIXME: What does AGP means for such chipset ? */
name|WREG32_MC
argument_list|(
name|R_000005_MC_AGP_LOCATION
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000006_AGP_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000007_AGP_BASE_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Program MC */
name|WREG32_MC
argument_list|(
name|R_000004_MC_FB_LOCATION
argument_list|,
name|S_000004_MC_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
operator||
name|S_000004_MC_FB_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000134_HDP_FB_LOCATION
argument_list|,
name|S_000134_HDP_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|rv515_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs600_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|rs600_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GPU configuration (# pipes, ...) */
name|rs600_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GART (initialize after TTM so we can allocate 	 * memory through TTM but finalize after TTM) */
name|r
operator|=
name|rs600_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|rs600_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|hdp_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
comment|/* 1M ring buffer */
name|r
operator|=
name|r100_cp_init
argument_list|(
name|rdev
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|r600_audio_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing audio\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rs600_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Make sur GART are not working */
name|rs600_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock before doing reset */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* post */
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
comment|/* Resume clock after posting */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|rs600_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|rs600_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_audio_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_cp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs600_irq_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs600_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|rs600_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_audio_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs600_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rs600_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Disable VGA */
name|rv515_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize scratch registers */
name|radeon_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* restore some register to sane defaults */
name|r100_restore_sanity
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* BIOS */
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|r
operator|=
name|radeon_atombios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
else|else
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting atombios for RS600 GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* check if cards are posted or not */
if|if
condition|(
name|radeon_boot_test_post_card
argument_list|(
name|rdev
argument_list|)
operator|==
name|false
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* initialize memory controller */
name|rs600_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs600_debugfs
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|rs600_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rs600_set_safe_registers
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|rs600_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
comment|/* Somethings want wront with the accel init stop accel */
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs600_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


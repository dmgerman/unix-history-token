begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2007-8 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc_helper.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_fixed.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_function
specifier|static
name|void
name|radeon_overscan_setup
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|WREG32
argument_list|(
name|RADEON_OVR_CLR
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_OVR_WID_LEFT_RIGHT
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_OVR_WID_TOP_BOTTOM
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_rmx_mode_set
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|int
name|xres
init|=
name|mode
operator|->
name|hdisplay
decl_stmt|;
name|int
name|yres
init|=
name|mode
operator|->
name|vdisplay
decl_stmt|;
name|bool
name|hscale
init|=
name|true
decl_stmt|,
name|vscale
init|=
name|true
decl_stmt|;
name|int
name|hsync_wid
decl_stmt|;
name|int
name|vsync_wid
decl_stmt|;
name|int
name|hsync_start
decl_stmt|;
name|int
name|blank_width
decl_stmt|;
name|u32
name|scale
decl_stmt|,
name|inc
decl_stmt|,
name|crtc_more_cntl
decl_stmt|;
name|u32
name|fp_horz_stretch
decl_stmt|,
name|fp_vert_stretch
decl_stmt|,
name|fp_horz_vert_active
decl_stmt|;
name|u32
name|fp_h_sync_strt_wid
decl_stmt|,
name|fp_crtc_h_total_disp
decl_stmt|;
name|u32
name|fp_v_sync_strt_wid
decl_stmt|,
name|fp_crtc_v_total_disp
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|native_mode
init|=
operator|&
name|radeon_crtc
operator|->
name|native_mode
decl_stmt|;
name|fp_vert_stretch
operator|=
name|RREG32
argument_list|(
name|RADEON_FP_VERT_STRETCH
argument_list|)
operator|&
operator|(
name|RADEON_VERT_STRETCH_RESERVED
operator||
name|RADEON_VERT_AUTO_RATIO_INC
operator|)
expr_stmt|;
name|fp_horz_stretch
operator|=
name|RREG32
argument_list|(
name|RADEON_FP_HORZ_STRETCH
argument_list|)
operator|&
operator|(
name|RADEON_HORZ_FP_LOOP_STRETCH
operator||
name|RADEON_HORZ_AUTO_RATIO_INC
operator|)
expr_stmt|;
name|crtc_more_cntl
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS100
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS200
operator|)
condition|)
block|{
comment|/* This is to workaround the asic bug for RMX, some versions 		   of BIOS dosen't have this register initialized correctly. */
name|crtc_more_cntl
operator||=
name|RADEON_CRTC_H_CUTOFF_ACTIVE_EN
expr_stmt|;
block|}
name|fp_crtc_h_total_disp
operator|=
operator|(
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_htotal
operator|/
literal|8
operator|)
operator|-
literal|1
operator|)
operator|&
literal|0x3ff
operator|)
operator||
operator|(
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_hdisplay
operator|/
literal|8
operator|)
operator|-
literal|1
operator|)
operator|&
literal|0x1ff
operator|)
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
name|hsync_wid
operator|=
operator|(
name|mode
operator|->
name|crtc_hsync_end
operator|-
name|mode
operator|->
name|crtc_hsync_start
operator|)
operator|/
literal|8
expr_stmt|;
if|if
condition|(
operator|!
name|hsync_wid
condition|)
name|hsync_wid
operator|=
literal|1
expr_stmt|;
name|hsync_start
operator|=
name|mode
operator|->
name|crtc_hsync_start
operator|-
literal|8
expr_stmt|;
name|fp_h_sync_strt_wid
operator|=
operator|(
operator|(
name|hsync_start
operator|&
literal|0x1fff
operator|)
operator||
operator|(
operator|(
name|hsync_wid
operator|&
literal|0x3f
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_NHSYNC
operator|)
condition|?
name|RADEON_CRTC_H_SYNC_POL
else|:
literal|0
operator|)
operator|)
expr_stmt|;
name|fp_crtc_v_total_disp
operator|=
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_vtotal
operator|-
literal|1
operator|)
operator|&
literal|0xffff
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|crtc_vdisplay
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
name|vsync_wid
operator|=
name|mode
operator|->
name|crtc_vsync_end
operator|-
name|mode
operator|->
name|crtc_vsync_start
expr_stmt|;
if|if
condition|(
operator|!
name|vsync_wid
condition|)
name|vsync_wid
operator|=
literal|1
expr_stmt|;
name|fp_v_sync_strt_wid
operator|=
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_vsync_start
operator|-
literal|1
operator|)
operator|&
literal|0xfff
operator|)
operator||
operator|(
operator|(
name|vsync_wid
operator|&
literal|0x1f
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_NVSYNC
operator|)
condition|?
name|RADEON_CRTC_V_SYNC_POL
else|:
literal|0
operator|)
operator|)
expr_stmt|;
name|fp_horz_vert_active
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|native_mode
operator|->
name|hdisplay
operator|==
literal|0
operator|||
name|native_mode
operator|->
name|vdisplay
operator|==
literal|0
condition|)
block|{
name|hscale
operator|=
name|false
expr_stmt|;
name|vscale
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|xres
operator|>
name|native_mode
operator|->
name|hdisplay
condition|)
name|xres
operator|=
name|native_mode
operator|->
name|hdisplay
expr_stmt|;
if|if
condition|(
name|yres
operator|>
name|native_mode
operator|->
name|vdisplay
condition|)
name|yres
operator|=
name|native_mode
operator|->
name|vdisplay
expr_stmt|;
if|if
condition|(
name|xres
operator|==
name|native_mode
operator|->
name|hdisplay
condition|)
name|hscale
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|yres
operator|==
name|native_mode
operator|->
name|vdisplay
condition|)
name|vscale
operator|=
name|false
expr_stmt|;
block|}
switch|switch
condition|(
name|radeon_crtc
operator|->
name|rmx_type
condition|)
block|{
case|case
name|RMX_FULL
case|:
case|case
name|RMX_ASPECT
case|:
if|if
condition|(
operator|!
name|hscale
condition|)
name|fp_horz_stretch
operator||=
operator|(
operator|(
name|xres
operator|/
literal|8
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
else|else
block|{
name|inc
operator|=
operator|(
name|fp_horz_stretch
operator|&
name|RADEON_HORZ_AUTO_RATIO_INC
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|scale
operator|=
operator|(
operator|(
name|xres
operator|+
name|inc
operator|)
operator|*
name|RADEON_HORZ_STRETCH_RATIO_MAX
operator|)
operator|/
name|native_mode
operator|->
name|hdisplay
operator|+
literal|1
expr_stmt|;
name|fp_horz_stretch
operator||=
operator|(
operator|(
operator|(
name|scale
operator|)
operator|&
name|RADEON_HORZ_STRETCH_RATIO_MASK
operator|)
operator||
name|RADEON_HORZ_STRETCH_BLEND
operator||
name|RADEON_HORZ_STRETCH_ENABLE
operator||
operator|(
operator|(
name|native_mode
operator|->
name|hdisplay
operator|/
literal|8
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|vscale
condition|)
name|fp_vert_stretch
operator||=
operator|(
operator|(
name|yres
operator|-
literal|1
operator|)
operator|<<
literal|12
operator|)
expr_stmt|;
else|else
block|{
name|inc
operator|=
operator|(
name|fp_vert_stretch
operator|&
name|RADEON_VERT_AUTO_RATIO_INC
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|scale
operator|=
operator|(
operator|(
name|yres
operator|+
name|inc
operator|)
operator|*
name|RADEON_VERT_STRETCH_RATIO_MAX
operator|)
operator|/
name|native_mode
operator|->
name|vdisplay
operator|+
literal|1
expr_stmt|;
name|fp_vert_stretch
operator||=
operator|(
operator|(
operator|(
name|scale
operator|)
operator|&
name|RADEON_VERT_STRETCH_RATIO_MASK
operator|)
operator||
name|RADEON_VERT_STRETCH_ENABLE
operator||
name|RADEON_VERT_STRETCH_BLEND
operator||
operator|(
operator|(
name|native_mode
operator|->
name|vdisplay
operator|-
literal|1
operator|)
operator|<<
literal|12
operator|)
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|RMX_CENTER
case|:
name|fp_horz_stretch
operator||=
operator|(
operator|(
name|xres
operator|/
literal|8
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|fp_vert_stretch
operator||=
operator|(
operator|(
name|yres
operator|-
literal|1
operator|)
operator|<<
literal|12
operator|)
expr_stmt|;
name|crtc_more_cntl
operator||=
operator|(
name|RADEON_CRTC_AUTO_HORZ_CENTER_EN
operator||
name|RADEON_CRTC_AUTO_VERT_CENTER_EN
operator|)
expr_stmt|;
name|blank_width
operator|=
operator|(
name|mode
operator|->
name|crtc_hblank_end
operator|-
name|mode
operator|->
name|crtc_hblank_start
operator|)
operator|/
literal|8
expr_stmt|;
if|if
condition|(
name|blank_width
operator|>
literal|110
condition|)
name|blank_width
operator|=
literal|110
expr_stmt|;
name|fp_crtc_h_total_disp
operator|=
operator|(
operator|(
operator|(
name|blank_width
operator|)
operator|&
literal|0x3ff
operator|)
operator||
operator|(
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_hdisplay
operator|/
literal|8
operator|)
operator|-
literal|1
operator|)
operator|&
literal|0x1ff
operator|)
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
name|hsync_wid
operator|=
operator|(
name|mode
operator|->
name|crtc_hsync_end
operator|-
name|mode
operator|->
name|crtc_hsync_start
operator|)
operator|/
literal|8
expr_stmt|;
if|if
condition|(
operator|!
name|hsync_wid
condition|)
name|hsync_wid
operator|=
literal|1
expr_stmt|;
name|fp_h_sync_strt_wid
operator|=
operator|(
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_hsync_start
operator|-
name|mode
operator|->
name|crtc_hblank_start
operator|)
operator|/
literal|8
operator|)
operator|&
literal|0x1fff
operator|)
operator||
operator|(
operator|(
name|hsync_wid
operator|&
literal|0x3f
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_NHSYNC
operator|)
condition|?
name|RADEON_CRTC_H_SYNC_POL
else|:
literal|0
operator|)
operator|)
expr_stmt|;
name|fp_crtc_v_total_disp
operator|=
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_vblank_end
operator|-
name|mode
operator|->
name|crtc_vblank_start
operator|)
operator|&
literal|0xffff
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|crtc_vdisplay
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
name|vsync_wid
operator|=
name|mode
operator|->
name|crtc_vsync_end
operator|-
name|mode
operator|->
name|crtc_vsync_start
expr_stmt|;
if|if
condition|(
operator|!
name|vsync_wid
condition|)
name|vsync_wid
operator|=
literal|1
expr_stmt|;
name|fp_v_sync_strt_wid
operator|=
operator|(
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_vsync_start
operator|-
name|mode
operator|->
name|crtc_vblank_start
operator|)
operator|&
literal|0xfff
operator|)
operator||
operator|(
operator|(
name|vsync_wid
operator|&
literal|0x1f
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_NVSYNC
operator|)
condition|?
name|RADEON_CRTC_V_SYNC_POL
else|:
literal|0
operator|)
operator|)
operator|)
expr_stmt|;
name|fp_horz_vert_active
operator|=
operator|(
operator|(
operator|(
name|native_mode
operator|->
name|vdisplay
operator|)
operator|&
literal|0xfff
operator|)
operator||
operator|(
operator|(
operator|(
name|native_mode
operator|->
name|hdisplay
operator|/
literal|8
operator|)
operator|&
literal|0x1ff
operator|)
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
break|break;
case|case
name|RMX_OFF
case|:
default|default:
name|fp_horz_stretch
operator||=
operator|(
operator|(
name|xres
operator|/
literal|8
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|fp_vert_stretch
operator||=
operator|(
operator|(
name|yres
operator|-
literal|1
operator|)
operator|<<
literal|12
operator|)
expr_stmt|;
break|break;
block|}
name|WREG32
argument_list|(
name|RADEON_FP_HORZ_STRETCH
argument_list|,
name|fp_horz_stretch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP_VERT_STRETCH
argument_list|,
name|fp_vert_stretch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_MORE_CNTL
argument_list|,
name|crtc_more_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP_HORZ_VERT_ACTIVE
argument_list|,
name|fp_horz_vert_active
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP_H_SYNC_STRT_WID
argument_list|,
name|fp_h_sync_strt_wid
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP_V_SYNC_STRT_WID
argument_list|,
name|fp_v_sync_strt_wid
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP_CRTC_H_TOTAL_DISP
argument_list|,
name|fp_crtc_h_total_disp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP_CRTC_V_TOTAL_DISP
argument_list|,
name|fp_crtc_v_total_disp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_pll_wait_for_read_update_complete
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
comment|/* FIXME: Certain revisions of R300 can't recover here.  Not sure of 	   the cause yet, but this workaround will mask the problem for now. 	   Other chips usually will pass at the very first test, so the 	   workaround shouldn't have any effect on them. */
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|<
literal|10000
operator|&&
name|RREG32_PLL
argument_list|(
name|RADEON_PPLL_REF_DIV
argument_list|)
operator|&
name|RADEON_PPLL_ATOMIC_UPDATE_R
operator|)
condition|;
name|i
operator|++
control|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_pll_write_update
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
while|while
condition|(
name|RREG32_PLL
argument_list|(
name|RADEON_PPLL_REF_DIV
argument_list|)
operator|&
name|RADEON_PPLL_ATOMIC_UPDATE_R
condition|)
empty_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_PPLL_REF_DIV
argument_list|,
name|RADEON_PPLL_ATOMIC_UPDATE_W
argument_list|,
operator|~
operator|(
name|RADEON_PPLL_ATOMIC_UPDATE_W
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_pll2_wait_for_read_update_complete
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
comment|/* FIXME: Certain revisions of R300 can't recover here.  Not sure of 	   the cause yet, but this workaround will mask the problem for now. 	   Other chips usually will pass at the very first test, so the 	   workaround shouldn't have any effect on them. */
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|<
literal|10000
operator|&&
name|RREG32_PLL
argument_list|(
name|RADEON_P2PLL_REF_DIV
argument_list|)
operator|&
name|RADEON_P2PLL_ATOMIC_UPDATE_R
operator|)
condition|;
name|i
operator|++
control|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_pll2_write_update
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
while|while
condition|(
name|RREG32_PLL
argument_list|(
name|RADEON_P2PLL_REF_DIV
argument_list|)
operator|&
name|RADEON_P2PLL_ATOMIC_UPDATE_R
condition|)
empty_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_P2PLL_REF_DIV
argument_list|,
name|RADEON_P2PLL_ATOMIC_UPDATE_W
argument_list|,
operator|~
operator|(
name|RADEON_P2PLL_ATOMIC_UPDATE_W
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|radeon_compute_pll_gain
parameter_list|(
name|uint16_t
name|ref_freq
parameter_list|,
name|uint16_t
name|ref_div
parameter_list|,
name|uint16_t
name|fb_div
parameter_list|)
block|{
name|unsigned
name|int
name|vcoFreq
decl_stmt|;
if|if
condition|(
operator|!
name|ref_div
condition|)
return|return
literal|1
return|;
name|vcoFreq
operator|=
operator|(
operator|(
name|unsigned
operator|)
name|ref_freq
operator|*
name|fb_div
operator|)
operator|/
name|ref_div
expr_stmt|;
comment|/* 	 * This is horribly crude: the VCO frequency range is divided into 	 * 3 parts, each part having a fixed PLL gain value. 	 */
if|if
condition|(
name|vcoFreq
operator|>=
literal|30000
condition|)
comment|/* 		 * [300..max] MHz : 7 		 */
return|return
literal|7
return|;
elseif|else
if|if
condition|(
name|vcoFreq
operator|>=
literal|18000
condition|)
comment|/* 		 * [180..300) MHz : 4 		 */
return|return
literal|4
return|;
else|else
comment|/* 		 * [0..180) MHz : 1 		 */
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_crtc_dpms
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|crtc_ext_cntl
init|=
literal|0
decl_stmt|;
name|uint32_t
name|mask
decl_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
name|mask
operator|=
operator|(
name|RADEON_CRTC2_DISP_DIS
operator||
name|RADEON_CRTC2_VSYNC_DIS
operator||
name|RADEON_CRTC2_HSYNC_DIS
operator||
name|RADEON_CRTC2_DISP_REQ_EN_B
operator|)
expr_stmt|;
else|else
name|mask
operator|=
operator|(
name|RADEON_CRTC_DISPLAY_DIS
operator||
name|RADEON_CRTC_VSYNC_DIS
operator||
name|RADEON_CRTC_HSYNC_DIS
operator|)
expr_stmt|;
comment|/* 	 * On all dual CRTC GPUs this bit controls the CRTC of the primary DAC. 	 * Therefore it is set in the DAC DMPS function. 	 * This is different for GPU's with a single CRTC but a primary and a 	 * TV DAC: here it controls the single CRTC no matter where it is 	 * routed. Therefore we set it here. 	 */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
condition|)
name|crtc_ext_cntl
operator|=
name|RADEON_CRTC_CRT_ON
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|DRM_MODE_DPMS_ON
case|:
name|radeon_crtc
operator|->
name|enabled
operator|=
name|true
expr_stmt|;
comment|/* adjust pm to dpms changes BEFORE enabling crtcs */
name|radeon_pm_compute_clocks
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
name|WREG32_P
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|RADEON_CRTC2_EN
argument_list|,
operator|~
operator|(
name|RADEON_CRTC2_EN
operator||
name|mask
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|WREG32_P
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|,
name|RADEON_CRTC_EN
argument_list|,
operator|~
operator|(
name|RADEON_CRTC_EN
operator||
name|RADEON_CRTC_DISP_REQ_EN_B
operator|)
argument_list|)
expr_stmt|;
name|WREG32_P
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|,
name|crtc_ext_cntl
argument_list|,
operator|~
operator|(
name|mask
operator||
name|crtc_ext_cntl
operator|)
argument_list|)
expr_stmt|;
block|}
name|drm_vblank_post_modeset
argument_list|(
name|dev
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
name|radeon_crtc_load_lut
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
break|break;
case|case
name|DRM_MODE_DPMS_STANDBY
case|:
case|case
name|DRM_MODE_DPMS_SUSPEND
case|:
case|case
name|DRM_MODE_DPMS_OFF
case|:
name|drm_vblank_pre_modeset
argument_list|(
name|dev
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
name|WREG32_P
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|mask
argument_list|,
operator|~
operator|(
name|RADEON_CRTC2_EN
operator||
name|mask
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|WREG32_P
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|,
name|RADEON_CRTC_DISP_REQ_EN_B
argument_list|,
operator|~
operator|(
name|RADEON_CRTC_EN
operator||
name|RADEON_CRTC_DISP_REQ_EN_B
operator|)
argument_list|)
expr_stmt|;
name|WREG32_P
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|,
name|mask
argument_list|,
operator|~
operator|(
name|mask
operator||
name|crtc_ext_cntl
operator|)
argument_list|)
expr_stmt|;
block|}
name|radeon_crtc
operator|->
name|enabled
operator|=
name|false
expr_stmt|;
comment|/* adjust pm to dpms changes AFTER disabling crtcs */
name|radeon_pm_compute_clocks
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|radeon_crtc_set_base
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|struct
name|drm_framebuffer
modifier|*
name|old_fb
parameter_list|)
block|{
return|return
name|radeon_crtc_do_set_base
argument_list|(
name|crtc
argument_list|,
name|old_fb
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|radeon_crtc_set_base_atomic
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|drm_framebuffer
modifier|*
name|fb
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|enum
name|mode_set_atomic
name|state
parameter_list|)
block|{
return|return
name|radeon_crtc_do_set_base
argument_list|(
name|crtc
argument_list|,
name|fb
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|radeon_crtc_do_set_base
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|drm_framebuffer
modifier|*
name|fb
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|atomic
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_framebuffer
modifier|*
name|radeon_fb
decl_stmt|;
name|struct
name|drm_framebuffer
modifier|*
name|target_fb
decl_stmt|;
name|struct
name|drm_gem_object
modifier|*
name|obj
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|rbo
decl_stmt|;
name|uint64_t
name|base
decl_stmt|;
name|uint32_t
name|crtc_offset
decl_stmt|,
name|crtc_offset_cntl
decl_stmt|,
name|crtc_tile_x0_y0
init|=
literal|0
decl_stmt|;
name|uint32_t
name|crtc_pitch
decl_stmt|,
name|pitch_pixels
decl_stmt|;
name|uint32_t
name|tiling_flags
decl_stmt|;
name|int
name|format
decl_stmt|;
name|uint32_t
name|gen_cntl_reg
decl_stmt|,
name|gen_cntl_val
decl_stmt|;
name|int
name|r
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* no fb bound */
if|if
condition|(
operator|!
name|atomic
operator|&&
operator|!
name|crtc
operator|->
name|fb
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"No FB bound\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|atomic
condition|)
block|{
name|radeon_fb
operator|=
name|to_radeon_framebuffer
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|target_fb
operator|=
name|fb
expr_stmt|;
block|}
else|else
block|{
name|radeon_fb
operator|=
name|to_radeon_framebuffer
argument_list|(
name|crtc
operator|->
name|fb
argument_list|)
expr_stmt|;
name|target_fb
operator|=
name|crtc
operator|->
name|fb
expr_stmt|;
block|}
switch|switch
condition|(
name|target_fb
operator|->
name|bits_per_pixel
condition|)
block|{
case|case
literal|8
case|:
name|format
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|15
case|:
comment|/*  555 */
name|format
operator|=
literal|3
expr_stmt|;
break|break;
case|case
literal|16
case|:
comment|/*  565 */
name|format
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|24
case|:
comment|/*  RGB */
name|format
operator|=
literal|5
expr_stmt|;
break|break;
case|case
literal|32
case|:
comment|/* xRGB */
name|format
operator|=
literal|6
expr_stmt|;
break|break;
default|default:
return|return
name|false
return|;
block|}
comment|/* Pin framebuffer& get tilling informations */
name|obj
operator|=
name|radeon_fb
operator|->
name|obj
expr_stmt|;
name|rbo
operator|=
name|gem_to_radeon_bo
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rbo
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
return|return
name|r
return|;
comment|/* Only 27 bit offset for legacy CRTC */
name|r
operator|=
name|radeon_bo_pin_restricted
argument_list|(
name|rbo
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
literal|1
operator|<<
literal|27
argument_list|,
operator|&
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|radeon_bo_unreserve
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|radeon_bo_get_tiling_flags
argument_list|(
name|rbo
argument_list|,
operator|&
name|tiling_flags
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|DRM_ERROR
argument_list|(
literal|"trying to scanout microtiled buffer\n"
argument_list|)
expr_stmt|;
comment|/* if scanout was in GTT this really wouldn't work */
comment|/* crtc offset is from display base addr not FB location */
name|radeon_crtc
operator|->
name|legacy_display_base_addr
operator|=
name|rdev
operator|->
name|mc
operator|.
name|vram_start
expr_stmt|;
name|base
operator|-=
name|radeon_crtc
operator|->
name|legacy_display_base_addr
expr_stmt|;
name|crtc_offset_cntl
operator|=
literal|0
expr_stmt|;
name|pitch_pixels
operator|=
name|target_fb
operator|->
name|pitches
index|[
literal|0
index|]
operator|/
operator|(
name|target_fb
operator|->
name|bits_per_pixel
operator|/
literal|8
operator|)
expr_stmt|;
name|crtc_pitch
operator|=
operator|(
operator|(
operator|(
name|pitch_pixels
operator|*
name|target_fb
operator|->
name|bits_per_pixel
operator|)
operator|+
operator|(
operator|(
name|target_fb
operator|->
name|bits_per_pixel
operator|*
literal|8
operator|)
operator|-
literal|1
operator|)
operator|)
operator|/
operator|(
name|target_fb
operator|->
name|bits_per_pixel
operator|*
literal|8
operator|)
operator|)
expr_stmt|;
name|crtc_pitch
operator||=
name|crtc_pitch
operator|<<
literal|16
expr_stmt|;
name|crtc_offset_cntl
operator||=
name|RADEON_CRTC_GUI_TRIG_OFFSET_LEFT_EN
expr_stmt|;
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
name|crtc_offset_cntl
operator||=
operator|(
name|R300_CRTC_X_Y_MODE_EN
operator||
name|R300_CRTC_MICRO_TILE_BUFFER_DIS
operator||
name|R300_CRTC_MACRO_TILE_EN
operator|)
expr_stmt|;
else|else
name|crtc_offset_cntl
operator||=
name|RADEON_CRTC_TILE_EN
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
name|crtc_offset_cntl
operator|&=
operator|~
operator|(
name|R300_CRTC_X_Y_MODE_EN
operator||
name|R300_CRTC_MICRO_TILE_BUFFER_DIS
operator||
name|R300_CRTC_MACRO_TILE_EN
operator|)
expr_stmt|;
else|else
name|crtc_offset_cntl
operator|&=
operator|~
name|RADEON_CRTC_TILE_EN
expr_stmt|;
block|}
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|crtc_tile_x0_y0
operator|=
name|x
operator||
operator|(
name|y
operator|<<
literal|16
operator|)
expr_stmt|;
name|base
operator|&=
operator|~
literal|0x7ff
expr_stmt|;
block|}
else|else
block|{
name|int
name|byteshift
init|=
name|target_fb
operator|->
name|bits_per_pixel
operator|>>
literal|4
decl_stmt|;
name|int
name|tile_addr
init|=
operator|(
operator|(
operator|(
name|y
operator|>>
literal|3
operator|)
operator|*
name|pitch_pixels
operator|+
name|x
operator|)
operator|>>
operator|(
literal|8
operator|-
name|byteshift
operator|)
operator|)
operator|<<
literal|11
decl_stmt|;
name|base
operator|+=
name|tile_addr
operator|+
operator|(
operator|(
name|x
operator|<<
name|byteshift
operator|)
operator|%
literal|256
operator|)
operator|+
operator|(
operator|(
name|y
operator|%
literal|8
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|crtc_offset_cntl
operator||=
operator|(
name|y
operator|%
literal|16
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|int
name|offset
init|=
name|y
operator|*
name|pitch_pixels
operator|+
name|x
decl_stmt|;
switch|switch
condition|(
name|target_fb
operator|->
name|bits_per_pixel
condition|)
block|{
case|case
literal|8
case|:
name|offset
operator|*=
literal|1
expr_stmt|;
break|break;
case|case
literal|15
case|:
case|case
literal|16
case|:
name|offset
operator|*=
literal|2
expr_stmt|;
break|break;
case|case
literal|24
case|:
name|offset
operator|*=
literal|3
expr_stmt|;
break|break;
case|case
literal|32
case|:
name|offset
operator|*=
literal|4
expr_stmt|;
break|break;
default|default:
return|return
name|false
return|;
block|}
name|base
operator|+=
name|offset
expr_stmt|;
block|}
name|base
operator|&=
operator|~
literal|7
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|1
condition|)
name|gen_cntl_reg
operator|=
name|RADEON_CRTC2_GEN_CNTL
expr_stmt|;
else|else
name|gen_cntl_reg
operator|=
name|RADEON_CRTC_GEN_CNTL
expr_stmt|;
name|gen_cntl_val
operator|=
name|RREG32
argument_list|(
name|gen_cntl_reg
argument_list|)
expr_stmt|;
name|gen_cntl_val
operator|&=
operator|~
operator|(
literal|0xf
operator|<<
literal|8
operator|)
expr_stmt|;
name|gen_cntl_val
operator||=
operator|(
name|format
operator|<<
literal|8
operator|)
expr_stmt|;
name|gen_cntl_val
operator|&=
operator|~
name|RADEON_CRTC_VSTAT_MODE_MASK
expr_stmt|;
name|WREG32
argument_list|(
name|gen_cntl_reg
argument_list|,
name|gen_cntl_val
argument_list|)
expr_stmt|;
name|crtc_offset
operator|=
operator|(
name|u32
operator|)
name|base
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISPLAY_BASE_ADDR
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|radeon_crtc
operator|->
name|legacy_display_base_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
name|WREG32
argument_list|(
name|R300_CRTC2_TILE_X0_Y0
argument_list|,
name|crtc_tile_x0_y0
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|R300_CRTC_TILE_X0_Y0
argument_list|,
name|crtc_tile_x0_y0
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_CRTC_OFFSET_CNTL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|crtc_offset_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_OFFSET
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|crtc_offset
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_PITCH
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|crtc_pitch
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|atomic
operator|&&
name|fb
operator|&&
name|fb
operator|!=
name|crtc
operator|->
name|fb
condition|)
block|{
name|radeon_fb
operator|=
name|to_radeon_framebuffer
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|rbo
operator|=
name|gem_to_radeon_bo
argument_list|(
name|radeon_fb
operator|->
name|obj
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rbo
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
return|return
name|r
return|;
name|radeon_bo_unpin
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
block|}
comment|/* Bytes per pixel may have changed */
name|radeon_bandwidth_update
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_set_crtc_timing
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|drm_encoder
modifier|*
name|encoder
decl_stmt|;
name|int
name|format
decl_stmt|;
name|int
name|hsync_start
decl_stmt|;
name|int
name|hsync_wid
decl_stmt|;
name|int
name|vsync_wid
decl_stmt|;
name|uint32_t
name|crtc_h_total_disp
decl_stmt|;
name|uint32_t
name|crtc_h_sync_strt_wid
decl_stmt|;
name|uint32_t
name|crtc_v_total_disp
decl_stmt|;
name|uint32_t
name|crtc_v_sync_strt_wid
decl_stmt|;
name|bool
name|is_tv
init|=
name|false
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|encoder
argument_list|,
argument|&dev->mode_config.encoder_list
argument_list|,
argument|head
argument_list|)
block|{
if|if
condition|(
name|encoder
operator|->
name|crtc
operator|==
name|crtc
condition|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|active_device
operator|&
name|ATOM_DEVICE_TV_SUPPORT
condition|)
block|{
name|is_tv
operator|=
name|true
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"crtc %d is connected to a TV\n"
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
switch|switch
condition|(
name|crtc
operator|->
name|fb
operator|->
name|bits_per_pixel
condition|)
block|{
case|case
literal|8
case|:
name|format
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|15
case|:
comment|/*  555 */
name|format
operator|=
literal|3
expr_stmt|;
break|break;
case|case
literal|16
case|:
comment|/*  565 */
name|format
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|24
case|:
comment|/*  RGB */
name|format
operator|=
literal|5
expr_stmt|;
break|break;
case|case
literal|32
case|:
comment|/* xRGB */
name|format
operator|=
literal|6
expr_stmt|;
break|break;
default|default:
return|return
name|false
return|;
block|}
name|crtc_h_total_disp
operator|=
operator|(
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_htotal
operator|/
literal|8
operator|)
operator|-
literal|1
operator|)
operator|&
literal|0x3ff
operator|)
operator||
operator|(
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_hdisplay
operator|/
literal|8
operator|)
operator|-
literal|1
operator|)
operator|&
literal|0x1ff
operator|)
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
name|hsync_wid
operator|=
operator|(
name|mode
operator|->
name|crtc_hsync_end
operator|-
name|mode
operator|->
name|crtc_hsync_start
operator|)
operator|/
literal|8
expr_stmt|;
if|if
condition|(
operator|!
name|hsync_wid
condition|)
name|hsync_wid
operator|=
literal|1
expr_stmt|;
name|hsync_start
operator|=
name|mode
operator|->
name|crtc_hsync_start
operator|-
literal|8
expr_stmt|;
name|crtc_h_sync_strt_wid
operator|=
operator|(
operator|(
name|hsync_start
operator|&
literal|0x1fff
operator|)
operator||
operator|(
operator|(
name|hsync_wid
operator|&
literal|0x3f
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_NHSYNC
operator|)
condition|?
name|RADEON_CRTC_H_SYNC_POL
else|:
literal|0
operator|)
operator|)
expr_stmt|;
comment|/* This works for double scan mode. */
name|crtc_v_total_disp
operator|=
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_vtotal
operator|-
literal|1
operator|)
operator|&
literal|0xffff
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|crtc_vdisplay
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
name|vsync_wid
operator|=
name|mode
operator|->
name|crtc_vsync_end
operator|-
name|mode
operator|->
name|crtc_vsync_start
expr_stmt|;
if|if
condition|(
operator|!
name|vsync_wid
condition|)
name|vsync_wid
operator|=
literal|1
expr_stmt|;
name|crtc_v_sync_strt_wid
operator|=
operator|(
operator|(
operator|(
name|mode
operator|->
name|crtc_vsync_start
operator|-
literal|1
operator|)
operator|&
literal|0xfff
operator|)
operator||
operator|(
operator|(
name|vsync_wid
operator|&
literal|0x1f
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_NVSYNC
operator|)
condition|?
name|RADEON_CRTC_V_SYNC_POL
else|:
literal|0
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
block|{
name|uint32_t
name|crtc2_gen_cntl
decl_stmt|;
name|uint32_t
name|disp2_merge_cntl
decl_stmt|;
comment|/* if TV DAC is enabled for another crtc and keep it enabled */
name|crtc2_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|)
operator|&
literal|0x00718080
expr_stmt|;
name|crtc2_gen_cntl
operator||=
operator|(
operator|(
name|format
operator|<<
literal|8
operator|)
operator||
name|RADEON_CRTC2_VSYNC_DIS
operator||
name|RADEON_CRTC2_HSYNC_DIS
operator||
name|RADEON_CRTC2_DISP_DIS
operator||
name|RADEON_CRTC2_DISP_REQ_EN_B
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_DBLSCAN
operator|)
condition|?
name|RADEON_CRTC2_DBL_SCAN_EN
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_CSYNC
operator|)
condition|?
name|RADEON_CRTC2_CSYNC_EN
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_INTERLACE
operator|)
condition|?
name|RADEON_CRTC2_INTERLACE_EN
else|:
literal|0
operator|)
operator|)
expr_stmt|;
comment|/* rs4xx chips seem to like to have the crtc enabled when the timing is set */
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS400
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
operator|)
condition|)
name|crtc2_gen_cntl
operator||=
name|RADEON_CRTC2_EN
expr_stmt|;
name|disp2_merge_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP2_MERGE_CNTL
argument_list|)
expr_stmt|;
name|disp2_merge_cntl
operator|&=
operator|~
name|RADEON_DISP2_RGB_OFFSET_EN
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP2_MERGE_CNTL
argument_list|,
name|disp2_merge_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|crtc2_gen_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP_H2_SYNC_STRT_WID
argument_list|,
name|crtc_h_sync_strt_wid
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP_V2_SYNC_STRT_WID
argument_list|,
name|crtc_v_sync_strt_wid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint32_t
name|crtc_gen_cntl
decl_stmt|;
name|uint32_t
name|crtc_ext_cntl
decl_stmt|;
name|uint32_t
name|disp_merge_cntl
decl_stmt|;
name|crtc_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|)
operator|&
literal|0x00718000
expr_stmt|;
name|crtc_gen_cntl
operator||=
operator|(
name|RADEON_CRTC_EXT_DISP_EN
operator||
operator|(
name|format
operator|<<
literal|8
operator|)
operator||
name|RADEON_CRTC_DISP_REQ_EN_B
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_DBLSCAN
operator|)
condition|?
name|RADEON_CRTC_DBL_SCAN_EN
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_CSYNC
operator|)
condition|?
name|RADEON_CRTC_CSYNC_EN
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_INTERLACE
operator|)
condition|?
name|RADEON_CRTC_INTERLACE_EN
else|:
literal|0
operator|)
operator|)
expr_stmt|;
comment|/* rs4xx chips seem to like to have the crtc enabled when the timing is set */
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS400
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
operator|)
condition|)
name|crtc_gen_cntl
operator||=
name|RADEON_CRTC_EN
expr_stmt|;
name|crtc_ext_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|)
expr_stmt|;
name|crtc_ext_cntl
operator||=
operator|(
name|RADEON_XCRT_CNT_EN
operator||
name|RADEON_CRTC_VSYNC_DIS
operator||
name|RADEON_CRTC_HSYNC_DIS
operator||
name|RADEON_CRTC_DISPLAY_DIS
operator|)
expr_stmt|;
name|disp_merge_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DISP_MERGE_CNTL
argument_list|)
expr_stmt|;
name|disp_merge_cntl
operator|&=
operator|~
name|RADEON_DISP_RGB_OFFSET_EN
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_MERGE_CNTL
argument_list|,
name|disp_merge_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|,
name|crtc_gen_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_EXT_CNTL
argument_list|,
name|crtc_ext_cntl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|is_tv
condition|)
name|radeon_legacy_tv_adjust_crtc_reg
argument_list|(
name|encoder
argument_list|,
operator|&
name|crtc_h_total_disp
argument_list|,
operator|&
name|crtc_h_sync_strt_wid
argument_list|,
operator|&
name|crtc_v_total_disp
argument_list|,
operator|&
name|crtc_v_sync_strt_wid
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_H_TOTAL_DISP
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|crtc_h_total_disp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_H_SYNC_STRT_WID
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|crtc_h_sync_strt_wid
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_V_TOTAL_DISP
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|crtc_v_total_disp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_V_SYNC_STRT_WID
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|crtc_v_sync_strt_wid
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_set_pll
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|drm_encoder
modifier|*
name|encoder
decl_stmt|;
name|uint32_t
name|feedback_div
init|=
literal|0
decl_stmt|;
name|uint32_t
name|frac_fb_div
init|=
literal|0
decl_stmt|;
name|uint32_t
name|reference_div
init|=
literal|0
decl_stmt|;
name|uint32_t
name|post_divider
init|=
literal|0
decl_stmt|;
name|uint32_t
name|freq
init|=
literal|0
decl_stmt|;
name|uint8_t
name|pll_gain
decl_stmt|;
name|bool
name|use_bios_divs
init|=
name|false
decl_stmt|;
comment|/* PLL registers */
name|uint32_t
name|pll_ref_div
init|=
literal|0
decl_stmt|;
name|uint32_t
name|pll_fb_post_div
init|=
literal|0
decl_stmt|;
name|uint32_t
name|htotal_cntl
init|=
literal|0
decl_stmt|;
name|bool
name|is_tv
init|=
name|false
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|pll
decl_stmt|;
struct|struct
block|{
name|int
name|divider
decl_stmt|;
name|int
name|bitvalue
decl_stmt|;
block|}
modifier|*
name|post_div
struct|,
name|post_divs
index|[]
init|=
block|{
comment|/* From RAGE 128 VR/RAGE 128 GL Register 		 * Reference Manual (Technical Reference 		 * Manual P/N RRG-G04100-C Rev. 0.04), page 		 * 3-17 (PLL_DIV_[3:0]). 		 */
block|{
literal|1
block|,
literal|0
block|}
block|,
comment|/* VCLK_SRC                 */
block|{
literal|2
block|,
literal|1
block|}
block|,
comment|/* VCLK_SRC/2               */
block|{
literal|4
block|,
literal|2
block|}
block|,
comment|/* VCLK_SRC/4               */
block|{
literal|8
block|,
literal|3
block|}
block|,
comment|/* VCLK_SRC/8               */
block|{
literal|3
block|,
literal|4
block|}
block|,
comment|/* VCLK_SRC/3               */
block|{
literal|16
block|,
literal|5
block|}
block|,
comment|/* VCLK_SRC/16              */
block|{
literal|6
block|,
literal|6
block|}
block|,
comment|/* VCLK_SRC/6               */
block|{
literal|12
block|,
literal|7
block|}
block|,
comment|/* VCLK_SRC/12              */
block|{
literal|0
block|,
literal|0
block|}
block|}
struct|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
name|pll
operator|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|p2pll
expr_stmt|;
else|else
name|pll
operator|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|p1pll
expr_stmt|;
name|pll
operator|->
name|flags
operator|=
name|RADEON_PLL_LEGACY
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|clock
operator|>
literal|200000
condition|)
comment|/* range limits??? */
name|pll
operator|->
name|flags
operator||=
name|RADEON_PLL_PREFER_HIGH_FB_DIV
expr_stmt|;
else|else
name|pll
operator|->
name|flags
operator||=
name|RADEON_PLL_PREFER_LOW_REF_DIV
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|encoder
argument_list|,
argument|&dev->mode_config.encoder_list
argument_list|,
argument|head
argument_list|)
block|{
if|if
condition|(
name|encoder
operator|->
name|crtc
operator|==
name|crtc
condition|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|active_device
operator|&
name|ATOM_DEVICE_TV_SUPPORT
condition|)
block|{
name|is_tv
operator|=
name|true
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|encoder
operator|->
name|encoder_type
operator|!=
name|DRM_MODE_ENCODER_DAC
condition|)
name|pll
operator|->
name|flags
operator||=
name|RADEON_PLL_NO_ODD_POST_DIV
expr_stmt|;
if|if
condition|(
name|encoder
operator|->
name|encoder_type
operator|==
name|DRM_MODE_ENCODER_LVDS
condition|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder_lvds
modifier|*
name|lvds
init|=
operator|(
expr|struct
name|radeon_encoder_lvds
operator|*
operator|)
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
if|if
condition|(
name|lvds
condition|)
block|{
if|if
condition|(
name|lvds
operator|->
name|use_bios_dividers
condition|)
block|{
name|pll_ref_div
operator|=
name|lvds
operator|->
name|panel_ref_divider
expr_stmt|;
name|pll_fb_post_div
operator|=
operator|(
name|lvds
operator|->
name|panel_fb_divider
operator||
operator|(
name|lvds
operator|->
name|panel_post_divider
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
name|htotal_cntl
operator|=
literal|0
expr_stmt|;
name|use_bios_divs
operator|=
name|true
expr_stmt|;
block|}
block|}
block|}
name|pll
operator|->
name|flags
operator||=
name|RADEON_PLL_USE_REF_DIV
expr_stmt|;
block|}
block|}
block|}
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|use_bios_divs
condition|)
block|{
name|radeon_compute_pll_legacy
argument_list|(
name|pll
argument_list|,
name|mode
operator|->
name|clock
argument_list|,
operator|&
name|freq
argument_list|,
operator|&
name|feedback_div
argument_list|,
operator|&
name|frac_fb_div
argument_list|,
operator|&
name|reference_div
argument_list|,
operator|&
name|post_divider
argument_list|)
expr_stmt|;
for|for
control|(
name|post_div
operator|=
operator|&
name|post_divs
index|[
literal|0
index|]
init|;
name|post_div
operator|->
name|divider
condition|;
operator|++
name|post_div
control|)
block|{
if|if
condition|(
name|post_div
operator|->
name|divider
operator|==
name|post_divider
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|post_div
operator|->
name|divider
condition|)
name|post_div
operator|=
operator|&
name|post_divs
index|[
literal|0
index|]
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"dc=%u, fd=%d, rd=%d, pd=%d\n"
argument_list|,
operator|(
name|unsigned
operator|)
name|freq
argument_list|,
name|feedback_div
argument_list|,
name|reference_div
argument_list|,
name|post_divider
argument_list|)
expr_stmt|;
name|pll_ref_div
operator|=
name|reference_div
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__powerpc__
argument_list|)
operator|&&
operator|(
literal|0
operator|)
comment|/* TODO */
comment|/* apparently programming this otherwise causes a hang??? */
if|if
condition|(
name|info
operator|->
name|MacModel
operator|==
name|RADEON_MAC_IBOOK
condition|)
name|pll_fb_post_div
operator|=
literal|0x000600ad
expr_stmt|;
else|else
endif|#
directive|endif
name|pll_fb_post_div
operator|=
operator|(
name|feedback_div
operator||
operator|(
name|post_div
operator|->
name|bitvalue
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
name|htotal_cntl
operator|=
name|mode
operator|->
name|htotal
operator|&
literal|0x7
expr_stmt|;
block|}
name|pll_gain
operator|=
name|radeon_compute_pll_gain
argument_list|(
name|pll
operator|->
name|reference_freq
argument_list|,
name|pll_ref_div
operator|&
literal|0x3ff
argument_list|,
name|pll_fb_post_div
operator|&
literal|0x7ff
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
block|{
name|uint32_t
name|pixclks_cntl
init|=
operator|(
operator|(
name|RREG32_PLL
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|)
operator|&
operator|~
operator|(
name|RADEON_PIX2CLK_SRC_SEL_MASK
operator|)
operator|)
operator||
name|RADEON_PIX2CLK_SRC_SEL_P2PLLCLK
operator|)
decl_stmt|;
if|if
condition|(
name|is_tv
condition|)
block|{
name|radeon_legacy_tv_adjust_pll2
argument_list|(
name|encoder
argument_list|,
operator|&
name|htotal_cntl
argument_list|,
operator|&
name|pll_ref_div
argument_list|,
operator|&
name|pll_fb_post_div
argument_list|,
operator|&
name|pixclks_cntl
argument_list|)
expr_stmt|;
block|}
name|WREG32_PLL_P
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|,
name|RADEON_PIX2CLK_SRC_SEL_CPUCLK
argument_list|,
operator|~
operator|(
name|RADEON_PIX2CLK_SRC_SEL_MASK
operator|)
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_P2PLL_CNTL
argument_list|,
name|RADEON_P2PLL_RESET
operator||
name|RADEON_P2PLL_ATOMIC_UPDATE_EN
operator||
operator|(
operator|(
name|uint32_t
operator|)
name|pll_gain
operator|<<
name|RADEON_P2PLL_PVG_SHIFT
operator|)
argument_list|,
operator|~
operator|(
name|RADEON_P2PLL_RESET
operator||
name|RADEON_P2PLL_ATOMIC_UPDATE_EN
operator||
name|RADEON_P2PLL_PVG_MASK
operator|)
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_P2PLL_REF_DIV
argument_list|,
name|pll_ref_div
argument_list|,
operator|~
name|RADEON_P2PLL_REF_DIV_MASK
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_P2PLL_DIV_0
argument_list|,
name|pll_fb_post_div
argument_list|,
operator|~
name|RADEON_P2PLL_FB0_DIV_MASK
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_P2PLL_DIV_0
argument_list|,
name|pll_fb_post_div
argument_list|,
operator|~
name|RADEON_P2PLL_POST0_DIV_MASK
argument_list|)
expr_stmt|;
name|radeon_pll2_write_update
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|radeon_pll2_wait_for_read_update_complete
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|RADEON_HTOTAL2_CNTL
argument_list|,
name|htotal_cntl
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_P2PLL_CNTL
argument_list|,
literal|0
argument_list|,
operator|~
operator|(
name|RADEON_P2PLL_RESET
operator||
name|RADEON_P2PLL_SLEEP
operator||
name|RADEON_P2PLL_ATOMIC_UPDATE_EN
operator|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Wrote2: 0x%08x 0x%08x 0x%08x (0x%08x)\n"
argument_list|,
operator|(
name|unsigned
operator|)
name|pll_ref_div
argument_list|,
operator|(
name|unsigned
operator|)
name|pll_fb_post_div
argument_list|,
operator|(
name|unsigned
operator|)
name|htotal_cntl
argument_list|,
name|RREG32_PLL
argument_list|(
name|RADEON_P2PLL_CNTL
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Wrote2: rd=%u, fd=%u, pd=%u\n"
argument_list|,
operator|(
name|unsigned
operator|)
name|pll_ref_div
operator|&
name|RADEON_P2PLL_REF_DIV_MASK
argument_list|,
operator|(
name|unsigned
operator|)
name|pll_fb_post_div
operator|&
name|RADEON_P2PLL_FB0_DIV_MASK
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
operator|(
name|pll_fb_post_div
operator|&
name|RADEON_P2PLL_POST0_DIV_MASK
operator|)
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|mdelay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/* Let the clock to lock */
name|WREG32_PLL_P
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|,
name|RADEON_PIX2CLK_SRC_SEL_P2PLLCLK
argument_list|,
operator|~
operator|(
name|RADEON_PIX2CLK_SRC_SEL_MASK
operator|)
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|,
name|pixclks_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint32_t
name|pixclks_cntl
decl_stmt|;
if|if
condition|(
name|is_tv
condition|)
block|{
name|pixclks_cntl
operator|=
name|RREG32_PLL
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|)
expr_stmt|;
name|radeon_legacy_tv_adjust_pll1
argument_list|(
name|encoder
argument_list|,
operator|&
name|htotal_cntl
argument_list|,
operator|&
name|pll_ref_div
argument_list|,
operator|&
name|pll_fb_post_div
argument_list|,
operator|&
name|pixclks_cntl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_MOBILITY
condition|)
block|{
comment|/* A temporal workaround for the occasional blanking on certain laptop panels. 			   This appears to related to the PLL divider registers (fail to lock?). 			   It occurs even when all dividers are the same with their old settings. 			   In this case we really don't need to fiddle with PLL registers. 			   By doing this we can avoid the blanking problem with some panels. 			*/
if|if
condition|(
operator|(
name|pll_ref_div
operator|==
operator|(
name|RREG32_PLL
argument_list|(
name|RADEON_PPLL_REF_DIV
argument_list|)
operator|&
name|RADEON_PPLL_REF_DIV_MASK
operator|)
operator|)
operator|&&
operator|(
name|pll_fb_post_div
operator|==
operator|(
name|RREG32_PLL
argument_list|(
name|RADEON_PPLL_DIV_3
argument_list|)
operator|&
operator|(
name|RADEON_PPLL_POST3_DIV_MASK
operator||
name|RADEON_PPLL_FB3_DIV_MASK
operator|)
operator|)
operator|)
condition|)
block|{
name|WREG32_P
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|,
name|RADEON_PLL_DIV_SEL
argument_list|,
operator|~
operator|(
name|RADEON_PLL_DIV_SEL
operator|)
argument_list|)
expr_stmt|;
name|r100_pll_errata_after_index
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|WREG32_PLL_P
argument_list|(
name|RADEON_VCLK_ECP_CNTL
argument_list|,
name|RADEON_VCLK_SRC_SEL_CPUCLK
argument_list|,
operator|~
operator|(
name|RADEON_VCLK_SRC_SEL_MASK
operator|)
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_PPLL_CNTL
argument_list|,
name|RADEON_PPLL_RESET
operator||
name|RADEON_PPLL_ATOMIC_UPDATE_EN
operator||
name|RADEON_PPLL_VGA_ATOMIC_UPDATE_EN
operator||
operator|(
operator|(
name|uint32_t
operator|)
name|pll_gain
operator|<<
name|RADEON_PPLL_PVG_SHIFT
operator|)
argument_list|,
operator|~
operator|(
name|RADEON_PPLL_RESET
operator||
name|RADEON_PPLL_ATOMIC_UPDATE_EN
operator||
name|RADEON_PPLL_VGA_ATOMIC_UPDATE_EN
operator||
name|RADEON_PPLL_PVG_MASK
operator|)
argument_list|)
expr_stmt|;
name|WREG32_P
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|,
name|RADEON_PLL_DIV_SEL
argument_list|,
operator|~
operator|(
name|RADEON_PLL_DIV_SEL
operator|)
argument_list|)
expr_stmt|;
name|r100_pll_errata_after_index
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS300
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS400
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
operator|)
condition|)
block|{
if|if
condition|(
name|pll_ref_div
operator|&
name|R300_PPLL_REF_DIV_ACC_MASK
condition|)
block|{
comment|/* When restoring console mode, use saved PPLL_REF_DIV 				 * setting. 				 */
name|WREG32_PLL_P
argument_list|(
name|RADEON_PPLL_REF_DIV
argument_list|,
name|pll_ref_div
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* R300 uses ref_div_acc field as real ref divider */
name|WREG32_PLL_P
argument_list|(
name|RADEON_PPLL_REF_DIV
argument_list|,
operator|(
name|pll_ref_div
operator|<<
name|R300_PPLL_REF_DIV_ACC_SHIFT
operator|)
argument_list|,
operator|~
name|R300_PPLL_REF_DIV_ACC_MASK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|WREG32_PLL_P
argument_list|(
name|RADEON_PPLL_REF_DIV
argument_list|,
name|pll_ref_div
argument_list|,
operator|~
name|RADEON_PPLL_REF_DIV_MASK
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_PPLL_DIV_3
argument_list|,
name|pll_fb_post_div
argument_list|,
operator|~
name|RADEON_PPLL_FB3_DIV_MASK
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_PPLL_DIV_3
argument_list|,
name|pll_fb_post_div
argument_list|,
operator|~
name|RADEON_PPLL_POST3_DIV_MASK
argument_list|)
expr_stmt|;
name|radeon_pll_write_update
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|radeon_pll_wait_for_read_update_complete
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|RADEON_HTOTAL_CNTL
argument_list|,
name|htotal_cntl
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_PPLL_CNTL
argument_list|,
literal|0
argument_list|,
operator|~
operator|(
name|RADEON_PPLL_RESET
operator||
name|RADEON_PPLL_SLEEP
operator||
name|RADEON_PPLL_ATOMIC_UPDATE_EN
operator||
name|RADEON_PPLL_VGA_ATOMIC_UPDATE_EN
operator|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Wrote: 0x%08x 0x%08x 0x%08x (0x%08x)\n"
argument_list|,
name|pll_ref_div
argument_list|,
name|pll_fb_post_div
argument_list|,
operator|(
name|unsigned
operator|)
name|htotal_cntl
argument_list|,
name|RREG32_PLL
argument_list|(
name|RADEON_PPLL_CNTL
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Wrote: rd=%d, fd=%d, pd=%d\n"
argument_list|,
name|pll_ref_div
operator|&
name|RADEON_PPLL_REF_DIV_MASK
argument_list|,
name|pll_fb_post_div
operator|&
name|RADEON_PPLL_FB3_DIV_MASK
argument_list|,
operator|(
name|pll_fb_post_div
operator|&
name|RADEON_PPLL_POST3_DIV_MASK
operator|)
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|mdelay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/* Let the clock to lock */
name|WREG32_PLL_P
argument_list|(
name|RADEON_VCLK_ECP_CNTL
argument_list|,
name|RADEON_VCLK_SRC_SEL_PPLLCLK
argument_list|,
operator|~
operator|(
name|RADEON_VCLK_SRC_SEL_MASK
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_tv
condition|)
name|WREG32_PLL
argument_list|(
name|RADEON_PIXCLKS_CNTL
argument_list|,
name|pixclks_cntl
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_crtc_mode_fixup
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
specifier|const
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
if|if
condition|(
operator|!
name|radeon_crtc_scaling_mode_fixup
argument_list|(
name|crtc
argument_list|,
name|mode
argument_list|,
name|adjusted_mode
argument_list|)
condition|)
return|return
name|false
return|;
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_crtc_mode_set
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|struct
name|drm_framebuffer
modifier|*
name|old_fb
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
comment|/* TODO TV */
name|radeon_crtc_set_base
argument_list|(
name|crtc
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|old_fb
argument_list|)
expr_stmt|;
name|radeon_set_crtc_timing
argument_list|(
name|crtc
argument_list|,
name|adjusted_mode
argument_list|)
expr_stmt|;
name|radeon_set_pll
argument_list|(
name|crtc
argument_list|,
name|adjusted_mode
argument_list|)
expr_stmt|;
name|radeon_overscan_setup
argument_list|(
name|crtc
argument_list|,
name|adjusted_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|0
condition|)
block|{
name|radeon_legacy_rmx_mode_set
argument_list|(
name|crtc
argument_list|,
name|adjusted_mode
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|radeon_crtc
operator|->
name|rmx_type
operator|!=
name|RMX_OFF
condition|)
block|{
comment|/* FIXME: only first crtc has rmx what should we 			 * do ? 			 */
name|DRM_ERROR
argument_list|(
literal|"Mode need scaling but only first crtc can do that.\n"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_crtc_prepare
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtci
decl_stmt|;
name|radeon_crtc
operator|->
name|in_mode_set
operator|=
name|true
expr_stmt|;
comment|/* 	* The hardware wedges sometimes if you reconfigure one CRTC 	* whilst another is running (see fdo bug #24611). 	*/
name|list_for_each_entry
argument_list|(
argument|crtci
argument_list|,
argument|&dev->mode_config.crtc_list
argument_list|,
argument|head
argument_list|)
name|radeon_crtc_dpms
argument_list|(
name|crtci
argument_list|,
name|DRM_MODE_DPMS_OFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_crtc_commit
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtci
decl_stmt|;
comment|/* 	* Reenable the CRTCs that should be running. 	*/
name|list_for_each_entry
argument_list|(
argument|crtci
argument_list|,
argument|&dev->mode_config.crtc_list
argument_list|,
argument|head
argument_list|)
block|{
if|if
condition|(
name|crtci
operator|->
name|enabled
condition|)
name|radeon_crtc_dpms
argument_list|(
name|crtci
argument_list|,
name|DRM_MODE_DPMS_ON
argument_list|)
expr_stmt|;
block|}
name|radeon_crtc
operator|->
name|in_mode_set
operator|=
name|false
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_crtc_helper_funcs
name|legacy_helper_funcs
init|=
block|{
operator|.
name|dpms
operator|=
name|radeon_crtc_dpms
block|,
operator|.
name|mode_fixup
operator|=
name|radeon_crtc_mode_fixup
block|,
operator|.
name|mode_set
operator|=
name|radeon_crtc_mode_set
block|,
operator|.
name|mode_set_base
operator|=
name|radeon_crtc_set_base
block|,
operator|.
name|mode_set_base_atomic
operator|=
name|radeon_crtc_set_base_atomic
block|,
operator|.
name|prepare
operator|=
name|radeon_crtc_prepare
block|,
operator|.
name|commit
operator|=
name|radeon_crtc_commit
block|,
operator|.
name|load_lut
operator|=
name|radeon_crtc_load_lut
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|radeon_legacy_init_crtc
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
parameter_list|)
block|{
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|1
condition|)
name|radeon_crtc
operator|->
name|crtc_offset
operator|=
name|RADEON_CRTC2_H_TOTAL_DISP
operator|-
name|RADEON_CRTC_H_TOTAL_DISP
expr_stmt|;
name|drm_crtc_helper_add
argument_list|(
operator|&
name|radeon_crtc
operator|->
name|base
argument_list|,
operator|&
name|legacy_helper_funcs
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* r300_cmdbuf.c -- Command buffer emission for R300 -*- linux-c -*-  *  * Copyright (C) The Weather Channel, Inc.  2002.  * Copyright (C) 2004 Nicolai Haehnle.  * All Rights Reserved.  *  * The Weather Channel (TM) funded Tungsten Graphics to develop the  * initial release of the Radeon 8500 driver under the XFree86 license.  * This notice must be preserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Nicolai Haehnle<prefect_@gmx.net>  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_buffer.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon_drv.h"
end_include

begin_include
include|#
directive|include
file|"r300_reg.h"
end_include

begin_define
define|#
directive|define
name|R300_SIMULTANEOUS_CLIPRECTS
value|4
end_define

begin_comment
comment|/* Values for R300_RE_CLIPRECT_CNTL depending on the number of cliprects  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|int
name|r300_cliprect_cntl
index|[
literal|4
index|]
init|=
block|{
literal|0xAAAA
block|,
literal|0xEEEE
block|,
literal|0xFEFE
block|,
literal|0xFFFE
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * Emit up to R300_SIMULTANEOUS_CLIPRECTS cliprects from the given command  * buffer, starting with index n.  */
end_comment

begin_function
specifier|static
name|int
name|r300_emit_cliprects
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|struct
name|drm_clip_rect
name|box
decl_stmt|;
name|int
name|nr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|nr
operator|=
name|cmdbuf
operator|->
name|nbox
operator|-
name|n
expr_stmt|;
if|if
condition|(
name|nr
operator|>
name|R300_SIMULTANEOUS_CLIPRECTS
condition|)
name|nr
operator|=
name|R300_SIMULTANEOUS_CLIPRECTS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%i cliprects\n"
argument_list|,
name|nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|nr
condition|)
block|{
name|BEGIN_RING
argument_list|(
literal|6
operator|+
name|nr
operator|*
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_RE_CLIPRECT_TL_0
argument_list|,
name|nr
operator|*
literal|2
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|DRM_COPY_FROM_USER_UNCHECKED
argument_list|(
operator|&
name|box
argument_list|,
operator|&
name|cmdbuf
operator|->
name|boxes
index|[
name|n
operator|+
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|box
argument_list|)
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"copy cliprect faulted\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
name|box
operator|.
name|x2
operator|--
expr_stmt|;
comment|/* Hardware expects inclusive bottom-right corner */
name|box
operator|.
name|y2
operator|--
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV515
condition|)
block|{
name|box
operator|.
name|x1
operator|=
operator|(
name|box
operator|.
name|x1
operator|)
operator|&
name|R300_CLIPRECT_MASK
expr_stmt|;
name|box
operator|.
name|y1
operator|=
operator|(
name|box
operator|.
name|y1
operator|)
operator|&
name|R300_CLIPRECT_MASK
expr_stmt|;
name|box
operator|.
name|x2
operator|=
operator|(
name|box
operator|.
name|x2
operator|)
operator|&
name|R300_CLIPRECT_MASK
expr_stmt|;
name|box
operator|.
name|y2
operator|=
operator|(
name|box
operator|.
name|y2
operator|)
operator|&
name|R300_CLIPRECT_MASK
expr_stmt|;
block|}
else|else
block|{
name|box
operator|.
name|x1
operator|=
operator|(
name|box
operator|.
name|x1
operator|+
name|R300_CLIPRECT_OFFSET
operator|)
operator|&
name|R300_CLIPRECT_MASK
expr_stmt|;
name|box
operator|.
name|y1
operator|=
operator|(
name|box
operator|.
name|y1
operator|+
name|R300_CLIPRECT_OFFSET
operator|)
operator|&
name|R300_CLIPRECT_MASK
expr_stmt|;
name|box
operator|.
name|x2
operator|=
operator|(
name|box
operator|.
name|x2
operator|+
name|R300_CLIPRECT_OFFSET
operator|)
operator|&
name|R300_CLIPRECT_MASK
expr_stmt|;
name|box
operator|.
name|y2
operator|=
operator|(
name|box
operator|.
name|y2
operator|+
name|R300_CLIPRECT_OFFSET
operator|)
operator|&
name|R300_CLIPRECT_MASK
expr_stmt|;
block|}
name|OUT_RING
argument_list|(
operator|(
name|box
operator|.
name|x1
operator|<<
name|R300_CLIPRECT_X_SHIFT
operator|)
operator||
operator|(
name|box
operator|.
name|y1
operator|<<
name|R300_CLIPRECT_Y_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|box
operator|.
name|x2
operator|<<
name|R300_CLIPRECT_X_SHIFT
operator|)
operator||
operator|(
name|box
operator|.
name|y2
operator|<<
name|R300_CLIPRECT_Y_SHIFT
operator|)
argument_list|)
expr_stmt|;
block|}
name|OUT_RING_REG
argument_list|(
name|R300_RE_CLIPRECT_CNTL
argument_list|,
name|r300_cliprect_cntl
index|[
name|nr
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* TODO/SECURITY: Force scissors to a safe value, otherwise the 		 * client might be able to trample over memory. 		 * The impact should be very limited, but I'd rather be safe than 		 * sorry. 		 */
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_RE_SCISSORS_TL
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R300_SCISSORS_X_MASK
operator||
name|R300_SCISSORS_Y_MASK
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
else|else
block|{
comment|/* Why we allow zero cliprect rendering: 		 * There are some commands in a command buffer that must be submitted 		 * even when there are no cliprects, e.g. DMA buffer discard 		 * or state setting (though state setting could be avoided by 		 * simulating a loss of context). 		 * 		 * Now since the cmdbuf interface is so chaotic right now (and is 		 * bound to remain that way for a bit until things settle down), 		 * it is basically impossible to filter out the commands that are 		 * necessary and those that aren't. 		 * 		 * So I choose the safe way and don't do any filtering at all; 		 * instead, I simply set up the engine so that all rendering 		 * can't produce any fragments. 		 */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING_REG
argument_list|(
name|R300_RE_CLIPRECT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
comment|/* flus cache and wait idle clean after cliprect change */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R300_RB3D_DC_FLUSH
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_WAIT_3D_IDLECLEAN
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* set flush flag */
name|dev_priv
operator|->
name|track_flush
operator||=
name|RADEON_FLUSH_EMITED
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|u8
name|r300_reg_flags
index|[
literal|0x10000
operator|>>
literal|2
index|]
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|r300_init_reg_flags
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|memset
argument_list|(
name|r300_reg_flags
argument_list|,
literal|0
argument_list|,
literal|0x10000
operator|>>
literal|2
argument_list|)
expr_stmt|;
define|#
directive|define
name|ADD_RANGE_MARK
parameter_list|(
name|reg
parameter_list|,
name|count
parameter_list|,
name|mark
parameter_list|)
define|\
value|for(i=((reg)>>2);i<((reg)>>2)+(count);i++)\ 			r300_reg_flags[i]|=(mark);
define|#
directive|define
name|MARK_SAFE
value|1
define|#
directive|define
name|MARK_CHECK_OFFSET
value|2
define|#
directive|define
name|ADD_RANGE
parameter_list|(
name|reg
parameter_list|,
name|count
parameter_list|)
value|ADD_RANGE_MARK(reg, count, MARK_SAFE)
comment|/* these match cmducs() command in r300_driver/r300/r300_cmdbuf.c */
name|ADD_RANGE
argument_list|(
name|R300_SE_VPORT_XSCALE
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_CNTL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_SE_VTE_CNTL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x2134
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_CNTL_STATUS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_INPUT_CNTL_0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x21DC
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_UNKNOWN_221C
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_CLIP_X_0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_PVS_STATE_FLUSH_REG
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_UNKNOWN_2288
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_OUTPUT_VTX_FMT_0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_PVS_CNTL_1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_GB_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_GB_MSPOS0
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_TX_INVALTAGS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_TX_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x4200
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x4214
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RE_POINTSIZE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x4230
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RE_LINE_CNT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RE_UNK4238
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x4260
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RE_SHADE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RE_POLYGON_MODE
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RE_ZBIAS_CNTL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RE_ZBIAS_T_FACTOR
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RE_OCCLUSION_CNTL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RE_CULL_CNTL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x42C0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RS_CNTL_0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_SU_REG_DEST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV530
condition|)
name|ADD_RANGE
argument_list|(
name|RV530_FG_ZBREG_DEST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_SC_HYPERZ
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x43E8
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x46A4
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RE_FOG_STATE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_FOG_COLOR_R
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_PP_ALPHA_TEST
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x4BD8
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_PFS_PARAM_0_X
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x4E00
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RB3D_CBLEND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RB3D_COLORMASK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RB3D_BLEND_COLOR
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ADD_RANGE_MARK
argument_list|(
name|R300_RB3D_COLOROFFSET0
argument_list|,
literal|1
argument_list|,
name|MARK_CHECK_OFFSET
argument_list|)
expr_stmt|;
comment|/* check offset */
name|ADD_RANGE
argument_list|(
name|R300_RB3D_COLORPITCH0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x4E50
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x4E88
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
literal|0x4EA0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_ZB_CNTL
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_ZB_FORMAT
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ADD_RANGE_MARK
argument_list|(
name|R300_ZB_DEPTHOFFSET
argument_list|,
literal|1
argument_list|,
name|MARK_CHECK_OFFSET
argument_list|)
expr_stmt|;
comment|/* check offset */
name|ADD_RANGE
argument_list|(
name|R300_ZB_DEPTHPITCH
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_ZB_DEPTHCLEARVALUE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_ZB_ZMASK_OFFSET
argument_list|,
literal|13
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_ZB_ZPASS_DATA
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* ZB_ZPASS_DATA, ZB_ZPASS_ADDR */
name|ADD_RANGE
argument_list|(
name|R300_TX_FILTER_0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_TX_FILTER1_0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_TX_SIZE_0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_TX_FORMAT_0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_TX_PITCH_0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* Texture offset is dangerous and needs more checking */
name|ADD_RANGE_MARK
argument_list|(
name|R300_TX_OFFSET_0
argument_list|,
literal|16
argument_list|,
name|MARK_CHECK_OFFSET
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_TX_CHROMA_KEY_0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_TX_BORDER_COLOR_0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* Sporadic registers used as primitives are emitted */
name|ADD_RANGE
argument_list|(
name|R300_ZB_ZCACHE_CTLSTAT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_INPUT_ROUTE_0_0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_VAP_INPUT_ROUTE_1_0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV515
condition|)
block|{
name|ADD_RANGE
argument_list|(
name|R500_VAP_INDEX_OFFSET
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R500_US_CONFIG
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R500_US_CODE_ADDR
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R500_US_FC_CTRL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R500_RS_IP_0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R500_RS_INST_0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R500_RB3D_COLOR_CLEAR_VALUE_AR
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R500_RB3D_CONSTANT_COLOR_AR
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R500_ZB_FIFO_SIZE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ADD_RANGE
argument_list|(
name|R300_PFS_CNTL_0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_PFS_NODE_0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_PFS_TEXI_0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_PFS_INSTR0_0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_PFS_INSTR1_0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_PFS_INSTR2_0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_PFS_INSTR3_0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RS_INTERP_0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ADD_RANGE
argument_list|(
name|R300_RS_ROUTE_0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|r300_check_range
parameter_list|(
name|unsigned
name|reg
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|reg
operator|&
operator|~
literal|0xffff
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
operator|(
name|reg
operator|>>
literal|2
operator|)
init|;
name|i
operator|<
operator|(
name|reg
operator|>>
literal|2
operator|)
operator|+
name|count
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|r300_reg_flags
index|[
name|i
index|]
operator|!=
name|MARK_SAFE
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|r300_emit_carefully_checked_packet0
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|,
name|drm_r300_cmd_header_t
name|header
parameter_list|)
block|{
name|int
name|reg
decl_stmt|;
name|int
name|sz
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u32
modifier|*
name|value
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|sz
operator|=
name|header
operator|.
name|packet0
operator|.
name|count
expr_stmt|;
name|reg
operator|=
operator|(
name|header
operator|.
name|packet0
operator|.
name|reghi
operator|<<
literal|8
operator|)
operator||
name|header
operator|.
name|packet0
operator|.
name|reglo
expr_stmt|;
if|if
condition|(
operator|(
name|sz
operator|>
literal|64
operator|)
operator|||
operator|(
name|sz
operator|<
literal|0
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Cannot emit more than 64 values at a time (reg=%04x sz=%d)\n"
argument_list|,
name|reg
argument_list|,
name|sz
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sz
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|r300_reg_flags
index|[
operator|(
name|reg
operator|>>
literal|2
operator|)
operator|+
name|i
index|]
condition|)
block|{
case|case
name|MARK_SAFE
case|:
break|break;
case|case
name|MARK_CHECK_OFFSET
case|:
name|value
operator|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|radeon_check_offset
argument_list|(
name|dev_priv
argument_list|,
operator|*
name|value
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Offset failed range check (reg=%04x sz=%d)\n"
argument_list|,
name|reg
argument_list|,
name|sz
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Register %04x failed check as flag=%02x\n"
argument_list|,
name|reg
operator|+
name|i
operator|*
literal|4
argument_list|,
name|r300_reg_flags
index|[
operator|(
name|reg
operator|>>
literal|2
operator|)
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
name|BEGIN_RING
argument_list|(
literal|1
operator|+
name|sz
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|reg
argument_list|,
name|sz
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING_DRM_BUFFER
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Emits a packet0 setting arbitrary registers.  * Called by r300_do_cp_cmdbuf.  *  * Note that checks are performed on contents and addresses of the registers  */
end_comment

begin_function
specifier|static
name|__inline__
name|int
name|r300_emit_packet0
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|,
name|drm_r300_cmd_header_t
name|header
parameter_list|)
block|{
name|int
name|reg
decl_stmt|;
name|int
name|sz
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|sz
operator|=
name|header
operator|.
name|packet0
operator|.
name|count
expr_stmt|;
name|reg
operator|=
operator|(
name|header
operator|.
name|packet0
operator|.
name|reghi
operator|<<
literal|8
operator|)
operator||
name|header
operator|.
name|packet0
operator|.
name|reglo
expr_stmt|;
if|if
condition|(
operator|!
name|sz
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|sz
operator|*
literal|4
operator|>
name|drm_buffer_unprocessed
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|reg
operator|+
name|sz
operator|*
literal|4
operator|>=
literal|0x10000
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No such registers in hardware reg=%04x sz=%d\n"
argument_list|,
name|reg
argument_list|,
name|sz
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|r300_check_range
argument_list|(
name|reg
argument_list|,
name|sz
argument_list|)
condition|)
block|{
comment|/* go and check everything */
return|return
name|r300_emit_carefully_checked_packet0
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|,
name|header
argument_list|)
return|;
block|}
comment|/* the rest of the data is safe to emit, whatever the values the user passed */
name|BEGIN_RING
argument_list|(
literal|1
operator|+
name|sz
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|reg
argument_list|,
name|sz
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING_DRM_BUFFER
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Uploads user-supplied vertex program instructions or parameters onto  * the graphics card.  * Called by r300_do_cp_cmdbuf.  */
end_comment

begin_function
specifier|static
name|__inline__
name|int
name|r300_emit_vpu
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|,
name|drm_r300_cmd_header_t
name|header
parameter_list|)
block|{
name|int
name|sz
decl_stmt|;
name|int
name|addr
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|sz
operator|=
name|header
operator|.
name|vpu
operator|.
name|count
expr_stmt|;
name|addr
operator|=
operator|(
name|header
operator|.
name|vpu
operator|.
name|adrhi
operator|<<
literal|8
operator|)
operator||
name|header
operator|.
name|vpu
operator|.
name|adrlo
expr_stmt|;
if|if
condition|(
operator|!
name|sz
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|sz
operator|*
literal|16
operator|>
name|drm_buffer_unprocessed
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* VAP is very sensitive so we purge cache before we program it 	 * and we also flush its state before& after */
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R300_RB3D_DC_FLUSH
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_WAIT_3D_IDLECLEAN
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_VAP_PVS_STATE_FLUSH_REG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* set flush flag */
name|dev_priv
operator|->
name|track_flush
operator||=
name|RADEON_FLUSH_EMITED
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|3
operator|+
name|sz
operator|*
literal|4
argument_list|)
expr_stmt|;
name|OUT_RING_REG
argument_list|(
name|R300_VAP_PVS_UPLOAD_ADDRESS
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0_TABLE
argument_list|(
name|R300_VAP_PVS_UPLOAD_DATA
argument_list|,
name|sz
operator|*
literal|4
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING_DRM_BUFFER
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|sz
operator|*
literal|4
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_VAP_PVS_STATE_FLUSH_REG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Emit a clear packet from userspace.  * Called by r300_emit_packet3.  */
end_comment

begin_function
specifier|static
name|__inline__
name|int
name|r300_emit_clear
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|)
block|{
name|RING_LOCALS
expr_stmt|;
if|if
condition|(
literal|8
operator|*
literal|4
operator|>
name|drm_buffer_unprocessed
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|BEGIN_RING
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|R200_3D_DRAW_IMMD_2
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R300_PRIM_TYPE_POINT
operator||
name|R300_PRIM_WALK_RING
operator||
operator|(
literal|1
operator|<<
name|R300_PRIM_NUM_VERTICES_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|OUT_RING_DRM_BUFFER
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R300_RB3D_DC_FLUSH
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_WAIT_3D_IDLECLEAN
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* set flush flag */
name|dev_priv
operator|->
name|track_flush
operator||=
name|RADEON_FLUSH_EMITED
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|r300_emit_3d_load_vbpntr
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|,
name|u32
name|header
parameter_list|)
block|{
name|int
name|count
decl_stmt|,
name|i
decl_stmt|,
name|k
decl_stmt|;
define|#
directive|define
name|MAX_ARRAY_PACKET
value|64
name|u32
modifier|*
name|data
decl_stmt|;
name|u32
name|narrays
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|count
operator|=
operator|(
name|header
operator|&
name|RADEON_CP_PACKET_COUNT_MASK
operator|)
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
operator|(
name|count
operator|+
literal|1
operator|)
operator|>
name|MAX_ARRAY_PACKET
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Too large payload in 3D_LOAD_VBPNTR (count=%d)\n"
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* carefully check packet contents */
comment|/* We have already read the header so advance the buffer. */
name|drm_buffer_advance
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|narrays
operator|=
operator|*
operator|(
name|u32
operator|*
operator|)
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
name|i
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|k
operator|<
name|narrays
operator|)
operator|&&
operator|(
name|i
operator|<
operator|(
name|count
operator|+
literal|1
operator|)
operator|)
condition|)
block|{
name|i
operator|++
expr_stmt|;
comment|/* skip attribute field */
name|data
operator|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|radeon_check_offset
argument_list|(
name|dev_priv
argument_list|,
operator|*
name|data
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Offset failed range check (k=%d i=%d) while processing 3D_LOAD_VBPNTR packet.\n"
argument_list|,
name|k
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|k
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|narrays
condition|)
break|break;
comment|/* have one more to process, they come in pairs */
name|data
operator|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|radeon_check_offset
argument_list|(
name|dev_priv
argument_list|,
operator|*
name|data
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Offset failed range check (k=%d i=%d) while processing 3D_LOAD_VBPNTR packet.\n"
argument_list|,
name|k
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|k
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
comment|/* do the counts match what we expect ? */
if|if
condition|(
operator|(
name|k
operator|!=
name|narrays
operator|)
operator|||
operator|(
name|i
operator|!=
operator|(
name|count
operator|+
literal|1
operator|)
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Malformed 3D_LOAD_VBPNTR packet (k=%d i=%d narrays=%d count+1=%d).\n"
argument_list|,
name|k
argument_list|,
name|i
argument_list|,
name|narrays
argument_list|,
name|count
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* all clear, output packet */
name|BEGIN_RING
argument_list|(
name|count
operator|+
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|OUT_RING_DRM_BUFFER
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|count
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|r300_emit_bitblt_multi
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|)
block|{
name|u32
modifier|*
name|cmd
init|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|int
name|count
decl_stmt|,
name|ret
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|count
operator|=
operator|(
operator|*
name|cmd
operator|&
name|RADEON_CP_PACKET_COUNT_MASK
operator|)
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
operator|*
name|cmd
operator|&
literal|0x8000
condition|)
block|{
name|u32
name|offset
decl_stmt|;
name|u32
modifier|*
name|cmd1
init|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|cmd1
operator|&
operator|(
name|RADEON_GMC_SRC_PITCH_OFFSET_CNTL
operator||
name|RADEON_GMC_DST_PITCH_OFFSET_CNTL
operator|)
condition|)
block|{
name|u32
modifier|*
name|cmd2
init|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|offset
operator|=
operator|*
name|cmd2
operator|<<
literal|10
expr_stmt|;
name|ret
operator|=
operator|!
name|radeon_check_offset
argument_list|(
name|dev_priv
argument_list|,
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid bitblt first offset is %08X\n"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
if|if
condition|(
operator|(
operator|*
name|cmd1
operator|&
name|RADEON_GMC_SRC_PITCH_OFFSET_CNTL
operator|)
operator|&&
operator|(
operator|*
name|cmd1
operator|&
name|RADEON_GMC_DST_PITCH_OFFSET_CNTL
operator|)
condition|)
block|{
name|u32
modifier|*
name|cmd3
init|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|3
argument_list|)
decl_stmt|;
name|offset
operator|=
operator|*
name|cmd3
operator|<<
literal|10
expr_stmt|;
name|ret
operator|=
operator|!
name|radeon_check_offset
argument_list|(
name|dev_priv
argument_list|,
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid bitblt second offset is %08X\n"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
name|BEGIN_RING
argument_list|(
name|count
operator|+
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING_DRM_BUFFER
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|count
operator|+
literal|2
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|r300_emit_draw_indx_2
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|)
block|{
name|u32
modifier|*
name|cmd
init|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|u32
modifier|*
name|cmd1
init|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|expected_count
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|count
operator|=
operator|(
operator|*
name|cmd
operator|&
name|RADEON_CP_PACKET_COUNT_MASK
operator|)
operator|>>
literal|16
expr_stmt|;
name|expected_count
operator|=
operator|*
name|cmd1
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|*
name|cmd1
operator|&
name|R300_VAP_VF_CNTL__INDEX_SIZE_32bit
operator|)
condition|)
name|expected_count
operator|=
operator|(
name|expected_count
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|count
operator|&&
name|count
operator|!=
name|expected_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"3D_DRAW_INDX_2: packet size %i, expected %i\n"
argument_list|,
name|count
argument_list|,
name|expected_count
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|BEGIN_RING
argument_list|(
name|count
operator|+
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING_DRM_BUFFER
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|count
operator|+
literal|2
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|count
condition|)
block|{
name|drm_r300_cmd_header_t
name|stack_header
decl_stmt|,
modifier|*
name|header
decl_stmt|;
name|u32
modifier|*
name|cmd1
decl_stmt|,
modifier|*
name|cmd2
decl_stmt|,
modifier|*
name|cmd3
decl_stmt|;
if|if
condition|(
name|drm_buffer_unprocessed
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|)
operator|<
literal|4
operator|*
literal|4
operator|+
sizeof|sizeof
argument_list|(
name|stack_header
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"3D_DRAW_INDX_2: expect subsequent INDX_BUFFER, but stream is too short.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|header
operator|=
name|drm_buffer_read_object
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|stack_header
argument_list|)
argument_list|,
operator|&
name|stack_header
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cmd1
operator|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cmd2
operator|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|cmd3
operator|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
operator|->
name|header
operator|.
name|cmd_type
operator|!=
name|R300_CMD_PACKET3
operator|||
name|header
operator|->
name|packet3
operator|.
name|packet
operator|!=
name|R300_CMD_PACKET3_RAW
operator|||
operator|*
name|cmd
operator|!=
name|CP_PACKET3
argument_list|(
name|RADEON_CP_INDX_BUFFER
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"3D_DRAW_INDX_2: expect subsequent INDX_BUFFER.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
operator|*
name|cmd1
operator|&
literal|0x8000ffff
operator|)
operator|!=
literal|0x80000810
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid indx_buffer reg address %08X\n"
argument_list|,
operator|*
name|cmd1
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|radeon_check_offset
argument_list|(
name|dev_priv
argument_list|,
operator|*
name|cmd2
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid indx_buffer offset is %08X\n"
argument_list|,
operator|*
name|cmd2
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|*
name|cmd3
operator|!=
name|expected_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"INDX_BUFFER: buffer size %i, expected %i\n"
argument_list|,
operator|*
name|cmd3
argument_list|,
name|expected_count
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|OUT_RING_DRM_BUFFER
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|r300_emit_raw_packet3
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|)
block|{
name|u32
modifier|*
name|header
decl_stmt|;
name|int
name|count
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
if|if
condition|(
literal|4
operator|>
name|drm_buffer_unprocessed
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Fixme !! This simply emits a packet without much checking. 	   We need to be smarter. */
comment|/* obtain first word - actual packet3 header */
name|header
operator|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Is it packet 3 ? */
if|if
condition|(
operator|(
operator|*
name|header
operator|>>
literal|30
operator|)
operator|!=
literal|0x3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Not a packet3 header (0x%08x)\n"
argument_list|,
operator|*
name|header
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|count
operator|=
operator|(
operator|*
name|header
operator|>>
literal|16
operator|)
operator|&
literal|0x3fff
expr_stmt|;
comment|/* Check again now that we know how much data to expect */
if|if
condition|(
operator|(
name|count
operator|+
literal|2
operator|)
operator|*
literal|4
operator|>
name|drm_buffer_unprocessed
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Expected packet3 of length %d but have only %d bytes left\n"
argument_list|,
operator|(
name|count
operator|+
literal|2
operator|)
operator|*
literal|4
argument_list|,
name|drm_buffer_unprocessed
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Is it a packet type we know about ? */
switch|switch
condition|(
operator|*
name|header
operator|&
literal|0xff00
condition|)
block|{
case|case
name|RADEON_3D_LOAD_VBPNTR
case|:
comment|/* load vertex array pointers */
return|return
name|r300_emit_3d_load_vbpntr
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|,
operator|*
name|header
argument_list|)
return|;
case|case
name|RADEON_CNTL_BITBLT_MULTI
case|:
return|return
name|r300_emit_bitblt_multi
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|)
return|;
case|case
name|RADEON_CP_INDX_BUFFER
case|:
name|DRM_ERROR
argument_list|(
literal|"packet3 INDX_BUFFER without preceding 3D_DRAW_INDX_2 is illegal.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
case|case
name|RADEON_CP_3D_DRAW_IMMD_2
case|:
comment|/* triggers drawing using in-packet vertex data */
case|case
name|RADEON_CP_3D_DRAW_VBUF_2
case|:
comment|/* triggers drawing of vertex buffers setup elsewhere */
name|dev_priv
operator|->
name|track_flush
operator|&=
operator|~
operator|(
name|RADEON_FLUSH_EMITED
operator||
name|RADEON_PURGE_EMITED
operator|)
expr_stmt|;
break|break;
case|case
name|RADEON_CP_3D_DRAW_INDX_2
case|:
comment|/* triggers drawing using indices to vertex buffer */
comment|/* whenever we send vertex we clear flush& purge */
name|dev_priv
operator|->
name|track_flush
operator|&=
operator|~
operator|(
name|RADEON_FLUSH_EMITED
operator||
name|RADEON_PURGE_EMITED
operator|)
expr_stmt|;
return|return
name|r300_emit_draw_indx_2
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|)
return|;
case|case
name|RADEON_WAIT_FOR_IDLE
case|:
case|case
name|RADEON_CP_NOP
case|:
comment|/* these packets are safe */
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet3 header (0x%08x)\n"
argument_list|,
operator|*
name|header
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|BEGIN_RING
argument_list|(
name|count
operator|+
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING_DRM_BUFFER
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|count
operator|+
literal|2
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Emit a rendering packet3 from userspace.  * Called by r300_do_cp_cmdbuf.  */
end_comment

begin_function
specifier|static
name|__inline__
name|int
name|r300_emit_packet3
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|,
name|drm_r300_cmd_header_t
name|header
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|orig_iter
init|=
name|cmdbuf
operator|->
name|buffer
operator|->
name|iterator
decl_stmt|;
comment|/* This is a do-while-loop so that we run the interior at least once, 	 * even if cmdbuf->nbox is 0. Compare r300_emit_cliprects for rationale. 	 */
name|n
operator|=
literal|0
expr_stmt|;
do|do
block|{
if|if
condition|(
name|cmdbuf
operator|->
name|nbox
operator|>
name|R300_SIMULTANEOUS_CLIPRECTS
condition|)
block|{
name|ret
operator|=
name|r300_emit_cliprects
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|cmdbuf
operator|->
name|buffer
operator|->
name|iterator
operator|=
name|orig_iter
expr_stmt|;
block|}
switch|switch
condition|(
name|header
operator|.
name|packet3
operator|.
name|packet
condition|)
block|{
case|case
name|R300_CMD_PACKET3_CLEAR
case|:
name|DRM_DEBUG
argument_list|(
literal|"R300_CMD_PACKET3_CLEAR\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|r300_emit_clear
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r300_emit_clear failed\n"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
break|break;
case|case
name|R300_CMD_PACKET3_RAW
case|:
name|DRM_DEBUG
argument_list|(
literal|"R300_CMD_PACKET3_RAW\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|r300_emit_raw_packet3
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r300_emit_raw_packet3 failed\n"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"bad packet3 type %i at byte %d\n"
argument_list|,
name|header
operator|.
name|packet3
operator|.
name|packet
argument_list|,
name|cmdbuf
operator|->
name|buffer
operator|->
name|iterator
operator|-
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|header
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|n
operator|+=
name|R300_SIMULTANEOUS_CLIPRECTS
expr_stmt|;
block|}
do|while
condition|(
name|n
operator|<
name|cmdbuf
operator|->
name|nbox
condition|)
do|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Some of the R300 chips seem to be extremely touchy about the two registers  * that are configured in r300_pacify.  * Among the worst offenders seems to be the R300 ND (0x4E44): When userspace  * sends a command buffer that contains only state setting commands and a  * vertex program/parameter upload sequence, this will eventually lead to a  * lockup, unless the sequence is bracketed by calls to r300_pacify.  * So we should take great care to *always* call r300_pacify before  * *anything* 3D related, and again afterwards. This is what the  * call bracket in r300_do_cp_cmdbuf is for.  */
end_comment

begin_comment
comment|/**  * Emit the sequence to pacify R300.  */
end_comment

begin_function
specifier|static
name|void
name|r300_pacify
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|uint32_t
name|cache_z
decl_stmt|,
name|cache_3d
decl_stmt|,
name|cache_2d
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|cache_z
operator|=
name|R300_ZC_FLUSH
expr_stmt|;
name|cache_2d
operator|=
name|R300_RB2D_DC_FLUSH
expr_stmt|;
name|cache_3d
operator|=
name|R300_RB3D_DC_FLUSH
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|dev_priv
operator|->
name|track_flush
operator|&
name|RADEON_PURGE_EMITED
operator|)
condition|)
block|{
comment|/* we can purge, primitive where draw since last purge */
name|cache_z
operator||=
name|R300_ZC_FREE
expr_stmt|;
name|cache_2d
operator||=
name|R300_RB2D_DC_FREE
expr_stmt|;
name|cache_3d
operator||=
name|R300_RB3D_DC_FREE
expr_stmt|;
block|}
comment|/* flush& purge zbuffer */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_ZB_ZCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|cache_z
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* flush& purge 3d */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|cache_3d
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* flush& purge texture */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_TX_INVALTAGS
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* FIXME: is this one really needed ? */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_RB3D_AARESOLVE_CTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_WAIT_3D_IDLECLEAN
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* flush& purge 2d through E2 as RB2D will trigger lockup */
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|R300_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|cache_2d
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_WAIT_2D_IDLECLEAN
operator||
name|RADEON_WAIT_HOST_IDLECLEAN
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* set flush& purge flags */
name|dev_priv
operator|->
name|track_flush
operator||=
name|RADEON_FLUSH_EMITED
operator||
name|RADEON_PURGE_EMITED
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Called by r300_do_cp_cmdbuf to update the internal buffer age and state.  * The actual age emit is done by r300_do_cp_cmdbuf, which is why you must  * be careful about how this function is called.  */
end_comment

begin_function
specifier|static
name|void
name|r300_discard_buffer
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_master
modifier|*
name|master
parameter_list|,
name|struct
name|drm_buf
modifier|*
name|buf
parameter_list|)
block|{
name|drm_radeon_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_radeon_master_private
modifier|*
name|master_priv
init|=
name|master
operator|->
name|driver_priv
decl_stmt|;
name|buf_priv
operator|->
name|age
operator|=
operator|++
name|master_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|1
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r300_cmd_wait
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_r300_cmd_header_t
name|header
parameter_list|)
block|{
name|u32
name|wait_until
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
if|if
condition|(
operator|!
name|header
operator|.
name|wait
operator|.
name|flags
condition|)
return|return;
name|wait_until
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|header
operator|.
name|wait
operator|.
name|flags
condition|)
block|{
case|case
name|R300_WAIT_2D
case|:
name|wait_until
operator|=
name|RADEON_WAIT_2D_IDLE
expr_stmt|;
break|break;
case|case
name|R300_WAIT_3D
case|:
name|wait_until
operator|=
name|RADEON_WAIT_3D_IDLE
expr_stmt|;
break|break;
case|case
name|R300_NEW_WAIT_2D_3D
case|:
name|wait_until
operator|=
name|RADEON_WAIT_2D_IDLE
operator||
name|RADEON_WAIT_3D_IDLE
expr_stmt|;
break|break;
case|case
name|R300_NEW_WAIT_2D_2D_CLEAN
case|:
name|wait_until
operator|=
name|RADEON_WAIT_2D_IDLE
operator||
name|RADEON_WAIT_2D_IDLECLEAN
expr_stmt|;
break|break;
case|case
name|R300_NEW_WAIT_3D_3D_CLEAN
case|:
name|wait_until
operator|=
name|RADEON_WAIT_3D_IDLE
operator||
name|RADEON_WAIT_3D_IDLECLEAN
expr_stmt|;
break|break;
case|case
name|R300_NEW_WAIT_2D_2D_CLEAN_3D_3D_CLEAN
case|:
name|wait_until
operator|=
name|RADEON_WAIT_2D_IDLE
operator||
name|RADEON_WAIT_2D_IDLECLEAN
expr_stmt|;
name|wait_until
operator||=
name|RADEON_WAIT_3D_IDLE
operator||
name|RADEON_WAIT_3D_IDLECLEAN
expr_stmt|;
break|break;
default|default:
return|return;
block|}
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|wait_until
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|r300_scratch
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|,
name|drm_r300_cmd_header_t
name|header
parameter_list|)
block|{
name|u32
modifier|*
name|ref_age_base
decl_stmt|;
name|u32
name|i
decl_stmt|,
modifier|*
name|buf_idx
decl_stmt|,
name|h_pending
decl_stmt|;
name|u64
modifier|*
name|ptr_addr
decl_stmt|;
name|u64
name|stack_ptr_addr
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
if|if
condition|(
name|drm_buffer_unprocessed
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|)
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
operator|+
name|header
operator|.
name|scratch
operator|.
name|n_bufs
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|buf_idx
argument_list|)
operator|)
condition|)
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|header
operator|.
name|scratch
operator|.
name|reg
operator|>=
literal|5
condition|)
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
name|dev_priv
operator|->
name|scratch_ages
index|[
name|header
operator|.
name|scratch
operator|.
name|reg
index|]
operator|++
expr_stmt|;
name|ptr_addr
operator|=
name|drm_buffer_read_object
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|stack_ptr_addr
argument_list|)
argument_list|,
operator|&
name|stack_ptr_addr
argument_list|)
expr_stmt|;
name|ref_age_base
operator|=
operator|(
name|u32
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|get_unaligned
argument_list|(
name|ptr_addr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|header
operator|.
name|scratch
operator|.
name|n_bufs
condition|;
name|i
operator|++
control|)
block|{
name|buf_idx
operator|=
name|drm_buffer_pointer_to_dword
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|buf_idx
operator|*=
literal|2
expr_stmt|;
comment|/* 8 bytes per buf */
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
name|ref_age_base
operator|+
operator|*
name|buf_idx
argument_list|,
operator|&
name|dev_priv
operator|->
name|scratch_ages
index|[
name|header
operator|.
name|scratch
operator|.
name|reg
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
operator|&
name|h_pending
argument_list|,
name|ref_age_base
operator|+
operator|*
name|buf_idx
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|h_pending
operator|==
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|h_pending
operator|--
expr_stmt|;
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
name|ref_age_base
operator|+
operator|*
name|buf_idx
operator|+
literal|1
argument_list|,
operator|&
name|h_pending
argument_list|,
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|drm_buffer_advance
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|buf_idx
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_SCRATCH_REG0
operator|+
name|header
operator|.
name|scratch
operator|.
name|reg
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|scratch_ages
index|[
name|header
operator|.
name|scratch
operator|.
name|reg
index|]
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Uploads user-supplied vertex program instructions or parameters onto  * the graphics card.  * Called by r300_do_cp_cmdbuf.  */
end_comment

begin_function
specifier|static
specifier|inline
name|int
name|r300_emit_r500fp
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|,
name|drm_r300_cmd_header_t
name|header
parameter_list|)
block|{
name|int
name|sz
decl_stmt|;
name|int
name|addr
decl_stmt|;
name|int
name|type
decl_stmt|;
name|int
name|isclamp
decl_stmt|;
name|int
name|stride
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|sz
operator|=
name|header
operator|.
name|r500fp
operator|.
name|count
expr_stmt|;
comment|/* address is 9 bits 0 - 8, bit 1 of flags is part of address */
name|addr
operator|=
operator|(
operator|(
name|header
operator|.
name|r500fp
operator|.
name|adrhi_flags
operator|&
literal|1
operator|)
operator|<<
literal|8
operator|)
operator||
name|header
operator|.
name|r500fp
operator|.
name|adrlo
expr_stmt|;
name|type
operator|=
operator|!
operator|!
operator|(
name|header
operator|.
name|r500fp
operator|.
name|adrhi_flags
operator|&
name|R500FP_CONSTANT_TYPE
operator|)
expr_stmt|;
name|isclamp
operator|=
operator|!
operator|!
operator|(
name|header
operator|.
name|r500fp
operator|.
name|adrhi_flags
operator|&
name|R500FP_CONSTANT_CLAMP
operator|)
expr_stmt|;
name|addr
operator||=
operator|(
name|type
operator|<<
literal|16
operator|)
expr_stmt|;
name|addr
operator||=
operator|(
name|isclamp
operator|<<
literal|17
operator|)
expr_stmt|;
name|stride
operator|=
name|type
condition|?
literal|4
else|:
literal|6
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"r500fp %d %d type: %d\n"
argument_list|,
name|sz
argument_list|,
name|addr
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sz
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|sz
operator|*
name|stride
operator|*
literal|4
operator|>
name|drm_buffer_unprocessed
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|BEGIN_RING
argument_list|(
literal|3
operator|+
name|sz
operator|*
name|stride
argument_list|)
expr_stmt|;
name|OUT_RING_REG
argument_list|(
name|R500_GA_US_VECTOR_INDEX
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0_TABLE
argument_list|(
name|R500_GA_US_VECTOR_DATA
argument_list|,
name|sz
operator|*
name|stride
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING_DRM_BUFFER
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
name|sz
operator|*
name|stride
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Parses and validates a user-supplied command buffer and emits appropriate  * commands on the DMA ring buffer.  * Called by the ioctl handler function radeon_cp_cmdbuf.  */
end_comment

begin_function
name|int
name|r300_do_cp_cmdbuf
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|,
name|drm_radeon_kcmd_buffer_t
modifier|*
name|cmdbuf
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_radeon_master_private
modifier|*
name|master_priv
init|=
name|file_priv
operator|->
name|masterp
operator|->
name|driver_priv
decl_stmt|;
name|struct
name|drm_device_dma
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|struct
name|drm_buf
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|int
name|emit_dispatch_age
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* pacify */
name|r300_pacify
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdbuf
operator|->
name|nbox
operator|<=
name|R300_SIMULTANEOUS_CLIPRECTS
condition|)
block|{
name|ret
operator|=
name|r300_emit_cliprects
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|cleanup
goto|;
block|}
while|while
condition|(
name|drm_buffer_unprocessed
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|drm_r300_cmd_header_t
argument_list|)
condition|)
block|{
name|int
name|idx
decl_stmt|;
name|drm_r300_cmd_header_t
modifier|*
name|header
decl_stmt|,
name|stack_header
decl_stmt|;
name|header
operator|=
name|drm_buffer_read_object
argument_list|(
name|cmdbuf
operator|->
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|stack_header
argument_list|)
argument_list|,
operator|&
name|stack_header
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|header
operator|->
name|header
operator|.
name|cmd_type
condition|)
block|{
case|case
name|R300_CMD_PACKET0
case|:
name|DRM_DEBUG
argument_list|(
literal|"R300_CMD_PACKET0\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|r300_emit_packet0
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|,
operator|*
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r300_emit_packet0 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
break|break;
case|case
name|R300_CMD_VPU
case|:
name|DRM_DEBUG
argument_list|(
literal|"R300_CMD_VPU\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|r300_emit_vpu
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|,
operator|*
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r300_emit_vpu failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
break|break;
case|case
name|R300_CMD_PACKET3
case|:
name|DRM_DEBUG
argument_list|(
literal|"R300_CMD_PACKET3\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|r300_emit_packet3
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|,
operator|*
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r300_emit_packet3 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
break|break;
case|case
name|R300_CMD_END3D
case|:
name|DRM_DEBUG
argument_list|(
literal|"R300_CMD_END3D\n"
argument_list|)
expr_stmt|;
comment|/* TODO: 			   Ideally userspace driver should not need to issue this call, 			   i.e. the drm driver should issue it automatically and prevent 			   lockups.  			   In practice, we do not understand why this call is needed and what 			   it does (except for some vague guesses that it has to do with cache 			   coherence) and so the user space driver does it.  			   Once we are sure which uses prevent lockups the code could be moved 			   into the kernel and the userspace driver will not 			   need to use this command.  			   Note that issuing this command does not hurt anything 			   except, possibly, performance */
name|r300_pacify
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
break|break;
case|case
name|R300_CMD_CP_DELAY
case|:
comment|/* simple enough, we can do it here */
name|DRM_DEBUG
argument_list|(
literal|"R300_CMD_CP_DELAY\n"
argument_list|)
expr_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|BEGIN_RING
argument_list|(
name|header
operator|->
name|delay
operator|.
name|count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|header
operator|->
name|delay
operator|.
name|count
condition|;
name|i
operator|++
control|)
name|OUT_RING
argument_list|(
name|RADEON_CP_PACKET2
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|R300_CMD_DMA_DISCARD
case|:
name|DRM_DEBUG
argument_list|(
literal|"RADEON_CMD_DMA_DISCARD\n"
argument_list|)
expr_stmt|;
name|idx
operator|=
name|header
operator|->
name|dma
operator|.
name|buf_idx
expr_stmt|;
if|if
condition|(
name|idx
operator|<
literal|0
operator|||
name|idx
operator|>=
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer index %d (of %d max)\n"
argument_list|,
name|idx
argument_list|,
name|dma
operator|->
name|buf_count
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|idx
index|]
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|file_priv
operator|!=
name|file_priv
operator|||
name|buf
operator|->
name|pending
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad buffer %p %p %d\n"
argument_list|,
name|buf
operator|->
name|file_priv
argument_list|,
name|file_priv
argument_list|,
name|buf
operator|->
name|pending
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|emit_dispatch_age
operator|=
literal|1
expr_stmt|;
name|r300_discard_buffer
argument_list|(
name|dev
argument_list|,
name|file_priv
operator|->
name|masterp
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
name|R300_CMD_WAIT
case|:
name|DRM_DEBUG
argument_list|(
literal|"R300_CMD_WAIT\n"
argument_list|)
expr_stmt|;
name|r300_cmd_wait
argument_list|(
name|dev_priv
argument_list|,
operator|*
name|header
argument_list|)
expr_stmt|;
break|break;
case|case
name|R300_CMD_SCRATCH
case|:
name|DRM_DEBUG
argument_list|(
literal|"R300_CMD_SCRATCH\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|r300_scratch
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|,
operator|*
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r300_scratch failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
break|break;
case|case
name|R300_CMD_R500FP
case|:
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|<
name|CHIP_RV515
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Calling r500 command on r300 card\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"R300_CMD_R500FP\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|r300_emit_r500fp
argument_list|(
name|dev_priv
argument_list|,
name|cmdbuf
argument_list|,
operator|*
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r300_emit_r500fp failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"bad cmd_type %i at byte %d\n"
argument_list|,
name|header
operator|->
name|header
operator|.
name|cmd_type
argument_list|,
name|cmdbuf
operator|->
name|buffer
operator|->
name|iterator
operator|-
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|header
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
name|DRM_DEBUG
argument_list|(
literal|"END\n"
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|r300_pacify
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* We emit the vertex buffer age here, outside the pacifier "brackets" 	 * for two reasons: 	 *  (1) This may coalesce multiple age emissions into a single one and 	 *  (2) more importantly, some chips lock up hard when scratch registers 	 *      are written inside the pacifier bracket. 	 */
if|if
condition|(
name|emit_dispatch_age
condition|)
block|{
name|RING_LOCALS
expr_stmt|;
comment|/* Emit the vertex buffer age */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|RADEON_DISPATCH_AGE
argument_list|(
name|master_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


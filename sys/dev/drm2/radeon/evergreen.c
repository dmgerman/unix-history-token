begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2010 Advanced Micro Devices, Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Alex Deucher  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"evergreend.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"avivod.h"
end_include

begin_include
include|#
directive|include
file|"evergreen_reg.h"
end_include

begin_include
include|#
directive|include
file|"evergreen_blit_shaders.h"
end_include

begin_define
define|#
directive|define
name|EVERGREEN_PFP_UCODE_SIZE
value|1120
end_define

begin_define
define|#
directive|define
name|EVERGREEN_PM4_UCODE_SIZE
value|1376
end_define

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|crtc_offsets
index|[
literal|6
index|]
init|=
block|{
name|EVERGREEN_CRTC0_REGISTER_OFFSET
block|,
name|EVERGREEN_CRTC1_REGISTER_OFFSET
block|,
name|EVERGREEN_CRTC2_REGISTER_OFFSET
block|,
name|EVERGREEN_CRTC3_REGISTER_OFFSET
block|,
name|EVERGREEN_CRTC4_REGISTER_OFFSET
block|,
name|EVERGREEN_CRTC5_REGISTER_OFFSET
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|evergreen_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|evergreen_pcie_gen2_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|evergreen_tiling_fields
parameter_list|(
name|unsigned
name|tiling_flags
parameter_list|,
name|unsigned
modifier|*
name|bankw
parameter_list|,
name|unsigned
modifier|*
name|bankh
parameter_list|,
name|unsigned
modifier|*
name|mtaspect
parameter_list|,
name|unsigned
modifier|*
name|tile_split
parameter_list|)
block|{
operator|*
name|bankw
operator|=
operator|(
name|tiling_flags
operator|>>
name|RADEON_TILING_EG_BANKW_SHIFT
operator|)
operator|&
name|RADEON_TILING_EG_BANKW_MASK
expr_stmt|;
operator|*
name|bankh
operator|=
operator|(
name|tiling_flags
operator|>>
name|RADEON_TILING_EG_BANKH_SHIFT
operator|)
operator|&
name|RADEON_TILING_EG_BANKH_MASK
expr_stmt|;
operator|*
name|mtaspect
operator|=
operator|(
name|tiling_flags
operator|>>
name|RADEON_TILING_EG_MACRO_TILE_ASPECT_SHIFT
operator|)
operator|&
name|RADEON_TILING_EG_MACRO_TILE_ASPECT_MASK
expr_stmt|;
operator|*
name|tile_split
operator|=
operator|(
name|tiling_flags
operator|>>
name|RADEON_TILING_EG_TILE_SPLIT_SHIFT
operator|)
operator|&
name|RADEON_TILING_EG_TILE_SPLIT_MASK
expr_stmt|;
switch|switch
condition|(
operator|*
name|bankw
condition|)
block|{
default|default:
case|case
literal|1
case|:
operator|*
name|bankw
operator|=
name|EVERGREEN_ADDR_SURF_BANK_WIDTH_1
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|*
name|bankw
operator|=
name|EVERGREEN_ADDR_SURF_BANK_WIDTH_2
expr_stmt|;
break|break;
case|case
literal|4
case|:
operator|*
name|bankw
operator|=
name|EVERGREEN_ADDR_SURF_BANK_WIDTH_4
expr_stmt|;
break|break;
case|case
literal|8
case|:
operator|*
name|bankw
operator|=
name|EVERGREEN_ADDR_SURF_BANK_WIDTH_8
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
operator|*
name|bankh
condition|)
block|{
default|default:
case|case
literal|1
case|:
operator|*
name|bankh
operator|=
name|EVERGREEN_ADDR_SURF_BANK_HEIGHT_1
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|*
name|bankh
operator|=
name|EVERGREEN_ADDR_SURF_BANK_HEIGHT_2
expr_stmt|;
break|break;
case|case
literal|4
case|:
operator|*
name|bankh
operator|=
name|EVERGREEN_ADDR_SURF_BANK_HEIGHT_4
expr_stmt|;
break|break;
case|case
literal|8
case|:
operator|*
name|bankh
operator|=
name|EVERGREEN_ADDR_SURF_BANK_HEIGHT_8
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
operator|*
name|mtaspect
condition|)
block|{
default|default:
case|case
literal|1
case|:
operator|*
name|mtaspect
operator|=
name|EVERGREEN_ADDR_SURF_MACRO_TILE_ASPECT_1
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|*
name|mtaspect
operator|=
name|EVERGREEN_ADDR_SURF_MACRO_TILE_ASPECT_2
expr_stmt|;
break|break;
case|case
literal|4
case|:
operator|*
name|mtaspect
operator|=
name|EVERGREEN_ADDR_SURF_MACRO_TILE_ASPECT_4
expr_stmt|;
break|break;
case|case
literal|8
case|:
operator|*
name|mtaspect
operator|=
name|EVERGREEN_ADDR_SURF_MACRO_TILE_ASPECT_8
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|evergreen_fix_pci_max_read_req_size
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u16
name|ctl
decl_stmt|,
name|v
decl_stmt|;
name|int
name|err
decl_stmt|,
name|cap
decl_stmt|;
name|err
operator|=
name|pci_find_cap
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
name|PCIY_EXPRESS
argument_list|,
operator|&
name|cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return;
name|cap
operator|+=
name|PCIER_DEVICE_CTL
expr_stmt|;
name|ctl
operator|=
name|pci_read_config
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
name|cap
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|v
operator|=
operator|(
name|ctl
operator|&
name|PCIEM_CTL_MAX_READ_REQUEST
operator|)
operator|>>
literal|12
expr_stmt|;
comment|/* if bios or OS sets MAX_READ_REQUEST_SIZE to an invalid value, fix it 	 * to avoid hangs or perfomance issues 	 */
if|if
condition|(
operator|(
name|v
operator|==
literal|0
operator|)
operator|||
operator|(
name|v
operator|==
literal|6
operator|)
operator|||
operator|(
name|v
operator|==
literal|7
operator|)
condition|)
block|{
name|ctl
operator|&=
operator|~
name|PCIEM_CTL_MAX_READ_REQUEST
expr_stmt|;
name|ctl
operator||=
operator|(
literal|2
operator|<<
literal|12
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
name|cap
argument_list|,
name|ctl
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * dce4_wait_for_vblank - vblank wait asic callback.  *  * @rdev: radeon_device pointer  * @crtc: crtc to wait for vblank on  *  * Wait for vblank on the requested crtc (evergreen+).  */
end_comment

begin_function
name|void
name|dce4_wait_for_vblank
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|crtc
operator|>=
name|rdev
operator|->
name|num_crtc
condition|)
return|return;
if|if
condition|(
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|crtc
index|]
argument_list|)
operator|&
name|EVERGREEN_CRTC_MASTER_EN
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_STATUS
operator|+
name|crtc_offsets
index|[
name|crtc
index|]
argument_list|)
operator|&
name|EVERGREEN_CRTC_V_BLANK
operator|)
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_STATUS
operator|+
name|crtc_offsets
index|[
name|crtc
index|]
argument_list|)
operator|&
name|EVERGREEN_CRTC_V_BLANK
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * radeon_irq_kms_pflip_irq_get - pre-pageflip callback.  *  * @rdev: radeon_device pointer  * @crtc: crtc to prepare for pageflip on  *  * Pre-pageflip callback (evergreen+).  * Enables the pageflip irq (vblank irq).  */
end_comment

begin_function
name|void
name|evergreen_pre_page_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
comment|/* enable the pflip int */
name|radeon_irq_kms_pflip_irq_get
argument_list|(
name|rdev
argument_list|,
name|crtc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * evergreen_post_page_flip - pos-pageflip callback.  *  * @rdev: radeon_device pointer  * @crtc: crtc to cleanup pageflip on  *  * Post-pageflip callback (evergreen+).  * Disables the pageflip irq (vblank irq).  */
end_comment

begin_function
name|void
name|evergreen_post_page_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
comment|/* disable the pflip int */
name|radeon_irq_kms_pflip_irq_put
argument_list|(
name|rdev
argument_list|,
name|crtc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * evergreen_page_flip - pageflip callback.  *  * @rdev: radeon_device pointer  * @crtc_id: crtc to cleanup pageflip on  * @crtc_base: new address of the crtc (GPU MC address)  *  * Does the actual pageflip (evergreen+).  * During vblank we take the crtc lock and wait for the update_pending  * bit to go high, when it does, we release the lock, and allow the  * double buffered update to take place.  * Returns the current update pending status.  */
end_comment

begin_function
name|u32
name|evergreen_page_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc_id
parameter_list|,
name|u64
name|crtc_base
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|crtc_id
index|]
decl_stmt|;
name|u32
name|tmp
init|=
name|RREG32
argument_list|(
name|EVERGREEN_GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Lock the graphics update lock */
name|tmp
operator||=
name|EVERGREEN_GRPH_UPDATE_LOCK
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* update the scanout addresses */
name|WREG32
argument_list|(
name|EVERGREEN_GRPH_SECONDARY_SURFACE_ADDRESS_HIGH
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|upper_32_bits
argument_list|(
name|crtc_base
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_GRPH_SECONDARY_SURFACE_ADDRESS
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|u32
operator|)
name|crtc_base
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_GRPH_PRIMARY_SURFACE_ADDRESS_HIGH
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|upper_32_bits
argument_list|(
name|crtc_base
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_GRPH_PRIMARY_SURFACE_ADDRESS
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|u32
operator|)
name|crtc_base
argument_list|)
expr_stmt|;
comment|/* Wait for update_pending to go high. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|EVERGREEN_GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
operator|&
name|EVERGREEN_GRPH_SURFACE_UPDATE_PENDING
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"Update pending now high. Unlocking vupdate_lock.\n"
argument_list|)
expr_stmt|;
comment|/* Unlock the lock, so double-buffering can take place inside vblank */
name|tmp
operator|&=
operator|~
name|EVERGREEN_GRPH_UPDATE_LOCK
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Return current update_pending status: */
return|return
name|RREG32
argument_list|(
name|EVERGREEN_GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
operator|&
name|EVERGREEN_GRPH_SURFACE_UPDATE_PENDING
return|;
block|}
end_function

begin_comment
comment|/* get temperature in millidegrees */
end_comment

begin_function
name|int
name|evergreen_get_temp
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|temp
decl_stmt|,
name|toffset
decl_stmt|;
name|int
name|actual_temp
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_JUNIPER
condition|)
block|{
name|toffset
operator|=
operator|(
name|RREG32
argument_list|(
name|CG_THERMAL_CTRL
argument_list|)
operator|&
name|TOFFSET_MASK
operator|)
operator|>>
name|TOFFSET_SHIFT
expr_stmt|;
name|temp
operator|=
operator|(
name|RREG32
argument_list|(
name|CG_TS0_STATUS
argument_list|)
operator|&
name|TS0_ADC_DOUT_MASK
operator|)
operator|>>
name|TS0_ADC_DOUT_SHIFT
expr_stmt|;
if|if
condition|(
name|toffset
operator|&
literal|0x100
condition|)
name|actual_temp
operator|=
name|temp
operator|/
literal|2
operator|-
operator|(
literal|0x200
operator|-
name|toffset
operator|)
expr_stmt|;
else|else
name|actual_temp
operator|=
name|temp
operator|/
literal|2
operator|+
name|toffset
expr_stmt|;
name|actual_temp
operator|=
name|actual_temp
operator|*
literal|1000
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|=
operator|(
name|RREG32
argument_list|(
name|CG_MULT_THERMAL_STATUS
argument_list|)
operator|&
name|ASIC_T_MASK
operator|)
operator|>>
name|ASIC_T_SHIFT
expr_stmt|;
if|if
condition|(
name|temp
operator|&
literal|0x400
condition|)
name|actual_temp
operator|=
operator|-
literal|256
expr_stmt|;
elseif|else
if|if
condition|(
name|temp
operator|&
literal|0x200
condition|)
name|actual_temp
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|temp
operator|&
literal|0x100
condition|)
block|{
name|actual_temp
operator|=
name|temp
operator|&
literal|0x1ff
expr_stmt|;
name|actual_temp
operator||=
operator|~
literal|0x1ff
expr_stmt|;
block|}
else|else
name|actual_temp
operator|=
name|temp
operator|&
literal|0xff
expr_stmt|;
name|actual_temp
operator|=
operator|(
name|actual_temp
operator|*
literal|1000
operator|)
operator|/
literal|2
expr_stmt|;
block|}
return|return
name|actual_temp
return|;
block|}
end_function

begin_function
name|int
name|sumo_get_temp
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|temp
init|=
name|RREG32
argument_list|(
name|CG_THERMAL_STATUS
argument_list|)
operator|&
literal|0xff
decl_stmt|;
name|int
name|actual_temp
init|=
name|temp
operator|-
literal|49
decl_stmt|;
return|return
name|actual_temp
operator|*
literal|1000
return|;
block|}
end_function

begin_comment
comment|/**  * sumo_pm_init_profile - Initialize power profiles callback.  *  * @rdev: radeon_device pointer  *  * Initialize the power states used in profile mode  * (sumo, trinity, SI).  * Used for profile mode only.  */
end_comment

begin_function
name|void
name|sumo_pm_init_profile
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
comment|/* default */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low,mid sh/mh */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_MOBILITY
condition|)
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_BATTERY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_PERFORMANCE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high sh/mh */
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_PERFORMANCE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|idx
index|]
operator|.
name|num_clock_modes
operator|-
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|idx
index|]
operator|.
name|num_clock_modes
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * btc_pm_init_profile - Initialize power profiles callback.  *  * @rdev: radeon_device pointer  *  * Initialize the power states used in profile mode  * (BTC, cayman).  * Used for profile mode only.  */
end_comment

begin_function
name|void
name|btc_pm_init_profile
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
comment|/* default */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|2
expr_stmt|;
comment|/* starting with BTC, there is one state that is used for both 	 * MH and SH.  Difference is that we always use the high clock index for 	 * mclk. 	 */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_MOBILITY
condition|)
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_BATTERY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_PERFORMANCE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* low sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|1
expr_stmt|;
comment|/* high sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|2
expr_stmt|;
comment|/* low mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|1
expr_stmt|;
comment|/* high mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|2
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * evergreen_pm_misc - set additional pm hw parameters callback.  *  * @rdev: radeon_device pointer  *  * Set non-clock parameters associated with a power state  * (voltage, etc.) (evergreen+).  */
end_comment

begin_function
name|void
name|evergreen_pm_misc
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|req_ps_idx
init|=
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
decl_stmt|;
name|int
name|req_cm_idx
init|=
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
decl_stmt|;
name|struct
name|radeon_power_state
modifier|*
name|ps
init|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|req_ps_idx
index|]
decl_stmt|;
name|struct
name|radeon_voltage
modifier|*
name|voltage
init|=
operator|&
name|ps
operator|->
name|clock_info
index|[
name|req_cm_idx
index|]
operator|.
name|voltage
decl_stmt|;
if|if
condition|(
name|voltage
operator|->
name|type
operator|==
name|VOLTAGE_SW
condition|)
block|{
comment|/* 0xff01 is a flag rather then an actual voltage */
if|if
condition|(
name|voltage
operator|->
name|voltage
operator|==
literal|0xff01
condition|)
return|return;
if|if
condition|(
name|voltage
operator|->
name|voltage
operator|&&
operator|(
name|voltage
operator|->
name|voltage
operator|!=
name|rdev
operator|->
name|pm
operator|.
name|current_vddc
operator|)
condition|)
block|{
name|radeon_atom_set_voltage
argument_list|(
name|rdev
argument_list|,
name|voltage
operator|->
name|voltage
argument_list|,
name|SET_VOLTAGE_TYPE_ASIC_VDDC
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|current_vddc
operator|=
name|voltage
operator|->
name|voltage
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"Setting: vddc: %d\n"
argument_list|,
name|voltage
operator|->
name|voltage
argument_list|)
expr_stmt|;
block|}
comment|/* 0xff01 is a flag rather then an actual voltage */
if|if
condition|(
name|voltage
operator|->
name|vddci
operator|==
literal|0xff01
condition|)
return|return;
if|if
condition|(
name|voltage
operator|->
name|vddci
operator|&&
operator|(
name|voltage
operator|->
name|vddci
operator|!=
name|rdev
operator|->
name|pm
operator|.
name|current_vddci
operator|)
condition|)
block|{
name|radeon_atom_set_voltage
argument_list|(
name|rdev
argument_list|,
name|voltage
operator|->
name|vddci
argument_list|,
name|SET_VOLTAGE_TYPE_ASIC_VDDCI
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|current_vddci
operator|=
name|voltage
operator|->
name|vddci
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"Setting: vddci: %d\n"
argument_list|,
name|voltage
operator|->
name|vddci
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * evergreen_pm_prepare - pre-power state change callback.  *  * @rdev: radeon_device pointer  *  * Prepare for a power state change (evergreen+).  */
end_comment

begin_function
name|void
name|evergreen_pm_prepare
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|ddev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* disable any active CRTCs */
name|list_for_each_entry
argument_list|(
argument|crtc
argument_list|,
argument|&ddev->mode_config.crtc_list
argument_list|,
argument|head
argument_list|)
block|{
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|enabled
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|EVERGREEN_CRTC_DISP_READ_REQUEST_DISABLE
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * evergreen_pm_finish - post-power state change callback.  *  * @rdev: radeon_device pointer  *  * Clean up after a power state change (evergreen+).  */
end_comment

begin_function
name|void
name|evergreen_pm_finish
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|ddev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* enable any active CRTCs */
name|list_for_each_entry
argument_list|(
argument|crtc
argument_list|,
argument|&ddev->mode_config.crtc_list
argument_list|,
argument|head
argument_list|)
block|{
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|enabled
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|EVERGREEN_CRTC_DISP_READ_REQUEST_DISABLE
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * evergreen_hpd_sense - hpd sense callback.  *  * @rdev: radeon_device pointer  * @hpd: hpd (hotplug detect) pin  *  * Checks if a digital monitor is connected (evergreen+).  * Returns true if connected, false if not connected.  */
end_comment

begin_function
name|bool
name|evergreen_hpd_sense
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|enum
name|radeon_hpd_id
name|hpd
parameter_list|)
block|{
name|bool
name|connected
init|=
name|false
decl_stmt|;
switch|switch
condition|(
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD1_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD2_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD3_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_4
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD4_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_5
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD5_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_6
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD6_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|connected
return|;
block|}
end_function

begin_comment
comment|/**  * evergreen_hpd_set_polarity - hpd set polarity callback.  *  * @rdev: radeon_device pointer  * @hpd: hpd (hotplug detect) pin  *  * Set the polarity of the hpd pin (evergreen+).  */
end_comment

begin_function
name|void
name|evergreen_hpd_set_polarity
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|enum
name|radeon_hpd_id
name|hpd
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|bool
name|connected
init|=
name|evergreen_hpd_sense
argument_list|(
name|rdev
argument_list|,
name|hpd
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_4
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_5
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_6
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_comment
comment|/**  * evergreen_hpd_init - hpd setup callback.  *  * @rdev: radeon_device pointer  *  * Setup the hpd pins used by the card (evergreen+).  * Enable the pin, set the polarity, and enable the hpd interrupts.  */
end_comment

begin_function
name|void
name|evergreen_hpd_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|unsigned
name|enabled
init|=
literal|0
decl_stmt|;
name|u32
name|tmp
init|=
name|DC_HPDx_CONNECTION_TIMER
argument_list|(
literal|0x9c4
argument_list|)
operator||
name|DC_HPDx_RX_INT_TIMER
argument_list|(
literal|0xfa
argument_list|)
operator||
name|DC_HPDx_EN
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|connector
argument_list|,
argument|&dev->mode_config.connector_list
argument_list|,
argument|head
argument_list|)
block|{
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
init|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|WREG32
argument_list|(
name|DC_HPD1_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|WREG32
argument_list|(
name|DC_HPD2_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
name|WREG32
argument_list|(
name|DC_HPD3_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_4
case|:
name|WREG32
argument_list|(
name|DC_HPD4_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_5
case|:
name|WREG32
argument_list|(
name|DC_HPD5_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_6
case|:
name|WREG32
argument_list|(
name|DC_HPD6_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|radeon_hpd_set_polarity
argument_list|(
name|rdev
argument_list|,
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
argument_list|)
expr_stmt|;
name|enabled
operator||=
literal|1
operator|<<
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
expr_stmt|;
block|}
name|radeon_irq_kms_enable_hpd
argument_list|(
name|rdev
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * evergreen_hpd_fini - hpd tear down callback.  *  * @rdev: radeon_device pointer  *  * Tear down the hpd pins used by the card (evergreen+).  * Disable the hpd interrupts.  */
end_comment

begin_function
name|void
name|evergreen_hpd_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|unsigned
name|disabled
init|=
literal|0
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|connector
argument_list|,
argument|&dev->mode_config.connector_list
argument_list|,
argument|head
argument_list|)
block|{
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
init|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|WREG32
argument_list|(
name|DC_HPD1_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|WREG32
argument_list|(
name|DC_HPD2_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
name|WREG32
argument_list|(
name|DC_HPD3_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_4
case|:
name|WREG32
argument_list|(
name|DC_HPD4_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_5
case|:
name|WREG32
argument_list|(
name|DC_HPD5_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_6
case|:
name|WREG32
argument_list|(
name|DC_HPD6_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|disabled
operator||=
literal|1
operator|<<
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
expr_stmt|;
block|}
name|radeon_irq_kms_disable_hpd
argument_list|(
name|rdev
argument_list|,
name|disabled
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* watermark setup */
end_comment

begin_function
specifier|static
name|u32
name|evergreen_line_buffer_adjust
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|other_mode
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
comment|/* 	 * Line Buffer Setup 	 * There are 3 line buffers, each one shared by 2 display controllers. 	 * DC_LB_MEMORY_SPLIT controls how that line buffer is shared between 	 * the display controllers.  The paritioning is done via one of four 	 * preset allocations specified in bits 2:0: 	 * first display controller 	 *  0 - first half of lb (3840 * 2) 	 *  1 - first 3/4 of lb (5760 * 2) 	 *  2 - whole lb (7680 * 2), other crtc must be disabled 	 *  3 - first 1/4 of lb (1920 * 2) 	 * second display controller 	 *  4 - second half of lb (3840 * 2) 	 *  5 - second 3/4 of lb (5760 * 2) 	 *  6 - whole lb (7680 * 2), other crtc must be disabled 	 *  7 - last 1/4 of lb (1920 * 2) 	 */
comment|/* this can get tricky if we have two large displays on a paired group 	 * of crtcs.  Ideally for multiple large displays we'd assign them to 	 * non-linked crtcs for maximum line buffer allocation. 	 */
if|if
condition|(
name|radeon_crtc
operator|->
name|base
operator|.
name|enabled
operator|&&
name|mode
condition|)
block|{
if|if
condition|(
name|other_mode
condition|)
name|tmp
operator|=
literal|0
expr_stmt|;
comment|/* 1/2 */
else|else
name|tmp
operator|=
literal|2
expr_stmt|;
comment|/* whole */
block|}
else|else
name|tmp
operator|=
literal|0
expr_stmt|;
comment|/* second controller of the pair uses second half of the lb */
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|%
literal|2
condition|)
name|tmp
operator|+=
literal|4
expr_stmt|;
name|WREG32
argument_list|(
name|DC_LB_MEMORY_SPLIT
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|base
operator|.
name|enabled
operator|&&
name|mode
condition|)
block|{
switch|switch
condition|(
name|tmp
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|4
case|:
default|default:
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
literal|4096
operator|*
literal|2
return|;
else|else
return|return
literal|3840
operator|*
literal|2
return|;
case|case
literal|1
case|:
case|case
literal|5
case|:
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
literal|6144
operator|*
literal|2
return|;
else|else
return|return
literal|5760
operator|*
literal|2
return|;
case|case
literal|2
case|:
case|case
literal|6
case|:
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
literal|8192
operator|*
literal|2
return|;
else|else
return|return
literal|7680
operator|*
literal|2
return|;
case|case
literal|3
case|:
case|case
literal|7
case|:
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
literal|2048
operator|*
literal|2
return|;
else|else
return|return
literal|1920
operator|*
literal|2
return|;
block|}
block|}
comment|/* controller not enabled, so no lb used */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|u32
name|evergreen_get_number_of_dram_channels
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
init|=
name|RREG32
argument_list|(
name|MC_SHARED_CHMAP
argument_list|)
decl_stmt|;
switch|switch
condition|(
operator|(
name|tmp
operator|&
name|NOOFCHAN_MASK
operator|)
operator|>>
name|NOOFCHAN_SHIFT
condition|)
block|{
case|case
literal|0
case|:
default|default:
return|return
literal|1
return|;
case|case
literal|1
case|:
return|return
literal|2
return|;
case|case
literal|2
case|:
return|return
literal|4
return|;
case|case
literal|3
case|:
return|return
literal|8
return|;
block|}
block|}
end_function

begin_struct
struct|struct
name|evergreen_wm_params
block|{
name|u32
name|dram_channels
decl_stmt|;
comment|/* number of dram channels */
name|u32
name|yclk
decl_stmt|;
comment|/* bandwidth per dram data pin in kHz */
name|u32
name|sclk
decl_stmt|;
comment|/* engine clock in kHz */
name|u32
name|disp_clk
decl_stmt|;
comment|/* display clock in kHz */
name|u32
name|src_width
decl_stmt|;
comment|/* viewport width */
name|u32
name|active_time
decl_stmt|;
comment|/* active display time in ns */
name|u32
name|blank_time
decl_stmt|;
comment|/* blank time in ns */
name|bool
name|interlaced
decl_stmt|;
comment|/* mode is interlaced */
name|fixed20_12
name|vsc
decl_stmt|;
comment|/* vertical scale ratio */
name|u32
name|num_heads
decl_stmt|;
comment|/* number of active crtcs */
name|u32
name|bytes_per_pixel
decl_stmt|;
comment|/* bytes per pixel display + overlay */
name|u32
name|lb_size
decl_stmt|;
comment|/* line buffer allocated to pipe */
name|u32
name|vtaps
decl_stmt|;
comment|/* vertical scaler taps */
block|}
struct|;
end_struct

begin_function
specifier|static
name|u32
name|evergreen_dram_bandwidth
parameter_list|(
name|struct
name|evergreen_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate DRAM Bandwidth and the part allocated to display. */
name|fixed20_12
name|dram_efficiency
decl_stmt|;
comment|/* 0.7 */
name|fixed20_12
name|yclk
decl_stmt|,
name|dram_channels
decl_stmt|,
name|bandwidth
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|yclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|yclk
argument_list|)
expr_stmt|;
name|yclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|yclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|dram_channels
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|dram_channels
operator|*
literal|4
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|dram_efficiency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|dram_efficiency
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|dram_efficiency
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|dram_channels
argument_list|,
name|yclk
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|bandwidth
argument_list|,
name|dram_efficiency
argument_list|)
expr_stmt|;
return|return
name|dfixed_trunc
argument_list|(
name|bandwidth
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|evergreen_dram_bandwidth_for_display
parameter_list|(
name|struct
name|evergreen_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate DRAM Bandwidth and the part allocated to display. */
name|fixed20_12
name|disp_dram_allocation
decl_stmt|;
comment|/* 0.3 to 0.7 */
name|fixed20_12
name|yclk
decl_stmt|,
name|dram_channels
decl_stmt|,
name|bandwidth
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|yclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|yclk
argument_list|)
expr_stmt|;
name|yclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|yclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|dram_channels
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|dram_channels
operator|*
literal|4
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|disp_dram_allocation
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|3
argument_list|)
expr_stmt|;
comment|/* XXX worse case value 0.3 */
name|disp_dram_allocation
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|disp_dram_allocation
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|dram_channels
argument_list|,
name|yclk
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|bandwidth
argument_list|,
name|disp_dram_allocation
argument_list|)
expr_stmt|;
return|return
name|dfixed_trunc
argument_list|(
name|bandwidth
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|evergreen_data_return_bandwidth
parameter_list|(
name|struct
name|evergreen_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate the display Data return Bandwidth */
name|fixed20_12
name|return_efficiency
decl_stmt|;
comment|/* 0.8 */
name|fixed20_12
name|sclk
decl_stmt|,
name|bandwidth
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|sclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|sclk
argument_list|)
expr_stmt|;
name|sclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|sclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|return_efficiency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|return_efficiency
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|return_efficiency
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|32
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|sclk
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|bandwidth
argument_list|,
name|return_efficiency
argument_list|)
expr_stmt|;
return|return
name|dfixed_trunc
argument_list|(
name|bandwidth
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|evergreen_dmif_request_bandwidth
parameter_list|(
name|struct
name|evergreen_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate the DMIF Request Bandwidth */
name|fixed20_12
name|disp_clk_request_efficiency
decl_stmt|;
comment|/* 0.8 */
name|fixed20_12
name|disp_clk
decl_stmt|,
name|bandwidth
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|disp_clk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|disp_clk
argument_list|)
expr_stmt|;
name|disp_clk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|disp_clk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|disp_clk_request_efficiency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|disp_clk_request_efficiency
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|disp_clk_request_efficiency
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|32
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|disp_clk
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|bandwidth
argument_list|,
name|disp_clk_request_efficiency
argument_list|)
expr_stmt|;
return|return
name|dfixed_trunc
argument_list|(
name|bandwidth
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|evergreen_available_bandwidth
parameter_list|(
name|struct
name|evergreen_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate the Available bandwidth. Display can use this temporarily but not in average. */
name|u32
name|dram_bandwidth
init|=
name|evergreen_dram_bandwidth
argument_list|(
name|wm
argument_list|)
decl_stmt|;
name|u32
name|data_return_bandwidth
init|=
name|evergreen_data_return_bandwidth
argument_list|(
name|wm
argument_list|)
decl_stmt|;
name|u32
name|dmif_req_bandwidth
init|=
name|evergreen_dmif_request_bandwidth
argument_list|(
name|wm
argument_list|)
decl_stmt|;
return|return
name|min
argument_list|(
name|dram_bandwidth
argument_list|,
name|min
argument_list|(
name|data_return_bandwidth
argument_list|,
name|dmif_req_bandwidth
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|evergreen_average_bandwidth
parameter_list|(
name|struct
name|evergreen_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate the display mode Average Bandwidth 	 * DisplayMode should contain the source and destination dimensions, 	 * timing, etc. 	 */
name|fixed20_12
name|bpp
decl_stmt|;
name|fixed20_12
name|line_time
decl_stmt|;
name|fixed20_12
name|src_width
decl_stmt|;
name|fixed20_12
name|bandwidth
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|line_time
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|active_time
operator|+
name|wm
operator|->
name|blank_time
argument_list|)
expr_stmt|;
name|line_time
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|line_time
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|bpp
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|bytes_per_pixel
argument_list|)
expr_stmt|;
name|src_width
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|src_width
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|src_width
argument_list|,
name|bpp
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|bandwidth
argument_list|,
name|wm
operator|->
name|vsc
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|bandwidth
argument_list|,
name|line_time
argument_list|)
expr_stmt|;
return|return
name|dfixed_trunc
argument_list|(
name|bandwidth
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|evergreen_latency_watermark
parameter_list|(
name|struct
name|evergreen_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* First calcualte the latency in ns */
name|u32
name|mc_latency
init|=
literal|2000
decl_stmt|;
comment|/* 2000 ns. */
name|u32
name|available_bandwidth
init|=
name|evergreen_available_bandwidth
argument_list|(
name|wm
argument_list|)
decl_stmt|;
name|u32
name|worst_chunk_return_time
init|=
operator|(
literal|512
operator|*
literal|8
operator|*
literal|1000
operator|)
operator|/
name|available_bandwidth
decl_stmt|;
name|u32
name|cursor_line_pair_return_time
init|=
operator|(
literal|128
operator|*
literal|4
operator|*
literal|1000
operator|)
operator|/
name|available_bandwidth
decl_stmt|;
name|u32
name|dc_latency
init|=
literal|40000000
operator|/
name|wm
operator|->
name|disp_clk
decl_stmt|;
comment|/* dc pipe latency */
name|u32
name|other_heads_data_return_time
init|=
operator|(
operator|(
name|wm
operator|->
name|num_heads
operator|+
literal|1
operator|)
operator|*
name|worst_chunk_return_time
operator|)
operator|+
operator|(
name|wm
operator|->
name|num_heads
operator|*
name|cursor_line_pair_return_time
operator|)
decl_stmt|;
name|u32
name|latency
init|=
name|mc_latency
operator|+
name|other_heads_data_return_time
operator|+
name|dc_latency
decl_stmt|;
name|u32
name|max_src_lines_per_dst_line
decl_stmt|,
name|lb_fill_bw
decl_stmt|,
name|line_fill_time
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
if|if
condition|(
name|wm
operator|->
name|num_heads
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wm
operator|->
name|vsc
operator|.
name|full
operator|>
name|a
operator|.
name|full
operator|)
operator|||
operator|(
operator|(
name|wm
operator|->
name|vsc
operator|.
name|full
operator|>
name|b
operator|.
name|full
operator|)
operator|&&
operator|(
name|wm
operator|->
name|vtaps
operator|>=
literal|3
operator|)
operator|)
operator|||
operator|(
name|wm
operator|->
name|vtaps
operator|>=
literal|5
operator|)
operator|||
operator|(
operator|(
name|wm
operator|->
name|vsc
operator|.
name|full
operator|>=
name|a
operator|.
name|full
operator|)
operator|&&
name|wm
operator|->
name|interlaced
operator|)
condition|)
name|max_src_lines_per_dst_line
operator|=
literal|4
expr_stmt|;
else|else
name|max_src_lines_per_dst_line
operator|=
literal|2
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|available_bandwidth
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|num_heads
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|disp_clk
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|bytes_per_pixel
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|lb_fill_bw
operator|=
name|min
argument_list|(
name|dfixed_trunc
argument_list|(
name|a
argument_list|)
argument_list|,
name|dfixed_trunc
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|max_src_lines_per_dst_line
operator|*
name|wm
operator|->
name|src_width
operator|*
name|wm
operator|->
name|bytes_per_pixel
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|lb_fill_bw
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|line_fill_time
operator|=
name|dfixed_trunc
argument_list|(
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|line_fill_time
operator|<
name|wm
operator|->
name|active_time
condition|)
return|return
name|latency
return|;
else|else
return|return
name|latency
operator|+
operator|(
name|line_fill_time
operator|-
name|wm
operator|->
name|active_time
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|evergreen_average_bandwidth_vs_dram_bandwidth_for_display
parameter_list|(
name|struct
name|evergreen_wm_params
modifier|*
name|wm
parameter_list|)
block|{
if|if
condition|(
name|evergreen_average_bandwidth
argument_list|(
name|wm
argument_list|)
operator|<=
operator|(
name|evergreen_dram_bandwidth_for_display
argument_list|(
name|wm
argument_list|)
operator|/
name|wm
operator|->
name|num_heads
operator|)
condition|)
return|return
name|true
return|;
else|else
return|return
name|false
return|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|bool
name|evergreen_average_bandwidth_vs_available_bandwidth
parameter_list|(
name|struct
name|evergreen_wm_params
modifier|*
name|wm
parameter_list|)
block|{
if|if
condition|(
name|evergreen_average_bandwidth
argument_list|(
name|wm
argument_list|)
operator|<=
operator|(
name|evergreen_available_bandwidth
argument_list|(
name|wm
argument_list|)
operator|/
name|wm
operator|->
name|num_heads
operator|)
condition|)
return|return
name|true
return|;
else|else
return|return
name|false
return|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|bool
name|evergreen_check_latency_hiding
parameter_list|(
name|struct
name|evergreen_wm_params
modifier|*
name|wm
parameter_list|)
block|{
name|u32
name|lb_partitions
init|=
name|wm
operator|->
name|lb_size
operator|/
name|wm
operator|->
name|src_width
decl_stmt|;
name|u32
name|line_time
init|=
name|wm
operator|->
name|active_time
operator|+
name|wm
operator|->
name|blank_time
decl_stmt|;
name|u32
name|latency_tolerant_lines
decl_stmt|;
name|u32
name|latency_hiding
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wm
operator|->
name|vsc
operator|.
name|full
operator|>
name|a
operator|.
name|full
condition|)
name|latency_tolerant_lines
operator|=
literal|1
expr_stmt|;
else|else
block|{
if|if
condition|(
name|lb_partitions
operator|<=
operator|(
name|wm
operator|->
name|vtaps
operator|+
literal|1
operator|)
condition|)
name|latency_tolerant_lines
operator|=
literal|1
expr_stmt|;
else|else
name|latency_tolerant_lines
operator|=
literal|2
expr_stmt|;
block|}
name|latency_hiding
operator|=
operator|(
name|latency_tolerant_lines
operator|*
name|line_time
operator|+
name|wm
operator|->
name|blank_time
operator|)
expr_stmt|;
if|if
condition|(
name|evergreen_latency_watermark
argument_list|(
name|wm
argument_list|)
operator|<=
name|latency_hiding
condition|)
return|return
name|true
return|;
else|else
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|evergreen_program_watermarks
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
parameter_list|,
name|u32
name|lb_size
parameter_list|,
name|u32
name|num_heads
parameter_list|)
block|{
name|struct
name|drm_display_mode
modifier|*
name|mode
init|=
operator|&
name|radeon_crtc
operator|->
name|base
operator|.
name|mode
decl_stmt|;
name|struct
name|evergreen_wm_params
name|wm
decl_stmt|;
name|u32
name|pixel_period
decl_stmt|;
name|u32
name|line_time
init|=
literal|0
decl_stmt|;
name|u32
name|latency_watermark_a
init|=
literal|0
decl_stmt|,
name|latency_watermark_b
init|=
literal|0
decl_stmt|;
name|u32
name|priority_a_mark
init|=
literal|0
decl_stmt|,
name|priority_b_mark
init|=
literal|0
decl_stmt|;
name|u32
name|priority_a_cnt
init|=
name|PRIORITY_OFF
decl_stmt|;
name|u32
name|priority_b_cnt
init|=
name|PRIORITY_OFF
decl_stmt|;
name|u32
name|pipe_offset
init|=
name|radeon_crtc
operator|->
name|crtc_id
operator|*
literal|16
decl_stmt|;
name|u32
name|tmp
decl_stmt|,
name|arb_control3
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|base
operator|.
name|enabled
operator|&&
name|num_heads
operator|&&
name|mode
condition|)
block|{
name|pixel_period
operator|=
literal|1000000
operator|/
operator|(
name|u32
operator|)
name|mode
operator|->
name|clock
expr_stmt|;
name|line_time
operator|=
name|min
argument_list|(
operator|(
name|u32
operator|)
name|mode
operator|->
name|crtc_htotal
operator|*
name|pixel_period
argument_list|,
operator|(
name|u32
operator|)
literal|65535
argument_list|)
expr_stmt|;
name|priority_a_cnt
operator|=
literal|0
expr_stmt|;
name|priority_b_cnt
operator|=
literal|0
expr_stmt|;
name|wm
operator|.
name|yclk
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_mclk
operator|*
literal|10
expr_stmt|;
name|wm
operator|.
name|sclk
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_sclk
operator|*
literal|10
expr_stmt|;
name|wm
operator|.
name|disp_clk
operator|=
name|mode
operator|->
name|clock
expr_stmt|;
name|wm
operator|.
name|src_width
operator|=
name|mode
operator|->
name|crtc_hdisplay
expr_stmt|;
name|wm
operator|.
name|active_time
operator|=
name|mode
operator|->
name|crtc_hdisplay
operator|*
name|pixel_period
expr_stmt|;
name|wm
operator|.
name|blank_time
operator|=
name|line_time
operator|-
name|wm
operator|.
name|active_time
expr_stmt|;
name|wm
operator|.
name|interlaced
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_INTERLACE
condition|)
name|wm
operator|.
name|interlaced
operator|=
name|true
expr_stmt|;
name|wm
operator|.
name|vsc
operator|=
name|radeon_crtc
operator|->
name|vsc
expr_stmt|;
name|wm
operator|.
name|vtaps
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|rmx_type
operator|!=
name|RMX_OFF
condition|)
name|wm
operator|.
name|vtaps
operator|=
literal|2
expr_stmt|;
name|wm
operator|.
name|bytes_per_pixel
operator|=
literal|4
expr_stmt|;
comment|/* XXX: get this from fb config */
name|wm
operator|.
name|lb_size
operator|=
name|lb_size
expr_stmt|;
name|wm
operator|.
name|dram_channels
operator|=
name|evergreen_get_number_of_dram_channels
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|wm
operator|.
name|num_heads
operator|=
name|num_heads
expr_stmt|;
comment|/* set for high clocks */
name|latency_watermark_a
operator|=
name|min
argument_list|(
name|evergreen_latency_watermark
argument_list|(
operator|&
name|wm
argument_list|)
argument_list|,
operator|(
name|u32
operator|)
literal|65535
argument_list|)
expr_stmt|;
comment|/* set for low clocks */
comment|/* wm.yclk = low clk; wm.sclk = low clk */
name|latency_watermark_b
operator|=
name|min
argument_list|(
name|evergreen_latency_watermark
argument_list|(
operator|&
name|wm
argument_list|)
argument_list|,
operator|(
name|u32
operator|)
literal|65535
argument_list|)
expr_stmt|;
comment|/* possibly force display priority to high */
comment|/* should really do this at mode validation time... */
if|if
condition|(
operator|!
name|evergreen_average_bandwidth_vs_dram_bandwidth_for_display
argument_list|(
operator|&
name|wm
argument_list|)
operator|||
operator|!
name|evergreen_average_bandwidth_vs_available_bandwidth
argument_list|(
operator|&
name|wm
argument_list|)
operator|||
operator|!
name|evergreen_check_latency_hiding
argument_list|(
operator|&
name|wm
argument_list|)
operator|||
operator|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
operator|)
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"force priority to high\n"
argument_list|)
expr_stmt|;
name|priority_a_cnt
operator||=
name|PRIORITY_ALWAYS_ON
expr_stmt|;
name|priority_b_cnt
operator||=
name|PRIORITY_ALWAYS_ON
expr_stmt|;
block|}
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mode
operator|->
name|clock
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|latency_watermark_a
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|c
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|c
argument_list|,
name|radeon_crtc
operator|->
name|hsc
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|priority_a_mark
operator|=
name|dfixed_trunc
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|priority_a_cnt
operator||=
name|priority_a_mark
operator|&
name|PRIORITY_MARK_MASK
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mode
operator|->
name|clock
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|latency_watermark_b
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|c
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|c
argument_list|,
name|radeon_crtc
operator|->
name|hsc
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|priority_b_mark
operator|=
name|dfixed_trunc
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|priority_b_cnt
operator||=
name|priority_b_mark
operator|&
name|PRIORITY_MARK_MASK
expr_stmt|;
block|}
comment|/* select wm A */
name|arb_control3
operator|=
name|RREG32
argument_list|(
name|PIPE0_ARBITRATION_CONTROL3
operator|+
name|pipe_offset
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|arb_control3
expr_stmt|;
name|tmp
operator|&=
operator|~
name|LATENCY_WATERMARK_MASK
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|LATENCY_WATERMARK_MASK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PIPE0_ARBITRATION_CONTROL3
operator|+
name|pipe_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PIPE0_LATENCY_CONTROL
operator|+
name|pipe_offset
argument_list|,
operator|(
name|LATENCY_LOW_WATERMARK
argument_list|(
name|latency_watermark_a
argument_list|)
operator||
name|LATENCY_HIGH_WATERMARK
argument_list|(
name|line_time
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* select wm B */
name|tmp
operator|=
name|RREG32
argument_list|(
name|PIPE0_ARBITRATION_CONTROL3
operator|+
name|pipe_offset
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|LATENCY_WATERMARK_MASK
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|LATENCY_WATERMARK_MASK
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PIPE0_ARBITRATION_CONTROL3
operator|+
name|pipe_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PIPE0_LATENCY_CONTROL
operator|+
name|pipe_offset
argument_list|,
operator|(
name|LATENCY_LOW_WATERMARK
argument_list|(
name|latency_watermark_b
argument_list|)
operator||
name|LATENCY_HIGH_WATERMARK
argument_list|(
name|line_time
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* restore original selection */
name|WREG32
argument_list|(
name|PIPE0_ARBITRATION_CONTROL3
operator|+
name|pipe_offset
argument_list|,
name|arb_control3
argument_list|)
expr_stmt|;
comment|/* write the priority marks */
name|WREG32
argument_list|(
name|PRIORITY_A_CNT
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PRIORITY_B_CNT
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|priority_b_cnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * evergreen_bandwidth_update - update display watermarks callback.  *  * @rdev: radeon_device pointer  *  * Update the display watermarks based on the requested mode(s)  * (evergreen+).  */
end_comment

begin_function
name|void
name|evergreen_bandwidth_update
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_display_mode
modifier|*
name|mode0
init|=
name|NULL
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|mode1
init|=
name|NULL
decl_stmt|;
name|u32
name|num_heads
init|=
literal|0
decl_stmt|,
name|lb_size
decl_stmt|;
name|int
name|i
decl_stmt|;
name|radeon_update_display_priority
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
name|num_heads
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|mode0
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
name|mode1
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
operator|+
literal|1
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
name|lb_size
operator|=
name|evergreen_line_buffer_adjust
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
index|]
argument_list|,
name|mode0
argument_list|,
name|mode1
argument_list|)
expr_stmt|;
name|evergreen_program_watermarks
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
index|]
argument_list|,
name|lb_size
argument_list|,
name|num_heads
argument_list|)
expr_stmt|;
name|lb_size
operator|=
name|evergreen_line_buffer_adjust
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|mode1
argument_list|,
name|mode0
argument_list|)
expr_stmt|;
name|evergreen_program_watermarks
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|lb_size
argument_list|,
name|num_heads
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * evergreen_mc_wait_for_idle - wait for MC idle callback.  *  * @rdev: radeon_device pointer  *  * Wait for the MC (memory controller) to be idle.  * (evergreen+).  * Returns 0 if the MC is idle, -1 if not.  */
end_comment

begin_function
name|int
name|evergreen_mc_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
comment|/* read MC_STATUS */
name|tmp
operator|=
name|RREG32
argument_list|(
name|SRBM_STATUS
argument_list|)
operator|&
literal|0x1F00
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
return|return
literal|0
return|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * GART  */
end_comment

begin_function
name|void
name|evergreen_pcie_gart_tlb_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|WREG32
argument_list|(
name|HDP_MEM_COHERENCY_FLUSH_CNTL
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_REQUEST_RESPONSE
argument_list|,
name|REQUEST_TYPE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
comment|/* read MC_STATUS */
name|tmp
operator|=
name|RREG32
argument_list|(
name|VM_CONTEXT0_REQUEST_RESPONSE
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|&
name|RESPONSE_TYPE_MASK
operator|)
operator|>>
name|RESPONSE_TYPE_SHIFT
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"[drm] r600 flush TLB failed\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tmp
condition|)
block|{
return|return;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_pcie_gart_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"No VRAM object for PCIE GART.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_gart_table_vram_pin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|radeon_gart_restore
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_CACHE
operator||
name|ENABLE_L2_FRAGMENT_PROCESSING
operator||
name|ENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|BANK_SELECT
argument_list|(
literal|0
argument_list|)
operator||
name|CACHE_UPDATE_MODE
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|tmp
operator|=
name|ENABLE_L1_TLB
operator||
name|ENABLE_L1_FRAGMENT_PROCESSING
operator||
name|SYSTEM_ACCESS_MODE_NOT_IN_SYS
operator||
name|SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU
operator||
name|EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
name|WREG32
argument_list|(
name|FUS_MC_VM_MD_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|FUS_MC_VM_MD_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|FUS_MC_VM_MD_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_JUNIPER
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_CYPRESS
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_HEMLOCK
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_BARTS
operator|)
condition|)
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB3_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB3_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_START_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_END_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
argument_list|,
name|rdev
operator|->
name|gart
operator|.
name|table_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
argument_list|,
name|ENABLE_CONTEXT
operator||
name|PAGE_TABLE_DEPTH
argument_list|(
literal|0
argument_list|)
operator||
name|RANGE_PROTECTION_FAULT_ENABLE_DEFAULT
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PROTECTION_FAULT_DEFAULT_ADDR
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|rdev
operator|->
name|dummy_page
operator|.
name|addr
operator|>>
literal|12
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT1_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evergreen_pcie_gart_tlb_flush
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"PCIE GART of %uM enabled (table at 0x%016llX).\n"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|ready
operator|=
name|true
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|evergreen_pcie_gart_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
comment|/* Disable all tables */
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT1_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_FRAGMENT_PROCESSING
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|BANK_SELECT
argument_list|(
literal|0
argument_list|)
operator||
name|CACHE_UPDATE_MODE
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|tmp
operator|=
name|EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB3_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_unpin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|evergreen_pcie_gart_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|evergreen_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_free
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|evergreen_agp_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_CACHE
operator||
name|ENABLE_L2_FRAGMENT_PROCESSING
operator||
name|ENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|BANK_SELECT
argument_list|(
literal|0
argument_list|)
operator||
name|CACHE_UPDATE_MODE
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|tmp
operator|=
name|ENABLE_L1_TLB
operator||
name|ENABLE_L1_FRAGMENT_PROCESSING
operator||
name|SYSTEM_ACCESS_MODE_NOT_IN_SYS
operator||
name|SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU
operator||
name|EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB3_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT1_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|evergreen_mc_stop
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|evergreen_mc_save
modifier|*
name|save
parameter_list|)
block|{
name|u32
name|crtc_enabled
decl_stmt|,
name|tmp
decl_stmt|,
name|frame_count
decl_stmt|,
name|blackout
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|save
operator|->
name|vga_render_control
operator|=
name|RREG32
argument_list|(
name|VGA_RENDER_CONTROL
argument_list|)
expr_stmt|;
name|save
operator|->
name|vga_hdp_control
operator|=
name|RREG32
argument_list|(
name|VGA_HDP_CONTROL
argument_list|)
expr_stmt|;
comment|/* disable VGA render */
name|WREG32
argument_list|(
name|VGA_RENDER_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* blank the display controllers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|++
control|)
block|{
name|crtc_enabled
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|)
operator|&
name|EVERGREEN_CRTC_MASTER_EN
expr_stmt|;
if|if
condition|(
name|crtc_enabled
condition|)
block|{
name|save
operator|->
name|crtc_enabled
index|[
name|i
index|]
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE6
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_BLANK_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|EVERGREEN_CRTC_BLANK_DATA_EN
operator|)
condition|)
block|{
name|radeon_wait_for_vblank
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|EVERGREEN_CRTC_BLANK_DATA_EN
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_UPDATE_LOCK
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_BLANK_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_UPDATE_LOCK
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|EVERGREEN_CRTC_DISP_READ_REQUEST_DISABLE
operator|)
condition|)
block|{
name|radeon_wait_for_vblank
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|EVERGREEN_CRTC_DISP_READ_REQUEST_DISABLE
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_UPDATE_LOCK
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_UPDATE_LOCK
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* wait for the next frame */
name|frame_count
operator|=
name|radeon_get_vblank_counter
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|radeon_get_vblank_counter
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
operator|!=
name|frame_count
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|save
operator|->
name|crtc_enabled
index|[
name|i
index|]
operator|=
name|false
expr_stmt|;
block|}
block|}
name|radeon_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|blackout
operator|=
name|RREG32
argument_list|(
name|MC_SHARED_BLACKOUT_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|blackout
operator|&
name|BLACKOUT_MODE_MASK
operator|)
operator|!=
literal|1
condition|)
block|{
comment|/* Block CPU access */
name|WREG32
argument_list|(
name|BIF_FB_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* blackout the MC */
name|blackout
operator|&=
operator|~
name|BLACKOUT_MODE_MASK
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SHARED_BLACKOUT_CNTL
argument_list|,
name|blackout
operator||
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* wait for the MC to settle */
name|DRM_UDELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|evergreen_mc_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|evergreen_mc_save
modifier|*
name|save
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|,
name|frame_count
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* update crtc base addresses */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|EVERGREEN_GRPH_PRIMARY_SURFACE_ADDRESS_HIGH
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_GRPH_SECONDARY_SURFACE_ADDRESS_HIGH
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_GRPH_PRIMARY_SURFACE_ADDRESS
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
operator|(
name|u32
operator|)
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_GRPH_SECONDARY_SURFACE_ADDRESS
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
operator|(
name|u32
operator|)
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|EVERGREEN_VGA_MEMORY_BASE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_VGA_MEMORY_BASE_ADDRESS
argument_list|,
operator|(
name|u32
operator|)
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
expr_stmt|;
comment|/* unblackout the MC */
name|tmp
operator|=
name|RREG32
argument_list|(
name|MC_SHARED_BLACKOUT_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|BLACKOUT_MODE_MASK
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SHARED_BLACKOUT_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* allow CPU access */
name|WREG32
argument_list|(
name|BIF_FB_EN
argument_list|,
name|FB_READ_EN
operator||
name|FB_WRITE_EN
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|save
operator|->
name|crtc_enabled
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|ASIC_IS_DCE6
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_BLANK_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|EVERGREEN_CRTC_BLANK_DATA_EN
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_UPDATE_LOCK
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_BLANK_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_UPDATE_LOCK
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|EVERGREEN_CRTC_DISP_READ_REQUEST_DISABLE
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_UPDATE_LOCK
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_CRTC_UPDATE_LOCK
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* wait for the next frame */
name|frame_count
operator|=
name|radeon_get_vblank_counter
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|radeon_get_vblank_counter
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
operator|!=
name|frame_count
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Unlock vga access */
name|WREG32
argument_list|(
name|VGA_HDP_CONTROL
argument_list|,
name|save
operator|->
name|vga_hdp_control
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGA_RENDER_CONTROL
argument_list|,
name|save
operator|->
name|vga_render_control
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|evergreen_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|evergreen_mc_save
name|save
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Initialize HDP */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
operator|,
name|j
operator|+=
literal|0x18
control|)
block|{
name|WREG32
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|HDP_REG_COHERENCY_FLUSH_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evergreen_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|evergreen_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Lockout access through VGA aperture*/
name|WREG32
argument_list|(
name|VGA_HDP_CONTROL
argument_list|,
name|VGA_MEMORY_DISABLE
argument_list|)
expr_stmt|;
comment|/* Update configuration */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|<
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
condition|)
block|{
comment|/* VRAM before AGP */
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* VRAM after AGP */
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_DEFAULT_ADDR
argument_list|,
name|rdev
operator|->
name|vram_scratch
operator|.
name|gpu_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
comment|/* llano/ontario only */
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_PALM
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_SUMO
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_SUMO2
operator|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|MC_FUS_VM_FB_OFFSET
argument_list|)
operator|&
literal|0x000FFFFF
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|20
operator|)
operator|&
literal|0xF
operator|)
operator|<<
literal|24
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|20
operator|)
operator|&
literal|0xF
operator|)
operator|<<
literal|20
expr_stmt|;
name|WREG32
argument_list|(
name|MC_FUS_VM_FB_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|tmp
operator|=
operator|(
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|24
operator|)
operator|&
literal|0xFFFF
operator|)
operator|<<
literal|16
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|24
operator|)
operator|&
literal|0xFFFF
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_FB_LOCATION
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_BASE
argument_list|,
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_INFO
argument_list|,
operator|(
literal|2
operator|<<
literal|7
operator|)
operator||
operator|(
literal|1
operator|<<
literal|30
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_SIZE
argument_list|,
literal|0x3FFFFFFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|WREG32
argument_list|(
name|MC_VM_AGP_TOP
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BOT
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BASE
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|agp_base
operator|>>
literal|22
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|MC_VM_AGP_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_TOP
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BOT
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evergreen_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
name|evergreen_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
comment|/* we need to own VRAM, so turn off the VGA renderer here 	 * to stop it overwriting our objects */
name|rv515_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * CP.  */
end_comment

begin_function
name|void
name|evergreen_ring_ib_execute
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ib
operator|->
name|ring
index|]
decl_stmt|;
name|u32
name|next_rptr
decl_stmt|;
comment|/* set to DX10/11 mode */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_MODE_CONTROL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|rptr_save_reg
condition|)
block|{
name|next_rptr
operator|=
name|ring
operator|->
name|wptr
operator|+
literal|3
operator|+
literal|4
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
name|ring
operator|->
name|rptr_save_reg
operator|-
name|PACKET3_SET_CONFIG_REG_START
operator|)
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
block|{
name|next_rptr
operator|=
name|ring
operator|->
name|wptr
operator|+
literal|5
operator|+
literal|4
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_MEM_WRITE
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ring
operator|->
name|next_rptr_gpu_addr
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|upper_32_bits
argument_list|(
name|ring
operator|->
name|next_rptr_gpu_addr
argument_list|)
operator|&
literal|0xff
operator|)
operator||
operator|(
literal|1
operator|<<
literal|18
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_INDIRECT_BUFFER
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
operator|(
literal|2
operator|<<
literal|0
operator|)
operator||
endif|#
directive|endif
operator|(
name|ib
operator|->
name|gpu_addr
operator|&
literal|0xFFFFFFFC
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|ib
operator|->
name|gpu_addr
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ib
operator|->
name|length_dw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_cp_load_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|__be32
modifier|*
name|fw_data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
condition|)
return|return
operator|-
name|EINVAL
return|;
name|r700_cp_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_CNTL
argument_list|,
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|BUF_SWAP_32BIT
operator||
endif|#
directive|endif
name|RB_NO_UPDATE
operator||
name|RB_BLKSZ
argument_list|(
literal|15
argument_list|)
operator||
name|RB_BUFSZ
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|pfp_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EVERGREEN_PFP_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_PFP_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|me_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EVERGREEN_PM4_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_ME_RAM_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_RADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_cp_start
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|int
name|r
decl_stmt|,
name|i
decl_stmt|;
name|uint32_t
name|cp_me
decl_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to lock ring (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_ME_INITIALIZE
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|-
literal|1
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_ME_INITIALIZE_DEVICE_ID
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|cp_me
operator|=
literal|0xff
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_CNTL
argument_list|,
name|cp_me
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|evergreen_default_size
operator|+
literal|19
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to lock ring (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* setup clear context state */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_PREAMBLE_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_PREAMBLE_BEGIN_CLEAR_STATE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|evergreen_default_size
condition|;
name|i
operator|++
control|)
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|evergreen_default_state
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_PREAMBLE_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_PREAMBLE_END_CLEAR_STATE
argument_list|)
expr_stmt|;
comment|/* set clear context state */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_CLEAR_STATE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* SQ_VTX_BASE_VTX_LOC */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xc0026f00
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* Clear consts */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xc0036f00
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000bc4
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xc0026900
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000316
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x0000000e
argument_list|)
expr_stmt|;
comment|/* VGT_VERTEX_REUSE_BLOCK_CNTL */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/*  */
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_cp_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|u32
name|rb_bufsz
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* Reset cp; if cp is reset, then PA, SH, VGT also need to be reset */
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
operator|(
name|SOFT_RESET_CP
operator||
name|SOFT_RESET_PA
operator||
name|SOFT_RESET_SH
operator||
name|SOFT_RESET_VGT
operator||
name|SOFT_RESET_SPI
operator||
name|SOFT_RESET_SX
operator|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
comment|/* Set ring buffer size */
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|ring
operator|->
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|drm_order
argument_list|(
name|RADEON_GPU_PAGE_SIZE
operator|/
literal|8
argument_list|)
operator|<<
literal|8
operator|)
operator||
name|rb_bufsz
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|tmp
operator||=
name|BUF_SWAP_32BIT
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|CP_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_SEM_WAIT_TIMER
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_SEM_INCOMPLETE_TIMER_CNTL
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* Set the write pointer delay */
name|WREG32
argument_list|(
name|CP_RB_WPTR_DELAY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Initialize the ring buffer's read and write pointers */
name|WREG32
argument_list|(
name|CP_RB_CNTL
argument_list|,
name|tmp
operator||
name|RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_RPTR_WR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ring
operator|->
name|wptr
operator|=
literal|0
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_WPTR
argument_list|,
name|ring
operator|->
name|wptr
argument_list|)
expr_stmt|;
comment|/* set the wb address whether it's enabled or not */
name|WREG32
argument_list|(
name|CP_RB_RPTR_ADDR
argument_list|,
operator|(
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP_RPTR_OFFSET
operator|)
operator|&
literal|0xFFFFFFFC
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_RPTR_ADDR_HI
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP_RPTR_OFFSET
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_ADDR
argument_list|,
operator|(
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_SCRATCH_OFFSET
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
else|else
block|{
name|tmp
operator||=
name|RB_NO_UPDATE
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_BASE
argument_list|,
name|ring
operator|->
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_DEBUG
argument_list|,
operator|(
literal|1
operator|<<
literal|27
operator|)
operator||
operator|(
literal|1
operator|<<
literal|28
operator|)
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr
operator|=
name|RREG32
argument_list|(
name|CP_RB_RPTR
argument_list|)
expr_stmt|;
name|evergreen_cp_start
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|ring
operator|->
name|ready
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|radeon_ring_test
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|,
name|ring
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|ring
operator|->
name|ready
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Core functions  */
end_comment

begin_function
specifier|static
name|void
name|evergreen_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|gb_addr_config
decl_stmt|;
name|u32
name|mc_shared_chmap
decl_stmt|,
name|mc_arb_ramcfg
decl_stmt|;
name|u32
name|sx_debug_1
decl_stmt|;
name|u32
name|smx_dc_ctl0
decl_stmt|;
name|u32
name|sq_config
decl_stmt|;
name|u32
name|sq_lds_resource_mgmt
decl_stmt|;
name|u32
name|sq_gpr_resource_mgmt_1
decl_stmt|;
name|u32
name|sq_gpr_resource_mgmt_2
decl_stmt|;
name|u32
name|sq_gpr_resource_mgmt_3
decl_stmt|;
name|u32
name|sq_thread_resource_mgmt
decl_stmt|;
name|u32
name|sq_thread_resource_mgmt_2
decl_stmt|;
name|u32
name|sq_stack_resource_mgmt_1
decl_stmt|;
name|u32
name|sq_stack_resource_mgmt_2
decl_stmt|;
name|u32
name|sq_stack_resource_mgmt_3
decl_stmt|;
name|u32
name|vgt_cache_invalidation
decl_stmt|;
name|u32
name|hdp_host_path_cntl
decl_stmt|,
name|tmp
decl_stmt|;
name|u32
name|disabled_rb_mask
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|num_shader_engines
decl_stmt|,
name|ps_thread_count
decl_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_CYPRESS
case|:
case|case
name|CHIP_HEMLOCK
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|10
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|=
literal|4
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|=
literal|248
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|=
literal|512
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|=
literal|64
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x100
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|CYPRESS_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_JUNIPER
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|10
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|=
literal|4
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|=
literal|248
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|=
literal|512
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|=
literal|64
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x100
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|JUNIPER_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_REDWOOD
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|5
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|=
literal|2
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|=
literal|248
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|=
literal|64
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x100
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|REDWOOD_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_CEDAR
case|:
default|default:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|=
literal|1
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gs_threads
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|=
literal|96
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x40
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|CEDAR_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_PALM
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|=
literal|1
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gs_threads
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|=
literal|96
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x40
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|CEDAR_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_SUMO
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9648
condition|)
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9647
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x964a
operator|)
condition|)
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|4
expr_stmt|;
else|else
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|5
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|=
literal|2
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|=
literal|248
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|=
literal|64
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x40
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|SUMO_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_SUMO2
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|=
literal|1
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|=
literal|248
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|=
literal|512
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|=
literal|64
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x40
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|SUMO2_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_BARTS
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|7
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|=
literal|4
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|=
literal|248
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|=
literal|512
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|=
literal|64
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x100
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|BARTS_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_TURKS
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|6
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|=
literal|2
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|=
literal|248
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|=
literal|64
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x100
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|TURKS_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_CAICOS
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_simds
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|=
literal|1
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gs_threads
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|=
literal|96
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_hw_contexts
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x40
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|CAICOS_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
block|}
comment|/* Initialize HDP */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
operator|,
name|j
operator|+=
literal|0x18
control|)
block|{
name|WREG32
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|GRBM_CNTL
argument_list|,
name|GRBM_READ_TIMEOUT
argument_list|(
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
name|evergreen_fix_pci_max_read_req_size
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|mc_shared_chmap
operator|=
name|RREG32
argument_list|(
name|MC_SHARED_CHMAP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_PALM
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_SUMO
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_SUMO2
operator|)
condition|)
name|mc_arb_ramcfg
operator|=
name|RREG32
argument_list|(
name|FUS_MC_ARB_RAMCFG
argument_list|)
expr_stmt|;
else|else
name|mc_arb_ramcfg
operator|=
name|RREG32
argument_list|(
name|MC_ARB_RAMCFG
argument_list|)
expr_stmt|;
comment|/* setup tiling info dword.  gb_addr_config is not adequate since it does 	 * not have bank info, so create a custom tiling dword. 	 * bits 3:0   num_pipes 	 * bits 7:4   num_banks 	 * bits 11:8  group_size 	 * bits 15:12 row_size 	 */
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_tile_pipes
condition|)
block|{
case|case
literal|1
case|:
default|default:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator||=
operator|(
literal|0
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator||=
operator|(
literal|1
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator||=
operator|(
literal|2
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator||=
operator|(
literal|3
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
block|}
comment|/* num banks is 8 on all fusion asics. 0 = 4, 1 = 8, 2 = 16 */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator||=
literal|1
operator|<<
literal|4
expr_stmt|;
else|else
block|{
switch|switch
condition|(
operator|(
name|mc_arb_ramcfg
operator|&
name|NOOFBANK_MASK
operator|)
operator|>>
name|NOOFBANK_SHIFT
condition|)
block|{
case|case
literal|0
case|:
comment|/* four banks */
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator||=
literal|0
operator|<<
literal|4
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* eight banks */
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator||=
literal|1
operator|<<
literal|4
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* sixteen banks */
default|default:
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator||=
literal|2
operator|<<
literal|4
expr_stmt|;
break|break;
block|}
block|}
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator||=
literal|0
operator|<<
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|tile_config
operator||=
operator|(
operator|(
name|gb_addr_config
operator|&
literal|0x30000000
operator|)
operator|>>
literal|28
operator|)
operator|<<
literal|12
expr_stmt|;
name|num_shader_engines
operator|=
operator|(
name|gb_addr_config
operator|&
name|NUM_SHADER_ENGINES
argument_list|(
literal|3
argument_list|)
operator|>>
literal|12
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CEDAR
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_HEMLOCK
operator|)
condition|)
block|{
name|u32
name|efuse_straps_4
decl_stmt|;
name|u32
name|efuse_straps_3
decl_stmt|;
name|WREG32
argument_list|(
name|RCU_IND_INDEX
argument_list|,
literal|0x204
argument_list|)
expr_stmt|;
name|efuse_straps_4
operator|=
name|RREG32
argument_list|(
name|RCU_IND_DATA
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RCU_IND_INDEX
argument_list|,
literal|0x203
argument_list|)
expr_stmt|;
name|efuse_straps_3
operator|=
name|RREG32
argument_list|(
name|RCU_IND_DATA
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
operator|(
name|efuse_straps_4
operator|&
literal|0xf
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
operator|(
name|efuse_straps_3
operator|&
literal|0xf0000000
operator|)
operator|>>
literal|28
operator|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|num_ses
operator|-
literal|1
operator|)
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|u32
name|rb_disable_bitmap
decl_stmt|;
name|WREG32
argument_list|(
name|GRBM_GFX_INDEX
argument_list|,
name|INSTANCE_BROADCAST_WRITES
operator||
name|SE_INDEX
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_GFX_INDEX
argument_list|,
name|INSTANCE_BROADCAST_WRITES
operator||
name|SE_INDEX
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|rb_disable_bitmap
operator|=
operator|(
name|RREG32
argument_list|(
name|CC_RB_BACKEND_DISABLE
argument_list|)
operator|&
literal|0x00ff0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|tmp
operator|<<=
literal|4
expr_stmt|;
name|tmp
operator||=
name|rb_disable_bitmap
expr_stmt|;
block|}
block|}
comment|/* enabled rb are just the one not disabled :) */
name|disabled_rb_mask
operator|=
name|tmp
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_GFX_INDEX
argument_list|,
name|INSTANCE_BROADCAST_WRITES
operator||
name|SE_BROADCAST_WRITES
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_GFX_INDEX
argument_list|,
name|INSTANCE_BROADCAST_WRITES
operator||
name|SE_BROADCAST_WRITES
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GB_ADDR_CONFIG
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMIF_ADDR_CONFIG
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_ADDR_CONFIG
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_TILING_CONFIG
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
operator|==
literal|1
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|disabled_rb_mask
operator|&
literal|3
operator|)
operator|==
literal|1
condition|)
block|{
comment|/* RB0 disabled, RB1 enabled */
name|tmp
operator|=
literal|0x11111111
expr_stmt|;
block|}
else|else
block|{
comment|/* RB1 disabled, RB0 enabled */
name|tmp
operator|=
literal|0x00000000
expr_stmt|;
block|}
block|}
else|else
block|{
name|tmp
operator|=
name|gb_addr_config
operator|&
name|NUM_PIPES_MASK
expr_stmt|;
name|tmp
operator|=
name|r6xx_remap_render_backend
argument_list|(
name|rdev
argument_list|,
name|tmp
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_backends
argument_list|,
name|EVERGREEN_MAX_BACKENDS
argument_list|,
name|disabled_rb_mask
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|GB_BACKEND_MAP
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_SYS_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_USER_SYS_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_USER_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set HW defaults for 3D engine */
name|WREG32
argument_list|(
name|CP_QUEUE_THRESHOLDS
argument_list|,
operator|(
name|ROQ_IB1_START
argument_list|(
literal|0x16
argument_list|)
operator||
name|ROQ_IB2_START
argument_list|(
literal|0x2b
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_MEQ_THRESHOLDS
argument_list|,
name|STQ_SPLIT
argument_list|(
literal|0x30
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|TA_CNTL_AUX
argument_list|,
operator|(
name|DISABLE_CUBE_ANISO
operator||
name|SYNC_GRADIENT
operator||
name|SYNC_WALKER
operator||
name|SYNC_ALIGNER
operator|)
argument_list|)
expr_stmt|;
name|sx_debug_1
operator|=
name|RREG32
argument_list|(
name|SX_DEBUG_1
argument_list|)
expr_stmt|;
name|sx_debug_1
operator||=
name|ENABLE_NEW_SMX_ADDRESS
expr_stmt|;
name|WREG32
argument_list|(
name|SX_DEBUG_1
argument_list|,
name|sx_debug_1
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator|=
name|RREG32
argument_list|(
name|SMX_DC_CTL0
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator|&=
operator|~
name|NUMBER_OF_SETS
argument_list|(
literal|0x1ff
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator||=
name|NUMBER_OF_SETS
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_num_of_sets
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SMX_DC_CTL0
argument_list|,
name|smx_dc_ctl0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_SUMO2
condition|)
name|WREG32
argument_list|(
name|SMX_SAR_CTL0
argument_list|,
literal|0x00010000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SX_EXPORT_BUFFER_SIZES
argument_list|,
operator|(
name|COLOR_BUFFER_SIZE
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator||
name|POSITION_BUFFER_SIZE
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_pos_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator||
name|SMX_BUFFER_SIZE
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sx_max_export_smx_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_FIFO_SIZE
argument_list|,
operator|(
name|SC_PRIM_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_prim_fifo_size
argument_list|)
operator||
name|SC_HIZ_TILE_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_hiz_tile_fifo_size
argument_list|)
operator||
name|SC_EARLYZ_TILE_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sc_earlyz_tile_fifo_size
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_NUM_INSTANCES
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_CONFIG_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_CONFIG_CNTL_1
argument_list|,
name|VTX_DONE_DELAY
argument_list|(
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PERFMON_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_MS_FIFO_SIZES
argument_list|,
operator|(
name|CACHE_FIFO_SIZE
argument_list|(
literal|16
operator|*
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|sq_num_cf_insts
argument_list|)
operator||
name|FETCH_FIFO_HIWATER
argument_list|(
literal|0x4
argument_list|)
operator||
name|DONE_FIFO_HIWATER
argument_list|(
literal|0xe0
argument_list|)
operator||
name|ALU_UPDATE_FIFO_HIWATER
argument_list|(
literal|0x8
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sq_config
operator|=
name|RREG32
argument_list|(
name|SQ_CONFIG
argument_list|)
expr_stmt|;
name|sq_config
operator|&=
operator|~
operator|(
name|PS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|VS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|GS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|ES_PRIO
argument_list|(
literal|3
argument_list|)
operator|)
expr_stmt|;
name|sq_config
operator||=
operator|(
name|VC_ENABLE
operator||
name|EXPORT_SRC_C
operator||
name|PS_PRIO
argument_list|(
literal|0
argument_list|)
operator||
name|VS_PRIO
argument_list|(
literal|1
argument_list|)
operator||
name|GS_PRIO
argument_list|(
literal|2
argument_list|)
operator||
name|ES_PRIO
argument_list|(
literal|3
argument_list|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_CEDAR
case|:
case|case
name|CHIP_PALM
case|:
case|case
name|CHIP_SUMO
case|:
case|case
name|CHIP_SUMO2
case|:
case|case
name|CHIP_CAICOS
case|:
comment|/* no vertex cache */
name|sq_config
operator|&=
operator|~
name|VC_ENABLE
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|sq_lds_resource_mgmt
operator|=
name|RREG32
argument_list|(
name|SQ_LDS_RESOURCE_MGMT
argument_list|)
expr_stmt|;
name|sq_gpr_resource_mgmt_1
operator|=
name|NUM_PS_GPRS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|-
operator|(
literal|4
operator|*
literal|2
operator|)
operator|)
operator|*
literal|12
operator|/
literal|32
argument_list|)
expr_stmt|;
name|sq_gpr_resource_mgmt_1
operator||=
name|NUM_VS_GPRS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|-
operator|(
literal|4
operator|*
literal|2
operator|)
operator|)
operator|*
literal|6
operator|/
literal|32
argument_list|)
expr_stmt|;
name|sq_gpr_resource_mgmt_1
operator||=
name|NUM_CLAUSE_TEMP_GPRS
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|sq_gpr_resource_mgmt_2
operator|=
name|NUM_GS_GPRS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|-
operator|(
literal|4
operator|*
literal|2
operator|)
operator|)
operator|*
literal|4
operator|/
literal|32
argument_list|)
expr_stmt|;
name|sq_gpr_resource_mgmt_2
operator||=
name|NUM_ES_GPRS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|-
operator|(
literal|4
operator|*
literal|2
operator|)
operator|)
operator|*
literal|4
operator|/
literal|32
argument_list|)
expr_stmt|;
name|sq_gpr_resource_mgmt_3
operator|=
name|NUM_HS_GPRS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|-
operator|(
literal|4
operator|*
literal|2
operator|)
operator|)
operator|*
literal|3
operator|/
literal|32
argument_list|)
expr_stmt|;
name|sq_gpr_resource_mgmt_3
operator||=
name|NUM_LS_GPRS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_gprs
operator|-
operator|(
literal|4
operator|*
literal|2
operator|)
operator|)
operator|*
literal|3
operator|/
literal|32
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_CEDAR
case|:
case|case
name|CHIP_PALM
case|:
case|case
name|CHIP_SUMO
case|:
case|case
name|CHIP_SUMO2
case|:
name|ps_thread_count
operator|=
literal|96
expr_stmt|;
break|break;
default|default:
name|ps_thread_count
operator|=
literal|128
expr_stmt|;
break|break;
block|}
name|sq_thread_resource_mgmt
operator|=
name|NUM_PS_THREADS
argument_list|(
name|ps_thread_count
argument_list|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator||=
name|NUM_VS_THREADS
argument_list|(
operator|(
operator|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|-
name|ps_thread_count
operator|)
operator|/
literal|6
operator|)
operator|/
literal|8
operator|)
operator|*
literal|8
argument_list|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator||=
name|NUM_GS_THREADS
argument_list|(
operator|(
operator|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|-
name|ps_thread_count
operator|)
operator|/
literal|6
operator|)
operator|/
literal|8
operator|)
operator|*
literal|8
argument_list|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator||=
name|NUM_ES_THREADS
argument_list|(
operator|(
operator|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|-
name|ps_thread_count
operator|)
operator|/
literal|6
operator|)
operator|/
literal|8
operator|)
operator|*
literal|8
argument_list|)
expr_stmt|;
name|sq_thread_resource_mgmt_2
operator|=
name|NUM_HS_THREADS
argument_list|(
operator|(
operator|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|-
name|ps_thread_count
operator|)
operator|/
literal|6
operator|)
operator|/
literal|8
operator|)
operator|*
literal|8
argument_list|)
expr_stmt|;
name|sq_thread_resource_mgmt_2
operator||=
name|NUM_LS_THREADS
argument_list|(
operator|(
operator|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_threads
operator|-
name|ps_thread_count
operator|)
operator|/
literal|6
operator|)
operator|/
literal|8
operator|)
operator|*
literal|8
argument_list|)
expr_stmt|;
name|sq_stack_resource_mgmt_1
operator|=
name|NUM_PS_STACK_ENTRIES
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|6
argument_list|)
expr_stmt|;
name|sq_stack_resource_mgmt_1
operator||=
name|NUM_VS_STACK_ENTRIES
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|6
argument_list|)
expr_stmt|;
name|sq_stack_resource_mgmt_2
operator|=
name|NUM_GS_STACK_ENTRIES
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|6
argument_list|)
expr_stmt|;
name|sq_stack_resource_mgmt_2
operator||=
name|NUM_ES_STACK_ENTRIES
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|6
argument_list|)
expr_stmt|;
name|sq_stack_resource_mgmt_3
operator|=
name|NUM_HS_STACK_ENTRIES
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|6
argument_list|)
expr_stmt|;
name|sq_stack_resource_mgmt_3
operator||=
name|NUM_LS_STACK_ENTRIES
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|evergreen
operator|.
name|max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|6
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_CONFIG
argument_list|,
name|sq_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_GPR_RESOURCE_MGMT_1
argument_list|,
name|sq_gpr_resource_mgmt_1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_GPR_RESOURCE_MGMT_2
argument_list|,
name|sq_gpr_resource_mgmt_2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_GPR_RESOURCE_MGMT_3
argument_list|,
name|sq_gpr_resource_mgmt_3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_THREAD_RESOURCE_MGMT
argument_list|,
name|sq_thread_resource_mgmt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_THREAD_RESOURCE_MGMT_2
argument_list|,
name|sq_thread_resource_mgmt_2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_STACK_RESOURCE_MGMT_1
argument_list|,
name|sq_stack_resource_mgmt_1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_STACK_RESOURCE_MGMT_2
argument_list|,
name|sq_stack_resource_mgmt_2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_STACK_RESOURCE_MGMT_3
argument_list|,
name|sq_stack_resource_mgmt_3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_DYN_GPR_CNTL_PS_FLUSH_REQ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_LDS_RESOURCE_MGMT
argument_list|,
name|sq_lds_resource_mgmt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_FORCE_EOV_MAX_CNTS
argument_list|,
operator|(
name|FORCE_EOV_MAX_CLK_CNT
argument_list|(
literal|4095
argument_list|)
operator||
name|FORCE_EOV_MAX_REZ_CNT
argument_list|(
literal|255
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_CEDAR
case|:
case|case
name|CHIP_PALM
case|:
case|case
name|CHIP_SUMO
case|:
case|case
name|CHIP_SUMO2
case|:
case|case
name|CHIP_CAICOS
case|:
name|vgt_cache_invalidation
operator|=
name|CACHE_INVALIDATION
argument_list|(
name|TC_ONLY
argument_list|)
expr_stmt|;
break|break;
default|default:
name|vgt_cache_invalidation
operator|=
name|CACHE_INVALIDATION
argument_list|(
name|VC_AND_TC
argument_list|)
expr_stmt|;
break|break;
block|}
name|vgt_cache_invalidation
operator||=
name|AUTO_INVLD_EN
argument_list|(
name|ES_AND_GS_AUTO
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_CACHE_INVALIDATION
argument_list|,
name|vgt_cache_invalidation
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_GS_VERTEX_REUSE
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SU_LINE_STIPPLE_VALUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_LINE_STIPPLE_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_VERTEX_REUSE_BLOCK_CNTL
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_OUT_DEALLOC_CNTL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR0_SEL_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR0_SEL_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR1_SEL_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR1_SEL_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR2_SEL_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR2_SEL_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR3_SEL_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR3_SEL_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* clear render buffer base addresses */
name|WREG32
argument_list|(
name|CB_COLOR0_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR1_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR2_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR3_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR4_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR5_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR6_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR7_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR8_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR9_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR10_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR11_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set the shader const cache sizes to 0 */
for|for
control|(
name|i
operator|=
name|SQ_ALU_CONST_BUFFER_SIZE_PS_0
init|;
name|i
operator|<
literal|0x28200
condition|;
name|i
operator|+=
literal|4
control|)
name|WREG32
argument_list|(
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|SQ_ALU_CONST_BUFFER_SIZE_HS_0
init|;
name|i
operator|<
literal|0x29000
condition|;
name|i
operator|+=
literal|4
control|)
name|WREG32
argument_list|(
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|HDP_MISC_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|HDP_FLUSH_INVALIDATE_CACHE
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_MISC_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|hdp_host_path_cntl
operator|=
name|RREG32
argument_list|(
name|HDP_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_HOST_PATH_CNTL
argument_list|,
name|hdp_host_path_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_CL_ENHANCE
argument_list|,
name|CLIP_VTX_REORDER_ENA
operator||
name|NUM_CLIP_SEQ
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|evergreen_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|chansize
decl_stmt|,
name|numchan
decl_stmt|;
comment|/* Get VRAM informations */
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_PALM
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_SUMO
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_SUMO2
operator|)
condition|)
name|tmp
operator|=
name|RREG32
argument_list|(
name|FUS_MC_ARB_RAMCFG
argument_list|)
expr_stmt|;
else|else
name|tmp
operator|=
name|RREG32
argument_list|(
name|MC_ARB_RAMCFG
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|CHANSIZE_OVERRIDE
condition|)
block|{
name|chansize
operator|=
literal|16
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tmp
operator|&
name|CHANSIZE_MASK
condition|)
block|{
name|chansize
operator|=
literal|64
expr_stmt|;
block|}
else|else
block|{
name|chansize
operator|=
literal|32
expr_stmt|;
block|}
name|tmp
operator|=
name|RREG32
argument_list|(
name|MC_SHARED_CHMAP
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|tmp
operator|&
name|NOOFCHAN_MASK
operator|)
operator|>>
name|NOOFCHAN_SHIFT
condition|)
block|{
case|case
literal|0
case|:
default|default:
name|numchan
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|numchan
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|numchan
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|numchan
operator|=
literal|8
expr_stmt|;
break|break;
block|}
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
name|numchan
operator|*
name|chansize
expr_stmt|;
comment|/* Could aper size report 0 ? */
name|rdev
operator|->
name|mc
operator|.
name|aper_base
operator|=
name|drm_get_resource_start
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|aper_size
operator|=
name|drm_get_resource_len
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Setup GPU memory space */
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_PALM
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_SUMO
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_SUMO2
operator|)
condition|)
block|{
comment|/* size in bytes on fusion */
name|rdev
operator|->
name|mc
operator|.
name|mc_vram_size
operator|=
name|RREG32
argument_list|(
name|CONFIG_MEMSIZE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|=
name|RREG32
argument_list|(
name|CONFIG_MEMSIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* size in MB on evergreen/cayman/tn */
name|rdev
operator|->
name|mc
operator|.
name|mc_vram_size
operator|=
name|RREG32
argument_list|(
name|CONFIG_MEMSIZE
argument_list|)
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|=
name|RREG32
argument_list|(
name|CONFIG_MEMSIZE
argument_list|)
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
block|}
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_size
expr_stmt|;
name|r700_vram_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|bool
name|evergreen_gpu_is_lockup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|u32
name|srbm_status
decl_stmt|;
name|u32
name|grbm_status
decl_stmt|;
name|u32
name|grbm_status_se0
decl_stmt|,
name|grbm_status_se1
decl_stmt|;
name|srbm_status
operator|=
name|RREG32
argument_list|(
name|SRBM_STATUS
argument_list|)
expr_stmt|;
name|grbm_status
operator|=
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
expr_stmt|;
name|grbm_status_se0
operator|=
name|RREG32
argument_list|(
name|GRBM_STATUS_SE0
argument_list|)
expr_stmt|;
name|grbm_status_se1
operator|=
name|RREG32
argument_list|(
name|GRBM_STATUS_SE1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|grbm_status
operator|&
name|GUI_ACTIVE
operator|)
condition|)
block|{
name|radeon_ring_lockup_update
argument_list|(
name|ring
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* force CP activities */
name|radeon_ring_force_activity
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|radeon_ring_test_lockup
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|evergreen_gpu_soft_reset_gfx
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|grbm_reset
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
operator|&
name|GUI_ACTIVE
operator|)
condition|)
return|return;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS               = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE0           = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE0
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE1           = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  SRBM_STATUS               = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|SRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008674_CP_STALLED_STAT1 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008678_CP_STALLED_STAT2 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT2
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00867C_CP_BUSY_STAT     = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_BUSY_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008680_CP_STAT          = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Disable CP parsing/prefetching */
name|WREG32
argument_list|(
name|CP_ME_CNTL
argument_list|,
name|CP_ME_HALT
operator||
name|CP_PFP_HALT
argument_list|)
expr_stmt|;
comment|/* reset all the gfx blocks */
name|grbm_reset
operator|=
operator|(
name|SOFT_RESET_CP
operator||
name|SOFT_RESET_CB
operator||
name|SOFT_RESET_DB
operator||
name|SOFT_RESET_PA
operator||
name|SOFT_RESET_SC
operator||
name|SOFT_RESET_SPI
operator||
name|SOFT_RESET_SH
operator||
name|SOFT_RESET_SX
operator||
name|SOFT_RESET_TC
operator||
name|SOFT_RESET_TA
operator||
name|SOFT_RESET_VC
operator||
name|SOFT_RESET_VGT
operator|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_SOFT_RESET=0x%08X\n"
argument_list|,
name|grbm_reset
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
name|grbm_reset
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS               = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE0           = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE0
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE1           = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  SRBM_STATUS               = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|SRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008674_CP_STALLED_STAT1 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008678_CP_STALLED_STAT2 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT2
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00867C_CP_BUSY_STAT     = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_BUSY_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008680_CP_STAT          = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|evergreen_gpu_soft_reset_dma
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
operator|&
name|DMA_IDLE
condition|)
return|return;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00D034_DMA_STATUS_REG   = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Disable DMA */
name|tmp
operator|=
name|RREG32
argument_list|(
name|DMA_RB_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|DMA_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Reset dma */
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
name|SOFT_RESET_DMA
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00D034_DMA_STATUS_REG   = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_gpu_soft_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|reset_mask
parameter_list|)
block|{
name|struct
name|evergreen_mc_save
name|save
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
operator|&
name|GUI_ACTIVE
operator|)
condition|)
name|reset_mask
operator|&=
operator|~
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator|)
expr_stmt|;
if|if
condition|(
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
operator|&
name|DMA_IDLE
condition|)
name|reset_mask
operator|&=
operator|~
name|RADEON_RESET_DMA
expr_stmt|;
if|if
condition|(
name|reset_mask
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU softreset: 0x%08X\n"
argument_list|,
name|reset_mask
argument_list|)
expr_stmt|;
name|evergreen_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|evergreen_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reset_mask
operator|&
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator|)
condition|)
name|evergreen_gpu_soft_reset_gfx
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset_mask
operator|&
name|RADEON_RESET_DMA
condition|)
name|evergreen_gpu_soft_reset_dma
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Wait a little for things to settle down */
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|evergreen_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|evergreen_asic_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
return|return
name|evergreen_gpu_soft_reset
argument_list|(
name|rdev
argument_list|,
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator||
name|RADEON_RESET_DMA
operator|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Interrupts */
end_comment

begin_function
name|u32
name|evergreen_get_vblank_counter
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
if|if
condition|(
name|crtc
operator|>=
name|rdev
operator|->
name|num_crtc
condition|)
return|return
literal|0
return|;
else|else
return|return
name|RREG32
argument_list|(
name|CRTC_STATUS_FRAME_COUNT
operator|+
name|crtc_offsets
index|[
name|crtc
index|]
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|evergreen_disable_interrupt_state
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
name|cayman_cp_int_cntl_setup
argument_list|(
name|rdev
argument_list|,
literal|0
argument_list|,
name|CNTX_BUSY_INT_ENABLE
operator||
name|CNTX_EMPTY_INT_ENABLE
argument_list|)
expr_stmt|;
name|cayman_cp_int_cntl_setup
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cayman_cp_int_cntl_setup
argument_list|(
name|rdev
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|CAYMAN_DMA1_CNTL
argument_list|)
operator|&
operator|~
name|TRAP_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|CAYMAN_DMA1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
name|WREG32
argument_list|(
name|CP_INT_CNTL
argument_list|,
name|CNTX_BUSY_INT_ENABLE
operator||
name|CNTX_EMPTY_INT_ENABLE
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DMA_CNTL
argument_list|)
operator|&
operator|~
name|TRAP_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_INT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* only one DAC on DCE6 */
if|if
condition|(
operator|!
name|ASIC_IS_DCE6
argument_list|(
name|rdev
argument_list|)
condition|)
name|WREG32
argument_list|(
name|DACA_AUTODETECT_INT_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DACB_AUTODETECT_INT_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|evergreen_irq_set
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|cp_int_cntl
init|=
name|CNTX_BUSY_INT_ENABLE
operator||
name|CNTX_EMPTY_INT_ENABLE
decl_stmt|;
name|u32
name|cp_int_cntl1
init|=
literal|0
decl_stmt|,
name|cp_int_cntl2
init|=
literal|0
decl_stmt|;
name|u32
name|crtc1
init|=
literal|0
decl_stmt|,
name|crtc2
init|=
literal|0
decl_stmt|,
name|crtc3
init|=
literal|0
decl_stmt|,
name|crtc4
init|=
literal|0
decl_stmt|,
name|crtc5
init|=
literal|0
decl_stmt|,
name|crtc6
init|=
literal|0
decl_stmt|;
name|u32
name|hpd1
decl_stmt|,
name|hpd2
decl_stmt|,
name|hpd3
decl_stmt|,
name|hpd4
decl_stmt|,
name|hpd5
decl_stmt|,
name|hpd6
decl_stmt|;
name|u32
name|grbm_int_cntl
init|=
literal|0
decl_stmt|;
name|u32
name|grph1
init|=
literal|0
decl_stmt|,
name|grph2
init|=
literal|0
decl_stmt|,
name|grph3
init|=
literal|0
decl_stmt|,
name|grph4
init|=
literal|0
decl_stmt|,
name|grph5
init|=
literal|0
decl_stmt|,
name|grph6
init|=
literal|0
decl_stmt|;
name|u32
name|afmt1
init|=
literal|0
decl_stmt|,
name|afmt2
init|=
literal|0
decl_stmt|,
name|afmt3
init|=
literal|0
decl_stmt|,
name|afmt4
init|=
literal|0
decl_stmt|,
name|afmt5
init|=
literal|0
decl_stmt|,
name|afmt6
init|=
literal|0
decl_stmt|;
name|u32
name|dma_cntl
decl_stmt|,
name|dma_cntl1
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|irq
operator|.
name|installed
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Can't enable IRQ/MSI because no handler is installed\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* don't enable anything if the ih is disabled */
if|if
condition|(
operator|!
name|rdev
operator|->
name|ih
operator|.
name|enabled
condition|)
block|{
name|r600_disable_interrupts
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* force the active interrupt state to all disabled */
name|evergreen_disable_interrupt_state
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|hpd1
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd2
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd3
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd4
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd5
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd6
operator|=
name|RREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|afmt1
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|)
operator|&
operator|~
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|afmt2
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|)
operator|&
operator|~
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|afmt3
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|)
operator|&
operator|~
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|afmt4
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|)
operator|&
operator|~
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|afmt5
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|)
operator|&
operator|~
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|afmt6
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|)
operator|&
operator|~
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|dma_cntl
operator|=
name|RREG32
argument_list|(
name|DMA_CNTL
argument_list|)
operator|&
operator|~
name|TRAP_ENABLE
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
comment|/* enable CP interrupts on all rings */
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: sw int gfx\n"
argument_list|)
expr_stmt|;
name|cp_int_cntl
operator||=
name|TIME_STAMP_INT_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: sw int cp1\n"
argument_list|)
expr_stmt|;
name|cp_int_cntl1
operator||=
name|TIME_STAMP_INT_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: sw int cp2\n"
argument_list|)
expr_stmt|;
name|cp_int_cntl2
operator||=
name|TIME_STAMP_INT_ENABLE
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: sw int gfx\n"
argument_list|)
expr_stmt|;
name|cp_int_cntl
operator||=
name|RB_INT_ENABLE
expr_stmt|;
name|cp_int_cntl
operator||=
name|TIME_STAMP_INT_ENABLE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: sw int dma\n"
argument_list|)
expr_stmt|;
name|dma_cntl
operator||=
name|TRAP_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
name|dma_cntl1
operator|=
name|RREG32
argument_list|(
name|CAYMAN_DMA1_CNTL
argument_list|)
operator|&
operator|~
name|TRAP_ENABLE
expr_stmt|;
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|CAYMAN_RING_TYPE_DMA1_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: sw int dma1\n"
argument_list|)
expr_stmt|;
name|dma_cntl1
operator||=
name|TRAP_ENABLE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|0
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: vblank 0\n"
argument_list|)
expr_stmt|;
name|crtc1
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|1
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: vblank 1\n"
argument_list|)
expr_stmt|;
name|crtc2
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|2
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|2
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: vblank 2\n"
argument_list|)
expr_stmt|;
name|crtc3
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|3
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|3
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: vblank 3\n"
argument_list|)
expr_stmt|;
name|crtc4
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|4
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|4
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: vblank 4\n"
argument_list|)
expr_stmt|;
name|crtc5
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|5
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|5
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: vblank 5\n"
argument_list|)
expr_stmt|;
name|crtc6
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|0
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hpd 1\n"
argument_list|)
expr_stmt|;
name|hpd1
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|1
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hpd 2\n"
argument_list|)
expr_stmt|;
name|hpd2
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|2
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hpd 3\n"
argument_list|)
expr_stmt|;
name|hpd3
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|3
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hpd 4\n"
argument_list|)
expr_stmt|;
name|hpd4
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|4
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hpd 5\n"
argument_list|)
expr_stmt|;
name|hpd5
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|5
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hpd 6\n"
argument_list|)
expr_stmt|;
name|hpd6
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|afmt
index|[
literal|0
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hdmi 0\n"
argument_list|)
expr_stmt|;
name|afmt1
operator||=
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|afmt
index|[
literal|1
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hdmi 1\n"
argument_list|)
expr_stmt|;
name|afmt2
operator||=
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|afmt
index|[
literal|2
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hdmi 2\n"
argument_list|)
expr_stmt|;
name|afmt3
operator||=
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|afmt
index|[
literal|3
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hdmi 3\n"
argument_list|)
expr_stmt|;
name|afmt4
operator||=
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|afmt
index|[
literal|4
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hdmi 4\n"
argument_list|)
expr_stmt|;
name|afmt5
operator||=
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|afmt
index|[
literal|5
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"evergreen_irq_set: hdmi 5\n"
argument_list|)
expr_stmt|;
name|afmt6
operator||=
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
name|cayman_cp_int_cntl_setup
argument_list|(
name|rdev
argument_list|,
literal|0
argument_list|,
name|cp_int_cntl
argument_list|)
expr_stmt|;
name|cayman_cp_int_cntl_setup
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|,
name|cp_int_cntl1
argument_list|)
expr_stmt|;
name|cayman_cp_int_cntl_setup
argument_list|(
name|rdev
argument_list|,
literal|2
argument_list|,
name|cp_int_cntl2
argument_list|)
expr_stmt|;
block|}
else|else
name|WREG32
argument_list|(
name|CP_INT_CNTL
argument_list|,
name|cp_int_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_CNTL
argument_list|,
name|dma_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
name|WREG32
argument_list|(
name|CAYMAN_DMA1_CNTL
argument_list|,
name|dma_cntl1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_INT_CNTL
argument_list|,
name|grbm_int_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|crtc1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|crtc2
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|crtc3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|crtc4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|crtc5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|crtc6
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|grph1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|grph2
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|grph3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|grph4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|grph5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|grph6
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|hpd1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|hpd2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|hpd3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|hpd4
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|hpd5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|hpd6
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|afmt1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|afmt2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|afmt3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|afmt4
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|afmt5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|afmt6
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|evergreen_irq_ack
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE2
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE3
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE4
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE5
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d1grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d2grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d3grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d4grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d5grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d6grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|)
expr_stmt|;
block|}
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status1
operator|=
name|RREG32
argument_list|(
name|AFMT_STATUS
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status2
operator|=
name|RREG32
argument_list|(
name|AFMT_STATUS
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status3
operator|=
name|RREG32
argument_list|(
name|AFMT_STATUS
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status4
operator|=
name|RREG32
argument_list|(
name|AFMT_STATUS
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status5
operator|=
name|RREG32
argument_list|(
name|AFMT_STATUS
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status6
operator|=
name|RREG32
argument_list|(
name|AFMT_STATUS
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d1grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d2grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|LB_D1_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|LB_D1_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|LB_D2_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|LB_D2_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d3grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d4grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|LB_D3_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|LB_D3_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|LB_D4_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|LB_D4_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d5grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d6grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|LB_D5_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|LB_D5_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|LB_D6_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|LB_D6_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|DC_HPD1_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|DC_HPD2_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|DC_HPD3_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|DC_HPD4_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|DC_HPD5_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|DC_HPD6_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status1
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|AFMT_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status2
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|AFMT_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status3
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|AFMT_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status4
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|AFMT_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status5
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|AFMT_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status6
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|AFMT_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|evergreen_irq_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_disable_interrupts
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Wait and acknowledge irq */
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|evergreen_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|evergreen_disable_interrupt_state
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|evergreen_irq_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|evergreen_irq_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_rlc_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|evergreen_get_ih_wptr
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|wptr
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|wptr
operator|=
name|le32_to_cpu
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|wb
index|[
name|R600_WB_IH_WPTR_OFFSET
operator|/
literal|4
index|]
argument_list|)
expr_stmt|;
else|else
name|wptr
operator|=
name|RREG32
argument_list|(
name|IH_RB_WPTR
argument_list|)
expr_stmt|;
if|if
condition|(
name|wptr
operator|&
name|RB_OVERFLOW
condition|)
block|{
comment|/* When a ring buffer overflow happen start parsing interrupt 		 * from the last not overwritten vector (wptr + 16). Hopefully 		 * this should allow us to catchup. 		 */
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IH ring buffer overflow (0x%08X, %d, %d)\n"
argument_list|,
name|wptr
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|rptr
argument_list|,
operator|(
name|wptr
operator|+
literal|16
operator|)
operator|+
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|rptr
operator|=
operator|(
name|wptr
operator|+
literal|16
operator|)
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|IH_RB_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|IH_WPTR_OVERFLOW_CLEAR
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|wptr
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
operator|)
return|;
block|}
end_function

begin_function
name|irqreturn_t
name|evergreen_irq_process
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|wptr
decl_stmt|;
name|u32
name|rptr
decl_stmt|;
name|u32
name|src_id
decl_stmt|,
name|src_data
decl_stmt|;
name|u32
name|ring_index
decl_stmt|;
name|bool
name|queue_hotplug
init|=
name|false
decl_stmt|;
name|bool
name|queue_hdmi
init|=
name|false
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|ih
operator|.
name|enabled
operator|||
name|rdev
operator|->
name|shutdown
condition|)
return|return
name|IRQ_NONE
return|;
name|wptr
operator|=
name|evergreen_get_ih_wptr
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|restart_ih
label|:
comment|/* is somebody else already processing irqs? */
if|if
condition|(
name|atomic_xchg
argument_list|(
operator|&
name|rdev
operator|->
name|ih
operator|.
name|lock
argument_list|,
literal|1
argument_list|)
condition|)
return|return
name|IRQ_NONE
return|;
name|rptr
operator|=
name|rdev
operator|->
name|ih
operator|.
name|rptr
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_process start: rptr %d, wptr %d\n"
argument_list|,
name|rptr
argument_list|,
name|wptr
argument_list|)
expr_stmt|;
comment|/* Order reading of wptr vs. reading of IH ring data */
name|rmb
argument_list|()
expr_stmt|;
comment|/* display interrupts */
name|evergreen_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
while|while
condition|(
name|rptr
operator|!=
name|wptr
condition|)
block|{
comment|/* wptr/rptr are in bytes! */
name|ring_index
operator|=
name|rptr
operator|/
literal|4
expr_stmt|;
name|src_id
operator|=
name|le32_to_cpu
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring
index|[
name|ring_index
index|]
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|src_data
operator|=
name|le32_to_cpu
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring
index|[
name|ring_index
operator|+
literal|1
index|]
argument_list|)
operator|&
literal|0xfffffff
expr_stmt|;
switch|switch
condition|(
name|src_id
condition|)
block|{
case|case
literal|1
case|:
comment|/* D1 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D1 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|LB_D1_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|0
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|0
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&=
operator|~
name|LB_D1_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D1 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D1 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|LB_D1_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&=
operator|~
name|LB_D1_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D1 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|2
case|:
comment|/* D2 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D2 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|LB_D2_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|1
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|1
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&=
operator|~
name|LB_D2_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D2 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D2 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|LB_D2_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&=
operator|~
name|LB_D2_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D2 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|3
case|:
comment|/* D3 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D3 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|LB_D3_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|2
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|2
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&=
operator|~
name|LB_D3_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D3 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D3 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|LB_D3_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&=
operator|~
name|LB_D3_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D3 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|4
case|:
comment|/* D4 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D4 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|LB_D4_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|3
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|3
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&=
operator|~
name|LB_D4_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D4 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D4 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|LB_D4_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&=
operator|~
name|LB_D4_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D4 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|5
case|:
comment|/* D5 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D5 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|LB_D5_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|4
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|4
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&=
operator|~
name|LB_D5_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D5 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D5 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|LB_D5_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&=
operator|~
name|LB_D5_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D5 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|6
case|:
comment|/* D6 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D6 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|LB_D6_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|5
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|5
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&=
operator|~
name|LB_D6_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D6 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D6 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|LB_D6_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&=
operator|~
name|LB_D6_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D6 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|42
case|:
comment|/* HPD hotplug */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|DC_HPD1_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&=
operator|~
name|DC_HPD1_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD1\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|DC_HPD2_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&=
operator|~
name|DC_HPD2_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD2\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|DC_HPD3_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&=
operator|~
name|DC_HPD3_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD3\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|DC_HPD4_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&=
operator|~
name|DC_HPD4_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD4\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|DC_HPD5_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&=
operator|~
name|DC_HPD5_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD5\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|DC_HPD6_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&=
operator|~
name|DC_HPD6_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD6\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|44
case|:
comment|/* hdmi */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status1
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status1
operator|&=
operator|~
name|AFMT_AZ_FORMAT_WTRIG
expr_stmt|;
name|queue_hdmi
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HDMI0\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status2
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status2
operator|&=
operator|~
name|AFMT_AZ_FORMAT_WTRIG
expr_stmt|;
name|queue_hdmi
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HDMI1\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status3
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status3
operator|&=
operator|~
name|AFMT_AZ_FORMAT_WTRIG
expr_stmt|;
name|queue_hdmi
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HDMI2\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status4
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status4
operator|&=
operator|~
name|AFMT_AZ_FORMAT_WTRIG
expr_stmt|;
name|queue_hdmi
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HDMI3\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status5
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status5
operator|&=
operator|~
name|AFMT_AZ_FORMAT_WTRIG
expr_stmt|;
name|queue_hdmi
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HDMI4\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status6
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|afmt_status6
operator|&=
operator|~
name|AFMT_AZ_FORMAT_WTRIG
expr_stmt|;
name|queue_hdmi
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HDMI5\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|146
case|:
case|case
literal|147
case|:
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU fault detected: %d 0x%08x\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  VM_CONTEXT1_PROTECTION_FAULT_ADDR   0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|VM_CONTEXT1_PROTECTION_FAULT_ADDR
argument_list|)
argument_list|)
expr_stmt|;
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  VM_CONTEXT1_PROTECTION_FAULT_STATUS 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|VM_CONTEXT1_PROTECTION_FAULT_STATUS
argument_list|)
argument_list|)
expr_stmt|;
comment|/* reset addr and status */
name|WREG32_P
argument_list|(
name|VM_CONTEXT1_CNTL2
argument_list|,
literal|1
argument_list|,
operator|~
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|176
case|:
comment|/* CP_INT in ring buffer */
case|case
literal|177
case|:
comment|/* CP_INT in IB1 */
case|case
literal|178
case|:
comment|/* CP_INT in IB2 */
name|DRM_DEBUG
argument_list|(
literal|"IH: CP int: 0x%08x\n"
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|181
case|:
comment|/* CP EOP event */
name|DRM_DEBUG
argument_list|(
literal|"IH: CP EOP\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP1_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP2_INDEX
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|224
case|:
comment|/* DMA trap event */
name|DRM_DEBUG
argument_list|(
literal|"IH: DMA trap\n"
argument_list|)
expr_stmt|;
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|R600_RING_TYPE_DMA_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|233
case|:
comment|/* GUI IDLE */
name|DRM_DEBUG
argument_list|(
literal|"IH: GUI idle\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|244
case|:
comment|/* DMA trap event */
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"IH: DMA1 trap\n"
argument_list|)
expr_stmt|;
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_DMA1_INDEX
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* wptr/rptr are in bytes! */
name|rptr
operator|+=
literal|16
expr_stmt|;
name|rptr
operator|&=
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
expr_stmt|;
block|}
if|if
condition|(
name|queue_hotplug
condition|)
name|taskqueue_enqueue
argument_list|(
name|rdev
operator|->
name|tq
argument_list|,
operator|&
name|rdev
operator|->
name|hotplug_work
argument_list|)
expr_stmt|;
if|if
condition|(
name|queue_hdmi
condition|)
name|taskqueue_enqueue
argument_list|(
name|rdev
operator|->
name|tq
argument_list|,
operator|&
name|rdev
operator|->
name|audio_work
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|rptr
operator|=
name|rptr
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_RPTR
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|rptr
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|rdev
operator|->
name|ih
operator|.
name|lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* make sure wptr hasn't changed while processing */
name|wptr
operator|=
name|evergreen_get_ih_wptr
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|wptr
operator|!=
name|rptr
condition|)
goto|goto
name|restart_ih
goto|;
return|return
name|IRQ_HANDLED
return|;
block|}
end_function

begin_comment
comment|/**  * evergreen_dma_fence_ring_emit - emit a fence on the DMA ring  *  * @rdev: radeon_device pointer  * @fence: radeon fence object  *  * Add a DMA fence packet to the ring to write  * the fence seq number and DMA trap packet to generate  * an interrupt if needed (evergreen-SI).  */
end_comment

begin_function
name|void
name|evergreen_dma_fence_ring_emit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_fence
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|fence
operator|->
name|ring
index|]
decl_stmt|;
name|u64
name|addr
init|=
name|rdev
operator|->
name|fence_drv
index|[
name|fence
operator|->
name|ring
index|]
operator|.
name|gpu_addr
decl_stmt|;
comment|/* write the fence */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_FENCE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|addr
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|upper_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|fence
operator|->
name|seq
argument_list|)
expr_stmt|;
comment|/* generate an interrupt */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_TRAP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* flush HDP */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_SRBM_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|0xf
operator|<<
literal|16
operator|)
operator||
operator|(
name|HDP_MEM_COHERENCY_FLUSH_CNTL
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * evergreen_dma_ring_ib_execute - schedule an IB on the DMA engine  *  * @rdev: radeon_device pointer  * @ib: IB object to schedule  *  * Schedule an IB in the DMA ring (evergreen).  */
end_comment

begin_function
name|void
name|evergreen_dma_ring_ib_execute
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ib
operator|->
name|ring
index|]
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
block|{
name|u32
name|next_rptr
init|=
name|ring
operator|->
name|wptr
operator|+
literal|4
decl_stmt|;
while|while
condition|(
operator|(
name|next_rptr
operator|&
literal|7
operator|)
operator|!=
literal|5
condition|)
name|next_rptr
operator|++
expr_stmt|;
name|next_rptr
operator|+=
literal|3
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ring
operator|->
name|next_rptr_gpu_addr
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|ring
operator|->
name|next_rptr_gpu_addr
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
block|}
comment|/* The indirect buffer packet must end on an 8 DW boundary in the DMA ring. 	 * Pad as necessary with NOPs. 	 */
while|while
condition|(
operator|(
name|ring
operator|->
name|wptr
operator|&
literal|7
operator|)
operator|!=
literal|5
condition|)
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_NOP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_INDIRECT_BUFFER
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|ib
operator|->
name|gpu_addr
operator|&
literal|0xFFFFFFE0
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|ib
operator|->
name|length_dw
operator|<<
literal|12
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|ib
operator|->
name|gpu_addr
argument_list|)
operator|&
literal|0xFF
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * evergreen_copy_dma - copy pages using the DMA engine  *  * @rdev: radeon_device pointer  * @src_offset: src GPU address  * @dst_offset: dst GPU address  * @num_gpu_pages: number of GPU pages to xfer  * @fence: radeon fence object  *  * Copy GPU paging using the DMA engine (evergreen-cayman).  * Used by the radeon ttm implementation to move pages if  * registered as the asic copy callback.  */
end_comment

begin_function
name|int
name|evergreen_copy_dma
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint64_t
name|src_offset
parameter_list|,
name|uint64_t
name|dst_offset
parameter_list|,
name|unsigned
name|num_gpu_pages
parameter_list|,
name|struct
name|radeon_fence
modifier|*
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_semaphore
modifier|*
name|sem
init|=
name|NULL
decl_stmt|;
name|int
name|ring_index
init|=
name|rdev
operator|->
name|asic
operator|->
name|copy
operator|.
name|dma_ring_index
decl_stmt|;
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ring_index
index|]
decl_stmt|;
name|u32
name|size_in_dw
decl_stmt|,
name|cur_size_in_dw
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_loops
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
name|r
operator|=
name|radeon_semaphore_create
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: moving bo (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|size_in_dw
operator|=
operator|(
name|num_gpu_pages
operator|<<
name|RADEON_GPU_PAGE_SHIFT
operator|)
operator|/
literal|4
expr_stmt|;
name|num_loops
operator|=
name|DIV_ROUND_UP
argument_list|(
name|size_in_dw
argument_list|,
literal|0xfffff
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|num_loops
operator|*
literal|5
operator|+
literal|11
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: moving bo (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
name|radeon_fence_need_sync
argument_list|(
operator|*
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
condition|)
block|{
name|radeon_semaphore_sync_rings
argument_list|(
name|rdev
argument_list|,
name|sem
argument_list|,
operator|(
operator|*
name|fence
operator|)
operator|->
name|ring
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
name|radeon_fence_note_sync
argument_list|(
operator|*
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_loops
condition|;
name|i
operator|++
control|)
block|{
name|cur_size_in_dw
operator|=
name|size_in_dw
expr_stmt|;
if|if
condition|(
name|cur_size_in_dw
operator|>
literal|0xFFFFF
condition|)
name|cur_size_in_dw
operator|=
literal|0xFFFFF
expr_stmt|;
name|size_in_dw
operator|-=
name|cur_size_in_dw
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_COPY
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|cur_size_in_dw
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|dst_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|src_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|dst_offset
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|src_offset
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|src_offset
operator|+=
name|cur_size_in_dw
operator|*
literal|4
expr_stmt|;
name|dst_offset
operator|+=
name|cur_size_in_dw
operator|*
literal|4
expr_stmt|;
block|}
name|r
operator|=
name|radeon_fence_emit
argument_list|(
name|rdev
argument_list|,
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_ring_unlock_undo
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
operator|*
name|fence
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|evergreen_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* enable pcie gen2 link */
name|evergreen_pcie_gen2_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
operator|||
operator|!
name|rdev
operator|->
name|rlc_fw
operator|||
operator|!
name|rdev
operator|->
name|mc_fw
condition|)
block|{
name|r
operator|=
name|ni_init_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
name|r
operator|=
name|ni_mc_load_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load MC firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
operator|||
operator|!
name|rdev
operator|->
name|rlc_fw
condition|)
block|{
name|r
operator|=
name|r600_init_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
block|}
name|r
operator|=
name|r600_vram_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|evergreen_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|evergreen_agp_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|evergreen_pcie_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
name|evergreen_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r
operator|=
name|evergreen_blit_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|r600_blit_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|asic
operator|->
name|copy
operator|.
name|copy
operator|=
name|NULL
expr_stmt|;
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed blitter (%d) falling back to memcpy\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|R600_RING_TYPE_DMA_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing DMA fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|r
operator|=
name|r600_irq_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: IH init failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|evergreen_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|RADEON_WB_CP_RPTR_OFFSET
argument_list|,
name|R600_CP_RB_RPTR
argument_list|,
name|R600_CP_RB_WPTR
argument_list|,
literal|0
argument_list|,
literal|0xfffff
argument_list|,
name|RADEON_CP_PACKET2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|R600_WB_DMA_RPTR_OFFSET
argument_list|,
name|DMA_RB_RPTR
argument_list|,
name|DMA_RB_WPTR
argument_list|,
literal|2
argument_list|,
literal|0x3fffc
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_NOP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|evergreen_cp_load_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|evergreen_cp_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|r600_dma_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|r600_audio_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: audio init failed\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|evergreen_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* reset the asic, the gfx blocks are often in a bad state 	 * after the driver is unloaded or after a resume 	 */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed !\n"
argument_list|)
expr_stmt|;
comment|/* Do not reset GPU before posting, on rv770 hw unlike on r500 hw, 	 * posting will perform necessary task to bring back GPU into good 	 * shape. 	 */
comment|/* post card */
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|evergreen_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"evergreen startup failed on resume\n"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|evergreen_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_audio_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r700_cp_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_dma_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|evergreen_irq_suspend
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|evergreen_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Plan is to move initialization in that function and use  * helper function so that radeon_device_init pretty much  * do nothing more than calling asic specific function. This  * should also allow to remove a bunch of callback function  * like vram_info.  */
end_comment

begin_function
name|int
name|evergreen_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Read BIOS */
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Must be an ATOMBIOS */
if|if
condition|(
operator|!
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting atombios for evergreen GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_atombios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* reset the asic, the gfx blocks are often in a bad state 	 * after the driver is unloaded or after a resume 	 */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed !\n"
argument_list|)
expr_stmt|;
comment|/* Post card if necessary */
if|if
condition|(
operator|!
name|radeon_card_posted
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Card not posted and no BIOS - ignoring\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_INFO
argument_list|(
literal|"GPU not posted. posting now...\n"
argument_list|)
expr_stmt|;
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize scratch registers */
name|r600_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* initialize AGP */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|r
operator|=
name|radeon_agp_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
name|radeon_agp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
comment|/* initialize memory controller */
name|r
operator|=
name|evergreen_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ih_ring_init
argument_list|(
name|rdev
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|r
operator|=
name|r600_pcie_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|evergreen_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|r700_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_dma_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_irq_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|evergreen_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
comment|/* Don't start up if the MC ucode is missing on BTC parts. 	 * The default clocks and voltages before the MC ucode 	 * is loaded are not suffient for advanced operations. 	 */
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|mc_fw
operator|&&
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: MC ucode required for NI+.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|evergreen_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_audio_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_blit_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r700_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_dma_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_irq_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|evergreen_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_vram_scratch_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_agp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
condition|)
name|ni_fini_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
else|else
name|r600_fini_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|evergreen_pcie_gen2_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|link_width_cntl
decl_stmt|,
name|speed_cntl
decl_stmt|,
name|mask
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|radeon_pcie_gen2
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
operator|)
condition|)
return|return;
comment|/* x2 cards have a special sequence */
if|if
condition|(
name|ASIC_IS_X2
argument_list|(
name|rdev
argument_list|)
condition|)
return|return;
name|ret
operator|=
name|drm_pcie_get_speed_cap_mask
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|DRM_PCIE_SPEED_50
operator|)
condition|)
return|return;
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|speed_cntl
operator|&
name|LC_CURRENT_DATA_RATE
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"PCIE gen 2 link speeds already enabled\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|DRM_INFO
argument_list|(
literal|"enabling PCIE gen 2 link speeds, disable with radeon.pcie_gen2=0\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|speed_cntl
operator|&
name|LC_OTHER_SIDE_EVER_SENT_GEN2
operator|)
operator|||
operator|(
name|speed_cntl
operator|&
name|LC_OTHER_SIDE_SUPPORTS_GEN2
operator|)
condition|)
block|{
name|link_width_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
name|link_width_cntl
operator|&=
operator|~
name|LC_UPCONFIGURE_DIS
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
name|speed_cntl
operator|&=
operator|~
name|LC_TARGET_LINK_SPEED_OVERRIDE_EN
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
name|speed_cntl
operator||=
name|LC_CLR_FAILED_SPD_CHANGE_CNT
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
name|speed_cntl
operator|&=
operator|~
name|LC_CLR_FAILED_SPD_CHANGE_CNT
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
name|speed_cntl
operator||=
name|LC_GEN2_EN_STRAP
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|link_width_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
comment|/* XXX: only disable it if gen1 bridge vendor == 0x111d or 0x1106 */
if|if
condition|(
literal|1
condition|)
name|link_width_cntl
operator||=
name|LC_UPCONFIGURE_DIS
expr_stmt|;
else|else
name|link_width_cntl
operator|&=
operator|~
name|LC_UPCONFIGURE_DIS
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"r520d.h"
end_include

begin_comment
comment|/* This files gather functions specifics to: r520,rv530,rv560,rv570,r580 */
end_comment

begin_function
name|int
name|r520_mc_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
comment|/* read MC_STATUS */
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R520_MC_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|R520_MC_STATUS_IDLE
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r520_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|pipe_select_current
decl_stmt|,
name|gb_pipe_select
decl_stmt|,
name|tmp
decl_stmt|;
name|rv515_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* 	 * DST_PIPE_CONFIG		0x170C 	 * GB_TILE_CONFIG		0x4018 	 * GB_FIFO_SIZE			0x4024 	 * GB_PIPE_SELECT		0x402C 	 * GB_PIPE_SELECT2              0x4124 	 *	Z_PIPE_SHIFT			0 	 *	Z_PIPE_MASK			0x000000003 	 * GB_FIFO_SIZE2                0x4128 	 *	SC_SFIFO_SIZE_SHIFT		0 	 *	SC_SFIFO_SIZE_MASK		0x000000003 	 *	SC_MFIFO_SIZE_SHIFT		2 	 *	SC_MFIFO_SIZE_MASK		0x00000000C 	 *	FG_SFIFO_SIZE_SHIFT		4 	 *	FG_SFIFO_SIZE_MASK		0x000000030 	 *	ZB_MFIFO_SIZE_SHIFT		6 	 *	ZB_MFIFO_SIZE_MASK		0x0000000C0 	 * GA_ENHANCE			0x4274 	 * SU_REG_DEST			0x42C8 	 */
comment|/* workaround for RV530 */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV530
condition|)
block|{
name|WREG32
argument_list|(
literal|0x4128
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
name|r420_pipes_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|gb_pipe_select
operator|=
name|RREG32
argument_list|(
name|R400_GB_PIPE_SELECT
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|R300_DST_PIPE_CONFIG
argument_list|)
expr_stmt|;
name|pipe_select_current
operator|=
operator|(
name|tmp
operator|>>
literal|2
operator|)
operator|&
literal|3
expr_stmt|;
name|tmp
operator|=
operator|(
literal|1
operator|<<
name|pipe_select_current
operator|)
operator||
operator|(
operator|(
operator|(
name|gb_pipe_select
operator|>>
literal|8
operator|)
operator|&
literal|0xF
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
literal|0x000D
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|r520_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to wait MC idle while "
literal|"programming pipes. Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|r520_vram_get_type
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|R520_MC_CNTL0
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|tmp
operator|&
name|R520_MEM_NUM_CHANNELS_MASK
operator|)
operator|>>
name|R520_MEM_NUM_CHANNELS_SHIFT
condition|)
block|{
case|case
literal|0
case|:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|32
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|64
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|256
expr_stmt|;
break|break;
default|default:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tmp
operator|&
name|R520_MC_CHANNEL_SIZE
condition|)
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|*=
literal|2
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r520_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r520_vram_get_type
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_vram_init_sizes
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_vram_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_base_align
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
condition|)
name|radeon_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r520_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|rv515_mc_save
name|save
decl_stmt|;
comment|/* Stops all mc clients */
name|rv515_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
comment|/* Wait for mc idle */
if|if
condition|(
name|r520_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait MC idle timeout before updating MC.\n"
argument_list|)
expr_stmt|;
comment|/* Write VRAM size in case we are limiting it */
name|WREG32
argument_list|(
name|R_0000F8_CONFIG_MEMSIZE
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
argument_list|)
expr_stmt|;
comment|/* Program MC, should be a 32bits limited address space */
name|WREG32_MC
argument_list|(
name|R_000004_MC_FB_LOCATION
argument_list|,
name|S_000004_MC_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
operator||
name|S_000004_MC_FB_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000134_HDP_FB_LOCATION
argument_list|,
name|S_000134_HDP_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|WREG32_MC
argument_list|(
name|R_000005_MC_AGP_LOCATION
argument_list|,
name|S_000005_MC_AGP_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|16
argument_list|)
operator||
name|S_000005_MC_AGP_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000006_AGP_BASE
argument_list|,
name|lower_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|agp_base
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000007_AGP_BASE_2
argument_list|,
name|S_000007_AGP_BASE_ADDR_2
argument_list|(
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|agp_base
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32_MC
argument_list|(
name|R_000005_MC_AGP_LOCATION
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000006_AGP_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000007_AGP_BASE_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|rv515_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|r520_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|r520_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GPU configuration (# pipes, ...) */
name|r520_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GART (initialize after TTM so we can allocate 	 * memory through TTM but finalize after TTM) */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
block|{
name|r
operator|=
name|rv370_pcie_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|rs600_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|hdp_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
comment|/* 1M ring buffer */
name|r
operator|=
name|r100_cp_init
argument_list|(
name|rdev
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r520_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Make sur GART are not working */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|rv370_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock before doing reset */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* post */
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
comment|/* Resume clock after posting */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|r520_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|r520_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Initialize scratch registers */
name|radeon_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* restore some register to sane defaults */
name|r100_restore_sanity
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* TODO: disable VGA need to use VGA request */
comment|/* BIOS*/
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|r
operator|=
name|radeon_atombios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
else|else
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting atombios for RV515 GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* check if cards are posted or not */
if|if
condition|(
name|radeon_boot_test_post_card
argument_list|(
name|rdev
argument_list|)
operator|==
name|false
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
operator|!
name|radeon_card_posted
argument_list|(
name|rdev
argument_list|)
operator|&&
name|rdev
operator|->
name|bios
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"GPU not posted. posting now...\n"
argument_list|)
expr_stmt|;
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* initialize AGP */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|r
operator|=
name|radeon_agp_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_agp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* initialize memory controller */
name|r520_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv515_debugfs
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|rv370_pcie_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rv515_set_safe_registers
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|r520_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
comment|/* Somethings want wront with the accel init stop accel */
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv370_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_agp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


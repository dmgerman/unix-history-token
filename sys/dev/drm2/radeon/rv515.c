begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"rv515d.h"
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"rv515_reg_safe.h"
end_include

begin_comment
comment|/* This files gather functions specifics to: rv515 */
end_comment

begin_function_decl
specifier|static
name|int
name|rv515_debugfs_pipes_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rv515_debugfs_ga_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rv515_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|crtc_offsets
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
name|AVIVO_D2CRTC_H_TOTAL
operator|-
name|AVIVO_D1CRTC_H_TOTAL
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|rv515_debugfs
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|r100_debugfs_rbbm_init
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to register debugfs file for RBBM !\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rv515_debugfs_pipes_info_init
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to register debugfs file for pipes !\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rv515_debugfs_ga_info_init
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to register debugfs file for pipes !\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|rv515_ring_start
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|ISYNC_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ISYNC_ANY2D_IDLE3D
operator||
name|ISYNC_ANY3D_IDLE2D
operator||
name|ISYNC_WAIT_IDLEGUI
operator||
name|ISYNC_CPSCRATCH_IDLEGUI
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|WAIT_2D_IDLECLEAN
operator||
name|WAIT_3D_IDLECLEAN
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R300_DST_PIPE_CONFIG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|R300_PIPE_AUTO_CONFIG
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|GB_SELECT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|GB_ENABLE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|R500_SU_REG_DEST
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|1
operator|<<
name|rdev
operator|->
name|num_gb_pipes
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|VAP_INDEX_OFFSET
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RB3D_DC_FLUSH
operator||
name|RB3D_DC_FREE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|ZB_ZCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ZC_FLUSH
operator||
name|ZC_FREE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|WAIT_2D_IDLECLEAN
operator||
name|WAIT_3D_IDLECLEAN
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|GB_AA_CONFIG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RB3D_DC_FLUSH
operator||
name|RB3D_DC_FREE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|ZB_ZCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ZC_FLUSH
operator||
name|ZC_FREE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|GB_MSPOS0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
literal|6
operator|<<
name|MS_X0_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MS_Y0_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MS_X1_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MS_Y1_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MS_X2_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MS_Y2_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MSBD0_Y_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MSBD0_X_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|GB_MSPOS1
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
literal|6
operator|<<
name|MS_X3_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MS_Y3_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MS_X4_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MS_Y4_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MS_X5_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MS_Y5_SHIFT
operator|)
operator||
operator|(
literal|6
operator|<<
name|MSBD1_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|GA_ENHANCE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|GA_DEADLOCK_CNTL
operator||
name|GA_FASTSYNC_CNTL
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|GA_POLY_MODE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|FRONT_PTYPE_TRIANGE
operator||
name|BACK_PTYPE_TRIANGE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|GA_ROUND_MODE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|GEOMETRY_ROUND_NEAREST
operator||
name|COLOR_ROUND_NEAREST
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
literal|0x20C8
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rv515_mc_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
comment|/* read MC_STATUS */
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|MC_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|MC_STATUS_IDLE
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|rv515_vga_render_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|WREG32
argument_list|(
name|R_000300_VGA_RENDER_CONTROL
argument_list|,
name|RREG32
argument_list|(
name|R_000300_VGA_RENDER_CONTROL
argument_list|)
operator|&
name|C_000300_VGA_VSTATUS_CNTL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rv515_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|pipe_select_current
decl_stmt|,
name|gb_pipe_select
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
name|r100_gui_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to wait GUI idle while "
literal|"resetting GPU. Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
name|rv515_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r420_pipes_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|gb_pipe_select
operator|=
name|RREG32
argument_list|(
name|R400_GB_PIPE_SELECT
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|R300_DST_PIPE_CONFIG
argument_list|)
expr_stmt|;
name|pipe_select_current
operator|=
operator|(
name|tmp
operator|>>
literal|2
operator|)
operator|&
literal|3
expr_stmt|;
name|tmp
operator|=
operator|(
literal|1
operator|<<
name|pipe_select_current
operator|)
operator||
operator|(
operator|(
operator|(
name|gb_pipe_select
operator|>>
literal|8
operator|)
operator|&
literal|0xF
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
literal|0x000D
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|r100_gui_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to wait GUI idle while "
literal|"resetting GPU. Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rv515_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to wait MC idle while "
literal|"programming pipes. Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rv515_vram_get_type
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|RV515_MC_CNTL
argument_list|)
operator|&
name|MEM_NUM_CHANNELS_MASK
expr_stmt|;
switch|switch
condition|(
name|tmp
condition|)
block|{
case|case
literal|0
case|:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|64
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
break|break;
default|default:
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rv515_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|rv515_vram_get_type
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_vram_init_sizes
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_vram_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_base_align
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
condition|)
name|radeon_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|rv515_mc_rreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|)
block|{
name|uint32_t
name|r
decl_stmt|;
name|WREG32
argument_list|(
name|MC_IND_INDEX
argument_list|,
literal|0x7f0000
operator||
operator|(
name|reg
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|RREG32
argument_list|(
name|MC_IND_DATA
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_IND_INDEX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|rv515_mc_wreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|v
parameter_list|)
block|{
name|WREG32
argument_list|(
name|MC_IND_INDEX
argument_list|,
literal|0xff0000
operator||
operator|(
operator|(
name|reg
operator|)
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_IND_DATA
argument_list|,
operator|(
name|v
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_IND_INDEX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
end_if

begin_function
specifier|static
name|int
name|rv515_debugfs_pipes_info
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_info_node
modifier|*
name|node
init|=
operator|(
expr|struct
name|drm_info_node
operator|*
operator|)
name|m
operator|->
name|private
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|node
operator|->
name|minor
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|GB_PIPE_SELECT
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GB_PIPE_SELECT 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|SU_REG_DEST
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"SU_REG_DEST 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|GB_TILE_CONFIG
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GB_TILE_CONFIG 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DST_PIPE_CONFIG
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"DST_PIPE_CONFIG 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rv515_debugfs_ga_info
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_info_node
modifier|*
name|node
init|=
operator|(
expr|struct
name|drm_info_node
operator|*
operator|)
name|m
operator|->
name|private
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|node
operator|->
name|minor
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
literal|0x2140
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"VAP_CNTL_STATUS 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
literal|0x425C
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"GA_IDLE 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|drm_info_list
name|rv515_pipes_info_list
index|[]
init|=
block|{
block|{
literal|"rv515_pipes_info"
block|,
name|rv515_debugfs_pipes_info
block|,
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|drm_info_list
name|rv515_ga_info_list
index|[]
init|=
block|{
block|{
literal|"rv515_ga_info"
block|,
name|rv515_debugfs_ga_info
block|,
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|rv515_debugfs_pipes_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
return|return
name|radeon_debugfs_add_files
argument_list|(
name|rdev
argument_list|,
name|rv515_pipes_info_list
argument_list|,
literal|1
argument_list|)
return|;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|rv515_debugfs_ga_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
return|return
name|radeon_debugfs_add_files
argument_list|(
name|rdev
argument_list|,
name|rv515_ga_info_list
argument_list|,
literal|1
argument_list|)
return|;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|rv515_mc_stop
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|rv515_mc_save
modifier|*
name|save
parameter_list|)
block|{
name|u32
name|crtc_enabled
decl_stmt|,
name|tmp
decl_stmt|,
name|frame_count
decl_stmt|,
name|blackout
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|save
operator|->
name|vga_render_control
operator|=
name|RREG32
argument_list|(
name|R_000300_VGA_RENDER_CONTROL
argument_list|)
expr_stmt|;
name|save
operator|->
name|vga_hdp_control
operator|=
name|RREG32
argument_list|(
name|R_000328_VGA_HDP_CONTROL
argument_list|)
expr_stmt|;
comment|/* disable VGA render */
name|WREG32
argument_list|(
name|R_000300_VGA_RENDER_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* blank the display controllers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|++
control|)
block|{
name|crtc_enabled
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|)
operator|&
name|AVIVO_CRTC_EN
expr_stmt|;
if|if
condition|(
name|crtc_enabled
condition|)
block|{
name|save
operator|->
name|crtc_enabled
index|[
name|i
index|]
operator|=
name|true
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|AVIVO_CRTC_DISP_READ_REQUEST_DISABLE
operator|)
condition|)
block|{
name|radeon_wait_for_vblank
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|AVIVO_CRTC_DISP_READ_REQUEST_DISABLE
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
comment|/* wait for the next frame */
name|frame_count
operator|=
name|radeon_get_vblank_counter
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|radeon_get_vblank_counter
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
operator|!=
name|frame_count
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|save
operator|->
name|crtc_enabled
index|[
name|i
index|]
operator|=
name|false
expr_stmt|;
block|}
block|}
name|radeon_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
name|blackout
operator|=
name|RREG32
argument_list|(
name|R700_MC_CITF_CNTL
argument_list|)
expr_stmt|;
else|else
name|blackout
operator|=
name|RREG32
argument_list|(
name|R600_CITF_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|blackout
operator|&
name|R600_BLACKOUT_MASK
operator|)
operator|!=
name|R600_BLACKOUT_MASK
condition|)
block|{
comment|/* Block CPU access */
name|WREG32
argument_list|(
name|R600_BIF_FB_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* blackout the MC */
name|blackout
operator||=
name|R600_BLACKOUT_MASK
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
name|WREG32
argument_list|(
name|R700_MC_CITF_CNTL
argument_list|,
name|blackout
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|R600_CITF_CNTL
argument_list|,
name|blackout
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* wait for the MC to settle */
name|DRM_UDELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rv515_mc_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|rv515_mc_save
modifier|*
name|save
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|,
name|frame_count
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* update crtc base addresses */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
block|{
if|if
condition|(
name|i
operator|==
literal|1
condition|)
block|{
name|WREG32
argument_list|(
name|R700_D1GRPH_PRIMARY_SURFACE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R700_D1GRPH_SECONDARY_SURFACE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|R700_D2GRPH_PRIMARY_SURFACE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R700_D2GRPH_SECONDARY_SURFACE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|WREG32
argument_list|(
name|R_006110_D1GRPH_PRIMARY_SURFACE_ADDRESS
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
operator|(
name|u32
operator|)
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_006118_D1GRPH_SECONDARY_SURFACE_ADDRESS
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
operator|(
name|u32
operator|)
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|R_000310_VGA_MEMORY_BASE_ADDRESS
argument_list|,
operator|(
name|u32
operator|)
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
block|{
comment|/* unblackout the MC */
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
name|tmp
operator|=
name|RREG32
argument_list|(
name|R700_MC_CITF_CNTL
argument_list|)
expr_stmt|;
else|else
name|tmp
operator|=
name|RREG32
argument_list|(
name|R600_CITF_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|R600_BLACKOUT_MASK
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
name|WREG32
argument_list|(
name|R700_MC_CITF_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|R600_CITF_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* allow CPU access */
name|WREG32
argument_list|(
name|R600_BIF_FB_EN
argument_list|,
name|R600_FB_READ_EN
operator||
name|R600_FB_WRITE_EN
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|save
operator|->
name|crtc_enabled
index|[
name|i
index|]
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|AVIVO_CRTC_DISP_READ_REQUEST_DISABLE
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1CRTC_CONTROL
operator|+
name|crtc_offsets
index|[
name|i
index|]
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* wait for the next frame */
name|frame_count
operator|=
name|radeon_get_vblank_counter
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|radeon_get_vblank_counter
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|)
operator|!=
name|frame_count
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Unlock vga access */
name|WREG32
argument_list|(
name|R_000328_VGA_HDP_CONTROL
argument_list|,
name|save
operator|->
name|vga_hdp_control
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000300_VGA_RENDER_CONTROL
argument_list|,
name|save
operator|->
name|vga_render_control
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rv515_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|rv515_mc_save
name|save
decl_stmt|;
comment|/* Stops all mc clients */
name|rv515_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
comment|/* Wait for mc idle */
if|if
condition|(
name|rv515_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait MC idle timeout before updating MC.\n"
argument_list|)
expr_stmt|;
comment|/* Write VRAM size in case we are limiting it */
name|WREG32
argument_list|(
name|R_0000F8_CONFIG_MEMSIZE
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
argument_list|)
expr_stmt|;
comment|/* Program MC, should be a 32bits limited address space */
name|WREG32_MC
argument_list|(
name|R_000001_MC_FB_LOCATION
argument_list|,
name|S_000001_MC_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
operator||
name|S_000001_MC_FB_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000134_HDP_FB_LOCATION
argument_list|,
name|S_000134_HDP_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|WREG32_MC
argument_list|(
name|R_000002_MC_AGP_LOCATION
argument_list|,
name|S_000002_MC_AGP_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|16
argument_list|)
operator||
name|S_000002_MC_AGP_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000003_MC_AGP_BASE
argument_list|,
name|lower_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|agp_base
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000004_MC_AGP_BASE_2
argument_list|,
name|S_000004_AGP_BASE_ADDR_2
argument_list|(
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|agp_base
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32_MC
argument_list|(
name|R_000002_MC_AGP_LOCATION
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000003_MC_AGP_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|R_000004_MC_AGP_BASE_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|rv515_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rv515_clock_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|radeon_dynclks
operator|!=
operator|-
literal|1
operator|&&
name|radeon_dynclks
condition|)
name|radeon_atom_set_clock_gating
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* We need to force on some of the block */
name|WREG32_PLL
argument_list|(
name|R_00000F_CP_DYN_CNTL
argument_list|,
name|RREG32_PLL
argument_list|(
name|R_00000F_CP_DYN_CNTL
argument_list|)
operator||
name|S_00000F_CP_FORCEON
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|R_000011_E2_DYN_CNTL
argument_list|,
name|RREG32_PLL
argument_list|(
name|R_000011_E2_DYN_CNTL
argument_list|)
operator||
name|S_000011_E2_FORCEON
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|R_000013_IDCT_DYN_CNTL
argument_list|,
name|RREG32_PLL
argument_list|(
name|R_000013_IDCT_DYN_CNTL
argument_list|)
operator||
name|S_000013_IDCT_FORCEON
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rv515_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|rv515_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GPU configuration (# pipes, ...) */
name|rv515_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GART (initialize after TTM so we can allocate 	 * memory through TTM but finalize after TTM) */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
block|{
name|r
operator|=
name|rv370_pcie_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|rs600_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|hdp_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
comment|/* 1M ring buffer */
name|r
operator|=
name|r100_cp_init
argument_list|(
name|rdev
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rv515_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Make sur GART are not working */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|rv370_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock before doing reset */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* post */
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
comment|/* Resume clock after posting */
name|rv515_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|rv515_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|rv515_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r100_cp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rs600_irq_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|rv370_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|rv515_set_safe_registers
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|reg_safe_bm
operator|=
name|rv515_reg_safe_bm
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r300
operator|.
name|reg_safe_bm_size
operator|=
name|DRM_ARRAY_SIZE
argument_list|(
name|rv515_reg_safe_bm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rv515_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv370_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_agp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rv515_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Initialize scratch registers */
name|radeon_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* TODO: disable VGA need to use VGA request */
comment|/* restore some register to sane defaults */
name|r100_restore_sanity
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* BIOS*/
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|r
operator|=
name|radeon_atombios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
else|else
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting atombios for RV515 GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* check if cards are posted or not */
if|if
condition|(
name|radeon_boot_test_post_card
argument_list|(
name|rdev
argument_list|)
operator|==
name|false
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* initialize AGP */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|r
operator|=
name|radeon_agp_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_agp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* initialize memory controller */
name|rv515_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv515_debugfs
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|rv370_pcie_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rv515_set_safe_registers
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|rv515_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
comment|/* Somethings want wront with the accel init stop accel */
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv370_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_agp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|atom_rv515_force_tv_scaler
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|int
name|index_reg
init|=
literal|0x6578
operator|+
name|crtc
operator|->
name|crtc_offset
decl_stmt|;
name|int
name|data_reg
init|=
literal|0x657c
operator|+
name|crtc
operator|->
name|crtc_offset
decl_stmt|;
name|WREG32
argument_list|(
literal|0x659C
operator|+
name|crtc
operator|->
name|crtc_offset
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x6594
operator|+
name|crtc
operator|->
name|crtc_offset
argument_list|,
literal|0x705
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x65A4
operator|+
name|crtc
operator|->
name|crtc_offset
argument_list|,
literal|0x10001
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x65D8
operator|+
name|crtc
operator|->
name|crtc_offset
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x65B0
operator|+
name|crtc
operator|->
name|crtc_offset
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x65C0
operator|+
name|crtc
operator|->
name|crtc_offset
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x65D4
operator|+
name|crtc
operator|->
name|crtc_offset
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x841880A8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x84208680
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFF880B0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x83D88088
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x84608680
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x102
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFF080D0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x83988068
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x201
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x84A08680
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x202
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFF080F8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x300
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x83588058
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x301
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x84E08660
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x302
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFF88120
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x83188040
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x401
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x85008660
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x402
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFF88150
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x82D88030
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x501
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x85408640
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x502
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFF88180
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x600
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x82A08018
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x601
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x85808620
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x602
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFF081B8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x700
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x82608010
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x701
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x85A08600
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x702
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x800081F0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x800
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8228BFF8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x801
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x85E085E0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x802
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFF88228
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x82A8BF00
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10001
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x82A08CC0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10002
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8008BEF8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10100
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x81F0BF28
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10101
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x83608CA0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10102
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8018BED0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10200
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8148BF38
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10201
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x84408C80
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10202
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8008BEB8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10300
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80B0BF78
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10301
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x85008C20
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10302
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8020BEA0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10400
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8028BF90
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10401
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x85E08BC0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10402
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8018BE90
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFB8BFB0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10501
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x86C08B40
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10502
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8010BE90
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10600
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBF58BFC8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10601
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x87A08AA0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10602
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8010BE98
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10700
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBF10BFF0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10701
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x886089E0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10702
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8018BEB0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10800
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBED8BFE8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10801
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x89408940
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x10802
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFE8BED8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20001
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x90008000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20002
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20003
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20100
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80108000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20101
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8FE0BF70
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20102
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFE880C0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20103
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20200
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8018BFF8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20201
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8F80BF08
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20202
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFD081A0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20203
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFF88000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20300
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80188000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20301
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8EE0BEC0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20302
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFB082A0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20303
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20400
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80188000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20401
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8E00BEA0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20402
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBF8883C0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20403
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80188000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20501
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8D00BE90
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20502
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBF588500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20503
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008008
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20600
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80188000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20601
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8BC0BE98
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20602
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBF308660
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20603
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008008
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20700
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80108000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20701
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8A80BEB0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20702
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBF0087C0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20703
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008008
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20800
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80108000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20801
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8920BED0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20802
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBED08920
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x20803
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008010
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x90008000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30001
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x80008000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30100
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8FE0BF90
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30101
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFF880A0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30200
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8F60BF40
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30201
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFE88180
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30300
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8EC0BF00
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30301
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFC88280
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30400
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8DE0BEE0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30401
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBFA083A0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8CE0BED0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30501
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBF7884E0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30600
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8BA0BED8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30601
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBF508640
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30700
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8A60BEE8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30701
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBF2087A0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30800
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0x8900BF00
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|index_reg
argument_list|,
literal|0x30801
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|data_reg
argument_list|,
literal|0xBF008900
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|rv515_watermark
block|{
name|u32
name|lb_request_fifo_depth
decl_stmt|;
name|fixed20_12
name|num_line_pair
decl_stmt|;
name|fixed20_12
name|estimated_width
decl_stmt|;
name|fixed20_12
name|worst_case_latency
decl_stmt|;
name|fixed20_12
name|consumption_rate
decl_stmt|;
name|fixed20_12
name|active_time
decl_stmt|;
name|fixed20_12
name|dbpp
decl_stmt|;
name|fixed20_12
name|priority_mark_max
decl_stmt|;
name|fixed20_12
name|priority_mark
decl_stmt|;
name|fixed20_12
name|sclk
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|rv515_crtc_bandwidth_compute
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|rv515_watermark
modifier|*
name|wm
parameter_list|)
block|{
name|struct
name|drm_display_mode
modifier|*
name|mode
init|=
operator|&
name|crtc
operator|->
name|base
operator|.
name|mode
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
name|fixed20_12
name|pclk
decl_stmt|,
name|request_fifo_depth
decl_stmt|,
name|tolerable_latency
decl_stmt|,
name|estimated_width
decl_stmt|;
name|fixed20_12
name|consumption_time
decl_stmt|,
name|line_time
decl_stmt|,
name|chunk_time
decl_stmt|,
name|read_delay_latency
decl_stmt|;
if|if
condition|(
operator|!
name|crtc
operator|->
name|base
operator|.
name|enabled
condition|)
block|{
comment|/* FIXME: wouldn't it better to set priority mark to maximum */
name|wm
operator|->
name|lb_request_fifo_depth
operator|=
literal|4
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|crtc
operator|->
name|vsc
operator|.
name|full
operator|>
name|dfixed_const
argument_list|(
literal|2
argument_list|)
condition|)
name|wm
operator|->
name|num_line_pair
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
argument_list|)
expr_stmt|;
else|else
name|wm
operator|->
name|num_line_pair
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mode
operator|->
name|crtc_hdisplay
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|256
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|request_fifo_depth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|wm
operator|->
name|num_line_pair
argument_list|)
expr_stmt|;
name|request_fifo_depth
operator|.
name|full
operator|=
name|dfixed_ceil
argument_list|(
name|request_fifo_depth
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|.
name|full
operator|<
name|dfixed_const
argument_list|(
literal|4
argument_list|)
condition|)
block|{
name|wm
operator|->
name|lb_request_fifo_depth
operator|=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|wm
operator|->
name|lb_request_fifo_depth
operator|=
name|dfixed_trunc
argument_list|(
name|request_fifo_depth
argument_list|)
expr_stmt|;
block|}
comment|/* Determine consumption rate 	 *  pclk = pixel clock period(ns) = 1000 / (mode.clock / 1000) 	 *  vtaps = number of vertical taps, 	 *  vsc = vertical scaling ratio, defined as source/destination 	 *  hsc = horizontal scaling ration, defined as source/destination 	 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mode
operator|->
name|clock
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|pclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|crtc
operator|->
name|rmx_type
operator|!=
name|RMX_OFF
condition|)
block|{
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|crtc
operator|->
name|vsc
operator|.
name|full
operator|>
name|b
operator|.
name|full
condition|)
name|b
operator|.
name|full
operator|=
name|crtc
operator|->
name|vsc
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|crtc
operator|->
name|hsc
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|consumption_time
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|pclk
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|consumption_time
operator|.
name|full
operator|=
name|pclk
operator|.
name|full
expr_stmt|;
block|}
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|wm
operator|->
name|consumption_rate
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|consumption_time
argument_list|)
expr_stmt|;
comment|/* Determine line time 	 *  LineTime = total time for one line of displayhtotal 	 *  LineTime = total number of horizontal pixels 	 *  pclk = pixel clock period(ns) 	 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|crtc
operator|->
name|base
operator|.
name|mode
operator|.
name|crtc_htotal
argument_list|)
expr_stmt|;
name|line_time
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|pclk
argument_list|)
expr_stmt|;
comment|/* Determine active time 	 *  ActiveTime = time of active region of display within one line, 	 *  hactive = total number of horizontal active pixels 	 *  htotal = total number of horizontal pixels 	 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|crtc
operator|->
name|base
operator|.
name|mode
operator|.
name|crtc_htotal
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|crtc
operator|->
name|base
operator|.
name|mode
operator|.
name|crtc_hdisplay
argument_list|)
expr_stmt|;
name|wm
operator|->
name|active_time
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|line_time
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|wm
operator|->
name|active_time
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm
operator|->
name|active_time
argument_list|,
name|a
argument_list|)
expr_stmt|;
comment|/* Determine chunk time 	 * ChunkTime = the time it takes the DCP to send one chunk of data 	 * to the LB which consists of pipeline delay and inter chunk gap 	 * sclk = system clock(Mhz) 	 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|600
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|chunk_time
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|rdev
operator|->
name|pm
operator|.
name|sclk
argument_list|)
expr_stmt|;
name|read_delay_latency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* Determine the worst case latency 	 * NumLinePair = Number of line pairs to request(1=2 lines, 2=4 lines) 	 * WorstCaseLatency = worst case time from urgent to when the MC starts 	 *                    to return data 	 * READ_DELAY_IDLE_MAX = constant of 1us 	 * ChunkTime = time it takes the DCP to send one chunk of data to the LB 	 *             which consists of pipeline delay and inter chunk gap 	 */
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|wm
operator|->
name|num_line_pair
argument_list|)
operator|>
literal|1
condition|)
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|wm
operator|->
name|worst_case_latency
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|chunk_time
argument_list|)
expr_stmt|;
name|wm
operator|->
name|worst_case_latency
operator|.
name|full
operator|+=
name|read_delay_latency
operator|.
name|full
expr_stmt|;
block|}
else|else
block|{
name|wm
operator|->
name|worst_case_latency
operator|.
name|full
operator|=
name|chunk_time
operator|.
name|full
operator|+
name|read_delay_latency
operator|.
name|full
expr_stmt|;
block|}
comment|/* Determine the tolerable latency 	 * TolerableLatency = Any given request has only 1 line time 	 *                    for the data to be returned 	 * LBRequestFifoDepth = Number of chunk requests the LB can 	 *                      put into the request FIFO for a display 	 *  LineTime = total time for one line of display 	 *  ChunkTime = the time it takes the DCP to send one chunk 	 *              of data to the LB which consists of 	 *  pipeline delay and inter chunk gap 	 */
if|if
condition|(
operator|(
literal|2
operator|+
name|wm
operator|->
name|lb_request_fifo_depth
operator|)
operator|>=
name|dfixed_trunc
argument_list|(
name|request_fifo_depth
argument_list|)
condition|)
block|{
name|tolerable_latency
operator|.
name|full
operator|=
name|line_time
operator|.
name|full
expr_stmt|;
block|}
else|else
block|{
name|tolerable_latency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|lb_request_fifo_depth
operator|-
literal|2
argument_list|)
expr_stmt|;
name|tolerable_latency
operator|.
name|full
operator|=
name|request_fifo_depth
operator|.
name|full
operator|-
name|tolerable_latency
operator|.
name|full
expr_stmt|;
name|tolerable_latency
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|tolerable_latency
argument_list|,
name|chunk_time
argument_list|)
expr_stmt|;
name|tolerable_latency
operator|.
name|full
operator|=
name|line_time
operator|.
name|full
operator|-
name|tolerable_latency
operator|.
name|full
expr_stmt|;
block|}
comment|/* We assume worst case 32bits (4 bytes) */
name|wm
operator|->
name|dbpp
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
operator|*
literal|16
argument_list|)
expr_stmt|;
comment|/* Determine the maximum priority mark 	 *  width = viewport width in pixels 	 */
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark_max
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|crtc
operator|->
name|base
operator|.
name|mode
operator|.
name|crtc_hdisplay
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark_max
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm
operator|->
name|priority_mark_max
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark_max
operator|.
name|full
operator|=
name|dfixed_ceil
argument_list|(
name|wm
operator|->
name|priority_mark_max
argument_list|)
expr_stmt|;
comment|/* Determine estimated width */
name|estimated_width
operator|.
name|full
operator|=
name|tolerable_latency
operator|.
name|full
operator|-
name|wm
operator|->
name|worst_case_latency
operator|.
name|full
expr_stmt|;
name|estimated_width
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|estimated_width
argument_list|,
name|consumption_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|estimated_width
argument_list|)
operator|>
name|crtc
operator|->
name|base
operator|.
name|mode
operator|.
name|crtc_hdisplay
condition|)
block|{
name|wm
operator|->
name|priority_mark
operator|.
name|full
operator|=
name|wm
operator|->
name|priority_mark_max
operator|.
name|full
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|estimated_width
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark
operator|.
name|full
operator|=
name|dfixed_ceil
argument_list|(
name|wm
operator|->
name|priority_mark
argument_list|)
expr_stmt|;
name|wm
operator|->
name|priority_mark
operator|.
name|full
operator|=
name|wm
operator|->
name|priority_mark_max
operator|.
name|full
operator|-
name|wm
operator|->
name|priority_mark
operator|.
name|full
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|rv515_bandwidth_avivo_update
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_display_mode
modifier|*
name|mode0
init|=
name|NULL
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|mode1
init|=
name|NULL
decl_stmt|;
name|struct
name|rv515_watermark
name|wm0
decl_stmt|;
name|struct
name|rv515_watermark
name|wm1
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|u32
name|d1mode_priority_a_cnt
init|=
name|MODE_PRIORITY_OFF
decl_stmt|;
name|u32
name|d2mode_priority_a_cnt
init|=
name|MODE_PRIORITY_OFF
decl_stmt|;
name|fixed20_12
name|priority_mark02
decl_stmt|,
name|priority_mark12
decl_stmt|,
name|fill_rate
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|,
name|b
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
name|mode0
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
name|mode1
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
name|rs690_line_buffer_adjust
argument_list|(
name|rdev
argument_list|,
name|mode0
argument_list|,
name|mode1
argument_list|)
expr_stmt|;
name|rv515_crtc_bandwidth_compute
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
argument_list|,
operator|&
name|wm0
argument_list|)
expr_stmt|;
name|rv515_crtc_bandwidth_compute
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
argument_list|,
operator|&
name|wm1
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|wm0
operator|.
name|lb_request_fifo_depth
expr_stmt|;
name|tmp
operator||=
name|wm1
operator|.
name|lb_request_fifo_depth
operator|<<
literal|16
expr_stmt|;
name|WREG32
argument_list|(
name|LB_MAX_REQ_OUTSTANDING
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode0
operator|&&
name|mode1
condition|)
block|{
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|wm0
operator|.
name|dbpp
argument_list|)
operator|>
literal|64
condition|)
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm0
operator|.
name|dbpp
argument_list|,
name|wm0
operator|.
name|num_line_pair
argument_list|)
expr_stmt|;
else|else
name|a
operator|.
name|full
operator|=
name|wm0
operator|.
name|num_line_pair
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|wm1
operator|.
name|dbpp
argument_list|)
operator|>
literal|64
condition|)
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm1
operator|.
name|dbpp
argument_list|,
name|wm1
operator|.
name|num_line_pair
argument_list|)
expr_stmt|;
else|else
name|b
operator|.
name|full
operator|=
name|wm1
operator|.
name|num_line_pair
operator|.
name|full
expr_stmt|;
name|a
operator|.
name|full
operator|+=
name|b
operator|.
name|full
expr_stmt|;
name|fill_rate
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm0
operator|.
name|sclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|wm0
operator|.
name|consumption_rate
operator|.
name|full
operator|>
name|fill_rate
operator|.
name|full
condition|)
block|{
name|b
operator|.
name|full
operator|=
name|wm0
operator|.
name|consumption_rate
operator|.
name|full
operator|-
name|fill_rate
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|wm0
operator|.
name|active_time
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm0
operator|.
name|worst_case_latency
argument_list|,
name|wm0
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|priority_mark02
operator|.
name|full
operator|=
name|a
operator|.
name|full
operator|+
name|b
operator|.
name|full
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm0
operator|.
name|worst_case_latency
argument_list|,
name|wm0
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark02
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wm1
operator|.
name|consumption_rate
operator|.
name|full
operator|>
name|fill_rate
operator|.
name|full
condition|)
block|{
name|b
operator|.
name|full
operator|=
name|wm1
operator|.
name|consumption_rate
operator|.
name|full
operator|-
name|fill_rate
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|wm1
operator|.
name|active_time
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm1
operator|.
name|worst_case_latency
argument_list|,
name|wm1
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|priority_mark12
operator|.
name|full
operator|=
name|a
operator|.
name|full
operator|+
name|b
operator|.
name|full
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm1
operator|.
name|worst_case_latency
argument_list|,
name|wm1
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark12
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wm0
operator|.
name|priority_mark
operator|.
name|full
operator|>
name|priority_mark02
operator|.
name|full
condition|)
name|priority_mark02
operator|.
name|full
operator|=
name|wm0
operator|.
name|priority_mark
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|wm0
operator|.
name|priority_mark_max
operator|.
name|full
operator|>
name|priority_mark02
operator|.
name|full
condition|)
name|priority_mark02
operator|.
name|full
operator|=
name|wm0
operator|.
name|priority_mark_max
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|wm1
operator|.
name|priority_mark
operator|.
name|full
operator|>
name|priority_mark12
operator|.
name|full
condition|)
name|priority_mark12
operator|.
name|full
operator|=
name|wm1
operator|.
name|priority_mark
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|wm1
operator|.
name|priority_mark_max
operator|.
name|full
operator|>
name|priority_mark12
operator|.
name|full
condition|)
name|priority_mark12
operator|.
name|full
operator|=
name|wm1
operator|.
name|priority_mark_max
operator|.
name|full
expr_stmt|;
name|d1mode_priority_a_cnt
operator|=
name|dfixed_trunc
argument_list|(
name|priority_mark02
argument_list|)
expr_stmt|;
name|d2mode_priority_a_cnt
operator|=
name|dfixed_trunc
argument_list|(
name|priority_mark12
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
condition|)
block|{
name|d1mode_priority_a_cnt
operator||=
name|MODE_PRIORITY_ALWAYS_ON
expr_stmt|;
name|d2mode_priority_a_cnt
operator||=
name|MODE_PRIORITY_ALWAYS_ON
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|mode0
condition|)
block|{
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|wm0
operator|.
name|dbpp
argument_list|)
operator|>
literal|64
condition|)
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm0
operator|.
name|dbpp
argument_list|,
name|wm0
operator|.
name|num_line_pair
argument_list|)
expr_stmt|;
else|else
name|a
operator|.
name|full
operator|=
name|wm0
operator|.
name|num_line_pair
operator|.
name|full
expr_stmt|;
name|fill_rate
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm0
operator|.
name|sclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|wm0
operator|.
name|consumption_rate
operator|.
name|full
operator|>
name|fill_rate
operator|.
name|full
condition|)
block|{
name|b
operator|.
name|full
operator|=
name|wm0
operator|.
name|consumption_rate
operator|.
name|full
operator|-
name|fill_rate
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|wm0
operator|.
name|active_time
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm0
operator|.
name|worst_case_latency
argument_list|,
name|wm0
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|priority_mark02
operator|.
name|full
operator|=
name|a
operator|.
name|full
operator|+
name|b
operator|.
name|full
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm0
operator|.
name|worst_case_latency
argument_list|,
name|wm0
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|priority_mark02
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wm0
operator|.
name|priority_mark
operator|.
name|full
operator|>
name|priority_mark02
operator|.
name|full
condition|)
name|priority_mark02
operator|.
name|full
operator|=
name|wm0
operator|.
name|priority_mark
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|wm0
operator|.
name|priority_mark_max
operator|.
name|full
operator|>
name|priority_mark02
operator|.
name|full
condition|)
name|priority_mark02
operator|.
name|full
operator|=
name|wm0
operator|.
name|priority_mark_max
operator|.
name|full
expr_stmt|;
name|d1mode_priority_a_cnt
operator|=
name|dfixed_trunc
argument_list|(
name|priority_mark02
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
condition|)
name|d1mode_priority_a_cnt
operator||=
name|MODE_PRIORITY_ALWAYS_ON
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode1
condition|)
block|{
if|if
condition|(
name|dfixed_trunc
argument_list|(
name|wm1
operator|.
name|dbpp
argument_list|)
operator|>
literal|64
condition|)
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm1
operator|.
name|dbpp
argument_list|,
name|wm1
operator|.
name|num_line_pair
argument_list|)
expr_stmt|;
else|else
name|a
operator|.
name|full
operator|=
name|wm1
operator|.
name|num_line_pair
operator|.
name|full
expr_stmt|;
name|fill_rate
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|wm1
operator|.
name|sclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|wm1
operator|.
name|consumption_rate
operator|.
name|full
operator|>
name|fill_rate
operator|.
name|full
condition|)
block|{
name|b
operator|.
name|full
operator|=
name|wm1
operator|.
name|consumption_rate
operator|.
name|full
operator|-
name|fill_rate
operator|.
name|full
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|wm1
operator|.
name|active_time
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm1
operator|.
name|worst_case_latency
argument_list|,
name|wm1
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|priority_mark12
operator|.
name|full
operator|=
name|a
operator|.
name|full
operator|+
name|b
operator|.
name|full
expr_stmt|;
block|}
else|else
block|{
name|a
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|wm1
operator|.
name|worst_case_latency
argument_list|,
name|wm1
operator|.
name|consumption_rate
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|priority_mark12
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wm1
operator|.
name|priority_mark
operator|.
name|full
operator|>
name|priority_mark12
operator|.
name|full
condition|)
name|priority_mark12
operator|.
name|full
operator|=
name|wm1
operator|.
name|priority_mark
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|wm1
operator|.
name|priority_mark_max
operator|.
name|full
operator|>
name|priority_mark12
operator|.
name|full
condition|)
name|priority_mark12
operator|.
name|full
operator|=
name|wm1
operator|.
name|priority_mark_max
operator|.
name|full
expr_stmt|;
name|d2mode_priority_a_cnt
operator|=
name|dfixed_trunc
argument_list|(
name|priority_mark12
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
condition|)
name|d2mode_priority_a_cnt
operator||=
name|MODE_PRIORITY_ALWAYS_ON
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|D1MODE_PRIORITY_A_CNT
argument_list|,
name|d1mode_priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|D1MODE_PRIORITY_B_CNT
argument_list|,
name|d1mode_priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|D2MODE_PRIORITY_A_CNT
argument_list|,
name|d2mode_priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|D2MODE_PRIORITY_B_CNT
argument_list|,
name|d2mode_priority_a_cnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rv515_bandwidth_update
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|mode0
init|=
name|NULL
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|mode1
init|=
name|NULL
decl_stmt|;
name|radeon_update_display_priority
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
name|mode0
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
name|mode1
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
comment|/* 	 * Set display0/1 priority up in the memory controller for 	 * modes if the user specifies HIGH for displaypriority 	 * option. 	 */
if|if
condition|(
operator|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV515
operator|)
condition|)
block|{
name|tmp
operator|=
name|RREG32_MC
argument_list|(
name|MC_MISC_LAT_TIMER
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|MC_DISP1R_INIT_LAT_MASK
expr_stmt|;
name|tmp
operator|&=
operator|~
name|MC_DISP0R_INIT_LAT_MASK
expr_stmt|;
if|if
condition|(
name|mode1
condition|)
name|tmp
operator||=
operator|(
literal|1
operator|<<
name|MC_DISP1R_INIT_LAT_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|mode0
condition|)
name|tmp
operator||=
operator|(
literal|1
operator|<<
name|MC_DISP0R_INIT_LAT_SHIFT
operator|)
expr_stmt|;
name|WREG32_MC
argument_list|(
name|MC_MISC_LAT_TIMER
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|rv515_bandwidth_avivo_update
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


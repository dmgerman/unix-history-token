begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2007-8 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc_helper.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_edid.h>
end_include

begin_function
specifier|static
name|void
name|avivo_crtc_load_lut
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"%d\n"
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_LUTA_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_LUTA_BLACK_OFFSET_BLUE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_LUTA_BLACK_OFFSET_GREEN
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_LUTA_BLACK_OFFSET_RED
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_LUTA_WHITE_OFFSET_BLUE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_LUTA_WHITE_OFFSET_GREEN
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_LUTA_WHITE_OFFSET_RED
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_LUT_RW_SELECT
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_LUT_RW_MODE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_DC_LUT_WRITE_EN_MASK
argument_list|,
literal|0x0000003f
argument_list|)
expr_stmt|;
name|WREG8
argument_list|(
name|AVIVO_DC_LUT_RW_INDEX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|AVIVO_DC_LUT_30_COLOR
argument_list|,
operator|(
name|radeon_crtc
operator|->
name|lut_r
index|[
name|i
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|radeon_crtc
operator|->
name|lut_g
index|[
name|i
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|radeon_crtc
operator|->
name|lut_b
index|[
name|i
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|AVIVO_D1GRPH_LUT_SEL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dce4_crtc_load_lut
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"%d\n"
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_BLACK_OFFSET_BLUE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_BLACK_OFFSET_GREEN
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_BLACK_OFFSET_RED
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_WHITE_OFFSET_BLUE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_WHITE_OFFSET_GREEN
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_WHITE_OFFSET_RED
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_RW_MODE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_WRITE_EN_MASK
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_RW_INDEX
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_30_COLOR
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|radeon_crtc
operator|->
name|lut_r
index|[
name|i
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|radeon_crtc
operator|->
name|lut_g
index|[
name|i
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|radeon_crtc
operator|->
name|lut_b
index|[
name|i
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dce5_crtc_load_lut
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"%d\n"
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|NI_INPUT_CSC_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|NI_INPUT_CSC_GRPH_MODE
argument_list|(
name|NI_INPUT_CSC_BYPASS
argument_list|)
operator||
name|NI_INPUT_CSC_OVL_MODE
argument_list|(
name|NI_INPUT_CSC_BYPASS
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|NI_PRESCALE_GRPH_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|NI_GRPH_PRESCALE_BYPASS
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|NI_PRESCALE_OVL_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|NI_OVL_PRESCALE_BYPASS
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|NI_INPUT_GAMMA_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|NI_GRPH_INPUT_GAMMA_MODE
argument_list|(
name|NI_INPUT_GAMMA_USE_LUT
argument_list|)
operator||
name|NI_OVL_INPUT_GAMMA_MODE
argument_list|(
name|NI_INPUT_GAMMA_USE_LUT
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_BLACK_OFFSET_BLUE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_BLACK_OFFSET_GREEN
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_BLACK_OFFSET_RED
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_WHITE_OFFSET_BLUE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_WHITE_OFFSET_GREEN
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_WHITE_OFFSET_RED
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_RW_MODE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_WRITE_EN_MASK
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_RW_INDEX
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|EVERGREEN_DC_LUT_30_COLOR
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|radeon_crtc
operator|->
name|lut_r
index|[
name|i
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|radeon_crtc
operator|->
name|lut_g
index|[
name|i
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|radeon_crtc
operator|->
name|lut_b
index|[
name|i
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|NI_DEGAMMA_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|NI_GRPH_DEGAMMA_MODE
argument_list|(
name|NI_DEGAMMA_BYPASS
argument_list|)
operator||
name|NI_OVL_DEGAMMA_MODE
argument_list|(
name|NI_DEGAMMA_BYPASS
argument_list|)
operator||
name|NI_ICON_DEGAMMA_MODE
argument_list|(
name|NI_DEGAMMA_BYPASS
argument_list|)
operator||
name|NI_CURSOR_DEGAMMA_MODE
argument_list|(
name|NI_DEGAMMA_BYPASS
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|NI_GAMUT_REMAP_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|NI_GRPH_GAMUT_REMAP_MODE
argument_list|(
name|NI_GAMUT_REMAP_BYPASS
argument_list|)
operator||
name|NI_OVL_GAMUT_REMAP_MODE
argument_list|(
name|NI_GAMUT_REMAP_BYPASS
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|NI_REGAMMA_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|NI_GRPH_REGAMMA_MODE
argument_list|(
name|NI_REGAMMA_BYPASS
argument_list|)
operator||
name|NI_OVL_REGAMMA_MODE
argument_list|(
name|NI_REGAMMA_BYPASS
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|NI_OUTPUT_CSC_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|NI_OUTPUT_CSC_GRPH_MODE
argument_list|(
name|NI_OUTPUT_CSC_BYPASS
argument_list|)
operator||
name|NI_OUTPUT_CSC_OVL_MODE
argument_list|(
name|NI_OUTPUT_CSC_BYPASS
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* XXX match this to the depth of the crtc fmt block, move to modeset? */
name|WREG32
argument_list|(
literal|0x6940
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|legacy_crtc_load_lut
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|dac2_cntl
decl_stmt|;
name|dac2_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|0
condition|)
name|dac2_cntl
operator|&=
operator|(
name|uint32_t
operator|)
operator|~
name|RADEON_DAC2_PALETTE_ACC_CTL
expr_stmt|;
else|else
name|dac2_cntl
operator||=
name|RADEON_DAC2_PALETTE_ACC_CTL
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|dac2_cntl
argument_list|)
expr_stmt|;
name|WREG8
argument_list|(
name|RADEON_PALETTE_INDEX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RADEON_PALETTE_30_DATA
argument_list|,
operator|(
name|radeon_crtc
operator|->
name|lut_r
index|[
name|i
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|radeon_crtc
operator|->
name|lut_g
index|[
name|i
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|radeon_crtc
operator|->
name|lut_b
index|[
name|i
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|radeon_crtc_load_lut
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
operator|!
name|crtc
operator|->
name|enabled
condition|)
return|return;
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
condition|)
name|dce5_crtc_load_lut
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
name|dce4_crtc_load_lut
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
name|avivo_crtc_load_lut
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
else|else
name|legacy_crtc_load_lut
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** Sets the color ramps on behalf of fbcon */
end_comment

begin_function
name|void
name|radeon_crtc_fb_gamma_set
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|u16
name|red
parameter_list|,
name|u16
name|green
parameter_list|,
name|u16
name|blue
parameter_list|,
name|int
name|regno
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|radeon_crtc
operator|->
name|lut_r
index|[
name|regno
index|]
operator|=
name|red
operator|>>
literal|6
expr_stmt|;
name|radeon_crtc
operator|->
name|lut_g
index|[
name|regno
index|]
operator|=
name|green
operator|>>
literal|6
expr_stmt|;
name|radeon_crtc
operator|->
name|lut_b
index|[
name|regno
index|]
operator|=
name|blue
operator|>>
literal|6
expr_stmt|;
block|}
end_function

begin_comment
comment|/** Gets the color ramps on behalf of fbcon */
end_comment

begin_function
name|void
name|radeon_crtc_fb_gamma_get
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|u16
modifier|*
name|red
parameter_list|,
name|u16
modifier|*
name|green
parameter_list|,
name|u16
modifier|*
name|blue
parameter_list|,
name|int
name|regno
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
operator|*
name|red
operator|=
name|radeon_crtc
operator|->
name|lut_r
index|[
name|regno
index|]
operator|<<
literal|6
expr_stmt|;
operator|*
name|green
operator|=
name|radeon_crtc
operator|->
name|lut_g
index|[
name|regno
index|]
operator|<<
literal|6
expr_stmt|;
operator|*
name|blue
operator|=
name|radeon_crtc
operator|->
name|lut_b
index|[
name|regno
index|]
operator|<<
literal|6
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_crtc_gamma_set
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|u16
modifier|*
name|red
parameter_list|,
name|u16
modifier|*
name|green
parameter_list|,
name|u16
modifier|*
name|blue
parameter_list|,
name|uint32_t
name|start
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|int
name|end
init|=
operator|(
name|start
operator|+
name|size
operator|>
literal|256
operator|)
condition|?
literal|256
else|:
name|start
operator|+
name|size
decl_stmt|,
name|i
decl_stmt|;
comment|/* userspace palettes are always correct as is */
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<
name|end
condition|;
name|i
operator|++
control|)
block|{
name|radeon_crtc
operator|->
name|lut_r
index|[
name|i
index|]
operator|=
name|red
index|[
name|i
index|]
operator|>>
literal|6
expr_stmt|;
name|radeon_crtc
operator|->
name|lut_g
index|[
name|i
index|]
operator|=
name|green
index|[
name|i
index|]
operator|>>
literal|6
expr_stmt|;
name|radeon_crtc
operator|->
name|lut_b
index|[
name|i
index|]
operator|=
name|blue
index|[
name|i
index|]
operator|>>
literal|6
expr_stmt|;
block|}
name|radeon_crtc_load_lut
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_crtc_destroy
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|drm_crtc_cleanup
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|radeon_crtc
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Handle unpin events outside the interrupt handler proper.  */
end_comment

begin_function
specifier|static
name|void
name|radeon_unpin_work_func
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|radeon_unpin_work
modifier|*
name|work
init|=
name|arg
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* unpin of the old buffer */
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|work
operator|->
name|old_rbo
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
name|r
operator|==
literal|0
argument_list|)
condition|)
block|{
name|r
operator|=
name|radeon_bo_unpin
argument_list|(
name|work
operator|->
name|old_rbo
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to unpin buffer after flip\n"
argument_list|)
expr_stmt|;
block|}
name|radeon_bo_unreserve
argument_list|(
name|work
operator|->
name|old_rbo
argument_list|)
expr_stmt|;
block|}
else|else
name|DRM_ERROR
argument_list|(
literal|"failed to reserve buffer after flip\n"
argument_list|)
expr_stmt|;
name|drm_gem_object_unreference_unlocked
argument_list|(
operator|&
name|work
operator|->
name|old_rbo
operator|->
name|gem_base
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|work
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_crtc_handle_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc_id
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|crtc_id
index|]
decl_stmt|;
name|struct
name|radeon_unpin_work
modifier|*
name|work
decl_stmt|;
name|struct
name|drm_pending_vblank_event
modifier|*
name|e
decl_stmt|;
name|struct
name|timeval
name|now
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|u32
name|update_pending
decl_stmt|;
name|int
name|vpos
decl_stmt|,
name|hpos
decl_stmt|;
name|DRM_SPINLOCK_IRQSAVE
argument_list|(
operator|&
name|rdev
operator|->
name|ddev
operator|->
name|event_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|work
operator|=
name|radeon_crtc
operator|->
name|unpin_work
expr_stmt|;
if|if
condition|(
name|work
operator|==
name|NULL
operator|||
operator|(
name|work
operator|->
name|fence
operator|&&
operator|!
name|radeon_fence_signaled
argument_list|(
name|work
operator|->
name|fence
argument_list|)
operator|)
condition|)
block|{
name|DRM_SPINUNLOCK_IRQRESTORE
argument_list|(
operator|&
name|rdev
operator|->
name|ddev
operator|->
name|event_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* New pageflip, or just completion of a previous one? */
if|if
condition|(
operator|!
name|radeon_crtc
operator|->
name|deferred_flip_completion
condition|)
block|{
comment|/* do the flip (mmio) */
name|update_pending
operator|=
name|radeon_page_flip
argument_list|(
name|rdev
argument_list|,
name|crtc_id
argument_list|,
name|work
operator|->
name|new_crtc_base
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* This is just a completion of a flip queued in crtc 		 * at last invocation. Make sure we go directly to 		 * completion routine. 		 */
name|update_pending
operator|=
literal|0
expr_stmt|;
name|radeon_crtc
operator|->
name|deferred_flip_completion
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Has the pageflip already completed in crtc, or is it certain 	 * to complete in this vblank? 	 */
if|if
condition|(
name|update_pending
operator|&&
operator|(
name|DRM_SCANOUTPOS_VALID
operator|&
name|radeon_get_crtc_scanoutpos
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
name|crtc_id
argument_list|,
operator|&
name|vpos
argument_list|,
operator|&
name|hpos
argument_list|)
operator|)
operator|&&
operator|(
operator|(
name|vpos
operator|>=
operator|(
literal|99
operator|*
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|crtc_id
index|]
operator|->
name|base
operator|.
name|hwmode
operator|.
name|crtc_vdisplay
operator|)
operator|/
literal|100
operator|)
operator|||
operator|(
name|vpos
operator|<
literal|0
operator|&&
operator|!
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
operator|)
operator|)
condition|)
block|{
comment|/* crtc didn't flip in this target vblank interval, 		 * but flip is pending in crtc. Based on the current 		 * scanout position we know that the current frame is 		 * (nearly) complete and the flip will (likely) 		 * complete before the start of the next frame. 		 */
name|update_pending
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|update_pending
condition|)
block|{
comment|/* crtc didn't flip in this target vblank interval, 		 * but flip is pending in crtc. It will complete it 		 * in next vblank interval, so complete the flip at 		 * next vblank irq. 		 */
name|radeon_crtc
operator|->
name|deferred_flip_completion
operator|=
literal|1
expr_stmt|;
name|DRM_SPINUNLOCK_IRQRESTORE
argument_list|(
operator|&
name|rdev
operator|->
name|ddev
operator|->
name|event_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Pageflip (will be) certainly completed in this vblank. Clean up. */
name|radeon_crtc
operator|->
name|unpin_work
operator|=
name|NULL
expr_stmt|;
comment|/* wakeup userspace */
if|if
condition|(
name|work
operator|->
name|event
condition|)
block|{
name|e
operator|=
name|work
operator|->
name|event
expr_stmt|;
name|e
operator|->
name|event
operator|.
name|sequence
operator|=
name|drm_vblank_count_and_time
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
name|crtc_id
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
name|e
operator|->
name|event
operator|.
name|tv_sec
operator|=
name|now
operator|.
name|tv_sec
expr_stmt|;
name|e
operator|->
name|event
operator|.
name|tv_usec
operator|=
name|now
operator|.
name|tv_usec
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|e
operator|->
name|base
operator|.
name|link
argument_list|,
operator|&
name|e
operator|->
name|base
operator|.
name|file_priv
operator|->
name|event_list
argument_list|)
expr_stmt|;
name|drm_event_wakeup
argument_list|(
operator|&
name|e
operator|->
name|base
argument_list|)
expr_stmt|;
block|}
name|DRM_SPINUNLOCK_IRQRESTORE
argument_list|(
operator|&
name|rdev
operator|->
name|ddev
operator|->
name|event_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|drm_vblank_put
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
name|radeon_fence_unref
argument_list|(
operator|&
name|work
operator|->
name|fence
argument_list|)
expr_stmt|;
name|radeon_post_page_flip
argument_list|(
name|work
operator|->
name|rdev
argument_list|,
name|work
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|rdev
operator|->
name|tq
argument_list|,
operator|&
name|work
operator|->
name|work
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_crtc_page_flip
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
name|struct
name|drm_framebuffer
modifier|*
name|fb
parameter_list|,
name|struct
name|drm_pending_vblank_event
modifier|*
name|event
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_framebuffer
modifier|*
name|old_radeon_fb
decl_stmt|;
name|struct
name|radeon_framebuffer
modifier|*
name|new_radeon_fb
decl_stmt|;
name|struct
name|drm_gem_object
modifier|*
name|obj
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|rbo
decl_stmt|;
name|struct
name|radeon_unpin_work
modifier|*
name|work
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|u32
name|tiling_flags
decl_stmt|,
name|pitch_pixels
decl_stmt|;
name|u64
name|base
decl_stmt|;
name|int
name|r
decl_stmt|;
name|work
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|work
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|work
operator|==
name|NULL
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|work
operator|->
name|event
operator|=
name|event
expr_stmt|;
name|work
operator|->
name|rdev
operator|=
name|rdev
expr_stmt|;
name|work
operator|->
name|crtc_id
operator|=
name|radeon_crtc
operator|->
name|crtc_id
expr_stmt|;
name|old_radeon_fb
operator|=
name|to_radeon_framebuffer
argument_list|(
name|crtc
operator|->
name|fb
argument_list|)
expr_stmt|;
name|new_radeon_fb
operator|=
name|to_radeon_framebuffer
argument_list|(
name|fb
argument_list|)
expr_stmt|;
comment|/* schedule unpin of the old buffer */
name|obj
operator|=
name|old_radeon_fb
operator|->
name|obj
expr_stmt|;
comment|/* take a reference to the old object */
name|drm_gem_object_reference
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|rbo
operator|=
name|gem_to_radeon_bo
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|work
operator|->
name|old_rbo
operator|=
name|rbo
expr_stmt|;
name|obj
operator|=
name|new_radeon_fb
operator|->
name|obj
expr_stmt|;
name|rbo
operator|=
name|gem_to_radeon_bo
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|rbo
operator|->
name|tbo
operator|.
name|bdev
operator|->
name|fence_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rbo
operator|->
name|tbo
operator|.
name|sync_obj
condition|)
name|work
operator|->
name|fence
operator|=
name|radeon_fence_ref
argument_list|(
name|rbo
operator|->
name|tbo
operator|.
name|sync_obj
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rbo
operator|->
name|tbo
operator|.
name|bdev
operator|->
name|fence_lock
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|work
operator|->
name|work
argument_list|,
literal|0
argument_list|,
name|radeon_unpin_work_func
argument_list|,
name|work
argument_list|)
expr_stmt|;
comment|/* We borrow the event spin lock for protecting unpin_work */
name|DRM_SPINLOCK_IRQSAVE
argument_list|(
operator|&
name|dev
operator|->
name|event_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|unpin_work
condition|)
block|{
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"flip queue: crtc already busy\n"
argument_list|)
expr_stmt|;
name|r
operator|=
operator|-
name|EBUSY
expr_stmt|;
goto|goto
name|unlock_free
goto|;
block|}
name|radeon_crtc
operator|->
name|unpin_work
operator|=
name|work
expr_stmt|;
name|radeon_crtc
operator|->
name|deferred_flip_completion
operator|=
literal|0
expr_stmt|;
name|DRM_SPINUNLOCK_IRQRESTORE
argument_list|(
operator|&
name|dev
operator|->
name|event_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
comment|/* pin the new buffer */
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"flip-ioctl() cur_fbo = %p, cur_bbo = %p\n"
argument_list|,
name|work
operator|->
name|old_rbo
argument_list|,
name|rbo
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rbo
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to reserve new rbo buffer before flip\n"
argument_list|)
expr_stmt|;
goto|goto
name|pflip_cleanup
goto|;
block|}
comment|/* Only 27 bit offset for legacy CRTC */
name|r
operator|=
name|radeon_bo_pin_restricted
argument_list|(
name|rbo
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|?
literal|0
else|:
literal|1
operator|<<
literal|27
argument_list|,
operator|&
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|radeon_bo_unreserve
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
name|r
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"failed to pin new rbo buffer before flip\n"
argument_list|)
expr_stmt|;
goto|goto
name|pflip_cleanup
goto|;
block|}
name|radeon_bo_get_tiling_flags
argument_list|(
name|rbo
argument_list|,
operator|&
name|tiling_flags
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
comment|/* crtc offset is from display base addr not FB location */
name|base
operator|-=
name|radeon_crtc
operator|->
name|legacy_display_base_addr
expr_stmt|;
name|pitch_pixels
operator|=
name|fb
operator|->
name|pitches
index|[
literal|0
index|]
operator|/
operator|(
name|fb
operator|->
name|bits_per_pixel
operator|/
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
block|{
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|base
operator|&=
operator|~
literal|0x7ff
expr_stmt|;
block|}
else|else
block|{
name|int
name|byteshift
init|=
name|fb
operator|->
name|bits_per_pixel
operator|>>
literal|4
decl_stmt|;
name|int
name|tile_addr
init|=
operator|(
operator|(
operator|(
name|crtc
operator|->
name|y
operator|>>
literal|3
operator|)
operator|*
name|pitch_pixels
operator|+
name|crtc
operator|->
name|x
operator|)
operator|>>
operator|(
literal|8
operator|-
name|byteshift
operator|)
operator|)
operator|<<
literal|11
decl_stmt|;
name|base
operator|+=
name|tile_addr
operator|+
operator|(
operator|(
name|crtc
operator|->
name|x
operator|<<
name|byteshift
operator|)
operator|%
literal|256
operator|)
operator|+
operator|(
operator|(
name|crtc
operator|->
name|y
operator|%
literal|8
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|int
name|offset
init|=
name|crtc
operator|->
name|y
operator|*
name|pitch_pixels
operator|+
name|crtc
operator|->
name|x
decl_stmt|;
switch|switch
condition|(
name|fb
operator|->
name|bits_per_pixel
condition|)
block|{
case|case
literal|8
case|:
default|default:
name|offset
operator|*=
literal|1
expr_stmt|;
break|break;
case|case
literal|15
case|:
case|case
literal|16
case|:
name|offset
operator|*=
literal|2
expr_stmt|;
break|break;
case|case
literal|24
case|:
name|offset
operator|*=
literal|3
expr_stmt|;
break|break;
case|case
literal|32
case|:
name|offset
operator|*=
literal|4
expr_stmt|;
break|break;
block|}
name|base
operator|+=
name|offset
expr_stmt|;
block|}
name|base
operator|&=
operator|~
literal|7
expr_stmt|;
block|}
name|DRM_SPINLOCK_IRQSAVE
argument_list|(
operator|&
name|dev
operator|->
name|event_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|work
operator|->
name|new_crtc_base
operator|=
name|base
expr_stmt|;
name|DRM_SPINUNLOCK_IRQRESTORE
argument_list|(
operator|&
name|dev
operator|->
name|event_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
comment|/* update crtc fb */
name|crtc
operator|->
name|fb
operator|=
name|fb
expr_stmt|;
name|r
operator|=
name|drm_vblank_get
argument_list|(
name|dev
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to get vblank before flip\n"
argument_list|)
expr_stmt|;
goto|goto
name|pflip_cleanup1
goto|;
block|}
comment|/* set the proper interrupt */
name|radeon_pre_page_flip
argument_list|(
name|rdev
argument_list|,
name|radeon_crtc
operator|->
name|crtc_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|pflip_cleanup1
label|:
if|if
condition|(
name|unlikely
argument_list|(
name|radeon_bo_reserve
argument_list|(
name|rbo
argument_list|,
name|false
argument_list|)
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to reserve new rbo in error path\n"
argument_list|)
expr_stmt|;
goto|goto
name|pflip_cleanup
goto|;
block|}
if|if
condition|(
name|unlikely
argument_list|(
name|radeon_bo_unpin
argument_list|(
name|rbo
argument_list|)
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to unpin new rbo in error path\n"
argument_list|)
expr_stmt|;
block|}
name|radeon_bo_unreserve
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
name|pflip_cleanup
label|:
name|DRM_SPINLOCK_IRQSAVE
argument_list|(
operator|&
name|dev
operator|->
name|event_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|radeon_crtc
operator|->
name|unpin_work
operator|=
name|NULL
expr_stmt|;
name|unlock_free
label|:
name|DRM_SPINUNLOCK_IRQRESTORE
argument_list|(
operator|&
name|dev
operator|->
name|event_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|drm_gem_object_unreference_unlocked
argument_list|(
name|old_radeon_fb
operator|->
name|obj
argument_list|)
expr_stmt|;
name|radeon_fence_unref
argument_list|(
operator|&
name|work
operator|->
name|fence
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|work
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_crtc_funcs
name|radeon_crtc_funcs
init|=
block|{
operator|.
name|cursor_set
operator|=
name|radeon_crtc_cursor_set
block|,
operator|.
name|cursor_move
operator|=
name|radeon_crtc_cursor_move
block|,
operator|.
name|gamma_set
operator|=
name|radeon_crtc_gamma_set
block|,
operator|.
name|set_config
operator|=
name|drm_crtc_helper_set_config
block|,
operator|.
name|destroy
operator|=
name|radeon_crtc_destroy
block|,
operator|.
name|page_flip
operator|=
name|radeon_crtc_page_flip
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|radeon_crtc_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|radeon_crtc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_crtc
argument_list|)
operator|+
operator|(
name|RADEONFB_CONN_LIMIT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|drm_connector
operator|*
argument_list|)
operator|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|==
name|NULL
condition|)
return|return;
name|drm_crtc_init
argument_list|(
name|dev
argument_list|,
operator|&
name|radeon_crtc
operator|->
name|base
argument_list|,
operator|&
name|radeon_crtc_funcs
argument_list|)
expr_stmt|;
name|drm_mode_crtc_set_gamma_size
argument_list|(
operator|&
name|radeon_crtc
operator|->
name|base
argument_list|,
literal|256
argument_list|)
expr_stmt|;
name|radeon_crtc
operator|->
name|crtc_id
operator|=
name|index
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|index
index|]
operator|=
name|radeon_crtc
expr_stmt|;
if|#
directive|if
literal|0
block|radeon_crtc->mode_set.crtc =&radeon_crtc->base; 	radeon_crtc->mode_set.connectors = (struct drm_connector **)(radeon_crtc + 1); 	radeon_crtc->mode_set.num_connectors = 0;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|radeon_crtc
operator|->
name|lut_r
index|[
name|i
index|]
operator|=
name|i
operator|<<
literal|2
expr_stmt|;
name|radeon_crtc
operator|->
name|lut_g
index|[
name|i
index|]
operator|=
name|i
operator|<<
literal|2
expr_stmt|;
name|radeon_crtc
operator|->
name|lut_b
index|[
name|i
index|]
operator|=
name|i
operator|<<
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
operator|&&
operator|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
operator|||
name|radeon_r4xx_atom
operator|)
condition|)
name|radeon_atombios_init_crtc
argument_list|(
name|dev
argument_list|,
name|radeon_crtc
argument_list|)
expr_stmt|;
else|else
name|radeon_legacy_init_crtc
argument_list|(
name|dev
argument_list|,
name|radeon_crtc
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|encoder_names
index|[
literal|37
index|]
init|=
block|{
literal|"NONE"
block|,
literal|"INTERNAL_LVDS"
block|,
literal|"INTERNAL_TMDS1"
block|,
literal|"INTERNAL_TMDS2"
block|,
literal|"INTERNAL_DAC1"
block|,
literal|"INTERNAL_DAC2"
block|,
literal|"INTERNAL_SDVOA"
block|,
literal|"INTERNAL_SDVOB"
block|,
literal|"SI170B"
block|,
literal|"CH7303"
block|,
literal|"CH7301"
block|,
literal|"INTERNAL_DVO1"
block|,
literal|"EXTERNAL_SDVOA"
block|,
literal|"EXTERNAL_SDVOB"
block|,
literal|"TITFP513"
block|,
literal|"INTERNAL_LVTM1"
block|,
literal|"VT1623"
block|,
literal|"HDMI_SI1930"
block|,
literal|"HDMI_INTERNAL"
block|,
literal|"INTERNAL_KLDSCP_TMDS1"
block|,
literal|"INTERNAL_KLDSCP_DVO1"
block|,
literal|"INTERNAL_KLDSCP_DAC1"
block|,
literal|"INTERNAL_KLDSCP_DAC2"
block|,
literal|"SI178"
block|,
literal|"MVPU_FPGA"
block|,
literal|"INTERNAL_DDI"
block|,
literal|"VT1625"
block|,
literal|"HDMI_SI1932"
block|,
literal|"DP_AN9801"
block|,
literal|"DP_DP501"
block|,
literal|"INTERNAL_UNIPHY"
block|,
literal|"INTERNAL_KLDSCP_LVTMA"
block|,
literal|"INTERNAL_UNIPHY1"
block|,
literal|"INTERNAL_UNIPHY2"
block|,
literal|"NUTMEG"
block|,
literal|"TRAVIS"
block|,
literal|"INTERNAL_VCE"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|hpd_names
index|[
literal|6
index|]
init|=
block|{
literal|"HPD1"
block|,
literal|"HPD2"
block|,
literal|"HPD3"
block|,
literal|"HPD4"
block|,
literal|"HPD5"
block|,
literal|"HPD6"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|radeon_print_display_setup
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
decl_stmt|;
name|struct
name|drm_encoder
modifier|*
name|encoder
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
decl_stmt|;
name|uint32_t
name|devices
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"Radeon Display Connectors\n"
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|connector
argument_list|,
argument|&dev->mode_config.connector_list
argument_list|,
argument|head
argument_list|)
block|{
name|radeon_connector
operator|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"Connector %d:\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"  %s\n"
argument_list|,
name|drm_get_connector_name
argument_list|(
name|connector
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
operator|!=
name|RADEON_HPD_NONE
condition|)
name|DRM_INFO
argument_list|(
literal|"  %s\n"
argument_list|,
name|hpd_names
index|[
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_connector
operator|->
name|ddc_bus
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"  DDC: 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x\n"
argument_list|,
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|rec
operator|.
name|mask_clk_reg
argument_list|,
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|rec
operator|.
name|mask_data_reg
argument_list|,
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|rec
operator|.
name|a_clk_reg
argument_list|,
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|rec
operator|.
name|a_data_reg
argument_list|,
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|rec
operator|.
name|en_clk_reg
argument_list|,
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|rec
operator|.
name|en_data_reg
argument_list|,
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|rec
operator|.
name|y_clk_reg
argument_list|,
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|rec
operator|.
name|y_data_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_connector
operator|->
name|router
operator|.
name|ddc_valid
condition|)
name|DRM_INFO
argument_list|(
literal|"  DDC Router 0x%x/0x%x\n"
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|ddc_mux_control_pin
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|ddc_mux_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_connector
operator|->
name|router
operator|.
name|cd_valid
condition|)
name|DRM_INFO
argument_list|(
literal|"  Clock/Data Router 0x%x/0x%x\n"
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|cd_mux_control_pin
argument_list|,
name|radeon_connector
operator|->
name|router
operator|.
name|cd_mux_state
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_VGA
operator|||
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVII
operator|||
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVID
operator|||
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVIA
operator|||
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_HDMIA
operator|||
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_HDMIB
condition|)
name|DRM_INFO
argument_list|(
literal|"  DDC: no ddc bus - possible BIOS bug - please report to xorg-driver-ati@lists.x.org\n"
argument_list|)
expr_stmt|;
block|}
name|DRM_INFO
argument_list|(
literal|"  Encoders:\n"
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|encoder
argument_list|,
argument|&dev->mode_config.encoder_list
argument_list|,
argument|head
argument_list|)
block|{
name|radeon_encoder
operator|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
expr_stmt|;
name|devices
operator|=
name|radeon_encoder
operator|->
name|devices
operator|&
name|radeon_connector
operator|->
name|devices
expr_stmt|;
if|if
condition|(
name|devices
condition|)
block|{
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_CRT1_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    CRT1: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_CRT2_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    CRT2: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_LCD1_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    LCD1: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_DFP1_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    DFP1: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_DFP2_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    DFP2: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_DFP3_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    DFP3: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_DFP4_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    DFP4: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_DFP5_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    DFP5: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_DFP6_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    DFP6: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_TV1_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    TV1: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|devices
operator|&
name|ATOM_DEVICE_CV_SUPPORT
condition|)
name|DRM_INFO
argument_list|(
literal|"    CV: %s\n"
argument_list|,
name|encoder_names
index|[
name|radeon_encoder
operator|->
name|encoder_id
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|i
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_setup_enc_conn
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|bool
name|ret
init|=
name|false
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|bios
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|ret
operator|=
name|radeon_get_atom_connector_info_from_supported_devices_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|false
condition|)
name|ret
operator|=
name|radeon_get_atom_connector_info_from_object_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|radeon_get_legacy_connector_info_from_bios
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|false
condition|)
name|ret
operator|=
name|radeon_get_legacy_connector_info_from_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
name|ret
operator|=
name|radeon_get_legacy_connector_info_from_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|radeon_setup_encoder_clones
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|radeon_print_display_setup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|radeon_ddc_get_modes
parameter_list|(
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|radeon_connector
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
comment|/* on hw with routers, select right port */
if|if
condition|(
name|radeon_connector
operator|->
name|router
operator|.
name|ddc_valid
condition|)
name|radeon_router_select_ddc_port
argument_list|(
name|radeon_connector
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_connector_encoder_get_dp_bridge_encoder_id
argument_list|(
operator|&
name|radeon_connector
operator|->
name|base
argument_list|)
operator|!=
name|ENCODER_OBJECT_ID_NONE
condition|)
block|{
name|struct
name|radeon_connector_atom_dig
modifier|*
name|dig
init|=
name|radeon_connector
operator|->
name|con_priv
decl_stmt|;
if|if
condition|(
name|dig
operator|->
name|dp_i2c_bus
condition|)
name|radeon_connector
operator|->
name|edid
operator|=
name|drm_get_edid
argument_list|(
operator|&
name|radeon_connector
operator|->
name|base
argument_list|,
name|dig
operator|->
name|dp_i2c_bus
operator|->
name|adapter
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|radeon_connector
operator|->
name|base
operator|.
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DisplayPort
operator|)
operator|||
operator|(
name|radeon_connector
operator|->
name|base
operator|.
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_eDP
operator|)
condition|)
block|{
name|struct
name|radeon_connector_atom_dig
modifier|*
name|dig
init|=
name|radeon_connector
operator|->
name|con_priv
decl_stmt|;
if|if
condition|(
operator|(
name|dig
operator|->
name|dp_sink_type
operator|==
name|CONNECTOR_OBJECT_ID_DISPLAYPORT
operator|||
name|dig
operator|->
name|dp_sink_type
operator|==
name|CONNECTOR_OBJECT_ID_eDP
operator|)
operator|&&
name|dig
operator|->
name|dp_i2c_bus
condition|)
name|radeon_connector
operator|->
name|edid
operator|=
name|drm_get_edid
argument_list|(
operator|&
name|radeon_connector
operator|->
name|base
argument_list|,
name|dig
operator|->
name|dp_i2c_bus
operator|->
name|adapter
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|radeon_connector
operator|->
name|ddc_bus
operator|&&
operator|!
name|radeon_connector
operator|->
name|edid
condition|)
name|radeon_connector
operator|->
name|edid
operator|=
name|drm_get_edid
argument_list|(
operator|&
name|radeon_connector
operator|->
name|base
argument_list|,
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|adapter
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|radeon_connector
operator|->
name|ddc_bus
operator|&&
operator|!
name|radeon_connector
operator|->
name|edid
condition|)
name|radeon_connector
operator|->
name|edid
operator|=
name|drm_get_edid
argument_list|(
operator|&
name|radeon_connector
operator|->
name|base
argument_list|,
name|radeon_connector
operator|->
name|ddc_bus
operator|->
name|adapter
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|radeon_connector
operator|->
name|edid
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
comment|/* some laptops provide a hardcoded edid in rom for LCDs */
if|if
condition|(
operator|(
operator|(
name|radeon_connector
operator|->
name|base
operator|.
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_LVDS
operator|)
operator|||
operator|(
name|radeon_connector
operator|->
name|base
operator|.
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_eDP
operator|)
operator|)
condition|)
name|radeon_connector
operator|->
name|edid
operator|=
name|radeon_bios_get_hardcoded_edid
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* some servers provide a hardcoded edid in rom for KVMs */
name|radeon_connector
operator|->
name|edid
operator|=
name|radeon_bios_get_hardcoded_edid
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_connector
operator|->
name|edid
condition|)
block|{
name|drm_mode_connector_update_edid_property
argument_list|(
operator|&
name|radeon_connector
operator|->
name|base
argument_list|,
name|radeon_connector
operator|->
name|edid
argument_list|)
expr_stmt|;
name|ret
operator|=
name|drm_add_edid_modes
argument_list|(
operator|&
name|radeon_connector
operator|->
name|base
argument_list|,
name|radeon_connector
operator|->
name|edid
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|drm_mode_connector_update_edid_property
argument_list|(
operator|&
name|radeon_connector
operator|->
name|base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* avivo */
end_comment

begin_function
specifier|static
name|void
name|avivo_get_fb_div
parameter_list|(
name|struct
name|radeon_pll
modifier|*
name|pll
parameter_list|,
name|u32
name|target_clock
parameter_list|,
name|u32
name|post_div
parameter_list|,
name|u32
name|ref_div
parameter_list|,
name|u32
modifier|*
name|fb_div
parameter_list|,
name|u32
modifier|*
name|frac_fb_div
parameter_list|)
block|{
name|u32
name|tmp
init|=
name|post_div
operator|*
name|ref_div
decl_stmt|;
name|tmp
operator|*=
name|target_clock
expr_stmt|;
operator|*
name|fb_div
operator|=
name|tmp
operator|/
name|pll
operator|->
name|reference_freq
expr_stmt|;
operator|*
name|frac_fb_div
operator|=
name|tmp
operator|%
name|pll
operator|->
name|reference_freq
expr_stmt|;
if|if
condition|(
operator|*
name|fb_div
operator|>
name|pll
operator|->
name|max_feedback_div
condition|)
operator|*
name|fb_div
operator|=
name|pll
operator|->
name|max_feedback_div
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|fb_div
operator|<
name|pll
operator|->
name|min_feedback_div
condition|)
operator|*
name|fb_div
operator|=
name|pll
operator|->
name|min_feedback_div
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|avivo_get_post_div
parameter_list|(
name|struct
name|radeon_pll
modifier|*
name|pll
parameter_list|,
name|u32
name|target_clock
parameter_list|)
block|{
name|u32
name|vco
decl_stmt|,
name|post_div
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_USE_POST_DIV
condition|)
return|return
name|pll
operator|->
name|post_div
return|;
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_PREFER_MINM_OVER_MAXP
condition|)
block|{
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_IS_LCD
condition|)
name|vco
operator|=
name|pll
operator|->
name|lcd_pll_out_min
expr_stmt|;
else|else
name|vco
operator|=
name|pll
operator|->
name|pll_out_min
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_IS_LCD
condition|)
name|vco
operator|=
name|pll
operator|->
name|lcd_pll_out_max
expr_stmt|;
else|else
name|vco
operator|=
name|pll
operator|->
name|pll_out_max
expr_stmt|;
block|}
name|post_div
operator|=
name|vco
operator|/
name|target_clock
expr_stmt|;
name|tmp
operator|=
name|vco
operator|%
name|target_clock
expr_stmt|;
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_PREFER_MINM_OVER_MAXP
condition|)
block|{
if|if
condition|(
name|tmp
condition|)
name|post_div
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|tmp
condition|)
name|post_div
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|post_div
operator|>
name|pll
operator|->
name|max_post_div
condition|)
name|post_div
operator|=
name|pll
operator|->
name|max_post_div
expr_stmt|;
elseif|else
if|if
condition|(
name|post_div
operator|<
name|pll
operator|->
name|min_post_div
condition|)
name|post_div
operator|=
name|pll
operator|->
name|min_post_div
expr_stmt|;
return|return
name|post_div
return|;
block|}
end_function

begin_define
define|#
directive|define
name|MAX_TOLERANCE
value|10
end_define

begin_function
name|void
name|radeon_compute_pll_avivo
parameter_list|(
name|struct
name|radeon_pll
modifier|*
name|pll
parameter_list|,
name|u32
name|freq
parameter_list|,
name|u32
modifier|*
name|dot_clock_p
parameter_list|,
name|u32
modifier|*
name|fb_div_p
parameter_list|,
name|u32
modifier|*
name|frac_fb_div_p
parameter_list|,
name|u32
modifier|*
name|ref_div_p
parameter_list|,
name|u32
modifier|*
name|post_div_p
parameter_list|)
block|{
name|u32
name|target_clock
init|=
name|freq
operator|/
literal|10
decl_stmt|;
name|u32
name|post_div
init|=
name|avivo_get_post_div
argument_list|(
name|pll
argument_list|,
name|target_clock
argument_list|)
decl_stmt|;
name|u32
name|ref_div
init|=
name|pll
operator|->
name|min_ref_div
decl_stmt|;
name|u32
name|fb_div
init|=
literal|0
decl_stmt|,
name|frac_fb_div
init|=
literal|0
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_USE_REF_DIV
condition|)
name|ref_div
operator|=
name|pll
operator|->
name|reference_div
expr_stmt|;
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_USE_FRAC_FB_DIV
condition|)
block|{
name|avivo_get_fb_div
argument_list|(
name|pll
argument_list|,
name|target_clock
argument_list|,
name|post_div
argument_list|,
name|ref_div
argument_list|,
operator|&
name|fb_div
argument_list|,
operator|&
name|frac_fb_div
argument_list|)
expr_stmt|;
name|frac_fb_div
operator|=
operator|(
literal|100
operator|*
name|frac_fb_div
operator|)
operator|/
name|pll
operator|->
name|reference_freq
expr_stmt|;
if|if
condition|(
name|frac_fb_div
operator|>=
literal|5
condition|)
block|{
name|frac_fb_div
operator|-=
literal|5
expr_stmt|;
name|frac_fb_div
operator|=
name|frac_fb_div
operator|/
literal|10
expr_stmt|;
name|frac_fb_div
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|frac_fb_div
operator|>=
literal|10
condition|)
block|{
name|fb_div
operator|++
expr_stmt|;
name|frac_fb_div
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|ref_div
operator|<=
name|pll
operator|->
name|max_ref_div
condition|)
block|{
name|avivo_get_fb_div
argument_list|(
name|pll
argument_list|,
name|target_clock
argument_list|,
name|post_div
argument_list|,
name|ref_div
argument_list|,
operator|&
name|fb_div
argument_list|,
operator|&
name|frac_fb_div
argument_list|)
expr_stmt|;
if|if
condition|(
name|frac_fb_div
operator|>=
operator|(
name|pll
operator|->
name|reference_freq
operator|/
literal|2
operator|)
condition|)
name|fb_div
operator|++
expr_stmt|;
name|frac_fb_div
operator|=
literal|0
expr_stmt|;
name|tmp
operator|=
operator|(
name|pll
operator|->
name|reference_freq
operator|*
name|fb_div
operator|)
operator|/
operator|(
name|post_div
operator|*
name|ref_div
operator|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|*
literal|10000
operator|)
operator|/
name|target_clock
expr_stmt|;
if|if
condition|(
name|tmp
operator|>
operator|(
literal|10000
operator|+
name|MAX_TOLERANCE
operator|)
condition|)
name|ref_div
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|tmp
operator|>=
operator|(
literal|10000
operator|-
name|MAX_TOLERANCE
operator|)
condition|)
break|break;
else|else
name|ref_div
operator|++
expr_stmt|;
block|}
block|}
operator|*
name|dot_clock_p
operator|=
operator|(
operator|(
name|pll
operator|->
name|reference_freq
operator|*
name|fb_div
operator|*
literal|10
operator|)
operator|+
operator|(
name|pll
operator|->
name|reference_freq
operator|*
name|frac_fb_div
operator|)
operator|)
operator|/
operator|(
name|ref_div
operator|*
name|post_div
operator|*
literal|10
operator|)
expr_stmt|;
operator|*
name|fb_div_p
operator|=
name|fb_div
expr_stmt|;
operator|*
name|frac_fb_div_p
operator|=
name|frac_fb_div
expr_stmt|;
operator|*
name|ref_div_p
operator|=
name|ref_div
expr_stmt|;
operator|*
name|post_div_p
operator|=
name|post_div
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"%d, pll dividers - fb: %d.%d ref: %d, post %d\n"
argument_list|,
operator|*
name|dot_clock_p
argument_list|,
name|fb_div
argument_list|,
name|frac_fb_div
argument_list|,
name|ref_div
argument_list|,
name|post_div
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* pre-avivo */
end_comment

begin_function
specifier|static
specifier|inline
name|uint32_t
name|radeon_div
parameter_list|(
name|uint64_t
name|n
parameter_list|,
name|uint32_t
name|d
parameter_list|)
block|{
name|uint64_t
name|mod
decl_stmt|;
name|n
operator|+=
name|d
operator|/
literal|2
expr_stmt|;
name|mod
operator|=
name|do_div
argument_list|(
name|n
argument_list|,
name|d
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
name|void
name|radeon_compute_pll_legacy
parameter_list|(
name|struct
name|radeon_pll
modifier|*
name|pll
parameter_list|,
name|uint64_t
name|freq
parameter_list|,
name|uint32_t
modifier|*
name|dot_clock_p
parameter_list|,
name|uint32_t
modifier|*
name|fb_div_p
parameter_list|,
name|uint32_t
modifier|*
name|frac_fb_div_p
parameter_list|,
name|uint32_t
modifier|*
name|ref_div_p
parameter_list|,
name|uint32_t
modifier|*
name|post_div_p
parameter_list|)
block|{
name|uint32_t
name|min_ref_div
init|=
name|pll
operator|->
name|min_ref_div
decl_stmt|;
name|uint32_t
name|max_ref_div
init|=
name|pll
operator|->
name|max_ref_div
decl_stmt|;
name|uint32_t
name|min_post_div
init|=
name|pll
operator|->
name|min_post_div
decl_stmt|;
name|uint32_t
name|max_post_div
init|=
name|pll
operator|->
name|max_post_div
decl_stmt|;
name|uint32_t
name|min_fractional_feed_div
init|=
literal|0
decl_stmt|;
name|uint32_t
name|max_fractional_feed_div
init|=
literal|0
decl_stmt|;
name|uint32_t
name|best_vco
init|=
name|pll
operator|->
name|best_vco
decl_stmt|;
name|uint32_t
name|best_post_div
init|=
literal|1
decl_stmt|;
name|uint32_t
name|best_ref_div
init|=
literal|1
decl_stmt|;
name|uint32_t
name|best_feedback_div
init|=
literal|1
decl_stmt|;
name|uint32_t
name|best_frac_feedback_div
init|=
literal|0
decl_stmt|;
name|uint32_t
name|best_freq
init|=
operator|-
literal|1
decl_stmt|;
name|uint32_t
name|best_error
init|=
literal|0xffffffff
decl_stmt|;
name|uint32_t
name|best_vco_diff
init|=
literal|1
decl_stmt|;
name|uint32_t
name|post_div
decl_stmt|;
name|u32
name|pll_out_min
decl_stmt|,
name|pll_out_max
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"PLL freq %ju %u %u\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|freq
argument_list|,
name|pll
operator|->
name|min_ref_div
argument_list|,
name|pll
operator|->
name|max_ref_div
argument_list|)
expr_stmt|;
name|freq
operator|=
name|freq
operator|*
literal|1000
expr_stmt|;
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_IS_LCD
condition|)
block|{
name|pll_out_min
operator|=
name|pll
operator|->
name|lcd_pll_out_min
expr_stmt|;
name|pll_out_max
operator|=
name|pll
operator|->
name|lcd_pll_out_max
expr_stmt|;
block|}
else|else
block|{
name|pll_out_min
operator|=
name|pll
operator|->
name|pll_out_min
expr_stmt|;
name|pll_out_max
operator|=
name|pll
operator|->
name|pll_out_max
expr_stmt|;
block|}
if|if
condition|(
name|pll_out_min
operator|>
literal|64800
condition|)
name|pll_out_min
operator|=
literal|64800
expr_stmt|;
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_USE_REF_DIV
condition|)
name|min_ref_div
operator|=
name|max_ref_div
operator|=
name|pll
operator|->
name|reference_div
expr_stmt|;
else|else
block|{
while|while
condition|(
name|min_ref_div
operator|<
name|max_ref_div
operator|-
literal|1
condition|)
block|{
name|uint32_t
name|mid
init|=
operator|(
name|min_ref_div
operator|+
name|max_ref_div
operator|)
operator|/
literal|2
decl_stmt|;
name|uint32_t
name|pll_in
init|=
name|pll
operator|->
name|reference_freq
operator|/
name|mid
decl_stmt|;
if|if
condition|(
name|pll_in
operator|<
name|pll
operator|->
name|pll_in_min
condition|)
name|max_ref_div
operator|=
name|mid
expr_stmt|;
elseif|else
if|if
condition|(
name|pll_in
operator|>
name|pll
operator|->
name|pll_in_max
condition|)
name|min_ref_div
operator|=
name|mid
expr_stmt|;
else|else
break|break;
block|}
block|}
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_USE_POST_DIV
condition|)
name|min_post_div
operator|=
name|max_post_div
operator|=
name|pll
operator|->
name|post_div
expr_stmt|;
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_USE_FRAC_FB_DIV
condition|)
block|{
name|min_fractional_feed_div
operator|=
name|pll
operator|->
name|min_frac_feedback_div
expr_stmt|;
name|max_fractional_feed_div
operator|=
name|pll
operator|->
name|max_frac_feedback_div
expr_stmt|;
block|}
for|for
control|(
name|post_div
operator|=
name|max_post_div
init|;
name|post_div
operator|>=
name|min_post_div
condition|;
operator|--
name|post_div
control|)
block|{
name|uint32_t
name|ref_div
decl_stmt|;
if|if
condition|(
operator|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_NO_ODD_POST_DIV
operator|)
operator|&&
operator|(
name|post_div
operator|&
literal|1
operator|)
condition|)
continue|continue;
comment|/* legacy radeons only have a few post_divs */
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_LEGACY
condition|)
block|{
if|if
condition|(
operator|(
name|post_div
operator|==
literal|5
operator|)
operator|||
operator|(
name|post_div
operator|==
literal|7
operator|)
operator|||
operator|(
name|post_div
operator|==
literal|9
operator|)
operator|||
operator|(
name|post_div
operator|==
literal|10
operator|)
operator|||
operator|(
name|post_div
operator|==
literal|11
operator|)
operator|||
operator|(
name|post_div
operator|==
literal|13
operator|)
operator|||
operator|(
name|post_div
operator|==
literal|14
operator|)
operator|||
operator|(
name|post_div
operator|==
literal|15
operator|)
condition|)
continue|continue;
block|}
for|for
control|(
name|ref_div
operator|=
name|min_ref_div
init|;
name|ref_div
operator|<=
name|max_ref_div
condition|;
operator|++
name|ref_div
control|)
block|{
name|uint32_t
name|feedback_div
decl_stmt|,
name|current_freq
init|=
literal|0
decl_stmt|,
name|error
decl_stmt|,
name|vco_diff
decl_stmt|;
name|uint32_t
name|pll_in
init|=
name|pll
operator|->
name|reference_freq
operator|/
name|ref_div
decl_stmt|;
name|uint32_t
name|min_feed_div
init|=
name|pll
operator|->
name|min_feedback_div
decl_stmt|;
name|uint32_t
name|max_feed_div
init|=
name|pll
operator|->
name|max_feedback_div
operator|+
literal|1
decl_stmt|;
if|if
condition|(
name|pll_in
operator|<
name|pll
operator|->
name|pll_in_min
operator|||
name|pll_in
operator|>
name|pll
operator|->
name|pll_in_max
condition|)
continue|continue;
while|while
condition|(
name|min_feed_div
operator|<
name|max_feed_div
condition|)
block|{
name|uint32_t
name|vco
decl_stmt|;
name|uint32_t
name|min_frac_feed_div
init|=
name|min_fractional_feed_div
decl_stmt|;
name|uint32_t
name|max_frac_feed_div
init|=
name|max_fractional_feed_div
operator|+
literal|1
decl_stmt|;
name|uint32_t
name|frac_feedback_div
decl_stmt|;
name|uint64_t
name|tmp
decl_stmt|;
name|feedback_div
operator|=
operator|(
name|min_feed_div
operator|+
name|max_feed_div
operator|)
operator|/
literal|2
expr_stmt|;
name|tmp
operator|=
operator|(
name|uint64_t
operator|)
name|pll
operator|->
name|reference_freq
operator|*
name|feedback_div
expr_stmt|;
name|vco
operator|=
name|radeon_div
argument_list|(
name|tmp
argument_list|,
name|ref_div
argument_list|)
expr_stmt|;
if|if
condition|(
name|vco
operator|<
name|pll_out_min
condition|)
block|{
name|min_feed_div
operator|=
name|feedback_div
operator|+
literal|1
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|vco
operator|>
name|pll_out_max
condition|)
block|{
name|max_feed_div
operator|=
name|feedback_div
expr_stmt|;
continue|continue;
block|}
while|while
condition|(
name|min_frac_feed_div
operator|<
name|max_frac_feed_div
condition|)
block|{
name|frac_feedback_div
operator|=
operator|(
name|min_frac_feed_div
operator|+
name|max_frac_feed_div
operator|)
operator|/
literal|2
expr_stmt|;
name|tmp
operator|=
operator|(
name|uint64_t
operator|)
name|pll
operator|->
name|reference_freq
operator|*
literal|10000
operator|*
name|feedback_div
expr_stmt|;
name|tmp
operator|+=
operator|(
name|uint64_t
operator|)
name|pll
operator|->
name|reference_freq
operator|*
literal|1000
operator|*
name|frac_feedback_div
expr_stmt|;
name|current_freq
operator|=
name|radeon_div
argument_list|(
name|tmp
argument_list|,
name|ref_div
operator|*
name|post_div
argument_list|)
expr_stmt|;
if|if
condition|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_PREFER_CLOSEST_LOWER
condition|)
block|{
if|if
condition|(
name|freq
operator|<
name|current_freq
condition|)
name|error
operator|=
literal|0xffffffff
expr_stmt|;
else|else
name|error
operator|=
name|freq
operator|-
name|current_freq
expr_stmt|;
block|}
else|else
name|error
operator|=
name|abs
argument_list|(
name|current_freq
operator|-
name|freq
argument_list|)
expr_stmt|;
name|vco_diff
operator|=
name|abs
argument_list|(
name|vco
operator|-
name|best_vco
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|best_vco
operator|==
literal|0
operator|&&
name|error
operator|<
name|best_error
operator|)
operator|||
operator|(
name|best_vco
operator|!=
literal|0
operator|&&
operator|(
operator|(
name|best_error
operator|>
literal|100
operator|&&
name|error
operator|<
name|best_error
operator|-
literal|100
operator|)
operator|||
operator|(
name|abs
argument_list|(
name|error
operator|-
name|best_error
argument_list|)
operator|<
literal|100
operator|&&
name|vco_diff
operator|<
name|best_vco_diff
operator|)
operator|)
operator|)
condition|)
block|{
name|best_post_div
operator|=
name|post_div
expr_stmt|;
name|best_ref_div
operator|=
name|ref_div
expr_stmt|;
name|best_feedback_div
operator|=
name|feedback_div
expr_stmt|;
name|best_frac_feedback_div
operator|=
name|frac_feedback_div
expr_stmt|;
name|best_freq
operator|=
name|current_freq
expr_stmt|;
name|best_error
operator|=
name|error
expr_stmt|;
name|best_vco_diff
operator|=
name|vco_diff
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|current_freq
operator|==
name|freq
condition|)
block|{
if|if
condition|(
name|best_freq
operator|==
operator|-
literal|1
condition|)
block|{
name|best_post_div
operator|=
name|post_div
expr_stmt|;
name|best_ref_div
operator|=
name|ref_div
expr_stmt|;
name|best_feedback_div
operator|=
name|feedback_div
expr_stmt|;
name|best_frac_feedback_div
operator|=
name|frac_feedback_div
expr_stmt|;
name|best_freq
operator|=
name|current_freq
expr_stmt|;
name|best_error
operator|=
name|error
expr_stmt|;
name|best_vco_diff
operator|=
name|vco_diff
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_PREFER_LOW_REF_DIV
operator|)
operator|&&
operator|(
name|ref_div
operator|<
name|best_ref_div
operator|)
operator|)
operator|||
operator|(
operator|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_PREFER_HIGH_REF_DIV
operator|)
operator|&&
operator|(
name|ref_div
operator|>
name|best_ref_div
operator|)
operator|)
operator|||
operator|(
operator|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_PREFER_LOW_FB_DIV
operator|)
operator|&&
operator|(
name|feedback_div
operator|<
name|best_feedback_div
operator|)
operator|)
operator|||
operator|(
operator|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_PREFER_HIGH_FB_DIV
operator|)
operator|&&
operator|(
name|feedback_div
operator|>
name|best_feedback_div
operator|)
operator|)
operator|||
operator|(
operator|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_PREFER_LOW_POST_DIV
operator|)
operator|&&
operator|(
name|post_div
operator|<
name|best_post_div
operator|)
operator|)
operator|||
operator|(
operator|(
name|pll
operator|->
name|flags
operator|&
name|RADEON_PLL_PREFER_HIGH_POST_DIV
operator|)
operator|&&
operator|(
name|post_div
operator|>
name|best_post_div
operator|)
operator|)
condition|)
block|{
name|best_post_div
operator|=
name|post_div
expr_stmt|;
name|best_ref_div
operator|=
name|ref_div
expr_stmt|;
name|best_feedback_div
operator|=
name|feedback_div
expr_stmt|;
name|best_frac_feedback_div
operator|=
name|frac_feedback_div
expr_stmt|;
name|best_freq
operator|=
name|current_freq
expr_stmt|;
name|best_error
operator|=
name|error
expr_stmt|;
name|best_vco_diff
operator|=
name|vco_diff
expr_stmt|;
block|}
block|}
if|if
condition|(
name|current_freq
operator|<
name|freq
condition|)
name|min_frac_feed_div
operator|=
name|frac_feedback_div
operator|+
literal|1
expr_stmt|;
else|else
name|max_frac_feed_div
operator|=
name|frac_feedback_div
expr_stmt|;
block|}
if|if
condition|(
name|current_freq
operator|<
name|freq
condition|)
name|min_feed_div
operator|=
name|feedback_div
operator|+
literal|1
expr_stmt|;
else|else
name|max_feed_div
operator|=
name|feedback_div
expr_stmt|;
block|}
block|}
block|}
operator|*
name|dot_clock_p
operator|=
name|best_freq
operator|/
literal|10000
expr_stmt|;
operator|*
name|fb_div_p
operator|=
name|best_feedback_div
expr_stmt|;
operator|*
name|frac_fb_div_p
operator|=
name|best_frac_feedback_div
expr_stmt|;
operator|*
name|ref_div_p
operator|=
name|best_ref_div
expr_stmt|;
operator|*
name|post_div_p
operator|=
name|best_post_div
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"%lld %d, pll dividers - fb: %d.%d ref: %d, post %d\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|freq
argument_list|,
name|best_freq
operator|/
literal|1000
argument_list|,
name|best_feedback_div
argument_list|,
name|best_frac_feedback_div
argument_list|,
name|best_ref_div
argument_list|,
name|best_post_div
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_user_framebuffer_destroy
parameter_list|(
name|struct
name|drm_framebuffer
modifier|*
name|fb
parameter_list|)
block|{
name|struct
name|radeon_framebuffer
modifier|*
name|radeon_fb
init|=
name|to_radeon_framebuffer
argument_list|(
name|fb
argument_list|)
decl_stmt|;
if|if
condition|(
name|radeon_fb
operator|->
name|obj
condition|)
block|{
name|drm_gem_object_unreference_unlocked
argument_list|(
name|radeon_fb
operator|->
name|obj
argument_list|)
expr_stmt|;
block|}
name|drm_framebuffer_cleanup
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|radeon_fb
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_user_framebuffer_create_handle
parameter_list|(
name|struct
name|drm_framebuffer
modifier|*
name|fb
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|,
name|unsigned
name|int
modifier|*
name|handle
parameter_list|)
block|{
name|struct
name|radeon_framebuffer
modifier|*
name|radeon_fb
init|=
name|to_radeon_framebuffer
argument_list|(
name|fb
argument_list|)
decl_stmt|;
return|return
name|drm_gem_handle_create
argument_list|(
name|file_priv
argument_list|,
name|radeon_fb
operator|->
name|obj
argument_list|,
name|handle
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_framebuffer_funcs
name|radeon_fb_funcs
init|=
block|{
operator|.
name|destroy
operator|=
name|radeon_user_framebuffer_destroy
block|,
operator|.
name|create_handle
operator|=
name|radeon_user_framebuffer_create_handle
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|radeon_framebuffer_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|radeon_framebuffer
modifier|*
name|rfb
parameter_list|,
name|struct
name|drm_mode_fb_cmd2
modifier|*
name|mode_cmd
parameter_list|,
name|struct
name|drm_gem_object
modifier|*
name|obj
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|rfb
operator|->
name|obj
operator|=
name|obj
expr_stmt|;
name|ret
operator|=
name|drm_framebuffer_init
argument_list|(
name|dev
argument_list|,
operator|&
name|rfb
operator|->
name|base
argument_list|,
operator|&
name|radeon_fb_funcs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|rfb
operator|->
name|obj
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
name|drm_helper_mode_fill_fb_struct
argument_list|(
operator|&
name|rfb
operator|->
name|base
argument_list|,
name|mode_cmd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_user_framebuffer_create
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|,
name|struct
name|drm_mode_fb_cmd2
modifier|*
name|mode_cmd
parameter_list|,
name|struct
name|drm_framebuffer
modifier|*
modifier|*
name|res
parameter_list|)
block|{
name|struct
name|drm_gem_object
modifier|*
name|obj
decl_stmt|;
name|struct
name|radeon_framebuffer
modifier|*
name|radeon_fb
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|obj
operator|=
name|drm_gem_object_lookup
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|,
name|mode_cmd
operator|->
name|handles
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|==
name|NULL
condition|)
block|{
name|dev_err
argument_list|(
name|dev
operator|->
name|device
argument_list|,
literal|"No GEM object associated to handle 0x%08X, "
literal|"can't create framebuffer\n"
argument_list|,
name|mode_cmd
operator|->
name|handles
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOENT
return|;
block|}
name|radeon_fb
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|radeon_fb
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_fb
operator|==
name|NULL
condition|)
block|{
name|drm_gem_object_unreference_unlocked
argument_list|(
name|obj
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
name|ret
operator|=
name|radeon_framebuffer_init
argument_list|(
name|dev
argument_list|,
name|radeon_fb
argument_list|,
name|mode_cmd
argument_list|,
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|radeon_fb
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|drm_gem_object_unreference_unlocked
argument_list|(
name|obj
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
operator|*
name|res
operator|=
operator|&
name|radeon_fb
operator|->
name|base
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_output_poll_changed
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|radeon_fb_output_poll_changed
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_mode_config_funcs
name|radeon_mode_funcs
init|=
block|{
operator|.
name|fb_create
operator|=
name|radeon_user_framebuffer_create
block|,
operator|.
name|output_poll_changed
operator|=
name|radeon_output_poll_changed
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|drm_prop_enum_list
name|radeon_tmds_pll_enum_list
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"driver"
block|}
block|,
block|{
literal|1
block|,
literal|"bios"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|drm_prop_enum_list
name|radeon_tv_std_enum_list
index|[]
init|=
block|{
block|{
name|TV_STD_NTSC
block|,
literal|"ntsc"
block|}
block|,
block|{
name|TV_STD_PAL
block|,
literal|"pal"
block|}
block|,
block|{
name|TV_STD_PAL_M
block|,
literal|"pal-m"
block|}
block|,
block|{
name|TV_STD_PAL_60
block|,
literal|"pal-60"
block|}
block|,
block|{
name|TV_STD_NTSC_J
block|,
literal|"ntsc-j"
block|}
block|,
block|{
name|TV_STD_SCART_PAL
block|,
literal|"scart-pal"
block|}
block|,
block|{
name|TV_STD_PAL_CN
block|,
literal|"pal-cn"
block|}
block|,
block|{
name|TV_STD_SECAM
block|,
literal|"secam"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|drm_prop_enum_list
name|radeon_underscan_enum_list
index|[]
init|=
block|{
block|{
name|UNDERSCAN_OFF
block|,
literal|"off"
block|}
block|,
block|{
name|UNDERSCAN_ON
block|,
literal|"on"
block|}
block|,
block|{
name|UNDERSCAN_AUTO
block|,
literal|"auto"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|radeon_modeset_create_props
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|sz
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|coherent_mode_property
operator|=
name|drm_property_create_range
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|,
literal|"coherent"
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|mode_info
operator|.
name|coherent_mode_property
condition|)
return|return
operator|-
name|ENOMEM
return|;
block|}
if|if
condition|(
operator|!
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|sz
operator|=
name|DRM_ARRAY_SIZE
argument_list|(
name|radeon_tmds_pll_enum_list
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|tmds_pll_property
operator|=
name|drm_property_create_enum
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|,
literal|"tmds_pll"
argument_list|,
name|radeon_tmds_pll_enum_list
argument_list|,
name|sz
argument_list|)
expr_stmt|;
block|}
name|rdev
operator|->
name|mode_info
operator|.
name|load_detect_property
operator|=
name|drm_property_create_range
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|,
literal|"load detection"
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|mode_info
operator|.
name|load_detect_property
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|drm_mode_create_scaling_mode_property
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
name|sz
operator|=
name|DRM_ARRAY_SIZE
argument_list|(
name|radeon_tv_std_enum_list
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|tv_std_property
operator|=
name|drm_property_create_enum
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|,
literal|"tv standard"
argument_list|,
name|radeon_tv_std_enum_list
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|sz
operator|=
name|DRM_ARRAY_SIZE
argument_list|(
name|radeon_underscan_enum_list
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|underscan_property
operator|=
name|drm_property_create_enum
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|,
literal|"underscan"
argument_list|,
name|radeon_underscan_enum_list
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|underscan_hborder_property
operator|=
name|drm_property_create_range
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|,
literal|"underscan hborder"
argument_list|,
literal|0
argument_list|,
literal|128
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|mode_info
operator|.
name|underscan_hborder_property
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|rdev
operator|->
name|mode_info
operator|.
name|underscan_vborder_property
operator|=
name|drm_property_create_range
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|,
literal|"underscan vborder"
argument_list|,
literal|0
argument_list|,
literal|128
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|mode_info
operator|.
name|underscan_vborder_property
condition|)
return|return
operator|-
name|ENOMEM
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|radeon_update_display_priority
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* adjustment options for the display watermarks */
if|if
condition|(
operator|(
name|radeon_disp_priority
operator|==
literal|0
operator|)
operator|||
operator|(
name|radeon_disp_priority
operator|>
literal|2
operator|)
condition|)
block|{
comment|/* set display priority to high for r3xx, rv515 chips 		 * this avoids flickering due to underflow to the 		 * display controllers during heavy acceleration. 		 * Don't force high on rs4xx igp chips as it seems to 		 * affect the sound card.  See kernel bug 15982. 		 */
if|if
condition|(
operator|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV515
operator|)
operator|)
operator|&&
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
condition|)
name|rdev
operator|->
name|disp_priority
operator|=
literal|2
expr_stmt|;
else|else
name|rdev
operator|->
name|disp_priority
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|rdev
operator|->
name|disp_priority
operator|=
name|radeon_disp_priority
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Allocate hdmi structs and determine register offsets  */
end_comment

begin_function
specifier|static
name|void
name|radeon_afmt_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_MAX_AFMT_BLOCKS
condition|;
name|i
operator|++
control|)
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE6
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
comment|/* todo */
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
comment|/* DCE4/5 has 6 audio blocks tied to DIG encoders */
comment|/* DCE4.1 has 2 audio blocks tied to DIG encoders */
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_afmt
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
operator|->
name|offset
operator|=
name|EVERGREEN_CRTC0_REGISTER_OFFSET
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
operator|->
name|id
operator|=
literal|0
expr_stmt|;
block|}
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_afmt
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
operator|->
name|offset
operator|=
name|EVERGREEN_CRTC1_REGISTER_OFFSET
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
operator|->
name|id
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ASIC_IS_DCE41
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|2
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_afmt
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|2
index|]
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|2
index|]
operator|->
name|offset
operator|=
name|EVERGREEN_CRTC2_REGISTER_OFFSET
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|2
index|]
operator|->
name|id
operator|=
literal|2
expr_stmt|;
block|}
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|3
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_afmt
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|3
index|]
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|3
index|]
operator|->
name|offset
operator|=
name|EVERGREEN_CRTC3_REGISTER_OFFSET
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|3
index|]
operator|->
name|id
operator|=
literal|3
expr_stmt|;
block|}
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|4
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_afmt
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|4
index|]
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|4
index|]
operator|->
name|offset
operator|=
name|EVERGREEN_CRTC4_REGISTER_OFFSET
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|4
index|]
operator|->
name|id
operator|=
literal|4
expr_stmt|;
block|}
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|5
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_afmt
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|5
index|]
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|5
index|]
operator|->
name|offset
operator|=
name|EVERGREEN_CRTC5_REGISTER_OFFSET
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|5
index|]
operator|->
name|id
operator|=
literal|5
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
comment|/* DCE3.x has 2 audio blocks tied to DIG encoders */
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_afmt
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
operator|->
name|offset
operator|=
name|DCE3_HDMI_OFFSET0
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
operator|->
name|id
operator|=
literal|0
expr_stmt|;
block|}
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_afmt
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
operator|->
name|offset
operator|=
name|DCE3_HDMI_OFFSET1
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
operator|->
name|id
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_DCE2
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
comment|/* DCE2 has at least 1 routable audio block */
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_afmt
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
operator|->
name|offset
operator|=
name|DCE2_HDMI_OFFSET0
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|0
index|]
operator|->
name|id
operator|=
literal|0
expr_stmt|;
block|}
comment|/* r6xx has 2 routable audio blocks */
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_afmt
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
operator|->
name|offset
operator|=
name|DCE2_HDMI_OFFSET1
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
literal|1
index|]
operator|->
name|id
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_afmt_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_MAX_AFMT_BLOCKS
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
name|i
index|]
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|afmt
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|radeon_modeset_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|drm_mode_config_init
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|mode_config_initialized
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|ddev
operator|->
name|mode_config
operator|.
name|funcs
operator|=
operator|&
name|radeon_mode_funcs
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|ddev
operator|->
name|mode_config
operator|.
name|max_width
operator|=
literal|16384
expr_stmt|;
name|rdev
operator|->
name|ddev
operator|->
name|mode_config
operator|.
name|max_height
operator|=
literal|16384
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|ddev
operator|->
name|mode_config
operator|.
name|max_width
operator|=
literal|8192
expr_stmt|;
name|rdev
operator|->
name|ddev
operator|->
name|mode_config
operator|.
name|max_height
operator|=
literal|8192
expr_stmt|;
block|}
else|else
block|{
name|rdev
operator|->
name|ddev
operator|->
name|mode_config
operator|.
name|max_width
operator|=
literal|4096
expr_stmt|;
name|rdev
operator|->
name|ddev
operator|->
name|mode_config
operator|.
name|max_height
operator|=
literal|4096
expr_stmt|;
block|}
name|rdev
operator|->
name|ddev
operator|->
name|mode_config
operator|.
name|preferred_depth
operator|=
literal|24
expr_stmt|;
name|rdev
operator|->
name|ddev
operator|->
name|mode_config
operator|.
name|prefer_shadow
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|ddev
operator|->
name|mode_config
operator|.
name|fb_base
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_base
expr_stmt|;
name|ret
operator|=
name|radeon_modeset_create_props
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
return|return
name|ret
return|;
block|}
comment|/* init i2c buses */
name|radeon_i2c_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* check combios for a valid hardcoded EDID - Sun servers */
if|if
condition|(
operator|!
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
comment|/* check for hardcoded EDID in BIOS */
name|radeon_combios_check_hardcoded_edid
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
comment|/* allocate crtcs */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|++
control|)
block|{
name|radeon_crtc_init
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
comment|/* okay we should have all the bios connectors */
name|ret
operator|=
name|radeon_setup_enc_conn
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
return|return
name|ret
return|;
block|}
comment|/* init dig PHYs, disp eng pll */
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|radeon_atom_encoder_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atom_disp_eng_pll_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
comment|/* initialize hpd */
name|radeon_hpd_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* setup afmt */
name|radeon_afmt_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize power management */
name|radeon_pm_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fbdev_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|drm_kms_helper_poll_init
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|radeon_modeset_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|radeon_fbdev_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|bios_hardcoded_edid
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
name|radeon_pm_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|mode_config_initialized
condition|)
block|{
name|radeon_afmt_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|drm_kms_helper_poll_fini
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
name|radeon_hpd_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* Work around lock recursion. dumbbell@ */
name|drm_mode_config_cleanup
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
name|DRM_LOCK
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|mode_config_initialized
operator|=
name|false
expr_stmt|;
block|}
comment|/* free i2c buses */
name|radeon_i2c_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|is_hdtv_mode
parameter_list|(
specifier|const
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
comment|/* try and guess if this is a tv or a monitor */
if|if
condition|(
operator|(
name|mode
operator|->
name|vdisplay
operator|==
literal|480
operator|&&
name|mode
operator|->
name|hdisplay
operator|==
literal|720
operator|)
operator|||
comment|/* 480p */
operator|(
name|mode
operator|->
name|vdisplay
operator|==
literal|576
operator|)
operator|||
comment|/* 576p */
operator|(
name|mode
operator|->
name|vdisplay
operator|==
literal|720
operator|)
operator|||
comment|/* 720p */
operator|(
name|mode
operator|->
name|vdisplay
operator|==
literal|1080
operator|)
condition|)
comment|/* 1080p */
return|return
name|true
return|;
else|else
return|return
name|false
return|;
block|}
end_function

begin_function
name|bool
name|radeon_crtc_scaling_mode_fixup
parameter_list|(
name|struct
name|drm_crtc
modifier|*
name|crtc
parameter_list|,
specifier|const
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|crtc
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_encoder
modifier|*
name|encoder
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
decl_stmt|;
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
decl_stmt|;
name|bool
name|first
init|=
name|true
decl_stmt|;
name|u32
name|src_v
init|=
literal|1
decl_stmt|,
name|dst_v
init|=
literal|1
decl_stmt|;
name|u32
name|src_h
init|=
literal|1
decl_stmt|,
name|dst_h
init|=
literal|1
decl_stmt|;
name|radeon_crtc
operator|->
name|h_border
operator|=
literal|0
expr_stmt|;
name|radeon_crtc
operator|->
name|v_border
operator|=
literal|0
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|encoder
argument_list|,
argument|&dev->mode_config.encoder_list
argument_list|,
argument|head
argument_list|)
block|{
if|if
condition|(
name|encoder
operator|->
name|crtc
operator|!=
name|crtc
condition|)
continue|continue;
name|radeon_encoder
operator|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
expr_stmt|;
name|connector
operator|=
name|radeon_get_connector_for_encoder
argument_list|(
name|encoder
argument_list|)
expr_stmt|;
name|radeon_connector
operator|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
condition|)
block|{
comment|/* set scaling */
if|if
condition|(
name|radeon_encoder
operator|->
name|rmx_type
operator|==
name|RMX_OFF
condition|)
name|radeon_crtc
operator|->
name|rmx_type
operator|=
name|RMX_OFF
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|->
name|hdisplay
operator|<
name|radeon_encoder
operator|->
name|native_mode
operator|.
name|hdisplay
operator|||
name|mode
operator|->
name|vdisplay
operator|<
name|radeon_encoder
operator|->
name|native_mode
operator|.
name|vdisplay
condition|)
name|radeon_crtc
operator|->
name|rmx_type
operator|=
name|radeon_encoder
operator|->
name|rmx_type
expr_stmt|;
else|else
name|radeon_crtc
operator|->
name|rmx_type
operator|=
name|RMX_OFF
expr_stmt|;
comment|/* copy native mode */
name|memcpy
argument_list|(
operator|&
name|radeon_crtc
operator|->
name|native_mode
argument_list|,
operator|&
name|radeon_encoder
operator|->
name|native_mode
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|drm_display_mode
argument_list|)
argument_list|)
expr_stmt|;
name|src_v
operator|=
name|crtc
operator|->
name|mode
operator|.
name|vdisplay
expr_stmt|;
name|dst_v
operator|=
name|radeon_crtc
operator|->
name|native_mode
operator|.
name|vdisplay
expr_stmt|;
name|src_h
operator|=
name|crtc
operator|->
name|mode
operator|.
name|hdisplay
expr_stmt|;
name|dst_h
operator|=
name|radeon_crtc
operator|->
name|native_mode
operator|.
name|hdisplay
expr_stmt|;
comment|/* fix up for overscan on hdmi */
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
operator|&&
operator|(
operator|!
operator|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_INTERLACE
operator|)
operator|)
operator|&&
operator|(
operator|(
name|radeon_encoder
operator|->
name|underscan_type
operator|==
name|UNDERSCAN_ON
operator|)
operator|||
operator|(
operator|(
name|radeon_encoder
operator|->
name|underscan_type
operator|==
name|UNDERSCAN_AUTO
operator|)
operator|&&
name|drm_detect_hdmi_monitor
argument_list|(
name|radeon_connector
operator|->
name|edid
argument_list|)
operator|&&
name|is_hdtv_mode
argument_list|(
name|mode
argument_list|)
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|radeon_encoder
operator|->
name|underscan_hborder
operator|!=
literal|0
condition|)
name|radeon_crtc
operator|->
name|h_border
operator|=
name|radeon_encoder
operator|->
name|underscan_hborder
expr_stmt|;
else|else
name|radeon_crtc
operator|->
name|h_border
operator|=
operator|(
name|mode
operator|->
name|hdisplay
operator|>>
literal|5
operator|)
operator|+
literal|16
expr_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|underscan_vborder
operator|!=
literal|0
condition|)
name|radeon_crtc
operator|->
name|v_border
operator|=
name|radeon_encoder
operator|->
name|underscan_vborder
expr_stmt|;
else|else
name|radeon_crtc
operator|->
name|v_border
operator|=
operator|(
name|mode
operator|->
name|vdisplay
operator|>>
literal|5
operator|)
operator|+
literal|16
expr_stmt|;
name|radeon_crtc
operator|->
name|rmx_type
operator|=
name|RMX_FULL
expr_stmt|;
name|src_v
operator|=
name|crtc
operator|->
name|mode
operator|.
name|vdisplay
expr_stmt|;
name|dst_v
operator|=
name|crtc
operator|->
name|mode
operator|.
name|vdisplay
operator|-
operator|(
name|radeon_crtc
operator|->
name|v_border
operator|*
literal|2
operator|)
expr_stmt|;
name|src_h
operator|=
name|crtc
operator|->
name|mode
operator|.
name|hdisplay
expr_stmt|;
name|dst_h
operator|=
name|crtc
operator|->
name|mode
operator|.
name|hdisplay
operator|-
operator|(
name|radeon_crtc
operator|->
name|h_border
operator|*
literal|2
operator|)
expr_stmt|;
block|}
name|first
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|radeon_crtc
operator|->
name|rmx_type
operator|!=
name|radeon_encoder
operator|->
name|rmx_type
condition|)
block|{
comment|/* WARNING: Right now this can't happen but 				 * in the future we need to check that scaling 				 * are consistent across different encoder 				 * (ie all encoder can work with the same 				 *  scaling). 				 */
name|DRM_ERROR
argument_list|(
literal|"Scaling not consistent across encoder.\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
block|}
if|if
condition|(
name|radeon_crtc
operator|->
name|rmx_type
operator|!=
name|RMX_OFF
condition|)
block|{
name|fixed20_12
name|a
decl_stmt|,
name|b
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|src_v
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|dst_v
argument_list|)
expr_stmt|;
name|radeon_crtc
operator|->
name|vsc
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|src_h
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|dst_h
argument_list|)
expr_stmt|;
name|radeon_crtc
operator|->
name|hsc
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_crtc
operator|->
name|vsc
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|radeon_crtc
operator|->
name|hsc
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_comment
comment|/*  * Retrieve current video scanout position of crtc on a given gpu.  *  * \param dev Device to query.  * \param crtc Crtc to query.  * \param *vpos Location where vertical scanout position should be stored.  * \param *hpos Location where horizontal scanout position should go.  *  * Returns vpos as a positive number while in active scanout area.  * Returns vpos as a negative number inside vblank, counting the number  * of scanlines to go until end of vblank, e.g., -1 means "one scanline  * until start of active scanout / end of vblank."  *  * \return Flags, or'ed together as follows:  *  * DRM_SCANOUTPOS_VALID = Query successful.  * DRM_SCANOUTPOS_INVBL = Inside vblank.  * DRM_SCANOUTPOS_ACCURATE = Returned position is accurate. A lack of  * this flag means that returned position may be offset by a constant but  * unknown small number of scanlines wrt. real scanout position.  *  */
end_comment

begin_function
name|int
name|radeon_get_crtc_scanoutpos
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|int
name|crtc
parameter_list|,
name|int
modifier|*
name|vpos
parameter_list|,
name|int
modifier|*
name|hpos
parameter_list|)
block|{
name|u32
name|stat_crtc
init|=
literal|0
decl_stmt|,
name|vbl
init|=
literal|0
decl_stmt|,
name|position
init|=
literal|0
decl_stmt|;
name|int
name|vbl_start
decl_stmt|,
name|vbl_end
decl_stmt|,
name|vtotal
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|bool
name|in_vbl
init|=
name|true
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|crtc
operator|==
literal|0
condition|)
block|{
name|vbl
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_V_BLANK_START_END
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|position
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_STATUS_POSITION
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|ret
operator||=
name|DRM_SCANOUTPOS_VALID
expr_stmt|;
block|}
if|if
condition|(
name|crtc
operator|==
literal|1
condition|)
block|{
name|vbl
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_V_BLANK_START_END
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|position
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_STATUS_POSITION
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|ret
operator||=
name|DRM_SCANOUTPOS_VALID
expr_stmt|;
block|}
if|if
condition|(
name|crtc
operator|==
literal|2
condition|)
block|{
name|vbl
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_V_BLANK_START_END
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|position
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_STATUS_POSITION
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|ret
operator||=
name|DRM_SCANOUTPOS_VALID
expr_stmt|;
block|}
if|if
condition|(
name|crtc
operator|==
literal|3
condition|)
block|{
name|vbl
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_V_BLANK_START_END
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|position
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_STATUS_POSITION
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|ret
operator||=
name|DRM_SCANOUTPOS_VALID
expr_stmt|;
block|}
if|if
condition|(
name|crtc
operator|==
literal|4
condition|)
block|{
name|vbl
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_V_BLANK_START_END
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|position
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_STATUS_POSITION
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|ret
operator||=
name|DRM_SCANOUTPOS_VALID
expr_stmt|;
block|}
if|if
condition|(
name|crtc
operator|==
literal|5
condition|)
block|{
name|vbl
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_V_BLANK_START_END
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|position
operator|=
name|RREG32
argument_list|(
name|EVERGREEN_CRTC_STATUS_POSITION
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|ret
operator||=
name|DRM_SCANOUTPOS_VALID
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|crtc
operator|==
literal|0
condition|)
block|{
name|vbl
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1CRTC_V_BLANK_START_END
argument_list|)
expr_stmt|;
name|position
operator|=
name|RREG32
argument_list|(
name|AVIVO_D1CRTC_STATUS_POSITION
argument_list|)
expr_stmt|;
name|ret
operator||=
name|DRM_SCANOUTPOS_VALID
expr_stmt|;
block|}
if|if
condition|(
name|crtc
operator|==
literal|1
condition|)
block|{
name|vbl
operator|=
name|RREG32
argument_list|(
name|AVIVO_D2CRTC_V_BLANK_START_END
argument_list|)
expr_stmt|;
name|position
operator|=
name|RREG32
argument_list|(
name|AVIVO_D2CRTC_STATUS_POSITION
argument_list|)
expr_stmt|;
name|ret
operator||=
name|DRM_SCANOUTPOS_VALID
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Pre-AVIVO: Different encoding of scanout pos and vblank interval. */
if|if
condition|(
name|crtc
operator|==
literal|0
condition|)
block|{
comment|/* Assume vbl_end == 0, get vbl_start from 			 * upper 16 bits. 			 */
name|vbl
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_CRTC_V_TOTAL_DISP
argument_list|)
operator|&
name|RADEON_CRTC_V_DISP
operator|)
operator|>>
name|RADEON_CRTC_V_DISP_SHIFT
expr_stmt|;
comment|/* Only retrieve vpos from upper 16 bits, set hpos == 0. */
name|position
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_CRTC_VLINE_CRNT_VLINE
argument_list|)
operator|>>
literal|16
operator|)
operator|&
name|RADEON_CRTC_V_TOTAL
expr_stmt|;
name|stat_crtc
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|stat_crtc
operator|&
literal|1
operator|)
condition|)
name|in_vbl
operator|=
name|false
expr_stmt|;
name|ret
operator||=
name|DRM_SCANOUTPOS_VALID
expr_stmt|;
block|}
if|if
condition|(
name|crtc
operator|==
literal|1
condition|)
block|{
name|vbl
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_CRTC2_V_TOTAL_DISP
argument_list|)
operator|&
name|RADEON_CRTC_V_DISP
operator|)
operator|>>
name|RADEON_CRTC_V_DISP_SHIFT
expr_stmt|;
name|position
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_CRTC2_VLINE_CRNT_VLINE
argument_list|)
operator|>>
literal|16
operator|)
operator|&
name|RADEON_CRTC_V_TOTAL
expr_stmt|;
name|stat_crtc
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|stat_crtc
operator|&
literal|1
operator|)
condition|)
name|in_vbl
operator|=
name|false
expr_stmt|;
name|ret
operator||=
name|DRM_SCANOUTPOS_VALID
expr_stmt|;
block|}
block|}
comment|/* Decode into vertical and horizontal scanout position. */
operator|*
name|vpos
operator|=
name|position
operator|&
literal|0x1fff
expr_stmt|;
operator|*
name|hpos
operator|=
operator|(
name|position
operator|>>
literal|16
operator|)
operator|&
literal|0x1fff
expr_stmt|;
comment|/* Valid vblank area boundaries from gpu retrieved? */
if|if
condition|(
name|vbl
operator|>
literal|0
condition|)
block|{
comment|/* Yes: Decode. */
name|ret
operator||=
name|DRM_SCANOUTPOS_ACCURATE
expr_stmt|;
name|vbl_start
operator|=
name|vbl
operator|&
literal|0x1fff
expr_stmt|;
name|vbl_end
operator|=
operator|(
name|vbl
operator|>>
literal|16
operator|)
operator|&
literal|0x1fff
expr_stmt|;
block|}
else|else
block|{
comment|/* No: Fake something reasonable which gives at least ok results. */
name|vbl_start
operator|=
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|crtc
index|]
operator|->
name|base
operator|.
name|hwmode
operator|.
name|crtc_vdisplay
expr_stmt|;
name|vbl_end
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Test scanout position against vblank region. */
if|if
condition|(
operator|(
operator|*
name|vpos
operator|<
name|vbl_start
operator|)
operator|&&
operator|(
operator|*
name|vpos
operator|>=
name|vbl_end
operator|)
condition|)
name|in_vbl
operator|=
name|false
expr_stmt|;
comment|/* Check if inside vblank area and apply corrective offsets: 	 * vpos will then be>=0 in video scanout area, but negative 	 * within vblank area, counting down the number of lines until 	 * start of scanout. 	 */
comment|/* Inside "upper part" of vblank area? Apply corrective offset if so: */
if|if
condition|(
name|in_vbl
operator|&&
operator|(
operator|*
name|vpos
operator|>=
name|vbl_start
operator|)
condition|)
block|{
name|vtotal
operator|=
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|crtc
index|]
operator|->
name|base
operator|.
name|hwmode
operator|.
name|crtc_vtotal
expr_stmt|;
operator|*
name|vpos
operator|=
operator|*
name|vpos
operator|-
name|vtotal
expr_stmt|;
block|}
comment|/* Correct for shifted end of vbl at vbl_end. */
operator|*
name|vpos
operator|=
operator|*
name|vpos
operator|-
name|vbl_end
expr_stmt|;
comment|/* In vblank? */
if|if
condition|(
name|in_vbl
condition|)
name|ret
operator||=
name|DRM_SCANOUTPOS_INVBL
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


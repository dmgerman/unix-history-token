begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"rv770d.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"avivod.h"
end_include

begin_define
define|#
directive|define
name|R700_PFP_UCODE_SIZE
value|848
end_define

begin_define
define|#
directive|define
name|R700_PM4_UCODE_SIZE
value|1360
end_define

begin_function_decl
specifier|static
name|void
name|rv770_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rv770_pcie_gen2_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|u32
name|rv770_page_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc_id
parameter_list|,
name|u64
name|crtc_base
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|crtc_id
index|]
decl_stmt|;
name|u32
name|tmp
init|=
name|RREG32
argument_list|(
name|AVIVO_D1GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Lock the graphics update lock */
name|tmp
operator||=
name|AVIVO_D1GRPH_UPDATE_LOCK
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* update the scanout addresses */
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
block|{
name|WREG32
argument_list|(
name|D2GRPH_SECONDARY_SURFACE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|crtc_base
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|D2GRPH_PRIMARY_SURFACE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|crtc_base
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|D1GRPH_SECONDARY_SURFACE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|crtc_base
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|D1GRPH_PRIMARY_SURFACE_ADDRESS_HIGH
argument_list|,
name|upper_32_bits
argument_list|(
name|crtc_base
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|D1GRPH_SECONDARY_SURFACE_ADDRESS
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|u32
operator|)
name|crtc_base
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|D1GRPH_PRIMARY_SURFACE_ADDRESS
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|u32
operator|)
name|crtc_base
argument_list|)
expr_stmt|;
comment|/* Wait for update_pending to go high. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|AVIVO_D1GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
operator|&
name|AVIVO_D1GRPH_SURFACE_UPDATE_PENDING
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"Update pending now high. Unlocking vupdate_lock.\n"
argument_list|)
expr_stmt|;
comment|/* Unlock the lock, so double-buffering can take place inside vblank */
name|tmp
operator|&=
operator|~
name|AVIVO_D1GRPH_UPDATE_LOCK
expr_stmt|;
name|WREG32
argument_list|(
name|AVIVO_D1GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Return current update_pending status: */
return|return
name|RREG32
argument_list|(
name|AVIVO_D1GRPH_UPDATE
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
operator|&
name|AVIVO_D1GRPH_SURFACE_UPDATE_PENDING
return|;
block|}
end_function

begin_comment
comment|/* get temperature in millidegrees */
end_comment

begin_function
name|int
name|rv770_get_temp
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|temp
init|=
operator|(
name|RREG32
argument_list|(
name|CG_MULT_THERMAL_STATUS
argument_list|)
operator|&
name|ASIC_T_MASK
operator|)
operator|>>
name|ASIC_T_SHIFT
decl_stmt|;
name|int
name|actual_temp
decl_stmt|;
if|if
condition|(
name|temp
operator|&
literal|0x400
condition|)
name|actual_temp
operator|=
operator|-
literal|256
expr_stmt|;
elseif|else
if|if
condition|(
name|temp
operator|&
literal|0x200
condition|)
name|actual_temp
operator|=
literal|255
expr_stmt|;
elseif|else
if|if
condition|(
name|temp
operator|&
literal|0x100
condition|)
block|{
name|actual_temp
operator|=
name|temp
operator|&
literal|0x1ff
expr_stmt|;
name|actual_temp
operator||=
operator|~
literal|0x1ff
expr_stmt|;
block|}
else|else
name|actual_temp
operator|=
name|temp
operator|&
literal|0xff
expr_stmt|;
return|return
operator|(
name|actual_temp
operator|*
literal|1000
operator|)
operator|/
literal|2
return|;
block|}
end_function

begin_function
name|void
name|rv770_pm_misc
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|req_ps_idx
init|=
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
decl_stmt|;
name|int
name|req_cm_idx
init|=
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
decl_stmt|;
name|struct
name|radeon_power_state
modifier|*
name|ps
init|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|req_ps_idx
index|]
decl_stmt|;
name|struct
name|radeon_voltage
modifier|*
name|voltage
init|=
operator|&
name|ps
operator|->
name|clock_info
index|[
name|req_cm_idx
index|]
operator|.
name|voltage
decl_stmt|;
if|if
condition|(
operator|(
name|voltage
operator|->
name|type
operator|==
name|VOLTAGE_SW
operator|)
operator|&&
name|voltage
operator|->
name|voltage
condition|)
block|{
comment|/* 0xff01 is a flag rather then an actual voltage */
if|if
condition|(
name|voltage
operator|->
name|voltage
operator|==
literal|0xff01
condition|)
return|return;
if|if
condition|(
name|voltage
operator|->
name|voltage
operator|!=
name|rdev
operator|->
name|pm
operator|.
name|current_vddc
condition|)
block|{
name|radeon_atom_set_voltage
argument_list|(
name|rdev
argument_list|,
name|voltage
operator|->
name|voltage
argument_list|,
name|SET_VOLTAGE_TYPE_ASIC_VDDC
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|current_vddc
operator|=
name|voltage
operator|->
name|voltage
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"Setting: v: %d\n"
argument_list|,
name|voltage
operator|->
name|voltage
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * GART  */
end_comment

begin_function
specifier|static
name|int
name|rv770_pcie_gart_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|r
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"No VRAM object for PCIE GART.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_gart_table_vram_pin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|radeon_gart_restore
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_CACHE
operator||
name|ENABLE_L2_FRAGMENT_PROCESSING
operator||
name|ENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|BANK_SELECT
argument_list|(
literal|0
argument_list|)
operator||
name|CACHE_UPDATE_MODE
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|tmp
operator|=
name|ENABLE_L1_TLB
operator||
name|ENABLE_L1_FRAGMENT_PROCESSING
operator||
name|SYSTEM_ACCESS_MODE_NOT_IN_SYS
operator||
name|SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU
operator||
name|EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV740
condition|)
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB3_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB3_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_START_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_END_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
argument_list|,
name|rdev
operator|->
name|gart
operator|.
name|table_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
argument_list|,
name|ENABLE_CONTEXT
operator||
name|PAGE_TABLE_DEPTH
argument_list|(
literal|0
argument_list|)
operator||
name|RANGE_PROTECTION_FAULT_ENABLE_DEFAULT
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PROTECTION_FAULT_DEFAULT_ADDR
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|rdev
operator|->
name|dummy_page
operator|.
name|addr
operator|>>
literal|12
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|r600_pcie_gart_tlb_flush
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"PCIE GART of %uM enabled (table at 0x%016llX).\n"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|ready
operator|=
name|true
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rv770_pcie_gart_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Disable all tables */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_FRAGMENT_PROCESSING
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|BANK_SELECT
argument_list|(
literal|0
argument_list|)
operator||
name|CACHE_UPDATE_MODE
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|tmp
operator|=
name|EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB3_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_unpin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rv770_pcie_gart_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|radeon_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv770_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_free
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rv770_agp_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_CACHE
operator||
name|ENABLE_L2_FRAGMENT_PROCESSING
operator||
name|ENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|BANK_SELECT
argument_list|(
literal|0
argument_list|)
operator||
name|CACHE_UPDATE_MODE
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|tmp
operator|=
name|ENABLE_L1_TLB
operator||
name|ENABLE_L1_FRAGMENT_PROCESSING
operator||
name|SYSTEM_ACCESS_MODE_NOT_IN_SYS
operator||
name|SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU
operator||
name|EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MD_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_MB_L1_TLB3_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rv770_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|rv515_mc_save
name|save
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Initialize HDP */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
operator|,
name|j
operator|+=
literal|0x18
control|)
block|{
name|WREG32
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
comment|/* r7xx hw bug.  Read from HDP_DEBUG1 rather 	 * than writing to HDP_REG_COHERENCY_FLUSH_CNTL 	 */
name|tmp
operator|=
name|RREG32
argument_list|(
name|HDP_DEBUG1
argument_list|)
expr_stmt|;
name|rv515_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|r600_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Lockout access through VGA aperture*/
name|WREG32
argument_list|(
name|VGA_HDP_CONTROL
argument_list|,
name|VGA_MEMORY_DISABLE
argument_list|)
expr_stmt|;
comment|/* Update configuration */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|<
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
condition|)
block|{
comment|/* VRAM before AGP */
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* VRAM after AGP */
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_DEFAULT_ADDR
argument_list|,
name|rdev
operator|->
name|vram_scratch
operator|.
name|gpu_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|24
operator|)
operator|&
literal|0xFFFF
operator|)
operator|<<
literal|16
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|24
operator|)
operator|&
literal|0xFFFF
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_FB_LOCATION
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_BASE
argument_list|,
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_INFO
argument_list|,
operator|(
literal|2
operator|<<
literal|7
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_SIZE
argument_list|,
literal|0x3FFFFFFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|WREG32
argument_list|(
name|MC_VM_AGP_TOP
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BOT
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BASE
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|agp_base
operator|>>
literal|22
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|MC_VM_AGP_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_TOP
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BOT
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r600_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
name|rv515_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
comment|/* we need to own VRAM, so turn off the VGA renderer here 	 * to stop it overwriting our objects */
name|rv515_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * CP.  */
end_comment

begin_function
name|void
name|r700_cp_stop
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|radeon_ttm_set_active_vram_size
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_CNTL
argument_list|,
operator|(
name|CP_ME_HALT
operator||
name|CP_PFP_HALT
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rv770_cp_load_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|__be32
modifier|*
name|fw_data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
condition|)
return|return
operator|-
name|EINVAL
return|;
name|r700_cp_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_CNTL
argument_list|,
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|BUF_SWAP_32BIT
operator||
endif|#
directive|endif
name|RB_NO_UPDATE
operator||
name|RB_BLKSZ
argument_list|(
literal|15
argument_list|)
operator||
name|RB_BUFSZ
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Reset cp */
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
name|SOFT_RESET_CP
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|pfp_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|R700_PFP_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_PFP_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|me_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|R700_PM4_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_ME_RAM_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_RADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r700_cp_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|r700_cp_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ring_fini
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|ring
operator|->
name|rptr_save_reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Core functions  */
end_comment

begin_function
specifier|static
name|void
name|rv770_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|num_qd_pipes
decl_stmt|;
name|u32
name|ta_aux_cntl
decl_stmt|;
name|u32
name|sx_debug_1
decl_stmt|;
name|u32
name|smx_dc_ctl0
decl_stmt|;
name|u32
name|db_debug3
decl_stmt|;
name|u32
name|num_gs_verts_per_thread
decl_stmt|;
name|u32
name|vgt_gs_per_es
decl_stmt|;
name|u32
name|gs_prim_buffer_depth
init|=
literal|0
decl_stmt|;
name|u32
name|sq_ms_fifo_sizes
decl_stmt|;
name|u32
name|sq_config
decl_stmt|;
name|u32
name|sq_thread_resource_mgmt
decl_stmt|;
name|u32
name|hdp_host_path_cntl
decl_stmt|;
name|u32
name|sq_dyn_gpr_size_simd_ab_0
decl_stmt|;
name|u32
name|gb_tiling_config
init|=
literal|0
decl_stmt|;
name|u32
name|cc_rb_backend_disable
init|=
literal|0
decl_stmt|;
name|u32
name|cc_gc_shader_pipe_config
init|=
literal|0
decl_stmt|;
name|u32
name|mc_arb_ramcfg
decl_stmt|;
name|u32
name|db_debug4
decl_stmt|,
name|tmp
decl_stmt|;
name|u32
name|inactive_pipes
decl_stmt|,
name|shader_pipe_config
decl_stmt|;
name|u32
name|disabled_rb_mask
decl_stmt|;
name|unsigned
name|active_number
decl_stmt|;
comment|/* setup chip specs */
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|tiling_group_size
operator|=
literal|256
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_RV770
case|:
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_tile_pipes
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_simds
operator|=
literal|10
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_backends
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_threads
operator|=
literal|248
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_stack_entries
operator|=
literal|512
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gs_threads
operator|=
literal|16
operator|*
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_smx_size
operator|=
literal|112
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_num_of_sets
operator|=
literal|7
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_prim_fifo_size
operator|=
literal|0xF9
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_earlyz_tile_fifo_fize
operator|=
literal|0x130
expr_stmt|;
break|break;
case|case
name|CHIP_RV730
case|:
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_simds
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_backends
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_threads
operator|=
literal|248
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_stack_entries
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gs_threads
operator|=
literal|16
operator|*
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_pos_size
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_smx_size
operator|=
literal|224
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_num_of_sets
operator|=
literal|7
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_prim_fifo_size
operator|=
literal|0xf9
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_earlyz_tile_fifo_fize
operator|=
literal|0x130
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_pos_size
operator|>
literal|16
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_pos_size
operator|-=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_smx_size
operator|+=
literal|16
expr_stmt|;
block|}
break|break;
case|case
name|CHIP_RV710
case|:
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_tile_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_simds
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_backends
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_threads
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_stack_entries
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_hw_contexts
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gs_threads
operator|=
literal|8
operator|*
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_smx_size
operator|=
literal|112
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sq_num_cf_insts
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_num_of_sets
operator|=
literal|7
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x40
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_earlyz_tile_fifo_fize
operator|=
literal|0x130
expr_stmt|;
break|break;
case|case
name|CHIP_RV740
case|:
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_simds
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_backends
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_threads
operator|=
literal|248
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_stack_entries
operator|=
literal|512
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gs_threads
operator|=
literal|16
operator|*
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_pos_size
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_smx_size
operator|=
literal|224
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_num_of_sets
operator|=
literal|7
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x100
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_earlyz_tile_fifo_fize
operator|=
literal|0x130
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_pos_size
operator|>
literal|16
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_pos_size
operator|-=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_smx_size
operator|+=
literal|16
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
comment|/* Initialize HDP */
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|j
operator|+=
literal|0x18
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|GRBM_CNTL
argument_list|,
name|GRBM_READ_TIMEOUT
argument_list|(
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup tiling, simd, pipe config */
name|mc_arb_ramcfg
operator|=
name|RREG32
argument_list|(
name|MC_ARB_RAMCFG
argument_list|)
expr_stmt|;
name|shader_pipe_config
operator|=
name|RREG32
argument_list|(
name|CC_GC_SHADER_PIPE_CONFIG
argument_list|)
expr_stmt|;
name|inactive_pipes
operator|=
operator|(
name|shader_pipe_config
operator|&
name|INACTIVE_QD_PIPES_MASK
operator|)
operator|>>
name|INACTIVE_QD_PIPES_SHIFT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|tmp
operator|=
literal|1
operator|,
name|active_number
operator|=
literal|0
init|;
name|i
operator|<
name|R7XX_MAX_PIPES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|inactive_pipes
operator|&
name|tmp
operator|)
condition|)
block|{
name|active_number
operator|++
expr_stmt|;
block|}
name|tmp
operator|<<=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|active_number
operator|==
literal|1
condition|)
block|{
name|WREG32
argument_list|(
name|SPI_CONFIG_CNTL
argument_list|,
name|DISABLE_INTERP_1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|SPI_CONFIG_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|cc_rb_backend_disable
operator|=
name|RREG32
argument_list|(
name|CC_RB_BACKEND_DISABLE
argument_list|)
operator|&
literal|0x00ff0000
expr_stmt|;
name|tmp
operator|=
name|R7XX_MAX_BACKENDS
operator|-
name|r600_count_pipe_bits
argument_list|(
name|cc_rb_backend_disable
operator|>>
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_backends
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_backends
operator|=
name|tmp
expr_stmt|;
block|}
name|cc_gc_shader_pipe_config
operator|=
name|RREG32
argument_list|(
name|CC_GC_SHADER_PIPE_CONFIG
argument_list|)
operator|&
literal|0xffffff00
expr_stmt|;
name|tmp
operator|=
name|R7XX_MAX_PIPES
operator|-
name|r600_count_pipe_bits
argument_list|(
operator|(
name|cc_gc_shader_pipe_config
operator|>>
literal|8
operator|)
operator|&
name|R7XX_MAX_PIPES_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_pipes
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_pipes
operator|=
name|tmp
expr_stmt|;
block|}
name|tmp
operator|=
name|R7XX_MAX_SIMDS
operator|-
name|r600_count_pipe_bits
argument_list|(
operator|(
name|cc_gc_shader_pipe_config
operator|>>
literal|16
operator|)
operator|&
name|R7XX_MAX_SIMDS_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_simds
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_simds
operator|=
name|tmp
expr_stmt|;
block|}
switch|switch
condition|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_tile_pipes
condition|)
block|{
case|case
literal|1
case|:
default|default:
name|gb_tiling_config
operator|=
name|PIPE_TILING
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|gb_tiling_config
operator|=
name|PIPE_TILING
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|gb_tiling_config
operator|=
name|PIPE_TILING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|gb_tiling_config
operator|=
name|PIPE_TILING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
break|break;
block|}
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|tiling_npipes
operator|=
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_tile_pipes
expr_stmt|;
name|disabled_rb_mask
operator|=
operator|(
name|RREG32
argument_list|(
name|CC_RB_BACKEND_DISABLE
argument_list|)
operator|>>
literal|16
operator|)
operator|&
name|R7XX_MAX_BACKENDS_MASK
expr_stmt|;
name|tmp
operator|=
operator|(
name|gb_tiling_config
operator|&
name|PIPE_TILING__MASK
operator|)
operator|>>
name|PIPE_TILING__SHIFT
expr_stmt|;
name|tmp
operator|=
name|r6xx_remap_render_backend
argument_list|(
name|rdev
argument_list|,
name|tmp
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_backends
argument_list|,
name|R7XX_MAX_BACKENDS
argument_list|,
name|disabled_rb_mask
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|tmp
operator|<<
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|backend_map
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV770
condition|)
name|gb_tiling_config
operator||=
name|BANK_TILING
argument_list|(
literal|1
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
name|mc_arb_ramcfg
operator|&
name|NOOFBANK_MASK
operator|)
operator|>>
name|NOOFBANK_SHIFT
condition|)
name|gb_tiling_config
operator||=
name|BANK_TILING
argument_list|(
literal|1
argument_list|)
expr_stmt|;
else|else
name|gb_tiling_config
operator||=
name|BANK_TILING
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|tiling_nbanks
operator|=
literal|4
operator|<<
operator|(
operator|(
name|gb_tiling_config
operator|>>
literal|4
operator|)
operator|&
literal|0x3
operator|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|GROUP_SIZE
argument_list|(
operator|(
name|mc_arb_ramcfg
operator|&
name|BURSTLENGTH_MASK
operator|)
operator|>>
name|BURSTLENGTH_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mc_arb_ramcfg
operator|&
name|NOOFROWS_MASK
operator|)
operator|>>
name|NOOFROWS_SHIFT
operator|)
operator|>
literal|3
condition|)
block|{
name|gb_tiling_config
operator||=
name|ROW_TILING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|SAMPLE_SPLIT
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gb_tiling_config
operator||=
name|ROW_TILING
argument_list|(
operator|(
operator|(
name|mc_arb_ramcfg
operator|&
name|NOOFROWS_MASK
operator|)
operator|>>
name|NOOFROWS_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|SAMPLE_SPLIT
argument_list|(
operator|(
operator|(
name|mc_arb_ramcfg
operator|&
name|NOOFROWS_MASK
operator|)
operator|>>
name|NOOFROWS_SHIFT
operator|)
argument_list|)
expr_stmt|;
block|}
name|gb_tiling_config
operator||=
name|BANK_SWAPS
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|tile_config
operator|=
name|gb_tiling_config
expr_stmt|;
name|WREG32
argument_list|(
name|GB_TILING_CONFIG
argument_list|,
name|gb_tiling_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DCP_TILING_CONFIG
argument_list|,
operator|(
name|gb_tiling_config
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_TILING_CONFIG
argument_list|,
operator|(
name|gb_tiling_config
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_TILING_CONFIG
argument_list|,
operator|(
name|gb_tiling_config
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_TILING_CONFIG2
argument_list|,
operator|(
name|gb_tiling_config
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_SYS_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_USER_SYS_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_USER_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|num_qd_pipes
operator|=
name|R7XX_MAX_PIPES
operator|-
name|r600_count_pipe_bits
argument_list|(
operator|(
name|cc_gc_shader_pipe_config
operator|&
name|INACTIVE_QD_PIPES_MASK
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_OUT_DEALLOC_CNTL
argument_list|,
operator|(
name|num_qd_pipes
operator|*
literal|4
operator|)
operator|&
name|DEALLOC_DIST_MASK
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_VERTEX_REUSE_BLOCK_CNTL
argument_list|,
operator|(
operator|(
name|num_qd_pipes
operator|*
literal|4
operator|)
operator|-
literal|2
operator|)
operator|&
name|VTX_REUSE_DEPTH_MASK
argument_list|)
expr_stmt|;
comment|/* set HW defaults for 3D engine */
name|WREG32
argument_list|(
name|CP_QUEUE_THRESHOLDS
argument_list|,
operator|(
name|ROQ_IB1_START
argument_list|(
literal|0x16
argument_list|)
operator||
name|ROQ_IB2_START
argument_list|(
literal|0x2b
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_MEQ_THRESHOLDS
argument_list|,
name|STQ_SPLIT
argument_list|(
literal|0x30
argument_list|)
argument_list|)
expr_stmt|;
name|ta_aux_cntl
operator|=
name|RREG32
argument_list|(
name|TA_CNTL_AUX
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|TA_CNTL_AUX
argument_list|,
name|ta_aux_cntl
operator||
name|DISABLE_CUBE_ANISO
argument_list|)
expr_stmt|;
name|sx_debug_1
operator|=
name|RREG32
argument_list|(
name|SX_DEBUG_1
argument_list|)
expr_stmt|;
name|sx_debug_1
operator||=
name|ENABLE_NEW_SMX_ADDRESS
expr_stmt|;
name|WREG32
argument_list|(
name|SX_DEBUG_1
argument_list|,
name|sx_debug_1
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator|=
name|RREG32
argument_list|(
name|SMX_DC_CTL0
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator|&=
operator|~
name|CACHE_DEPTH
argument_list|(
literal|0x1ff
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator||=
name|CACHE_DEPTH
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_num_of_sets
operator|*
literal|64
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SMX_DC_CTL0
argument_list|,
name|smx_dc_ctl0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|!=
name|CHIP_RV740
condition|)
name|WREG32
argument_list|(
name|SMX_EVENT_CTL
argument_list|,
operator|(
name|ES_FLUSH_CTL
argument_list|(
literal|4
argument_list|)
operator||
name|GS_FLUSH_CTL
argument_list|(
literal|4
argument_list|)
operator||
name|ACK_FLUSH_CTL
argument_list|(
literal|3
argument_list|)
operator||
name|SYNC_FLUSH_CTL
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|!=
name|CHIP_RV770
condition|)
name|WREG32
argument_list|(
name|SMX_SAR_CTL0
argument_list|,
literal|0x00003f3f
argument_list|)
expr_stmt|;
name|db_debug3
operator|=
name|RREG32
argument_list|(
name|DB_DEBUG3
argument_list|)
expr_stmt|;
name|db_debug3
operator|&=
operator|~
name|DB_CLK_OFF_DELAY
argument_list|(
literal|0x1f
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_RV770
case|:
case|case
name|CHIP_RV740
case|:
name|db_debug3
operator||=
name|DB_CLK_OFF_DELAY
argument_list|(
literal|0x1f
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHIP_RV710
case|:
case|case
name|CHIP_RV730
case|:
default|default:
name|db_debug3
operator||=
name|DB_CLK_OFF_DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
name|WREG32
argument_list|(
name|DB_DEBUG3
argument_list|,
name|db_debug3
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|!=
name|CHIP_RV770
condition|)
block|{
name|db_debug4
operator|=
name|RREG32
argument_list|(
name|DB_DEBUG4
argument_list|)
expr_stmt|;
name|db_debug4
operator||=
name|DISABLE_TILE_COVERED_FOR_PS_ITER
expr_stmt|;
name|WREG32
argument_list|(
name|DB_DEBUG4
argument_list|,
name|db_debug4
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|SX_EXPORT_BUFFER_SIZES
argument_list|,
operator|(
name|COLOR_BUFFER_SIZE
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator||
name|POSITION_BUFFER_SIZE
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_pos_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator||
name|SMX_BUFFER_SIZE
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sx_max_export_smx_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_FIFO_SIZE
argument_list|,
operator|(
name|SC_PRIM_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_prim_fifo_size
argument_list|)
operator||
name|SC_HIZ_TILE_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_hiz_tile_fifo_size
argument_list|)
operator||
name|SC_EARLYZ_TILE_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sc_earlyz_tile_fifo_fize
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_MULTI_CHIP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_NUM_INSTANCES
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_CONFIG_CNTL_1
argument_list|,
name|VTX_DONE_DELAY
argument_list|(
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PERFMON_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sq_ms_fifo_sizes
operator|=
operator|(
name|CACHE_FIFO_SIZE
argument_list|(
literal|16
operator|*
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|sq_num_cf_insts
argument_list|)
operator||
name|DONE_FIFO_HIWATER
argument_list|(
literal|0xe0
argument_list|)
operator||
name|ALU_UPDATE_FIFO_HIWATER
argument_list|(
literal|0x8
argument_list|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_RV770
case|:
case|case
name|CHIP_RV730
case|:
case|case
name|CHIP_RV710
case|:
name|sq_ms_fifo_sizes
operator||=
name|FETCH_FIFO_HIWATER
argument_list|(
literal|0x1
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHIP_RV740
case|:
default|default:
name|sq_ms_fifo_sizes
operator||=
name|FETCH_FIFO_HIWATER
argument_list|(
literal|0x4
argument_list|)
expr_stmt|;
break|break;
block|}
name|WREG32
argument_list|(
name|SQ_MS_FIFO_SIZES
argument_list|,
name|sq_ms_fifo_sizes
argument_list|)
expr_stmt|;
comment|/* SQ_CONFIG, SQ_GPR_RESOURCE_MGMT, SQ_THREAD_RESOURCE_MGMT, SQ_STACK_RESOURCE_MGMT 	 * should be adjusted as needed by the 2D/3D drivers.  This just sets default values 	 */
name|sq_config
operator|=
name|RREG32
argument_list|(
name|SQ_CONFIG
argument_list|)
expr_stmt|;
name|sq_config
operator|&=
operator|~
operator|(
name|PS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|VS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|GS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|ES_PRIO
argument_list|(
literal|3
argument_list|)
operator|)
expr_stmt|;
name|sq_config
operator||=
operator|(
name|DX9_CONSTS
operator||
name|VC_ENABLE
operator||
name|EXPORT_SRC_C
operator||
name|PS_PRIO
argument_list|(
literal|0
argument_list|)
operator||
name|VS_PRIO
argument_list|(
literal|1
argument_list|)
operator||
name|GS_PRIO
argument_list|(
literal|2
argument_list|)
operator||
name|ES_PRIO
argument_list|(
literal|3
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV710
condition|)
comment|/* no vertex cache */
name|sq_config
operator|&=
operator|~
name|VC_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_CONFIG
argument_list|,
name|sq_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_GPR_RESOURCE_MGMT_1
argument_list|,
operator|(
name|NUM_PS_GPRS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|*
literal|24
operator|)
operator|/
literal|64
argument_list|)
operator||
name|NUM_VS_GPRS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|*
literal|24
operator|)
operator|/
literal|64
argument_list|)
operator||
name|NUM_CLAUSE_TEMP_GPRS
argument_list|(
operator|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|*
literal|24
operator|)
operator|/
literal|64
operator|)
operator|/
literal|2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_GPR_RESOURCE_MGMT_2
argument_list|,
operator|(
name|NUM_GS_GPRS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|*
literal|7
operator|)
operator|/
literal|64
argument_list|)
operator||
name|NUM_ES_GPRS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|*
literal|7
operator|)
operator|/
literal|64
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator|=
operator|(
name|NUM_PS_THREADS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_threads
operator|*
literal|4
operator|)
operator|/
literal|8
argument_list|)
operator||
name|NUM_VS_THREADS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_threads
operator|*
literal|2
operator|)
operator|/
literal|8
argument_list|)
operator||
name|NUM_ES_THREADS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_threads
operator|*
literal|1
operator|)
operator|/
literal|8
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_threads
operator|*
literal|1
operator|)
operator|/
literal|8
operator|)
operator|>
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gs_threads
condition|)
name|sq_thread_resource_mgmt
operator||=
name|NUM_GS_THREADS
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gs_threads
argument_list|)
expr_stmt|;
else|else
name|sq_thread_resource_mgmt
operator||=
name|NUM_GS_THREADS
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gs_threads
operator|*
literal|1
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_THREAD_RESOURCE_MGMT
argument_list|,
name|sq_thread_resource_mgmt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_STACK_RESOURCE_MGMT_1
argument_list|,
operator|(
name|NUM_PS_STACK_ENTRIES
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|4
argument_list|)
operator||
name|NUM_VS_STACK_ENTRIES
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_STACK_RESOURCE_MGMT_2
argument_list|,
operator|(
name|NUM_GS_STACK_ENTRIES
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|4
argument_list|)
operator||
name|NUM_ES_STACK_ENTRIES
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sq_dyn_gpr_size_simd_ab_0
operator|=
operator|(
name|SIMDA_RING0
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|*
literal|38
operator|)
operator|/
literal|64
argument_list|)
operator||
name|SIMDA_RING1
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|*
literal|38
operator|)
operator|/
literal|64
argument_list|)
operator||
name|SIMDB_RING0
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|*
literal|38
operator|)
operator|/
literal|64
argument_list|)
operator||
name|SIMDB_RING1
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_gprs
operator|*
literal|38
operator|)
operator|/
literal|64
argument_list|)
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_DYN_GPR_SIZE_SIMD_AB_0
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_DYN_GPR_SIZE_SIMD_AB_1
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_DYN_GPR_SIZE_SIMD_AB_2
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_DYN_GPR_SIZE_SIMD_AB_3
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_DYN_GPR_SIZE_SIMD_AB_4
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_DYN_GPR_SIZE_SIMD_AB_5
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_DYN_GPR_SIZE_SIMD_AB_6
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_DYN_GPR_SIZE_SIMD_AB_7
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_FORCE_EOV_MAX_CNTS
argument_list|,
operator|(
name|FORCE_EOV_MAX_CLK_CNT
argument_list|(
literal|4095
argument_list|)
operator||
name|FORCE_EOV_MAX_REZ_CNT
argument_list|(
literal|255
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV710
condition|)
name|WREG32
argument_list|(
name|VGT_CACHE_INVALIDATION
argument_list|,
operator|(
name|CACHE_INVALIDATION
argument_list|(
name|TC_ONLY
argument_list|)
operator||
name|AUTO_INVLD_EN
argument_list|(
name|ES_AND_GS_AUTO
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|VGT_CACHE_INVALIDATION
argument_list|,
operator|(
name|CACHE_INVALIDATION
argument_list|(
name|VC_AND_TC
argument_list|)
operator||
name|AUTO_INVLD_EN
argument_list|(
name|ES_AND_GS_AUTO
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_RV770
case|:
case|case
name|CHIP_RV730
case|:
case|case
name|CHIP_RV740
case|:
name|gs_prim_buffer_depth
operator|=
literal|384
expr_stmt|;
break|break;
case|case
name|CHIP_RV710
case|:
name|gs_prim_buffer_depth
operator|=
literal|128
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|num_gs_verts_per_thread
operator|=
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_pipes
operator|*
literal|16
expr_stmt|;
name|vgt_gs_per_es
operator|=
name|gs_prim_buffer_depth
operator|+
name|num_gs_verts_per_thread
expr_stmt|;
comment|/* Max value for this is 256 */
if|if
condition|(
name|vgt_gs_per_es
operator|>
literal|256
condition|)
name|vgt_gs_per_es
operator|=
literal|256
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_ES_PER_GS
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_GS_PER_ES
argument_list|,
name|vgt_gs_per_es
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_GS_PER_VS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* more default values. 2D/3D driver should adjust as needed */
name|WREG32
argument_list|(
name|VGT_GS_VERTEX_REUSE
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_LINE_STIPPLE_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_STRMOUT_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SX_MISC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_MODE_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_EDGERULE
argument_list|,
literal|0xaaaaaaaa
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_AA_CONFIG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_CLIPRECT_RULE
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_LINE_STIPPLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_INPUT_Z
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_PS_IN_CONTROL_0
argument_list|,
name|NUM_INTERP
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR7_FRAG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* clear render buffer base addresses */
name|WREG32
argument_list|(
name|CB_COLOR0_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR1_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR2_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR3_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR4_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR5_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR6_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR7_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|TCP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hdp_host_path_cntl
operator|=
name|RREG32
argument_list|(
name|HDP_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_HOST_PATH_CNTL
argument_list|,
name|hdp_host_path_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_MULTI_CHIP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_CL_ENHANCE
argument_list|,
operator|(
name|CLIP_VTX_REORDER_ENA
operator||
name|NUM_CLIP_SEQ
argument_list|(
literal|3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VC_ENHANCE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r700_vram_gtt_location
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_mc
modifier|*
name|mc
parameter_list|)
block|{
name|u64
name|size_bf
decl_stmt|,
name|size_af
decl_stmt|;
if|if
condition|(
name|mc
operator|->
name|mc_vram_size
operator|>
literal|0xE0000000
condition|)
block|{
comment|/* leave room for at least 512M GTT */
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"limiting VRAM\n"
argument_list|)
expr_stmt|;
name|mc
operator|->
name|real_vram_size
operator|=
literal|0xE0000000
expr_stmt|;
name|mc
operator|->
name|mc_vram_size
operator|=
literal|0xE0000000
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|size_bf
operator|=
name|mc
operator|->
name|gtt_start
expr_stmt|;
name|size_af
operator|=
literal|0xFFFFFFFF
operator|-
name|mc
operator|->
name|gtt_end
expr_stmt|;
if|if
condition|(
name|size_bf
operator|>
name|size_af
condition|)
block|{
if|if
condition|(
name|mc
operator|->
name|mc_vram_size
operator|>
name|size_bf
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"limiting VRAM\n"
argument_list|)
expr_stmt|;
name|mc
operator|->
name|real_vram_size
operator|=
name|size_bf
expr_stmt|;
name|mc
operator|->
name|mc_vram_size
operator|=
name|size_bf
expr_stmt|;
block|}
name|mc
operator|->
name|vram_start
operator|=
name|mc
operator|->
name|gtt_start
operator|-
name|mc
operator|->
name|mc_vram_size
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mc
operator|->
name|mc_vram_size
operator|>
name|size_af
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"limiting VRAM\n"
argument_list|)
expr_stmt|;
name|mc
operator|->
name|real_vram_size
operator|=
name|size_af
expr_stmt|;
name|mc
operator|->
name|mc_vram_size
operator|=
name|size_af
expr_stmt|;
block|}
name|mc
operator|->
name|vram_start
operator|=
name|mc
operator|->
name|gtt_end
operator|+
literal|1
expr_stmt|;
block|}
name|mc
operator|->
name|vram_end
operator|=
name|mc
operator|->
name|vram_start
operator|+
name|mc
operator|->
name|mc_vram_size
operator|-
literal|1
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"VRAM: %juM 0x%08jX - 0x%08jX (%juM used)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|mc_vram_size
operator|>>
literal|20
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|vram_start
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|vram_end
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|real_vram_size
operator|>>
literal|20
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_vram_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_base_align
operator|=
literal|0
expr_stmt|;
name|radeon_gtt_location
argument_list|(
name|rdev
argument_list|,
name|mc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rv770_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|chansize
decl_stmt|,
name|numchan
decl_stmt|;
comment|/* Get VRAM informations */
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|MC_ARB_RAMCFG
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|CHANSIZE_OVERRIDE
condition|)
block|{
name|chansize
operator|=
literal|16
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tmp
operator|&
name|CHANSIZE_MASK
condition|)
block|{
name|chansize
operator|=
literal|64
expr_stmt|;
block|}
else|else
block|{
name|chansize
operator|=
literal|32
expr_stmt|;
block|}
name|tmp
operator|=
name|RREG32
argument_list|(
name|MC_SHARED_CHMAP
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|tmp
operator|&
name|NOOFCHAN_MASK
operator|)
operator|>>
name|NOOFCHAN_SHIFT
condition|)
block|{
case|case
literal|0
case|:
default|default:
name|numchan
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|numchan
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|numchan
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|numchan
operator|=
literal|8
expr_stmt|;
break|break;
block|}
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
name|numchan
operator|*
name|chansize
expr_stmt|;
comment|/* Could aper size report 0 ? */
name|rdev
operator|->
name|mc
operator|.
name|aper_base
operator|=
name|drm_get_resource_start
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|aper_size
operator|=
name|drm_get_resource_len
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Setup GPU memory space */
name|rdev
operator|->
name|mc
operator|.
name|mc_vram_size
operator|=
name|RREG32
argument_list|(
name|CONFIG_MEMSIZE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|=
name|RREG32
argument_list|(
name|CONFIG_MEMSIZE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_size
expr_stmt|;
name|r700_vram_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * rv770_copy_dma - copy pages using the DMA engine  *  * @rdev: radeon_device pointer  * @src_offset: src GPU address  * @dst_offset: dst GPU address  * @num_gpu_pages: number of GPU pages to xfer  * @fence: radeon fence object  *  * Copy GPU paging using the DMA engine (r7xx).  * Used by the radeon ttm implementation to move pages if  * registered as the asic copy callback.  */
end_comment

begin_function
name|int
name|rv770_copy_dma
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint64_t
name|src_offset
parameter_list|,
name|uint64_t
name|dst_offset
parameter_list|,
name|unsigned
name|num_gpu_pages
parameter_list|,
name|struct
name|radeon_fence
modifier|*
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_semaphore
modifier|*
name|sem
init|=
name|NULL
decl_stmt|;
name|int
name|ring_index
init|=
name|rdev
operator|->
name|asic
operator|->
name|copy
operator|.
name|dma_ring_index
decl_stmt|;
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ring_index
index|]
decl_stmt|;
name|u32
name|size_in_dw
decl_stmt|,
name|cur_size_in_dw
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_loops
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
name|r
operator|=
name|radeon_semaphore_create
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: moving bo (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|size_in_dw
operator|=
operator|(
name|num_gpu_pages
operator|<<
name|RADEON_GPU_PAGE_SHIFT
operator|)
operator|/
literal|4
expr_stmt|;
name|num_loops
operator|=
name|DIV_ROUND_UP
argument_list|(
name|size_in_dw
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|num_loops
operator|*
literal|5
operator|+
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: moving bo (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
name|radeon_fence_need_sync
argument_list|(
operator|*
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
condition|)
block|{
name|radeon_semaphore_sync_rings
argument_list|(
name|rdev
argument_list|,
name|sem
argument_list|,
operator|(
operator|*
name|fence
operator|)
operator|->
name|ring
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
name|radeon_fence_note_sync
argument_list|(
operator|*
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_loops
condition|;
name|i
operator|++
control|)
block|{
name|cur_size_in_dw
operator|=
name|size_in_dw
expr_stmt|;
if|if
condition|(
name|cur_size_in_dw
operator|>
literal|0xFFFF
condition|)
name|cur_size_in_dw
operator|=
literal|0xFFFF
expr_stmt|;
name|size_in_dw
operator|-=
name|cur_size_in_dw
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_COPY
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|cur_size_in_dw
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|dst_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|src_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|dst_offset
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|src_offset
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|src_offset
operator|+=
name|cur_size_in_dw
operator|*
literal|4
expr_stmt|;
name|dst_offset
operator|+=
name|cur_size_in_dw
operator|*
literal|4
expr_stmt|;
block|}
name|r
operator|=
name|radeon_fence_emit
argument_list|(
name|rdev
argument_list|,
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_ring_unlock_undo
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
operator|*
name|fence
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rv770_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* enable pcie gen2 link */
name|rv770_pcie_gen2_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
operator|||
operator|!
name|rdev
operator|->
name|rlc_fw
condition|)
block|{
name|r
operator|=
name|r600_init_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
name|r
operator|=
name|r600_vram_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rv770_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|rv770_agp_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|rv770_pcie_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
name|rv770_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r
operator|=
name|r600_blit_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|r600_blit_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|asic
operator|->
name|copy
operator|.
name|copy
operator|=
name|NULL
expr_stmt|;
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed blitter (%d) falling back to memcpy\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|R600_RING_TYPE_DMA_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing DMA fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|r
operator|=
name|r600_irq_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: IH init failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r600_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|RADEON_WB_CP_RPTR_OFFSET
argument_list|,
name|R600_CP_RB_RPTR
argument_list|,
name|R600_CP_RB_WPTR
argument_list|,
literal|0
argument_list|,
literal|0xfffff
argument_list|,
name|RADEON_CP_PACKET2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|R600_WB_DMA_RPTR_OFFSET
argument_list|,
name|DMA_RB_RPTR
argument_list|,
name|DMA_RB_WPTR
argument_list|,
literal|2
argument_list|,
literal|0x3fffc
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_NOP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|rv770_cp_load_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|r600_cp_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|r600_dma_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|r600_audio_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: audio init failed\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rv770_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Do not reset GPU before posting, on rv770 hw unlike on r500 hw, 	 * posting will perform necessary task to bring back GPU into good 	 * shape. 	 */
comment|/* post card */
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|rv770_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r600 startup failed on resume\n"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|rv770_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_audio_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r700_cp_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_dma_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_irq_suspend
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv770_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Plan is to move initialization in that function and use  * helper function so that radeon_device_init pretty much  * do nothing more than calling asic specific function. This  * should also allow to remove a bunch of callback function  * like vram_info.  */
end_comment

begin_function
name|int
name|rv770_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Read BIOS */
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Must be an ATOMBIOS */
if|if
condition|(
operator|!
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting atombios for R600 GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_atombios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Post card if necessary */
if|if
condition|(
operator|!
name|radeon_card_posted
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Card not posted and no BIOS - ignoring\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_INFO
argument_list|(
literal|"GPU not posted. posting now...\n"
argument_list|)
expr_stmt|;
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize scratch registers */
name|r600_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* initialize AGP */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|r
operator|=
name|radeon_agp_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
name|radeon_agp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
name|r
operator|=
name|rv770_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ih_ring_init
argument_list|(
name|rdev
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|r
operator|=
name|r600_pcie_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|rv770_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|r700_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_dma_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_irq_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv770_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
comment|/* Don't start up if the ucode is missing. */
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
operator|||
operator|!
name|rdev
operator|->
name|rlc_fw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: ucode required for R600+.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|rv770_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_blit_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r700_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_dma_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_irq_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rv770_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_vram_scratch_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_agp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_fini_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rv770_pcie_gen2_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|link_width_cntl
decl_stmt|,
name|lanes
decl_stmt|,
name|speed_cntl
decl_stmt|,
name|tmp
decl_stmt|;
name|u16
name|link_cntl2
decl_stmt|;
name|u32
name|mask
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|radeon_pcie_gen2
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
operator|)
condition|)
return|return;
comment|/* x2 cards have a special sequence */
if|if
condition|(
name|ASIC_IS_X2
argument_list|(
name|rdev
argument_list|)
condition|)
return|return;
name|ret
operator|=
name|drm_pcie_get_speed_cap_mask
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|DRM_PCIE_SPEED_50
operator|)
condition|)
return|return;
name|DRM_INFO
argument_list|(
literal|"enabling PCIE gen 2 link speeds, disable with radeon.pcie_gen2=0\n"
argument_list|)
expr_stmt|;
comment|/* advertise upconfig capability */
name|link_width_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
name|link_width_cntl
operator|&=
operator|~
name|LC_UPCONFIGURE_DIS
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
name|link_width_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|link_width_cntl
operator|&
name|LC_RENEGOTIATION_SUPPORT
condition|)
block|{
name|lanes
operator|=
operator|(
name|link_width_cntl
operator|&
name|LC_LINK_WIDTH_RD_MASK
operator|)
operator|>>
name|LC_LINK_WIDTH_RD_SHIFT
expr_stmt|;
name|link_width_cntl
operator|&=
operator|~
operator|(
name|LC_LINK_WIDTH_MASK
operator||
name|LC_RECONFIG_ARC_MISSING_ESCAPE
operator|)
expr_stmt|;
name|link_width_cntl
operator||=
name|lanes
operator||
name|LC_RECONFIG_NOW
operator||
name|LC_RENEGOTIATE_EN
operator||
name|LC_UPCONFIGURE_SUPPORT
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|link_width_cntl
operator||=
name|LC_UPCONFIGURE_DIS
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
block|}
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|speed_cntl
operator|&
name|LC_OTHER_SIDE_EVER_SENT_GEN2
operator|)
operator|&&
operator|(
name|speed_cntl
operator|&
name|LC_OTHER_SIDE_SUPPORTS_GEN2
operator|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
literal|0x541c
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x541c
argument_list|,
name|tmp
operator||
literal|0x8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MM_CFGREGS_CNTL
argument_list|,
name|MM_WR_TO_CFG_EN
argument_list|)
expr_stmt|;
name|link_cntl2
operator|=
name|RREG16
argument_list|(
literal|0x4088
argument_list|)
expr_stmt|;
name|link_cntl2
operator|&=
operator|~
name|TARGET_LINK_SPEED_MASK
expr_stmt|;
name|link_cntl2
operator||=
literal|0x2
expr_stmt|;
name|WREG16
argument_list|(
literal|0x4088
argument_list|,
name|link_cntl2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MM_CFGREGS_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
name|speed_cntl
operator|&=
operator|~
name|LC_TARGET_LINK_SPEED_OVERRIDE_EN
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
name|speed_cntl
operator||=
name|LC_CLR_FAILED_SPD_CHANGE_CNT
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
name|speed_cntl
operator|&=
operator|~
name|LC_CLR_FAILED_SPD_CHANGE_CNT
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
name|speed_cntl
operator||=
name|LC_GEN2_EN_STRAP
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|link_width_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
comment|/* XXX: only disable it if gen1 bridge vendor == 0x111d or 0x1106 */
if|if
condition|(
literal|1
condition|)
name|link_width_cntl
operator||=
name|LC_UPCONFIGURE_DIS
expr_stmt|;
else|else
name|link_width_cntl
operator|&=
operator|~
name|LC_UPCONFIGURE_DIS
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


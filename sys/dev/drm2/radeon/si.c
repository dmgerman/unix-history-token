begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2011 Advanced Micro Devices, Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Alex Deucher  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"sid.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"si_blit_shaders.h"
end_include

begin_define
define|#
directive|define
name|SI_PFP_UCODE_SIZE
value|2144
end_define

begin_define
define|#
directive|define
name|SI_PM4_UCODE_SIZE
value|2144
end_define

begin_define
define|#
directive|define
name|SI_CE_UCODE_SIZE
value|2144
end_define

begin_define
define|#
directive|define
name|SI_RLC_UCODE_SIZE
value|2048
end_define

begin_define
define|#
directive|define
name|SI_MC_UCODE_SIZE
value|7769
end_define

begin_comment
comment|/* get temperature in millidegrees */
end_comment

begin_function
name|int
name|si_get_temp
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|temp
decl_stmt|;
name|int
name|actual_temp
init|=
literal|0
decl_stmt|;
name|temp
operator|=
operator|(
name|RREG32
argument_list|(
name|CG_MULT_THERMAL_STATUS
argument_list|)
operator|&
name|CTF_TEMP_MASK
operator|)
operator|>>
name|CTF_TEMP_SHIFT
expr_stmt|;
if|if
condition|(
name|temp
operator|&
literal|0x200
condition|)
name|actual_temp
operator|=
literal|255
expr_stmt|;
else|else
name|actual_temp
operator|=
name|temp
operator|&
literal|0x1ff
expr_stmt|;
name|actual_temp
operator|=
operator|(
name|actual_temp
operator|*
literal|1000
operator|)
expr_stmt|;
return|return
name|actual_temp
return|;
block|}
end_function

begin_define
define|#
directive|define
name|TAHITI_IO_MC_REGS_SIZE
value|36
end_define

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|tahiti_io_mc_regs
index|[
name|TAHITI_IO_MC_REGS_SIZE
index|]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x0000006f
block|,
literal|0x03044000
block|}
block|,
block|{
literal|0x00000070
block|,
literal|0x0480c018
block|}
block|,
block|{
literal|0x00000071
block|,
literal|0x00000040
block|}
block|,
block|{
literal|0x00000072
block|,
literal|0x01000000
block|}
block|,
block|{
literal|0x00000074
block|,
literal|0x000000ff
block|}
block|,
block|{
literal|0x00000075
block|,
literal|0x00143400
block|}
block|,
block|{
literal|0x00000076
block|,
literal|0x08ec0800
block|}
block|,
block|{
literal|0x00000077
block|,
literal|0x040000cc
block|}
block|,
block|{
literal|0x00000079
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x0000007a
block|,
literal|0x21000409
block|}
block|,
block|{
literal|0x0000007c
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x0000007d
block|,
literal|0xe8000000
block|}
block|,
block|{
literal|0x0000007e
block|,
literal|0x044408a8
block|}
block|,
block|{
literal|0x0000007f
block|,
literal|0x00000003
block|}
block|,
block|{
literal|0x00000080
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000081
block|,
literal|0x01000000
block|}
block|,
block|{
literal|0x00000082
block|,
literal|0x02000000
block|}
block|,
block|{
literal|0x00000083
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000084
block|,
literal|0xe3f3e4f4
block|}
block|,
block|{
literal|0x00000085
block|,
literal|0x00052024
block|}
block|,
block|{
literal|0x00000087
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000088
block|,
literal|0x66036603
block|}
block|,
block|{
literal|0x00000089
block|,
literal|0x01000000
block|}
block|,
block|{
literal|0x0000008b
block|,
literal|0x1c0a0000
block|}
block|,
block|{
literal|0x0000008c
block|,
literal|0xff010000
block|}
block|,
block|{
literal|0x0000008e
block|,
literal|0xffffefff
block|}
block|,
block|{
literal|0x0000008f
block|,
literal|0xfff3efff
block|}
block|,
block|{
literal|0x00000090
block|,
literal|0xfff3efbf
block|}
block|,
block|{
literal|0x00000094
block|,
literal|0x00101101
block|}
block|,
block|{
literal|0x00000095
block|,
literal|0x00000fff
block|}
block|,
block|{
literal|0x00000096
block|,
literal|0x00116fff
block|}
block|,
block|{
literal|0x00000097
block|,
literal|0x60010000
block|}
block|,
block|{
literal|0x00000098
block|,
literal|0x10010000
block|}
block|,
block|{
literal|0x00000099
block|,
literal|0x00006000
block|}
block|,
block|{
literal|0x0000009a
block|,
literal|0x00001000
block|}
block|,
block|{
literal|0x0000009f
block|,
literal|0x00a77400
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|pitcairn_io_mc_regs
index|[
name|TAHITI_IO_MC_REGS_SIZE
index|]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x0000006f
block|,
literal|0x03044000
block|}
block|,
block|{
literal|0x00000070
block|,
literal|0x0480c018
block|}
block|,
block|{
literal|0x00000071
block|,
literal|0x00000040
block|}
block|,
block|{
literal|0x00000072
block|,
literal|0x01000000
block|}
block|,
block|{
literal|0x00000074
block|,
literal|0x000000ff
block|}
block|,
block|{
literal|0x00000075
block|,
literal|0x00143400
block|}
block|,
block|{
literal|0x00000076
block|,
literal|0x08ec0800
block|}
block|,
block|{
literal|0x00000077
block|,
literal|0x040000cc
block|}
block|,
block|{
literal|0x00000079
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x0000007a
block|,
literal|0x21000409
block|}
block|,
block|{
literal|0x0000007c
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x0000007d
block|,
literal|0xe8000000
block|}
block|,
block|{
literal|0x0000007e
block|,
literal|0x044408a8
block|}
block|,
block|{
literal|0x0000007f
block|,
literal|0x00000003
block|}
block|,
block|{
literal|0x00000080
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000081
block|,
literal|0x01000000
block|}
block|,
block|{
literal|0x00000082
block|,
literal|0x02000000
block|}
block|,
block|{
literal|0x00000083
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000084
block|,
literal|0xe3f3e4f4
block|}
block|,
block|{
literal|0x00000085
block|,
literal|0x00052024
block|}
block|,
block|{
literal|0x00000087
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000088
block|,
literal|0x66036603
block|}
block|,
block|{
literal|0x00000089
block|,
literal|0x01000000
block|}
block|,
block|{
literal|0x0000008b
block|,
literal|0x1c0a0000
block|}
block|,
block|{
literal|0x0000008c
block|,
literal|0xff010000
block|}
block|,
block|{
literal|0x0000008e
block|,
literal|0xffffefff
block|}
block|,
block|{
literal|0x0000008f
block|,
literal|0xfff3efff
block|}
block|,
block|{
literal|0x00000090
block|,
literal|0xfff3efbf
block|}
block|,
block|{
literal|0x00000094
block|,
literal|0x00101101
block|}
block|,
block|{
literal|0x00000095
block|,
literal|0x00000fff
block|}
block|,
block|{
literal|0x00000096
block|,
literal|0x00116fff
block|}
block|,
block|{
literal|0x00000097
block|,
literal|0x60010000
block|}
block|,
block|{
literal|0x00000098
block|,
literal|0x10010000
block|}
block|,
block|{
literal|0x00000099
block|,
literal|0x00006000
block|}
block|,
block|{
literal|0x0000009a
block|,
literal|0x00001000
block|}
block|,
block|{
literal|0x0000009f
block|,
literal|0x00a47400
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|verde_io_mc_regs
index|[
name|TAHITI_IO_MC_REGS_SIZE
index|]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x0000006f
block|,
literal|0x03044000
block|}
block|,
block|{
literal|0x00000070
block|,
literal|0x0480c018
block|}
block|,
block|{
literal|0x00000071
block|,
literal|0x00000040
block|}
block|,
block|{
literal|0x00000072
block|,
literal|0x01000000
block|}
block|,
block|{
literal|0x00000074
block|,
literal|0x000000ff
block|}
block|,
block|{
literal|0x00000075
block|,
literal|0x00143400
block|}
block|,
block|{
literal|0x00000076
block|,
literal|0x08ec0800
block|}
block|,
block|{
literal|0x00000077
block|,
literal|0x040000cc
block|}
block|,
block|{
literal|0x00000079
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x0000007a
block|,
literal|0x21000409
block|}
block|,
block|{
literal|0x0000007c
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x0000007d
block|,
literal|0xe8000000
block|}
block|,
block|{
literal|0x0000007e
block|,
literal|0x044408a8
block|}
block|,
block|{
literal|0x0000007f
block|,
literal|0x00000003
block|}
block|,
block|{
literal|0x00000080
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000081
block|,
literal|0x01000000
block|}
block|,
block|{
literal|0x00000082
block|,
literal|0x02000000
block|}
block|,
block|{
literal|0x00000083
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000084
block|,
literal|0xe3f3e4f4
block|}
block|,
block|{
literal|0x00000085
block|,
literal|0x00052024
block|}
block|,
block|{
literal|0x00000087
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000088
block|,
literal|0x66036603
block|}
block|,
block|{
literal|0x00000089
block|,
literal|0x01000000
block|}
block|,
block|{
literal|0x0000008b
block|,
literal|0x1c0a0000
block|}
block|,
block|{
literal|0x0000008c
block|,
literal|0xff010000
block|}
block|,
block|{
literal|0x0000008e
block|,
literal|0xffffefff
block|}
block|,
block|{
literal|0x0000008f
block|,
literal|0xfff3efff
block|}
block|,
block|{
literal|0x00000090
block|,
literal|0xfff3efbf
block|}
block|,
block|{
literal|0x00000094
block|,
literal|0x00101101
block|}
block|,
block|{
literal|0x00000095
block|,
literal|0x00000fff
block|}
block|,
block|{
literal|0x00000096
block|,
literal|0x00116fff
block|}
block|,
block|{
literal|0x00000097
block|,
literal|0x60010000
block|}
block|,
block|{
literal|0x00000098
block|,
literal|0x10010000
block|}
block|,
block|{
literal|0x00000099
block|,
literal|0x00006000
block|}
block|,
block|{
literal|0x0000009a
block|,
literal|0x00001000
block|}
block|,
block|{
literal|0x0000009f
block|,
literal|0x00a37400
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ucode loading */
end_comment

begin_function
specifier|static
name|int
name|si_mc_load_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|__be32
modifier|*
name|fw_data
decl_stmt|;
name|u32
name|running
decl_stmt|,
name|blackout
init|=
literal|0
decl_stmt|;
name|u32
modifier|*
name|io_mc_regs
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ucode_size
decl_stmt|,
name|regs_size
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|mc_fw
condition|)
return|return
operator|-
name|EINVAL
return|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_TAHITI
case|:
name|io_mc_regs
operator|=
operator|(
name|u32
operator|*
operator|)
operator|&
name|tahiti_io_mc_regs
expr_stmt|;
name|ucode_size
operator|=
name|SI_MC_UCODE_SIZE
expr_stmt|;
name|regs_size
operator|=
name|TAHITI_IO_MC_REGS_SIZE
expr_stmt|;
break|break;
case|case
name|CHIP_PITCAIRN
case|:
name|io_mc_regs
operator|=
operator|(
name|u32
operator|*
operator|)
operator|&
name|pitcairn_io_mc_regs
expr_stmt|;
name|ucode_size
operator|=
name|SI_MC_UCODE_SIZE
expr_stmt|;
name|regs_size
operator|=
name|TAHITI_IO_MC_REGS_SIZE
expr_stmt|;
break|break;
case|case
name|CHIP_VERDE
case|:
default|default:
name|io_mc_regs
operator|=
operator|(
name|u32
operator|*
operator|)
operator|&
name|verde_io_mc_regs
expr_stmt|;
name|ucode_size
operator|=
name|SI_MC_UCODE_SIZE
expr_stmt|;
name|regs_size
operator|=
name|TAHITI_IO_MC_REGS_SIZE
expr_stmt|;
break|break;
block|}
name|running
operator|=
name|RREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|)
operator|&
name|RUN_MASK
expr_stmt|;
if|if
condition|(
name|running
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|running
condition|)
block|{
name|blackout
operator|=
name|RREG32
argument_list|(
name|MC_SHARED_BLACKOUT_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SHARED_BLACKOUT_CNTL
argument_list|,
name|blackout
operator||
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* reset the engine and set to writable */
name|WREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/* load mc io regs */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|regs_size
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|MC_SEQ_IO_DEBUG_INDEX
argument_list|,
name|io_mc_regs
index|[
operator|(
name|i
operator|<<
literal|1
operator|)
index|]
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SEQ_IO_DEBUG_DATA
argument_list|,
name|io_mc_regs
index|[
operator|(
name|i
operator|<<
literal|1
operator|)
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* load the MC ucode */
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|mc_fw
operator|->
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ucode_size
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|MC_SEQ_SUP_PGM
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
comment|/* put the engine back into the active state */
name|WREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|,
literal|0x00000004
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
comment|/* wait for training to complete */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|MC_SEQ_TRAIN_WAKEUP_CNTL
argument_list|)
operator|&
name|TRAIN_DONE_D0
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|MC_SEQ_TRAIN_WAKEUP_CNTL
argument_list|)
operator|&
name|TRAIN_DONE_D1
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|running
condition|)
name|WREG32
argument_list|(
name|MC_SHARED_BLACKOUT_CNTL
argument_list|,
name|blackout
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_init_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|chip_name
decl_stmt|;
specifier|const
name|char
modifier|*
name|rlc_chip_name
decl_stmt|;
name|size_t
name|pfp_req_size
decl_stmt|,
name|me_req_size
decl_stmt|,
name|ce_req_size
decl_stmt|,
name|rlc_req_size
decl_stmt|,
name|mc_req_size
decl_stmt|;
name|char
name|fw_name
index|[
literal|30
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_TAHITI
case|:
name|chip_name
operator|=
literal|"TAHITI"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"TAHITI"
expr_stmt|;
name|pfp_req_size
operator|=
name|SI_PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|SI_PM4_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|ce_req_size
operator|=
name|SI_CE_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|rlc_req_size
operator|=
name|SI_RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|mc_req_size
operator|=
name|SI_MC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
break|break;
case|case
name|CHIP_PITCAIRN
case|:
name|chip_name
operator|=
literal|"PITCAIRN"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"PITCAIRN"
expr_stmt|;
name|pfp_req_size
operator|=
name|SI_PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|SI_PM4_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|ce_req_size
operator|=
name|SI_CE_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|rlc_req_size
operator|=
name|SI_RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|mc_req_size
operator|=
name|SI_MC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
break|break;
case|case
name|CHIP_VERDE
case|:
name|chip_name
operator|=
literal|"VERDE"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"VERDE"
expr_stmt|;
name|pfp_req_size
operator|=
name|SI_PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|SI_PM4_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|ce_req_size
operator|=
name|SI_CE_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|rlc_req_size
operator|=
name|SI_RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|mc_req_size
operator|=
name|SI_MC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: Unsupported family %d"
argument_list|,
name|__func__
argument_list|,
name|rdev
operator|->
name|family
argument_list|)
expr_stmt|;
block|}
name|DRM_INFO
argument_list|(
literal|"Loading %s Microcode\n"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_pfp"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pfp_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|->
name|datasize
operator|!=
name|pfp_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"si_cp: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|pfp_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_me"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|->
name|datasize
operator|!=
name|me_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"si_cp: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|me_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_ce"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ce_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|ce_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|ce_fw
operator|->
name|datasize
operator|!=
name|ce_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"si_cp: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|ce_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_rlc"
argument_list|,
name|rlc_chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|->
name|datasize
operator|!=
name|rlc_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"si_rlc: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|rlc_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_mc"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mc_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|mc_fw
operator|->
name|datasize
operator|!=
name|mc_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"si_mc: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|mc_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|out
label|:
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|!=
operator|-
name|EINVAL
condition|)
name|DRM_ERROR
argument_list|(
literal|"si_cp: Failed to load firmware \"%s\"\n"
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|pfp_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pfp_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|me_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|ce_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|ce_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ce_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|rlc_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|mc_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|mc_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc_fw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/**  * si_fini_microcode - drop the firmwares image references  *  * @rdev: radeon_device pointer  *  * Drop the pfp, me, rlc, mc and ce firmware image references.  * Called at driver shutdown.  */
end_comment

begin_function
specifier|static
name|void
name|si_fini_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|pfp_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pfp_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|me_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|rlc_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|mc_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|mc_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|ce_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|ce_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ce_fw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* watermark setup */
end_comment

begin_function
specifier|static
name|u32
name|dce6_line_buffer_adjust
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|other_mode
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
comment|/* 	 * Line Buffer Setup 	 * There are 3 line buffers, each one shared by 2 display controllers. 	 * DC_LB_MEMORY_SPLIT controls how that line buffer is shared between 	 * the display controllers.  The paritioning is done via one of four 	 * preset allocations specified in bits 21:20: 	 *  0 - half lb 	 *  2 - whole lb, other crtc must be disabled 	 */
comment|/* this can get tricky if we have two large displays on a paired group 	 * of crtcs.  Ideally for multiple large displays we'd assign them to 	 * non-linked crtcs for maximum line buffer allocation. 	 */
if|if
condition|(
name|radeon_crtc
operator|->
name|base
operator|.
name|enabled
operator|&&
name|mode
condition|)
block|{
if|if
condition|(
name|other_mode
condition|)
name|tmp
operator|=
literal|0
expr_stmt|;
comment|/* 1/2 */
else|else
name|tmp
operator|=
literal|2
expr_stmt|;
comment|/* whole */
block|}
else|else
name|tmp
operator|=
literal|0
expr_stmt|;
name|WREG32
argument_list|(
name|DC_LB_MEMORY_SPLIT
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|DC_LB_MEMORY_CONFIG
argument_list|(
name|tmp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|base
operator|.
name|enabled
operator|&&
name|mode
condition|)
block|{
switch|switch
condition|(
name|tmp
condition|)
block|{
case|case
literal|0
case|:
default|default:
return|return
literal|4096
operator|*
literal|2
return|;
case|case
literal|2
case|:
return|return
literal|8192
operator|*
literal|2
return|;
block|}
block|}
comment|/* controller not enabled, so no lb used */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|si_get_number_of_dram_channels
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
init|=
name|RREG32
argument_list|(
name|MC_SHARED_CHMAP
argument_list|)
decl_stmt|;
switch|switch
condition|(
operator|(
name|tmp
operator|&
name|NOOFCHAN_MASK
operator|)
operator|>>
name|NOOFCHAN_SHIFT
condition|)
block|{
case|case
literal|0
case|:
default|default:
return|return
literal|1
return|;
case|case
literal|1
case|:
return|return
literal|2
return|;
case|case
literal|2
case|:
return|return
literal|4
return|;
case|case
literal|3
case|:
return|return
literal|8
return|;
case|case
literal|4
case|:
return|return
literal|3
return|;
case|case
literal|5
case|:
return|return
literal|6
return|;
case|case
literal|6
case|:
return|return
literal|10
return|;
case|case
literal|7
case|:
return|return
literal|12
return|;
case|case
literal|8
case|:
return|return
literal|16
return|;
block|}
block|}
end_function

begin_struct
struct|struct
name|dce6_wm_params
block|{
name|u32
name|dram_channels
decl_stmt|;
comment|/* number of dram channels */
name|u32
name|yclk
decl_stmt|;
comment|/* bandwidth per dram data pin in kHz */
name|u32
name|sclk
decl_stmt|;
comment|/* engine clock in kHz */
name|u32
name|disp_clk
decl_stmt|;
comment|/* display clock in kHz */
name|u32
name|src_width
decl_stmt|;
comment|/* viewport width */
name|u32
name|active_time
decl_stmt|;
comment|/* active display time in ns */
name|u32
name|blank_time
decl_stmt|;
comment|/* blank time in ns */
name|bool
name|interlaced
decl_stmt|;
comment|/* mode is interlaced */
name|fixed20_12
name|vsc
decl_stmt|;
comment|/* vertical scale ratio */
name|u32
name|num_heads
decl_stmt|;
comment|/* number of active crtcs */
name|u32
name|bytes_per_pixel
decl_stmt|;
comment|/* bytes per pixel display + overlay */
name|u32
name|lb_size
decl_stmt|;
comment|/* line buffer allocated to pipe */
name|u32
name|vtaps
decl_stmt|;
comment|/* vertical scaler taps */
block|}
struct|;
end_struct

begin_function
specifier|static
name|u32
name|dce6_dram_bandwidth
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate raw DRAM Bandwidth */
name|fixed20_12
name|dram_efficiency
decl_stmt|;
comment|/* 0.7 */
name|fixed20_12
name|yclk
decl_stmt|,
name|dram_channels
decl_stmt|,
name|bandwidth
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|yclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|yclk
argument_list|)
expr_stmt|;
name|yclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|yclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|dram_channels
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|dram_channels
operator|*
literal|4
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|dram_efficiency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|dram_efficiency
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|dram_efficiency
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|dram_channels
argument_list|,
name|yclk
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|bandwidth
argument_list|,
name|dram_efficiency
argument_list|)
expr_stmt|;
return|return
name|dfixed_trunc
argument_list|(
name|bandwidth
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|dce6_dram_bandwidth_for_display
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate DRAM Bandwidth and the part allocated to display. */
name|fixed20_12
name|disp_dram_allocation
decl_stmt|;
comment|/* 0.3 to 0.7 */
name|fixed20_12
name|yclk
decl_stmt|,
name|dram_channels
decl_stmt|,
name|bandwidth
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|yclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|yclk
argument_list|)
expr_stmt|;
name|yclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|yclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|dram_channels
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|dram_channels
operator|*
literal|4
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|disp_dram_allocation
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|3
argument_list|)
expr_stmt|;
comment|/* XXX worse case value 0.3 */
name|disp_dram_allocation
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|disp_dram_allocation
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|dram_channels
argument_list|,
name|yclk
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|bandwidth
argument_list|,
name|disp_dram_allocation
argument_list|)
expr_stmt|;
return|return
name|dfixed_trunc
argument_list|(
name|bandwidth
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|dce6_data_return_bandwidth
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate the display Data return Bandwidth */
name|fixed20_12
name|return_efficiency
decl_stmt|;
comment|/* 0.8 */
name|fixed20_12
name|sclk
decl_stmt|,
name|bandwidth
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|sclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|sclk
argument_list|)
expr_stmt|;
name|sclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|sclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|return_efficiency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|return_efficiency
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|return_efficiency
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|32
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|sclk
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|bandwidth
argument_list|,
name|return_efficiency
argument_list|)
expr_stmt|;
return|return
name|dfixed_trunc
argument_list|(
name|bandwidth
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|dce6_get_dmif_bytes_per_request
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
return|return
literal|32
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|dce6_dmif_request_bandwidth
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate the DMIF Request Bandwidth */
name|fixed20_12
name|disp_clk_request_efficiency
decl_stmt|;
comment|/* 0.8 */
name|fixed20_12
name|disp_clk
decl_stmt|,
name|sclk
decl_stmt|,
name|bandwidth
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|,
name|b1
decl_stmt|,
name|b2
decl_stmt|;
name|u32
name|min_bandwidth
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|disp_clk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|disp_clk
argument_list|)
expr_stmt|;
name|disp_clk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|disp_clk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|dce6_get_dmif_bytes_per_request
argument_list|(
name|wm
argument_list|)
operator|/
literal|2
argument_list|)
expr_stmt|;
name|b1
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|disp_clk
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|sclk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|sclk
argument_list|)
expr_stmt|;
name|sclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|sclk
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|dce6_get_dmif_bytes_per_request
argument_list|(
name|wm
argument_list|)
argument_list|)
expr_stmt|;
name|b2
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|sclk
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|disp_clk_request_efficiency
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|disp_clk_request_efficiency
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|disp_clk_request_efficiency
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|min_bandwidth
operator|=
name|min
argument_list|(
name|dfixed_trunc
argument_list|(
name|b1
argument_list|)
argument_list|,
name|dfixed_trunc
argument_list|(
name|b2
argument_list|)
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|min_bandwidth
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|a
argument_list|,
name|disp_clk_request_efficiency
argument_list|)
expr_stmt|;
return|return
name|dfixed_trunc
argument_list|(
name|bandwidth
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|dce6_available_bandwidth
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate the Available bandwidth. Display can use this temporarily but not in average. */
name|u32
name|dram_bandwidth
init|=
name|dce6_dram_bandwidth
argument_list|(
name|wm
argument_list|)
decl_stmt|;
name|u32
name|data_return_bandwidth
init|=
name|dce6_data_return_bandwidth
argument_list|(
name|wm
argument_list|)
decl_stmt|;
name|u32
name|dmif_req_bandwidth
init|=
name|dce6_dmif_request_bandwidth
argument_list|(
name|wm
argument_list|)
decl_stmt|;
return|return
name|min
argument_list|(
name|dram_bandwidth
argument_list|,
name|min
argument_list|(
name|data_return_bandwidth
argument_list|,
name|dmif_req_bandwidth
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|dce6_average_bandwidth
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* Calculate the display mode Average Bandwidth 	 * DisplayMode should contain the source and destination dimensions, 	 * timing, etc. 	 */
name|fixed20_12
name|bpp
decl_stmt|;
name|fixed20_12
name|line_time
decl_stmt|;
name|fixed20_12
name|src_width
decl_stmt|;
name|fixed20_12
name|bandwidth
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|line_time
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|active_time
operator|+
name|wm
operator|->
name|blank_time
argument_list|)
expr_stmt|;
name|line_time
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|line_time
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|bpp
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|bytes_per_pixel
argument_list|)
expr_stmt|;
name|src_width
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|src_width
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|src_width
argument_list|,
name|bpp
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|bandwidth
argument_list|,
name|wm
operator|->
name|vsc
argument_list|)
expr_stmt|;
name|bandwidth
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|bandwidth
argument_list|,
name|line_time
argument_list|)
expr_stmt|;
return|return
name|dfixed_trunc
argument_list|(
name|bandwidth
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|dce6_latency_watermark
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
comment|/* First calcualte the latency in ns */
name|u32
name|mc_latency
init|=
literal|2000
decl_stmt|;
comment|/* 2000 ns. */
name|u32
name|available_bandwidth
init|=
name|dce6_available_bandwidth
argument_list|(
name|wm
argument_list|)
decl_stmt|;
name|u32
name|worst_chunk_return_time
init|=
operator|(
literal|512
operator|*
literal|8
operator|*
literal|1000
operator|)
operator|/
name|available_bandwidth
decl_stmt|;
name|u32
name|cursor_line_pair_return_time
init|=
operator|(
literal|128
operator|*
literal|4
operator|*
literal|1000
operator|)
operator|/
name|available_bandwidth
decl_stmt|;
name|u32
name|dc_latency
init|=
literal|40000000
operator|/
name|wm
operator|->
name|disp_clk
decl_stmt|;
comment|/* dc pipe latency */
name|u32
name|other_heads_data_return_time
init|=
operator|(
operator|(
name|wm
operator|->
name|num_heads
operator|+
literal|1
operator|)
operator|*
name|worst_chunk_return_time
operator|)
operator|+
operator|(
name|wm
operator|->
name|num_heads
operator|*
name|cursor_line_pair_return_time
operator|)
decl_stmt|;
name|u32
name|latency
init|=
name|mc_latency
operator|+
name|other_heads_data_return_time
operator|+
name|dc_latency
decl_stmt|;
name|u32
name|max_src_lines_per_dst_line
decl_stmt|,
name|lb_fill_bw
decl_stmt|,
name|line_fill_time
decl_stmt|;
name|u32
name|tmp
decl_stmt|,
name|dmif_size
init|=
literal|12288
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
if|if
condition|(
name|wm
operator|->
name|num_heads
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wm
operator|->
name|vsc
operator|.
name|full
operator|>
name|a
operator|.
name|full
operator|)
operator|||
operator|(
operator|(
name|wm
operator|->
name|vsc
operator|.
name|full
operator|>
name|b
operator|.
name|full
operator|)
operator|&&
operator|(
name|wm
operator|->
name|vtaps
operator|>=
literal|3
operator|)
operator|)
operator|||
operator|(
name|wm
operator|->
name|vtaps
operator|>=
literal|5
operator|)
operator|||
operator|(
operator|(
name|wm
operator|->
name|vsc
operator|.
name|full
operator|>=
name|a
operator|.
name|full
operator|)
operator|&&
name|wm
operator|->
name|interlaced
operator|)
condition|)
name|max_src_lines_per_dst_line
operator|=
literal|4
expr_stmt|;
else|else
name|max_src_lines_per_dst_line
operator|=
literal|2
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|available_bandwidth
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|num_heads
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mc_latency
operator|+
literal|512
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|disp_clk
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|dmif_size
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|min
argument_list|(
name|dfixed_trunc
argument_list|(
name|a
argument_list|)
argument_list|,
name|dfixed_trunc
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|disp_clk
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|wm
operator|->
name|bytes_per_pixel
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|lb_fill_bw
operator|=
name|min
argument_list|(
name|tmp
argument_list|,
name|dfixed_trunc
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|max_src_lines_per_dst_line
operator|*
name|wm
operator|->
name|src_width
operator|*
name|wm
operator|->
name|bytes_per_pixel
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|lb_fill_bw
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|line_fill_time
operator|=
name|dfixed_trunc
argument_list|(
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|line_fill_time
operator|<
name|wm
operator|->
name|active_time
condition|)
return|return
name|latency
return|;
else|else
return|return
name|latency
operator|+
operator|(
name|line_fill_time
operator|-
name|wm
operator|->
name|active_time
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|dce6_average_bandwidth_vs_dram_bandwidth_for_display
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
if|if
condition|(
name|dce6_average_bandwidth
argument_list|(
name|wm
argument_list|)
operator|<=
operator|(
name|dce6_dram_bandwidth_for_display
argument_list|(
name|wm
argument_list|)
operator|/
name|wm
operator|->
name|num_heads
operator|)
condition|)
return|return
name|true
return|;
else|else
return|return
name|false
return|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|bool
name|dce6_average_bandwidth_vs_available_bandwidth
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
if|if
condition|(
name|dce6_average_bandwidth
argument_list|(
name|wm
argument_list|)
operator|<=
operator|(
name|dce6_available_bandwidth
argument_list|(
name|wm
argument_list|)
operator|/
name|wm
operator|->
name|num_heads
operator|)
condition|)
return|return
name|true
return|;
else|else
return|return
name|false
return|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|bool
name|dce6_check_latency_hiding
parameter_list|(
name|struct
name|dce6_wm_params
modifier|*
name|wm
parameter_list|)
block|{
name|u32
name|lb_partitions
init|=
name|wm
operator|->
name|lb_size
operator|/
name|wm
operator|->
name|src_width
decl_stmt|;
name|u32
name|line_time
init|=
name|wm
operator|->
name|active_time
operator|+
name|wm
operator|->
name|blank_time
decl_stmt|;
name|u32
name|latency_tolerant_lines
decl_stmt|;
name|u32
name|latency_hiding
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wm
operator|->
name|vsc
operator|.
name|full
operator|>
name|a
operator|.
name|full
condition|)
name|latency_tolerant_lines
operator|=
literal|1
expr_stmt|;
else|else
block|{
if|if
condition|(
name|lb_partitions
operator|<=
operator|(
name|wm
operator|->
name|vtaps
operator|+
literal|1
operator|)
condition|)
name|latency_tolerant_lines
operator|=
literal|1
expr_stmt|;
else|else
name|latency_tolerant_lines
operator|=
literal|2
expr_stmt|;
block|}
name|latency_hiding
operator|=
operator|(
name|latency_tolerant_lines
operator|*
name|line_time
operator|+
name|wm
operator|->
name|blank_time
operator|)
expr_stmt|;
if|if
condition|(
name|dce6_latency_watermark
argument_list|(
name|wm
argument_list|)
operator|<=
name|latency_hiding
condition|)
return|return
name|true
return|;
else|else
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dce6_program_watermarks
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
parameter_list|,
name|u32
name|lb_size
parameter_list|,
name|u32
name|num_heads
parameter_list|)
block|{
name|struct
name|drm_display_mode
modifier|*
name|mode
init|=
operator|&
name|radeon_crtc
operator|->
name|base
operator|.
name|mode
decl_stmt|;
name|struct
name|dce6_wm_params
name|wm
decl_stmt|;
name|u32
name|pixel_period
decl_stmt|;
name|u32
name|line_time
init|=
literal|0
decl_stmt|;
name|u32
name|latency_watermark_a
init|=
literal|0
decl_stmt|,
name|latency_watermark_b
init|=
literal|0
decl_stmt|;
name|u32
name|priority_a_mark
init|=
literal|0
decl_stmt|,
name|priority_b_mark
init|=
literal|0
decl_stmt|;
name|u32
name|priority_a_cnt
init|=
name|PRIORITY_OFF
decl_stmt|;
name|u32
name|priority_b_cnt
init|=
name|PRIORITY_OFF
decl_stmt|;
name|u32
name|tmp
decl_stmt|,
name|arb_control3
decl_stmt|;
name|fixed20_12
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|base
operator|.
name|enabled
operator|&&
name|num_heads
operator|&&
name|mode
condition|)
block|{
name|pixel_period
operator|=
literal|1000000
operator|/
operator|(
name|u32
operator|)
name|mode
operator|->
name|clock
expr_stmt|;
name|line_time
operator|=
name|min
argument_list|(
operator|(
name|u32
operator|)
name|mode
operator|->
name|crtc_htotal
operator|*
name|pixel_period
argument_list|,
operator|(
name|u32
operator|)
literal|65535
argument_list|)
expr_stmt|;
name|priority_a_cnt
operator|=
literal|0
expr_stmt|;
name|priority_b_cnt
operator|=
literal|0
expr_stmt|;
name|wm
operator|.
name|yclk
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_mclk
operator|*
literal|10
expr_stmt|;
name|wm
operator|.
name|sclk
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_sclk
operator|*
literal|10
expr_stmt|;
name|wm
operator|.
name|disp_clk
operator|=
name|mode
operator|->
name|clock
expr_stmt|;
name|wm
operator|.
name|src_width
operator|=
name|mode
operator|->
name|crtc_hdisplay
expr_stmt|;
name|wm
operator|.
name|active_time
operator|=
name|mode
operator|->
name|crtc_hdisplay
operator|*
name|pixel_period
expr_stmt|;
name|wm
operator|.
name|blank_time
operator|=
name|line_time
operator|-
name|wm
operator|.
name|active_time
expr_stmt|;
name|wm
operator|.
name|interlaced
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_INTERLACE
condition|)
name|wm
operator|.
name|interlaced
operator|=
name|true
expr_stmt|;
name|wm
operator|.
name|vsc
operator|=
name|radeon_crtc
operator|->
name|vsc
expr_stmt|;
name|wm
operator|.
name|vtaps
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|rmx_type
operator|!=
name|RMX_OFF
condition|)
name|wm
operator|.
name|vtaps
operator|=
literal|2
expr_stmt|;
name|wm
operator|.
name|bytes_per_pixel
operator|=
literal|4
expr_stmt|;
comment|/* XXX: get this from fb config */
name|wm
operator|.
name|lb_size
operator|=
name|lb_size
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_ARUBA
condition|)
name|wm
operator|.
name|dram_channels
operator|=
name|evergreen_get_number_of_dram_channels
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
else|else
name|wm
operator|.
name|dram_channels
operator|=
name|si_get_number_of_dram_channels
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|wm
operator|.
name|num_heads
operator|=
name|num_heads
expr_stmt|;
comment|/* set for high clocks */
name|latency_watermark_a
operator|=
name|min
argument_list|(
name|dce6_latency_watermark
argument_list|(
operator|&
name|wm
argument_list|)
argument_list|,
operator|(
name|u32
operator|)
literal|65535
argument_list|)
expr_stmt|;
comment|/* set for low clocks */
comment|/* wm.yclk = low clk; wm.sclk = low clk */
name|latency_watermark_b
operator|=
name|min
argument_list|(
name|dce6_latency_watermark
argument_list|(
operator|&
name|wm
argument_list|)
argument_list|,
operator|(
name|u32
operator|)
literal|65535
argument_list|)
expr_stmt|;
comment|/* possibly force display priority to high */
comment|/* should really do this at mode validation time... */
if|if
condition|(
operator|!
name|dce6_average_bandwidth_vs_dram_bandwidth_for_display
argument_list|(
operator|&
name|wm
argument_list|)
operator|||
operator|!
name|dce6_average_bandwidth_vs_available_bandwidth
argument_list|(
operator|&
name|wm
argument_list|)
operator|||
operator|!
name|dce6_check_latency_hiding
argument_list|(
operator|&
name|wm
argument_list|)
operator|||
operator|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
operator|)
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"force priority to high\n"
argument_list|)
expr_stmt|;
name|priority_a_cnt
operator||=
name|PRIORITY_ALWAYS_ON
expr_stmt|;
name|priority_b_cnt
operator||=
name|PRIORITY_ALWAYS_ON
expr_stmt|;
block|}
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mode
operator|->
name|clock
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|latency_watermark_a
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|c
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|c
argument_list|,
name|radeon_crtc
operator|->
name|hsc
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|priority_a_mark
operator|=
name|dfixed_trunc
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|priority_a_cnt
operator||=
name|priority_a_mark
operator|&
name|PRIORITY_MARK_MASK
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mode
operator|->
name|clock
argument_list|)
expr_stmt|;
name|b
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|b
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|latency_watermark_b
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|c
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|c
argument_list|,
name|radeon_crtc
operator|->
name|hsc
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|c
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|priority_b_mark
operator|=
name|dfixed_trunc
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|priority_b_cnt
operator||=
name|priority_b_mark
operator|&
name|PRIORITY_MARK_MASK
expr_stmt|;
block|}
comment|/* select wm A */
name|arb_control3
operator|=
name|RREG32
argument_list|(
name|DPG_PIPE_ARBITRATION_CONTROL3
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|arb_control3
expr_stmt|;
name|tmp
operator|&=
operator|~
name|LATENCY_WATERMARK_MASK
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|LATENCY_WATERMARK_MASK
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DPG_PIPE_ARBITRATION_CONTROL3
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DPG_PIPE_LATENCY_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|LATENCY_LOW_WATERMARK
argument_list|(
name|latency_watermark_a
argument_list|)
operator||
name|LATENCY_HIGH_WATERMARK
argument_list|(
name|line_time
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* select wm B */
name|tmp
operator|=
name|RREG32
argument_list|(
name|DPG_PIPE_ARBITRATION_CONTROL3
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|LATENCY_WATERMARK_MASK
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|LATENCY_WATERMARK_MASK
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DPG_PIPE_ARBITRATION_CONTROL3
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DPG_PIPE_LATENCY_CONTROL
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
operator|(
name|LATENCY_LOW_WATERMARK
argument_list|(
name|latency_watermark_b
argument_list|)
operator||
name|LATENCY_HIGH_WATERMARK
argument_list|(
name|line_time
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* restore original selection */
name|WREG32
argument_list|(
name|DPG_PIPE_ARBITRATION_CONTROL3
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|arb_control3
argument_list|)
expr_stmt|;
comment|/* write the priority marks */
name|WREG32
argument_list|(
name|PRIORITY_A_CNT
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|priority_a_cnt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PRIORITY_B_CNT
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|priority_b_cnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dce6_bandwidth_update
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_display_mode
modifier|*
name|mode0
init|=
name|NULL
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|mode1
init|=
name|NULL
decl_stmt|;
name|u32
name|num_heads
init|=
literal|0
decl_stmt|,
name|lb_size
decl_stmt|;
name|int
name|i
decl_stmt|;
name|radeon_update_display_priority
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
name|num_heads
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|num_crtc
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|mode0
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
name|mode1
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
operator|+
literal|1
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
name|lb_size
operator|=
name|dce6_line_buffer_adjust
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
index|]
argument_list|,
name|mode0
argument_list|,
name|mode1
argument_list|)
expr_stmt|;
name|dce6_program_watermarks
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
index|]
argument_list|,
name|lb_size
argument_list|,
name|num_heads
argument_list|)
expr_stmt|;
name|lb_size
operator|=
name|dce6_line_buffer_adjust
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|mode1
argument_list|,
name|mode0
argument_list|)
expr_stmt|;
name|dce6_program_watermarks
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|lb_size
argument_list|,
name|num_heads
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Core functions  */
end_comment

begin_function
specifier|static
name|void
name|si_tiling_mode_table_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|u32
name|num_tile_mode_states
init|=
literal|32
decl_stmt|;
name|u32
name|reg_offset
decl_stmt|,
name|gb_tile_moden
decl_stmt|,
name|split_equal_to_row_size
decl_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|mem_row_size_in_kb
condition|)
block|{
case|case
literal|1
case|:
name|split_equal_to_row_size
operator|=
name|ADDR_SURF_TILE_SPLIT_1KB
expr_stmt|;
break|break;
case|case
literal|2
case|:
default|default:
name|split_equal_to_row_size
operator|=
name|ADDR_SURF_TILE_SPLIT_2KB
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|split_equal_to_row_size
operator|=
name|ADDR_SURF_TILE_SPLIT_4KB
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_TAHITI
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_PITCAIRN
operator|)
condition|)
block|{
for|for
control|(
name|reg_offset
operator|=
literal|0
init|;
name|reg_offset
operator|<
name|num_tile_mode_states
condition|;
name|reg_offset
operator|++
control|)
block|{
switch|switch
condition|(
name|reg_offset
condition|)
block|{
case|case
literal|0
case|:
comment|/* non-AA compressed depth or any compressed stencil */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_64B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* 2xAA/4xAA compressed depth only */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_128B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* 8xAA compressed depth only */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* 2xAA/4xAA compressed depth with stencil (for depth buffer) */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_128B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* Maps w/ a dimension less than the 2D macro-tile dimensions (for mipmapped depth textures) */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_1D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_64B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* Uncompressed 16bpp depth - and stencil buffer allocated with it */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|split_equal_to_row_size
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* Uncompressed 32bpp depth - and stencil buffer allocated with it */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|split_equal_to_row_size
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_1
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* Uncompressed 8bpp stencil without depth (drivers typically do not use) */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|split_equal_to_row_size
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* 1D and 1D Array Surfaces */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_LINEAR_ALIGNED
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DISPLAY_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_64B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* Displayable maps. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_1D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DISPLAY_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_64B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|10
case|:
comment|/* Display 8bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DISPLAY_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|11
case|:
comment|/* Display 16bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DISPLAY_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|12
case|:
comment|/* Display 32bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DISPLAY_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_512B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_1
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|13
case|:
comment|/* Thin. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_1D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_64B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|14
case|:
comment|/* Thin 8 bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_1
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|15
case|:
comment|/* Thin 16 bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_1
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|16
case|:
comment|/* Thin 32 bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_512B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_1
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|17
case|:
comment|/* Thin 64 bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|split_equal_to_row_size
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_1
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|21
case|:
comment|/* 8 bpp PRT. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_2
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|22
case|:
comment|/* 16 bpp PRT */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_4
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|23
case|:
comment|/* 32 bpp PRT */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|24
case|:
comment|/* 64 bpp PRT */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_512B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|25
case|:
comment|/* 128 bpp PRT */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_1KB
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_8_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_1
argument_list|)
operator|)
expr_stmt|;
break|break;
default|default:
name|gb_tile_moden
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|WREG32
argument_list|(
name|GB_TILE_MODE0
operator|+
operator|(
name|reg_offset
operator|*
literal|4
operator|)
argument_list|,
name|gb_tile_moden
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_VERDE
condition|)
block|{
for|for
control|(
name|reg_offset
operator|=
literal|0
init|;
name|reg_offset
operator|<
name|num_tile_mode_states
condition|;
name|reg_offset
operator|++
control|)
block|{
switch|switch
condition|(
name|reg_offset
condition|)
block|{
case|case
literal|0
case|:
comment|/* non-AA compressed depth or any compressed stencil */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_64B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_4
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* 2xAA/4xAA compressed depth only */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_128B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_4
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* 8xAA compressed depth only */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_4
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* 2xAA/4xAA compressed depth with stencil (for depth buffer) */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_128B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_4
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* Maps w/ a dimension less than the 2D macro-tile dimensions (for mipmapped depth textures) */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_1D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_64B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* Uncompressed 16bpp depth - and stencil buffer allocated with it */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|split_equal_to_row_size
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* Uncompressed 32bpp depth - and stencil buffer allocated with it */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|split_equal_to_row_size
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* Uncompressed 8bpp stencil without depth (drivers typically do not use) */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DEPTH_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|split_equal_to_row_size
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_4
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* 1D and 1D Array Surfaces */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_LINEAR_ALIGNED
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DISPLAY_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_64B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* Displayable maps. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_1D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DISPLAY_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_64B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|10
case|:
comment|/* Display 8bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DISPLAY_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_4
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|11
case|:
comment|/* Display 16bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DISPLAY_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|12
case|:
comment|/* Display 32bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_DISPLAY_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_512B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|13
case|:
comment|/* Thin. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_1D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_64B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|14
case|:
comment|/* Thin 8 bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|15
case|:
comment|/* Thin 16 bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|16
case|:
comment|/* Thin 32 bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_512B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|17
case|:
comment|/* Thin 64 bpp. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P4_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|split_equal_to_row_size
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|21
case|:
comment|/* 8 bpp PRT. */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_2
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|22
case|:
comment|/* 16 bpp PRT */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_4
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_4
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|23
case|:
comment|/* 32 bpp PRT */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_256B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_2
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|24
case|:
comment|/* 64 bpp PRT */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_512B
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_16_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_2
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
literal|25
case|:
comment|/* 128 bpp PRT */
name|gb_tile_moden
operator|=
operator|(
name|ARRAY_MODE
argument_list|(
name|ARRAY_2D_TILED_THIN1
argument_list|)
operator||
name|MICRO_TILE_MODE
argument_list|(
name|ADDR_SURF_THIN_MICRO_TILING
argument_list|)
operator||
name|PIPE_CONFIG
argument_list|(
name|ADDR_SURF_P8_32x32_8x16
argument_list|)
operator||
name|TILE_SPLIT
argument_list|(
name|ADDR_SURF_TILE_SPLIT_1KB
argument_list|)
operator||
name|NUM_BANKS
argument_list|(
name|ADDR_SURF_8_BANK
argument_list|)
operator||
name|BANK_WIDTH
argument_list|(
name|ADDR_SURF_BANK_WIDTH_1
argument_list|)
operator||
name|BANK_HEIGHT
argument_list|(
name|ADDR_SURF_BANK_HEIGHT_1
argument_list|)
operator||
name|MACRO_TILE_ASPECT
argument_list|(
name|ADDR_SURF_MACRO_ASPECT_1
argument_list|)
operator|)
expr_stmt|;
break|break;
default|default:
name|gb_tile_moden
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|WREG32
argument_list|(
name|GB_TILE_MODE0
operator|+
operator|(
name|reg_offset
operator|*
literal|4
operator|)
argument_list|,
name|gb_tile_moden
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|DRM_ERROR
argument_list|(
literal|"unknown asic: 0x%x\n"
argument_list|,
name|rdev
operator|->
name|family
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_select_se_sh
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|se_num
parameter_list|,
name|u32
name|sh_num
parameter_list|)
block|{
name|u32
name|data
init|=
name|INSTANCE_BROADCAST_WRITES
decl_stmt|;
if|if
condition|(
operator|(
name|se_num
operator|==
literal|0xffffffff
operator|)
operator|&&
operator|(
name|sh_num
operator|==
literal|0xffffffff
operator|)
condition|)
name|data
operator|=
name|SH_BROADCAST_WRITES
operator||
name|SE_BROADCAST_WRITES
expr_stmt|;
elseif|else
if|if
condition|(
name|se_num
operator|==
literal|0xffffffff
condition|)
name|data
operator||=
name|SE_BROADCAST_WRITES
operator||
name|SH_INDEX
argument_list|(
name|sh_num
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sh_num
operator|==
literal|0xffffffff
condition|)
name|data
operator||=
name|SH_BROADCAST_WRITES
operator||
name|SE_INDEX
argument_list|(
name|se_num
argument_list|)
expr_stmt|;
else|else
name|data
operator||=
name|SH_INDEX
argument_list|(
name|sh_num
argument_list|)
operator||
name|SE_INDEX
argument_list|(
name|se_num
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_GFX_INDEX
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|si_create_bitmask
parameter_list|(
name|u32
name|bit_width
parameter_list|)
block|{
name|u32
name|i
decl_stmt|,
name|mask
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bit_width
condition|;
name|i
operator|++
control|)
block|{
name|mask
operator|<<=
literal|1
expr_stmt|;
name|mask
operator||=
literal|1
expr_stmt|;
block|}
return|return
name|mask
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|si_get_cu_enabled
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|cu_per_sh
parameter_list|)
block|{
name|u32
name|data
decl_stmt|,
name|mask
decl_stmt|;
name|data
operator|=
name|RREG32
argument_list|(
name|CC_GC_SHADER_ARRAY_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
literal|1
condition|)
name|data
operator|&=
name|INACTIVE_CUS_MASK
expr_stmt|;
else|else
name|data
operator|=
literal|0
expr_stmt|;
name|data
operator||=
name|RREG32
argument_list|(
name|GC_USER_SHADER_ARRAY_CONFIG
argument_list|)
expr_stmt|;
name|data
operator|>>=
name|INACTIVE_CUS_SHIFT
expr_stmt|;
name|mask
operator|=
name|si_create_bitmask
argument_list|(
name|cu_per_sh
argument_list|)
expr_stmt|;
return|return
operator|~
name|data
operator|&
name|mask
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_setup_spi
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|se_num
parameter_list|,
name|u32
name|sh_per_se
parameter_list|,
name|u32
name|cu_per_sh
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|u32
name|data
decl_stmt|,
name|mask
decl_stmt|,
name|active_cu
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|se_num
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|sh_per_se
condition|;
name|j
operator|++
control|)
block|{
name|si_select_se_sh
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|data
operator|=
name|RREG32
argument_list|(
name|SPI_STATIC_THREAD_MGMT_3
argument_list|)
expr_stmt|;
name|active_cu
operator|=
name|si_get_cu_enabled
argument_list|(
name|rdev
argument_list|,
name|cu_per_sh
argument_list|)
expr_stmt|;
name|mask
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|16
condition|;
name|k
operator|++
control|)
block|{
name|mask
operator|<<=
name|k
expr_stmt|;
if|if
condition|(
name|active_cu
operator|&
name|mask
condition|)
block|{
name|data
operator|&=
operator|~
name|mask
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_STATIC_THREAD_MGMT_3
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
name|si_select_se_sh
argument_list|(
name|rdev
argument_list|,
literal|0xffffffff
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|si_get_rb_disabled
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|max_rb_num
parameter_list|,
name|u32
name|se_num
parameter_list|,
name|u32
name|sh_per_se
parameter_list|)
block|{
name|u32
name|data
decl_stmt|,
name|mask
decl_stmt|;
name|data
operator|=
name|RREG32
argument_list|(
name|CC_RB_BACKEND_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
literal|1
condition|)
name|data
operator|&=
name|BACKEND_DISABLE_MASK
expr_stmt|;
else|else
name|data
operator|=
literal|0
expr_stmt|;
name|data
operator||=
name|RREG32
argument_list|(
name|GC_USER_RB_BACKEND_DISABLE
argument_list|)
expr_stmt|;
name|data
operator|>>=
name|BACKEND_DISABLE_SHIFT
expr_stmt|;
name|mask
operator|=
name|si_create_bitmask
argument_list|(
name|max_rb_num
operator|/
name|se_num
operator|/
name|sh_per_se
argument_list|)
expr_stmt|;
return|return
name|data
operator|&
name|mask
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_setup_rb
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|se_num
parameter_list|,
name|u32
name|sh_per_se
parameter_list|,
name|u32
name|max_rb_num
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u32
name|data
decl_stmt|,
name|mask
decl_stmt|;
name|u32
name|disabled_rbs
init|=
literal|0
decl_stmt|;
name|u32
name|enabled_rbs
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|se_num
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|sh_per_se
condition|;
name|j
operator|++
control|)
block|{
name|si_select_se_sh
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|data
operator|=
name|si_get_rb_disabled
argument_list|(
name|rdev
argument_list|,
name|max_rb_num
argument_list|,
name|se_num
argument_list|,
name|sh_per_se
argument_list|)
expr_stmt|;
name|disabled_rbs
operator||=
name|data
operator|<<
operator|(
operator|(
name|i
operator|*
name|sh_per_se
operator|+
name|j
operator|)
operator|*
name|TAHITI_RB_BITMAP_WIDTH_PER_SH
operator|)
expr_stmt|;
block|}
block|}
name|si_select_se_sh
argument_list|(
name|rdev
argument_list|,
literal|0xffffffff
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|mask
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_rb_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|disabled_rbs
operator|&
name|mask
operator|)
condition|)
name|enabled_rbs
operator||=
name|mask
expr_stmt|;
name|mask
operator|<<=
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|se_num
condition|;
name|i
operator|++
control|)
block|{
name|si_select_se_sh
argument_list|(
name|rdev
argument_list|,
name|i
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|data
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|sh_per_se
condition|;
name|j
operator|++
control|)
block|{
switch|switch
condition|(
name|enabled_rbs
operator|&
literal|3
condition|)
block|{
case|case
literal|1
case|:
name|data
operator||=
operator|(
name|RASTER_CONFIG_RB_MAP_0
operator|<<
operator|(
name|i
operator|*
name|sh_per_se
operator|+
name|j
operator|)
operator|*
literal|2
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|data
operator||=
operator|(
name|RASTER_CONFIG_RB_MAP_3
operator|<<
operator|(
name|i
operator|*
name|sh_per_se
operator|+
name|j
operator|)
operator|*
literal|2
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
default|default:
name|data
operator||=
operator|(
name|RASTER_CONFIG_RB_MAP_2
operator|<<
operator|(
name|i
operator|*
name|sh_per_se
operator|+
name|j
operator|)
operator|*
literal|2
operator|)
expr_stmt|;
break|break;
block|}
name|enabled_rbs
operator|>>=
literal|2
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|PA_SC_RASTER_CONFIG
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
name|si_select_se_sh
argument_list|(
name|rdev
argument_list|,
literal|0xffffffff
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|gb_addr_config
init|=
literal|0
decl_stmt|;
name|u32
name|mc_shared_chmap
decl_stmt|,
name|mc_arb_ramcfg
decl_stmt|;
name|u32
name|sx_debug_1
decl_stmt|;
name|u32
name|hdp_host_path_cntl
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_TAHITI
case|:
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_shader_engines
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_tile_pipes
operator|=
literal|12
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_cu_per_sh
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_sh_per_se
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_backends_per_se
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_texture_channel_caches
operator|=
literal|12
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_prim_fifo_size_frontend
operator|=
literal|0x20
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_prim_fifo_size_backend
operator|=
literal|0x100
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|TAHITI_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_PITCAIRN
case|:
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_shader_engines
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_tile_pipes
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_cu_per_sh
operator|=
literal|5
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_sh_per_se
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_backends_per_se
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_texture_channel_caches
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_prim_fifo_size_frontend
operator|=
literal|0x20
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_prim_fifo_size_backend
operator|=
literal|0x100
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|TAHITI_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_VERDE
case|:
default|default:
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_shader_engines
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_cu_per_sh
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_sh_per_se
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_backends_per_se
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_texture_channel_caches
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_prim_fifo_size_frontend
operator|=
literal|0x20
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_prim_fifo_size_backend
operator|=
literal|0x40
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|VERDE_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
block|}
comment|/* Initialize HDP */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
operator|,
name|j
operator|+=
literal|0x18
control|)
block|{
name|WREG32
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|GRBM_CNTL
argument_list|,
name|GRBM_READ_TIMEOUT
argument_list|(
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
name|evergreen_fix_pci_max_read_req_size
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|BIF_FB_EN
argument_list|,
name|FB_READ_EN
operator||
name|FB_WRITE_EN
argument_list|)
expr_stmt|;
name|mc_shared_chmap
operator|=
name|RREG32
argument_list|(
name|MC_SHARED_CHMAP
argument_list|)
expr_stmt|;
name|mc_arb_ramcfg
operator|=
name|RREG32
argument_list|(
name|MC_ARB_RAMCFG
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|num_tile_pipes
operator|=
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_tile_pipes
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|mem_max_burst_length_bytes
operator|=
literal|256
expr_stmt|;
name|tmp
operator|=
operator|(
name|mc_arb_ramcfg
operator|&
name|NOOFCOLS_MASK
operator|)
operator|>>
name|NOOFCOLS_SHIFT
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|mem_row_size_in_kb
operator|=
operator|(
literal|4
operator|*
operator|(
literal|1
operator|<<
operator|(
literal|8
operator|+
name|tmp
operator|)
operator|)
operator|)
operator|/
literal|1024
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|mem_row_size_in_kb
operator|>
literal|4
condition|)
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|mem_row_size_in_kb
operator|=
literal|4
expr_stmt|;
comment|/* XXX use MC settings? */
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|shader_engine_tile_size
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|num_gpus
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|multi_gpu_tile_size
operator|=
literal|64
expr_stmt|;
comment|/* fix up row size */
name|gb_addr_config
operator|&=
operator|~
name|ROW_SIZE_MASK
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|mem_row_size_in_kb
condition|)
block|{
case|case
literal|1
case|:
default|default:
name|gb_addr_config
operator||=
name|ROW_SIZE
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|gb_addr_config
operator||=
name|ROW_SIZE
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|gb_addr_config
operator||=
name|ROW_SIZE
argument_list|(
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* setup tiling info dword.  gb_addr_config is not adequate since it does 	 * not have bank info, so create a custom tiling dword. 	 * bits 3:0   num_pipes 	 * bits 7:4   num_banks 	 * bits 11:8  group_size 	 * bits 15:12 row_size 	 */
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|tile_config
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|num_tile_pipes
condition|)
block|{
case|case
literal|1
case|:
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|tile_config
operator||=
operator|(
literal|0
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|tile_config
operator||=
operator|(
literal|1
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|tile_config
operator||=
operator|(
literal|2
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
default|default:
comment|/* XXX what about 12? */
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|tile_config
operator||=
operator|(
literal|3
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
operator|(
name|mc_arb_ramcfg
operator|&
name|NOOFBANK_MASK
operator|)
operator|>>
name|NOOFBANK_SHIFT
condition|)
block|{
case|case
literal|0
case|:
comment|/* four banks */
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|tile_config
operator||=
literal|0
operator|<<
literal|4
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* eight banks */
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|tile_config
operator||=
literal|1
operator|<<
literal|4
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* sixteen banks */
default|default:
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|tile_config
operator||=
literal|2
operator|<<
literal|4
expr_stmt|;
break|break;
block|}
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|tile_config
operator||=
operator|(
operator|(
name|gb_addr_config
operator|&
name|PIPE_INTERLEAVE_SIZE_MASK
operator|)
operator|>>
name|PIPE_INTERLEAVE_SIZE_SHIFT
operator|)
operator|<<
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|tile_config
operator||=
operator|(
operator|(
name|gb_addr_config
operator|&
name|ROW_SIZE_MASK
operator|)
operator|>>
name|ROW_SIZE_SHIFT
operator|)
operator|<<
literal|12
expr_stmt|;
name|WREG32
argument_list|(
name|GB_ADDR_CONFIG
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMIF_ADDR_CONFIG
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_ADDR_CONFIG
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_TILING_CONFIG
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_TILING_CONFIG
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|si_tiling_mode_table_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_setup_rb
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_shader_engines
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_sh_per_se
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_backends_per_se
argument_list|)
expr_stmt|;
name|si_setup_spi
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_shader_engines
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_sh_per_se
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_cu_per_sh
argument_list|)
expr_stmt|;
comment|/* set HW defaults for 3D engine */
name|WREG32
argument_list|(
name|CP_QUEUE_THRESHOLDS
argument_list|,
operator|(
name|ROQ_IB1_START
argument_list|(
literal|0x16
argument_list|)
operator||
name|ROQ_IB2_START
argument_list|(
literal|0x2b
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_MEQ_THRESHOLDS
argument_list|,
name|MEQ1_START
argument_list|(
literal|0x30
argument_list|)
operator||
name|MEQ2_START
argument_list|(
literal|0x60
argument_list|)
argument_list|)
expr_stmt|;
name|sx_debug_1
operator|=
name|RREG32
argument_list|(
name|SX_DEBUG_1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SX_DEBUG_1
argument_list|,
name|sx_debug_1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_CONFIG_CNTL_1
argument_list|,
name|VTX_DONE_DELAY
argument_list|(
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_FIFO_SIZE
argument_list|,
operator|(
name|SC_FRONTEND_PRIM_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_prim_fifo_size_frontend
argument_list|)
operator||
name|SC_BACKEND_PRIM_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_prim_fifo_size_backend
argument_list|)
operator||
name|SC_HIZ_TILE_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_hiz_tile_fifo_size
argument_list|)
operator||
name|SC_EARLYZ_TILE_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|sc_earlyz_tile_fifo_size
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_NUM_INSTANCES
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PERFMON_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_CONFIG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_FORCE_EOV_MAX_CNTS
argument_list|,
operator|(
name|FORCE_EOV_MAX_CLK_CNT
argument_list|(
literal|4095
argument_list|)
operator||
name|FORCE_EOV_MAX_REZ_CNT
argument_list|(
literal|255
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_CACHE_INVALIDATION
argument_list|,
name|CACHE_INVALIDATION
argument_list|(
name|VC_AND_TC
argument_list|)
operator||
name|AUTO_INVLD_EN
argument_list|(
name|ES_AND_GS_AUTO
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_GS_VERTEX_REUSE
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_LINE_STIPPLE_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERFCOUNTER0_SELECT0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERFCOUNTER0_SELECT1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERFCOUNTER1_SELECT0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERFCOUNTER1_SELECT1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERFCOUNTER2_SELECT0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERFCOUNTER2_SELECT1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERFCOUNTER3_SELECT0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERFCOUNTER3_SELECT1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|HDP_MISC_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|HDP_FLUSH_INVALIDATE_CACHE
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_MISC_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|hdp_host_path_cntl
operator|=
name|RREG32
argument_list|(
name|HDP_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_HOST_PATH_CNTL
argument_list|,
name|hdp_host_path_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_CL_ENHANCE
argument_list|,
name|CLIP_VTX_REORDER_ENA
operator||
name|NUM_CLIP_SEQ
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * GPU scratch registers helpers function.  */
end_comment

begin_function
specifier|static
name|void
name|si_scratch_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|rdev
operator|->
name|scratch
operator|.
name|num_reg
operator|=
literal|7
expr_stmt|;
name|rdev
operator|->
name|scratch
operator|.
name|reg_base
operator|=
name|SCRATCH_REG0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|scratch
operator|.
name|num_reg
condition|;
name|i
operator|++
control|)
block|{
name|rdev
operator|->
name|scratch
operator|.
name|free
index|[
name|i
index|]
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|scratch
operator|.
name|reg
index|[
name|i
index|]
operator|=
name|rdev
operator|->
name|scratch
operator|.
name|reg_base
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|si_fence_ring_emit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_fence
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|fence
operator|->
name|ring
index|]
decl_stmt|;
name|u64
name|addr
init|=
name|rdev
operator|->
name|fence_drv
index|[
name|fence
operator|->
name|ring
index|]
operator|.
name|gpu_addr
decl_stmt|;
comment|/* flush read cache over gart */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|CP_COHER_CNTL2
operator|-
name|PACKET3_SET_CONFIG_REG_START
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SURFACE_SYNC
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_TCL1_ACTION_ENA
operator||
name|PACKET3_TC_ACTION_ENA
operator||
name|PACKET3_SH_KCACHE_ACTION_ENA
operator||
name|PACKET3_SH_ICACHE_ACTION_ENA
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* poll interval */
comment|/* EVENT_WRITE_EOP - flush caches, send int */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_EVENT_WRITE_EOP
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|EVENT_TYPE
argument_list|(
name|CACHE_FLUSH_AND_INV_TS_EVENT
argument_list|)
operator||
name|EVENT_INDEX
argument_list|(
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|addr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|upper_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xff
operator|)
operator||
name|DATA_SEL
argument_list|(
literal|1
argument_list|)
operator||
name|INT_SEL
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|fence
operator|->
name|seq
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * IB stuff  */
end_comment

begin_function
name|void
name|si_ring_ib_execute
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ib
operator|->
name|ring
index|]
decl_stmt|;
name|u32
name|header
decl_stmt|;
if|if
condition|(
name|ib
operator|->
name|is_const_ib
condition|)
block|{
comment|/* set switch buffer packet before const IB */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SWITCH_BUFFER
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|header
operator|=
name|PACKET3
argument_list|(
name|PACKET3_INDIRECT_BUFFER_CONST
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u32
name|next_rptr
decl_stmt|;
if|if
condition|(
name|ring
operator|->
name|rptr_save_reg
condition|)
block|{
name|next_rptr
operator|=
name|ring
operator|->
name|wptr
operator|+
literal|3
operator|+
literal|4
operator|+
literal|8
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
name|ring
operator|->
name|rptr_save_reg
operator|-
name|PACKET3_SET_CONFIG_REG_START
operator|)
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
block|{
name|next_rptr
operator|=
name|ring
operator|->
name|wptr
operator|+
literal|5
operator|+
literal|4
operator|+
literal|8
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_WRITE_DATA
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|1
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ring
operator|->
name|next_rptr_gpu_addr
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|ring
operator|->
name|next_rptr_gpu_addr
argument_list|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
block|}
name|header
operator|=
name|PACKET3
argument_list|(
name|PACKET3_INDIRECT_BUFFER
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|header
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
operator|(
literal|2
operator|<<
literal|0
operator|)
operator||
endif|#
directive|endif
operator|(
name|ib
operator|->
name|gpu_addr
operator|&
literal|0xFFFFFFFC
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|ib
operator|->
name|gpu_addr
argument_list|)
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ib
operator|->
name|length_dw
operator||
operator|(
name|ib
operator|->
name|vm
condition|?
operator|(
name|ib
operator|->
name|vm
operator|->
name|id
operator|<<
literal|24
operator|)
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ib
operator|->
name|is_const_ib
condition|)
block|{
comment|/* flush read cache over gart for this vmid */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|CP_COHER_CNTL2
operator|-
name|PACKET3_SET_CONFIG_REG_START
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ib
operator|->
name|vm
condition|?
name|ib
operator|->
name|vm
operator|->
name|id
else|:
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SURFACE_SYNC
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_TCL1_ACTION_ENA
operator||
name|PACKET3_TC_ACTION_ENA
operator||
name|PACKET3_SH_KCACHE_ACTION_ENA
operator||
name|PACKET3_SH_ICACHE_ACTION_ENA
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* poll interval */
block|}
block|}
end_function

begin_comment
comment|/*  * CP.  */
end_comment

begin_function
specifier|static
name|void
name|si_cp_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
if|if
condition|(
name|enable
condition|)
name|WREG32
argument_list|(
name|CP_ME_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|radeon_ttm_set_active_vram_size
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_CNTL
argument_list|,
operator|(
name|CP_ME_HALT
operator||
name|CP_PFP_HALT
operator||
name|CP_CE_HALT
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
block|}
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_cp_load_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|__be32
modifier|*
name|fw_data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
condition|)
return|return
operator|-
name|EINVAL
return|;
name|si_cp_enable
argument_list|(
name|rdev
argument_list|,
name|false
argument_list|)
expr_stmt|;
comment|/* PFP */
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|pfp_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SI_PFP_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_PFP_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* CE */
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|ce_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_CE_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SI_CE_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_CE_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_CE_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* ME */
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|me_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SI_PM4_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_ME_RAM_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_CE_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_RADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_cp_start
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|int
name|r
decl_stmt|,
name|i
decl_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|7
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to lock ring (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* init the CP */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_ME_INITIALIZE
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|si
operator|.
name|max_hw_contexts
operator|-
literal|1
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_ME_INITIALIZE_DEVICE_ID
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* init the CE partitions */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_BASE
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_BASE_INDEX
argument_list|(
name|CE_PARTITION_BASE
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xc000
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xe000
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|si_cp_enable
argument_list|(
name|rdev
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|si_default_size
operator|+
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to lock ring (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* setup clear context state */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_PREAMBLE_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_PREAMBLE_BEGIN_CLEAR_STATE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|si_default_size
condition|;
name|i
operator|++
control|)
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|si_default_state
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_PREAMBLE_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_PREAMBLE_END_CLEAR_STATE
argument_list|)
expr_stmt|;
comment|/* set clear context state */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_CLEAR_STATE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONTEXT_REG
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000316
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x0000000e
argument_list|)
expr_stmt|;
comment|/* VGT_VERTEX_REUSE_BLOCK_CNTL */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/* VGT_OUT_DEALLOC_CNTL */
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|RADEON_RING_TYPE_GFX_INDEX
init|;
name|i
operator|<=
name|CAYMAN_RING_TYPE_CP2_INDEX
condition|;
operator|++
name|i
control|)
block|{
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|i
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* clear the compute context state */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_COMPUTE
argument_list|(
name|PACKET3_CLEAR_STATE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_cp_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
decl_stmt|;
name|si_cp_enable
argument_list|(
name|rdev
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
expr_stmt|;
name|radeon_ring_fini
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|ring
operator|->
name|rptr_save_reg
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
expr_stmt|;
name|radeon_ring_fini
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|ring
operator|->
name|rptr_save_reg
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
expr_stmt|;
name|radeon_ring_fini
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|ring
operator|->
name|rptr_save_reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_cp_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|u32
name|rb_bufsz
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* Reset cp; if cp is reset, then PA, SH, VGT also need to be reset */
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
operator|(
name|SOFT_RESET_CP
operator||
name|SOFT_RESET_PA
operator||
name|SOFT_RESET_VGT
operator||
name|SOFT_RESET_SPI
operator||
name|SOFT_RESET_SX
operator|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_SEM_WAIT_TIMER
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_SEM_INCOMPLETE_TIMER_CNTL
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* Set the write pointer delay */
name|WREG32
argument_list|(
name|CP_RB_WPTR_DELAY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_DEBUG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_ADDR
argument_list|,
operator|(
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_SCRATCH_OFFSET
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
comment|/* ring 0 - compute and gfx */
comment|/* Set ring buffer size */
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
expr_stmt|;
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|ring
operator|->
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|drm_order
argument_list|(
name|RADEON_GPU_PAGE_SIZE
operator|/
literal|8
argument_list|)
operator|<<
literal|8
operator|)
operator||
name|rb_bufsz
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|tmp
operator||=
name|BUF_SWAP_32BIT
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|CP_RB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Initialize the ring buffer's read and write pointers */
name|WREG32
argument_list|(
name|CP_RB0_CNTL
argument_list|,
name|tmp
operator||
name|RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
name|ring
operator|->
name|wptr
operator|=
literal|0
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB0_WPTR
argument_list|,
name|ring
operator|->
name|wptr
argument_list|)
expr_stmt|;
comment|/* set the wb address whether it's enabled or not */
name|WREG32
argument_list|(
name|CP_RB0_RPTR_ADDR
argument_list|,
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP_RPTR_OFFSET
operator|)
operator|&
literal|0xFFFFFFFC
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB0_RPTR_ADDR_HI
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP_RPTR_OFFSET
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
else|else
block|{
name|tmp
operator||=
name|RB_NO_UPDATE
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB0_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB0_BASE
argument_list|,
name|ring
operator|->
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr
operator|=
name|RREG32
argument_list|(
name|CP_RB0_RPTR
argument_list|)
expr_stmt|;
comment|/* ring1  - compute only */
comment|/* Set ring buffer size */
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
expr_stmt|;
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|ring
operator|->
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|drm_order
argument_list|(
name|RADEON_GPU_PAGE_SIZE
operator|/
literal|8
argument_list|)
operator|<<
literal|8
operator|)
operator||
name|rb_bufsz
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|tmp
operator||=
name|BUF_SWAP_32BIT
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|CP_RB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Initialize the ring buffer's read and write pointers */
name|WREG32
argument_list|(
name|CP_RB1_CNTL
argument_list|,
name|tmp
operator||
name|RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
name|ring
operator|->
name|wptr
operator|=
literal|0
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB1_WPTR
argument_list|,
name|ring
operator|->
name|wptr
argument_list|)
expr_stmt|;
comment|/* set the wb address whether it's enabled or not */
name|WREG32
argument_list|(
name|CP_RB1_RPTR_ADDR
argument_list|,
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP1_RPTR_OFFSET
operator|)
operator|&
literal|0xFFFFFFFC
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB1_RPTR_ADDR_HI
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP1_RPTR_OFFSET
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB1_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB1_BASE
argument_list|,
name|ring
operator|->
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr
operator|=
name|RREG32
argument_list|(
name|CP_RB1_RPTR
argument_list|)
expr_stmt|;
comment|/* ring2 - compute only */
comment|/* Set ring buffer size */
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
expr_stmt|;
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|ring
operator|->
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|drm_order
argument_list|(
name|RADEON_GPU_PAGE_SIZE
operator|/
literal|8
argument_list|)
operator|<<
literal|8
operator|)
operator||
name|rb_bufsz
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|tmp
operator||=
name|BUF_SWAP_32BIT
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|CP_RB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Initialize the ring buffer's read and write pointers */
name|WREG32
argument_list|(
name|CP_RB2_CNTL
argument_list|,
name|tmp
operator||
name|RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
name|ring
operator|->
name|wptr
operator|=
literal|0
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB2_WPTR
argument_list|,
name|ring
operator|->
name|wptr
argument_list|)
expr_stmt|;
comment|/* set the wb address whether it's enabled or not */
name|WREG32
argument_list|(
name|CP_RB2_RPTR_ADDR
argument_list|,
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP2_RPTR_OFFSET
operator|)
operator|&
literal|0xFFFFFFFC
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB2_RPTR_ADDR_HI
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP2_RPTR_OFFSET
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB2_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB2_BASE
argument_list|,
name|ring
operator|->
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr
operator|=
name|RREG32
argument_list|(
name|CP_RB2_RPTR
argument_list|)
expr_stmt|;
comment|/* start the rings */
name|si_cp_start
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ready
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
operator|.
name|ready
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
operator|.
name|ready
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|radeon_ring_test
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_ring_test
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP1_INDEX
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
block|}
name|r
operator|=
name|radeon_ring_test
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP2_INDEX
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|bool
name|si_gpu_is_lockup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|u32
name|srbm_status
decl_stmt|;
name|u32
name|grbm_status
decl_stmt|,
name|grbm_status2
decl_stmt|;
name|u32
name|grbm_status_se0
decl_stmt|,
name|grbm_status_se1
decl_stmt|;
name|srbm_status
operator|=
name|RREG32
argument_list|(
name|SRBM_STATUS
argument_list|)
expr_stmt|;
name|grbm_status
operator|=
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
expr_stmt|;
name|grbm_status2
operator|=
name|RREG32
argument_list|(
name|GRBM_STATUS2
argument_list|)
expr_stmt|;
name|grbm_status_se0
operator|=
name|RREG32
argument_list|(
name|GRBM_STATUS_SE0
argument_list|)
expr_stmt|;
name|grbm_status_se1
operator|=
name|RREG32
argument_list|(
name|GRBM_STATUS_SE1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|grbm_status
operator|&
name|GUI_ACTIVE
operator|)
condition|)
block|{
name|radeon_ring_lockup_update
argument_list|(
name|ring
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* force CP activities */
name|radeon_ring_force_activity
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|radeon_ring_test_lockup
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_gpu_soft_reset_gfx
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|grbm_reset
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
operator|&
name|GUI_ACTIVE
operator|)
condition|)
return|return;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS=0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS2=0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS2
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE0=0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE0
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE1=0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  SRBM_STATUS=0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|SRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Disable CP parsing/prefetching */
name|WREG32
argument_list|(
name|CP_ME_CNTL
argument_list|,
name|CP_ME_HALT
operator||
name|CP_PFP_HALT
operator||
name|CP_CE_HALT
argument_list|)
expr_stmt|;
comment|/* reset all the gfx blocks */
name|grbm_reset
operator|=
operator|(
name|SOFT_RESET_CP
operator||
name|SOFT_RESET_CB
operator||
name|SOFT_RESET_DB
operator||
name|SOFT_RESET_GDS
operator||
name|SOFT_RESET_PA
operator||
name|SOFT_RESET_SC
operator||
name|SOFT_RESET_BCI
operator||
name|SOFT_RESET_SPI
operator||
name|SOFT_RESET_SX
operator||
name|SOFT_RESET_TC
operator||
name|SOFT_RESET_TA
operator||
name|SOFT_RESET_VGT
operator||
name|SOFT_RESET_IA
operator|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_SOFT_RESET=0x%08X\n"
argument_list|,
name|grbm_reset
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
name|grbm_reset
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS=0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS2=0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS2
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE0=0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE0
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE1=0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  SRBM_STATUS=0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|SRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_gpu_soft_reset_dma
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
operator|&
name|DMA_IDLE
condition|)
return|return;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  DMA_STATUS_REG   = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
argument_list|)
expr_stmt|;
comment|/* dma0 */
name|tmp
operator|=
name|RREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|DMA_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* dma1 */
name|tmp
operator|=
name|RREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|DMA_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Reset dma */
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
name|SOFT_RESET_DMA
operator||
name|SOFT_RESET_DMA1
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  DMA_STATUS_REG   = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_gpu_soft_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|reset_mask
parameter_list|)
block|{
name|struct
name|evergreen_mc_save
name|save
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
operator|&
name|GUI_ACTIVE
operator|)
condition|)
name|reset_mask
operator|&=
operator|~
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator|)
expr_stmt|;
if|if
condition|(
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
operator|&
name|DMA_IDLE
condition|)
name|reset_mask
operator|&=
operator|~
name|RADEON_RESET_DMA
expr_stmt|;
if|if
condition|(
name|reset_mask
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU softreset: 0x%08X\n"
argument_list|,
name|reset_mask
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  VM_CONTEXT1_PROTECTION_FAULT_ADDR   0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|VM_CONTEXT1_PROTECTION_FAULT_ADDR
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  VM_CONTEXT1_PROTECTION_FAULT_STATUS 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|VM_CONTEXT1_PROTECTION_FAULT_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|evergreen_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reset_mask
operator|&
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator|)
condition|)
name|si_gpu_soft_reset_gfx
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset_mask
operator|&
name|RADEON_RESET_DMA
condition|)
name|si_gpu_soft_reset_dma
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Wait a little for things to settle down */
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|evergreen_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|si_asic_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
return|return
name|si_gpu_soft_reset
argument_list|(
name|rdev
argument_list|,
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator||
name|RADEON_RESET_DMA
operator|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* MC */
end_comment

begin_function
specifier|static
name|void
name|si_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|evergreen_mc_save
name|save
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Initialize HDP */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
operator|,
name|j
operator|+=
literal|0x18
control|)
block|{
name|WREG32
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|HDP_REG_COHERENCY_FLUSH_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evergreen_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Lockout access through VGA aperture*/
name|WREG32
argument_list|(
name|VGA_HDP_CONTROL
argument_list|,
name|VGA_MEMORY_DISABLE
argument_list|)
expr_stmt|;
comment|/* Update configuration */
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_DEFAULT_ADDR
argument_list|,
name|rdev
operator|->
name|vram_scratch
operator|.
name|gpu_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|24
operator|)
operator|&
literal|0xFFFF
operator|)
operator|<<
literal|16
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|24
operator|)
operator|&
literal|0xFFFF
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_FB_LOCATION
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* XXX double check these! */
name|WREG32
argument_list|(
name|HDP_NONSURFACE_BASE
argument_list|,
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_INFO
argument_list|,
operator|(
literal|2
operator|<<
literal|7
operator|)
operator||
operator|(
literal|1
operator|<<
literal|30
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_SIZE
argument_list|,
literal|0x3FFFFFFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_TOP
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BOT
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
name|evergreen_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
comment|/* we need to own VRAM, so turn off the VGA renderer here 	 * to stop it overwriting our objects */
name|rv515_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* SI MC address space is 40 bits */
end_comment

begin_function
specifier|static
name|void
name|si_vram_location
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_mc
modifier|*
name|mc
parameter_list|,
name|u64
name|base
parameter_list|)
block|{
name|mc
operator|->
name|vram_start
operator|=
name|base
expr_stmt|;
if|if
condition|(
name|mc
operator|->
name|mc_vram_size
operator|>
operator|(
literal|0xFFFFFFFFFFULL
operator|-
name|base
operator|+
literal|1
operator|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"limiting VRAM to PCI aperture size\n"
argument_list|)
expr_stmt|;
name|mc
operator|->
name|real_vram_size
operator|=
name|mc
operator|->
name|aper_size
expr_stmt|;
name|mc
operator|->
name|mc_vram_size
operator|=
name|mc
operator|->
name|aper_size
expr_stmt|;
block|}
name|mc
operator|->
name|vram_end
operator|=
name|mc
operator|->
name|vram_start
operator|+
name|mc
operator|->
name|mc_vram_size
operator|-
literal|1
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"VRAM: %juM 0x%016jX - 0x%016jX (%juM used)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|mc_vram_size
operator|>>
literal|20
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|vram_start
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|vram_end
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|real_vram_size
operator|>>
literal|20
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_gtt_location
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_mc
modifier|*
name|mc
parameter_list|)
block|{
name|u64
name|size_af
decl_stmt|,
name|size_bf
decl_stmt|;
name|size_af
operator|=
operator|(
operator|(
literal|0xFFFFFFFFFFULL
operator|-
name|mc
operator|->
name|vram_end
operator|)
operator|+
name|mc
operator|->
name|gtt_base_align
operator|)
operator|&
operator|~
name|mc
operator|->
name|gtt_base_align
expr_stmt|;
name|size_bf
operator|=
name|mc
operator|->
name|vram_start
operator|&
operator|~
name|mc
operator|->
name|gtt_base_align
expr_stmt|;
if|if
condition|(
name|size_bf
operator|>
name|size_af
condition|)
block|{
if|if
condition|(
name|mc
operator|->
name|gtt_size
operator|>
name|size_bf
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"limiting GTT\n"
argument_list|)
expr_stmt|;
name|mc
operator|->
name|gtt_size
operator|=
name|size_bf
expr_stmt|;
block|}
name|mc
operator|->
name|gtt_start
operator|=
operator|(
name|mc
operator|->
name|vram_start
operator|&
operator|~
name|mc
operator|->
name|gtt_base_align
operator|)
operator|-
name|mc
operator|->
name|gtt_size
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mc
operator|->
name|gtt_size
operator|>
name|size_af
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"limiting GTT\n"
argument_list|)
expr_stmt|;
name|mc
operator|->
name|gtt_size
operator|=
name|size_af
expr_stmt|;
block|}
name|mc
operator|->
name|gtt_start
operator|=
operator|(
name|mc
operator|->
name|vram_end
operator|+
literal|1
operator|+
name|mc
operator|->
name|gtt_base_align
operator|)
operator|&
operator|~
name|mc
operator|->
name|gtt_base_align
expr_stmt|;
block|}
name|mc
operator|->
name|gtt_end
operator|=
name|mc
operator|->
name|gtt_start
operator|+
name|mc
operator|->
name|gtt_size
operator|-
literal|1
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GTT: %juM 0x%016jX - 0x%016jX\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|gtt_size
operator|>>
literal|20
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|gtt_start
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|gtt_end
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_vram_gtt_location
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_mc
modifier|*
name|mc
parameter_list|)
block|{
if|if
condition|(
name|mc
operator|->
name|mc_vram_size
operator|>
literal|0xFFC0000000ULL
condition|)
block|{
comment|/* leave room for at least 1024M GTT */
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"limiting VRAM\n"
argument_list|)
expr_stmt|;
name|mc
operator|->
name|real_vram_size
operator|=
literal|0xFFC0000000ULL
expr_stmt|;
name|mc
operator|->
name|mc_vram_size
operator|=
literal|0xFFC0000000ULL
expr_stmt|;
block|}
name|si_vram_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_base_align
operator|=
literal|0
expr_stmt|;
name|si_gtt_location
argument_list|(
name|rdev
argument_list|,
name|mc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|chansize
decl_stmt|,
name|numchan
decl_stmt|;
comment|/* Get VRAM informations */
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|MC_ARB_RAMCFG
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|CHANSIZE_OVERRIDE
condition|)
block|{
name|chansize
operator|=
literal|16
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tmp
operator|&
name|CHANSIZE_MASK
condition|)
block|{
name|chansize
operator|=
literal|64
expr_stmt|;
block|}
else|else
block|{
name|chansize
operator|=
literal|32
expr_stmt|;
block|}
name|tmp
operator|=
name|RREG32
argument_list|(
name|MC_SHARED_CHMAP
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|tmp
operator|&
name|NOOFCHAN_MASK
operator|)
operator|>>
name|NOOFCHAN_SHIFT
condition|)
block|{
case|case
literal|0
case|:
default|default:
name|numchan
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|numchan
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|numchan
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|numchan
operator|=
literal|8
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|numchan
operator|=
literal|3
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|numchan
operator|=
literal|6
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|numchan
operator|=
literal|10
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|numchan
operator|=
literal|12
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|numchan
operator|=
literal|16
expr_stmt|;
break|break;
block|}
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
name|numchan
operator|*
name|chansize
expr_stmt|;
comment|/* Could aper size report 0 ? */
name|rdev
operator|->
name|mc
operator|.
name|aper_base
operator|=
name|drm_get_resource_start
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|aper_size
operator|=
name|drm_get_resource_len
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* size in MB on si */
name|rdev
operator|->
name|mc
operator|.
name|mc_vram_size
operator|=
name|RREG32
argument_list|(
name|CONFIG_MEMSIZE
argument_list|)
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|=
name|RREG32
argument_list|(
name|CONFIG_MEMSIZE
argument_list|)
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_size
expr_stmt|;
name|si_vram_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * GART  */
end_comment

begin_function
name|void
name|si_pcie_gart_tlb_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* flush hdp cache */
name|WREG32
argument_list|(
name|HDP_MEM_COHERENCY_FLUSH_CNTL
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
comment|/* bits 0-15 are the VM contexts0-15 */
name|WREG32
argument_list|(
name|VM_INVALIDATE_REQUEST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_pcie_gart_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"No VRAM object for PCIE GART.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_gart_table_vram_pin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|radeon_gart_restore
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|WREG32
argument_list|(
name|MC_VM_MX_L1_TLB_CNTL
argument_list|,
operator|(
literal|0xA
operator|<<
literal|7
operator|)
operator||
name|ENABLE_L1_TLB
operator||
name|SYSTEM_ACCESS_MODE_NOT_IN_SYS
operator||
name|ENABLE_ADVANCED_DRIVER_MODEL
operator||
name|SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU
argument_list|)
expr_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_CACHE
operator||
name|ENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|ENABLE_L2_PDE0_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
operator||
name|CONTEXT1_IDENTITY_ACCESS_MODE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
name|INVALIDATE_ALL_L1_TLBS
operator||
name|INVALIDATE_L2_CACHE
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|L2_CACHE_BIGK_ASSOCIATIVITY
operator||
name|L2_CACHE_BIGK_FRAGMENT_SIZE
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup context0 */
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_START_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_END_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
argument_list|,
name|rdev
operator|->
name|gart
operator|.
name|table_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PROTECTION_FAULT_DEFAULT_ADDR
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|rdev
operator|->
name|dummy_page
operator|.
name|addr
operator|>>
literal|12
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
argument_list|,
operator|(
name|ENABLE_CONTEXT
operator||
name|PAGE_TABLE_DEPTH
argument_list|(
literal|0
argument_list|)
operator||
name|RANGE_PROTECTION_FAULT_ENABLE_DEFAULT
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x15D4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x15D8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x15DC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* empty context1-15 */
comment|/* set vm size, must be a multiple of 4 */
name|WREG32
argument_list|(
name|VM_CONTEXT1_PAGE_TABLE_START_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT1_PAGE_TABLE_END_ADDR
argument_list|,
name|rdev
operator|->
name|vm_manager
operator|.
name|max_pfn
argument_list|)
expr_stmt|;
comment|/* Assign the pt base to something valid for now; the pts used for 	 * the VMs are determined by the application and setup and assigned 	 * on the fly in the vm part of radeon_gart.c 	 */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|<
literal|8
condition|)
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
argument_list|,
name|rdev
operator|->
name|gart
operator|.
name|table_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|VM_CONTEXT8_PAGE_TABLE_BASE_ADDR
operator|+
operator|(
operator|(
name|i
operator|-
literal|8
operator|)
operator|<<
literal|2
operator|)
argument_list|,
name|rdev
operator|->
name|gart
operator|.
name|table_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
comment|/* enable context1-15 */
name|WREG32
argument_list|(
name|VM_CONTEXT1_PROTECTION_FAULT_DEFAULT_ADDR
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|rdev
operator|->
name|dummy_page
operator|.
name|addr
operator|>>
literal|12
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT1_CNTL2
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT1_CNTL
argument_list|,
name|ENABLE_CONTEXT
operator||
name|PAGE_TABLE_DEPTH
argument_list|(
literal|1
argument_list|)
operator||
name|RANGE_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|RANGE_PROTECTION_FAULT_ENABLE_DEFAULT
operator||
name|DUMMY_PAGE_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|DUMMY_PAGE_PROTECTION_FAULT_ENABLE_DEFAULT
operator||
name|PDE0_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|PDE0_PROTECTION_FAULT_ENABLE_DEFAULT
operator||
name|VALID_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|VALID_PROTECTION_FAULT_ENABLE_DEFAULT
operator||
name|READ_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|READ_PROTECTION_FAULT_ENABLE_DEFAULT
operator||
name|WRITE_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|WRITE_PROTECTION_FAULT_ENABLE_DEFAULT
argument_list|)
expr_stmt|;
name|si_pcie_gart_tlb_flush
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"PCIE GART of %uM enabled (table at 0x%016llX).\n"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|ready
operator|=
name|true
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_pcie_gart_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* Disable all tables */
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT1_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|WREG32
argument_list|(
name|MC_VM_MX_L1_TLB_CNTL
argument_list|,
name|SYSTEM_ACCESS_MODE_NOT_IN_SYS
operator||
name|SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU
argument_list|)
expr_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|ENABLE_L2_PDE0_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
operator||
name|CONTEXT1_IDENTITY_ACCESS_MODE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|L2_CACHE_BIGK_ASSOCIATIVITY
operator||
name|L2_CACHE_BIGK_FRAGMENT_SIZE
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_unpin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_pcie_gart_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|si_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_free
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* vm parser */
end_comment

begin_function
specifier|static
name|bool
name|si_vm_reg_valid
parameter_list|(
name|u32
name|reg
parameter_list|)
block|{
comment|/* context regs are fine */
if|if
condition|(
name|reg
operator|>=
literal|0x28000
condition|)
return|return
name|true
return|;
comment|/* check config regs */
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|GRBM_GFX_INDEX
case|:
case|case
name|CP_STRMOUT_CNTL
case|:
case|case
name|VGT_VTX_VECT_EJECT_REG
case|:
case|case
name|VGT_CACHE_INVALIDATION
case|:
case|case
name|VGT_ESGS_RING_SIZE
case|:
case|case
name|VGT_GSVS_RING_SIZE
case|:
case|case
name|VGT_GS_VERTEX_REUSE
case|:
case|case
name|VGT_PRIMITIVE_TYPE
case|:
case|case
name|VGT_INDEX_TYPE
case|:
case|case
name|VGT_NUM_INDICES
case|:
case|case
name|VGT_NUM_INSTANCES
case|:
case|case
name|VGT_TF_RING_SIZE
case|:
case|case
name|VGT_HS_OFFCHIP_PARAM
case|:
case|case
name|VGT_TF_MEMORY_BASE
case|:
case|case
name|PA_CL_ENHANCE
case|:
case|case
name|PA_SU_LINE_STIPPLE_VALUE
case|:
case|case
name|PA_SC_LINE_STIPPLE_STATE
case|:
case|case
name|PA_SC_ENHANCE
case|:
case|case
name|SQC_CACHES
case|:
case|case
name|SPI_STATIC_THREAD_MGMT_1
case|:
case|case
name|SPI_STATIC_THREAD_MGMT_2
case|:
case|case
name|SPI_STATIC_THREAD_MGMT_3
case|:
case|case
name|SPI_PS_MAX_WAVE_ID
case|:
case|case
name|SPI_CONFIG_CNTL
case|:
case|case
name|SPI_CONFIG_CNTL_1
case|:
case|case
name|TA_CNTL_AUX
case|:
return|return
name|true
return|;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid register 0x%x in CS\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|si_vm_packet3_ce_check
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
modifier|*
name|ib
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
switch|switch
condition|(
name|pkt
operator|->
name|opcode
condition|)
block|{
case|case
name|PACKET3_NOP
case|:
case|case
name|PACKET3_SET_BASE
case|:
case|case
name|PACKET3_SET_CE_DE_COUNTERS
case|:
case|case
name|PACKET3_LOAD_CONST_RAM
case|:
case|case
name|PACKET3_WRITE_CONST_RAM
case|:
case|case
name|PACKET3_WRITE_CONST_RAM_OFFSET
case|:
case|case
name|PACKET3_DUMP_CONST_RAM
case|:
case|case
name|PACKET3_INCREMENT_CE_COUNTER
case|:
case|case
name|PACKET3_WAIT_ON_DE_COUNTER
case|:
case|case
name|PACKET3_CE_WRITE
case|:
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid CE packet3: 0x%x\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_vm_packet3_gfx_check
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
modifier|*
name|ib
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|u32
name|idx
init|=
name|pkt
operator|->
name|idx
operator|+
literal|1
decl_stmt|;
name|u32
name|idx_value
init|=
name|ib
index|[
name|idx
index|]
decl_stmt|;
name|u32
name|start_reg
decl_stmt|,
name|end_reg
decl_stmt|,
name|reg
decl_stmt|,
name|i
decl_stmt|;
name|u32
name|command
decl_stmt|,
name|info
decl_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|opcode
condition|)
block|{
case|case
name|PACKET3_NOP
case|:
case|case
name|PACKET3_SET_BASE
case|:
case|case
name|PACKET3_CLEAR_STATE
case|:
case|case
name|PACKET3_INDEX_BUFFER_SIZE
case|:
case|case
name|PACKET3_DISPATCH_DIRECT
case|:
case|case
name|PACKET3_DISPATCH_INDIRECT
case|:
case|case
name|PACKET3_ALLOC_GDS
case|:
case|case
name|PACKET3_WRITE_GDS_RAM
case|:
case|case
name|PACKET3_ATOMIC_GDS
case|:
case|case
name|PACKET3_ATOMIC
case|:
case|case
name|PACKET3_OCCLUSION_QUERY
case|:
case|case
name|PACKET3_SET_PREDICATION
case|:
case|case
name|PACKET3_COND_EXEC
case|:
case|case
name|PACKET3_PRED_EXEC
case|:
case|case
name|PACKET3_DRAW_INDIRECT
case|:
case|case
name|PACKET3_DRAW_INDEX_INDIRECT
case|:
case|case
name|PACKET3_INDEX_BASE
case|:
case|case
name|PACKET3_DRAW_INDEX_2
case|:
case|case
name|PACKET3_CONTEXT_CONTROL
case|:
case|case
name|PACKET3_INDEX_TYPE
case|:
case|case
name|PACKET3_DRAW_INDIRECT_MULTI
case|:
case|case
name|PACKET3_DRAW_INDEX_AUTO
case|:
case|case
name|PACKET3_DRAW_INDEX_IMMD
case|:
case|case
name|PACKET3_NUM_INSTANCES
case|:
case|case
name|PACKET3_DRAW_INDEX_MULTI_AUTO
case|:
case|case
name|PACKET3_STRMOUT_BUFFER_UPDATE
case|:
case|case
name|PACKET3_DRAW_INDEX_OFFSET_2
case|:
case|case
name|PACKET3_DRAW_INDEX_MULTI_ELEMENT
case|:
case|case
name|PACKET3_DRAW_INDEX_INDIRECT_MULTI
case|:
case|case
name|PACKET3_MPEG_INDEX
case|:
case|case
name|PACKET3_WAIT_REG_MEM
case|:
case|case
name|PACKET3_MEM_WRITE
case|:
case|case
name|PACKET3_PFP_SYNC_ME
case|:
case|case
name|PACKET3_SURFACE_SYNC
case|:
case|case
name|PACKET3_EVENT_WRITE
case|:
case|case
name|PACKET3_EVENT_WRITE_EOP
case|:
case|case
name|PACKET3_EVENT_WRITE_EOS
case|:
case|case
name|PACKET3_SET_CONTEXT_REG
case|:
case|case
name|PACKET3_SET_CONTEXT_REG_INDIRECT
case|:
case|case
name|PACKET3_SET_SH_REG
case|:
case|case
name|PACKET3_SET_SH_REG_OFFSET
case|:
case|case
name|PACKET3_INCREMENT_DE_COUNTER
case|:
case|case
name|PACKET3_WAIT_ON_CE_COUNTER
case|:
case|case
name|PACKET3_WAIT_ON_AVAIL_BUFFER
case|:
case|case
name|PACKET3_ME_WRITE
case|:
break|break;
case|case
name|PACKET3_COPY_DATA
case|:
if|if
condition|(
operator|(
name|idx_value
operator|&
literal|0xf00
operator|)
operator|==
literal|0
condition|)
block|{
name|reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|*
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_WRITE_DATA
case|:
if|if
condition|(
operator|(
name|idx_value
operator|&
literal|0xf00
operator|)
operator|==
literal|0
condition|)
block|{
name|start_reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|*
literal|4
expr_stmt|;
if|if
condition|(
name|idx_value
operator|&
literal|0x10000
condition|)
block|{
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|start_reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|pkt
operator|->
name|count
operator|-
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
break|break;
case|case
name|PACKET3_COND_WRITE
case|:
if|if
condition|(
name|idx_value
operator|&
literal|0x100
condition|)
block|{
name|reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|5
index|]
operator|*
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_COPY_DW
case|:
if|if
condition|(
name|idx_value
operator|&
literal|0x2
condition|)
block|{
name|reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|*
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_SET_CONFIG_REG
case|:
name|start_reg
operator|=
operator|(
name|idx_value
operator|<<
literal|2
operator|)
operator|+
name|PACKET3_SET_CONFIG_REG_START
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
name|pkt
operator|->
name|count
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|PACKET3_SET_CONFIG_REG_START
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|PACKET3_SET_CONFIG_REG_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|PACKET3_SET_CONFIG_REG_END
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad PACKET3_SET_CONFIG_REG\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pkt
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_CP_DMA
case|:
name|command
operator|=
name|ib
index|[
name|idx
operator|+
literal|4
index|]
expr_stmt|;
name|info
operator|=
name|ib
index|[
name|idx
operator|+
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_SAS
condition|)
block|{
comment|/* src address space is register */
if|if
condition|(
operator|(
operator|(
name|info
operator|&
literal|0x60000000
operator|)
operator|>>
literal|29
operator|)
operator|==
literal|0
condition|)
block|{
name|start_reg
operator|=
name|idx_value
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_SAIC
condition|)
block|{
name|reg
operator|=
name|start_reg
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA Bad SRC register\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|command
operator|&
literal|0x1fffff
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA Bad SRC register\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
block|}
block|}
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_DAS
condition|)
block|{
comment|/* dst address space is register */
if|if
condition|(
operator|(
operator|(
name|info
operator|&
literal|0x00300000
operator|)
operator|>>
literal|20
operator|)
operator|==
literal|0
condition|)
block|{
name|start_reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|command
operator|&
name|PACKET3_CP_DMA_CMD_DAIC
condition|)
block|{
name|reg
operator|=
name|start_reg
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA Bad DST register\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|command
operator|&
literal|0x1fffff
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"CP DMA Bad DST register\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
block|}
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid GFX packet3: 0x%x\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_vm_packet3_compute_check
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
modifier|*
name|ib
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|u32
name|idx
init|=
name|pkt
operator|->
name|idx
operator|+
literal|1
decl_stmt|;
name|u32
name|idx_value
init|=
name|ib
index|[
name|idx
index|]
decl_stmt|;
name|u32
name|start_reg
decl_stmt|,
name|reg
decl_stmt|,
name|i
decl_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|opcode
condition|)
block|{
case|case
name|PACKET3_NOP
case|:
case|case
name|PACKET3_SET_BASE
case|:
case|case
name|PACKET3_CLEAR_STATE
case|:
case|case
name|PACKET3_DISPATCH_DIRECT
case|:
case|case
name|PACKET3_DISPATCH_INDIRECT
case|:
case|case
name|PACKET3_ALLOC_GDS
case|:
case|case
name|PACKET3_WRITE_GDS_RAM
case|:
case|case
name|PACKET3_ATOMIC_GDS
case|:
case|case
name|PACKET3_ATOMIC
case|:
case|case
name|PACKET3_OCCLUSION_QUERY
case|:
case|case
name|PACKET3_SET_PREDICATION
case|:
case|case
name|PACKET3_COND_EXEC
case|:
case|case
name|PACKET3_PRED_EXEC
case|:
case|case
name|PACKET3_CONTEXT_CONTROL
case|:
case|case
name|PACKET3_STRMOUT_BUFFER_UPDATE
case|:
case|case
name|PACKET3_WAIT_REG_MEM
case|:
case|case
name|PACKET3_MEM_WRITE
case|:
case|case
name|PACKET3_PFP_SYNC_ME
case|:
case|case
name|PACKET3_SURFACE_SYNC
case|:
case|case
name|PACKET3_EVENT_WRITE
case|:
case|case
name|PACKET3_EVENT_WRITE_EOP
case|:
case|case
name|PACKET3_EVENT_WRITE_EOS
case|:
case|case
name|PACKET3_SET_CONTEXT_REG
case|:
case|case
name|PACKET3_SET_CONTEXT_REG_INDIRECT
case|:
case|case
name|PACKET3_SET_SH_REG
case|:
case|case
name|PACKET3_SET_SH_REG_OFFSET
case|:
case|case
name|PACKET3_INCREMENT_DE_COUNTER
case|:
case|case
name|PACKET3_WAIT_ON_CE_COUNTER
case|:
case|case
name|PACKET3_WAIT_ON_AVAIL_BUFFER
case|:
case|case
name|PACKET3_ME_WRITE
case|:
break|break;
case|case
name|PACKET3_COPY_DATA
case|:
if|if
condition|(
operator|(
name|idx_value
operator|&
literal|0xf00
operator|)
operator|==
literal|0
condition|)
block|{
name|reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|*
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_WRITE_DATA
case|:
if|if
condition|(
operator|(
name|idx_value
operator|&
literal|0xf00
operator|)
operator|==
literal|0
condition|)
block|{
name|start_reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|*
literal|4
expr_stmt|;
if|if
condition|(
name|idx_value
operator|&
literal|0x10000
condition|)
block|{
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|start_reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|pkt
operator|->
name|count
operator|-
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
block|}
break|break;
case|case
name|PACKET3_COND_WRITE
case|:
if|if
condition|(
name|idx_value
operator|&
literal|0x100
condition|)
block|{
name|reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|5
index|]
operator|*
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
case|case
name|PACKET3_COPY_DW
case|:
if|if
condition|(
name|idx_value
operator|&
literal|0x2
condition|)
block|{
name|reg
operator|=
name|ib
index|[
name|idx
operator|+
literal|3
index|]
operator|*
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|si_vm_reg_valid
argument_list|(
name|reg
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid Compute packet3: 0x%x\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|si_ib_parse
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|u32
name|idx
init|=
literal|0
decl_stmt|;
name|struct
name|radeon_cs_packet
name|pkt
decl_stmt|;
do|do
block|{
name|pkt
operator|.
name|idx
operator|=
name|idx
expr_stmt|;
name|pkt
operator|.
name|type
operator|=
name|CP_PACKET_GET_TYPE
argument_list|(
name|ib
operator|->
name|ptr
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|pkt
operator|.
name|count
operator|=
name|CP_PACKET_GET_COUNT
argument_list|(
name|ib
operator|->
name|ptr
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|pkt
operator|.
name|one_reg_wr
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|.
name|type
condition|)
block|{
case|case
name|PACKET_TYPE0
case|:
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Packet0 not allowed!\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE2
case|:
name|idx
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE3
case|:
name|pkt
operator|.
name|opcode
operator|=
name|CP_PACKET3_GET_OPCODE
argument_list|(
name|ib
operator|->
name|ptr
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib
operator|->
name|is_const_ib
condition|)
name|ret
operator|=
name|si_vm_packet3_ce_check
argument_list|(
name|rdev
argument_list|,
name|ib
operator|->
name|ptr
argument_list|,
operator|&
name|pkt
argument_list|)
expr_stmt|;
else|else
block|{
switch|switch
condition|(
name|ib
operator|->
name|ring
condition|)
block|{
case|case
name|RADEON_RING_TYPE_GFX_INDEX
case|:
name|ret
operator|=
name|si_vm_packet3_gfx_check
argument_list|(
name|rdev
argument_list|,
name|ib
operator|->
name|ptr
argument_list|,
operator|&
name|pkt
argument_list|)
expr_stmt|;
break|break;
case|case
name|CAYMAN_RING_TYPE_CP1_INDEX
case|:
case|case
name|CAYMAN_RING_TYPE_CP2_INDEX
case|:
name|ret
operator|=
name|si_vm_packet3_compute_check
argument_list|(
name|rdev
argument_list|,
name|ib
operator|->
name|ptr
argument_list|,
operator|&
name|pkt
argument_list|)
expr_stmt|;
break|break;
default|default:
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Non-PM4 ring %d !\n"
argument_list|,
name|ib
operator|->
name|ring
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
block|}
name|idx
operator|+=
name|pkt
operator|.
name|count
operator|+
literal|2
expr_stmt|;
break|break;
default|default:
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Unknown packet type %d !\n"
argument_list|,
name|pkt
operator|.
name|type
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ret
condition|)
break|break;
block|}
do|while
condition|(
name|idx
operator|<
name|ib
operator|->
name|length_dw
condition|)
do|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * vm  */
end_comment

begin_function
name|int
name|si_vm_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* number of VMs */
name|rdev
operator|->
name|vm_manager
operator|.
name|nvm
operator|=
literal|16
expr_stmt|;
comment|/* base offset of vram pages */
name|rdev
operator|->
name|vm_manager
operator|.
name|vram_base_offset
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|si_vm_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{ }
end_function

begin_comment
comment|/**  * si_vm_set_page - update the page tables using the CP  *  * @rdev: radeon_device pointer  * @pe: addr of the page entry  * @addr: dst addr to write into pe  * @count: number of page entries to update  * @incr: increase next addr by incr bytes  * @flags: access flags  *  * Update the page tables using the CP (cayman-si).  */
end_comment

begin_function
name|void
name|si_vm_set_page
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint64_t
name|pe
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|unsigned
name|count
parameter_list|,
name|uint32_t
name|incr
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|rdev
operator|->
name|asic
operator|->
name|vm
operator|.
name|pt_ring_index
index|]
decl_stmt|;
name|uint32_t
name|r600_flags
init|=
name|cayman_vm_page_flags
argument_list|(
name|rdev
argument_list|,
name|flags
argument_list|)
decl_stmt|;
name|uint64_t
name|value
decl_stmt|;
name|unsigned
name|ndw
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|asic
operator|->
name|vm
operator|.
name|pt_ring_index
operator|==
name|RADEON_RING_TYPE_GFX_INDEX
condition|)
block|{
while|while
condition|(
name|count
condition|)
block|{
name|ndw
operator|=
literal|2
operator|+
name|count
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|ndw
operator|>
literal|0x3FFE
condition|)
name|ndw
operator|=
literal|0x3FFE
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_WRITE_DATA
argument_list|,
name|ndw
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|WRITE_DATA_ENGINE_SEL
argument_list|(
literal|0
argument_list|)
operator||
name|WRITE_DATA_DST_SEL
argument_list|(
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|pe
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|pe
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|ndw
operator|>
literal|2
condition|;
name|ndw
operator|-=
literal|2
operator|,
operator|--
name|count
operator|,
name|pe
operator|+=
literal|8
control|)
block|{
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_SYSTEM
condition|)
block|{
name|value
operator|=
name|radeon_vm_map_gart
argument_list|(
name|rdev
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|value
operator|&=
literal|0xFFFFFFFFFFFFF000ULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_VALID
condition|)
block|{
name|value
operator|=
name|addr
expr_stmt|;
block|}
else|else
block|{
name|value
operator|=
literal|0
expr_stmt|;
block|}
name|addr
operator|+=
name|incr
expr_stmt|;
name|value
operator||=
name|r600_flags
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* DMA */
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_SYSTEM
condition|)
block|{
while|while
condition|(
name|count
condition|)
block|{
name|ndw
operator|=
name|count
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|ndw
operator|>
literal|0xFFFFE
condition|)
name|ndw
operator|=
literal|0xFFFFE
expr_stmt|;
comment|/* for non-physically contiguous pages (system) */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|ndw
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|pe
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|pe
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|ndw
operator|>
literal|0
condition|;
name|ndw
operator|-=
literal|2
operator|,
operator|--
name|count
operator|,
name|pe
operator|+=
literal|8
control|)
block|{
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_SYSTEM
condition|)
block|{
name|value
operator|=
name|radeon_vm_map_gart
argument_list|(
name|rdev
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|value
operator|&=
literal|0xFFFFFFFFFFFFF000ULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_VALID
condition|)
block|{
name|value
operator|=
name|addr
expr_stmt|;
block|}
else|else
block|{
name|value
operator|=
literal|0
expr_stmt|;
block|}
name|addr
operator|+=
name|incr
expr_stmt|;
name|value
operator||=
name|r600_flags
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
while|while
condition|(
name|count
condition|)
block|{
name|ndw
operator|=
name|count
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|ndw
operator|>
literal|0xFFFFE
condition|)
name|ndw
operator|=
literal|0xFFFFE
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_VALID
condition|)
name|value
operator|=
name|addr
expr_stmt|;
else|else
name|value
operator|=
literal|0
expr_stmt|;
comment|/* for physically contiguous pages (vram) */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PTE_PDE_PACKET
argument_list|(
name|ndw
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|pe
argument_list|)
expr_stmt|;
comment|/* dst addr */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|pe
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|r600_flags
argument_list|)
expr_stmt|;
comment|/* mask */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* value */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|incr
argument_list|)
expr_stmt|;
comment|/* increment size */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pe
operator|+=
name|ndw
operator|*
literal|4
expr_stmt|;
name|addr
operator|+=
operator|(
name|ndw
operator|/
literal|2
operator|)
operator|*
name|incr
expr_stmt|;
name|count
operator|-=
name|ndw
operator|/
literal|2
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|si_vm_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|ridx
parameter_list|,
name|struct
name|radeon_vm
modifier|*
name|vm
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ridx
index|]
decl_stmt|;
if|if
condition|(
name|vm
operator|==
name|NULL
condition|)
return|return;
comment|/* write new base address */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_WRITE_DATA
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|WRITE_DATA_ENGINE_SEL
argument_list|(
literal|0
argument_list|)
operator||
name|WRITE_DATA_DST_SEL
argument_list|(
literal|0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vm
operator|->
name|id
operator|<
literal|8
condition|)
block|{
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
operator|+
operator|(
name|vm
operator|->
name|id
operator|<<
literal|2
operator|)
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|VM_CONTEXT8_PAGE_TABLE_BASE_ADDR
operator|+
operator|(
operator|(
name|vm
operator|->
name|id
operator|-
literal|8
operator|)
operator|<<
literal|2
operator|)
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|vm
operator|->
name|pd_gpu_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
comment|/* flush hdp cache */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_WRITE_DATA
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|WRITE_DATA_ENGINE_SEL
argument_list|(
literal|0
argument_list|)
operator||
name|WRITE_DATA_DST_SEL
argument_list|(
literal|0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|HDP_MEM_COHERENCY_FLUSH_CNTL
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
comment|/* bits 0-15 are the VM contexts0-15 */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_WRITE_DATA
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|WRITE_DATA_ENGINE_SEL
argument_list|(
literal|0
argument_list|)
operator||
name|WRITE_DATA_DST_SEL
argument_list|(
literal|0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|VM_INVALIDATE_REQUEST
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|1
operator|<<
name|vm
operator|->
name|id
argument_list|)
expr_stmt|;
comment|/* sync PFP to ME, otherwise we might get invalid PFP reads */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_PFP_SYNC_ME
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|si_dma_vm_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|ridx
parameter_list|,
name|struct
name|radeon_vm
modifier|*
name|vm
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ridx
index|]
decl_stmt|;
if|if
condition|(
name|vm
operator|==
name|NULL
condition|)
return|return;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_SRBM_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vm
operator|->
name|id
operator|<
literal|8
condition|)
block|{
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|0xf
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
operator|+
operator|(
name|vm
operator|->
name|id
operator|<<
literal|2
operator|)
operator|)
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|0xf
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|VM_CONTEXT8_PAGE_TABLE_BASE_ADDR
operator|+
operator|(
operator|(
name|vm
operator|->
name|id
operator|-
literal|8
operator|)
operator|<<
literal|2
operator|)
operator|)
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|vm
operator|->
name|pd_gpu_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
comment|/* flush hdp cache */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_SRBM_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|0xf
operator|<<
literal|16
operator|)
operator||
operator|(
name|HDP_MEM_COHERENCY_FLUSH_CNTL
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* bits 0-7 are the VM contexts0-7 */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_SRBM_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|0xf
operator|<<
literal|16
operator|)
operator||
operator|(
name|VM_INVALIDATE_REQUEST
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|1
operator|<<
name|vm
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RLC  */
end_comment

begin_function
name|void
name|si_rlc_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* save restore block */
if|if
condition|(
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
condition|)
block|{
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%d) reserve RLC sr bo failed\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_bo_unpin
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
argument_list|)
expr_stmt|;
name|radeon_bo_unref
argument_list|(
operator|&
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* clear state block */
if|if
condition|(
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
condition|)
block|{
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%d) reserve RLC c bo failed\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_bo_unpin
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
argument_list|)
expr_stmt|;
name|radeon_bo_unref
argument_list|(
operator|&
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|si_rlc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* save restore block */
if|if
condition|(
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
operator|==
name|NULL
condition|)
block|{
name|r
operator|=
name|radeon_bo_create
argument_list|(
name|rdev
argument_list|,
name|RADEON_GPU_PAGE_SIZE
argument_list|,
name|PAGE_SIZE
argument_list|,
name|true
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|NULL
argument_list|,
operator|&
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%d) create RLC sr bo failed\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|si_rlc_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_bo_pin
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
operator|&
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_gpu_addr
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%d) pin RLC sr bo failed\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|si_rlc_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* clear state block */
if|if
condition|(
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
operator|==
name|NULL
condition|)
block|{
name|r
operator|=
name|radeon_bo_create
argument_list|(
name|rdev
argument_list|,
name|RADEON_GPU_PAGE_SIZE
argument_list|,
name|PAGE_SIZE
argument_list|,
name|true
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|NULL
argument_list|,
operator|&
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%d) create RLC c bo failed\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|si_rlc_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|si_rlc_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_bo_pin
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
operator|&
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_gpu_addr
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%d) pin RLC c bo failed\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|si_rlc_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_rlc_stop
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|WREG32
argument_list|(
name|RLC_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_rlc_start
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|WREG32
argument_list|(
name|RLC_CNTL
argument_list|,
name|RLC_ENABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_rlc_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
specifier|const
name|__be32
modifier|*
name|fw_data
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|rlc_fw
condition|)
return|return
operator|-
name|EINVAL
return|;
name|si_rlc_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_RL_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_RL_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_LB_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_LB_CNTR_MAX
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_LB_CNTR_INIT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_SAVE_AND_RESTORE_BASE
argument_list|,
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_CLEAR_STATE_RESTORE_BASE
argument_list|,
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_MC_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_UCODE_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|rlc_fw
operator|->
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SI_RLC_UCODE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RLC_UCODE_ADDR
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RLC_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|si_rlc_start
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_enable_interrupts
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|ih_cntl
init|=
name|RREG32
argument_list|(
name|IH_CNTL
argument_list|)
decl_stmt|;
name|u32
name|ih_rb_cntl
init|=
name|RREG32
argument_list|(
name|IH_RB_CNTL
argument_list|)
decl_stmt|;
name|ih_cntl
operator||=
name|ENABLE_INTR
expr_stmt|;
name|ih_rb_cntl
operator||=
name|IH_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|IH_CNTL
argument_list|,
name|ih_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_CNTL
argument_list|,
name|ih_rb_cntl
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|enabled
operator|=
name|true
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_disable_interrupts
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|ih_rb_cntl
init|=
name|RREG32
argument_list|(
name|IH_RB_CNTL
argument_list|)
decl_stmt|;
name|u32
name|ih_cntl
init|=
name|RREG32
argument_list|(
name|IH_CNTL
argument_list|)
decl_stmt|;
name|ih_rb_cntl
operator|&=
operator|~
name|IH_RB_ENABLE
expr_stmt|;
name|ih_cntl
operator|&=
operator|~
name|ENABLE_INTR
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_CNTL
argument_list|,
name|ih_rb_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_CNTL
argument_list|,
name|ih_cntl
argument_list|)
expr_stmt|;
comment|/* set rptr, wptr to 0 */
name|WREG32
argument_list|(
name|IH_RB_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|enabled
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|rptr
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_disable_interrupt_state
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|WREG32
argument_list|(
name|CP_INT_CNTL_RING0
argument_list|,
name|CNTX_BUSY_INT_ENABLE
operator||
name|CNTX_EMPTY_INT_ENABLE
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_INT_CNTL_RING1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_INT_CNTL_RING2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DMA_CNTL
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|)
operator|&
operator|~
name|TRAP_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_CNTL
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DMA_CNTL
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|)
operator|&
operator|~
name|TRAP_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_CNTL
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_INT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|DACA_AUTODETECT_INT_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_irq_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|rb_bufsz
decl_stmt|;
name|u32
name|interrupt_cntl
decl_stmt|,
name|ih_cntl
decl_stmt|,
name|ih_rb_cntl
decl_stmt|;
comment|/* allocate ring */
name|ret
operator|=
name|r600_ih_ring_alloc
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* disable irqs */
name|si_disable_interrupts
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* init rlc */
name|ret
operator|=
name|si_rlc_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|r600_ih_ring_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/* setup interrupt control */
comment|/* set dummy read address to ring address */
name|WREG32
argument_list|(
name|INTERRUPT_CNTL2
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|interrupt_cntl
operator|=
name|RREG32
argument_list|(
name|INTERRUPT_CNTL
argument_list|)
expr_stmt|;
comment|/* IH_DUMMY_RD_OVERRIDE=0 - dummy read disabled with msi, enabled without msi 	 * IH_DUMMY_RD_OVERRIDE=1 - dummy read controlled by IH_DUMMY_RD_EN 	 */
name|interrupt_cntl
operator|&=
operator|~
name|IH_DUMMY_RD_OVERRIDE
expr_stmt|;
comment|/* IH_REQ_NONSNOOP_EN=1 if ring is in non-cacheable memory, e.g., vram */
name|interrupt_cntl
operator|&=
operator|~
name|IH_REQ_NONSNOOP_EN
expr_stmt|;
name|WREG32
argument_list|(
name|INTERRUPT_CNTL
argument_list|,
name|interrupt_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_BASE
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_size
operator|/
literal|4
argument_list|)
expr_stmt|;
name|ih_rb_cntl
operator|=
operator|(
name|IH_WPTR_OVERFLOW_ENABLE
operator||
name|IH_WPTR_OVERFLOW_CLEAR
operator||
operator|(
name|rb_bufsz
operator|<<
literal|1
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|ih_rb_cntl
operator||=
name|IH_WPTR_WRITEBACK_ENABLE
expr_stmt|;
comment|/* set the writeback address whether it's enabled or not */
name|WREG32
argument_list|(
name|IH_RB_WPTR_ADDR_LO
argument_list|,
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|R600_WB_IH_WPTR_OFFSET
operator|)
operator|&
literal|0xFFFFFFFC
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_WPTR_ADDR_HI
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|R600_WB_IH_WPTR_OFFSET
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_CNTL
argument_list|,
name|ih_rb_cntl
argument_list|)
expr_stmt|;
comment|/* set rptr, wptr to 0 */
name|WREG32
argument_list|(
name|IH_RB_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Default settings for IH_CNTL (disabled at first) */
name|ih_cntl
operator|=
name|MC_WRREQ_CREDIT
argument_list|(
literal|0x10
argument_list|)
operator||
name|MC_WR_CLEAN_CNT
argument_list|(
literal|0x10
argument_list|)
operator||
name|MC_VMID
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* RPTR_REARM only works if msi's are enabled */
if|if
condition|(
name|rdev
operator|->
name|msi_enabled
condition|)
name|ih_cntl
operator||=
name|RPTR_REARM
expr_stmt|;
name|WREG32
argument_list|(
name|IH_CNTL
argument_list|,
name|ih_cntl
argument_list|)
expr_stmt|;
comment|/* force the active interrupt state to all disabled */
name|si_disable_interrupt_state
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|pci_enable_busmaster
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
expr_stmt|;
comment|/* enable irqs */
name|si_enable_interrupts
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|si_irq_set
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|cp_int_cntl
init|=
name|CNTX_BUSY_INT_ENABLE
operator||
name|CNTX_EMPTY_INT_ENABLE
decl_stmt|;
name|u32
name|cp_int_cntl1
init|=
literal|0
decl_stmt|,
name|cp_int_cntl2
init|=
literal|0
decl_stmt|;
name|u32
name|crtc1
init|=
literal|0
decl_stmt|,
name|crtc2
init|=
literal|0
decl_stmt|,
name|crtc3
init|=
literal|0
decl_stmt|,
name|crtc4
init|=
literal|0
decl_stmt|,
name|crtc5
init|=
literal|0
decl_stmt|,
name|crtc6
init|=
literal|0
decl_stmt|;
name|u32
name|hpd1
decl_stmt|,
name|hpd2
decl_stmt|,
name|hpd3
decl_stmt|,
name|hpd4
decl_stmt|,
name|hpd5
decl_stmt|,
name|hpd6
decl_stmt|;
name|u32
name|grbm_int_cntl
init|=
literal|0
decl_stmt|;
name|u32
name|grph1
init|=
literal|0
decl_stmt|,
name|grph2
init|=
literal|0
decl_stmt|,
name|grph3
init|=
literal|0
decl_stmt|,
name|grph4
init|=
literal|0
decl_stmt|,
name|grph5
init|=
literal|0
decl_stmt|,
name|grph6
init|=
literal|0
decl_stmt|;
name|u32
name|dma_cntl
decl_stmt|,
name|dma_cntl1
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|irq
operator|.
name|installed
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Can't enable IRQ/MSI because no handler is installed\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* don't enable anything if the ih is disabled */
if|if
condition|(
operator|!
name|rdev
operator|->
name|ih
operator|.
name|enabled
condition|)
block|{
name|si_disable_interrupts
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* force the active interrupt state to all disabled */
name|si_disable_interrupt_state
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|hpd1
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd2
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd3
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd4
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd5
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd6
operator|=
name|RREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|dma_cntl
operator|=
name|RREG32
argument_list|(
name|DMA_CNTL
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|)
operator|&
operator|~
name|TRAP_ENABLE
expr_stmt|;
name|dma_cntl1
operator|=
name|RREG32
argument_list|(
name|DMA_CNTL
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|)
operator|&
operator|~
name|TRAP_ENABLE
expr_stmt|;
comment|/* enable CP interrupts on all rings */
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: sw int gfx\n"
argument_list|)
expr_stmt|;
name|cp_int_cntl
operator||=
name|TIME_STAMP_INT_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: sw int cp1\n"
argument_list|)
expr_stmt|;
name|cp_int_cntl1
operator||=
name|TIME_STAMP_INT_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: sw int cp2\n"
argument_list|)
expr_stmt|;
name|cp_int_cntl2
operator||=
name|TIME_STAMP_INT_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: sw int dma\n"
argument_list|)
expr_stmt|;
name|dma_cntl
operator||=
name|TRAP_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|CAYMAN_RING_TYPE_DMA1_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: sw int dma1\n"
argument_list|)
expr_stmt|;
name|dma_cntl1
operator||=
name|TRAP_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|0
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: vblank 0\n"
argument_list|)
expr_stmt|;
name|crtc1
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|1
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: vblank 1\n"
argument_list|)
expr_stmt|;
name|crtc2
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|2
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|2
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: vblank 2\n"
argument_list|)
expr_stmt|;
name|crtc3
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|3
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|3
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: vblank 3\n"
argument_list|)
expr_stmt|;
name|crtc4
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|4
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|4
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: vblank 4\n"
argument_list|)
expr_stmt|;
name|crtc5
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|5
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|5
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: vblank 5\n"
argument_list|)
expr_stmt|;
name|crtc6
operator||=
name|VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|0
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: hpd 1\n"
argument_list|)
expr_stmt|;
name|hpd1
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|1
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: hpd 2\n"
argument_list|)
expr_stmt|;
name|hpd2
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|2
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: hpd 3\n"
argument_list|)
expr_stmt|;
name|hpd3
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|3
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: hpd 4\n"
argument_list|)
expr_stmt|;
name|hpd4
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|4
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: hpd 5\n"
argument_list|)
expr_stmt|;
name|hpd5
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|5
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"si_irq_set: hpd 6\n"
argument_list|)
expr_stmt|;
name|hpd6
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|CP_INT_CNTL_RING0
argument_list|,
name|cp_int_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_INT_CNTL_RING1
argument_list|,
name|cp_int_cntl1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_INT_CNTL_RING2
argument_list|,
name|cp_int_cntl2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_CNTL
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
name|dma_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_CNTL
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
name|dma_cntl1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_INT_CNTL
argument_list|,
name|grbm_int_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|crtc1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|crtc2
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|crtc3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|crtc4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|crtc5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|INT_MASK
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|crtc6
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|grph1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|grph2
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|grph3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|grph4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|grph5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRPH_INT_CONTROL
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|grph6
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|hpd1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|hpd2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|hpd3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|hpd4
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|hpd5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|hpd6
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|si_irq_ack
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE2
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE3
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE4
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE5
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d1grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d2grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d3grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d4grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d5grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d6grph_int
operator|=
name|RREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d1grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d2grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|LB_D1_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|LB_D1_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC0_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|LB_D2_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|LB_D2_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC1_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|4
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d3grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d4grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|LB_D3_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|LB_D3_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC2_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|LB_D4_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|LB_D4_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC3_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|num_crtc
operator|>=
literal|6
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d5grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|d6grph_int
operator|&
name|GRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|GRPH_INT_STATUS
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|GRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|LB_D5_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|LB_D5_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC4_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|LB_D6_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VBLANK_STATUS
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|LB_D6_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|VLINE_STATUS
operator|+
name|EVERGREEN_CRTC5_REGISTER_OFFSET
argument_list|,
name|VLINE_ACK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|DC_HPD1_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|DC_HPD2_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|DC_HPD3_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|DC_HPD4_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|DC_HPD5_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|DC_HPD6_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|si_irq_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|si_disable_interrupts
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Wait and acknowledge irq */
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|si_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_disable_interrupt_state
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_irq_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|si_irq_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_rlc_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|si_irq_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|si_irq_suspend
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_ih_ring_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|u32
name|si_get_ih_wptr
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|wptr
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|wptr
operator|=
name|le32_to_cpu
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|wb
index|[
name|R600_WB_IH_WPTR_OFFSET
operator|/
literal|4
index|]
argument_list|)
expr_stmt|;
else|else
name|wptr
operator|=
name|RREG32
argument_list|(
name|IH_RB_WPTR
argument_list|)
expr_stmt|;
if|if
condition|(
name|wptr
operator|&
name|RB_OVERFLOW
condition|)
block|{
comment|/* When a ring buffer overflow happen start parsing interrupt 		 * from the last not overwritten vector (wptr + 16). Hopefully 		 * this should allow us to catchup. 		 */
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IH ring buffer overflow (0x%08X, %d, %d)\n"
argument_list|,
name|wptr
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|rptr
argument_list|,
operator|(
name|wptr
operator|+
literal|16
operator|)
operator|+
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|rptr
operator|=
operator|(
name|wptr
operator|+
literal|16
operator|)
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|IH_RB_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|IH_WPTR_OVERFLOW_CLEAR
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|wptr
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
operator|)
return|;
block|}
end_function

begin_comment
comment|/*        SI IV Ring  * Each IV ring entry is 128 bits:  * [7:0]    - interrupt source id  * [31:8]   - reserved  * [59:32]  - interrupt source data  * [63:60]  - reserved  * [71:64]  - RINGID  * [79:72]  - VMID  * [127:80] - reserved  */
end_comment

begin_function
name|irqreturn_t
name|si_irq_process
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|wptr
decl_stmt|;
name|u32
name|rptr
decl_stmt|;
name|u32
name|src_id
decl_stmt|,
name|src_data
decl_stmt|,
name|ring_id
decl_stmt|;
name|u32
name|ring_index
decl_stmt|;
name|bool
name|queue_hotplug
init|=
name|false
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|ih
operator|.
name|enabled
operator|||
name|rdev
operator|->
name|shutdown
condition|)
return|return
name|IRQ_NONE
return|;
name|wptr
operator|=
name|si_get_ih_wptr
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|restart_ih
label|:
comment|/* is somebody else already processing irqs? */
if|if
condition|(
name|atomic_xchg
argument_list|(
operator|&
name|rdev
operator|->
name|ih
operator|.
name|lock
argument_list|,
literal|1
argument_list|)
condition|)
return|return
name|IRQ_NONE
return|;
name|rptr
operator|=
name|rdev
operator|->
name|ih
operator|.
name|rptr
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"si_irq_process start: rptr %d, wptr %d\n"
argument_list|,
name|rptr
argument_list|,
name|wptr
argument_list|)
expr_stmt|;
comment|/* Order reading of wptr vs. reading of IH ring data */
name|rmb
argument_list|()
expr_stmt|;
comment|/* display interrupts */
name|si_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
while|while
condition|(
name|rptr
operator|!=
name|wptr
condition|)
block|{
comment|/* wptr/rptr are in bytes! */
name|ring_index
operator|=
name|rptr
operator|/
literal|4
expr_stmt|;
name|src_id
operator|=
name|le32_to_cpu
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring
index|[
name|ring_index
index|]
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|src_data
operator|=
name|le32_to_cpu
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring
index|[
name|ring_index
operator|+
literal|1
index|]
argument_list|)
operator|&
literal|0xfffffff
expr_stmt|;
name|ring_id
operator|=
name|le32_to_cpu
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring
index|[
name|ring_index
operator|+
literal|2
index|]
argument_list|)
operator|&
literal|0xff
expr_stmt|;
switch|switch
condition|(
name|src_id
condition|)
block|{
case|case
literal|1
case|:
comment|/* D1 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D1 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|LB_D1_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|0
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|0
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&=
operator|~
name|LB_D1_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D1 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D1 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|LB_D1_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&=
operator|~
name|LB_D1_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D1 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|2
case|:
comment|/* D2 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D2 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|LB_D2_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|1
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|1
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&=
operator|~
name|LB_D2_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D2 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D2 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|LB_D2_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&=
operator|~
name|LB_D2_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D2 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|3
case|:
comment|/* D3 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D3 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|LB_D3_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|2
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|2
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&=
operator|~
name|LB_D3_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D3 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D3 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|LB_D3_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&=
operator|~
name|LB_D3_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D3 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|4
case|:
comment|/* D4 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D4 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|LB_D4_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|3
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|3
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&=
operator|~
name|LB_D4_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D4 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D4 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|LB_D4_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&=
operator|~
name|LB_D4_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D4 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|5
case|:
comment|/* D5 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D5 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|LB_D5_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|4
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|4
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&=
operator|~
name|LB_D5_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D5 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D5 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|LB_D5_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&=
operator|~
name|LB_D5_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D5 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|6
case|:
comment|/* D6 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D6 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|LB_D6_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|5
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|5
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&=
operator|~
name|LB_D6_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D6 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D6 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|LB_D6_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&=
operator|~
name|LB_D6_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D6 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|42
case|:
comment|/* HPD hotplug */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&
name|DC_HPD1_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int
operator|&=
operator|~
name|DC_HPD1_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD1\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&
name|DC_HPD2_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont
operator|&=
operator|~
name|DC_HPD2_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD2\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&
name|DC_HPD3_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont2
operator|&=
operator|~
name|DC_HPD3_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD3\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|3
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&
name|DC_HPD4_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont3
operator|&=
operator|~
name|DC_HPD4_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD4\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&
name|DC_HPD5_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont4
operator|&=
operator|~
name|DC_HPD5_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD5\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&
name|DC_HPD6_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|evergreen
operator|.
name|disp_int_cont5
operator|&=
operator|~
name|DC_HPD6_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD6\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|146
case|:
case|case
literal|147
case|:
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU fault detected: %d 0x%08x\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  VM_CONTEXT1_PROTECTION_FAULT_ADDR   0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|VM_CONTEXT1_PROTECTION_FAULT_ADDR
argument_list|)
argument_list|)
expr_stmt|;
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  VM_CONTEXT1_PROTECTION_FAULT_STATUS 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|VM_CONTEXT1_PROTECTION_FAULT_STATUS
argument_list|)
argument_list|)
expr_stmt|;
comment|/* reset addr and status */
name|WREG32_P
argument_list|(
name|VM_CONTEXT1_CNTL2
argument_list|,
literal|1
argument_list|,
operator|~
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|176
case|:
comment|/* RINGID0 CP_INT */
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|177
case|:
comment|/* RINGID1 CP_INT */
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP1_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|178
case|:
comment|/* RINGID2 CP_INT */
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP2_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|181
case|:
comment|/* CP EOP event */
name|DRM_DEBUG
argument_list|(
literal|"IH: CP EOP\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ring_id
condition|)
block|{
case|case
literal|0
case|:
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP1_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP2_INDEX
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|224
case|:
comment|/* DMA trap event */
name|DRM_DEBUG
argument_list|(
literal|"IH: DMA trap\n"
argument_list|)
expr_stmt|;
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|R600_RING_TYPE_DMA_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|233
case|:
comment|/* GUI IDLE */
name|DRM_DEBUG
argument_list|(
literal|"IH: GUI idle\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|244
case|:
comment|/* DMA trap event */
name|DRM_DEBUG
argument_list|(
literal|"IH: DMA1 trap\n"
argument_list|)
expr_stmt|;
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_DMA1_INDEX
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* wptr/rptr are in bytes! */
name|rptr
operator|+=
literal|16
expr_stmt|;
name|rptr
operator|&=
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
expr_stmt|;
block|}
if|if
condition|(
name|queue_hotplug
condition|)
name|taskqueue_enqueue
argument_list|(
name|rdev
operator|->
name|tq
argument_list|,
operator|&
name|rdev
operator|->
name|hotplug_work
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|rptr
operator|=
name|rptr
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_RPTR
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|rptr
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|rdev
operator|->
name|ih
operator|.
name|lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* make sure wptr hasn't changed while processing */
name|wptr
operator|=
name|si_get_ih_wptr
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|wptr
operator|!=
name|rptr
condition|)
goto|goto
name|restart_ih
goto|;
return|return
name|IRQ_HANDLED
return|;
block|}
end_function

begin_comment
comment|/**  * si_copy_dma - copy pages using the DMA engine  *  * @rdev: radeon_device pointer  * @src_offset: src GPU address  * @dst_offset: dst GPU address  * @num_gpu_pages: number of GPU pages to xfer  * @fence: radeon fence object  *  * Copy GPU paging using the DMA engine (SI).  * Used by the radeon ttm implementation to move pages if  * registered as the asic copy callback.  */
end_comment

begin_function
name|int
name|si_copy_dma
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint64_t
name|src_offset
parameter_list|,
name|uint64_t
name|dst_offset
parameter_list|,
name|unsigned
name|num_gpu_pages
parameter_list|,
name|struct
name|radeon_fence
modifier|*
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_semaphore
modifier|*
name|sem
init|=
name|NULL
decl_stmt|;
name|int
name|ring_index
init|=
name|rdev
operator|->
name|asic
operator|->
name|copy
operator|.
name|dma_ring_index
decl_stmt|;
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ring_index
index|]
decl_stmt|;
name|u32
name|size_in_bytes
decl_stmt|,
name|cur_size_in_bytes
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_loops
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
name|r
operator|=
name|radeon_semaphore_create
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: moving bo (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|size_in_bytes
operator|=
operator|(
name|num_gpu_pages
operator|<<
name|RADEON_GPU_PAGE_SHIFT
operator|)
expr_stmt|;
name|num_loops
operator|=
name|DIV_ROUND_UP
argument_list|(
name|size_in_bytes
argument_list|,
literal|0xfffff
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|num_loops
operator|*
literal|5
operator|+
literal|11
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: moving bo (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
name|radeon_fence_need_sync
argument_list|(
operator|*
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
condition|)
block|{
name|radeon_semaphore_sync_rings
argument_list|(
name|rdev
argument_list|,
name|sem
argument_list|,
operator|(
operator|*
name|fence
operator|)
operator|->
name|ring
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
name|radeon_fence_note_sync
argument_list|(
operator|*
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_loops
condition|;
name|i
operator|++
control|)
block|{
name|cur_size_in_bytes
operator|=
name|size_in_bytes
expr_stmt|;
if|if
condition|(
name|cur_size_in_bytes
operator|>
literal|0xFFFFF
condition|)
name|cur_size_in_bytes
operator|=
literal|0xFFFFF
expr_stmt|;
name|size_in_bytes
operator|-=
name|cur_size_in_bytes
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_COPY
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|cur_size_in_bytes
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|dst_offset
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|src_offset
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|dst_offset
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|src_offset
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|src_offset
operator|+=
name|cur_size_in_bytes
expr_stmt|;
name|dst_offset
operator|+=
name|cur_size_in_bytes
expr_stmt|;
block|}
name|r
operator|=
name|radeon_fence_emit
argument_list|(
name|rdev
argument_list|,
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_ring_unlock_undo
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
operator|*
name|fence
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/*  * startup/shutdown callbacks  */
end_comment

begin_function
specifier|static
name|int
name|si_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
operator|||
operator|!
name|rdev
operator|->
name|ce_fw
operator|||
operator|!
name|rdev
operator|->
name|rlc_fw
operator|||
operator|!
name|rdev
operator|->
name|mc_fw
condition|)
block|{
name|r
operator|=
name|si_init_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
name|r
operator|=
name|si_mc_load_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load MC firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|r600_vram_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|si_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r
operator|=
name|si_pcie_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|si_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|r = evergreen_blit_init(rdev); 	if (r) { 		r600_blit_fini(rdev); 		rdev->asic->copy = NULL; 		dev_warn(rdev->dev, "failed blitter (%d) falling back to memcpy\n", r); 	}
endif|#
directive|endif
comment|/* allocate rlc buffers */
name|r
operator|=
name|si_rlc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to init rlc BOs!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP1_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP2_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|R600_RING_TYPE_DMA_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing DMA fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_DMA1_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing DMA fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|r
operator|=
name|si_irq_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: IH init failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|si_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|RADEON_WB_CP_RPTR_OFFSET
argument_list|,
name|CP_RB0_RPTR
argument_list|,
name|CP_RB0_WPTR
argument_list|,
literal|0
argument_list|,
literal|0xfffff
argument_list|,
name|RADEON_CP_PACKET2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|RADEON_WB_CP1_RPTR_OFFSET
argument_list|,
name|CP_RB1_RPTR
argument_list|,
name|CP_RB1_WPTR
argument_list|,
literal|0
argument_list|,
literal|0xfffff
argument_list|,
name|RADEON_CP_PACKET2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|RADEON_WB_CP2_RPTR_OFFSET
argument_list|,
name|CP_RB2_RPTR
argument_list|,
name|CP_RB2_WPTR
argument_list|,
literal|0
argument_list|,
literal|0xfffff
argument_list|,
name|RADEON_CP_PACKET2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|R600_WB_DMA_RPTR_OFFSET
argument_list|,
name|DMA_RB_RPTR
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
name|DMA_RB_WPTR
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
literal|2
argument_list|,
literal|0x3fffc
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_NOP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_DMA1_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|CAYMAN_WB_DMA1_RPTR_OFFSET
argument_list|,
name|DMA_RB_RPTR
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
name|DMA_RB_WPTR
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
literal|2
argument_list|,
literal|0x3fffc
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_NOP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|si_cp_load_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|si_cp_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|cayman_dma_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_vm_manager_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"vm manager initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|si_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Do not reset GPU before posting, on rv770 hw unlike on r500 hw, 	 * posting will perform necessary task to bring back GPU into good 	 * shape. 	 */
comment|/* post card */
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|si_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"si startup failed on resume\n"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|si_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|si_cp_enable
argument_list|(
name|rdev
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|cayman_dma_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_irq_suspend
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Plan is to move initialization in that function and use  * helper function so that radeon_device_init pretty much  * do nothing more than calling asic specific function. This  * should also allow to remove a bunch of callback function  * like vram_info.  */
end_comment

begin_function
name|int
name|si_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* Read BIOS */
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Must be an ATOMBIOS */
if|if
condition|(
operator|!
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting atombios for cayman GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_atombios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Post card if necessary */
if|if
condition|(
operator|!
name|radeon_card_posted
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Card not posted and no BIOS - ignoring\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_INFO
argument_list|(
literal|"GPU not posted. posting now...\n"
argument_list|)
expr_stmt|;
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize scratch registers */
name|si_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* initialize memory controller */
name|r
operator|=
name|si_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
expr_stmt|;
name|ring
operator|->
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
expr_stmt|;
name|ring
operator|->
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
expr_stmt|;
name|ring
operator|->
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
expr_stmt|;
name|ring
operator|->
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_DMA1_INDEX
index|]
expr_stmt|;
name|ring
operator|->
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ih_ring_init
argument_list|(
name|rdev
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|r
operator|=
name|r600_pcie_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|si_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|si_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|cayman_dma_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_irq_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_rlc_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_vm_manager_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
comment|/* Don't start up if the MC ucode is missing. 	 * The default clocks and voltages before the MC ucode 	 * is loaded are not suffient for advanced operations. 	 */
if|if
condition|(
operator|!
name|rdev
operator|->
name|mc_fw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: MC ucode required for NI+.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|si_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
literal|0
block|r600_blit_fini(rdev);
endif|#
directive|endif
name|si_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|cayman_dma_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_irq_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_rlc_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_vm_manager_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_vram_scratch_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|si_fini_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * si_get_gpu_clock - return GPU clock counter snapshot  *  * @rdev: radeon_device pointer  *  * Fetches a GPU clock counter snapshot (SI).  * Returns the 64 bit clock counter snapshot.  */
end_comment

begin_function
name|uint64_t
name|si_get_gpu_clock
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint64_t
name|clock
decl_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|rdev
operator|->
name|gpu_clock_mutex
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_CAPTURE_GPU_CLOCK_COUNT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|clock
operator|=
operator|(
name|uint64_t
operator|)
name|RREG32
argument_list|(
name|RLC_GPU_CLOCK_COUNT_LSB
argument_list|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|RREG32
argument_list|(
name|RLC_GPU_CLOCK_COUNT_MSB
argument_list|)
operator|<<
literal|32ULL
operator|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|rdev
operator|->
name|gpu_clock_mutex
argument_list|)
expr_stmt|;
return|return
name|clock
return|;
block|}
end_function

end_unit


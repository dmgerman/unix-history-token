begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Dave Airlie  *    Jerome Glisse<glisse@freedesktop.org>  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_if
if|#
directive|if
name|__OS_HAS_AGP
end_if

begin_struct
struct|struct
name|radeon_agpmode_quirk
block|{
name|u32
name|hostbridge_vendor
decl_stmt|;
name|u32
name|hostbridge_device
decl_stmt|;
name|u32
name|chip_vendor
decl_stmt|;
name|u32
name|chip_device
decl_stmt|;
name|u32
name|subsys_vendor
decl_stmt|;
name|u32
name|subsys_device
decl_stmt|;
name|u32
name|default_mode
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|radeon_agpmode_quirk
name|radeon_agpmode_quirk_list
index|[]
init|=
block|{
comment|/* Intel E7505 Memory Controller Hub / RV350 AR [Radeon 9600XT] Needs AGPMode 4 (deb #515326) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x2550
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4152
block|,
literal|0x1458
block|,
literal|0x4038
block|,
literal|4
block|}
block|,
comment|/* Intel 82865G/PE/P DRAM Controller/Host-Hub / Mobility 9800 Needs AGPMode 4 (deb #462590) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x2570
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4a4e
block|,
name|PCI_VENDOR_ID_DELL
block|,
literal|0x5106
block|,
literal|4
block|}
block|,
comment|/* Intel 82865G/PE/P DRAM Controller/Host-Hub / RV280 [Radeon 9200 SE] Needs AGPMode 4 (lp #300304) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x2570
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x5964
block|,
literal|0x148c
block|,
literal|0x2073
block|,
literal|4
block|}
block|,
comment|/* Intel 82855PM Processor to I/O Controller / Mobility M6 LY Needs AGPMode 1 (deb #467235) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3340
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4c59
block|,
name|PCI_VENDOR_ID_IBM
block|,
literal|0x052f
block|,
literal|1
block|}
block|,
comment|/* Intel 82855PM host bridge / Mobility 9600 M10 RV350 Needs AGPMode 1 (lp #195051) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3340
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4e50
block|,
name|PCI_VENDOR_ID_IBM
block|,
literal|0x0550
block|,
literal|1
block|}
block|,
comment|/* Intel 82855PM host bridge / Mobility M7 needs AGPMode 1 */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3340
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4c57
block|,
name|PCI_VENDOR_ID_IBM
block|,
literal|0x0530
block|,
literal|1
block|}
block|,
comment|/* Intel 82855PM host bridge / FireGL Mobility T2 RV350 Needs AGPMode 2 (fdo #20647) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3340
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4e54
block|,
name|PCI_VENDOR_ID_IBM
block|,
literal|0x054f
block|,
literal|2
block|}
block|,
comment|/* Intel 82855PM host bridge / Mobility M9+ / VaioPCG-V505DX Needs AGPMode 2 (fdo #17928) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3340
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x5c61
block|,
name|PCI_VENDOR_ID_SONY
block|,
literal|0x816b
block|,
literal|2
block|}
block|,
comment|/* Intel 82855PM Processor to I/O Controller / Mobility M9+ Needs AGPMode 8 (phoronix forum) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3340
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x5c61
block|,
name|PCI_VENDOR_ID_SONY
block|,
literal|0x8195
block|,
literal|8
block|}
block|,
comment|/* Intel 82830 830 Chipset Host Bridge / Mobility M6 LY Needs AGPMode 2 (fdo #17360)*/
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3575
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4c59
block|,
name|PCI_VENDOR_ID_DELL
block|,
literal|0x00e3
block|,
literal|2
block|}
block|,
comment|/* Intel 82852/82855 host bridge / Mobility FireGL 9000 RV250 Needs AGPMode 1 (lp #296617) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3580
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4c66
block|,
name|PCI_VENDOR_ID_DELL
block|,
literal|0x0149
block|,
literal|1
block|}
block|,
comment|/* Intel 82855PM host bridge / Mobility FireGL 9000 RV250 Needs AGPMode 1 for suspend/resume */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3340
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4c66
block|,
name|PCI_VENDOR_ID_IBM
block|,
literal|0x0531
block|,
literal|1
block|}
block|,
comment|/* Intel 82852/82855 host bridge / Mobility 9600 M10 RV350 Needs AGPMode 1 (deb #467460) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3580
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4e50
block|,
literal|0x1025
block|,
literal|0x0061
block|,
literal|1
block|}
block|,
comment|/* Intel 82852/82855 host bridge / Mobility 9600 M10 RV350 Needs AGPMode 1 (lp #203007) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3580
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4e50
block|,
literal|0x1025
block|,
literal|0x0064
block|,
literal|1
block|}
block|,
comment|/* Intel 82852/82855 host bridge / Mobility 9600 M10 RV350 Needs AGPMode 1 (lp #141551) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3580
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4e50
block|,
name|PCI_VENDOR_ID_ASUSTEK
block|,
literal|0x1942
block|,
literal|1
block|}
block|,
comment|/* Intel 82852/82855 host bridge / Mobility 9600/9700 Needs AGPMode 1 (deb #510208) */
block|{
name|PCI_VENDOR_ID_INTEL
block|,
literal|0x3580
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4e50
block|,
literal|0x10cf
block|,
literal|0x127f
block|,
literal|1
block|}
block|,
comment|/* ASRock K7VT4A+ AGP 8x / ATI Radeon 9250 AGP Needs AGPMode 4 (lp #133192) */
block|{
literal|0x1849
block|,
literal|0x3189
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x5960
block|,
literal|0x1787
block|,
literal|0x5960
block|,
literal|4
block|}
block|,
comment|/* VIA K8M800 Host Bridge / RV280 [Radeon 9200 PRO] Needs AGPMode 4 (fdo #12544) */
block|{
name|PCI_VENDOR_ID_VIA
block|,
literal|0x0204
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x5960
block|,
literal|0x17af
block|,
literal|0x2020
block|,
literal|4
block|}
block|,
comment|/* VIA KT880 Host Bridge / RV350 [Radeon 9550] Needs AGPMode 4 (fdo #19981) */
block|{
name|PCI_VENDOR_ID_VIA
block|,
literal|0x0269
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4153
block|,
name|PCI_VENDOR_ID_ASUSTEK
block|,
literal|0x003c
block|,
literal|4
block|}
block|,
comment|/* VIA VT8363 Host Bridge / R200 QL [Radeon 8500] Needs AGPMode 2 (lp #141551) */
block|{
name|PCI_VENDOR_ID_VIA
block|,
literal|0x0305
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x514c
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x013a
block|,
literal|2
block|}
block|,
comment|/* VIA VT82C693A Host Bridge / RV280 [Radeon 9200 PRO] Needs AGPMode 2 (deb #515512) */
block|{
name|PCI_VENDOR_ID_VIA
block|,
literal|0x0691
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x5960
block|,
name|PCI_VENDOR_ID_ASUSTEK
block|,
literal|0x004c
block|,
literal|2
block|}
block|,
comment|/* VIA VT82C693A Host Bridge / RV280 [Radeon 9200 PRO] Needs AGPMode 2 */
block|{
name|PCI_VENDOR_ID_VIA
block|,
literal|0x0691
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x5960
block|,
name|PCI_VENDOR_ID_ASUSTEK
block|,
literal|0x0054
block|,
literal|2
block|}
block|,
comment|/* VIA VT8377 Host Bridge / R200 QM [Radeon 9100] Needs AGPMode 4 (deb #461144) */
block|{
name|PCI_VENDOR_ID_VIA
block|,
literal|0x3189
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x514d
block|,
literal|0x174b
block|,
literal|0x7149
block|,
literal|4
block|}
block|,
comment|/* VIA VT8377 Host Bridge / RV280 [Radeon 9200 PRO] Needs AGPMode 4 (lp #312693) */
block|{
name|PCI_VENDOR_ID_VIA
block|,
literal|0x3189
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x5960
block|,
literal|0x1462
block|,
literal|0x0380
block|,
literal|4
block|}
block|,
comment|/* VIA VT8377 Host Bridge / RV280 Needs AGPMode 4 (ati ML) */
block|{
name|PCI_VENDOR_ID_VIA
block|,
literal|0x3189
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x5964
block|,
literal|0x148c
block|,
literal|0x2073
block|,
literal|4
block|}
block|,
comment|/* ATI Host Bridge / RV280 [M9+] Needs AGPMode 1 (phoronix forum) */
block|{
name|PCI_VENDOR_ID_ATI
block|,
literal|0xcbb2
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x5c61
block|,
name|PCI_VENDOR_ID_SONY
block|,
literal|0x8175
block|,
literal|1
block|}
block|,
comment|/* HP Host Bridge / R300 [FireGL X1] Needs AGPMode 2 (fdo #7770) */
block|{
name|PCI_VENDOR_ID_HP
block|,
literal|0x122e
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x4e47
block|,
name|PCI_VENDOR_ID_ATI
block|,
literal|0x0152
block|,
literal|2
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|radeon_agp_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|__OS_HAS_AGP
name|struct
name|radeon_agpmode_quirk
modifier|*
name|p
init|=
name|radeon_agpmode_quirk_list
decl_stmt|;
name|struct
name|drm_agp_mode
name|mode
decl_stmt|;
name|struct
name|drm_agp_info
name|info
decl_stmt|;
name|uint32_t
name|agp_status
decl_stmt|;
name|int
name|default_mode
decl_stmt|;
name|bool
name|is_v3
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Acquire AGP. */
name|ret
operator|=
name|drm_agp_acquire
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Unable to acquire AGP: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|drm_agp_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|drm_agp_release
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"Unable to get AGP info: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|agp
operator|->
name|agp_info
operator|.
name|ai_aperture_size
operator|>>
literal|20
operator|)
operator|<
literal|32
condition|)
block|{
name|drm_agp_release
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"AGP aperture too small (%zuM) "
literal|"need at least 32M, disabling AGP\n"
argument_list|,
name|rdev
operator|->
name|ddev
operator|->
name|agp
operator|->
name|agp_info
operator|.
name|ai_aperture_size
operator|>>
literal|20
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|mode
operator|.
name|mode
operator|=
name|info
operator|.
name|mode
expr_stmt|;
comment|/* chips with the agp to pcie bridge don't have the AGP_STATUS register 	 * Just use the whatever mode the host sets up. 	 */
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RV350
condition|)
name|agp_status
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_AGP_STATUS
argument_list|)
operator||
name|RADEON_AGPv3_MODE
operator|)
operator|&
name|mode
operator|.
name|mode
expr_stmt|;
else|else
name|agp_status
operator|=
name|mode
operator|.
name|mode
expr_stmt|;
name|is_v3
operator|=
operator|!
operator|!
operator|(
name|agp_status
operator|&
name|RADEON_AGPv3_MODE
operator|)
expr_stmt|;
if|if
condition|(
name|is_v3
condition|)
block|{
name|default_mode
operator|=
operator|(
name|agp_status
operator|&
name|RADEON_AGPv3_8X_MODE
operator|)
condition|?
literal|8
else|:
literal|4
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|agp_status
operator|&
name|RADEON_AGP_4X_MODE
condition|)
block|{
name|default_mode
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agp_status
operator|&
name|RADEON_AGP_2X_MODE
condition|)
block|{
name|default_mode
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|default_mode
operator|=
literal|1
expr_stmt|;
block|}
block|}
comment|/* Apply AGPMode Quirks */
while|while
condition|(
name|p
operator|&&
name|p
operator|->
name|chip_device
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|info
operator|.
name|id_vendor
operator|==
name|p
operator|->
name|hostbridge_vendor
operator|&&
name|info
operator|.
name|id_device
operator|==
name|p
operator|->
name|hostbridge_device
operator|&&
name|rdev
operator|->
name|ddev
operator|->
name|pci_vendor
operator|==
name|p
operator|->
name|chip_vendor
operator|&&
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
name|p
operator|->
name|chip_device
operator|&&
name|rdev
operator|->
name|ddev
operator|->
name|pci_subvendor
operator|==
name|p
operator|->
name|subsys_vendor
operator|&&
name|rdev
operator|->
name|ddev
operator|->
name|pci_subdevice
operator|==
name|p
operator|->
name|subsys_device
condition|)
block|{
name|default_mode
operator|=
name|p
operator|->
name|default_mode
expr_stmt|;
block|}
operator|++
name|p
expr_stmt|;
block|}
if|if
condition|(
name|radeon_agpmode
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|radeon_agpmode
operator|<
operator|(
name|is_v3
condition|?
literal|4
else|:
literal|1
operator|)
operator|)
operator|||
operator|(
name|radeon_agpmode
operator|>
operator|(
name|is_v3
condition|?
literal|8
else|:
literal|4
operator|)
operator|)
operator|||
operator|(
name|radeon_agpmode
operator|&
operator|(
name|radeon_agpmode
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal AGP Mode: %d (valid %s), leaving at %d\n"
argument_list|,
name|radeon_agpmode
argument_list|,
name|is_v3
condition|?
literal|"4, 8"
else|:
literal|"1, 2, 4"
argument_list|,
name|default_mode
argument_list|)
expr_stmt|;
name|radeon_agpmode
operator|=
name|default_mode
expr_stmt|;
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"AGP mode requested: %d\n"
argument_list|,
name|radeon_agpmode
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|radeon_agpmode
operator|=
name|default_mode
expr_stmt|;
block|}
name|mode
operator|.
name|mode
operator|&=
operator|~
name|RADEON_AGP_MODE_MASK
expr_stmt|;
if|if
condition|(
name|is_v3
condition|)
block|{
switch|switch
condition|(
name|radeon_agpmode
condition|)
block|{
case|case
literal|8
case|:
name|mode
operator|.
name|mode
operator||=
name|RADEON_AGPv3_8X_MODE
expr_stmt|;
break|break;
case|case
literal|4
case|:
default|default:
name|mode
operator|.
name|mode
operator||=
name|RADEON_AGPv3_4X_MODE
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|radeon_agpmode
condition|)
block|{
case|case
literal|4
case|:
name|mode
operator|.
name|mode
operator||=
name|RADEON_AGP_4X_MODE
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|mode
operator|.
name|mode
operator||=
name|RADEON_AGP_2X_MODE
expr_stmt|;
break|break;
case|case
literal|1
case|:
default|default:
name|mode
operator|.
name|mode
operator||=
name|RADEON_AGP_1X_MODE
expr_stmt|;
break|break;
block|}
block|}
name|mode
operator|.
name|mode
operator|&=
operator|~
name|RADEON_AGP_FW_MODE
expr_stmt|;
comment|/* disable fw */
name|ret
operator|=
name|drm_agp_enable
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Unable to enable AGP (mode = 0x%lx)\n"
argument_list|,
name|mode
operator|.
name|mode
argument_list|)
expr_stmt|;
name|drm_agp_release
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|rdev
operator|->
name|mc
operator|.
name|agp_base
operator|=
name|rdev
operator|->
name|ddev
operator|->
name|agp
operator|->
name|agp_info
operator|.
name|ai_aperture_base
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|=
name|rdev
operator|->
name|ddev
operator|->
name|agp
operator|->
name|agp_info
operator|.
name|ai_aperture_size
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|=
name|rdev
operator|->
name|mc
operator|.
name|agp_base
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|=
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|+
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|-
literal|1
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GTT: %juM 0x%08jX - 0x%08jX\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|,
operator|(
name|uintmax_t
operator|)
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
argument_list|,
operator|(
name|uintmax_t
operator|)
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
argument_list|)
expr_stmt|;
comment|/* workaround some hw issues */
if|if
condition|(
name|rdev
operator|->
name|family
operator|<
name|CHIP_R200
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_AGP_CNTL
argument_list|,
name|RREG32
argument_list|(
name|RADEON_AGP_CNTL
argument_list|)
operator||
literal|0x000e0000
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|radeon_agp_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|__OS_HAS_AGP
name|int
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|r
operator|=
name|radeon_agp_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"radeon AGP reinit failed\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|radeon_agp_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|rdev
operator|->
name|ddev
operator|->
name|agp
operator|&&
name|rdev
operator|->
name|ddev
operator|->
name|agp
operator|->
name|acquired
condition|)
block|{
name|drm_agp_release
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|radeon_agp_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|radeon_agp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"radeon_mode.h"
end_include

begin_include
include|#
directive|include
file|"r600d.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"avivod.h"
end_include

begin_define
define|#
directive|define
name|PFP_UCODE_SIZE
value|576
end_define

begin_define
define|#
directive|define
name|PM4_UCODE_SIZE
value|1792
end_define

begin_define
define|#
directive|define
name|RLC_UCODE_SIZE
value|768
end_define

begin_define
define|#
directive|define
name|R700_PFP_UCODE_SIZE
value|848
end_define

begin_define
define|#
directive|define
name|R700_PM4_UCODE_SIZE
value|1360
end_define

begin_define
define|#
directive|define
name|R700_RLC_UCODE_SIZE
value|1024
end_define

begin_define
define|#
directive|define
name|EVERGREEN_PFP_UCODE_SIZE
value|1120
end_define

begin_define
define|#
directive|define
name|EVERGREEN_PM4_UCODE_SIZE
value|1376
end_define

begin_define
define|#
directive|define
name|EVERGREEN_RLC_UCODE_SIZE
value|768
end_define

begin_define
define|#
directive|define
name|CAYMAN_RLC_UCODE_SIZE
value|1024
end_define

begin_define
define|#
directive|define
name|ARUBA_RLC_UCODE_SIZE
value|1536
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|__linux__
end_ifdef

begin_comment
comment|/* Firmware Names */
end_comment

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/R600_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/R600_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV610_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV610_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV630_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV630_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV620_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV620_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV635_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV635_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV670_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV670_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RS780_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RS780_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV770_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV770_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV730_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV730_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV710_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/RV710_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/R600_rlc.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/R700_rlc.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/CEDAR_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/CEDAR_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/CEDAR_rlc.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/REDWOOD_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/REDWOOD_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/REDWOOD_rlc.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/JUNIPER_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/JUNIPER_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/JUNIPER_rlc.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/CYPRESS_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/CYPRESS_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/CYPRESS_rlc.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/PALM_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/PALM_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/SUMO_rlc.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/SUMO_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/SUMO_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/SUMO2_pfp.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_FIRMWARE
argument_list|(
literal|"radeon/SUMO2_me.bin"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|int
name|r600_debugfs_mc_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* r600,rv610,rv630,rv620,rv635,rv670 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|FREEBSD_WIP
end_ifdef

begin_comment
comment|/* FreeBSD: to please GCC 4.2. */
end_comment

begin_function_decl
name|int
name|r600_mc_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|r600_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|FREEBSD_WIP
end_ifdef

begin_comment
comment|/* FreeBSD: to please GCC 4.2. */
end_comment

begin_function_decl
name|void
name|r600_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|void
name|r600_irq_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|r600_pcie_gen2_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* get temperature in millidegrees */
end_comment

begin_function
name|int
name|rv6xx_get_temp
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|temp
init|=
operator|(
name|RREG32
argument_list|(
name|CG_THERMAL_STATUS
argument_list|)
operator|&
name|ASIC_T_MASK
operator|)
operator|>>
name|ASIC_T_SHIFT
decl_stmt|;
name|int
name|actual_temp
init|=
name|temp
operator|&
literal|0xff
decl_stmt|;
if|if
condition|(
name|temp
operator|&
literal|0x100
condition|)
name|actual_temp
operator|-=
literal|256
expr_stmt|;
return|return
name|actual_temp
operator|*
literal|1000
return|;
block|}
end_function

begin_function
name|void
name|r600_pm_get_dynpm_state
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_upclock
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_downclock
operator|=
name|true
expr_stmt|;
comment|/* power state array is low to high, default is first */
if|if
condition|(
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R600
operator|)
condition|)
block|{
name|int
name|min_power_state_index
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|>
literal|2
condition|)
name|min_power_state_index
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|pm
operator|.
name|dynpm_planned_action
condition|)
block|{
case|case
name|DYNPM_ACTION_MINIMUM
case|:
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|min_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_downclock
operator|=
name|false
expr_stmt|;
break|break;
case|case
name|DYNPM_ACTION_DOWNCLOCK
case|:
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|==
name|min_power_state_index
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_downclock
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|active_crtc_count
operator|>
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
condition|)
continue|continue;
elseif|else
if|if
condition|(
name|i
operator|>=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
expr_stmt|;
break|break;
block|}
else|else
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|==
literal|0
condition|)
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|-
literal|1
expr_stmt|;
else|else
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|-
literal|1
expr_stmt|;
block|}
block|}
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
literal|0
expr_stmt|;
comment|/* don't use the power state if crtcs are active and no display flag is set */
if|if
condition|(
operator|(
name|rdev
operator|->
name|pm
operator|.
name|active_crtc_count
operator|>
literal|0
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|clock_info
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
index|]
operator|.
name|flags
operator|&
name|RADEON_PM_MODE_NO_DISPLAY
operator|)
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|DYNPM_ACTION_UPCLOCK
case|:
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|==
operator|(
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|-
literal|1
operator|)
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_upclock
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|active_crtc_count
operator|>
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
operator|(
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|-
literal|1
operator|)
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
condition|)
continue|continue;
elseif|else
if|if
condition|(
name|i
operator|<=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
expr_stmt|;
break|break;
block|}
else|else
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|+
literal|1
expr_stmt|;
block|}
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|DYNPM_ACTION_DEFAULT
case|:
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_upclock
operator|=
name|false
expr_stmt|;
break|break;
case|case
name|DYNPM_ACTION_NONE
case|:
default|default:
name|DRM_ERROR
argument_list|(
literal|"Requested mode for not defined action\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
comment|/* XXX select a power state based on AC/DC, single/dualhead, etc. */
comment|/* for now just select the first power state and switch between clock modes */
comment|/* power state array is low to high, default is first (0) */
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|active_crtc_count
operator|>
literal|1
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* start at 1 as we don't want the default mode */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
condition|)
continue|continue;
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|type
operator|==
name|POWER_STATE_TYPE_PERFORMANCE
operator|)
operator|||
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|type
operator|==
name|POWER_STATE_TYPE_BATTERY
operator|)
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
comment|/* if nothing selected, grab the default state. */
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|==
operator|-
literal|1
condition|)
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|pm
operator|.
name|dynpm_planned_action
condition|)
block|{
case|case
name|DYNPM_ACTION_MINIMUM
case|:
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_downclock
operator|=
name|false
expr_stmt|;
break|break;
case|case
name|DYNPM_ACTION_DOWNCLOCK
case|:
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|==
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|current_clock_mode_index
operator|==
literal|0
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_downclock
operator|=
name|false
expr_stmt|;
block|}
else|else
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_clock_mode_index
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_downclock
operator|=
name|false
expr_stmt|;
block|}
comment|/* don't use the power state if crtcs are active and no display flag is set */
if|if
condition|(
operator|(
name|rdev
operator|->
name|pm
operator|.
name|active_crtc_count
operator|>
literal|0
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|clock_info
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
index|]
operator|.
name|flags
operator|&
name|RADEON_PM_MODE_NO_DISPLAY
operator|)
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|DYNPM_ACTION_UPCLOCK
case|:
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|==
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|current_clock_mode_index
operator|==
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|num_clock_modes
operator|-
literal|1
operator|)
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_clock_mode_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_upclock
operator|=
name|false
expr_stmt|;
block|}
else|else
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_clock_mode_index
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|num_clock_modes
operator|-
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_upclock
operator|=
name|false
expr_stmt|;
block|}
break|break;
case|case
name|DYNPM_ACTION_DEFAULT
case|:
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_upclock
operator|=
name|false
expr_stmt|;
break|break;
case|case
name|DYNPM_ACTION_NONE
case|:
default|default:
name|DRM_ERROR
argument_list|(
literal|"Requested mode for not defined action\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Requested: e: %d m: %d p: %d\n"
argument_list|,
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|clock_info
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
index|]
operator|.
name|sclk
argument_list|,
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|clock_info
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
index|]
operator|.
name|mclk
argument_list|,
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|pcie_lanes
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rs780_pm_init_profile
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|==
literal|2
condition|)
block|{
comment|/* default */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|==
literal|3
condition|)
block|{
comment|/* default */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* default */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|3
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|3
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|r600_pm_init_profile
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R600
condition|)
block|{
comment|/* XXX */
comment|/* default */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|<
literal|4
condition|)
block|{
comment|/* default */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|2
expr_stmt|;
comment|/* low sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|1
expr_stmt|;
comment|/* high sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|2
expr_stmt|;
comment|/* low mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|1
expr_stmt|;
comment|/* high mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
comment|/* default */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|2
expr_stmt|;
comment|/* low sh */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_MOBILITY
condition|)
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_BATTERY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_PERFORMANCE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|1
expr_stmt|;
comment|/* high sh */
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_PERFORMANCE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|2
expr_stmt|;
comment|/* low mh */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_MOBILITY
condition|)
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_BATTERY
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_PERFORMANCE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|1
expr_stmt|;
comment|/* high mh */
name|idx
operator|=
name|radeon_pm_get_type_index
argument_list|(
name|rdev
argument_list|,
name|POWER_STATE_TYPE_PERFORMANCE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|idx
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|2
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|r600_pm_misc
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|req_ps_idx
init|=
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
decl_stmt|;
name|int
name|req_cm_idx
init|=
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
decl_stmt|;
name|struct
name|radeon_power_state
modifier|*
name|ps
init|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|req_ps_idx
index|]
decl_stmt|;
name|struct
name|radeon_voltage
modifier|*
name|voltage
init|=
operator|&
name|ps
operator|->
name|clock_info
index|[
name|req_cm_idx
index|]
operator|.
name|voltage
decl_stmt|;
if|if
condition|(
operator|(
name|voltage
operator|->
name|type
operator|==
name|VOLTAGE_SW
operator|)
operator|&&
name|voltage
operator|->
name|voltage
condition|)
block|{
comment|/* 0xff01 is a flag rather then an actual voltage */
if|if
condition|(
name|voltage
operator|->
name|voltage
operator|==
literal|0xff01
condition|)
return|return;
if|if
condition|(
name|voltage
operator|->
name|voltage
operator|!=
name|rdev
operator|->
name|pm
operator|.
name|current_vddc
condition|)
block|{
name|radeon_atom_set_voltage
argument_list|(
name|rdev
argument_list|,
name|voltage
operator|->
name|voltage
argument_list|,
name|SET_VOLTAGE_TYPE_ASIC_VDDC
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|current_vddc
operator|=
name|voltage
operator|->
name|voltage
expr_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Setting: v: %d\n"
argument_list|,
name|voltage
operator|->
name|voltage
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|bool
name|r600_gui_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
operator|&
name|GUI_ACTIVE
condition|)
return|return
name|false
return|;
else|else
return|return
name|true
return|;
block|}
end_function

begin_comment
comment|/* hpd for digital panel detect/disconnect */
end_comment

begin_function
name|bool
name|r600_hpd_sense
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|enum
name|radeon_hpd_id
name|hpd
parameter_list|)
block|{
name|bool
name|connected
init|=
name|false
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD1_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD2_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD3_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_4
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD4_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
comment|/* DCE 3.2 */
case|case
name|RADEON_HPD_5
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD5_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_6
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HPD6_INT_STATUS
argument_list|)
operator|&
name|DC_HPDx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_INT_STATUS
argument_list|)
operator|&
name|DC_HOT_PLUG_DETECTx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_INT_STATUS
argument_list|)
operator|&
name|DC_HOT_PLUG_DETECTx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_INT_STATUS
argument_list|)
operator|&
name|DC_HOT_PLUG_DETECTx_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
return|return
name|connected
return|;
block|}
end_function

begin_function
name|void
name|r600_hpd_set_polarity
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|enum
name|radeon_hpd_id
name|hpd
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|bool
name|connected
init|=
name|r600_hpd_sense
argument_list|(
name|rdev
argument_list|,
name|hpd
argument_list|)
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_4
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_5
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
comment|/* DCE 3.2 */
case|case
name|RADEON_HPD_6
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HPDx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HOT_PLUG_DETECTx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HOT_PLUG_DETECTx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HOT_PLUG_DETECTx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HOT_PLUG_DETECTx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_INT_CONTROL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|DC_HOT_PLUG_DETECTx_INT_POLARITY
expr_stmt|;
else|else
name|tmp
operator||=
name|DC_HOT_PLUG_DETECTx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
block|}
end_function

begin_function
name|void
name|r600_hpd_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|unsigned
name|enable
init|=
literal|0
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|connector
argument_list|,
argument|&dev->mode_config.connector_list
argument_list|,
argument|head
argument_list|)
block|{
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
init|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
decl_stmt|;
if|if
condition|(
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_eDP
operator|||
name|connector
operator|->
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_LVDS
condition|)
block|{
comment|/* don't try to enable hpd on eDP or LVDS avoid breaking the 			 * aux dp channel on imac and help (but not completely fix) 			 * https://bugzilla.redhat.com/show_bug.cgi?id=726143 			 */
continue|continue;
block|}
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|u32
name|tmp
init|=
name|DC_HPDx_CONNECTION_TIMER
argument_list|(
literal|0x9c4
argument_list|)
operator||
name|DC_HPDx_RX_INT_TIMER
argument_list|(
literal|0xfa
argument_list|)
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE32
argument_list|(
name|rdev
argument_list|)
condition|)
name|tmp
operator||=
name|DC_HPDx_EN
expr_stmt|;
switch|switch
condition|(
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|WREG32
argument_list|(
name|DC_HPD1_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|WREG32
argument_list|(
name|DC_HPD2_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
name|WREG32
argument_list|(
name|DC_HPD3_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_4
case|:
name|WREG32
argument_list|(
name|DC_HPD4_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
comment|/* DCE 3.2 */
case|case
name|RADEON_HPD_5
case|:
name|WREG32
argument_list|(
name|DC_HPD5_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_6
case|:
name|WREG32
argument_list|(
name|DC_HPD6_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_CONTROL
argument_list|,
name|DC_HOT_PLUG_DETECTx_EN
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_CONTROL
argument_list|,
name|DC_HOT_PLUG_DETECTx_EN
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_CONTROL
argument_list|,
name|DC_HOT_PLUG_DETECTx_EN
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|enable
operator||=
literal|1
operator|<<
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
expr_stmt|;
name|radeon_hpd_set_polarity
argument_list|(
name|rdev
argument_list|,
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
argument_list|)
expr_stmt|;
block|}
name|radeon_irq_kms_enable_hpd
argument_list|(
name|rdev
argument_list|,
name|enable
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r600_hpd_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|unsigned
name|disable
init|=
literal|0
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|connector
argument_list|,
argument|&dev->mode_config.connector_list
argument_list|,
argument|head
argument_list|)
block|{
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
init|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|WREG32
argument_list|(
name|DC_HPD1_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|WREG32
argument_list|(
name|DC_HPD2_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
name|WREG32
argument_list|(
name|DC_HPD3_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_4
case|:
name|WREG32
argument_list|(
name|DC_HPD4_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
comment|/* DCE 3.2 */
case|case
name|RADEON_HPD_5
case|:
name|WREG32
argument_list|(
name|DC_HPD5_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_6
case|:
name|WREG32
argument_list|(
name|DC_HPD6_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_3
case|:
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|disable
operator||=
literal|1
operator|<<
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
expr_stmt|;
block|}
name|radeon_irq_kms_disable_hpd
argument_list|(
name|rdev
argument_list|,
name|disable
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * R600 PCIE GART  */
end_comment

begin_function
name|void
name|r600_pcie_gart_tlb_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* flush hdp cache so updates hit vram */
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RV740
operator|)
operator|&&
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
condition|)
block|{
specifier|volatile
name|uint32_t
modifier|*
name|ptr
init|=
name|rdev
operator|->
name|gart
operator|.
name|ptr
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* r7xx hw bug.  write to HDP_DEBUG1 followed by fb read 		 * rather than write to HDP_REG_COHERENCY_FLUSH_CNTL 		 * This seems to cause problems on some AGP cards. Just use the old 		 * method for them. 		 */
name|WREG32
argument_list|(
name|HDP_DEBUG1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|*
name|ptr
expr_stmt|;
block|}
else|else
name|WREG32
argument_list|(
name|R_005480_HDP_MEM_COHERENCY_FLUSH_CNTL
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_INVALIDATION_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_INVALIDATION_HIGH_ADDR
argument_list|,
operator|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|-
literal|1
operator|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_REQUEST_RESPONSE
argument_list|,
name|REQUEST_TYPE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
comment|/* read MC_STATUS */
name|tmp
operator|=
name|RREG32
argument_list|(
name|VM_CONTEXT0_REQUEST_RESPONSE
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|&
name|RESPONSE_TYPE_MASK
operator|)
operator|>>
name|RESPONSE_TYPE_SHIFT
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"[drm] r600 flush TLB failed\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tmp
condition|)
block|{
return|return;
block|}
name|udelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|r600_pcie_gart_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|robj
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"R600 PCIE GART already initialized\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Initialize common gart structure */
name|r
operator|=
name|radeon_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rdev
operator|->
name|gart
operator|.
name|table_size
operator|=
name|rdev
operator|->
name|gart
operator|.
name|num_gpu_pages
operator|*
literal|8
expr_stmt|;
return|return
name|radeon_gart_table_vram_alloc
argument_list|(
name|rdev
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_pcie_gart_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|r
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"No VRAM object for PCIE GART.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_gart_table_vram_pin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|radeon_gart_restore
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_CACHE
operator||
name|ENABLE_L2_FRAGMENT_PROCESSING
operator||
name|ENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|BANK_SELECT_0
argument_list|(
literal|0
argument_list|)
operator||
name|BANK_SELECT_1
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|tmp
operator|=
name|ENABLE_L1_TLB
operator||
name|ENABLE_L1_FRAGMENT_PROCESSING
operator||
name|SYSTEM_ACCESS_MODE_NOT_IN_SYS
operator||
name|EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|ENABLE_WAIT_L2_QUERY
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_SYS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_SYS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_HDP_CNTL
argument_list|,
name|tmp
operator||
name|ENABLE_L1_STRICT_ORDERING
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_HDP_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_RD_A_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_WR_A_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_RD_B_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_WR_B_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_GFX_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_GFX_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_PDMA_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_PDMA_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_SEM_CNTL
argument_list|,
name|tmp
operator||
name|ENABLE_SEMAPHORE_MODE
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_SEM_CNTL
argument_list|,
name|tmp
operator||
name|ENABLE_SEMAPHORE_MODE
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_START_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_END_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
argument_list|,
name|rdev
operator|->
name|gart
operator|.
name|table_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
argument_list|,
name|ENABLE_CONTEXT
operator||
name|PAGE_TABLE_DEPTH
argument_list|(
literal|0
argument_list|)
operator||
name|RANGE_PROTECTION_FAULT_ENABLE_DEFAULT
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PROTECTION_FAULT_DEFAULT_ADDR
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|rdev
operator|->
name|dummy_page
operator|.
name|addr
operator|>>
literal|12
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|r600_pcie_gart_tlb_flush
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"PCIE GART of %uM enabled (table at 0x%016llX).\n"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|ready
operator|=
name|true
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_pcie_gart_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Disable all tables */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_FRAGMENT_PROCESSING
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|BANK_SELECT_0
argument_list|(
literal|0
argument_list|)
operator||
name|BANK_SELECT_1
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup L1 TLB control */
name|tmp
operator|=
name|EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|ENABLE_WAIT_L2_QUERY
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_RD_A_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_WR_A_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_RD_B_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_WR_B_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_GFX_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_GFX_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_PDMA_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_PDMA_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_SEM_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_SEM_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_SYS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_SYS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_HDP_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_HDP_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_unpin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_pcie_gart_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|radeon_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_free
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_agp_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_CACHE
operator||
name|ENABLE_L2_FRAGMENT_PROCESSING
operator||
name|ENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|BANK_SELECT_0
argument_list|(
literal|0
argument_list|)
operator||
name|BANK_SELECT_1
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|tmp
operator|=
name|ENABLE_L1_TLB
operator||
name|ENABLE_L1_FRAGMENT_PROCESSING
operator||
name|SYSTEM_ACCESS_MODE_NOT_IN_SYS
operator||
name|EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|ENABLE_WAIT_L2_QUERY
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_SYS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_SYS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_HDP_CNTL
argument_list|,
name|tmp
operator||
name|ENABLE_L1_STRICT_ORDERING
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_HDP_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_RD_A_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_WR_A_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_RD_B_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCD_WR_B_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_GFX_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_GFX_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_PDMA_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_PDMA_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_RD_SEM_CNTL
argument_list|,
name|tmp
operator||
name|ENABLE_SEMAPHORE_MODE
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_L1_TLB_MCB_WR_SEM_CNTL
argument_list|,
name|tmp
operator||
name|ENABLE_SEMAPHORE_MODE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_mc_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
comment|/* read MC_STATUS */
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_000E50_SRBM_STATUS
argument_list|)
operator|&
literal|0x3F00
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
return|return
literal|0
return|;
name|udelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|rv515_mc_save
name|save
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Initialize HDP */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
operator|,
name|j
operator|+=
literal|0x18
control|)
block|{
name|WREG32
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|HDP_REG_COHERENCY_FLUSH_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rv515_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|r600_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Lockout access through VGA aperture (doesn't exist before R600) */
name|WREG32
argument_list|(
name|VGA_HDP_CONTROL
argument_list|,
name|VGA_MEMORY_DISABLE
argument_list|)
expr_stmt|;
comment|/* Update configuration */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|<
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
condition|)
block|{
comment|/* VRAM before AGP */
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* VRAM after AGP */
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|MC_VM_SYSTEM_APERTURE_DEFAULT_ADDR
argument_list|,
name|rdev
operator|->
name|vram_scratch
operator|.
name|gpu_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|24
operator|)
operator|&
literal|0xFFFF
operator|)
operator|<<
literal|16
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|24
operator|)
operator|&
literal|0xFFFF
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_FB_LOCATION
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_BASE
argument_list|,
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_INFO
argument_list|,
operator|(
literal|2
operator|<<
literal|7
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_NONSURFACE_SIZE
argument_list|,
literal|0x3FFFFFFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|WREG32
argument_list|(
name|MC_VM_AGP_TOP
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|22
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BOT
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|22
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BASE
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|agp_base
operator|>>
literal|22
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|MC_VM_AGP_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_TOP
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_VM_AGP_BOT
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r600_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
name|rv515_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
comment|/* we need to own VRAM, so turn off the VGA renderer here 	 * to stop it overwriting our objects */
name|rv515_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * r600_vram_gtt_location - try to find VRAM& GTT location  * @rdev: radeon device structure holding all necessary informations  * @mc: memory controller structure holding memory informations  *  * Function will place try to place VRAM at same place as in CPU (PCI)  * address space as some GPU seems to have issue when we reprogram at  * different address space.  *  * If there is not enough space to fit the unvisible VRAM after the  * aperture then we limit the VRAM size to the aperture.  *  * If we are using AGP then place VRAM adjacent to AGP aperture are we need  * them to be in one from GPU point of view so that we can program GPU to  * catch access outside them (weird GPU policy see ??).  *  * This function will never fails, worst case are limiting VRAM or GTT.  *  * Note: GTT start, end, size should be initialized before calling this  * function on AGP platform.  */
end_comment

begin_function
specifier|static
name|void
name|r600_vram_gtt_location
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_mc
modifier|*
name|mc
parameter_list|)
block|{
name|u64
name|size_bf
decl_stmt|,
name|size_af
decl_stmt|;
if|if
condition|(
name|mc
operator|->
name|mc_vram_size
operator|>
literal|0xE0000000
condition|)
block|{
comment|/* leave room for at least 512M GTT */
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"limiting VRAM\n"
argument_list|)
expr_stmt|;
name|mc
operator|->
name|real_vram_size
operator|=
literal|0xE0000000
expr_stmt|;
name|mc
operator|->
name|mc_vram_size
operator|=
literal|0xE0000000
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|size_bf
operator|=
name|mc
operator|->
name|gtt_start
expr_stmt|;
name|size_af
operator|=
literal|0xFFFFFFFF
operator|-
name|mc
operator|->
name|gtt_end
expr_stmt|;
if|if
condition|(
name|size_bf
operator|>
name|size_af
condition|)
block|{
if|if
condition|(
name|mc
operator|->
name|mc_vram_size
operator|>
name|size_bf
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"limiting VRAM\n"
argument_list|)
expr_stmt|;
name|mc
operator|->
name|real_vram_size
operator|=
name|size_bf
expr_stmt|;
name|mc
operator|->
name|mc_vram_size
operator|=
name|size_bf
expr_stmt|;
block|}
name|mc
operator|->
name|vram_start
operator|=
name|mc
operator|->
name|gtt_start
operator|-
name|mc
operator|->
name|mc_vram_size
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mc
operator|->
name|mc_vram_size
operator|>
name|size_af
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"limiting VRAM\n"
argument_list|)
expr_stmt|;
name|mc
operator|->
name|real_vram_size
operator|=
name|size_af
expr_stmt|;
name|mc
operator|->
name|mc_vram_size
operator|=
name|size_af
expr_stmt|;
block|}
name|mc
operator|->
name|vram_start
operator|=
name|mc
operator|->
name|gtt_end
operator|+
literal|1
expr_stmt|;
block|}
name|mc
operator|->
name|vram_end
operator|=
name|mc
operator|->
name|vram_start
operator|+
name|mc
operator|->
name|mc_vram_size
operator|-
literal|1
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"VRAM: %juM 0x%08jX - 0x%08jX (%juM used)\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|mc_vram_size
operator|>>
literal|20
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|vram_start
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|vram_end
argument_list|,
operator|(
name|uintmax_t
operator|)
name|mc
operator|->
name|real_vram_size
operator|>>
literal|20
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u64
name|base
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
name|base
operator|=
name|RREG32
argument_list|(
name|MC_VM_FB_LOCATION
argument_list|)
operator|&
literal|0xFFFF
expr_stmt|;
name|base
operator|<<=
literal|24
expr_stmt|;
block|}
name|radeon_vram_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_base_align
operator|=
literal|0
expr_stmt|;
name|radeon_gtt_location
argument_list|(
name|rdev
argument_list|,
name|mc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|r600_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|chansize
decl_stmt|,
name|numchan
decl_stmt|;
comment|/* Get VRAM informations */
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RAMCFG
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|CHANSIZE_OVERRIDE
condition|)
block|{
name|chansize
operator|=
literal|16
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tmp
operator|&
name|CHANSIZE_MASK
condition|)
block|{
name|chansize
operator|=
literal|64
expr_stmt|;
block|}
else|else
block|{
name|chansize
operator|=
literal|32
expr_stmt|;
block|}
name|tmp
operator|=
name|RREG32
argument_list|(
name|CHMAP
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|tmp
operator|&
name|NOOFCHAN_MASK
operator|)
operator|>>
name|NOOFCHAN_SHIFT
condition|)
block|{
case|case
literal|0
case|:
default|default:
name|numchan
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|numchan
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|numchan
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|numchan
operator|=
literal|8
expr_stmt|;
break|break;
block|}
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
name|numchan
operator|*
name|chansize
expr_stmt|;
comment|/* Could aper size report 0 ? */
name|rdev
operator|->
name|mc
operator|.
name|aper_base
operator|=
name|drm_get_resource_start
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|aper_size
operator|=
name|drm_get_resource_len
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Setup GPU memory space */
name|rdev
operator|->
name|mc
operator|.
name|mc_vram_size
operator|=
name|RREG32
argument_list|(
name|CONFIG_MEMSIZE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|=
name|RREG32
argument_list|(
name|CONFIG_MEMSIZE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_size
expr_stmt|;
name|r600_vram_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
name|rs690_pm_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|igp_sideport_enabled
operator|=
name|radeon_atombios_sideport_present
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r600_vram_scratch_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|void
modifier|*
name|vram_scratch_ptr_ptr
decl_stmt|;
comment|/* FreeBSD: to please GCC 4.2. */
if|if
condition|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|r
operator|=
name|radeon_bo_create
argument_list|(
name|rdev
argument_list|,
name|RADEON_GPU_PAGE_SIZE
argument_list|,
name|PAGE_SIZE
argument_list|,
name|true
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|NULL
argument_list|,
operator|&
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
block|}
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|radeon_bo_unref
argument_list|(
operator|&
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_bo_pin
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
operator|&
name|rdev
operator|->
name|vram_scratch
operator|.
name|gpu_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_bo_unreserve
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
name|radeon_bo_unref
argument_list|(
operator|&
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|vram_scratch_ptr_ptr
operator|=
operator|&
name|rdev
operator|->
name|vram_scratch
operator|.
name|ptr
expr_stmt|;
name|r
operator|=
name|radeon_bo_kmap
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|,
name|vram_scratch_ptr_ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
name|radeon_bo_unpin
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
name|radeon_bo_unref
argument_list|(
operator|&
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|r600_vram_scratch_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
name|r
operator|==
literal|0
argument_list|)
condition|)
block|{
name|radeon_bo_kunmap
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
name|radeon_bo_unpin
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
block|}
name|radeon_bo_unref
argument_list|(
operator|&
name|rdev
operator|->
name|vram_scratch
operator|.
name|robj
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* We doesn't check that the GPU really needs a reset we simply do the  * reset, it's up to the caller to determine if the GPU needs one. We  * might add an helper function to check that.  */
end_comment

begin_function
specifier|static
name|void
name|r600_gpu_soft_reset_gfx
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|grbm_busy_mask
init|=
name|S_008010_VC_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_VGT_BUSY_NO_DMA
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_VGT_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_TA03_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_TC_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_SX_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_SH_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_SPI03_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_SMX_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_SC_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_PA_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_DB03_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_CR_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_CB03_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008010_GUI_ACTIVE
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|u32
name|grbm2_busy_mask
init|=
name|S_008014_SPI0_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_SPI1_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_SPI2_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_SPI3_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_TA0_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_TA1_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_TA2_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_TA3_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_DB0_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_DB1_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_DB2_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_DB3_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_CB0_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_CB1_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_CB2_BUSY
argument_list|(
literal|1
argument_list|)
operator||
name|S_008014_CB3_BUSY
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
operator|&
name|GUI_ACTIVE
operator|)
condition|)
return|return;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008010_GRBM_STATUS      = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|R_008010_GRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008014_GRBM_STATUS2     = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|R_008014_GRBM_STATUS2
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_000E50_SRBM_STATUS      = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E50_SRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008674_CP_STALLED_STAT1 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008678_CP_STALLED_STAT2 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT2
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00867C_CP_BUSY_STAT     = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_BUSY_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008680_CP_STAT          = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Disable CP parsing/prefetching */
name|WREG32
argument_list|(
name|R_0086D8_CP_ME_CNTL
argument_list|,
name|S_0086D8_CP_ME_HALT
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check if any of the rendering block is busy and reset it */
if|if
condition|(
operator|(
name|RREG32
argument_list|(
name|R_008010_GRBM_STATUS
argument_list|)
operator|&
name|grbm_busy_mask
operator|)
operator|||
operator|(
name|RREG32
argument_list|(
name|R_008014_GRBM_STATUS2
argument_list|)
operator|&
name|grbm2_busy_mask
operator|)
condition|)
block|{
name|tmp
operator|=
name|S_008020_SOFT_RESET_CR
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_DB
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_CB
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_PA
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_SC
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_SMX
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_SPI
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_SX
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_SH
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_TC
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_TA
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_VC
argument_list|(
literal|1
argument_list|)
operator||
name|S_008020_SOFT_RESET_VGT
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008020_GRBM_SOFT_RESET=0x%08X\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_008020_GRBM_SOFT_RESET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|R_008020_GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|mdelay
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_008020_GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Reset CP (we always reset CP) */
name|tmp
operator|=
name|S_008020_SOFT_RESET_CP
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"R_008020_GRBM_SOFT_RESET=0x%08X\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_008020_GRBM_SOFT_RESET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|R_008020_GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|mdelay
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_008020_GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008010_GRBM_STATUS      = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|R_008010_GRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008014_GRBM_STATUS2     = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|R_008014_GRBM_STATUS2
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_000E50_SRBM_STATUS      = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E50_SRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008674_CP_STALLED_STAT1 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008678_CP_STALLED_STAT2 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT2
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00867C_CP_BUSY_STAT     = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_BUSY_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008680_CP_STAT          = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_gpu_soft_reset_dma
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
operator|&
name|DMA_IDLE
condition|)
return|return;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00D034_DMA_STATUS_REG   = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Disable DMA */
name|tmp
operator|=
name|RREG32
argument_list|(
name|DMA_RB_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|DMA_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Reset dma */
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
name|RV770_SOFT_RESET_DMA
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
name|SOFT_RESET_DMA
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|udelay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00D034_DMA_STATUS_REG   = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_gpu_soft_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|reset_mask
parameter_list|)
block|{
name|struct
name|rv515_mc_save
name|save
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
operator|&
name|GUI_ACTIVE
operator|)
condition|)
name|reset_mask
operator|&=
operator|~
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator|)
expr_stmt|;
if|if
condition|(
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
operator|&
name|DMA_IDLE
condition|)
name|reset_mask
operator|&=
operator|~
name|RADEON_RESET_DMA
expr_stmt|;
if|if
condition|(
name|reset_mask
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU softreset: 0x%08X\n"
argument_list|,
name|reset_mask
argument_list|)
expr_stmt|;
name|rv515_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|r600_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reset_mask
operator|&
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator|)
condition|)
name|r600_gpu_soft_reset_gfx
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset_mask
operator|&
name|RADEON_RESET_DMA
condition|)
name|r600_gpu_soft_reset_dma
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Wait a little for things to settle down */
name|mdelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|rv515_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|bool
name|r600_gpu_is_lockup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|u32
name|srbm_status
decl_stmt|;
name|u32
name|grbm_status
decl_stmt|;
name|u32
name|grbm_status2
decl_stmt|;
name|srbm_status
operator|=
name|RREG32
argument_list|(
name|R_000E50_SRBM_STATUS
argument_list|)
expr_stmt|;
name|grbm_status
operator|=
name|RREG32
argument_list|(
name|R_008010_GRBM_STATUS
argument_list|)
expr_stmt|;
name|grbm_status2
operator|=
name|RREG32
argument_list|(
name|R_008014_GRBM_STATUS2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|G_008010_GUI_ACTIVE
argument_list|(
name|grbm_status
argument_list|)
condition|)
block|{
name|radeon_ring_lockup_update
argument_list|(
name|ring
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* force CP activities */
name|radeon_ring_force_activity
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|radeon_ring_test_lockup
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * r600_dma_is_lockup - Check if the DMA engine is locked up  *  * @rdev: radeon_device pointer  * @ring: radeon_ring structure holding ring information  *  * Check if the async DMA engine is locked up (r6xx-evergreen).  * Returns true if the engine appears to be locked up, false if not.  */
end_comment

begin_function
name|bool
name|r600_dma_is_lockup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|u32
name|dma_status_reg
decl_stmt|;
name|dma_status_reg
operator|=
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
expr_stmt|;
if|if
condition|(
name|dma_status_reg
operator|&
name|DMA_IDLE
condition|)
block|{
name|radeon_ring_lockup_update
argument_list|(
name|ring
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* force ring activities */
name|radeon_ring_force_activity
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|radeon_ring_test_lockup
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|r600_asic_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
return|return
name|r600_gpu_soft_reset
argument_list|(
name|rdev
argument_list|,
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator||
name|RADEON_RESET_DMA
operator|)
argument_list|)
return|;
block|}
end_function

begin_function
name|u32
name|r6xx_remap_render_backend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|tiling_pipe_num
parameter_list|,
name|u32
name|max_rb_num
parameter_list|,
name|u32
name|total_max_rb_num
parameter_list|,
name|u32
name|disabled_rb_mask
parameter_list|)
block|{
name|u32
name|rendering_pipe_num
decl_stmt|,
name|rb_num_width
decl_stmt|,
name|req_rb_num
decl_stmt|;
name|u32
name|pipe_rb_ratio
decl_stmt|,
name|pipe_rb_remain
decl_stmt|,
name|tmp
decl_stmt|;
name|u32
name|data
init|=
literal|0
decl_stmt|,
name|mask
init|=
literal|1
operator|<<
operator|(
name|max_rb_num
operator|-
literal|1
operator|)
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* mask out the RBs that don't exist on that asic */
name|tmp
operator|=
name|disabled_rb_mask
operator||
operator|(
operator|(
literal|0xff
operator|<<
name|max_rb_num
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
comment|/* make sure at least one RB is available */
if|if
condition|(
operator|(
name|tmp
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
condition|)
name|disabled_rb_mask
operator|=
name|tmp
expr_stmt|;
name|rendering_pipe_num
operator|=
literal|1
operator|<<
name|tiling_pipe_num
expr_stmt|;
name|req_rb_num
operator|=
name|total_max_rb_num
operator|-
name|r600_count_pipe_bits
argument_list|(
name|disabled_rb_mask
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|rendering_pipe_num
operator|>=
name|req_rb_num
argument_list|,
operator|(
literal|"rendering_pipe_num< req_rb_num"
operator|)
argument_list|)
expr_stmt|;
name|pipe_rb_ratio
operator|=
name|rendering_pipe_num
operator|/
name|req_rb_num
expr_stmt|;
name|pipe_rb_remain
operator|=
name|rendering_pipe_num
operator|-
name|pipe_rb_ratio
operator|*
name|req_rb_num
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RV740
condition|)
block|{
comment|/* r6xx/r7xx */
name|rb_num_width
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
comment|/* eg+ */
name|rb_num_width
operator|=
literal|4
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_rb_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|disabled_rb_mask
operator|)
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|pipe_rb_ratio
condition|;
name|j
operator|++
control|)
block|{
name|data
operator|<<=
name|rb_num_width
expr_stmt|;
name|data
operator||=
name|max_rb_num
operator|-
name|i
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|pipe_rb_remain
condition|)
block|{
name|data
operator|<<=
name|rb_num_width
expr_stmt|;
name|data
operator||=
name|max_rb_num
operator|-
name|i
operator|-
literal|1
expr_stmt|;
name|pipe_rb_remain
operator|--
expr_stmt|;
block|}
block|}
name|mask
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
name|data
return|;
block|}
end_function

begin_function
name|int
name|r600_count_pipe_bits
parameter_list|(
name|uint32_t
name|val
parameter_list|)
block|{
return|return
name|hweight32
argument_list|(
name|val
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tiling_config
decl_stmt|;
name|u32
name|ramcfg
decl_stmt|;
name|u32
name|cc_rb_backend_disable
decl_stmt|;
name|u32
name|cc_gc_shader_pipe_config
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u32
name|sq_config
decl_stmt|;
name|u32
name|sq_gpr_resource_mgmt_1
init|=
literal|0
decl_stmt|;
name|u32
name|sq_gpr_resource_mgmt_2
init|=
literal|0
decl_stmt|;
name|u32
name|sq_thread_resource_mgmt
init|=
literal|0
decl_stmt|;
name|u32
name|sq_stack_resource_mgmt_1
init|=
literal|0
decl_stmt|;
name|u32
name|sq_stack_resource_mgmt_2
init|=
literal|0
decl_stmt|;
name|u32
name|disabled_rb_mask
decl_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|tiling_group_size
operator|=
literal|256
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_R600
case|:
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_tile_pipes
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_simds
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_backends
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_threads
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_stack_entries
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_gs_threads
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_smx_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|CHIP_RV630
case|:
case|case
name|CHIP_RV635
case|:
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_tile_pipes
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_simds
operator|=
literal|3
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_backends
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_gprs
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_threads
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_stack_entries
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_gs_threads
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_smx_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|CHIP_RV610
case|:
case|case
name|CHIP_RV620
case|:
case|case
name|CHIP_RS780
case|:
case|case
name|CHIP_RS880
case|:
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_pipes
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_tile_pipes
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_simds
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_backends
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_gprs
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_threads
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_stack_entries
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_hw_contexts
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_gs_threads
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_smx_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sq_num_cf_insts
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CHIP_RV670
case|:
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_simds
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_backends
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_gprs
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_threads
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_stack_entries
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_gs_threads
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sx_max_export_smx_size
operator|=
literal|128
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* Initialize HDP */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
operator|,
name|j
operator|+=
literal|0x18
control|)
block|{
name|WREG32
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|GRBM_CNTL
argument_list|,
name|GRBM_READ_TIMEOUT
argument_list|(
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup tiling */
name|tiling_config
operator|=
literal|0
expr_stmt|;
name|ramcfg
operator|=
name|RREG32
argument_list|(
name|RAMCFG
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_tile_pipes
condition|)
block|{
case|case
literal|1
case|:
name|tiling_config
operator||=
name|PIPE_TILING
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tiling_config
operator||=
name|PIPE_TILING
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|tiling_config
operator||=
name|PIPE_TILING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|tiling_config
operator||=
name|PIPE_TILING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|tiling_npipes
operator|=
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_tile_pipes
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|tiling_nbanks
operator|=
literal|4
operator|<<
operator|(
operator|(
name|ramcfg
operator|&
name|NOOFBANK_MASK
operator|)
operator|>>
name|NOOFBANK_SHIFT
operator|)
expr_stmt|;
name|tiling_config
operator||=
name|BANK_TILING
argument_list|(
operator|(
name|ramcfg
operator|&
name|NOOFBANK_MASK
operator|)
operator|>>
name|NOOFBANK_SHIFT
argument_list|)
expr_stmt|;
name|tiling_config
operator||=
name|GROUP_SIZE
argument_list|(
operator|(
name|ramcfg
operator|&
name|BURSTLENGTH_MASK
operator|)
operator|>>
name|BURSTLENGTH_SHIFT
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|ramcfg
operator|&
name|NOOFROWS_MASK
operator|)
operator|>>
name|NOOFROWS_SHIFT
expr_stmt|;
if|if
condition|(
name|tmp
operator|>
literal|3
condition|)
block|{
name|tiling_config
operator||=
name|ROW_TILING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|tiling_config
operator||=
name|SAMPLE_SPLIT
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tiling_config
operator||=
name|ROW_TILING
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|tiling_config
operator||=
name|SAMPLE_SPLIT
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
name|tiling_config
operator||=
name|BANK_SWAPS
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|cc_rb_backend_disable
operator|=
name|RREG32
argument_list|(
name|CC_RB_BACKEND_DISABLE
argument_list|)
operator|&
literal|0x00ff0000
expr_stmt|;
name|tmp
operator|=
name|R6XX_MAX_BACKENDS
operator|-
name|r600_count_pipe_bits
argument_list|(
operator|(
name|cc_rb_backend_disable
operator|>>
literal|16
operator|)
operator|&
name|R6XX_MAX_BACKENDS_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_backends
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_backends
operator|=
name|tmp
expr_stmt|;
block|}
name|cc_gc_shader_pipe_config
operator|=
name|RREG32
argument_list|(
name|CC_GC_SHADER_PIPE_CONFIG
argument_list|)
operator|&
literal|0x00ffff00
expr_stmt|;
name|tmp
operator|=
name|R6XX_MAX_PIPES
operator|-
name|r600_count_pipe_bits
argument_list|(
operator|(
name|cc_gc_shader_pipe_config
operator|>>
literal|8
operator|)
operator|&
name|R6XX_MAX_PIPES_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_pipes
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_pipes
operator|=
name|tmp
expr_stmt|;
block|}
name|tmp
operator|=
name|R6XX_MAX_SIMDS
operator|-
name|r600_count_pipe_bits
argument_list|(
operator|(
name|cc_gc_shader_pipe_config
operator|>>
literal|16
operator|)
operator|&
name|R6XX_MAX_SIMDS_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_simds
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_simds
operator|=
name|tmp
expr_stmt|;
block|}
name|disabled_rb_mask
operator|=
operator|(
name|RREG32
argument_list|(
name|CC_RB_BACKEND_DISABLE
argument_list|)
operator|>>
literal|16
operator|)
operator|&
name|R6XX_MAX_BACKENDS_MASK
expr_stmt|;
name|tmp
operator|=
operator|(
name|tiling_config
operator|&
name|PIPE_TILING__MASK
operator|)
operator|>>
name|PIPE_TILING__SHIFT
expr_stmt|;
name|tmp
operator|=
name|r6xx_remap_render_backend
argument_list|(
name|rdev
argument_list|,
name|tmp
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_backends
argument_list|,
name|R6XX_MAX_BACKENDS
argument_list|,
name|disabled_rb_mask
argument_list|)
expr_stmt|;
name|tiling_config
operator||=
name|tmp
operator|<<
literal|16
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|backend_map
operator|=
name|tmp
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|tile_config
operator|=
name|tiling_config
expr_stmt|;
name|WREG32
argument_list|(
name|GB_TILING_CONFIG
argument_list|,
name|tiling_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DCP_TILING_CONFIG
argument_list|,
name|tiling_config
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_TILING_CONFIG
argument_list|,
name|tiling_config
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_TILING_CONFIG
argument_list|,
name|tiling_config
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|R6XX_MAX_PIPES
operator|-
name|r600_count_pipe_bits
argument_list|(
operator|(
name|cc_gc_shader_pipe_config
operator|&
name|INACTIVE_QD_PIPES_MASK
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_OUT_DEALLOC_CNTL
argument_list|,
operator|(
name|tmp
operator|*
literal|4
operator|)
operator|&
name|DEALLOC_DIST_MASK
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_VERTEX_REUSE_BLOCK_CNTL
argument_list|,
operator|(
operator|(
name|tmp
operator|*
literal|4
operator|)
operator|-
literal|2
operator|)
operator|&
name|VTX_REUSE_DEPTH_MASK
argument_list|)
expr_stmt|;
comment|/* Setup some CP states */
name|WREG32
argument_list|(
name|CP_QUEUE_THRESHOLDS
argument_list|,
operator|(
name|ROQ_IB1_START
argument_list|(
literal|0x16
argument_list|)
operator||
name|ROQ_IB2_START
argument_list|(
literal|0x2b
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_MEQ_THRESHOLDS
argument_list|,
operator|(
name|MEQ_END
argument_list|(
literal|0x40
argument_list|)
operator||
name|ROQ_END
argument_list|(
literal|0x40
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|TA_CNTL_AUX
argument_list|,
operator|(
name|DISABLE_CUBE_ANISO
operator||
name|SYNC_GRADIENT
operator||
name|SYNC_WALKER
operator||
name|SYNC_ALIGNER
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup various GPU states */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV670
condition|)
name|WREG32
argument_list|(
name|ARB_GDEC_RD_CNTL
argument_list|,
literal|0x00000021
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|SX_DEBUG_1
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|SMX_EVENT_RELEASE
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|>
name|CHIP_R600
operator|)
condition|)
name|tmp
operator||=
name|ENABLE_NEW_SMX_ADDRESS
expr_stmt|;
name|WREG32
argument_list|(
name|SX_DEBUG_1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_R600
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV630
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV610
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RS780
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RS880
operator|)
condition|)
block|{
name|WREG32
argument_list|(
name|DB_DEBUG
argument_list|,
name|PREZ_MUST_WAIT_FOR_POSTZ_DONE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|DB_DEBUG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|DB_WATERMARKS
argument_list|,
operator|(
name|DEPTH_FREE
argument_list|(
literal|4
argument_list|)
operator||
name|DEPTH_CACHELINE_FREE
argument_list|(
literal|16
argument_list|)
operator||
name|DEPTH_FLUSH
argument_list|(
literal|16
argument_list|)
operator||
name|DEPTH_PENDING_FREE
argument_list|(
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_MULTI_CHIP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_NUM_INSTANCES
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_CONFIG_CNTL
argument_list|,
name|GPR_WRITE_PRIORITY
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_CONFIG_CNTL_1
argument_list|,
name|VTX_DONE_DELAY
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|SQ_MS_FIFO_SIZES
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV610
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RS780
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RS880
operator|)
condition|)
block|{
name|tmp
operator|=
operator|(
name|CACHE_FIFO_SIZE
argument_list|(
literal|0xa
argument_list|)
operator||
name|FETCH_FIFO_HIWATER
argument_list|(
literal|0xa
argument_list|)
operator||
name|DONE_FIFO_HIWATER
argument_list|(
literal|0xe0
argument_list|)
operator||
name|ALU_UPDATE_FIFO_HIWATER
argument_list|(
literal|0x8
argument_list|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_R600
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV630
operator|)
condition|)
block|{
name|tmp
operator|&=
operator|~
name|DONE_FIFO_HIWATER
argument_list|(
literal|0xff
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DONE_FIFO_HIWATER
argument_list|(
literal|0x4
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|SQ_MS_FIFO_SIZES
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* SQ_CONFIG, SQ_GPR_RESOURCE_MGMT, SQ_THREAD_RESOURCE_MGMT, SQ_STACK_RESOURCE_MGMT 	 * should be adjusted as needed by the 2D/3D drivers.  This just sets default values 	 */
name|sq_config
operator|=
name|RREG32
argument_list|(
name|SQ_CONFIG
argument_list|)
expr_stmt|;
name|sq_config
operator|&=
operator|~
operator|(
name|PS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|VS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|GS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|ES_PRIO
argument_list|(
literal|3
argument_list|)
operator|)
expr_stmt|;
name|sq_config
operator||=
operator|(
name|DX9_CONSTS
operator||
name|VC_ENABLE
operator||
name|PS_PRIO
argument_list|(
literal|0
argument_list|)
operator||
name|VS_PRIO
argument_list|(
literal|1
argument_list|)
operator||
name|GS_PRIO
argument_list|(
literal|2
argument_list|)
operator||
name|ES_PRIO
argument_list|(
literal|3
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_R600
condition|)
block|{
name|sq_gpr_resource_mgmt_1
operator|=
operator|(
name|NUM_PS_GPRS
argument_list|(
literal|124
argument_list|)
operator||
name|NUM_VS_GPRS
argument_list|(
literal|124
argument_list|)
operator||
name|NUM_CLAUSE_TEMP_GPRS
argument_list|(
literal|4
argument_list|)
operator|)
expr_stmt|;
name|sq_gpr_resource_mgmt_2
operator|=
operator|(
name|NUM_GS_GPRS
argument_list|(
literal|0
argument_list|)
operator||
name|NUM_ES_GPRS
argument_list|(
literal|0
argument_list|)
operator|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator|=
operator|(
name|NUM_PS_THREADS
argument_list|(
literal|136
argument_list|)
operator||
name|NUM_VS_THREADS
argument_list|(
literal|48
argument_list|)
operator||
name|NUM_GS_THREADS
argument_list|(
literal|4
argument_list|)
operator||
name|NUM_ES_THREADS
argument_list|(
literal|4
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_1
operator|=
operator|(
name|NUM_PS_STACK_ENTRIES
argument_list|(
literal|128
argument_list|)
operator||
name|NUM_VS_STACK_ENTRIES
argument_list|(
literal|128
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_2
operator|=
operator|(
name|NUM_GS_STACK_ENTRIES
argument_list|(
literal|0
argument_list|)
operator||
name|NUM_ES_STACK_ENTRIES
argument_list|(
literal|0
argument_list|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV610
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RS780
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RS880
operator|)
condition|)
block|{
comment|/* no vertex cache */
name|sq_config
operator|&=
operator|~
name|VC_ENABLE
expr_stmt|;
name|sq_gpr_resource_mgmt_1
operator|=
operator|(
name|NUM_PS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|NUM_VS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|NUM_CLAUSE_TEMP_GPRS
argument_list|(
literal|2
argument_list|)
operator|)
expr_stmt|;
name|sq_gpr_resource_mgmt_2
operator|=
operator|(
name|NUM_GS_GPRS
argument_list|(
literal|17
argument_list|)
operator||
name|NUM_ES_GPRS
argument_list|(
literal|17
argument_list|)
operator|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator|=
operator|(
name|NUM_PS_THREADS
argument_list|(
literal|79
argument_list|)
operator||
name|NUM_VS_THREADS
argument_list|(
literal|78
argument_list|)
operator||
name|NUM_GS_THREADS
argument_list|(
literal|4
argument_list|)
operator||
name|NUM_ES_THREADS
argument_list|(
literal|31
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_1
operator|=
operator|(
name|NUM_PS_STACK_ENTRIES
argument_list|(
literal|40
argument_list|)
operator||
name|NUM_VS_STACK_ENTRIES
argument_list|(
literal|40
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_2
operator|=
operator|(
name|NUM_GS_STACK_ENTRIES
argument_list|(
literal|32
argument_list|)
operator||
name|NUM_ES_STACK_ENTRIES
argument_list|(
literal|16
argument_list|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV630
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV635
operator|)
condition|)
block|{
name|sq_gpr_resource_mgmt_1
operator|=
operator|(
name|NUM_PS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|NUM_VS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|NUM_CLAUSE_TEMP_GPRS
argument_list|(
literal|2
argument_list|)
operator|)
expr_stmt|;
name|sq_gpr_resource_mgmt_2
operator|=
operator|(
name|NUM_GS_GPRS
argument_list|(
literal|18
argument_list|)
operator||
name|NUM_ES_GPRS
argument_list|(
literal|18
argument_list|)
operator|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator|=
operator|(
name|NUM_PS_THREADS
argument_list|(
literal|79
argument_list|)
operator||
name|NUM_VS_THREADS
argument_list|(
literal|78
argument_list|)
operator||
name|NUM_GS_THREADS
argument_list|(
literal|4
argument_list|)
operator||
name|NUM_ES_THREADS
argument_list|(
literal|31
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_1
operator|=
operator|(
name|NUM_PS_STACK_ENTRIES
argument_list|(
literal|40
argument_list|)
operator||
name|NUM_VS_STACK_ENTRIES
argument_list|(
literal|40
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_2
operator|=
operator|(
name|NUM_GS_STACK_ENTRIES
argument_list|(
literal|32
argument_list|)
operator||
name|NUM_ES_STACK_ENTRIES
argument_list|(
literal|16
argument_list|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV670
condition|)
block|{
name|sq_gpr_resource_mgmt_1
operator|=
operator|(
name|NUM_PS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|NUM_VS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|NUM_CLAUSE_TEMP_GPRS
argument_list|(
literal|2
argument_list|)
operator|)
expr_stmt|;
name|sq_gpr_resource_mgmt_2
operator|=
operator|(
name|NUM_GS_GPRS
argument_list|(
literal|17
argument_list|)
operator||
name|NUM_ES_GPRS
argument_list|(
literal|17
argument_list|)
operator|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator|=
operator|(
name|NUM_PS_THREADS
argument_list|(
literal|79
argument_list|)
operator||
name|NUM_VS_THREADS
argument_list|(
literal|78
argument_list|)
operator||
name|NUM_GS_THREADS
argument_list|(
literal|4
argument_list|)
operator||
name|NUM_ES_THREADS
argument_list|(
literal|31
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_1
operator|=
operator|(
name|NUM_PS_STACK_ENTRIES
argument_list|(
literal|64
argument_list|)
operator||
name|NUM_VS_STACK_ENTRIES
argument_list|(
literal|64
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_2
operator|=
operator|(
name|NUM_GS_STACK_ENTRIES
argument_list|(
literal|64
argument_list|)
operator||
name|NUM_ES_STACK_ENTRIES
argument_list|(
literal|64
argument_list|)
operator|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|SQ_CONFIG
argument_list|,
name|sq_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_GPR_RESOURCE_MGMT_1
argument_list|,
name|sq_gpr_resource_mgmt_1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_GPR_RESOURCE_MGMT_2
argument_list|,
name|sq_gpr_resource_mgmt_2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_THREAD_RESOURCE_MGMT
argument_list|,
name|sq_thread_resource_mgmt
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_STACK_RESOURCE_MGMT_1
argument_list|,
name|sq_stack_resource_mgmt_1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_STACK_RESOURCE_MGMT_2
argument_list|,
name|sq_stack_resource_mgmt_2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV610
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RS780
operator|)
operator|||
operator|(
operator|(
name|rdev
operator|->
name|family
operator|)
operator|==
name|CHIP_RS880
operator|)
condition|)
block|{
name|WREG32
argument_list|(
name|VGT_CACHE_INVALIDATION
argument_list|,
name|CACHE_INVALIDATION
argument_list|(
name|TC_ONLY
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|VGT_CACHE_INVALIDATION
argument_list|,
name|CACHE_INVALIDATION
argument_list|(
name|VC_AND_TC
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* More default values. 2D/3D driver should adjust as needed */
name|WREG32
argument_list|(
name|PA_SC_AA_SAMPLE_LOCS_2S
argument_list|,
operator|(
name|S0_X
argument_list|(
literal|0xc
argument_list|)
operator||
name|S0_Y
argument_list|(
literal|0x4
argument_list|)
operator||
name|S1_X
argument_list|(
literal|0x4
argument_list|)
operator||
name|S1_Y
argument_list|(
literal|0xc
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_AA_SAMPLE_LOCS_4S
argument_list|,
operator|(
name|S0_X
argument_list|(
literal|0xe
argument_list|)
operator||
name|S0_Y
argument_list|(
literal|0xe
argument_list|)
operator||
name|S1_X
argument_list|(
literal|0x2
argument_list|)
operator||
name|S1_Y
argument_list|(
literal|0x2
argument_list|)
operator||
name|S2_X
argument_list|(
literal|0xa
argument_list|)
operator||
name|S2_Y
argument_list|(
literal|0x6
argument_list|)
operator||
name|S3_X
argument_list|(
literal|0x6
argument_list|)
operator||
name|S3_Y
argument_list|(
literal|0xa
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_AA_SAMPLE_LOCS_8S_WD0
argument_list|,
operator|(
name|S0_X
argument_list|(
literal|0xe
argument_list|)
operator||
name|S0_Y
argument_list|(
literal|0xb
argument_list|)
operator||
name|S1_X
argument_list|(
literal|0x4
argument_list|)
operator||
name|S1_Y
argument_list|(
literal|0xc
argument_list|)
operator||
name|S2_X
argument_list|(
literal|0x1
argument_list|)
operator||
name|S2_Y
argument_list|(
literal|0x6
argument_list|)
operator||
name|S3_X
argument_list|(
literal|0xa
argument_list|)
operator||
name|S3_Y
argument_list|(
literal|0xe
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_AA_SAMPLE_LOCS_8S_WD1
argument_list|,
operator|(
name|S4_X
argument_list|(
literal|0x6
argument_list|)
operator||
name|S4_Y
argument_list|(
literal|0x1
argument_list|)
operator||
name|S5_X
argument_list|(
literal|0x0
argument_list|)
operator||
name|S5_Y
argument_list|(
literal|0x0
argument_list|)
operator||
name|S6_X
argument_list|(
literal|0xb
argument_list|)
operator||
name|S6_Y
argument_list|(
literal|0x4
argument_list|)
operator||
name|S7_X
argument_list|(
literal|0x7
argument_list|)
operator||
name|S7_Y
argument_list|(
literal|0x8
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_STRMOUT_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_pipes
operator|*
literal|16
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_RV610
case|:
case|case
name|CHIP_RV620
case|:
case|case
name|CHIP_RS780
case|:
case|case
name|CHIP_RS880
case|:
name|tmp
operator|+=
literal|32
expr_stmt|;
break|break;
case|case
name|CHIP_RV670
case|:
name|tmp
operator|+=
literal|128
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|tmp
operator|>
literal|256
condition|)
block|{
name|tmp
operator|=
literal|256
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|VGT_ES_PER_GS
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_GS_PER_ES
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_GS_PER_VS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_GS_VERTEX_REUSE
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* more default values. 2D/3D driver should adjust as needed */
name|WREG32
argument_list|(
name|PA_SC_LINE_STIPPLE_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_STRMOUT_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SX_MISC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_MODE_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_AA_CONFIG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_LINE_STIPPLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_INPUT_Z
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_PS_IN_CONTROL_0
argument_list|,
name|NUM_INTERP
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR7_FRAG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Clear render buffer base addresses */
name|WREG32
argument_list|(
name|CB_COLOR0_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR1_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR2_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR3_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR4_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR5_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR6_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR7_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_COLOR7_FRAG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_RV610
case|:
case|case
name|CHIP_RV620
case|:
case|case
name|CHIP_RS780
case|:
case|case
name|CHIP_RS880
case|:
name|tmp
operator|=
name|TC_L2_SIZE
argument_list|(
literal|8
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHIP_RV630
case|:
case|case
name|CHIP_RV635
case|:
name|tmp
operator|=
name|TC_L2_SIZE
argument_list|(
literal|4
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHIP_R600
case|:
name|tmp
operator|=
name|TC_L2_SIZE
argument_list|(
literal|0
argument_list|)
operator||
name|L2_DISABLE_LATE_HIT
expr_stmt|;
break|break;
default|default:
name|tmp
operator|=
name|TC_L2_SIZE
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|WREG32
argument_list|(
name|TC_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|HDP_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_HOST_PATH_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|ARB_POP
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|ENABLE_TC128
expr_stmt|;
name|WREG32
argument_list|(
name|ARB_POP
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_MULTI_CHIP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_CL_ENHANCE
argument_list|,
operator|(
name|CLIP_VTX_REORDER_ENA
operator||
name|NUM_CLIP_SEQ
argument_list|(
literal|3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_ENHANCE
argument_list|,
name|FORCE_EOV_MAX_CLK_CNT
argument_list|(
literal|4095
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VC_ENHANCE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Indirect registers accessor  */
end_comment

begin_function
name|u32
name|r600_pciep_rreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|reg
parameter_list|)
block|{
name|u32
name|r
decl_stmt|;
name|WREG32
argument_list|(
name|PCIE_PORT_INDEX
argument_list|,
operator|(
operator|(
name|reg
operator|)
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|PCIE_PORT_INDEX
argument_list|)
expr_stmt|;
name|r
operator|=
name|RREG32
argument_list|(
name|PCIE_PORT_DATA
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|r600_pciep_wreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u32
name|v
parameter_list|)
block|{
name|WREG32
argument_list|(
name|PCIE_PORT_INDEX
argument_list|,
operator|(
operator|(
name|reg
operator|)
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|PCIE_PORT_INDEX
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PCIE_PORT_DATA
argument_list|,
operator|(
name|v
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|PCIE_PORT_DATA
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * CP& Ring  */
end_comment

begin_function
name|void
name|r600_cp_stop
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|radeon_ttm_set_active_vram_size
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0086D8_CP_ME_CNTL
argument_list|,
name|S_0086D8_CP_ME_HALT
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_init_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|chip_name
decl_stmt|;
specifier|const
name|char
modifier|*
name|rlc_chip_name
decl_stmt|;
name|size_t
name|pfp_req_size
decl_stmt|,
name|me_req_size
decl_stmt|,
name|rlc_req_size
decl_stmt|;
name|char
name|fw_name
index|[
literal|30
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_R600
case|:
name|chip_name
operator|=
literal|"R600"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"R600"
expr_stmt|;
break|break;
case|case
name|CHIP_RV610
case|:
name|chip_name
operator|=
literal|"RV610"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"R600"
expr_stmt|;
break|break;
case|case
name|CHIP_RV630
case|:
name|chip_name
operator|=
literal|"RV630"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"R600"
expr_stmt|;
break|break;
case|case
name|CHIP_RV620
case|:
name|chip_name
operator|=
literal|"RV620"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"R600"
expr_stmt|;
break|break;
case|case
name|CHIP_RV635
case|:
name|chip_name
operator|=
literal|"RV635"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"R600"
expr_stmt|;
break|break;
case|case
name|CHIP_RV670
case|:
name|chip_name
operator|=
literal|"RV670"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"R600"
expr_stmt|;
break|break;
case|case
name|CHIP_RS780
case|:
case|case
name|CHIP_RS880
case|:
name|chip_name
operator|=
literal|"RS780"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"R600"
expr_stmt|;
break|break;
case|case
name|CHIP_RV770
case|:
name|chip_name
operator|=
literal|"RV770"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"R700"
expr_stmt|;
break|break;
case|case
name|CHIP_RV730
case|:
case|case
name|CHIP_RV740
case|:
name|chip_name
operator|=
literal|"RV730"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"R700"
expr_stmt|;
break|break;
case|case
name|CHIP_RV710
case|:
name|chip_name
operator|=
literal|"RV710"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"R700"
expr_stmt|;
break|break;
case|case
name|CHIP_CEDAR
case|:
name|chip_name
operator|=
literal|"CEDAR"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"CEDAR"
expr_stmt|;
break|break;
case|case
name|CHIP_REDWOOD
case|:
name|chip_name
operator|=
literal|"REDWOOD"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"REDWOOD"
expr_stmt|;
break|break;
case|case
name|CHIP_JUNIPER
case|:
name|chip_name
operator|=
literal|"JUNIPER"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"JUNIPER"
expr_stmt|;
break|break;
case|case
name|CHIP_CYPRESS
case|:
case|case
name|CHIP_HEMLOCK
case|:
name|chip_name
operator|=
literal|"CYPRESS"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"CYPRESS"
expr_stmt|;
break|break;
case|case
name|CHIP_PALM
case|:
name|chip_name
operator|=
literal|"PALM"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"SUMO"
expr_stmt|;
break|break;
case|case
name|CHIP_SUMO
case|:
name|chip_name
operator|=
literal|"SUMO"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"SUMO"
expr_stmt|;
break|break;
case|case
name|CHIP_SUMO2
case|:
name|chip_name
operator|=
literal|"SUMO2"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"SUMO"
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: Unsupported family %d"
argument_list|,
name|__func__
argument_list|,
name|rdev
operator|->
name|family
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CEDAR
condition|)
block|{
name|pfp_req_size
operator|=
name|EVERGREEN_PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|EVERGREEN_PM4_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|rlc_req_size
operator|=
name|EVERGREEN_RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
block|{
name|pfp_req_size
operator|=
name|R700_PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|R700_PM4_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|rlc_req_size
operator|=
name|R700_RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
block|}
else|else
block|{
name|pfp_req_size
operator|=
name|PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|PM4_UCODE_SIZE
operator|*
literal|12
expr_stmt|;
name|rlc_req_size
operator|=
name|RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
block|}
name|DRM_INFO
argument_list|(
literal|"Loading %s Microcode\n"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_pfp"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pfp_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|->
name|datasize
operator|!=
name|pfp_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r600_cp: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|pfp_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_me"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|->
name|datasize
operator|!=
name|me_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r600_cp: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|me_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_rlc"
argument_list|,
name|rlc_chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|->
name|datasize
operator|!=
name|rlc_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r600_rlc: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|rlc_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|out
label|:
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|!=
operator|-
name|EINVAL
condition|)
name|DRM_ERROR
argument_list|(
literal|"r600_cp: Failed to load firmware \"%s\"\n"
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|pfp_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pfp_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|me_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|rlc_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc_fw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/**  * r600_fini_microcode - drop the firmwares image references  *  * @rdev: radeon_device pointer  *  * Drop the pfp, me and rlc firmwares image references.  * Called at driver shutdown.  */
end_comment

begin_function
name|void
name|r600_fini_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|pfp_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pfp_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|me_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|rlc_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc_fw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|r600_cp_load_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|__be32
modifier|*
name|fw_data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
condition|)
return|return
operator|-
name|EINVAL
return|;
name|r600_cp_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_CNTL
argument_list|,
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|BUF_SWAP_32BIT
operator||
endif|#
directive|endif
name|RB_NO_UPDATE
operator||
name|RB_BLKSZ
argument_list|(
literal|15
argument_list|)
operator||
name|RB_BUFSZ
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Reset cp */
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
name|SOFT_RESET_CP
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|mdelay
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|me_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PM4_UCODE_SIZE
operator|*
literal|3
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_ME_RAM_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|pfp_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PFP_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_PFP_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_RADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r600_cp_start
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|int
name|r
decl_stmt|;
name|uint32_t
name|cp_me
decl_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to lock ring (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_ME_INITIALIZE
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
block|{
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|rv770
operator|.
name|max_hw_contexts
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|r600
operator|.
name|max_hw_contexts
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_ME_INITIALIZE_DEVICE_ID
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|cp_me
operator|=
literal|0xff
expr_stmt|;
name|WREG32
argument_list|(
name|R_0086D8_CP_ME_CNTL
argument_list|,
name|cp_me
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r600_cp_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|u32
name|rb_bufsz
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* Reset cp */
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
name|SOFT_RESET_CP
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|mdelay
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set ring buffer size */
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|ring
operator|->
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|drm_order
argument_list|(
name|RADEON_GPU_PAGE_SIZE
operator|/
literal|8
argument_list|)
operator|<<
literal|8
operator|)
operator||
name|rb_bufsz
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|tmp
operator||=
name|BUF_SWAP_32BIT
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|CP_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_SEM_WAIT_TIMER
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* Set the write pointer delay */
name|WREG32
argument_list|(
name|CP_RB_WPTR_DELAY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Initialize the ring buffer's read and write pointers */
name|WREG32
argument_list|(
name|CP_RB_CNTL
argument_list|,
name|tmp
operator||
name|RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_RPTR_WR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ring
operator|->
name|wptr
operator|=
literal|0
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_WPTR
argument_list|,
name|ring
operator|->
name|wptr
argument_list|)
expr_stmt|;
comment|/* set the wb address whether it's enabled or not */
name|WREG32
argument_list|(
name|CP_RB_RPTR_ADDR
argument_list|,
operator|(
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP_RPTR_OFFSET
operator|)
operator|&
literal|0xFFFFFFFC
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_RPTR_ADDR_HI
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP_RPTR_OFFSET
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_ADDR
argument_list|,
operator|(
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_SCRATCH_OFFSET
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
else|else
block|{
name|tmp
operator||=
name|RB_NO_UPDATE
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|mdelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_RB_BASE
argument_list|,
name|ring
operator|->
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_DEBUG
argument_list|,
operator|(
literal|1
operator|<<
literal|27
operator|)
operator||
operator|(
literal|1
operator|<<
literal|28
operator|)
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr
operator|=
name|RREG32
argument_list|(
name|CP_RB_RPTR
argument_list|)
expr_stmt|;
name|r600_cp_start
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|ring
operator|->
name|ready
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|radeon_ring_test
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|,
name|ring
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|ring
operator|->
name|ready
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r600_ring_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|,
name|unsigned
name|ring_size
parameter_list|)
block|{
name|u32
name|rb_bufsz
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* Align ring size */
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|ring_size
operator|=
operator|(
literal|1
operator|<<
operator|(
name|rb_bufsz
operator|+
literal|1
operator|)
operator|)
operator|*
literal|4
expr_stmt|;
name|ring
operator|->
name|ring_size
operator|=
name|ring_size
expr_stmt|;
name|ring
operator|->
name|align_mask
operator|=
literal|16
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|radeon_ring_supports_scratch_reg
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
condition|)
block|{
name|r
operator|=
name|radeon_scratch_get
argument_list|(
name|rdev
argument_list|,
operator|&
name|ring
operator|->
name|rptr_save_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to get scratch reg for rptr save (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr_save_reg
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|r600_cp_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|r600_cp_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ring_fini
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|ring
operator|->
name|rptr_save_reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * DMA  * Starting with R600, the GPU has an asynchronous  * DMA engine.  The programming model is very similar  * to the 3D engine (ring buffer, IBs, etc.), but the  * DMA controller has it's own packet format that is  * different form the PM4 format used by the 3D engine.  * It supports copying data, writing embedded data,  * solid fills, and a number of other things.  It also  * has support for tiling/detiling of buffers.  */
end_comment

begin_comment
comment|/**  * r600_dma_stop - stop the async dma engine  *  * @rdev: radeon_device pointer  *  * Stop the async dma engine (r6xx-evergreen).  */
end_comment

begin_function
name|void
name|r600_dma_stop
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|rb_cntl
init|=
name|RREG32
argument_list|(
name|DMA_RB_CNTL
argument_list|)
decl_stmt|;
name|radeon_ttm_set_active_vram_size
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
argument_list|)
expr_stmt|;
name|rb_cntl
operator|&=
operator|~
name|DMA_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
argument_list|,
name|rb_cntl
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * r600_dma_resume - setup and start the async dma engine  *  * @rdev: radeon_device pointer  *  * Set up the DMA ring buffer and enable it. (r6xx-evergreen).  * Returns 0 for success, error for failure.  */
end_comment

begin_function
name|int
name|r600_dma_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
decl_stmt|;
name|u32
name|rb_cntl
decl_stmt|,
name|dma_cntl
decl_stmt|,
name|ib_cntl
decl_stmt|;
name|u32
name|rb_bufsz
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* Reset dma */
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
name|RV770_SOFT_RESET_DMA
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
name|SOFT_RESET_DMA
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|udelay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_SEM_INCOMPLETE_TIMER_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_SEM_WAIT_FAIL_TIMER_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set ring buffer size in dwords */
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|ring
operator|->
name|ring_size
operator|/
literal|4
argument_list|)
expr_stmt|;
name|rb_cntl
operator|=
name|rb_bufsz
operator|<<
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|rb_cntl
operator||=
name|DMA_RB_SWAP_ENABLE
operator||
name|DMA_RPTR_WRITEBACK_SWAP_ENABLE
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|DMA_RB_CNTL
argument_list|,
name|rb_cntl
argument_list|)
expr_stmt|;
comment|/* Initialize the ring buffer's read and write pointers */
name|WREG32
argument_list|(
name|DMA_RB_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set the wb address whether it's enabled or not */
name|WREG32
argument_list|(
name|DMA_RB_RPTR_ADDR_HI
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|R600_WB_DMA_RPTR_OFFSET
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_RPTR_ADDR_LO
argument_list|,
operator|(
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|R600_WB_DMA_RPTR_OFFSET
operator|)
operator|&
literal|0xFFFFFFFC
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|rb_cntl
operator||=
name|DMA_RPTR_WRITEBACK_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_BASE
argument_list|,
name|ring
operator|->
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* enable DMA IBs */
name|ib_cntl
operator|=
name|DMA_IB_ENABLE
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|ib_cntl
operator||=
name|DMA_IB_SWAP_ENABLE
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|DMA_IB_CNTL
argument_list|,
name|ib_cntl
argument_list|)
expr_stmt|;
name|dma_cntl
operator|=
name|RREG32
argument_list|(
name|DMA_CNTL
argument_list|)
expr_stmt|;
name|dma_cntl
operator|&=
operator|~
name|CTXEMPTY_INT_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_CNTL
argument_list|,
name|dma_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
name|WREG32
argument_list|(
name|DMA_MODE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ring
operator|->
name|wptr
operator|=
literal|0
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_WPTR
argument_list|,
name|ring
operator|->
name|wptr
operator|<<
literal|2
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr
operator|=
name|RREG32
argument_list|(
name|DMA_RB_RPTR
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
argument_list|,
name|rb_cntl
operator||
name|DMA_RB_ENABLE
argument_list|)
expr_stmt|;
name|ring
operator|->
name|ready
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|radeon_ring_test
argument_list|(
name|rdev
argument_list|,
name|R600_RING_TYPE_DMA_INDEX
argument_list|,
name|ring
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|ring
operator|->
name|ready
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ttm_set_active_vram_size
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * r600_dma_fini - tear down the async dma engine  *  * @rdev: radeon_device pointer  *  * Stop the async dma engine and free the ring (r6xx-evergreen).  */
end_comment

begin_function
name|void
name|r600_dma_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_dma_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ring_fini
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * GPU scratch registers helpers function.  */
end_comment

begin_function
name|void
name|r600_scratch_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|rdev
operator|->
name|scratch
operator|.
name|num_reg
operator|=
literal|7
expr_stmt|;
name|rdev
operator|->
name|scratch
operator|.
name|reg_base
operator|=
name|SCRATCH_REG0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|scratch
operator|.
name|num_reg
condition|;
name|i
operator|++
control|)
block|{
name|rdev
operator|->
name|scratch
operator|.
name|free
index|[
name|i
index|]
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|scratch
operator|.
name|reg
index|[
name|i
index|]
operator|=
name|rdev
operator|->
name|scratch
operator|.
name|reg_base
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|r600_ring_test
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|uint32_t
name|scratch
decl_stmt|;
name|uint32_t
name|tmp
init|=
literal|0
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|int
name|r
decl_stmt|;
name|r
operator|=
name|radeon_scratch_get
argument_list|(
name|rdev
argument_list|,
operator|&
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to get scratch reg (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|WREG32
argument_list|(
name|scratch
argument_list|,
literal|0xCAFEDEAD
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to lock ring %d (%d).\n"
argument_list|,
name|ring
operator|->
name|idx
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|scratch
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
name|scratch
operator|-
name|PACKET3_SET_CONFIG_REG_OFFSET
operator|)
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xDEADBEEF
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0xDEADBEEF
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"ring test on %d succeeded in %d usecs\n"
argument_list|,
name|ring
operator|->
name|idx
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: ring %d test failed (scratch(0x%04X)=0x%08X)\n"
argument_list|,
name|ring
operator|->
name|idx
argument_list|,
name|scratch
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|r
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|scratch
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/**  * r600_dma_ring_test - simple async dma engine test  *  * @rdev: radeon_device pointer  * @ring: radeon_ring structure holding ring information  *  * Test the DMA engine by writing using it to write an  * value to memory. (r6xx-SI).  * Returns 0 for success, error for failure.  */
end_comment

begin_function
name|int
name|r600_dma_ring_test
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|int
name|r
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ptr
init|=
name|rdev
operator|->
name|vram_scratch
operator|.
name|ptr
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
operator|!
name|ptr
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"invalid vram scratch pointer\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
literal|0xCAFEDEAD
expr_stmt|;
operator|*
name|ptr
operator|=
name|tmp
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: dma failed to lock ring %d (%d).\n"
argument_list|,
name|ring
operator|->
name|idx
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|rdev
operator|->
name|vram_scratch
operator|.
name|gpu_addr
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|gpu_addr
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xDEADBEEF
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
operator|*
name|ptr
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0xDEADBEEF
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"ring test on %d succeeded in %d usecs\n"
argument_list|,
name|ring
operator|->
name|idx
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: ring %d test failed (0x%08X)\n"
argument_list|,
name|ring
operator|->
name|idx
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|r
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/*  * CP fences/semaphores  */
end_comment

begin_function
name|void
name|r600_fence_ring_emit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_fence
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|fence
operator|->
name|ring
index|]
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|use_event
condition|)
block|{
name|u64
name|addr
init|=
name|rdev
operator|->
name|fence_drv
index|[
name|fence
operator|->
name|ring
index|]
operator|.
name|gpu_addr
decl_stmt|;
comment|/* flush read cache over gart */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SURFACE_SYNC
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_TC_ACTION_ENA
operator||
name|PACKET3_VC_ACTION_ENA
operator||
name|PACKET3_SH_ACTION_ENA
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* poll interval */
comment|/* EVENT_WRITE_EOP - flush caches, send int */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_EVENT_WRITE_EOP
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|EVENT_TYPE
argument_list|(
name|CACHE_FLUSH_AND_INV_EVENT_TS
argument_list|)
operator||
name|EVENT_INDEX
argument_list|(
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|addr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|upper_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xff
operator|)
operator||
name|DATA_SEL
argument_list|(
literal|1
argument_list|)
operator||
name|INT_SEL
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|fence
operator|->
name|seq
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* flush read cache over gart */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SURFACE_SYNC
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_TC_ACTION_ENA
operator||
name|PACKET3_VC_ACTION_ENA
operator||
name|PACKET3_SH_ACTION_ENA
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* poll interval */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_EVENT_WRITE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|EVENT_TYPE
argument_list|(
name|CACHE_FLUSH_AND_INV_EVENT
argument_list|)
operator||
name|EVENT_INDEX
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* wait for 3D idle clean */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|WAIT_UNTIL
operator|-
name|PACKET3_SET_CONFIG_REG_OFFSET
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|WAIT_3D_IDLE_bit
operator||
name|WAIT_3D_IDLECLEAN_bit
argument_list|)
expr_stmt|;
comment|/* Emit fence sequence& fire IRQ */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
name|rdev
operator|->
name|fence_drv
index|[
name|fence
operator|->
name|ring
index|]
operator|.
name|scratch_reg
operator|-
name|PACKET3_SET_CONFIG_REG_OFFSET
operator|)
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|fence
operator|->
name|seq
argument_list|)
expr_stmt|;
comment|/* CP_INTERRUPT packet 3 no longer exists, use packet 0 */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|CP_INT_STATUS
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RB_INT_STAT
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|r600_semaphore_ring_emit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|,
name|struct
name|radeon_semaphore
modifier|*
name|semaphore
parameter_list|,
name|bool
name|emit_wait
parameter_list|)
block|{
name|uint64_t
name|addr
init|=
name|semaphore
operator|->
name|gpu_addr
decl_stmt|;
name|unsigned
name|sel
init|=
name|emit_wait
condition|?
name|PACKET3_SEM_SEL_WAIT
else|:
name|PACKET3_SEM_SEL_SIGNAL
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|<
name|CHIP_CAYMAN
condition|)
name|sel
operator||=
name|PACKET3_SEM_WAIT_ON_SIGNAL
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_MEM_SEMAPHORE
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|addr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|upper_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xff
operator|)
operator||
name|sel
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * DMA fences/semaphores  */
end_comment

begin_comment
comment|/**  * r600_dma_fence_ring_emit - emit a fence on the DMA ring  *  * @rdev: radeon_device pointer  * @fence: radeon fence object  *  * Add a DMA fence packet to the ring to write  * the fence seq number and DMA trap packet to generate  * an interrupt if needed (r6xx-r7xx).  */
end_comment

begin_function
name|void
name|r600_dma_fence_ring_emit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_fence
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|fence
operator|->
name|ring
index|]
decl_stmt|;
name|u64
name|addr
init|=
name|rdev
operator|->
name|fence_drv
index|[
name|fence
operator|->
name|ring
index|]
operator|.
name|gpu_addr
decl_stmt|;
comment|/* write the fence */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_FENCE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|addr
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|upper_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|lower_32_bits
argument_list|(
name|fence
operator|->
name|seq
argument_list|)
argument_list|)
expr_stmt|;
comment|/* generate an interrupt */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_TRAP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * r600_dma_semaphore_ring_emit - emit a semaphore on the dma ring  *  * @rdev: radeon_device pointer  * @ring: radeon_ring structure holding ring information  * @semaphore: radeon semaphore object  * @emit_wait: wait or signal semaphore  *  * Add a DMA semaphore packet to the ring wait on or signal  * other rings (r6xx-SI).  */
end_comment

begin_function
name|void
name|r600_dma_semaphore_ring_emit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|,
name|struct
name|radeon_semaphore
modifier|*
name|semaphore
parameter_list|,
name|bool
name|emit_wait
parameter_list|)
block|{
name|u64
name|addr
init|=
name|semaphore
operator|->
name|gpu_addr
decl_stmt|;
name|u32
name|s
init|=
name|emit_wait
condition|?
literal|0
else|:
literal|1
decl_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_SEMAPHORE
argument_list|,
literal|0
argument_list|,
name|s
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|addr
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_copy_blit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint64_t
name|src_offset
parameter_list|,
name|uint64_t
name|dst_offset
parameter_list|,
name|unsigned
name|num_gpu_pages
parameter_list|,
name|struct
name|radeon_fence
modifier|*
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_semaphore
modifier|*
name|sem
init|=
name|NULL
decl_stmt|;
name|struct
name|radeon_sa_bo
modifier|*
name|vb
init|=
name|NULL
decl_stmt|;
name|int
name|r
decl_stmt|;
name|r
operator|=
name|r600_blit_prepare_copy
argument_list|(
name|rdev
argument_list|,
name|num_gpu_pages
argument_list|,
name|fence
argument_list|,
operator|&
name|vb
argument_list|,
operator|&
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
name|r600_kms_blit_copy
argument_list|(
name|rdev
argument_list|,
name|src_offset
argument_list|,
name|dst_offset
argument_list|,
name|num_gpu_pages
argument_list|,
name|vb
argument_list|)
expr_stmt|;
name|r600_blit_done_copy
argument_list|(
name|rdev
argument_list|,
name|fence
argument_list|,
name|vb
argument_list|,
name|sem
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * r600_copy_dma - copy pages using the DMA engine  *  * @rdev: radeon_device pointer  * @src_offset: src GPU address  * @dst_offset: dst GPU address  * @num_gpu_pages: number of GPU pages to xfer  * @fence: radeon fence object  *  * Copy GPU paging using the DMA engine (r6xx).  * Used by the radeon ttm implementation to move pages if  * registered as the asic copy callback.  */
end_comment

begin_function
name|int
name|r600_copy_dma
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint64_t
name|src_offset
parameter_list|,
name|uint64_t
name|dst_offset
parameter_list|,
name|unsigned
name|num_gpu_pages
parameter_list|,
name|struct
name|radeon_fence
modifier|*
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_semaphore
modifier|*
name|sem
init|=
name|NULL
decl_stmt|;
name|int
name|ring_index
init|=
name|rdev
operator|->
name|asic
operator|->
name|copy
operator|.
name|dma_ring_index
decl_stmt|;
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ring_index
index|]
decl_stmt|;
name|u32
name|size_in_dw
decl_stmt|,
name|cur_size_in_dw
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_loops
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
name|r
operator|=
name|radeon_semaphore_create
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: moving bo (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|size_in_dw
operator|=
operator|(
name|num_gpu_pages
operator|<<
name|RADEON_GPU_PAGE_SHIFT
operator|)
operator|/
literal|4
expr_stmt|;
name|num_loops
operator|=
name|DIV_ROUND_UP
argument_list|(
name|size_in_dw
argument_list|,
literal|0xFFFE
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|num_loops
operator|*
literal|4
operator|+
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: moving bo (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
name|radeon_fence_need_sync
argument_list|(
operator|*
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
condition|)
block|{
name|radeon_semaphore_sync_rings
argument_list|(
name|rdev
argument_list|,
name|sem
argument_list|,
operator|(
operator|*
name|fence
operator|)
operator|->
name|ring
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
name|radeon_fence_note_sync
argument_list|(
operator|*
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_loops
condition|;
name|i
operator|++
control|)
block|{
name|cur_size_in_dw
operator|=
name|size_in_dw
expr_stmt|;
if|if
condition|(
name|cur_size_in_dw
operator|>
literal|0xFFFE
condition|)
name|cur_size_in_dw
operator|=
literal|0xFFFE
expr_stmt|;
name|size_in_dw
operator|-=
name|cur_size_in_dw
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_COPY
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|cur_size_in_dw
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|dst_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|src_offset
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
operator|(
name|upper_32_bits
argument_list|(
name|dst_offset
argument_list|)
operator|&
literal|0xff
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|src_offset
argument_list|)
operator|&
literal|0xff
operator|)
operator|)
argument_list|)
expr_stmt|;
name|src_offset
operator|+=
name|cur_size_in_dw
operator|*
literal|4
expr_stmt|;
name|dst_offset
operator|+=
name|cur_size_in_dw
operator|*
literal|4
expr_stmt|;
block|}
name|r
operator|=
name|radeon_fence_emit
argument_list|(
name|rdev
argument_list|,
name|fence
argument_list|,
name|ring
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_ring_unlock_undo
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|radeon_semaphore_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|sem
argument_list|,
operator|*
name|fence
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|r600_set_surface_reg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|reg
parameter_list|,
name|uint32_t
name|tiling_flags
parameter_list|,
name|uint32_t
name|pitch
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint32_t
name|obj_size
parameter_list|)
block|{
comment|/* FIXME: implement */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r600_clear_surface_reg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
comment|/* FIXME: implement */
block|}
end_function

begin_function
specifier|static
name|int
name|r600_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* enable pcie gen2 link */
name|r600_pcie_gen2_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
operator|||
operator|!
name|rdev
operator|->
name|rlc_fw
condition|)
block|{
name|r
operator|=
name|r600_init_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
name|r
operator|=
name|r600_vram_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r600_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|r600_agp_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|r600_pcie_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
name|r600_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r
operator|=
name|r600_blit_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|r600_blit_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|asic
operator|->
name|copy
operator|.
name|copy
operator|=
name|NULL
expr_stmt|;
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed blitter (%d) falling back to memcpy\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|R600_RING_TYPE_DMA_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing DMA fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|r
operator|=
name|r600_irq_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: IH init failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r600_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|RADEON_WB_CP_RPTR_OFFSET
argument_list|,
name|R600_CP_RB_RPTR
argument_list|,
name|R600_CP_RB_WPTR
argument_list|,
literal|0
argument_list|,
literal|0xfffff
argument_list|,
name|RADEON_CP_PACKET2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|R600_WB_DMA_RPTR_OFFSET
argument_list|,
name|DMA_RB_RPTR
argument_list|,
name|DMA_RB_WPTR
argument_list|,
literal|2
argument_list|,
literal|0x3fffc
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_NOP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|r600_cp_load_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|r600_cp_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|r600_dma_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|r600_audio_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: audio init failed\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r600_vga_set_state
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|bool
name|state
parameter_list|)
block|{
name|uint32_t
name|temp
decl_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|CONFIG_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|false
condition|)
block|{
name|temp
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|0
operator|)
expr_stmt|;
name|temp
operator||=
operator|(
literal|1
operator|<<
literal|1
operator|)
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|1
operator|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|CONFIG_CNTL
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Do not reset GPU before posting, on r600 hw unlike on r500 hw, 	 * posting will perform necessary task to bring back GPU into good 	 * shape. 	 */
comment|/* post card */
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|r600_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"r600 startup failed on resume\n"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|r600_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_audio_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_cp_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_dma_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_irq_suspend
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Plan is to move initialization in that function and use  * helper function so that radeon_device_init pretty much  * do nothing more than calling asic specific function. This  * should also allow to remove a bunch of callback function  * like vram_info.  */
end_comment

begin_function
name|int
name|r600_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
name|r600_debugfs_mc_info_init
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to register debugfs file for mc !\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Read BIOS */
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Must be an ATOMBIOS */
if|if
condition|(
operator|!
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting atombios for R600 GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_atombios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Post card if necessary */
if|if
condition|(
operator|!
name|radeon_card_posted
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Card not posted and no BIOS - ignoring\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_INFO
argument_list|(
literal|"GPU not posted. posting now...\n"
argument_list|)
expr_stmt|;
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize scratch registers */
name|r600_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|r
operator|=
name|radeon_agp_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
name|radeon_agp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
name|r
operator|=
name|r600_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ih_ring_init
argument_list|(
name|rdev
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|r
operator|=
name|r600_pcie_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|r600_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|r600_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_dma_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_irq_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
comment|/* Don't start up if the ucode is missing. */
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
operator|||
operator|!
name|rdev
operator|->
name|rlc_fw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: ucode required for R600+.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r600_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_audio_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_blit_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_dma_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_irq_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_vram_scratch_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_agp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_fini_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * CS stuff  */
end_comment

begin_function
name|void
name|r600_ring_ib_execute
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ib
operator|->
name|ring
index|]
decl_stmt|;
name|u32
name|next_rptr
decl_stmt|;
if|if
condition|(
name|ring
operator|->
name|rptr_save_reg
condition|)
block|{
name|next_rptr
operator|=
name|ring
operator|->
name|wptr
operator|+
literal|3
operator|+
literal|4
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
name|ring
operator|->
name|rptr_save_reg
operator|-
name|PACKET3_SET_CONFIG_REG_OFFSET
operator|)
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
block|{
name|next_rptr
operator|=
name|ring
operator|->
name|wptr
operator|+
literal|5
operator|+
literal|4
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_MEM_WRITE
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ring
operator|->
name|next_rptr_gpu_addr
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|upper_32_bits
argument_list|(
name|ring
operator|->
name|next_rptr_gpu_addr
argument_list|)
operator|&
literal|0xff
operator|)
operator||
operator|(
literal|1
operator|<<
literal|18
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_INDIRECT_BUFFER
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
operator|(
literal|2
operator|<<
literal|0
operator|)
operator||
endif|#
directive|endif
operator|(
name|ib
operator|->
name|gpu_addr
operator|&
literal|0xFFFFFFFC
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|ib
operator|->
name|gpu_addr
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ib
operator|->
name|length_dw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_ib_test
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|radeon_ib
name|ib
decl_stmt|;
name|uint32_t
name|scratch
decl_stmt|;
name|uint32_t
name|tmp
init|=
literal|0
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|int
name|r
decl_stmt|;
name|r
operator|=
name|radeon_scratch_get
argument_list|(
name|rdev
argument_list|,
operator|&
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to get scratch reg (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|WREG32
argument_list|(
name|scratch
argument_list|,
literal|0xCAFEDEAD
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ib_get
argument_list|(
name|rdev
argument_list|,
name|ring
operator|->
name|idx
argument_list|,
operator|&
name|ib
argument_list|,
name|NULL
argument_list|,
literal|256
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to get ib (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
goto|goto
name|free_scratch
goto|;
block|}
name|ib
operator|.
name|ptr
index|[
literal|0
index|]
operator|=
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|scratch
operator|-
name|PACKET3_SET_CONFIG_REG_OFFSET
operator|)
operator|>>
literal|2
operator|)
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|2
index|]
operator|=
literal|0xDEADBEEF
expr_stmt|;
name|ib
operator|.
name|length_dw
operator|=
literal|3
expr_stmt|;
name|r
operator|=
name|radeon_ib_schedule
argument_list|(
name|rdev
argument_list|,
operator|&
name|ib
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to schedule ib (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
goto|goto
name|free_ib
goto|;
block|}
name|r
operator|=
name|radeon_fence_wait
argument_list|(
name|ib
operator|.
name|fence
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: fence wait failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
goto|goto
name|free_ib
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0xDEADBEEF
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"ib test on ring %d succeeded in %u usecs\n"
argument_list|,
name|ib
operator|.
name|fence
operator|->
name|ring
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: ib test failed (scratch(0x%04X)=0x%08X)\n"
argument_list|,
name|scratch
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|r
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|free_ib
label|:
name|radeon_ib_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|ib
argument_list|)
expr_stmt|;
name|free_scratch
label|:
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|scratch
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/**  * r600_dma_ib_test - test an IB on the DMA engine  *  * @rdev: radeon_device pointer  * @ring: radeon_ring structure holding ring information  *  * Test a simple IB in the DMA ring (r6xx-SI).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
name|int
name|r600_dma_ib_test
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|radeon_ib
name|ib
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|int
name|r
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ptr
init|=
name|rdev
operator|->
name|vram_scratch
operator|.
name|ptr
decl_stmt|;
name|u32
name|tmp
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|ptr
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"invalid vram scratch pointer\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tmp
operator|=
literal|0xCAFEDEAD
expr_stmt|;
operator|*
name|ptr
operator|=
name|tmp
expr_stmt|;
name|r
operator|=
name|radeon_ib_get
argument_list|(
name|rdev
argument_list|,
name|ring
operator|->
name|idx
argument_list|,
operator|&
name|ib
argument_list|,
name|NULL
argument_list|,
literal|256
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to get ib (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|ib
operator|.
name|ptr
index|[
literal|0
index|]
operator|=
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|1
index|]
operator|=
name|rdev
operator|->
name|vram_scratch
operator|.
name|gpu_addr
operator|&
literal|0xfffffffc
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|2
index|]
operator|=
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|vram_scratch
operator|.
name|gpu_addr
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|3
index|]
operator|=
literal|0xDEADBEEF
expr_stmt|;
name|ib
operator|.
name|length_dw
operator|=
literal|4
expr_stmt|;
name|r
operator|=
name|radeon_ib_schedule
argument_list|(
name|rdev
argument_list|,
operator|&
name|ib
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_ib_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|ib
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to schedule ib (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_wait
argument_list|(
name|ib
operator|.
name|fence
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_ib_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|ib
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"radeon: fence wait failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
operator|*
name|ptr
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0xDEADBEEF
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"ib test on ring %d succeeded in %u usecs\n"
argument_list|,
name|ib
operator|.
name|fence
operator|->
name|ring
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: ib test failed (0x%08X)\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|r
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|radeon_ib_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|ib
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/**  * r600_dma_ring_ib_execute - Schedule an IB on the DMA engine  *  * @rdev: radeon_device pointer  * @ib: IB object to schedule  *  * Schedule an IB in the DMA ring (r6xx-r7xx).  */
end_comment

begin_function
name|void
name|r600_dma_ring_ib_execute
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ib
operator|->
name|ring
index|]
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
block|{
name|u32
name|next_rptr
init|=
name|ring
operator|->
name|wptr
operator|+
literal|4
decl_stmt|;
while|while
condition|(
operator|(
name|next_rptr
operator|&
literal|7
operator|)
operator|!=
literal|5
condition|)
name|next_rptr
operator|++
expr_stmt|;
name|next_rptr
operator|+=
literal|3
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ring
operator|->
name|next_rptr_gpu_addr
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|ring
operator|->
name|next_rptr_gpu_addr
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
block|}
comment|/* The indirect buffer packet must end on an 8 DW boundary in the DMA ring. 	 * Pad as necessary with NOPs. 	 */
while|while
condition|(
operator|(
name|ring
operator|->
name|wptr
operator|&
literal|7
operator|)
operator|!=
literal|5
condition|)
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_NOP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_INDIRECT_BUFFER
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|ib
operator|->
name|gpu_addr
operator|&
literal|0xFFFFFFE0
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|ib
operator|->
name|length_dw
operator|<<
literal|16
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|ib
operator|->
name|gpu_addr
argument_list|)
operator|&
literal|0xFF
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Interrupts  *  * Interrupts use a ring buffer on r6xx/r7xx hardware.  It works pretty  * the same as the CP ring buffer, but in reverse.  Rather than the CPU  * writing to the ring and the GPU consuming, the GPU writes to the ring  * and host consumes.  As the host irq handler processes interrupts, it  * increments the rptr.  When the rptr catches up with the wptr, all the  * current interrupts have been processed.  */
end_comment

begin_function
name|void
name|r600_ih_ring_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|unsigned
name|ring_size
parameter_list|)
block|{
name|u32
name|rb_bufsz
decl_stmt|;
comment|/* Align ring size */
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|ring_size
operator|/
literal|4
argument_list|)
expr_stmt|;
name|ring_size
operator|=
operator|(
literal|1
operator|<<
name|rb_bufsz
operator|)
operator|*
literal|4
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|ring_size
operator|=
name|ring_size
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
operator|=
name|rdev
operator|->
name|ih
operator|.
name|ring_size
operator|-
literal|1
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|rptr
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_ih_ring_alloc
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|void
modifier|*
name|ring_ptr
decl_stmt|;
comment|/* FreeBSD: to please GCC 4.2. */
comment|/* Allocate ring buffer */
if|if
condition|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
operator|==
name|NULL
condition|)
block|{
name|r
operator|=
name|radeon_bo_create
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|ring_size
argument_list|,
name|PAGE_SIZE
argument_list|,
name|true
argument_list|,
name|RADEON_GEM_DOMAIN_GTT
argument_list|,
name|NULL
argument_list|,
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to create ih ring buffer (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|radeon_bo_unref
argument_list|(
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_bo_pin
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|,
name|RADEON_GEM_DOMAIN_GTT
argument_list|,
operator|&
name|rdev
operator|->
name|ih
operator|.
name|gpu_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_bo_unreserve
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
name|radeon_bo_unref
argument_list|(
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to pin ih ring buffer (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|ring_ptr
operator|=
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ring
expr_stmt|;
name|r
operator|=
name|radeon_bo_kmap
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|,
name|ring_ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
name|radeon_bo_unpin
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to map ih ring buffer (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_bo_unref
argument_list|(
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r600_ih_ring_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
condition|)
block|{
name|r
operator|=
name|radeon_bo_reserve
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
name|r
operator|==
literal|0
argument_list|)
condition|)
block|{
name|radeon_bo_kunmap
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
name|radeon_bo_unpin
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
block|}
name|radeon_bo_unref
argument_list|(
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|ring
operator|=
name|NULL
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|r600_rlc_stop
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RV740
operator|)
condition|)
block|{
comment|/* r7xx asics need to soft reset RLC before halting */
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
name|SOFT_RESET_RLC
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|mdelay
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RLC_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_rlc_start
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|WREG32
argument_list|(
name|RLC_CNTL
argument_list|,
name|RLC_ENABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_rlc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
specifier|const
name|__be32
modifier|*
name|fw_data
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|rlc_fw
condition|)
return|return
operator|-
name|EINVAL
return|;
name|r600_rlc_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_HB_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_ARUBA
condition|)
block|{
name|WREG32
argument_list|(
name|TN_RLC_SAVE_AND_RESTORE_BASE
argument_list|,
name|rdev
operator|->
name|rlc
operator|.
name|save_restore_gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|TN_RLC_CLEAR_STATE_RESTORE_BASE
argument_list|,
name|rdev
operator|->
name|rlc
operator|.
name|clear_state_gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_CAYMAN
condition|)
block|{
name|WREG32
argument_list|(
name|RLC_HB_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_HB_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_HB_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_CAICOS
condition|)
block|{
name|WREG32
argument_list|(
name|RLC_HB_WPTR_LSB_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_HB_WPTR_MSB_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RLC_MC_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_UCODE_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|rlc_fw
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_ARUBA
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARUBA_RLC_UCODE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RLC_UCODE_ADDR
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CAYMAN
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CAYMAN_RLC_UCODE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RLC_UCODE_ADDR
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CEDAR
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EVERGREEN_RLC_UCODE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RLC_UCODE_ADDR
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|R700_RLC_UCODE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RLC_UCODE_ADDR
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RLC_UCODE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RLC_UCODE_ADDR
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|WREG32
argument_list|(
name|RLC_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|r600_rlc_start
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_enable_interrupts
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|ih_cntl
init|=
name|RREG32
argument_list|(
name|IH_CNTL
argument_list|)
decl_stmt|;
name|u32
name|ih_rb_cntl
init|=
name|RREG32
argument_list|(
name|IH_RB_CNTL
argument_list|)
decl_stmt|;
name|ih_cntl
operator||=
name|ENABLE_INTR
expr_stmt|;
name|ih_rb_cntl
operator||=
name|IH_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|IH_CNTL
argument_list|,
name|ih_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_CNTL
argument_list|,
name|ih_rb_cntl
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|enabled
operator|=
name|true
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r600_disable_interrupts
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|ih_rb_cntl
init|=
name|RREG32
argument_list|(
name|IH_RB_CNTL
argument_list|)
decl_stmt|;
name|u32
name|ih_cntl
init|=
name|RREG32
argument_list|(
name|IH_CNTL
argument_list|)
decl_stmt|;
name|ih_rb_cntl
operator|&=
operator|~
name|IH_RB_ENABLE
expr_stmt|;
name|ih_cntl
operator|&=
operator|~
name|ENABLE_INTR
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_CNTL
argument_list|,
name|ih_rb_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_CNTL
argument_list|,
name|ih_cntl
argument_list|)
expr_stmt|;
comment|/* set rptr, wptr to 0 */
name|WREG32
argument_list|(
name|IH_RB_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|enabled
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|rptr
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_disable_interrupt_state
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|WREG32
argument_list|(
name|CP_INT_CNTL
argument_list|,
name|CNTX_BUSY_INT_ENABLE
operator||
name|CNTX_EMPTY_INT_ENABLE
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DMA_CNTL
argument_list|)
operator|&
operator|~
name|TRAP_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_INT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DxMODE_INT_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|D1GRPH_INTERRUPT_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|D2GRPH_INTERRUPT_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|DCE3_DACA_AUTODETECT_INT_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DCE3_DACB_AUTODETECT_INT_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE32
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|)
operator|&
name|DC_HPDx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET0
argument_list|)
operator|&
operator|~
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET1
argument_list|)
operator|&
operator|~
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|HDMI0_AUDIO_PACKET_CONTROL
argument_list|)
operator|&
operator|~
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|WREG32
argument_list|(
name|HDMI0_AUDIO_PACKET_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DCE3_HDMI1_AUDIO_PACKET_CONTROL
argument_list|)
operator|&
operator|~
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|WREG32
argument_list|(
name|DCE3_HDMI1_AUDIO_PACKET_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|WREG32
argument_list|(
name|DACA_AUTODETECT_INT_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DACB_AUTODETECT_INT_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|)
operator|&
name|DC_HOT_PLUG_DETECTx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|)
operator|&
name|DC_HOT_PLUG_DETECTx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_INT_CONTROL
argument_list|)
operator|&
name|DC_HOT_PLUG_DETECTx_INT_POLARITY
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|HDMI0_AUDIO_PACKET_CONTROL
argument_list|)
operator|&
operator|~
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|WREG32
argument_list|(
name|HDMI0_AUDIO_PACKET_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|HDMI1_AUDIO_PACKET_CONTROL
argument_list|)
operator|&
operator|~
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|WREG32
argument_list|(
name|HDMI1_AUDIO_PACKET_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|r600_irq_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|rb_bufsz
decl_stmt|;
name|u32
name|interrupt_cntl
decl_stmt|,
name|ih_cntl
decl_stmt|,
name|ih_rb_cntl
decl_stmt|;
comment|/* allocate ring */
name|ret
operator|=
name|r600_ih_ring_alloc
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* disable irqs */
name|r600_disable_interrupts
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* init rlc */
name|ret
operator|=
name|r600_rlc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|r600_ih_ring_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/* setup interrupt control */
comment|/* set dummy read address to ring address */
name|WREG32
argument_list|(
name|INTERRUPT_CNTL2
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|interrupt_cntl
operator|=
name|RREG32
argument_list|(
name|INTERRUPT_CNTL
argument_list|)
expr_stmt|;
comment|/* IH_DUMMY_RD_OVERRIDE=0 - dummy read disabled with msi, enabled without msi 	 * IH_DUMMY_RD_OVERRIDE=1 - dummy read controlled by IH_DUMMY_RD_EN 	 */
name|interrupt_cntl
operator|&=
operator|~
name|IH_DUMMY_RD_OVERRIDE
expr_stmt|;
comment|/* IH_REQ_NONSNOOP_EN=1 if ring is in non-cacheable memory, e.g., vram */
name|interrupt_cntl
operator|&=
operator|~
name|IH_REQ_NONSNOOP_EN
expr_stmt|;
name|WREG32
argument_list|(
name|INTERRUPT_CNTL
argument_list|,
name|interrupt_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_BASE
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring_size
operator|/
literal|4
argument_list|)
expr_stmt|;
name|ih_rb_cntl
operator|=
operator|(
name|IH_WPTR_OVERFLOW_ENABLE
operator||
name|IH_WPTR_OVERFLOW_CLEAR
operator||
operator|(
name|rb_bufsz
operator|<<
literal|1
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|ih_rb_cntl
operator||=
name|IH_WPTR_WRITEBACK_ENABLE
expr_stmt|;
comment|/* set the writeback address whether it's enabled or not */
name|WREG32
argument_list|(
name|IH_RB_WPTR_ADDR_LO
argument_list|,
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|R600_WB_IH_WPTR_OFFSET
operator|)
operator|&
literal|0xFFFFFFFC
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_WPTR_ADDR_HI
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|R600_WB_IH_WPTR_OFFSET
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_CNTL
argument_list|,
name|ih_rb_cntl
argument_list|)
expr_stmt|;
comment|/* set rptr, wptr to 0 */
name|WREG32
argument_list|(
name|IH_RB_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Default settings for IH_CNTL (disabled at first) */
name|ih_cntl
operator|=
name|MC_WRREQ_CREDIT
argument_list|(
literal|0x10
argument_list|)
operator||
name|MC_WR_CLEAN_CNT
argument_list|(
literal|0x10
argument_list|)
expr_stmt|;
comment|/* RPTR_REARM only works if msi's are enabled */
if|if
condition|(
name|rdev
operator|->
name|msi_enabled
condition|)
name|ih_cntl
operator||=
name|RPTR_REARM
expr_stmt|;
name|WREG32
argument_list|(
name|IH_CNTL
argument_list|,
name|ih_cntl
argument_list|)
expr_stmt|;
comment|/* force the active interrupt state to all disabled */
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_CEDAR
condition|)
name|evergreen_disable_interrupt_state
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
else|else
name|r600_disable_interrupt_state
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* at this point everything should be setup correctly to enable master */
name|pci_enable_busmaster
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
expr_stmt|;
comment|/* enable irqs */
name|r600_enable_interrupts
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|r600_irq_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_irq_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_rlc_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r600_irq_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_irq_suspend
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_ih_ring_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_irq_set
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|cp_int_cntl
init|=
name|CNTX_BUSY_INT_ENABLE
operator||
name|CNTX_EMPTY_INT_ENABLE
decl_stmt|;
name|u32
name|mode_int
init|=
literal|0
decl_stmt|;
name|u32
name|hpd1
decl_stmt|,
name|hpd2
decl_stmt|,
name|hpd3
decl_stmt|,
name|hpd4
init|=
literal|0
decl_stmt|,
name|hpd5
init|=
literal|0
decl_stmt|,
name|hpd6
init|=
literal|0
decl_stmt|;
name|u32
name|grbm_int_cntl
init|=
literal|0
decl_stmt|;
name|u32
name|hdmi0
decl_stmt|,
name|hdmi1
decl_stmt|;
name|u32
name|d1grph
init|=
literal|0
decl_stmt|,
name|d2grph
init|=
literal|0
decl_stmt|;
name|u32
name|dma_cntl
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|irq
operator|.
name|installed
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Can't enable IRQ/MSI because no handler is installed\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* don't enable anything if the ih is disabled */
if|if
condition|(
operator|!
name|rdev
operator|->
name|ih
operator|.
name|enabled
condition|)
block|{
name|r600_disable_interrupts
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* force the active interrupt state to all disabled */
name|r600_disable_interrupt_state
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|hpd1
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd2
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd3
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd4
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE32
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|hpd5
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd6
operator|=
name|RREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hdmi0
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET0
argument_list|)
operator|&
operator|~
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|hdmi1
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET1
argument_list|)
operator|&
operator|~
name|AFMT_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
else|else
block|{
name|hdmi0
operator|=
name|RREG32
argument_list|(
name|HDMI0_AUDIO_PACKET_CONTROL
argument_list|)
operator|&
operator|~
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|hdmi1
operator|=
name|RREG32
argument_list|(
name|DCE3_HDMI1_AUDIO_PACKET_CONTROL
argument_list|)
operator|&
operator|~
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
block|}
else|else
block|{
name|hpd1
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd2
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hpd3
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_INT_CONTROL
argument_list|)
operator|&
operator|~
name|DC_HPDx_INT_EN
expr_stmt|;
name|hdmi0
operator|=
name|RREG32
argument_list|(
name|HDMI0_AUDIO_PACKET_CONTROL
argument_list|)
operator|&
operator|~
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
name|hdmi1
operator|=
name|RREG32
argument_list|(
name|HDMI1_AUDIO_PACKET_CONTROL
argument_list|)
operator|&
operator|~
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
name|dma_cntl
operator|=
name|RREG32
argument_list|(
name|DMA_CNTL
argument_list|)
operator|&
operator|~
name|TRAP_ENABLE
expr_stmt|;
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: sw int\n"
argument_list|)
expr_stmt|;
name|cp_int_cntl
operator||=
name|RB_INT_ENABLE
expr_stmt|;
name|cp_int_cntl
operator||=
name|TIME_STAMP_INT_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: sw int dma\n"
argument_list|)
expr_stmt|;
name|dma_cntl
operator||=
name|TRAP_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|0
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: vblank 0\n"
argument_list|)
expr_stmt|;
name|mode_int
operator||=
name|D1MODE_VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|1
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: vblank 1\n"
argument_list|)
expr_stmt|;
name|mode_int
operator||=
name|D2MODE_VBLANK_INT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|0
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: hpd 1\n"
argument_list|)
expr_stmt|;
name|hpd1
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|1
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: hpd 2\n"
argument_list|)
expr_stmt|;
name|hpd2
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|2
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: hpd 3\n"
argument_list|)
expr_stmt|;
name|hpd3
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|3
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: hpd 4\n"
argument_list|)
expr_stmt|;
name|hpd4
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|4
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: hpd 5\n"
argument_list|)
expr_stmt|;
name|hpd5
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|5
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: hpd 6\n"
argument_list|)
expr_stmt|;
name|hpd6
operator||=
name|DC_HPDx_INT_EN
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|afmt
index|[
literal|0
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: hdmi 0\n"
argument_list|)
expr_stmt|;
name|hdmi0
operator||=
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|afmt
index|[
literal|1
index|]
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_set: hdmi 0\n"
argument_list|)
expr_stmt|;
name|hdmi1
operator||=
name|HDMI0_AZ_FORMAT_WTRIG_MASK
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|CP_INT_CNTL
argument_list|,
name|cp_int_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_CNTL
argument_list|,
name|dma_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DxMODE_INT_MASK
argument_list|,
name|mode_int
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|D1GRPH_INTERRUPT_CONTROL
argument_list|,
name|d1grph
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|D2GRPH_INTERRUPT_CONTROL
argument_list|,
name|d2grph
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_INT_CNTL
argument_list|,
name|grbm_int_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|hpd1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|hpd2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|hpd3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|hpd4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE32
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|hpd5
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|hpd6
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET0
argument_list|,
name|hdmi0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET1
argument_list|,
name|hdmi1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|HDMI0_AUDIO_PACKET_CONTROL
argument_list|,
name|hdmi0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DCE3_HDMI1_AUDIO_PACKET_CONTROL
argument_list|,
name|hdmi1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|,
name|hpd1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|,
name|hpd2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_INT_CONTROL
argument_list|,
name|hpd3
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDMI0_AUDIO_PACKET_CONTROL
argument_list|,
name|hdmi0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDMI1_AUDIO_PACKET_CONTROL
argument_list|,
name|hdmi1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_irq_ack
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|=
name|RREG32
argument_list|(
name|DCE3_DISP_INTERRUPT_STATUS
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont
operator|=
name|RREG32
argument_list|(
name|DCE3_DISP_INTERRUPT_STATUS_CONTINUE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont2
operator|=
name|RREG32
argument_list|(
name|DCE3_DISP_INTERRUPT_STATUS_CONTINUE2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE32
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi0_status
operator|=
name|RREG32
argument_list|(
name|AFMT_STATUS
operator|+
name|DCE3_HDMI_OFFSET0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi1_status
operator|=
name|RREG32
argument_list|(
name|AFMT_STATUS
operator|+
name|DCE3_HDMI_OFFSET1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi0_status
operator|=
name|RREG32
argument_list|(
name|HDMI0_STATUS
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi1_status
operator|=
name|RREG32
argument_list|(
name|DCE3_HDMI1_STATUS
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont
operator|=
name|RREG32
argument_list|(
name|DISP_INTERRUPT_STATUS_CONTINUE
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont2
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi0_status
operator|=
name|RREG32
argument_list|(
name|HDMI0_STATUS
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi1_status
operator|=
name|RREG32
argument_list|(
name|HDMI1_STATUS
argument_list|)
expr_stmt|;
block|}
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|d1grph_int
operator|=
name|RREG32
argument_list|(
name|D1GRPH_INTERRUPT_STATUS
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|d2grph_int
operator|=
name|RREG32
argument_list|(
name|D2GRPH_INTERRUPT_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|d1grph_int
operator|&
name|DxGRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|D1GRPH_INTERRUPT_STATUS
argument_list|,
name|DxGRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|d2grph_int
operator|&
name|DxGRPH_PFLIP_INT_OCCURRED
condition|)
name|WREG32
argument_list|(
name|D2GRPH_INTERRUPT_STATUS
argument_list|,
name|DxGRPH_PFLIP_INT_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|LB_D1_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|D1MODE_VBLANK_STATUS
argument_list|,
name|DxMODE_VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|LB_D1_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|D1MODE_VLINE_STATUS
argument_list|,
name|DxMODE_VLINE_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|LB_D2_VBLANK_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|D2MODE_VBLANK_STATUS
argument_list|,
name|DxMODE_VBLANK_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|LB_D2_VLINE_INTERRUPT
condition|)
name|WREG32
argument_list|(
name|D2MODE_VLINE_STATUS
argument_list|,
name|DxMODE_VLINE_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|DC_HPD1_INTERRUPT
condition|)
block|{
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT1_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|DC_HPD2_INTERRUPT
condition|)
block|{
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT2_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont
operator|&
name|DC_HPD3_INTERRUPT
condition|)
block|{
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HOT_PLUG_DETECT3_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont
operator|&
name|DC_HPD4_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD4_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ASIC_IS_DCE32
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont2
operator|&
name|DC_HPD5_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont2
operator|&
name|DC_HPD6_INTERRUPT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DC_HPD5_INT_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|DC_HPDx_INT_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DC_HPD6_INT_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi0_status
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET0
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|AFMT_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi1_status
operator|&
name|AFMT_AZ_FORMAT_WTRIG
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET1
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|AFMT_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|AFMT_AUDIO_PACKET_CONTROL
operator|+
name|DCE3_HDMI_OFFSET1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi0_status
operator|&
name|HDMI0_AZ_FORMAT_WTRIG
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|HDMI0_AUDIO_PACKET_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|HDMI0_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|HDMI0_AUDIO_PACKET_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi1_status
operator|&
name|HDMI0_AZ_FORMAT_WTRIG
condition|)
block|{
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|DCE3_HDMI1_AUDIO_PACKET_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|HDMI0_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|DCE3_HDMI1_AUDIO_PACKET_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|HDMI1_AUDIO_PACKET_CONTROL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|HDMI0_AZ_FORMAT_WTRIG_ACK
expr_stmt|;
name|WREG32
argument_list|(
name|HDMI1_AUDIO_PACKET_CONTROL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|r600_irq_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_disable_interrupts
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Wait and acknowledge irq */
name|mdelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|r600_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_disable_interrupt_state
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|r600_get_ih_wptr
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|wptr
decl_stmt|,
name|tmp
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|wptr
operator|=
name|le32_to_cpu
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|wb
index|[
name|R600_WB_IH_WPTR_OFFSET
operator|/
literal|4
index|]
argument_list|)
expr_stmt|;
else|else
name|wptr
operator|=
name|RREG32
argument_list|(
name|IH_RB_WPTR
argument_list|)
expr_stmt|;
if|if
condition|(
name|wptr
operator|&
name|RB_OVERFLOW
condition|)
block|{
comment|/* When a ring buffer overflow happen start parsing interrupt 		 * from the last not overwritten vector (wptr + 16). Hopefully 		 * this should allow us to catchup. 		 */
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IH ring buffer overflow (0x%08X, %d, %d)\n"
argument_list|,
name|wptr
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|rptr
argument_list|,
operator|(
name|wptr
operator|+
literal|16
operator|)
operator|+
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|rptr
operator|=
operator|(
name|wptr
operator|+
literal|16
operator|)
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|IH_RB_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|IH_WPTR_OVERFLOW_CLEAR
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|wptr
operator|&
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
operator|)
return|;
block|}
end_function

begin_comment
comment|/*        r600 IV Ring  * Each IV ring entry is 128 bits:  * [7:0]    - interrupt source id  * [31:8]   - reserved  * [59:32]  - interrupt source data  * [127:60]  - reserved  *  * The basic interrupt vector entries  * are decoded as follows:  * src_id  src_data  description  *      1         0  D1 Vblank  *      1         1  D1 Vline  *      5         0  D2 Vblank  *      5         1  D2 Vline  *     19         0  FP Hot plug detection A  *     19         1  FP Hot plug detection B  *     19         2  DAC A auto-detection  *     19         3  DAC B auto-detection  *     21         4  HDMI block A  *     21         5  HDMI block B  *    176         -  CP_INT RB  *    177         -  CP_INT IB1  *    178         -  CP_INT IB2  *    181         -  EOP Interrupt  *    233         -  GUI Idle  *  * Note, these are based on r600 and may need to be  * adjusted or added to on newer asics  */
end_comment

begin_function
name|irqreturn_t
name|r600_irq_process
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|wptr
decl_stmt|;
name|u32
name|rptr
decl_stmt|;
name|u32
name|src_id
decl_stmt|,
name|src_data
decl_stmt|;
name|u32
name|ring_index
decl_stmt|;
name|bool
name|queue_hotplug
init|=
name|false
decl_stmt|;
name|bool
name|queue_hdmi
init|=
name|false
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|ih
operator|.
name|enabled
operator|||
name|rdev
operator|->
name|shutdown
condition|)
return|return
name|IRQ_NONE
return|;
comment|/* No MSIs, need a dummy read to flush PCI DMAs */
if|if
condition|(
operator|!
name|rdev
operator|->
name|msi_enabled
condition|)
name|RREG32
argument_list|(
name|IH_RB_WPTR
argument_list|)
expr_stmt|;
name|wptr
operator|=
name|r600_get_ih_wptr
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|restart_ih
label|:
comment|/* is somebody else already processing irqs? */
if|if
condition|(
name|atomic_xchg
argument_list|(
operator|&
name|rdev
operator|->
name|ih
operator|.
name|lock
argument_list|,
literal|1
argument_list|)
condition|)
return|return
name|IRQ_NONE
return|;
name|rptr
operator|=
name|rdev
operator|->
name|ih
operator|.
name|rptr
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"r600_irq_process start: rptr %d, wptr %d\n"
argument_list|,
name|rptr
argument_list|,
name|wptr
argument_list|)
expr_stmt|;
comment|/* Order reading of wptr vs. reading of IH ring data */
name|rmb
argument_list|()
expr_stmt|;
comment|/* display interrupts */
name|r600_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
while|while
condition|(
name|rptr
operator|!=
name|wptr
condition|)
block|{
comment|/* wptr/rptr are in bytes! */
name|ring_index
operator|=
name|rptr
operator|/
literal|4
expr_stmt|;
name|src_id
operator|=
name|le32_to_cpu
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring
index|[
name|ring_index
index|]
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|src_data
operator|=
name|le32_to_cpu
argument_list|(
name|rdev
operator|->
name|ih
operator|.
name|ring
index|[
name|ring_index
operator|+
literal|1
index|]
argument_list|)
operator|&
literal|0xfffffff
expr_stmt|;
switch|switch
condition|(
name|src_id
condition|)
block|{
case|case
literal|1
case|:
comment|/* D1 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D1 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|LB_D1_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|0
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|0
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&=
operator|~
name|LB_D1_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D1 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D1 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|LB_D1_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&=
operator|~
name|LB_D1_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D1 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|5
case|:
comment|/* D2 vblank/vline */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
comment|/* D2 vblank */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|LB_D2_VBLANK_INTERRUPT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|1
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|1
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&=
operator|~
name|LB_D2_VBLANK_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D2 vblank\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
comment|/* D1 vline */
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|LB_D2_VLINE_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&=
operator|~
name|LB_D2_VLINE_INTERRUPT
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: D2 vline\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|19
case|:
comment|/* HPD/DAC hotplug */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|DC_HPD1_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&=
operator|~
name|DC_HPD1_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD1\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&
name|DC_HPD2_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int
operator|&=
operator|~
name|DC_HPD2_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD2\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont
operator|&
name|DC_HPD3_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont
operator|&=
operator|~
name|DC_HPD3_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD3\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont
operator|&
name|DC_HPD4_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont
operator|&=
operator|~
name|DC_HPD4_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD4\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|10
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont2
operator|&
name|DC_HPD5_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont2
operator|&=
operator|~
name|DC_HPD5_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD5\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|12
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont2
operator|&
name|DC_HPD6_INTERRUPT
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|disp_int_cont2
operator|&=
operator|~
name|DC_HPD6_INTERRUPT
expr_stmt|;
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HPD6\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|21
case|:
comment|/* hdmi */
switch|switch
condition|(
name|src_data
condition|)
block|{
case|case
literal|4
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi0_status
operator|&
name|HDMI0_AZ_FORMAT_WTRIG
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi0_status
operator|&=
operator|~
name|HDMI0_AZ_FORMAT_WTRIG
expr_stmt|;
name|queue_hdmi
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HDMI0\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi1_status
operator|&
name|HDMI0_AZ_FORMAT_WTRIG
condition|)
block|{
name|rdev
operator|->
name|irq
operator|.
name|stat_regs
operator|.
name|r600
operator|.
name|hdmi1_status
operator|&=
operator|~
name|HDMI0_AZ_FORMAT_WTRIG
expr_stmt|;
name|queue_hdmi
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"IH: HDMI1\n"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|176
case|:
comment|/* CP_INT in ring buffer */
case|case
literal|177
case|:
comment|/* CP_INT in IB1 */
case|case
literal|178
case|:
comment|/* CP_INT in IB2 */
name|DRM_DEBUG
argument_list|(
literal|"IH: CP int: 0x%08x\n"
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|181
case|:
comment|/* CP EOP event */
name|DRM_DEBUG
argument_list|(
literal|"IH: CP EOP\n"
argument_list|)
expr_stmt|;
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|224
case|:
comment|/* DMA trap event */
name|DRM_DEBUG
argument_list|(
literal|"IH: DMA trap\n"
argument_list|)
expr_stmt|;
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|R600_RING_TYPE_DMA_INDEX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|233
case|:
comment|/* GUI IDLE */
name|DRM_DEBUG
argument_list|(
literal|"IH: GUI idle\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_DEBUG
argument_list|(
literal|"Unhandled interrupt: %d %d\n"
argument_list|,
name|src_id
argument_list|,
name|src_data
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* wptr/rptr are in bytes! */
name|rptr
operator|+=
literal|16
expr_stmt|;
name|rptr
operator|&=
name|rdev
operator|->
name|ih
operator|.
name|ptr_mask
expr_stmt|;
block|}
if|if
condition|(
name|queue_hotplug
condition|)
name|taskqueue_enqueue
argument_list|(
name|rdev
operator|->
name|tq
argument_list|,
operator|&
name|rdev
operator|->
name|hotplug_work
argument_list|)
expr_stmt|;
if|if
condition|(
name|queue_hdmi
condition|)
name|taskqueue_enqueue
argument_list|(
name|rdev
operator|->
name|tq
argument_list|,
operator|&
name|rdev
operator|->
name|audio_work
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|rptr
operator|=
name|rptr
expr_stmt|;
name|WREG32
argument_list|(
name|IH_RB_RPTR
argument_list|,
name|rdev
operator|->
name|ih
operator|.
name|rptr
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|rdev
operator|->
name|ih
operator|.
name|lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* make sure wptr hasn't changed while processing */
name|wptr
operator|=
name|r600_get_ih_wptr
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|wptr
operator|!=
name|rptr
condition|)
goto|goto
name|restart_ih
goto|;
return|return
name|IRQ_HANDLED
return|;
block|}
end_function

begin_comment
comment|/*  * Debugfs info  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
end_if

begin_function
specifier|static
name|int
name|r600_debugfs_mc_info
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_info_node
modifier|*
name|node
init|=
operator|(
expr|struct
name|drm_info_node
operator|*
operator|)
name|m
operator|->
name|private
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|node
operator|->
name|minor
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DREG32_SYS
argument_list|(
name|m
argument_list|,
name|rdev
argument_list|,
name|R_000E50_SRBM_STATUS
argument_list|)
expr_stmt|;
name|DREG32_SYS
argument_list|(
name|m
argument_list|,
name|rdev
argument_list|,
name|VM_L2_STATUS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|drm_info_list
name|r600_mc_info_list
index|[]
init|=
block|{
block|{
literal|"r600_mc_info"
block|,
name|r600_debugfs_mc_info
block|,
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|r600_debugfs_mc_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
return|return
name|radeon_debugfs_add_files
argument_list|(
name|rdev
argument_list|,
name|r600_mc_info_list
argument_list|,
name|ARRAY_SIZE
argument_list|(
name|r600_mc_info_list
argument_list|)
argument_list|)
return|;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**  * r600_ioctl_wait_idle - flush host path cache on wait idle ioctl  * rdev: radeon device structure  * bo: buffer object struct which userspace is waiting for idle  *  * Some R6XX/R7XX doesn't seems to take into account HDP flush performed  * through ring buffer, this leads to corruption in rendering, see  * http://bugzilla.kernel.org/show_bug.cgi?id=15186 to avoid this we  * directly perform HDP flush by writing register through MMIO.  */
end_comment

begin_function
name|void
name|r600_ioctl_wait_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_bo
modifier|*
name|bo
parameter_list|)
block|{
comment|/* r7xx hw bug.  write to HDP_DEBUG1 followed by fb read 	 * rather than write to HDP_REG_COHERENCY_FLUSH_CNTL. 	 * This seems to cause problems on some AGP cards. Just use the old 	 * method for them. 	 */
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RV740
operator|)
operator|&&
name|rdev
operator|->
name|vram_scratch
operator|.
name|ptr
operator|&&
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
condition|)
block|{
specifier|volatile
name|uint32_t
modifier|*
name|ptr
init|=
name|rdev
operator|->
name|vram_scratch
operator|.
name|ptr
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|WREG32
argument_list|(
name|HDP_DEBUG1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|*
name|ptr
expr_stmt|;
block|}
else|else
name|WREG32
argument_list|(
name|R_005480_HDP_MEM_COHERENCY_FLUSH_CNTL
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r600_set_pcie_lanes
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|lanes
parameter_list|)
block|{
name|u32
name|link_width_cntl
decl_stmt|,
name|mask
decl_stmt|,
name|target_reg
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
operator|)
condition|)
return|return;
comment|/* x2 cards have a special sequence */
if|if
condition|(
name|ASIC_IS_X2
argument_list|(
name|rdev
argument_list|)
condition|)
return|return;
comment|/* FIXME wait for idle */
switch|switch
condition|(
name|lanes
condition|)
block|{
case|case
literal|0
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X0
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X1
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X2
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X4
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X8
expr_stmt|;
break|break;
case|case
literal|12
case|:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X12
expr_stmt|;
break|break;
case|case
literal|16
case|:
default|default:
name|mask
operator|=
name|RADEON_PCIE_LC_LINK_WIDTH_X16
expr_stmt|;
break|break;
block|}
name|link_width_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|RADEON_PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|link_width_cntl
operator|&
name|RADEON_PCIE_LC_LINK_WIDTH_RD_MASK
operator|)
operator|==
operator|(
name|mask
operator|<<
name|RADEON_PCIE_LC_LINK_WIDTH_RD_SHIFT
operator|)
condition|)
return|return;
if|if
condition|(
name|link_width_cntl
operator|&
name|R600_PCIE_LC_UPCONFIGURE_DIS
condition|)
return|return;
name|link_width_cntl
operator|&=
operator|~
operator|(
name|RADEON_PCIE_LC_LINK_WIDTH_MASK
operator||
name|RADEON_PCIE_LC_RECONFIG_NOW
operator||
name|R600_PCIE_LC_RENEGOTIATE_EN
operator||
name|R600_PCIE_LC_RECONFIG_ARC_MISSING_ESCAPE
operator|)
expr_stmt|;
name|link_width_cntl
operator||=
name|mask
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|RADEON_PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
comment|/* some northbridges can renegotiate the link rather than requiring                                            * a complete re-config.                                                                                       * e.g., AMD 780/790 northbridges (pci ids: 0x5956, 0x5957, 0x5958, etc.)                                      */
if|if
condition|(
name|link_width_cntl
operator|&
name|R600_PCIE_LC_RENEGOTIATION_SUPPORT
condition|)
name|link_width_cntl
operator||=
name|R600_PCIE_LC_RENEGOTIATE_EN
operator||
name|R600_PCIE_LC_UPCONFIGURE_SUPPORT
expr_stmt|;
else|else
name|link_width_cntl
operator||=
name|R600_PCIE_LC_RECONFIG_ARC_MISSING_ESCAPE
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|RADEON_PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
operator|(
name|link_width_cntl
operator||
name|RADEON_PCIE_LC_RECONFIG_NOW
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV770
condition|)
name|target_reg
operator|=
name|R700_TARGET_AND_CURRENT_PROFILE_INDEX
expr_stmt|;
else|else
name|target_reg
operator|=
name|R600_TARGET_AND_CURRENT_PROFILE_INDEX
expr_stmt|;
comment|/* wait for lane set to complete */
name|link_width_cntl
operator|=
name|RREG32
argument_list|(
name|target_reg
argument_list|)
expr_stmt|;
while|while
condition|(
name|link_width_cntl
operator|==
literal|0xffffffff
condition|)
name|link_width_cntl
operator|=
name|RREG32
argument_list|(
name|target_reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_get_pcie_lanes
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|link_width_cntl
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
operator|)
condition|)
return|return
literal|0
return|;
comment|/* x2 cards have a special sequence */
if|if
condition|(
name|ASIC_IS_X2
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* FIXME wait for idle */
name|link_width_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|RADEON_PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|link_width_cntl
operator|&
name|RADEON_PCIE_LC_LINK_WIDTH_RD_MASK
operator|)
operator|>>
name|RADEON_PCIE_LC_LINK_WIDTH_RD_SHIFT
condition|)
block|{
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X0
case|:
return|return
literal|0
return|;
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X1
case|:
return|return
literal|1
return|;
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X2
case|:
return|return
literal|2
return|;
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X4
case|:
return|return
literal|4
return|;
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X8
case|:
return|return
literal|8
return|;
case|case
name|RADEON_PCIE_LC_LINK_WIDTH_X16
case|:
default|default:
return|return
literal|16
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|r600_pcie_gen2_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|link_width_cntl
decl_stmt|,
name|lanes
decl_stmt|,
name|speed_cntl
decl_stmt|,
name|training_cntl
decl_stmt|,
name|tmp
decl_stmt|;
name|u16
name|link_cntl2
decl_stmt|;
name|u32
name|mask
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|radeon_pcie_gen2
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
operator|)
condition|)
return|return;
comment|/* x2 cards have a special sequence */
if|if
condition|(
name|ASIC_IS_X2
argument_list|(
name|rdev
argument_list|)
condition|)
return|return;
comment|/* only RV6xx+ chips are supported */
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_R600
condition|)
return|return;
name|ret
operator|=
name|drm_pcie_get_speed_cap_mask
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|DRM_PCIE_SPEED_50
operator|)
condition|)
return|return;
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|speed_cntl
operator|&
name|LC_CURRENT_DATA_RATE
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"PCIE gen 2 link speeds already enabled\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|DRM_INFO
argument_list|(
literal|"enabling PCIE gen 2 link speeds, disable with radeon.pcie_gen2=0\n"
argument_list|)
expr_stmt|;
comment|/* 55 nm r6xx asics */
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV670
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV635
operator|)
condition|)
block|{
comment|/* advertise upconfig capability */
name|link_width_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
name|link_width_cntl
operator|&=
operator|~
name|LC_UPCONFIGURE_DIS
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
name|link_width_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|link_width_cntl
operator|&
name|LC_RENEGOTIATION_SUPPORT
condition|)
block|{
name|lanes
operator|=
operator|(
name|link_width_cntl
operator|&
name|LC_LINK_WIDTH_RD_MASK
operator|)
operator|>>
name|LC_LINK_WIDTH_RD_SHIFT
expr_stmt|;
name|link_width_cntl
operator|&=
operator|~
operator|(
name|LC_LINK_WIDTH_MASK
operator||
name|LC_RECONFIG_ARC_MISSING_ESCAPE
operator|)
expr_stmt|;
name|link_width_cntl
operator||=
name|lanes
operator||
name|LC_RECONFIG_NOW
operator||
name|LC_RENEGOTIATE_EN
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|link_width_cntl
operator||=
name|LC_UPCONFIGURE_DIS
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
block|}
block|}
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|speed_cntl
operator|&
name|LC_OTHER_SIDE_EVER_SENT_GEN2
operator|)
operator|&&
operator|(
name|speed_cntl
operator|&
name|LC_OTHER_SIDE_SUPPORTS_GEN2
operator|)
condition|)
block|{
comment|/* 55 nm r6xx asics */
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV670
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV635
operator|)
condition|)
block|{
name|WREG32
argument_list|(
name|MM_CFGREGS_CNTL
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
name|link_cntl2
operator|=
name|RREG32
argument_list|(
literal|0x4088
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MM_CFGREGS_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* not supported yet */
if|if
condition|(
name|link_cntl2
operator|&
name|SELECTABLE_DEEMPHASIS
condition|)
return|return;
block|}
name|speed_cntl
operator|&=
operator|~
name|LC_SPEED_CHANGE_ATTEMPTS_ALLOWED_MASK
expr_stmt|;
name|speed_cntl
operator||=
operator|(
literal|0x3
operator|<<
name|LC_SPEED_CHANGE_ATTEMPTS_ALLOWED_SHIFT
operator|)
expr_stmt|;
name|speed_cntl
operator|&=
operator|~
name|LC_VOLTAGE_TIMER_SEL_MASK
expr_stmt|;
name|speed_cntl
operator|&=
operator|~
name|LC_FORCE_DIS_HW_SPEED_CHANGE
expr_stmt|;
name|speed_cntl
operator||=
name|LC_FORCE_EN_HW_SPEED_CHANGE
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
literal|0x541c
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x541c
argument_list|,
name|tmp
operator||
literal|0x8
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MM_CFGREGS_CNTL
argument_list|,
name|MM_WR_TO_CFG_EN
argument_list|)
expr_stmt|;
name|link_cntl2
operator|=
name|RREG16
argument_list|(
literal|0x4088
argument_list|)
expr_stmt|;
name|link_cntl2
operator|&=
operator|~
name|TARGET_LINK_SPEED_MASK
expr_stmt|;
name|link_cntl2
operator||=
literal|0x2
expr_stmt|;
name|WREG16
argument_list|(
literal|0x4088
argument_list|,
name|link_cntl2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MM_CFGREGS_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV670
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV635
operator|)
condition|)
block|{
name|training_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_TRAINING_CNTL
argument_list|)
expr_stmt|;
name|training_cntl
operator|&=
operator|~
name|LC_POINT_7_PLUS_EN
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_TRAINING_CNTL
argument_list|,
name|training_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
name|speed_cntl
operator|&=
operator|~
name|LC_TARGET_LINK_SPEED_OVERRIDE_EN
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
block|}
name|speed_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|)
expr_stmt|;
name|speed_cntl
operator||=
name|LC_GEN2_EN_STRAP
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_SPEED_CNTL
argument_list|,
name|speed_cntl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|link_width_cntl
operator|=
name|RREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|)
expr_stmt|;
comment|/* XXX: only disable it if gen1 bridge vendor == 0x111d or 0x1106 */
if|if
condition|(
literal|1
condition|)
name|link_width_cntl
operator||=
name|LC_UPCONFIGURE_DIS
expr_stmt|;
else|else
name|link_width_cntl
operator|&=
operator|~
name|LC_UPCONFIGURE_DIS
expr_stmt|;
name|WREG32_PCIE_P
argument_list|(
name|PCIE_LC_LINK_WIDTH_CNTL
argument_list|,
name|link_width_cntl
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * r600_get_gpu_clock - return GPU clock counter snapshot  *  * @rdev: radeon_device pointer  *  * Fetches a GPU clock counter snapshot (R6xx-cayman).  * Returns the 64 bit clock counter snapshot.  */
end_comment

begin_function
name|uint64_t
name|r600_get_gpu_clock
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint64_t
name|clock
decl_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|rdev
operator|->
name|gpu_clock_mutex
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_CAPTURE_GPU_CLOCK_COUNT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|clock
operator|=
operator|(
name|uint64_t
operator|)
name|RREG32
argument_list|(
name|RLC_GPU_CLOCK_COUNT_LSB
argument_list|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|RREG32
argument_list|(
name|RLC_GPU_CLOCK_COUNT_MSB
argument_list|)
operator|<<
literal|32ULL
operator|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|rdev
operator|->
name|gpu_clock_mutex
argument_list|)
expr_stmt|;
return|return
name|clock
return|;
block|}
end_function

end_unit


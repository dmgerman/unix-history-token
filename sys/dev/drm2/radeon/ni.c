begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2010 Advanced Micro Devices, Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Alex Deucher  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"nid.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"ni_reg.h"
end_include

begin_include
include|#
directive|include
file|"cayman_blit_shaders.h"
end_include

begin_function_decl
specifier|extern
name|void
name|evergreen_pcie_gen2_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|EVERGREEN_PFP_UCODE_SIZE
value|1120
end_define

begin_define
define|#
directive|define
name|EVERGREEN_PM4_UCODE_SIZE
value|1376
end_define

begin_define
define|#
directive|define
name|EVERGREEN_RLC_UCODE_SIZE
value|768
end_define

begin_define
define|#
directive|define
name|BTC_MC_UCODE_SIZE
value|6024
end_define

begin_define
define|#
directive|define
name|CAYMAN_PFP_UCODE_SIZE
value|2176
end_define

begin_define
define|#
directive|define
name|CAYMAN_PM4_UCODE_SIZE
value|2176
end_define

begin_define
define|#
directive|define
name|CAYMAN_RLC_UCODE_SIZE
value|1024
end_define

begin_define
define|#
directive|define
name|CAYMAN_MC_UCODE_SIZE
value|6037
end_define

begin_define
define|#
directive|define
name|ARUBA_RLC_UCODE_SIZE
value|1536
end_define

begin_define
define|#
directive|define
name|BTC_IO_MC_REGS_SIZE
value|29
end_define

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|barts_io_mc_regs
index|[
name|BTC_IO_MC_REGS_SIZE
index|]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x00000077
block|,
literal|0xff010100
block|}
block|,
block|{
literal|0x00000078
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000079
block|,
literal|0x00001434
block|}
block|,
block|{
literal|0x0000007a
block|,
literal|0xcc08ec08
block|}
block|,
block|{
literal|0x0000007b
block|,
literal|0x00040000
block|}
block|,
block|{
literal|0x0000007c
block|,
literal|0x000080c0
block|}
block|,
block|{
literal|0x0000007d
block|,
literal|0x09000000
block|}
block|,
block|{
literal|0x0000007e
block|,
literal|0x00210404
block|}
block|,
block|{
literal|0x00000081
block|,
literal|0x08a8e800
block|}
block|,
block|{
literal|0x00000082
block|,
literal|0x00030444
block|}
block|,
block|{
literal|0x00000083
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000085
block|,
literal|0x00000001
block|}
block|,
block|{
literal|0x00000086
block|,
literal|0x00000002
block|}
block|,
block|{
literal|0x00000087
block|,
literal|0x48490000
block|}
block|,
block|{
literal|0x00000088
block|,
literal|0x20244647
block|}
block|,
block|{
literal|0x00000089
block|,
literal|0x00000005
block|}
block|,
block|{
literal|0x0000008b
block|,
literal|0x66030000
block|}
block|,
block|{
literal|0x0000008c
block|,
literal|0x00006603
block|}
block|,
block|{
literal|0x0000008d
block|,
literal|0x00000100
block|}
block|,
block|{
literal|0x0000008f
block|,
literal|0x00001c0a
block|}
block|,
block|{
literal|0x00000090
block|,
literal|0xff000001
block|}
block|,
block|{
literal|0x00000094
block|,
literal|0x00101101
block|}
block|,
block|{
literal|0x00000095
block|,
literal|0x00000fff
block|}
block|,
block|{
literal|0x00000096
block|,
literal|0x00116fff
block|}
block|,
block|{
literal|0x00000097
block|,
literal|0x60010000
block|}
block|,
block|{
literal|0x00000098
block|,
literal|0x10010000
block|}
block|,
block|{
literal|0x00000099
block|,
literal|0x00006000
block|}
block|,
block|{
literal|0x0000009a
block|,
literal|0x00001000
block|}
block|,
block|{
literal|0x0000009f
block|,
literal|0x00946a00
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|turks_io_mc_regs
index|[
name|BTC_IO_MC_REGS_SIZE
index|]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x00000077
block|,
literal|0xff010100
block|}
block|,
block|{
literal|0x00000078
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000079
block|,
literal|0x00001434
block|}
block|,
block|{
literal|0x0000007a
block|,
literal|0xcc08ec08
block|}
block|,
block|{
literal|0x0000007b
block|,
literal|0x00040000
block|}
block|,
block|{
literal|0x0000007c
block|,
literal|0x000080c0
block|}
block|,
block|{
literal|0x0000007d
block|,
literal|0x09000000
block|}
block|,
block|{
literal|0x0000007e
block|,
literal|0x00210404
block|}
block|,
block|{
literal|0x00000081
block|,
literal|0x08a8e800
block|}
block|,
block|{
literal|0x00000082
block|,
literal|0x00030444
block|}
block|,
block|{
literal|0x00000083
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000085
block|,
literal|0x00000001
block|}
block|,
block|{
literal|0x00000086
block|,
literal|0x00000002
block|}
block|,
block|{
literal|0x00000087
block|,
literal|0x48490000
block|}
block|,
block|{
literal|0x00000088
block|,
literal|0x20244647
block|}
block|,
block|{
literal|0x00000089
block|,
literal|0x00000005
block|}
block|,
block|{
literal|0x0000008b
block|,
literal|0x66030000
block|}
block|,
block|{
literal|0x0000008c
block|,
literal|0x00006603
block|}
block|,
block|{
literal|0x0000008d
block|,
literal|0x00000100
block|}
block|,
block|{
literal|0x0000008f
block|,
literal|0x00001c0a
block|}
block|,
block|{
literal|0x00000090
block|,
literal|0xff000001
block|}
block|,
block|{
literal|0x00000094
block|,
literal|0x00101101
block|}
block|,
block|{
literal|0x00000095
block|,
literal|0x00000fff
block|}
block|,
block|{
literal|0x00000096
block|,
literal|0x00116fff
block|}
block|,
block|{
literal|0x00000097
block|,
literal|0x60010000
block|}
block|,
block|{
literal|0x00000098
block|,
literal|0x10010000
block|}
block|,
block|{
literal|0x00000099
block|,
literal|0x00006000
block|}
block|,
block|{
literal|0x0000009a
block|,
literal|0x00001000
block|}
block|,
block|{
literal|0x0000009f
block|,
literal|0x00936a00
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|caicos_io_mc_regs
index|[
name|BTC_IO_MC_REGS_SIZE
index|]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x00000077
block|,
literal|0xff010100
block|}
block|,
block|{
literal|0x00000078
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000079
block|,
literal|0x00001434
block|}
block|,
block|{
literal|0x0000007a
block|,
literal|0xcc08ec08
block|}
block|,
block|{
literal|0x0000007b
block|,
literal|0x00040000
block|}
block|,
block|{
literal|0x0000007c
block|,
literal|0x000080c0
block|}
block|,
block|{
literal|0x0000007d
block|,
literal|0x09000000
block|}
block|,
block|{
literal|0x0000007e
block|,
literal|0x00210404
block|}
block|,
block|{
literal|0x00000081
block|,
literal|0x08a8e800
block|}
block|,
block|{
literal|0x00000082
block|,
literal|0x00030444
block|}
block|,
block|{
literal|0x00000083
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000085
block|,
literal|0x00000001
block|}
block|,
block|{
literal|0x00000086
block|,
literal|0x00000002
block|}
block|,
block|{
literal|0x00000087
block|,
literal|0x48490000
block|}
block|,
block|{
literal|0x00000088
block|,
literal|0x20244647
block|}
block|,
block|{
literal|0x00000089
block|,
literal|0x00000005
block|}
block|,
block|{
literal|0x0000008b
block|,
literal|0x66030000
block|}
block|,
block|{
literal|0x0000008c
block|,
literal|0x00006603
block|}
block|,
block|{
literal|0x0000008d
block|,
literal|0x00000100
block|}
block|,
block|{
literal|0x0000008f
block|,
literal|0x00001c0a
block|}
block|,
block|{
literal|0x00000090
block|,
literal|0xff000001
block|}
block|,
block|{
literal|0x00000094
block|,
literal|0x00101101
block|}
block|,
block|{
literal|0x00000095
block|,
literal|0x00000fff
block|}
block|,
block|{
literal|0x00000096
block|,
literal|0x00116fff
block|}
block|,
block|{
literal|0x00000097
block|,
literal|0x60010000
block|}
block|,
block|{
literal|0x00000098
block|,
literal|0x10010000
block|}
block|,
block|{
literal|0x00000099
block|,
literal|0x00006000
block|}
block|,
block|{
literal|0x0000009a
block|,
literal|0x00001000
block|}
block|,
block|{
literal|0x0000009f
block|,
literal|0x00916a00
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|cayman_io_mc_regs
index|[
name|BTC_IO_MC_REGS_SIZE
index|]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x00000077
block|,
literal|0xff010100
block|}
block|,
block|{
literal|0x00000078
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000079
block|,
literal|0x00001434
block|}
block|,
block|{
literal|0x0000007a
block|,
literal|0xcc08ec08
block|}
block|,
block|{
literal|0x0000007b
block|,
literal|0x00040000
block|}
block|,
block|{
literal|0x0000007c
block|,
literal|0x000080c0
block|}
block|,
block|{
literal|0x0000007d
block|,
literal|0x09000000
block|}
block|,
block|{
literal|0x0000007e
block|,
literal|0x00210404
block|}
block|,
block|{
literal|0x00000081
block|,
literal|0x08a8e800
block|}
block|,
block|{
literal|0x00000082
block|,
literal|0x00030444
block|}
block|,
block|{
literal|0x00000083
block|,
literal|0x00000000
block|}
block|,
block|{
literal|0x00000085
block|,
literal|0x00000001
block|}
block|,
block|{
literal|0x00000086
block|,
literal|0x00000002
block|}
block|,
block|{
literal|0x00000087
block|,
literal|0x48490000
block|}
block|,
block|{
literal|0x00000088
block|,
literal|0x20244647
block|}
block|,
block|{
literal|0x00000089
block|,
literal|0x00000005
block|}
block|,
block|{
literal|0x0000008b
block|,
literal|0x66030000
block|}
block|,
block|{
literal|0x0000008c
block|,
literal|0x00006603
block|}
block|,
block|{
literal|0x0000008d
block|,
literal|0x00000100
block|}
block|,
block|{
literal|0x0000008f
block|,
literal|0x00001c0a
block|}
block|,
block|{
literal|0x00000090
block|,
literal|0xff000001
block|}
block|,
block|{
literal|0x00000094
block|,
literal|0x00101101
block|}
block|,
block|{
literal|0x00000095
block|,
literal|0x00000fff
block|}
block|,
block|{
literal|0x00000096
block|,
literal|0x00116fff
block|}
block|,
block|{
literal|0x00000097
block|,
literal|0x60010000
block|}
block|,
block|{
literal|0x00000098
block|,
literal|0x10010000
block|}
block|,
block|{
literal|0x00000099
block|,
literal|0x00006000
block|}
block|,
block|{
literal|0x0000009a
block|,
literal|0x00001000
block|}
block|,
block|{
literal|0x0000009f
block|,
literal|0x00976b00
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ni_mc_load_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|__be32
modifier|*
name|fw_data
decl_stmt|;
name|u32
name|mem_type
decl_stmt|,
name|running
decl_stmt|,
name|blackout
init|=
literal|0
decl_stmt|;
specifier|const
name|u32
modifier|*
name|io_mc_regs
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ucode_size
decl_stmt|,
name|regs_size
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|mc_fw
condition|)
return|return
operator|-
name|EINVAL
return|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_BARTS
case|:
name|io_mc_regs
operator|=
operator|&
name|barts_io_mc_regs
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|ucode_size
operator|=
name|BTC_MC_UCODE_SIZE
expr_stmt|;
name|regs_size
operator|=
name|BTC_IO_MC_REGS_SIZE
expr_stmt|;
break|break;
case|case
name|CHIP_TURKS
case|:
name|io_mc_regs
operator|=
operator|&
name|turks_io_mc_regs
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|ucode_size
operator|=
name|BTC_MC_UCODE_SIZE
expr_stmt|;
name|regs_size
operator|=
name|BTC_IO_MC_REGS_SIZE
expr_stmt|;
break|break;
case|case
name|CHIP_CAICOS
case|:
default|default:
name|io_mc_regs
operator|=
operator|&
name|caicos_io_mc_regs
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|ucode_size
operator|=
name|BTC_MC_UCODE_SIZE
expr_stmt|;
name|regs_size
operator|=
name|BTC_IO_MC_REGS_SIZE
expr_stmt|;
break|break;
case|case
name|CHIP_CAYMAN
case|:
name|io_mc_regs
operator|=
operator|&
name|cayman_io_mc_regs
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|ucode_size
operator|=
name|CAYMAN_MC_UCODE_SIZE
expr_stmt|;
name|regs_size
operator|=
name|BTC_IO_MC_REGS_SIZE
expr_stmt|;
break|break;
block|}
name|mem_type
operator|=
operator|(
name|RREG32
argument_list|(
name|MC_SEQ_MISC0
argument_list|)
operator|&
name|MC_SEQ_MISC0_GDDR5_MASK
operator|)
operator|>>
name|MC_SEQ_MISC0_GDDR5_SHIFT
expr_stmt|;
name|running
operator|=
name|RREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|)
operator|&
name|RUN_MASK
expr_stmt|;
if|if
condition|(
operator|(
name|mem_type
operator|==
name|MC_SEQ_MISC0_GDDR5_VALUE
operator|)
operator|&&
operator|(
name|running
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|running
condition|)
block|{
name|blackout
operator|=
name|RREG32
argument_list|(
name|MC_SHARED_BLACKOUT_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SHARED_BLACKOUT_CNTL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* reset the engine and set to writable */
name|WREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/* load mc io regs */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|regs_size
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|MC_SEQ_IO_DEBUG_INDEX
argument_list|,
name|io_mc_regs
index|[
operator|(
name|i
operator|<<
literal|1
operator|)
index|]
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SEQ_IO_DEBUG_DATA
argument_list|,
name|io_mc_regs
index|[
operator|(
name|i
operator|<<
literal|1
operator|)
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* load the MC ucode */
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|mc_fw
operator|->
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ucode_size
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|MC_SEQ_SUP_PGM
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
comment|/* put the engine back into the active state */
name|WREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|,
literal|0x00000004
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|MC_SEQ_SUP_CNTL
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
comment|/* wait for training to complete */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|MC_IO_PAD_CNTL_D0
argument_list|)
operator|&
name|MEM_FALL_OUT_CMD
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|running
condition|)
name|WREG32
argument_list|(
name|MC_SHARED_BLACKOUT_CNTL
argument_list|,
name|blackout
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ni_init_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|chip_name
decl_stmt|;
specifier|const
name|char
modifier|*
name|rlc_chip_name
decl_stmt|;
name|size_t
name|pfp_req_size
decl_stmt|,
name|me_req_size
decl_stmt|,
name|rlc_req_size
decl_stmt|,
name|mc_req_size
decl_stmt|;
name|char
name|fw_name
index|[
literal|30
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_BARTS
case|:
name|chip_name
operator|=
literal|"BARTS"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"BTC"
expr_stmt|;
name|pfp_req_size
operator|=
name|EVERGREEN_PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|EVERGREEN_PM4_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|rlc_req_size
operator|=
name|EVERGREEN_RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|mc_req_size
operator|=
name|BTC_MC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
break|break;
case|case
name|CHIP_TURKS
case|:
name|chip_name
operator|=
literal|"TURKS"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"BTC"
expr_stmt|;
name|pfp_req_size
operator|=
name|EVERGREEN_PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|EVERGREEN_PM4_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|rlc_req_size
operator|=
name|EVERGREEN_RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|mc_req_size
operator|=
name|BTC_MC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
break|break;
case|case
name|CHIP_CAICOS
case|:
name|chip_name
operator|=
literal|"CAICOS"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"BTC"
expr_stmt|;
name|pfp_req_size
operator|=
name|EVERGREEN_PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|EVERGREEN_PM4_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|rlc_req_size
operator|=
name|EVERGREEN_RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|mc_req_size
operator|=
name|BTC_MC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
break|break;
case|case
name|CHIP_CAYMAN
case|:
name|chip_name
operator|=
literal|"CAYMAN"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"CAYMAN"
expr_stmt|;
name|pfp_req_size
operator|=
name|CAYMAN_PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|CAYMAN_PM4_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|rlc_req_size
operator|=
name|CAYMAN_RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|mc_req_size
operator|=
name|CAYMAN_MC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
break|break;
case|case
name|CHIP_ARUBA
case|:
name|chip_name
operator|=
literal|"ARUBA"
expr_stmt|;
name|rlc_chip_name
operator|=
literal|"ARUBA"
expr_stmt|;
comment|/* pfp/me same size as CAYMAN */
name|pfp_req_size
operator|=
name|CAYMAN_PFP_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|me_req_size
operator|=
name|CAYMAN_PM4_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|rlc_req_size
operator|=
name|ARUBA_RLC_UCODE_SIZE
operator|*
literal|4
expr_stmt|;
name|mc_req_size
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: Unsupported family %d"
argument_list|,
name|__func__
argument_list|,
name|rdev
operator|->
name|family
argument_list|)
expr_stmt|;
block|}
name|DRM_INFO
argument_list|(
literal|"Loading %s Microcode\n"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_pfp"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pfp_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|->
name|datasize
operator|!=
name|pfp_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ni_cp: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|pfp_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_me"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|->
name|datasize
operator|!=
name|me_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ni_cp: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|me_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_rlc"
argument_list|,
name|rlc_chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|->
name|datasize
operator|!=
name|rlc_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ni_rlc: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|rlc_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
comment|/* no MC ucode on TN */
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
condition|)
block|{
name|snprintf
argument_list|(
name|fw_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fw_name
argument_list|)
argument_list|,
literal|"radeonkmsfw_%s_mc"
argument_list|,
name|chip_name
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mc_fw
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rdev
operator|->
name|mc_fw
operator|->
name|datasize
operator|!=
name|mc_req_size
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ni_mc: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|mc_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
block|}
name|out
label|:
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|!=
operator|-
name|EINVAL
condition|)
name|DRM_ERROR
argument_list|(
literal|"ni_cp: Failed to load firmware \"%s\"\n"
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|pfp_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pfp_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|me_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|rlc_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|mc_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|mc_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc_fw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/**  * ni_fini_microcode - drop the firmwares image references  *  * @rdev: radeon_device pointer  *  * Drop the pfp, me, mc and rlc firmwares image references.  * Called at driver shutdown.  */
end_comment

begin_function
name|void
name|ni_fini_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pfp_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|pfp_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pfp_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|me_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|rlc_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|rlc_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|rlc_fw
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|mc_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|mc_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc_fw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Core functions  */
end_comment

begin_function
specifier|static
name|void
name|cayman_gpu_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|gb_addr_config
init|=
literal|0
decl_stmt|;
name|u32
name|mc_shared_chmap
decl_stmt|,
name|mc_arb_ramcfg
decl_stmt|;
name|u32
name|cgts_tcc_disable
decl_stmt|;
name|u32
name|sx_debug_1
decl_stmt|;
name|u32
name|smx_dc_ctl0
decl_stmt|;
name|u32
name|cgts_sm_ctrl_reg
decl_stmt|;
name|u32
name|hdp_host_path_cntl
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|u32
name|disabled_rb_mask
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_CAYMAN
case|:
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_shader_engines
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_pipes_per_simd
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_tile_pipes
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_simds_per_se
operator|=
literal|12
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_backends_per_se
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_texture_channel_caches
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_threads
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_stack_entries
operator|=
literal|512
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_num_of_sets
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_max_export_pos_size
operator|=
literal|64
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_max_export_smx_size
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x100
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|CAYMAN_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
case|case
name|CHIP_ARUBA
case|:
default|default:
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_shader_engines
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_pipes_per_simd
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_tile_pipes
operator|=
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9900
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9901
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9905
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9906
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9907
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9908
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9909
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9910
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9917
operator|)
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_simds_per_se
operator|=
literal|6
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_backends_per_se
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9903
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9904
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x990A
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9913
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9918
operator|)
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_simds_per_se
operator|=
literal|4
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_backends_per_se
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9919
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9990
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9991
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x9994
operator|)
operator|||
operator|(
name|rdev
operator|->
name|ddev
operator|->
name|pci_device
operator|==
literal|0x99A0
operator|)
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_simds_per_se
operator|=
literal|3
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_backends_per_se
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_simds_per_se
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_backends_per_se
operator|=
literal|1
expr_stmt|;
block|}
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_texture_channel_caches
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_gprs
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_threads
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_gs_threads
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_stack_entries
operator|=
literal|512
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_num_of_sets
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_max_export_pos_size
operator|=
literal|64
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_max_export_smx_size
operator|=
literal|192
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sc_prim_fifo_size
operator|=
literal|0x40
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sc_earlyz_tile_fifo_size
operator|=
literal|0x130
expr_stmt|;
name|gb_addr_config
operator|=
name|ARUBA_GB_ADDR_CONFIG_GOLDEN
expr_stmt|;
break|break;
block|}
comment|/* Initialize HDP */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
operator|,
name|j
operator|+=
literal|0x18
control|)
block|{
name|WREG32
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|GRBM_CNTL
argument_list|,
name|GRBM_READ_TIMEOUT
argument_list|(
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
name|evergreen_fix_pci_max_read_req_size
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|mc_shared_chmap
operator|=
name|RREG32
argument_list|(
name|MC_SHARED_CHMAP
argument_list|)
expr_stmt|;
name|mc_arb_ramcfg
operator|=
name|RREG32
argument_list|(
name|MC_ARB_RAMCFG
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|mc_arb_ramcfg
operator|&
name|NOOFCOLS_MASK
operator|)
operator|>>
name|NOOFCOLS_SHIFT
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|mem_row_size_in_kb
operator|=
operator|(
literal|4
operator|*
operator|(
literal|1
operator|<<
operator|(
literal|8
operator|+
name|tmp
operator|)
operator|)
operator|)
operator|/
literal|1024
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|mem_row_size_in_kb
operator|>
literal|4
condition|)
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|mem_row_size_in_kb
operator|=
literal|4
expr_stmt|;
comment|/* XXX use MC settings? */
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|shader_engine_tile_size
operator|=
literal|32
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|num_gpus
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|multi_gpu_tile_size
operator|=
literal|64
expr_stmt|;
name|tmp
operator|=
operator|(
name|gb_addr_config
operator|&
name|NUM_PIPES_MASK
operator|)
operator|>>
name|NUM_PIPES_SHIFT
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|num_tile_pipes
operator|=
operator|(
literal|1
operator|<<
name|tmp
operator|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|gb_addr_config
operator|&
name|PIPE_INTERLEAVE_SIZE_MASK
operator|)
operator|>>
name|PIPE_INTERLEAVE_SIZE_SHIFT
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|mem_max_burst_length_bytes
operator|=
operator|(
name|tmp
operator|+
literal|1
operator|)
operator|*
literal|256
expr_stmt|;
name|tmp
operator|=
operator|(
name|gb_addr_config
operator|&
name|NUM_SHADER_ENGINES_MASK
operator|)
operator|>>
name|NUM_SHADER_ENGINES_SHIFT
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|num_shader_engines
operator|=
name|tmp
operator|+
literal|1
expr_stmt|;
name|tmp
operator|=
operator|(
name|gb_addr_config
operator|&
name|NUM_GPUS_MASK
operator|)
operator|>>
name|NUM_GPUS_SHIFT
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|num_gpus
operator|=
name|tmp
operator|+
literal|1
expr_stmt|;
name|tmp
operator|=
operator|(
name|gb_addr_config
operator|&
name|MULTI_GPU_TILE_SIZE_MASK
operator|)
operator|>>
name|MULTI_GPU_TILE_SIZE_SHIFT
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|multi_gpu_tile_size
operator|=
literal|1
operator|<<
name|tmp
expr_stmt|;
name|tmp
operator|=
operator|(
name|gb_addr_config
operator|&
name|ROW_SIZE_MASK
operator|)
operator|>>
name|ROW_SIZE_SHIFT
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|mem_row_size_in_kb
operator|=
literal|1
operator|<<
name|tmp
expr_stmt|;
comment|/* setup tiling info dword.  gb_addr_config is not adequate since it does 	 * not have bank info, so create a custom tiling dword. 	 * bits 3:0   num_pipes 	 * bits 7:4   num_banks 	 * bits 11:8  group_size 	 * bits 15:12 row_size 	 */
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|num_tile_pipes
condition|)
block|{
case|case
literal|1
case|:
default|default:
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator||=
operator|(
literal|0
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator||=
operator|(
literal|1
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator||=
operator|(
literal|2
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator||=
operator|(
literal|3
operator|<<
literal|0
operator|)
expr_stmt|;
break|break;
block|}
comment|/* num banks is 8 on all fusion asics. 0 = 4, 1 = 8, 2 = 16 */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator||=
literal|1
operator|<<
literal|4
expr_stmt|;
else|else
block|{
switch|switch
condition|(
operator|(
name|mc_arb_ramcfg
operator|&
name|NOOFBANK_MASK
operator|)
operator|>>
name|NOOFBANK_SHIFT
condition|)
block|{
case|case
literal|0
case|:
comment|/* four banks */
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator||=
literal|0
operator|<<
literal|4
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* eight banks */
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator||=
literal|1
operator|<<
literal|4
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* sixteen banks */
default|default:
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator||=
literal|2
operator|<<
literal|4
expr_stmt|;
break|break;
block|}
block|}
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator||=
operator|(
operator|(
name|gb_addr_config
operator|&
name|PIPE_INTERLEAVE_SIZE_MASK
operator|)
operator|>>
name|PIPE_INTERLEAVE_SIZE_SHIFT
operator|)
operator|<<
literal|8
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|tile_config
operator||=
operator|(
operator|(
name|gb_addr_config
operator|&
name|ROW_SIZE_MASK
operator|)
operator|>>
name|ROW_SIZE_SHIFT
operator|)
operator|<<
literal|12
expr_stmt|;
name|tmp
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
operator|(
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_shader_engines
operator|-
literal|1
operator|)
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|u32
name|rb_disable_bitmap
decl_stmt|;
name|WREG32
argument_list|(
name|GRBM_GFX_INDEX
argument_list|,
name|INSTANCE_BROADCAST_WRITES
operator||
name|SE_INDEX
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_GFX_INDEX
argument_list|,
name|INSTANCE_BROADCAST_WRITES
operator||
name|SE_INDEX
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|rb_disable_bitmap
operator|=
operator|(
name|RREG32
argument_list|(
name|CC_RB_BACKEND_DISABLE
argument_list|)
operator|&
literal|0x00ff0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|tmp
operator|<<=
literal|4
expr_stmt|;
name|tmp
operator||=
name|rb_disable_bitmap
expr_stmt|;
block|}
comment|/* enabled rb are just the one not disabled :) */
name|disabled_rb_mask
operator|=
name|tmp
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_GFX_INDEX
argument_list|,
name|INSTANCE_BROADCAST_WRITES
operator||
name|SE_BROADCAST_WRITES
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RLC_GFX_INDEX
argument_list|,
name|INSTANCE_BROADCAST_WRITES
operator||
name|SE_BROADCAST_WRITES
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GB_ADDR_CONFIG
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMIF_ADDR_CONFIG
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_ADDR_CONFIG
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_TILING_CONFIG
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_TILING_CONFIG
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
name|gb_addr_config
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|gb_addr_config
operator|&
name|NUM_PIPES_MASK
expr_stmt|;
name|tmp
operator|=
name|r6xx_remap_render_backend
argument_list|(
name|rdev
argument_list|,
name|tmp
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_backends_per_se
operator|*
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_shader_engines
argument_list|,
name|CAYMAN_MAX_BACKENDS
argument_list|,
name|disabled_rb_mask
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GB_BACKEND_MAP
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|cgts_tcc_disable
operator|=
literal|0xffff0000
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_texture_channel_caches
condition|;
name|i
operator|++
control|)
name|cgts_tcc_disable
operator|&=
operator|~
operator|(
literal|1
operator|<<
operator|(
literal|16
operator|+
name|i
operator|)
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_TCC_DISABLE
argument_list|,
name|cgts_tcc_disable
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_SYS_TCC_DISABLE
argument_list|,
name|cgts_tcc_disable
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_USER_SYS_TCC_DISABLE
argument_list|,
name|cgts_tcc_disable
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_USER_TCC_DISABLE
argument_list|,
name|cgts_tcc_disable
argument_list|)
expr_stmt|;
comment|/* reprogram the shader complex */
name|cgts_sm_ctrl_reg
operator|=
name|RREG32
argument_list|(
name|CGTS_SM_CTRL_REG
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CGTS_SM_CTRL_REG
argument_list|,
name|OVERRIDE
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CGTS_SM_CTRL_REG
argument_list|,
name|cgts_sm_ctrl_reg
argument_list|)
expr_stmt|;
comment|/* set HW defaults for 3D engine */
name|WREG32
argument_list|(
name|CP_MEQ_THRESHOLDS
argument_list|,
name|MEQ1_START
argument_list|(
literal|0x30
argument_list|)
operator||
name|MEQ2_START
argument_list|(
literal|0x60
argument_list|)
argument_list|)
expr_stmt|;
name|sx_debug_1
operator|=
name|RREG32
argument_list|(
name|SX_DEBUG_1
argument_list|)
expr_stmt|;
name|sx_debug_1
operator||=
name|ENABLE_NEW_SMX_ADDRESS
expr_stmt|;
name|WREG32
argument_list|(
name|SX_DEBUG_1
argument_list|,
name|sx_debug_1
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator|=
name|RREG32
argument_list|(
name|SMX_DC_CTL0
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator|&=
operator|~
name|NUMBER_OF_SETS
argument_list|(
literal|0x1ff
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator||=
name|NUMBER_OF_SETS
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_num_of_sets
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SMX_DC_CTL0
argument_list|,
name|smx_dc_ctl0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SPI_CONFIG_CNTL_1
argument_list|,
name|VTX_DONE_DELAY
argument_list|(
literal|4
argument_list|)
operator||
name|CRC_SIMD_ID_WADDR_DISABLE
argument_list|)
expr_stmt|;
comment|/* need to be explicitly zero-ed */
name|WREG32
argument_list|(
name|VGT_OFFCHIP_LDS_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_LSTMP_RING_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_HSTMP_RING_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_ESTMP_RING_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_GSTMP_RING_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_VSTMP_RING_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_PSTMP_RING_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|TA_CNTL_AUX
argument_list|,
name|DISABLE_CUBE_ANISO
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SX_EXPORT_BUFFER_SIZES
argument_list|,
operator|(
name|COLOR_BUFFER_SIZE
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_max_export_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator||
name|POSITION_BUFFER_SIZE
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_max_export_pos_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator||
name|SMX_BUFFER_SIZE
argument_list|(
operator|(
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sx_max_export_smx_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_FIFO_SIZE
argument_list|,
operator|(
name|SC_PRIM_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sc_prim_fifo_size
argument_list|)
operator||
name|SC_HIZ_TILE_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sc_hiz_tile_fifo_size
argument_list|)
operator||
name|SC_EARLYZ_TILE_FIFO_SIZE
argument_list|(
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sc_earlyz_tile_fifo_size
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_NUM_INSTANCES
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PERFMON_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_MS_FIFO_SIZES
argument_list|,
operator|(
name|CACHE_FIFO_SIZE
argument_list|(
literal|16
operator|*
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|sq_num_cf_insts
argument_list|)
operator||
name|FETCH_FIFO_HIWATER
argument_list|(
literal|0x4
argument_list|)
operator||
name|DONE_FIFO_HIWATER
argument_list|(
literal|0xe0
argument_list|)
operator||
name|ALU_UPDATE_FIFO_HIWATER
argument_list|(
literal|0x8
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_GPR_RESOURCE_MGMT_1
argument_list|,
name|NUM_CLAUSE_TEMP_GPRS
argument_list|(
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_CONFIG
argument_list|,
operator|(
name|VC_ENABLE
operator||
name|EXPORT_SRC_C
operator||
name|GFX_PRIO
argument_list|(
literal|0
argument_list|)
operator||
name|CS1_PRIO
argument_list|(
literal|0
argument_list|)
operator||
name|CS2_PRIO
argument_list|(
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SQ_DYN_GPR_CNTL_PS_FLUSH_REQ
argument_list|,
name|DYN_GPR_ENABLE
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_FORCE_EOV_MAX_CNTS
argument_list|,
operator|(
name|FORCE_EOV_MAX_CLK_CNT
argument_list|(
literal|4095
argument_list|)
operator||
name|FORCE_EOV_MAX_REZ_CNT
argument_list|(
literal|255
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_CACHE_INVALIDATION
argument_list|,
name|CACHE_INVALIDATION
argument_list|(
name|VC_AND_TC
argument_list|)
operator||
name|AUTO_INVLD_EN
argument_list|(
name|ES_AND_GS_AUTO
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VGT_GS_VERTEX_REUSE
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_SC_LINE_STIPPLE_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR0_SEL_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR0_SEL_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR1_SEL_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR1_SEL_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR2_SEL_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR2_SEL_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR3_SEL_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CB_PERF_CTR3_SEL_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|HDP_MISC_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|HDP_FLUSH_INVALIDATE_CACHE
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_MISC_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|hdp_host_path_cntl
operator|=
name|RREG32
argument_list|(
name|HDP_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|HDP_HOST_PATH_CNTL
argument_list|,
name|hdp_host_path_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|PA_CL_ENHANCE
argument_list|,
name|CLIP_VTX_REORDER_ENA
operator||
name|NUM_CLIP_SEQ
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * GART  */
end_comment

begin_function
name|void
name|cayman_pcie_gart_tlb_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* flush hdp cache */
name|WREG32
argument_list|(
name|HDP_MEM_COHERENCY_FLUSH_CNTL
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
comment|/* bits 0-7 are the VM contexts0-7 */
name|WREG32
argument_list|(
name|VM_INVALIDATE_REQUEST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cayman_pcie_gart_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"No VRAM object for PCIE GART.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_gart_table_vram_pin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|radeon_gart_restore
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|WREG32
argument_list|(
name|MC_VM_MX_L1_TLB_CNTL
argument_list|,
operator|(
literal|0xA
operator|<<
literal|7
operator|)
operator||
name|ENABLE_L1_TLB
operator||
name|ENABLE_L1_FRAGMENT_PROCESSING
operator||
name|SYSTEM_ACCESS_MODE_NOT_IN_SYS
operator||
name|ENABLE_ADVANCED_DRIVER_MODEL
operator||
name|SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU
argument_list|)
expr_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_CACHE
operator||
name|ENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|ENABLE_L2_PDE0_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
operator||
name|CONTEXT1_IDENTITY_ACCESS_MODE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
name|INVALIDATE_ALL_L1_TLBS
operator||
name|INVALIDATE_L2_CACHE
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|L2_CACHE_BIGK_ASSOCIATIVITY
operator||
name|L2_CACHE_BIGK_FRAGMENT_SIZE
argument_list|(
literal|6
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup context0 */
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_START_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_END_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
argument_list|,
name|rdev
operator|->
name|gart
operator|.
name|table_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PROTECTION_FAULT_DEFAULT_ADDR
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|rdev
operator|->
name|dummy_page
operator|.
name|addr
operator|>>
literal|12
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
argument_list|,
name|ENABLE_CONTEXT
operator||
name|PAGE_TABLE_DEPTH
argument_list|(
literal|0
argument_list|)
operator||
name|RANGE_PROTECTION_FAULT_ENABLE_DEFAULT
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x15D4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x15D8
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
literal|0x15DC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* empty context1-7 */
comment|/* Assign the pt base to something valid for now; the pts used for 	 * the VMs are determined by the application and setup and assigned 	 * on the fly in the vm part of radeon_gart.c 	 */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_START_ADDR
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_END_ADDR
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
argument_list|,
name|rdev
operator|->
name|vm_manager
operator|.
name|max_pfn
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
argument_list|,
name|rdev
operator|->
name|gart
operator|.
name|table_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
block|}
comment|/* enable context1-7 */
name|WREG32
argument_list|(
name|VM_CONTEXT1_PROTECTION_FAULT_DEFAULT_ADDR
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|rdev
operator|->
name|dummy_page
operator|.
name|addr
operator|>>
literal|12
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT1_CNTL2
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT1_CNTL
argument_list|,
name|ENABLE_CONTEXT
operator||
name|PAGE_TABLE_DEPTH
argument_list|(
literal|1
argument_list|)
operator||
name|RANGE_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|RANGE_PROTECTION_FAULT_ENABLE_DEFAULT
operator||
name|DUMMY_PAGE_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|DUMMY_PAGE_PROTECTION_FAULT_ENABLE_DEFAULT
operator||
name|PDE0_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|PDE0_PROTECTION_FAULT_ENABLE_DEFAULT
operator||
name|VALID_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|VALID_PROTECTION_FAULT_ENABLE_DEFAULT
operator||
name|READ_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|READ_PROTECTION_FAULT_ENABLE_DEFAULT
operator||
name|WRITE_PROTECTION_FAULT_ENABLE_INTERRUPT
operator||
name|WRITE_PROTECTION_FAULT_ENABLE_DEFAULT
argument_list|)
expr_stmt|;
name|cayman_pcie_gart_tlb_flush
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"PCIE GART of %uM enabled (table at 0x%016llX).\n"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|ready
operator|=
name|true
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cayman_pcie_gart_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* Disable all tables */
name|WREG32
argument_list|(
name|VM_CONTEXT0_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_CONTEXT1_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Setup TLB control */
name|WREG32
argument_list|(
name|MC_VM_MX_L1_TLB_CNTL
argument_list|,
name|ENABLE_L1_FRAGMENT_PROCESSING
operator||
name|SYSTEM_ACCESS_MODE_NOT_IN_SYS
operator||
name|SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU
argument_list|)
expr_stmt|;
comment|/* Setup L2 cache */
name|WREG32
argument_list|(
name|VM_L2_CNTL
argument_list|,
name|ENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|ENABLE_L2_PDE0_CACHE_LRU_UPDATE_BY_WRITE
operator||
name|EFFECTIVE_L2_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
operator||
name|CONTEXT1_IDENTITY_ACCESS_MODE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|VM_L2_CNTL3
argument_list|,
name|L2_CACHE_BIGK_ASSOCIATIVITY
operator||
name|L2_CACHE_BIGK_FRAGMENT_SIZE
argument_list|(
literal|6
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_unpin
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cayman_pcie_gart_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|cayman_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_table_vram_free
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cayman_cp_int_cntl_setup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|ring
parameter_list|,
name|u32
name|cp_int_cntl
parameter_list|)
block|{
name|u32
name|srbm_gfx_cntl
init|=
name|RREG32
argument_list|(
name|SRBM_GFX_CNTL
argument_list|)
operator|&
operator|~
literal|3
decl_stmt|;
name|WREG32
argument_list|(
name|SRBM_GFX_CNTL
argument_list|,
name|srbm_gfx_cntl
operator||
operator|(
name|ring
operator|&
literal|3
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_INT_CNTL
argument_list|,
name|cp_int_cntl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * CP.  */
end_comment

begin_function
name|void
name|cayman_fence_ring_emit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_fence
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|fence
operator|->
name|ring
index|]
decl_stmt|;
name|u64
name|addr
init|=
name|rdev
operator|->
name|fence_drv
index|[
name|fence
operator|->
name|ring
index|]
operator|.
name|gpu_addr
decl_stmt|;
comment|/* flush read cache over gart for this vmid */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|CP_COHER_CNTL2
operator|-
name|PACKET3_SET_CONFIG_REG_START
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SURFACE_SYNC
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_TC_ACTION_ENA
operator||
name|PACKET3_SH_ACTION_ENA
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* poll interval */
comment|/* EVENT_WRITE_EOP - flush caches, send int */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_EVENT_WRITE_EOP
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|EVENT_TYPE
argument_list|(
name|CACHE_FLUSH_AND_INV_EVENT_TS
argument_list|)
operator||
name|EVENT_INDEX
argument_list|(
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|addr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|upper_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xff
operator|)
operator||
name|DATA_SEL
argument_list|(
literal|1
argument_list|)
operator||
name|INT_SEL
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|fence
operator|->
name|seq
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cayman_ring_ib_execute
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ib
operator|->
name|ring
index|]
decl_stmt|;
comment|/* set to DX10/11 mode */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_MODE_CONTROL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|rptr_save_reg
condition|)
block|{
name|uint32_t
name|next_rptr
init|=
name|ring
operator|->
name|wptr
operator|+
literal|3
operator|+
literal|4
operator|+
literal|8
decl_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
operator|(
name|ring
operator|->
name|rptr_save_reg
operator|-
name|PACKET3_SET_CONFIG_REG_START
operator|)
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_INDIRECT_BUFFER
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
operator|(
literal|2
operator|<<
literal|0
operator|)
operator||
endif|#
directive|endif
operator|(
name|ib
operator|->
name|gpu_addr
operator|&
literal|0xFFFFFFFC
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|ib
operator|->
name|gpu_addr
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ib
operator|->
name|length_dw
operator||
operator|(
name|ib
operator|->
name|vm
condition|?
operator|(
name|ib
operator|->
name|vm
operator|->
name|id
operator|<<
literal|24
operator|)
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
comment|/* flush read cache over gart for this vmid */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|CP_COHER_CNTL2
operator|-
name|PACKET3_SET_CONFIG_REG_START
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ib
operator|->
name|vm
condition|?
name|ib
operator|->
name|vm
operator|->
name|id
else|:
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_SURFACE_SYNC
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_TC_ACTION_ENA
operator||
name|PACKET3_SH_ACTION_ENA
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* poll interval */
block|}
end_function

begin_function
specifier|static
name|void
name|cayman_cp_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
if|if
condition|(
name|enable
condition|)
name|WREG32
argument_list|(
name|CP_ME_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|radeon_ttm_set_active_vram_size
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_CNTL
argument_list|,
operator|(
name|CP_ME_HALT
operator||
name|CP_PFP_HALT
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|cayman_cp_load_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|__be32
modifier|*
name|fw_data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
condition|)
return|return
operator|-
name|EINVAL
return|;
name|cayman_cp_enable
argument_list|(
name|rdev
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|pfp_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CAYMAN_PFP_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_PFP_UCODE_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|me_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CAYMAN_PM4_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|CP_ME_RAM_DATA
argument_list|,
name|be32_to_cpup
argument_list|(
name|fw_data
operator|++
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_ME_RAM_RADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cayman_cp_start
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|int
name|r
decl_stmt|,
name|i
decl_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to lock ring (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_ME_INITIALIZE
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|cayman
operator|.
name|max_hw_contexts
operator|-
literal|1
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_ME_INITIALIZE_DEVICE_ID
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|cayman_cp_enable
argument_list|(
name|rdev
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|cayman_default_size
operator|+
literal|19
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to lock ring (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* setup clear context state */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_PREAMBLE_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_PREAMBLE_BEGIN_CLEAR_STATE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cayman_default_size
condition|;
name|i
operator|++
control|)
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|cayman_default_state
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_PREAMBLE_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3_PREAMBLE_END_CLEAR_STATE
argument_list|)
expr_stmt|;
comment|/* set clear context state */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_CLEAR_STATE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* SQ_VTX_BASE_VTX_LOC */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xc0026f00
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* Clear consts */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xc0036f00
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000bc4
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xc0026900
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000316
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x0000000e
argument_list|)
expr_stmt|;
comment|/* VGT_VERTEX_REUSE_BLOCK_CNTL */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/*  */
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
comment|/* XXX init other rings */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cayman_cp_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|cayman_cp_enable
argument_list|(
name|rdev
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|radeon_ring_fini
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|ring
operator|->
name|rptr_save_reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cayman_cp_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|static
specifier|const
name|int
name|ridx
index|[]
init|=
block|{
name|RADEON_RING_TYPE_GFX_INDEX
block|,
name|CAYMAN_RING_TYPE_CP1_INDEX
block|,
name|CAYMAN_RING_TYPE_CP2_INDEX
block|}
decl_stmt|;
specifier|static
specifier|const
name|unsigned
name|cp_rb_cntl
index|[]
init|=
block|{
name|CP_RB0_CNTL
block|,
name|CP_RB1_CNTL
block|,
name|CP_RB2_CNTL
block|, 	}
decl_stmt|;
specifier|static
specifier|const
name|unsigned
name|cp_rb_rptr_addr
index|[]
init|=
block|{
name|CP_RB0_RPTR_ADDR
block|,
name|CP_RB1_RPTR_ADDR
block|,
name|CP_RB2_RPTR_ADDR
block|}
decl_stmt|;
specifier|static
specifier|const
name|unsigned
name|cp_rb_rptr_addr_hi
index|[]
init|=
block|{
name|CP_RB0_RPTR_ADDR_HI
block|,
name|CP_RB1_RPTR_ADDR_HI
block|,
name|CP_RB2_RPTR_ADDR_HI
block|}
decl_stmt|;
specifier|static
specifier|const
name|unsigned
name|cp_rb_base
index|[]
init|=
block|{
name|CP_RB0_BASE
block|,
name|CP_RB1_BASE
block|,
name|CP_RB2_BASE
block|}
decl_stmt|;
name|struct
name|radeon_ring
modifier|*
name|ring
decl_stmt|;
name|int
name|i
decl_stmt|,
name|r
decl_stmt|;
comment|/* Reset cp; if cp is reset, then PA, SH, VGT also need to be reset */
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
operator|(
name|SOFT_RESET_CP
operator||
name|SOFT_RESET_PA
operator||
name|SOFT_RESET_SH
operator||
name|SOFT_RESET_VGT
operator||
name|SOFT_RESET_SPI
operator||
name|SOFT_RESET_SX
operator|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_SEM_WAIT_TIMER
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_SEM_INCOMPLETE_TIMER_CNTL
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* Set the write pointer delay */
name|WREG32
argument_list|(
name|CP_RB_WPTR_DELAY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|CP_DEBUG
argument_list|,
operator|(
literal|1
operator|<<
literal|27
operator|)
argument_list|)
expr_stmt|;
comment|/* set the wb address whether it's enabled or not */
name|WREG32
argument_list|(
name|SCRATCH_ADDR
argument_list|,
operator|(
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_SCRATCH_OFFSET
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SCRATCH_UMSK
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
operator|++
name|i
control|)
block|{
name|uint32_t
name|rb_cntl
decl_stmt|;
name|uint64_t
name|addr
decl_stmt|;
comment|/* Set ring buffer size */
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ridx
index|[
name|i
index|]
index|]
expr_stmt|;
name|rb_cntl
operator|=
name|drm_order
argument_list|(
name|ring
operator|->
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|rb_cntl
operator||=
name|drm_order
argument_list|(
name|RADEON_GPU_PAGE_SIZE
operator|/
literal|8
argument_list|)
operator|<<
literal|8
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|rb_cntl
operator||=
name|BUF_SWAP_32BIT
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|cp_rb_cntl
index|[
name|i
index|]
argument_list|,
name|rb_cntl
argument_list|)
expr_stmt|;
comment|/* set the wb address whether it's enabled or not */
name|addr
operator|=
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP_RPTR_OFFSET
expr_stmt|;
name|WREG32
argument_list|(
name|cp_rb_rptr_addr
index|[
name|i
index|]
argument_list|,
name|addr
operator|&
literal|0xFFFFFFFC
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|cp_rb_rptr_addr_hi
index|[
name|i
index|]
argument_list|,
name|upper_32_bits
argument_list|(
name|addr
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
block|}
comment|/* set the rb base addr, this causes an internal reset of ALL rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
operator|++
name|i
control|)
block|{
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ridx
index|[
name|i
index|]
index|]
expr_stmt|;
name|WREG32
argument_list|(
name|cp_rb_base
index|[
name|i
index|]
argument_list|,
name|ring
operator|->
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
operator|++
name|i
control|)
block|{
comment|/* Initialize the ring buffer's read and write pointers */
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ridx
index|[
name|i
index|]
index|]
expr_stmt|;
name|WREG32_P
argument_list|(
name|cp_rb_cntl
index|[
name|i
index|]
argument_list|,
name|RB_RPTR_WR_ENA
argument_list|,
operator|~
name|RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr
operator|=
name|ring
operator|->
name|wptr
operator|=
literal|0
expr_stmt|;
name|WREG32
argument_list|(
name|ring
operator|->
name|rptr_reg
argument_list|,
name|ring
operator|->
name|rptr
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|ring
operator|->
name|wptr_reg
argument_list|,
name|ring
operator|->
name|wptr
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32_P
argument_list|(
name|cp_rb_cntl
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
operator|~
name|RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
block|}
comment|/* start the rings */
name|cayman_cp_start
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ready
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
comment|/* this only test cp0 */
name|r
operator|=
name|radeon_ring_test
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP1_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_CP2_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * DMA  * Starting with R600, the GPU has an asynchronous  * DMA engine.  The programming model is very similar  * to the 3D engine (ring buffer, IBs, etc.), but the  * DMA controller has it's own packet format that is  * different form the PM4 format used by the 3D engine.  * It supports copying data, writing embedded data,  * solid fills, and a number of other things.  It also  * has support for tiling/detiling of buffers.  * Cayman and newer support two asynchronous DMA engines.  */
end_comment

begin_comment
comment|/**  * cayman_dma_ring_ib_execute - Schedule an IB on the DMA engine  *  * @rdev: radeon_device pointer  * @ib: IB object to schedule  *  * Schedule an IB in the DMA ring (cayman-SI).  */
end_comment

begin_function
name|void
name|cayman_dma_ring_ib_execute
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ib
operator|->
name|ring
index|]
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
block|{
name|u32
name|next_rptr
init|=
name|ring
operator|->
name|wptr
operator|+
literal|4
decl_stmt|;
while|while
condition|(
operator|(
name|next_rptr
operator|&
literal|7
operator|)
operator|!=
literal|5
condition|)
name|next_rptr
operator|++
expr_stmt|;
name|next_rptr
operator|+=
literal|3
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ring
operator|->
name|next_rptr_gpu_addr
operator|&
literal|0xfffffffc
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|ring
operator|->
name|next_rptr_gpu_addr
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
block|}
comment|/* The indirect buffer packet must end on an 8 DW boundary in the DMA ring. 	 * Pad as necessary with NOPs. 	 */
while|while
condition|(
operator|(
name|ring
operator|->
name|wptr
operator|&
literal|7
operator|)
operator|!=
literal|5
condition|)
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_NOP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_IB_PACKET
argument_list|(
name|DMA_PACKET_INDIRECT_BUFFER
argument_list|,
name|ib
operator|->
name|vm
condition|?
name|ib
operator|->
name|vm
operator|->
name|id
else|:
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|ib
operator|->
name|gpu_addr
operator|&
literal|0xFFFFFFE0
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|ib
operator|->
name|length_dw
operator|<<
literal|12
operator|)
operator||
operator|(
name|upper_32_bits
argument_list|(
name|ib
operator|->
name|gpu_addr
argument_list|)
operator|&
literal|0xFF
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * cayman_dma_stop - stop the async dma engines  *  * @rdev: radeon_device pointer  *  * Stop the async dma engines (cayman-SI).  */
end_comment

begin_function
name|void
name|cayman_dma_stop
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|rb_cntl
decl_stmt|;
name|radeon_ttm_set_active_vram_size
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
argument_list|)
expr_stmt|;
comment|/* dma0 */
name|rb_cntl
operator|=
name|RREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rb_cntl
operator|&=
operator|~
name|DMA_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
name|rb_cntl
argument_list|)
expr_stmt|;
comment|/* dma1 */
name|rb_cntl
operator|=
name|RREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|rb_cntl
operator|&=
operator|~
name|DMA_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
name|rb_cntl
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_DMA1_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * cayman_dma_resume - setup and start the async dma engines  *  * @rdev: radeon_device pointer  *  * Set up the DMA ring buffers and enable them. (cayman-SI).  * Returns 0 for success, error for failure.  */
end_comment

begin_function
name|int
name|cayman_dma_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
decl_stmt|;
name|u32
name|rb_cntl
decl_stmt|,
name|dma_cntl
decl_stmt|,
name|ib_cntl
decl_stmt|;
name|u32
name|rb_bufsz
decl_stmt|;
name|u32
name|reg_offset
decl_stmt|,
name|wb_offset
decl_stmt|;
name|int
name|i
decl_stmt|,
name|r
decl_stmt|;
comment|/* Reset dma */
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
name|SOFT_RESET_DMA
operator||
name|SOFT_RESET_DMA1
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
expr_stmt|;
name|reg_offset
operator|=
name|DMA0_REGISTER_OFFSET
expr_stmt|;
name|wb_offset
operator|=
name|R600_WB_DMA_RPTR_OFFSET
expr_stmt|;
block|}
else|else
block|{
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_DMA1_INDEX
index|]
expr_stmt|;
name|reg_offset
operator|=
name|DMA1_REGISTER_OFFSET
expr_stmt|;
name|wb_offset
operator|=
name|CAYMAN_WB_DMA1_RPTR_OFFSET
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|DMA_SEM_INCOMPLETE_TIMER_CNTL
operator|+
name|reg_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_SEM_WAIT_FAIL_TIMER_CNTL
operator|+
name|reg_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set ring buffer size in dwords */
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|ring
operator|->
name|ring_size
operator|/
literal|4
argument_list|)
expr_stmt|;
name|rb_cntl
operator|=
name|rb_bufsz
operator|<<
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|rb_cntl
operator||=
name|DMA_RB_SWAP_ENABLE
operator||
name|DMA_RPTR_WRITEBACK_SWAP_ENABLE
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|reg_offset
argument_list|,
name|rb_cntl
argument_list|)
expr_stmt|;
comment|/* Initialize the ring buffer's read and write pointers */
name|WREG32
argument_list|(
name|DMA_RB_RPTR
operator|+
name|reg_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_WPTR
operator|+
name|reg_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set the wb address whether it's enabled or not */
name|WREG32
argument_list|(
name|DMA_RB_RPTR_ADDR_HI
operator|+
name|reg_offset
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|wb_offset
argument_list|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_RPTR_ADDR_LO
operator|+
name|reg_offset
argument_list|,
operator|(
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|wb_offset
operator|)
operator|&
literal|0xFFFFFFFC
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|rb_cntl
operator||=
name|DMA_RPTR_WRITEBACK_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_BASE
operator|+
name|reg_offset
argument_list|,
name|ring
operator|->
name|gpu_addr
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* enable DMA IBs */
name|ib_cntl
operator|=
name|DMA_IB_ENABLE
operator||
name|CMD_VMID_FORCE
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|ib_cntl
operator||=
name|DMA_IB_SWAP_ENABLE
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|DMA_IB_CNTL
operator|+
name|reg_offset
argument_list|,
name|ib_cntl
argument_list|)
expr_stmt|;
name|dma_cntl
operator|=
name|RREG32
argument_list|(
name|DMA_CNTL
operator|+
name|reg_offset
argument_list|)
expr_stmt|;
name|dma_cntl
operator|&=
operator|~
name|CTXEMPTY_INT_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_CNTL
operator|+
name|reg_offset
argument_list|,
name|dma_cntl
argument_list|)
expr_stmt|;
name|ring
operator|->
name|wptr
operator|=
literal|0
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_WPTR
operator|+
name|reg_offset
argument_list|,
name|ring
operator|->
name|wptr
operator|<<
literal|2
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr
operator|=
name|RREG32
argument_list|(
name|DMA_RB_RPTR
operator|+
name|reg_offset
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|reg_offset
argument_list|,
name|rb_cntl
operator||
name|DMA_RB_ENABLE
argument_list|)
expr_stmt|;
name|ring
operator|->
name|ready
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|radeon_ring_test
argument_list|(
name|rdev
argument_list|,
name|ring
operator|->
name|idx
argument_list|,
name|ring
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|ring
operator|->
name|ready
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
name|radeon_ttm_set_active_vram_size
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * cayman_dma_fini - tear down the async dma engines  *  * @rdev: radeon_device pointer  *  * Stop the async dma engines and free the rings (cayman-SI).  */
end_comment

begin_function
name|void
name|cayman_dma_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|cayman_dma_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ring_fini
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
argument_list|)
expr_stmt|;
name|radeon_ring_fini
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_DMA1_INDEX
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cayman_gpu_soft_reset_gfx
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|grbm_reset
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
operator|&
name|GUI_ACTIVE
operator|)
condition|)
return|return;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS               = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE0           = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE0
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE1           = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  SRBM_STATUS               = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|SRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008674_CP_STALLED_STAT1 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008678_CP_STALLED_STAT2 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT2
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00867C_CP_BUSY_STAT     = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_BUSY_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008680_CP_STAT          = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Disable CP parsing/prefetching */
name|WREG32
argument_list|(
name|CP_ME_CNTL
argument_list|,
name|CP_ME_HALT
operator||
name|CP_PFP_HALT
argument_list|)
expr_stmt|;
comment|/* reset all the gfx blocks */
name|grbm_reset
operator|=
operator|(
name|SOFT_RESET_CP
operator||
name|SOFT_RESET_CB
operator||
name|SOFT_RESET_DB
operator||
name|SOFT_RESET_GDS
operator||
name|SOFT_RESET_PA
operator||
name|SOFT_RESET_SC
operator||
name|SOFT_RESET_SPI
operator||
name|SOFT_RESET_SH
operator||
name|SOFT_RESET_SX
operator||
name|SOFT_RESET_TC
operator||
name|SOFT_RESET_TA
operator||
name|SOFT_RESET_VGT
operator||
name|SOFT_RESET_IA
operator|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_SOFT_RESET=0x%08X\n"
argument_list|,
name|grbm_reset
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
name|grbm_reset
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS               = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE0           = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE0
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  GRBM_STATUS_SE1           = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|GRBM_STATUS_SE1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  SRBM_STATUS               = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|SRBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008674_CP_STALLED_STAT1 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT1
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008678_CP_STALLED_STAT2 = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STALLED_STAT2
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00867C_CP_BUSY_STAT     = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_BUSY_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_008680_CP_STAT          = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cayman_gpu_soft_reset_dma
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
operator|&
name|DMA_IDLE
condition|)
return|return;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00D034_DMA_STATUS_REG   = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
argument_list|)
expr_stmt|;
comment|/* dma0 */
name|tmp
operator|=
name|RREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|DMA_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* dma1 */
name|tmp
operator|=
name|RREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|DMA_RB_ENABLE
expr_stmt|;
name|WREG32
argument_list|(
name|DMA_RB_CNTL
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Reset dma */
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
name|SOFT_RESET_DMA
operator||
name|SOFT_RESET_DMA1
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|SRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  R_00D034_DMA_STATUS_REG   = 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cayman_gpu_soft_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|reset_mask
parameter_list|)
block|{
name|struct
name|evergreen_mc_save
name|save
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|GRBM_STATUS
argument_list|)
operator|&
name|GUI_ACTIVE
operator|)
condition|)
name|reset_mask
operator|&=
operator|~
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator|)
expr_stmt|;
if|if
condition|(
name|RREG32
argument_list|(
name|DMA_STATUS_REG
argument_list|)
operator|&
name|DMA_IDLE
condition|)
name|reset_mask
operator|&=
operator|~
name|RADEON_RESET_DMA
expr_stmt|;
if|if
condition|(
name|reset_mask
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU softreset: 0x%08X\n"
argument_list|,
name|reset_mask
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  VM_CONTEXT0_PROTECTION_FAULT_ADDR   0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
literal|0x14F8
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  VM_CONTEXT0_PROTECTION_FAULT_STATUS 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
literal|0x14D8
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  VM_CONTEXT1_PROTECTION_FAULT_ADDR   0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
literal|0x14FC
argument_list|)
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"  VM_CONTEXT1_PROTECTION_FAULT_STATUS 0x%08X\n"
argument_list|,
name|RREG32
argument_list|(
literal|0x14DC
argument_list|)
argument_list|)
expr_stmt|;
name|evergreen_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|evergreen_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timedout !\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reset_mask
operator|&
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator|)
condition|)
name|cayman_gpu_soft_reset_gfx
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset_mask
operator|&
name|RADEON_RESET_DMA
condition|)
name|cayman_gpu_soft_reset_dma
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Wait a little for things to settle down */
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|evergreen_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cayman_asic_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
return|return
name|cayman_gpu_soft_reset
argument_list|(
name|rdev
argument_list|,
operator|(
name|RADEON_RESET_GFX
operator||
name|RADEON_RESET_COMPUTE
operator||
name|RADEON_RESET_DMA
operator|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * cayman_dma_is_lockup - Check if the DMA engine is locked up  *  * @rdev: radeon_device pointer  * @ring: radeon_ring structure holding ring information  *  * Check if the async DMA engine is locked up (cayman-SI).  * Returns true if the engine appears to be locked up, false if not.  */
end_comment

begin_function
name|bool
name|cayman_dma_is_lockup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|u32
name|dma_status_reg
decl_stmt|;
if|if
condition|(
name|ring
operator|->
name|idx
operator|==
name|R600_RING_TYPE_DMA_INDEX
condition|)
name|dma_status_reg
operator|=
name|RREG32
argument_list|(
name|DMA_STATUS_REG
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|)
expr_stmt|;
else|else
name|dma_status_reg
operator|=
name|RREG32
argument_list|(
name|DMA_STATUS_REG
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|dma_status_reg
operator|&
name|DMA_IDLE
condition|)
block|{
name|radeon_ring_lockup_update
argument_list|(
name|ring
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* force ring activities */
name|radeon_ring_force_activity
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|radeon_ring_test_lockup
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cayman_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* enable pcie gen2 link */
name|evergreen_pcie_gen2_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
operator|||
operator|!
name|rdev
operator|->
name|rlc_fw
condition|)
block|{
name|r
operator|=
name|ni_init_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
operator|||
operator|!
name|rdev
operator|->
name|pfp_fw
operator|||
operator|!
name|rdev
operator|->
name|rlc_fw
operator|||
operator|!
name|rdev
operator|->
name|mc_fw
condition|)
block|{
name|r
operator|=
name|ni_init_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
name|r
operator|=
name|ni_mc_load_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load MC firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
name|r
operator|=
name|r600_vram_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|evergreen_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r
operator|=
name|cayman_pcie_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|cayman_gpu_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r
operator|=
name|evergreen_blit_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|r600_blit_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|asic
operator|->
name|copy
operator|.
name|copy
operator|=
name|NULL
expr_stmt|;
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed blitter (%d) falling back to memcpy\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
comment|/* allocate rlc buffers */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
name|r
operator|=
name|si_rlc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to init rlc BOs!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP1_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_CP2_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|R600_RING_TYPE_DMA_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing DMA fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|CAYMAN_RING_TYPE_DMA1_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing DMA fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|r
operator|=
name|r600_irq_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: IH init failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|evergreen_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|RADEON_WB_CP_RPTR_OFFSET
argument_list|,
name|CP_RB0_RPTR
argument_list|,
name|CP_RB0_WPTR
argument_list|,
literal|0
argument_list|,
literal|0xfffff
argument_list|,
name|RADEON_CP_PACKET2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|R600_WB_DMA_RPTR_OFFSET
argument_list|,
name|DMA_RB_RPTR
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
name|DMA_RB_WPTR
operator|+
name|DMA0_REGISTER_OFFSET
argument_list|,
literal|2
argument_list|,
literal|0x3fffc
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_NOP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_DMA1_INDEX
index|]
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring
operator|->
name|ring_size
argument_list|,
name|CAYMAN_WB_DMA1_RPTR_OFFSET
argument_list|,
name|DMA_RB_RPTR
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
name|DMA_RB_WPTR
operator|+
name|DMA1_REGISTER_OFFSET
argument_list|,
literal|2
argument_list|,
literal|0x3fffc
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_NOP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|cayman_cp_load_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|cayman_cp_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|cayman_dma_resume
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_vm_manager_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"vm manager initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|r600_audio_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cayman_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Do not reset GPU before posting, on rv770 hw unlike on r500 hw, 	 * posting will perform necessary task to bring back GPU into good 	 * shape. 	 */
comment|/* post card */
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|cayman_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"cayman startup failed on resume\n"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|cayman_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_audio_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|cayman_cp_enable
argument_list|(
name|rdev
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|cayman_dma_stop
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|evergreen_irq_suspend
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|cayman_pcie_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Plan is to move initialization in that function and use  * helper function so that radeon_device_init pretty much  * do nothing more than calling asic specific function. This  * should also allow to remove a bunch of callback function  * like vram_info.  */
end_comment

begin_function
name|int
name|cayman_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* Read BIOS */
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Must be an ATOMBIOS */
if|if
condition|(
operator|!
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting atombios for cayman GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|r
operator|=
name|radeon_atombios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Post card if necessary */
if|if
condition|(
operator|!
name|radeon_card_posted
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Card not posted and no BIOS - ignoring\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_INFO
argument_list|(
literal|"GPU not posted. posting now...\n"
argument_list|)
expr_stmt|;
name|atom_asic_init
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize scratch registers */
name|r600_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* initialize memory controller */
name|r
operator|=
name|evergreen_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ring
operator|->
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|R600_RING_TYPE_DMA_INDEX
index|]
expr_stmt|;
name|ring
operator|->
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|CAYMAN_RING_TYPE_DMA1_INDEX
index|]
expr_stmt|;
name|ring
operator|->
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ih
operator|.
name|ring_obj
operator|=
name|NULL
expr_stmt|;
name|r600_ih_ring_init
argument_list|(
name|rdev
argument_list|,
literal|64
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|r
operator|=
name|r600_pcie_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|cayman_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|cayman_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|cayman_dma_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_irq_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
name|si_rlc_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_vm_manager_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|cayman_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
comment|/* Don't start up if the MC ucode is missing. 	 * The default clocks and voltages before the MC ucode 	 * is loaded are not suffient for advanced operations. 	 * 	 * We can skip this check for TN, because there is no MC 	 * ucode. 	 */
if|if
condition|(
operator|!
name|rdev
operator|->
name|mc_fw
operator|&&
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: MC ucode required for NI+.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|cayman_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r600_blit_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|cayman_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|cayman_dma_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_irq_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
name|si_rlc_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_vm_manager_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|cayman_pcie_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r600_vram_scratch_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|ni_fini_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vm  */
end_comment

begin_function
name|int
name|cayman_vm_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* number of VMs */
name|rdev
operator|->
name|vm_manager
operator|.
name|nvm
operator|=
literal|8
expr_stmt|;
comment|/* base offset of vram pages */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
name|u64
name|tmp
init|=
name|RREG32
argument_list|(
name|FUS_MC_VM_FB_OFFSET
argument_list|)
decl_stmt|;
name|tmp
operator|<<=
literal|22
expr_stmt|;
name|rdev
operator|->
name|vm_manager
operator|.
name|vram_base_offset
operator|=
name|tmp
expr_stmt|;
block|}
else|else
name|rdev
operator|->
name|vm_manager
operator|.
name|vram_base_offset
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|cayman_vm_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{ }
end_function

begin_define
define|#
directive|define
name|R600_ENTRY_VALID
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|R600_PTE_SYSTEM
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|R600_PTE_SNOOPED
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|R600_PTE_READABLE
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|R600_PTE_WRITEABLE
value|(1<< 6)
end_define

begin_function
name|uint32_t
name|cayman_vm_page_flags
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|uint32_t
name|r600_flags
init|=
literal|0
decl_stmt|;
name|r600_flags
operator||=
operator|(
name|flags
operator|&
name|RADEON_VM_PAGE_VALID
operator|)
condition|?
name|R600_ENTRY_VALID
else|:
literal|0
expr_stmt|;
name|r600_flags
operator||=
operator|(
name|flags
operator|&
name|RADEON_VM_PAGE_READABLE
operator|)
condition|?
name|R600_PTE_READABLE
else|:
literal|0
expr_stmt|;
name|r600_flags
operator||=
operator|(
name|flags
operator|&
name|RADEON_VM_PAGE_WRITEABLE
operator|)
condition|?
name|R600_PTE_WRITEABLE
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_SYSTEM
condition|)
block|{
name|r600_flags
operator||=
name|R600_PTE_SYSTEM
expr_stmt|;
name|r600_flags
operator||=
operator|(
name|flags
operator|&
name|RADEON_VM_PAGE_SNOOPED
operator|)
condition|?
name|R600_PTE_SNOOPED
else|:
literal|0
expr_stmt|;
block|}
return|return
name|r600_flags
return|;
block|}
end_function

begin_comment
comment|/**  * cayman_vm_set_page - update the page tables using the CP  *  * @rdev: radeon_device pointer  * @pe: addr of the page entry  * @addr: dst addr to write into pe  * @count: number of page entries to update  * @incr: increase next addr by incr bytes  * @flags: access flags  *  * Update the page tables using the CP (cayman-si).  */
end_comment

begin_function
name|void
name|cayman_vm_set_page
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint64_t
name|pe
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|unsigned
name|count
parameter_list|,
name|uint32_t
name|incr
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|rdev
operator|->
name|asic
operator|->
name|vm
operator|.
name|pt_ring_index
index|]
decl_stmt|;
name|uint32_t
name|r600_flags
init|=
name|cayman_vm_page_flags
argument_list|(
name|rdev
argument_list|,
name|flags
argument_list|)
decl_stmt|;
name|uint64_t
name|value
decl_stmt|;
name|unsigned
name|ndw
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|asic
operator|->
name|vm
operator|.
name|pt_ring_index
operator|==
name|RADEON_RING_TYPE_GFX_INDEX
condition|)
block|{
while|while
condition|(
name|count
condition|)
block|{
name|ndw
operator|=
literal|1
operator|+
name|count
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|ndw
operator|>
literal|0x3FFF
condition|)
name|ndw
operator|=
literal|0x3FFF
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_ME_WRITE
argument_list|,
name|ndw
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|pe
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|pe
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|ndw
operator|>
literal|1
condition|;
name|ndw
operator|-=
literal|2
operator|,
operator|--
name|count
operator|,
name|pe
operator|+=
literal|8
control|)
block|{
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_SYSTEM
condition|)
block|{
name|value
operator|=
name|radeon_vm_map_gart
argument_list|(
name|rdev
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|value
operator|&=
literal|0xFFFFFFFFFFFFF000ULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_VALID
condition|)
block|{
name|value
operator|=
name|addr
expr_stmt|;
block|}
else|else
block|{
name|value
operator|=
literal|0
expr_stmt|;
block|}
name|addr
operator|+=
name|incr
expr_stmt|;
name|value
operator||=
name|r600_flags
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
while|while
condition|(
name|count
condition|)
block|{
name|ndw
operator|=
name|count
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|ndw
operator|>
literal|0xFFFFE
condition|)
name|ndw
operator|=
literal|0xFFFFE
expr_stmt|;
comment|/* for non-physically contiguous pages (system) */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|ndw
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|pe
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|pe
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|ndw
operator|>
literal|0
condition|;
name|ndw
operator|-=
literal|2
operator|,
operator|--
name|count
operator|,
name|pe
operator|+=
literal|8
control|)
block|{
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_SYSTEM
condition|)
block|{
name|value
operator|=
name|radeon_vm_map_gart
argument_list|(
name|rdev
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|value
operator|&=
literal|0xFFFFFFFFFFFFF000ULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flags
operator|&
name|RADEON_VM_PAGE_VALID
condition|)
block|{
name|value
operator|=
name|addr
expr_stmt|;
block|}
else|else
block|{
name|value
operator|=
literal|0
expr_stmt|;
block|}
name|addr
operator|+=
name|incr
expr_stmt|;
name|value
operator||=
name|r600_flags
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|upper_32_bits
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * cayman_vm_flush - vm flush using the CP  *  * @rdev: radeon_device pointer  *  * Update the page table base and flush the VM TLB  * using the CP (cayman-si).  */
end_comment

begin_function
name|void
name|cayman_vm_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|ridx
parameter_list|,
name|struct
name|radeon_vm
modifier|*
name|vm
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ridx
index|]
decl_stmt|;
if|if
condition|(
name|vm
operator|==
name|NULL
condition|)
return|return;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
operator|+
operator|(
name|vm
operator|->
name|id
operator|<<
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|vm
operator|->
name|pd_gpu_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
comment|/* flush hdp cache */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|HDP_MEM_COHERENCY_FLUSH_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
comment|/* bits 0-7 are the VM contexts0-7 */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|VM_INVALIDATE_REQUEST
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|1
operator|<<
name|vm
operator|->
name|id
argument_list|)
expr_stmt|;
comment|/* sync PFP to ME, otherwise we might get invalid PFP reads */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_PFP_SYNC_ME
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cayman_dma_vm_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|ridx
parameter_list|,
name|struct
name|radeon_vm
modifier|*
name|vm
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|ridx
index|]
decl_stmt|;
if|if
condition|(
name|vm
operator|==
name|NULL
condition|)
return|return;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_SRBM_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|0xf
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
operator|+
operator|(
name|vm
operator|->
name|id
operator|<<
literal|2
operator|)
operator|)
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|vm
operator|->
name|pd_gpu_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
comment|/* flush hdp cache */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_SRBM_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|0xf
operator|<<
literal|16
operator|)
operator||
operator|(
name|HDP_MEM_COHERENCY_FLUSH_CNTL
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* bits 0-7 are the VM contexts0-7 */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|DMA_PACKET
argument_list|(
name|DMA_PACKET_SRBM_WRITE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|0xf
operator|<<
literal|16
operator|)
operator||
operator|(
name|VM_INVALIDATE_REQUEST
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|1
operator|<<
name|vm
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


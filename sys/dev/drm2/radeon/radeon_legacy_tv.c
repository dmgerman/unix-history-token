begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc_helper.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_comment
comment|/*  * Integrated TV out support based on the GATOS code by  * Federico Ulivi<fulivi@lycos.com>  */
end_comment

begin_comment
comment|/*  * Limits of h/v positions (hPos& vPos)  */
end_comment

begin_define
define|#
directive|define
name|MAX_H_POSITION
value|5
end_define

begin_comment
comment|/* Range: [-5..5], negative is on the left, 0 is default, positive is on the right */
end_comment

begin_define
define|#
directive|define
name|MAX_V_POSITION
value|5
end_define

begin_comment
comment|/* Range: [-5..5], negative is up, 0 is default, positive is down */
end_comment

begin_comment
comment|/*  * Unit for hPos (in TV clock periods)  */
end_comment

begin_define
define|#
directive|define
name|H_POS_UNIT
value|10
end_define

begin_comment
comment|/*  * Indexes in h. code timing table for horizontal line position adjustment  */
end_comment

begin_define
define|#
directive|define
name|H_TABLE_POS1
value|6
end_define

begin_define
define|#
directive|define
name|H_TABLE_POS2
value|8
end_define

begin_comment
comment|/*  * Limits of hor. size (hSize)  */
end_comment

begin_define
define|#
directive|define
name|MAX_H_SIZE
value|5
end_define

begin_comment
comment|/* Range: [-5..5], negative is smaller, positive is larger */
end_comment

begin_comment
comment|/* tv standard constants */
end_comment

begin_define
define|#
directive|define
name|NTSC_TV_CLOCK_T
value|233
end_define

begin_define
define|#
directive|define
name|NTSC_TV_VFTOTAL
value|1
end_define

begin_define
define|#
directive|define
name|NTSC_TV_LINES_PER_FRAME
value|525
end_define

begin_define
define|#
directive|define
name|NTSC_TV_ZERO_H_SIZE
value|479166
end_define

begin_define
define|#
directive|define
name|NTSC_TV_H_SIZE_UNIT
value|9478
end_define

begin_define
define|#
directive|define
name|PAL_TV_CLOCK_T
value|188
end_define

begin_define
define|#
directive|define
name|PAL_TV_VFTOTAL
value|3
end_define

begin_define
define|#
directive|define
name|PAL_TV_LINES_PER_FRAME
value|625
end_define

begin_define
define|#
directive|define
name|PAL_TV_ZERO_H_SIZE
value|473200
end_define

begin_define
define|#
directive|define
name|PAL_TV_H_SIZE_UNIT
value|9360
end_define

begin_comment
comment|/* tv pll setting for 27 mhz ref clk */
end_comment

begin_define
define|#
directive|define
name|NTSC_TV_PLL_M_27
value|22
end_define

begin_define
define|#
directive|define
name|NTSC_TV_PLL_N_27
value|175
end_define

begin_define
define|#
directive|define
name|NTSC_TV_PLL_P_27
value|5
end_define

begin_define
define|#
directive|define
name|PAL_TV_PLL_M_27
value|113
end_define

begin_define
define|#
directive|define
name|PAL_TV_PLL_N_27
value|668
end_define

begin_define
define|#
directive|define
name|PAL_TV_PLL_P_27
value|3
end_define

begin_comment
comment|/* tv pll setting for 14 mhz ref clk */
end_comment

begin_define
define|#
directive|define
name|NTSC_TV_PLL_M_14
value|33
end_define

begin_define
define|#
directive|define
name|NTSC_TV_PLL_N_14
value|693
end_define

begin_define
define|#
directive|define
name|NTSC_TV_PLL_P_14
value|7
end_define

begin_define
define|#
directive|define
name|PAL_TV_PLL_M_14
value|19
end_define

begin_define
define|#
directive|define
name|PAL_TV_PLL_N_14
value|353
end_define

begin_define
define|#
directive|define
name|PAL_TV_PLL_P_14
value|5
end_define

begin_define
define|#
directive|define
name|VERT_LEAD_IN_LINES
value|2
end_define

begin_define
define|#
directive|define
name|FRAC_BITS
value|0xe
end_define

begin_define
define|#
directive|define
name|FRAC_MASK
value|0x3fff
end_define

begin_struct
struct|struct
name|radeon_tv_mode_constants
block|{
name|uint16_t
name|hor_resolution
decl_stmt|;
name|uint16_t
name|ver_resolution
decl_stmt|;
name|enum
name|radeon_tv_std
name|standard
decl_stmt|;
name|uint16_t
name|hor_total
decl_stmt|;
name|uint16_t
name|ver_total
decl_stmt|;
name|uint16_t
name|hor_start
decl_stmt|;
name|uint16_t
name|hor_syncstart
decl_stmt|;
name|uint16_t
name|ver_syncstart
decl_stmt|;
name|unsigned
name|def_restart
decl_stmt|;
name|uint16_t
name|crtcPLL_N
decl_stmt|;
name|uint8_t
name|crtcPLL_M
decl_stmt|;
name|uint8_t
name|crtcPLL_post_div
decl_stmt|;
name|unsigned
name|pix_to_tv
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|hor_timing_NTSC
index|[
name|MAX_H_CODE_TIMING_LEN
index|]
init|=
block|{
literal|0x0007
block|,
literal|0x003f
block|,
literal|0x0263
block|,
literal|0x0a24
block|,
literal|0x2a6b
block|,
literal|0x0a36
block|,
literal|0x126d
block|,
comment|/* H_TABLE_POS1 */
literal|0x1bfe
block|,
literal|0x1a8f
block|,
comment|/* H_TABLE_POS2 */
literal|0x1ec7
block|,
literal|0x3863
block|,
literal|0x1bfe
block|,
literal|0x1bfe
block|,
literal|0x1a2a
block|,
literal|0x1e95
block|,
literal|0x0e31
block|,
literal|0x201b
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|vert_timing_NTSC
index|[
name|MAX_V_CODE_TIMING_LEN
index|]
init|=
block|{
literal|0x2001
block|,
literal|0x200d
block|,
literal|0x1006
block|,
literal|0x0c06
block|,
literal|0x1006
block|,
literal|0x1818
block|,
literal|0x21e3
block|,
literal|0x1006
block|,
literal|0x0c06
block|,
literal|0x1006
block|,
literal|0x1817
block|,
literal|0x21d4
block|,
literal|0x0002
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|hor_timing_PAL
index|[
name|MAX_H_CODE_TIMING_LEN
index|]
init|=
block|{
literal|0x0007
block|,
literal|0x0058
block|,
literal|0x027c
block|,
literal|0x0a31
block|,
literal|0x2a77
block|,
literal|0x0a95
block|,
literal|0x124f
block|,
comment|/* H_TABLE_POS1 */
literal|0x1bfe
block|,
literal|0x1b22
block|,
comment|/* H_TABLE_POS2 */
literal|0x1ef9
block|,
literal|0x387c
block|,
literal|0x1bfe
block|,
literal|0x1bfe
block|,
literal|0x1b31
block|,
literal|0x1eb5
block|,
literal|0x0e43
block|,
literal|0x201b
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|vert_timing_PAL
index|[
name|MAX_V_CODE_TIMING_LEN
index|]
init|=
block|{
literal|0x2001
block|,
literal|0x200c
block|,
literal|0x1005
block|,
literal|0x0c05
block|,
literal|0x1005
block|,
literal|0x1401
block|,
literal|0x1821
block|,
literal|0x2240
block|,
literal|0x1005
block|,
literal|0x0c05
block|,
literal|0x1005
block|,
literal|0x1401
block|,
literal|0x1822
block|,
literal|0x2230
block|,
literal|0x0002
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**********************************************************************  *  * availableModes  *  * Table of all allowed modes for tv output  *  **********************************************************************/
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|radeon_tv_mode_constants
name|available_tv_modes
index|[]
init|=
block|{
block|{
comment|/* NTSC timing for 27 Mhz ref clk */
literal|800
block|,
comment|/* horResolution */
literal|600
block|,
comment|/* verResolution */
name|TV_STD_NTSC
block|,
comment|/* standard */
literal|990
block|,
comment|/* horTotal */
literal|740
block|,
comment|/* verTotal */
literal|813
block|,
comment|/* horStart */
literal|824
block|,
comment|/* horSyncStart */
literal|632
block|,
comment|/* verSyncStart */
literal|625592
block|,
comment|/* defRestart */
literal|592
block|,
comment|/* crtcPLL_N */
literal|91
block|,
comment|/* crtcPLL_M */
literal|4
block|,
comment|/* crtcPLL_postDiv */
literal|1022
block|,
comment|/* pixToTV */
block|}
block|,
block|{
comment|/* PAL timing for 27 Mhz ref clk */
literal|800
block|,
comment|/* horResolution */
literal|600
block|,
comment|/* verResolution */
name|TV_STD_PAL
block|,
comment|/* standard */
literal|1144
block|,
comment|/* horTotal */
literal|706
block|,
comment|/* verTotal */
literal|812
block|,
comment|/* horStart */
literal|824
block|,
comment|/* horSyncStart */
literal|669
block|,
comment|/* verSyncStart */
literal|696700
block|,
comment|/* defRestart */
literal|1382
block|,
comment|/* crtcPLL_N */
literal|231
block|,
comment|/* crtcPLL_M */
literal|4
block|,
comment|/* crtcPLL_postDiv */
literal|759
block|,
comment|/* pixToTV */
block|}
block|,
block|{
comment|/* NTSC timing for 14 Mhz ref clk */
literal|800
block|,
comment|/* horResolution */
literal|600
block|,
comment|/* verResolution */
name|TV_STD_NTSC
block|,
comment|/* standard */
literal|1018
block|,
comment|/* horTotal */
literal|727
block|,
comment|/* verTotal */
literal|813
block|,
comment|/* horStart */
literal|840
block|,
comment|/* horSyncStart */
literal|633
block|,
comment|/* verSyncStart */
literal|630627
block|,
comment|/* defRestart */
literal|347
block|,
comment|/* crtcPLL_N */
literal|14
block|,
comment|/* crtcPLL_M */
literal|8
block|,
comment|/* crtcPLL_postDiv */
literal|1022
block|,
comment|/* pixToTV */
block|}
block|,
block|{
comment|/* PAL timing for 14 Mhz ref clk */
literal|800
block|,
comment|/* horResolution */
literal|600
block|,
comment|/* verResolution */
name|TV_STD_PAL
block|,
comment|/* standard */
literal|1131
block|,
comment|/* horTotal */
literal|742
block|,
comment|/* verTotal */
literal|813
block|,
comment|/* horStart */
literal|840
block|,
comment|/* horSyncStart */
literal|633
block|,
comment|/* verSyncStart */
literal|708369
block|,
comment|/* defRestart */
literal|211
block|,
comment|/* crtcPLL_N */
literal|9
block|,
comment|/* crtcPLL_M */
literal|8
block|,
comment|/* crtcPLL_postDiv */
literal|759
block|,
comment|/* pixToTV */
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|N_AVAILABLE_MODES
value|DRM_ARRAY_SIZE(available_tv_modes)
end_define

begin_function
specifier|static
specifier|const
name|struct
name|radeon_tv_mode_constants
modifier|*
name|radeon_legacy_tv_get_std_mode
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
parameter_list|,
name|uint16_t
modifier|*
name|pll_ref_freq
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|radeon_encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|tv_dac
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
specifier|const
name|struct
name|radeon_tv_mode_constants
modifier|*
name|const_ptr
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|pll
decl_stmt|;
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|radeon_encoder
operator|->
name|base
operator|.
name|crtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|1
condition|)
name|pll
operator|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|p2pll
expr_stmt|;
else|else
name|pll
operator|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|p1pll
expr_stmt|;
if|if
condition|(
name|pll_ref_freq
condition|)
operator|*
name|pll_ref_freq
operator|=
name|pll
operator|->
name|reference_freq
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_M
condition|)
block|{
if|if
condition|(
name|pll
operator|->
name|reference_freq
operator|==
literal|2700
condition|)
name|const_ptr
operator|=
operator|&
name|available_tv_modes
index|[
literal|0
index|]
expr_stmt|;
else|else
name|const_ptr
operator|=
operator|&
name|available_tv_modes
index|[
literal|2
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pll
operator|->
name|reference_freq
operator|==
literal|2700
condition|)
name|const_ptr
operator|=
operator|&
name|available_tv_modes
index|[
literal|1
index|]
expr_stmt|;
else|else
name|const_ptr
operator|=
operator|&
name|available_tv_modes
index|[
literal|3
index|]
expr_stmt|;
block|}
return|return
name|const_ptr
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|long
name|YCOEF_value
index|[
literal|5
index|]
init|=
block|{
literal|2
block|,
literal|2
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|YCOEF_EN_value
index|[
literal|5
index|]
init|=
block|{
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|SLOPE_value
index|[
literal|5
index|]
init|=
block|{
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|4
block|,
literal|8
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|SLOPE_limit
index|[
literal|5
index|]
init|=
block|{
literal|6
block|,
literal|5
block|,
literal|4
block|,
literal|3
block|,
literal|2
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|radeon_wait_pll_lock
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|unsigned
name|n_tests
parameter_list|,
name|unsigned
name|n_wait_loops
parameter_list|,
name|unsigned
name|cnt_threshold
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|save_pll_test
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|WREG32
argument_list|(
name|RADEON_TEST_DEBUG_MUX
argument_list|,
operator|(
name|RREG32
argument_list|(
name|RADEON_TEST_DEBUG_MUX
argument_list|)
operator|&
literal|0xffff60ff
operator|)
operator||
literal|0x100
argument_list|)
expr_stmt|;
name|save_pll_test
operator|=
name|RREG32_PLL
argument_list|(
name|RADEON_PLL_TEST_CNTL
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|RADEON_PLL_TEST_CNTL
argument_list|,
name|save_pll_test
operator|&
operator|~
name|RADEON_PLL_MASK_READ_B
argument_list|)
expr_stmt|;
name|WREG8
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|,
name|RADEON_PLL_TEST_CNTL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n_tests
condition|;
name|i
operator|++
control|)
block|{
name|WREG8
argument_list|(
name|RADEON_CLOCK_CNTL_DATA
operator|+
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|n_wait_loops
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|RREG8
argument_list|(
name|RADEON_CLOCK_CNTL_DATA
operator|+
literal|3
argument_list|)
operator|>=
name|cnt_threshold
condition|)
break|break;
block|}
name|WREG32_PLL
argument_list|(
name|RADEON_PLL_TEST_CNTL
argument_list|,
name|save_pll_test
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TEST_DEBUG_MUX
argument_list|,
name|RREG32
argument_list|(
name|RADEON_TEST_DEBUG_MUX
argument_list|)
operator|&
literal|0xffffe0ff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_tv_write_fifo
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|radeon_encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_HOST_WRITE_DATA
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_HOST_RD_WT_CNTL
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_HOST_RD_WT_CNTL
argument_list|,
name|addr
operator||
name|RADEON_HOST_FIFO_WT
argument_list|)
expr_stmt|;
do|do
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_HOST_RD_WT_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
name|RADEON_HOST_FIFO_WT_ACK
operator|)
operator|==
literal|0
condition|)
break|break;
name|i
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|<
literal|10000
condition|)
do|;
name|WREG32
argument_list|(
name|RADEON_TV_HOST_RD_WT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* included for completeness */
end_comment

begin_endif
unit|static uint32_t radeon_legacy_tv_read_fifo(struct radeon_encoder *radeon_encoder, uint16_t addr) { 	struct drm_device *dev = radeon_encoder->base.dev; 	struct radeon_device *rdev = dev->dev_private; 	uint32_t tmp; 	int i = 0;  	WREG32(RADEON_TV_HOST_RD_WT_CNTL, addr); 	WREG32(RADEON_TV_HOST_RD_WT_CNTL, addr | RADEON_HOST_FIFO_RD);  	do { 		tmp = RREG32(RADEON_TV_HOST_RD_WT_CNTL); 		if ((tmp& RADEON_HOST_FIFO_RD_ACK) == 0) 			break; 		i++; 	} while (i< 10000); 	WREG32(RADEON_TV_HOST_RD_WT_CNTL, 0); 	return RREG32(RADEON_TV_HOST_READ_DATA); }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|uint16_t
name|radeon_get_htiming_tables_addr
parameter_list|(
name|uint32_t
name|tv_uv_adr
parameter_list|)
block|{
name|uint16_t
name|h_table
decl_stmt|;
switch|switch
condition|(
operator|(
name|tv_uv_adr
operator|&
name|RADEON_HCODE_TABLE_SEL_MASK
operator|)
operator|>>
name|RADEON_HCODE_TABLE_SEL_SHIFT
condition|)
block|{
case|case
literal|0
case|:
name|h_table
operator|=
name|RADEON_TV_MAX_FIFO_ADDR_INTERNAL
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|h_table
operator|=
operator|(
operator|(
name|tv_uv_adr
operator|&
name|RADEON_TABLE1_BOT_ADR_MASK
operator|)
operator|>>
name|RADEON_TABLE1_BOT_ADR_SHIFT
operator|)
operator|*
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|h_table
operator|=
operator|(
operator|(
name|tv_uv_adr
operator|&
name|RADEON_TABLE3_TOP_ADR_MASK
operator|)
operator|>>
name|RADEON_TABLE3_TOP_ADR_SHIFT
operator|)
operator|*
literal|2
expr_stmt|;
break|break;
default|default:
name|h_table
operator|=
literal|0
expr_stmt|;
break|break;
block|}
return|return
name|h_table
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|radeon_get_vtiming_tables_addr
parameter_list|(
name|uint32_t
name|tv_uv_adr
parameter_list|)
block|{
name|uint16_t
name|v_table
decl_stmt|;
switch|switch
condition|(
operator|(
name|tv_uv_adr
operator|&
name|RADEON_VCODE_TABLE_SEL_MASK
operator|)
operator|>>
name|RADEON_VCODE_TABLE_SEL_SHIFT
condition|)
block|{
case|case
literal|0
case|:
name|v_table
operator|=
operator|(
operator|(
name|tv_uv_adr
operator|&
name|RADEON_MAX_UV_ADR_MASK
operator|)
operator|>>
name|RADEON_MAX_UV_ADR_SHIFT
operator|)
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|v_table
operator|=
operator|(
operator|(
name|tv_uv_adr
operator|&
name|RADEON_TABLE1_BOT_ADR_MASK
operator|)
operator|>>
name|RADEON_TABLE1_BOT_ADR_SHIFT
operator|)
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|v_table
operator|=
operator|(
operator|(
name|tv_uv_adr
operator|&
name|RADEON_TABLE3_TOP_ADR_MASK
operator|)
operator|>>
name|RADEON_TABLE3_TOP_ADR_SHIFT
operator|)
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
break|break;
default|default:
name|v_table
operator|=
literal|0
expr_stmt|;
break|break;
block|}
return|return
name|v_table
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_restore_tv_timing_tables
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|radeon_encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|tv_dac
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|uint16_t
name|h_table
decl_stmt|,
name|v_table
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_UV_ADR
argument_list|,
name|tv_dac
operator|->
name|tv
operator|.
name|tv_uv_adr
argument_list|)
expr_stmt|;
name|h_table
operator|=
name|radeon_get_htiming_tables_addr
argument_list|(
name|tv_dac
operator|->
name|tv
operator|.
name|tv_uv_adr
argument_list|)
expr_stmt|;
name|v_table
operator|=
name|radeon_get_vtiming_tables_addr
argument_list|(
name|tv_dac
operator|->
name|tv
operator|.
name|tv_uv_adr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_H_CODE_TIMING_LEN
condition|;
name|i
operator|+=
literal|2
operator|,
name|h_table
operator|--
control|)
block|{
name|tmp
operator|=
operator|(
operator|(
name|uint32_t
operator|)
name|tv_dac
operator|->
name|tv
operator|.
name|h_code_timing
index|[
name|i
index|]
operator|<<
literal|14
operator|)
operator||
operator|(
operator|(
name|uint32_t
operator|)
name|tv_dac
operator|->
name|tv
operator|.
name|h_code_timing
index|[
name|i
operator|+
literal|1
index|]
operator|)
expr_stmt|;
name|radeon_legacy_tv_write_fifo
argument_list|(
name|radeon_encoder
argument_list|,
name|h_table
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv
operator|.
name|h_code_timing
index|[
name|i
index|]
operator|==
literal|0
operator|||
name|tv_dac
operator|->
name|tv
operator|.
name|h_code_timing
index|[
name|i
operator|+
literal|1
index|]
operator|==
literal|0
condition|)
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_V_CODE_TIMING_LEN
condition|;
name|i
operator|+=
literal|2
operator|,
name|v_table
operator|++
control|)
block|{
name|tmp
operator|=
operator|(
operator|(
name|uint32_t
operator|)
name|tv_dac
operator|->
name|tv
operator|.
name|v_code_timing
index|[
name|i
operator|+
literal|1
index|]
operator|<<
literal|14
operator|)
operator||
operator|(
operator|(
name|uint32_t
operator|)
name|tv_dac
operator|->
name|tv
operator|.
name|v_code_timing
index|[
name|i
index|]
operator|)
expr_stmt|;
name|radeon_legacy_tv_write_fifo
argument_list|(
name|radeon_encoder
argument_list|,
name|v_table
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv
operator|.
name|v_code_timing
index|[
name|i
index|]
operator|==
literal|0
operator|||
name|tv_dac
operator|->
name|tv
operator|.
name|v_code_timing
index|[
name|i
operator|+
literal|1
index|]
operator|==
literal|0
condition|)
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_legacy_write_tv_restarts
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|radeon_encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|tv_dac
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_FRESTART
argument_list|,
name|tv_dac
operator|->
name|tv
operator|.
name|frestart
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_HRESTART
argument_list|,
name|tv_dac
operator|->
name|tv
operator|.
name|hrestart
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_VRESTART
argument_list|,
name|tv_dac
operator|->
name|tv
operator|.
name|vrestart
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_legacy_tv_init_restarts
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|tv_dac
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|int
name|restart
decl_stmt|;
name|unsigned
name|int
name|h_total
decl_stmt|,
name|v_total
decl_stmt|,
name|f_total
decl_stmt|;
name|int
name|v_offset
decl_stmt|,
name|h_offset
decl_stmt|;
name|u16
name|p1
decl_stmt|,
name|p2
decl_stmt|,
name|h_inc
decl_stmt|;
name|bool
name|h_changed
decl_stmt|;
specifier|const
name|struct
name|radeon_tv_mode_constants
modifier|*
name|const_ptr
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|pll
decl_stmt|;
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|radeon_encoder
operator|->
name|base
operator|.
name|crtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|1
condition|)
name|pll
operator|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|p2pll
expr_stmt|;
else|else
name|pll
operator|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|p1pll
expr_stmt|;
name|const_ptr
operator|=
name|radeon_legacy_tv_get_std_mode
argument_list|(
name|radeon_encoder
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|const_ptr
condition|)
return|return
name|false
return|;
name|h_total
operator|=
name|const_ptr
operator|->
name|hor_total
expr_stmt|;
name|v_total
operator|=
name|const_ptr
operator|->
name|ver_total
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_M
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_60
condition|)
name|f_total
operator|=
name|NTSC_TV_VFTOTAL
operator|+
literal|1
expr_stmt|;
else|else
name|f_total
operator|=
name|PAL_TV_VFTOTAL
operator|+
literal|1
expr_stmt|;
comment|/* adjust positions 1&2 in hor. cod timing table */
name|h_offset
operator|=
name|tv_dac
operator|->
name|h_pos
operator|*
name|H_POS_UNIT
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_M
condition|)
block|{
name|h_offset
operator|-=
literal|50
expr_stmt|;
name|p1
operator|=
name|hor_timing_NTSC
index|[
name|H_TABLE_POS1
index|]
expr_stmt|;
name|p2
operator|=
name|hor_timing_NTSC
index|[
name|H_TABLE_POS2
index|]
expr_stmt|;
block|}
else|else
block|{
name|p1
operator|=
name|hor_timing_PAL
index|[
name|H_TABLE_POS1
index|]
expr_stmt|;
name|p2
operator|=
name|hor_timing_PAL
index|[
name|H_TABLE_POS2
index|]
expr_stmt|;
block|}
name|p1
operator|=
call|(
name|u16
call|)
argument_list|(
operator|(
name|int
operator|)
name|p1
operator|+
name|h_offset
argument_list|)
expr_stmt|;
name|p2
operator|=
call|(
name|u16
call|)
argument_list|(
operator|(
name|int
operator|)
name|p2
operator|-
name|h_offset
argument_list|)
expr_stmt|;
name|h_changed
operator|=
operator|(
name|p1
operator|!=
name|tv_dac
operator|->
name|tv
operator|.
name|h_code_timing
index|[
name|H_TABLE_POS1
index|]
operator|||
name|p2
operator|!=
name|tv_dac
operator|->
name|tv
operator|.
name|h_code_timing
index|[
name|H_TABLE_POS2
index|]
operator|)
expr_stmt|;
name|tv_dac
operator|->
name|tv
operator|.
name|h_code_timing
index|[
name|H_TABLE_POS1
index|]
operator|=
name|p1
expr_stmt|;
name|tv_dac
operator|->
name|tv
operator|.
name|h_code_timing
index|[
name|H_TABLE_POS2
index|]
operator|=
name|p2
expr_stmt|;
comment|/* Convert hOffset from n. of TV clock periods to n. of CRTC clock periods (CRTC pixels) */
name|h_offset
operator|=
operator|(
name|h_offset
operator|*
call|(
name|int
call|)
argument_list|(
name|const_ptr
operator|->
name|pix_to_tv
argument_list|)
operator|)
operator|/
literal|1000
expr_stmt|;
comment|/* adjust restart */
name|restart
operator|=
name|const_ptr
operator|->
name|def_restart
expr_stmt|;
comment|/* 	 * convert v_pos TV lines to n. of CRTC pixels 	 */
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_M
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_60
condition|)
name|v_offset
operator|=
operator|(
call|(
name|int
call|)
argument_list|(
name|v_total
operator|*
name|h_total
argument_list|)
operator|*
literal|2
operator|*
name|tv_dac
operator|->
name|v_pos
operator|)
operator|/
call|(
name|int
call|)
argument_list|(
name|NTSC_TV_LINES_PER_FRAME
argument_list|)
expr_stmt|;
else|else
name|v_offset
operator|=
operator|(
call|(
name|int
call|)
argument_list|(
name|v_total
operator|*
name|h_total
argument_list|)
operator|*
literal|2
operator|*
name|tv_dac
operator|->
name|v_pos
operator|)
operator|/
call|(
name|int
call|)
argument_list|(
name|PAL_TV_LINES_PER_FRAME
argument_list|)
expr_stmt|;
name|restart
operator|-=
name|v_offset
operator|+
name|h_offset
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"compute_restarts: def = %u h = %d v = %d, p1 = %04x, p2 = %04x, restart = %d\n"
argument_list|,
name|const_ptr
operator|->
name|def_restart
argument_list|,
name|tv_dac
operator|->
name|h_pos
argument_list|,
name|tv_dac
operator|->
name|v_pos
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|,
name|restart
argument_list|)
expr_stmt|;
name|tv_dac
operator|->
name|tv
operator|.
name|hrestart
operator|=
name|restart
operator|%
name|h_total
expr_stmt|;
name|restart
operator|/=
name|h_total
expr_stmt|;
name|tv_dac
operator|->
name|tv
operator|.
name|vrestart
operator|=
name|restart
operator|%
name|v_total
expr_stmt|;
name|restart
operator|/=
name|v_total
expr_stmt|;
name|tv_dac
operator|->
name|tv
operator|.
name|frestart
operator|=
name|restart
operator|%
name|f_total
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"compute_restart: F/H/V=%u,%u,%u\n"
argument_list|,
operator|(
name|unsigned
operator|)
name|tv_dac
operator|->
name|tv
operator|.
name|frestart
argument_list|,
operator|(
name|unsigned
operator|)
name|tv_dac
operator|->
name|tv
operator|.
name|vrestart
argument_list|,
operator|(
name|unsigned
operator|)
name|tv_dac
operator|->
name|tv
operator|.
name|hrestart
argument_list|)
expr_stmt|;
comment|/* compute h_inc from hsize */
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_M
condition|)
name|h_inc
operator|=
call|(
name|u16
call|)
argument_list|(
call|(
name|int
call|)
argument_list|(
name|const_ptr
operator|->
name|hor_resolution
operator|*
literal|4096
operator|*
name|NTSC_TV_CLOCK_T
argument_list|)
operator|/
operator|(
name|tv_dac
operator|->
name|h_size
operator|*
call|(
name|int
call|)
argument_list|(
name|NTSC_TV_H_SIZE_UNIT
argument_list|)
operator|+
call|(
name|int
call|)
argument_list|(
name|NTSC_TV_ZERO_H_SIZE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|else
name|h_inc
operator|=
call|(
name|u16
call|)
argument_list|(
call|(
name|int
call|)
argument_list|(
name|const_ptr
operator|->
name|hor_resolution
operator|*
literal|4096
operator|*
name|PAL_TV_CLOCK_T
argument_list|)
operator|/
operator|(
name|tv_dac
operator|->
name|h_size
operator|*
call|(
name|int
call|)
argument_list|(
name|PAL_TV_H_SIZE_UNIT
argument_list|)
operator|+
call|(
name|int
call|)
argument_list|(
name|PAL_TV_ZERO_H_SIZE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tv_dac
operator|->
name|tv
operator|.
name|timing_cntl
operator|=
operator|(
name|tv_dac
operator|->
name|tv
operator|.
name|timing_cntl
operator|&
operator|~
name|RADEON_H_INC_MASK
operator|)
operator||
operator|(
operator|(
name|u32
operator|)
name|h_inc
operator|<<
name|RADEON_H_INC_SHIFT
operator|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"compute_restart: h_size = %d h_inc = %d\n"
argument_list|,
name|tv_dac
operator|->
name|h_size
argument_list|,
name|h_inc
argument_list|)
expr_stmt|;
return|return
name|h_changed
return|;
block|}
end_function

begin_function
name|void
name|radeon_legacy_tv_mode_set
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|tv_dac
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
specifier|const
name|struct
name|radeon_tv_mode_constants
modifier|*
name|const_ptr
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
name|pll_ref_freq
decl_stmt|;
name|uint32_t
name|vert_space
decl_stmt|,
name|flicker_removal
decl_stmt|,
name|tmp
decl_stmt|;
name|uint32_t
name|tv_master_cntl
decl_stmt|,
name|tv_rgb_cntl
decl_stmt|,
name|tv_dac_cntl
decl_stmt|;
name|uint32_t
name|tv_modulator_cntl1
decl_stmt|,
name|tv_modulator_cntl2
decl_stmt|;
name|uint32_t
name|tv_vscaler_cntl1
decl_stmt|,
name|tv_vscaler_cntl2
decl_stmt|;
name|uint32_t
name|tv_pll_cntl
decl_stmt|,
name|tv_pll_cntl1
decl_stmt|,
name|tv_ftotal
decl_stmt|;
name|uint32_t
name|tv_y_fall_cntl
decl_stmt|,
name|tv_y_rise_cntl
decl_stmt|,
name|tv_y_saw_tooth_cntl
decl_stmt|;
name|uint32_t
name|m
decl_stmt|,
name|n
decl_stmt|,
name|p
decl_stmt|;
specifier|const
name|uint16_t
modifier|*
name|hor_timing
decl_stmt|;
specifier|const
name|uint16_t
modifier|*
name|vert_timing
decl_stmt|;
name|const_ptr
operator|=
name|radeon_legacy_tv_get_std_mode
argument_list|(
name|radeon_encoder
argument_list|,
operator|&
name|pll_ref_freq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|const_ptr
condition|)
return|return;
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|encoder
operator|->
name|crtc
argument_list|)
expr_stmt|;
name|tv_master_cntl
operator|=
operator|(
name|RADEON_VIN_ASYNC_RST
operator||
name|RADEON_CRT_FIFO_CE_EN
operator||
name|RADEON_TV_FIFO_CE_EN
operator||
name|RADEON_TV_ON
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
name|tv_master_cntl
operator||=
name|RADEON_TVCLK_ALWAYS_ONb
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
condition|)
name|tv_master_cntl
operator||=
name|RADEON_RESTART_PHASE_FIX
expr_stmt|;
name|tv_modulator_cntl1
operator|=
operator|(
name|RADEON_SLEW_RATE_LIMIT
operator||
name|RADEON_SYNC_TIP_LEVEL
operator||
name|RADEON_YFLT_EN
operator||
name|RADEON_UVFLT_EN
operator||
operator|(
literal|6
operator|<<
name|RADEON_CY_FILT_BLEND_SHIFT
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
condition|)
block|{
name|tv_modulator_cntl1
operator||=
operator|(
literal|0x46
operator|<<
name|RADEON_SET_UP_LEVEL_SHIFT
operator|)
operator||
operator|(
literal|0x3b
operator|<<
name|RADEON_BLANK_LEVEL_SHIFT
operator|)
expr_stmt|;
name|tv_modulator_cntl2
operator|=
operator|(
operator|-
literal|111
operator|&
name|RADEON_TV_U_BURST_LEVEL_MASK
operator|)
operator||
operator|(
operator|(
literal|0
operator|&
name|RADEON_TV_V_BURST_LEVEL_MASK
operator|)
operator|<<
name|RADEON_TV_V_BURST_LEVEL_SHIFT
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_SCART_PAL
condition|)
block|{
name|tv_modulator_cntl1
operator||=
name|RADEON_ALT_PHASE_EN
expr_stmt|;
name|tv_modulator_cntl2
operator|=
operator|(
literal|0
operator|&
name|RADEON_TV_U_BURST_LEVEL_MASK
operator|)
operator||
operator|(
operator|(
literal|0
operator|&
name|RADEON_TV_V_BURST_LEVEL_MASK
operator|)
operator|<<
name|RADEON_TV_V_BURST_LEVEL_SHIFT
operator|)
expr_stmt|;
block|}
else|else
block|{
name|tv_modulator_cntl1
operator||=
name|RADEON_ALT_PHASE_EN
operator||
operator|(
literal|0x3b
operator|<<
name|RADEON_SET_UP_LEVEL_SHIFT
operator|)
operator||
operator|(
literal|0x3b
operator|<<
name|RADEON_BLANK_LEVEL_SHIFT
operator|)
expr_stmt|;
name|tv_modulator_cntl2
operator|=
operator|(
operator|-
literal|78
operator|&
name|RADEON_TV_U_BURST_LEVEL_MASK
operator|)
operator||
operator|(
operator|(
literal|62
operator|&
name|RADEON_TV_V_BURST_LEVEL_MASK
operator|)
operator|<<
name|RADEON_TV_V_BURST_LEVEL_SHIFT
operator|)
expr_stmt|;
block|}
name|tv_rgb_cntl
operator|=
operator|(
name|RADEON_RGB_DITHER_EN
operator||
name|RADEON_TVOUT_SCALE_EN
operator||
operator|(
literal|0x0b
operator|<<
name|RADEON_UVRAM_READ_MARGIN_SHIFT
operator|)
operator||
operator|(
literal|0x07
operator|<<
name|RADEON_FIFORAM_FFMACRO_READ_MARGIN_SHIFT
operator|)
operator||
name|RADEON_RGB_ATTEN_SEL
argument_list|(
literal|0x3
argument_list|)
operator||
name|RADEON_RGB_ATTEN_VAL
argument_list|(
literal|0xc
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
operator|==
literal|1
condition|)
name|tv_rgb_cntl
operator||=
name|RADEON_RGB_SRC_SEL_CRTC2
expr_stmt|;
else|else
block|{
if|if
condition|(
name|radeon_crtc
operator|->
name|rmx_type
operator|!=
name|RMX_OFF
condition|)
name|tv_rgb_cntl
operator||=
name|RADEON_RGB_SRC_SEL_RMX
expr_stmt|;
else|else
name|tv_rgb_cntl
operator||=
name|RADEON_RGB_SRC_SEL_CRTC1
expr_stmt|;
block|}
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_M
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_60
condition|)
name|vert_space
operator|=
name|const_ptr
operator|->
name|ver_total
operator|*
literal|2
operator|*
literal|10000
operator|/
name|NTSC_TV_LINES_PER_FRAME
expr_stmt|;
else|else
name|vert_space
operator|=
name|const_ptr
operator|->
name|ver_total
operator|*
literal|2
operator|*
literal|10000
operator|/
name|PAL_TV_LINES_PER_FRAME
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_VSCALER_CNTL1
argument_list|)
expr_stmt|;
name|tmp
operator|&=
literal|0xe3ff0000
expr_stmt|;
name|tmp
operator||=
operator|(
name|vert_space
operator|*
operator|(
literal|1
operator|<<
name|FRAC_BITS
operator|)
operator|/
literal|10000
operator|)
expr_stmt|;
name|tv_vscaler_cntl1
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|pll_ref_freq
operator|==
literal|2700
condition|)
name|tv_vscaler_cntl1
operator||=
name|RADEON_RESTART_FIELD
expr_stmt|;
if|if
condition|(
name|const_ptr
operator|->
name|hor_resolution
operator|==
literal|1024
condition|)
name|tv_vscaler_cntl1
operator||=
operator|(
literal|4
operator|<<
name|RADEON_Y_DEL_W_SIG_SHIFT
operator|)
expr_stmt|;
else|else
name|tv_vscaler_cntl1
operator||=
operator|(
literal|2
operator|<<
name|RADEON_Y_DEL_W_SIG_SHIFT
operator|)
expr_stmt|;
comment|/* scale up for int divide */
name|tmp
operator|=
name|const_ptr
operator|->
name|ver_total
operator|*
literal|2
operator|*
literal|1000
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_M
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_60
condition|)
block|{
name|tmp
operator|/=
name|NTSC_TV_LINES_PER_FRAME
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|/=
name|PAL_TV_LINES_PER_FRAME
expr_stmt|;
block|}
name|flicker_removal
operator|=
operator|(
name|tmp
operator|+
literal|500
operator|)
operator|/
literal|1000
expr_stmt|;
if|if
condition|(
name|flicker_removal
operator|<
literal|3
condition|)
name|flicker_removal
operator|=
literal|3
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DRM_ARRAY_SIZE
argument_list|(
name|SLOPE_limit
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|flicker_removal
operator|==
name|SLOPE_limit
index|[
name|i
index|]
condition|)
break|break;
block|}
name|tv_y_saw_tooth_cntl
operator|=
operator|(
name|vert_space
operator|*
name|SLOPE_value
index|[
name|i
index|]
operator|*
operator|(
literal|1
operator|<<
operator|(
name|FRAC_BITS
operator|-
literal|1
operator|)
operator|)
operator|+
literal|5001
operator|)
operator|/
literal|10000
operator|/
literal|8
operator||
operator|(
operator|(
name|SLOPE_value
index|[
name|i
index|]
operator|*
operator|(
literal|1
operator|<<
operator|(
name|FRAC_BITS
operator|-
literal|1
operator|)
operator|)
operator|/
literal|8
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|tv_y_fall_cntl
operator|=
operator|(
name|YCOEF_EN_value
index|[
name|i
index|]
operator|<<
literal|17
operator|)
operator||
operator|(
operator|(
name|YCOEF_value
index|[
name|i
index|]
operator|*
operator|(
literal|1
operator|<<
literal|8
operator|)
operator|/
literal|8
operator|)
operator|<<
literal|24
operator|)
operator||
name|RADEON_Y_FALL_PING_PONG
operator||
operator|(
literal|272
operator|*
name|SLOPE_value
index|[
name|i
index|]
operator|/
literal|8
operator|)
operator|*
operator|(
literal|1
operator|<<
operator|(
name|FRAC_BITS
operator|-
literal|1
operator|)
operator|)
operator|/
literal|1024
expr_stmt|;
name|tv_y_rise_cntl
operator|=
name|RADEON_Y_RISE_PING_PONG
operator||
operator|(
name|flicker_removal
operator|*
literal|1024
operator|-
literal|272
operator|)
operator|*
name|SLOPE_value
index|[
name|i
index|]
operator|/
literal|8
operator|*
operator|(
literal|1
operator|<<
operator|(
name|FRAC_BITS
operator|-
literal|1
operator|)
operator|)
operator|/
literal|1024
expr_stmt|;
name|tv_vscaler_cntl2
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_VSCALER_CNTL2
argument_list|)
operator|&
literal|0x00fffff0
expr_stmt|;
name|tv_vscaler_cntl2
operator||=
operator|(
literal|0x10
operator|<<
literal|24
operator|)
operator||
name|RADEON_DITHER_MODE
operator||
name|RADEON_Y_OUTPUT_DITHER_EN
operator||
name|RADEON_UV_OUTPUT_DITHER_EN
operator||
name|RADEON_UV_TO_BUF_DITHER_EN
expr_stmt|;
name|tmp
operator|=
operator|(
name|tv_vscaler_cntl1
operator|>>
name|RADEON_UV_INC_SHIFT
operator|)
operator|&
name|RADEON_UV_INC_MASK
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
literal|16384
operator|*
literal|256
operator|*
literal|10
operator|)
operator|/
name|tmp
operator|+
literal|5
operator|)
operator|/
literal|10
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|<<
name|RADEON_UV_OUTPUT_POST_SCALE_SHIFT
operator|)
operator||
literal|0x000b0000
expr_stmt|;
name|tv_dac
operator|->
name|tv
operator|.
name|timing_cntl
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_M
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_60
condition|)
name|tv_dac_cntl
operator|=
name|tv_dac
operator|->
name|ntsc_tvdac_adj
expr_stmt|;
else|else
name|tv_dac_cntl
operator|=
name|tv_dac
operator|->
name|pal_tvdac_adj
expr_stmt|;
name|tv_dac_cntl
operator||=
name|RADEON_TV_DAC_NBLANK
operator||
name|RADEON_TV_DAC_NHOLD
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
condition|)
name|tv_dac_cntl
operator||=
name|RADEON_TV_DAC_STD_NTSC
expr_stmt|;
else|else
name|tv_dac_cntl
operator||=
name|RADEON_TV_DAC_STD_PAL
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
condition|)
block|{
if|if
condition|(
name|pll_ref_freq
operator|==
literal|2700
condition|)
block|{
name|m
operator|=
name|NTSC_TV_PLL_M_27
expr_stmt|;
name|n
operator|=
name|NTSC_TV_PLL_N_27
expr_stmt|;
name|p
operator|=
name|NTSC_TV_PLL_P_27
expr_stmt|;
block|}
else|else
block|{
name|m
operator|=
name|NTSC_TV_PLL_M_14
expr_stmt|;
name|n
operator|=
name|NTSC_TV_PLL_N_14
expr_stmt|;
name|p
operator|=
name|NTSC_TV_PLL_P_14
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|pll_ref_freq
operator|==
literal|2700
condition|)
block|{
name|m
operator|=
name|PAL_TV_PLL_M_27
expr_stmt|;
name|n
operator|=
name|PAL_TV_PLL_N_27
expr_stmt|;
name|p
operator|=
name|PAL_TV_PLL_P_27
expr_stmt|;
block|}
else|else
block|{
name|m
operator|=
name|PAL_TV_PLL_M_14
expr_stmt|;
name|n
operator|=
name|PAL_TV_PLL_N_14
expr_stmt|;
name|p
operator|=
name|PAL_TV_PLL_P_14
expr_stmt|;
block|}
block|}
name|tv_pll_cntl
operator|=
operator|(
name|m
operator|&
name|RADEON_TV_M0LO_MASK
operator|)
operator||
operator|(
operator|(
operator|(
name|m
operator|>>
literal|8
operator|)
operator|&
name|RADEON_TV_M0HI_MASK
operator|)
operator|<<
name|RADEON_TV_M0HI_SHIFT
operator|)
operator||
operator|(
operator|(
name|n
operator|&
name|RADEON_TV_N0LO_MASK
operator|)
operator|<<
name|RADEON_TV_N0LO_SHIFT
operator|)
operator||
operator|(
operator|(
operator|(
name|n
operator|>>
literal|9
operator|)
operator|&
name|RADEON_TV_N0HI_MASK
operator|)
operator|<<
name|RADEON_TV_N0HI_SHIFT
operator|)
operator||
operator|(
operator|(
name|p
operator|&
name|RADEON_TV_P_MASK
operator|)
operator|<<
name|RADEON_TV_P_SHIFT
operator|)
expr_stmt|;
name|tv_pll_cntl1
operator|=
operator|(
operator|(
operator|(
literal|4
operator|&
name|RADEON_TVPCP_MASK
operator|)
operator|<<
name|RADEON_TVPCP_SHIFT
operator|)
operator||
operator|(
operator|(
literal|4
operator|&
name|RADEON_TVPVG_MASK
operator|)
operator|<<
name|RADEON_TVPVG_SHIFT
operator|)
operator||
operator|(
operator|(
literal|1
operator|&
name|RADEON_TVPDC_MASK
operator|)
operator|<<
name|RADEON_TVPDC_SHIFT
operator|)
operator||
name|RADEON_TVCLK_SRC_SEL_TVPLL
operator||
name|RADEON_TVPLL_TEST_DIS
operator|)
expr_stmt|;
name|tv_dac
operator|->
name|tv
operator|.
name|tv_uv_adr
operator|=
literal|0xc8
expr_stmt|;
if|if
condition|(
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_NTSC_J
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_M
operator|||
name|tv_dac
operator|->
name|tv_std
operator|==
name|TV_STD_PAL_60
condition|)
block|{
name|tv_ftotal
operator|=
name|NTSC_TV_VFTOTAL
expr_stmt|;
name|hor_timing
operator|=
name|hor_timing_NTSC
expr_stmt|;
name|vert_timing
operator|=
name|vert_timing_NTSC
expr_stmt|;
block|}
else|else
block|{
name|hor_timing
operator|=
name|hor_timing_PAL
expr_stmt|;
name|vert_timing
operator|=
name|vert_timing_PAL
expr_stmt|;
name|tv_ftotal
operator|=
name|PAL_TV_VFTOTAL
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_H_CODE_TIMING_LEN
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|tv_dac
operator|->
name|tv
operator|.
name|h_code_timing
index|[
name|i
index|]
operator|=
name|hor_timing
index|[
name|i
index|]
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_V_CODE_TIMING_LEN
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|tv_dac
operator|->
name|tv
operator|.
name|v_code_timing
index|[
name|i
index|]
operator|=
name|vert_timing
index|[
name|i
index|]
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
name|radeon_legacy_tv_init_restarts
argument_list|(
name|encoder
argument_list|)
expr_stmt|;
comment|/* play with DAC_CNTL */
comment|/* play with GPIOPAD_A */
comment|/* DISP_OUTPUT_CNTL */
comment|/* use reference freq */
comment|/* program the TV registers */
name|WREG32
argument_list|(
name|RADEON_TV_MASTER_CNTL
argument_list|,
operator|(
name|tv_master_cntl
operator||
name|RADEON_TV_ASYNC_RST
operator||
name|RADEON_CRT_ASYNC_RST
operator||
name|RADEON_TV_FIFO_ASYNC_RST
operator|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|RADEON_TV_DAC_NBLANK
expr_stmt|;
name|tmp
operator||=
name|RADEON_TV_DAC_BGSLEEP
operator||
name|RADEON_TV_DAC_RDACPD
operator||
name|RADEON_TV_DAC_GDACPD
operator||
name|RADEON_TV_DAC_BDACPD
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* TV PLL */
name|WREG32_PLL_P
argument_list|(
name|RADEON_TV_PLL_CNTL1
argument_list|,
literal|0
argument_list|,
operator|~
name|RADEON_TVCLK_SRC_SEL_TVPLL
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|RADEON_TV_PLL_CNTL
argument_list|,
name|tv_pll_cntl
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_TV_PLL_CNTL1
argument_list|,
name|RADEON_TVPLL_RESET
argument_list|,
operator|~
name|RADEON_TVPLL_RESET
argument_list|)
expr_stmt|;
name|radeon_wait_pll_lock
argument_list|(
name|encoder
argument_list|,
literal|200
argument_list|,
literal|800
argument_list|,
literal|135
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_TV_PLL_CNTL1
argument_list|,
literal|0
argument_list|,
operator|~
name|RADEON_TVPLL_RESET
argument_list|)
expr_stmt|;
name|radeon_wait_pll_lock
argument_list|(
name|encoder
argument_list|,
literal|300
argument_list|,
literal|160
argument_list|,
literal|27
argument_list|)
expr_stmt|;
name|radeon_wait_pll_lock
argument_list|(
name|encoder
argument_list|,
literal|200
argument_list|,
literal|800
argument_list|,
literal|135
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_TV_PLL_CNTL1
argument_list|,
literal|0
argument_list|,
operator|~
literal|0xf
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_TV_PLL_CNTL1
argument_list|,
name|RADEON_TVCLK_SRC_SEL_TVPLL
argument_list|,
operator|~
name|RADEON_TVCLK_SRC_SEL_TVPLL
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_TV_PLL_CNTL1
argument_list|,
operator|(
literal|1
operator|<<
name|RADEON_TVPDC_SHIFT
operator|)
argument_list|,
operator|~
name|RADEON_TVPDC_MASK
argument_list|)
expr_stmt|;
name|WREG32_PLL_P
argument_list|(
name|RADEON_TV_PLL_CNTL1
argument_list|,
literal|0
argument_list|,
operator|~
name|RADEON_TVPLL_SLEEP
argument_list|)
expr_stmt|;
comment|/* TV HV */
name|WREG32
argument_list|(
name|RADEON_TV_RGB_CNTL
argument_list|,
name|tv_rgb_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_HTOTAL
argument_list|,
name|const_ptr
operator|->
name|hor_total
operator|-
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_HDISP
argument_list|,
name|const_ptr
operator|->
name|hor_resolution
operator|-
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_HSTART
argument_list|,
name|const_ptr
operator|->
name|hor_start
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_VTOTAL
argument_list|,
name|const_ptr
operator|->
name|ver_total
operator|-
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_VDISP
argument_list|,
name|const_ptr
operator|->
name|ver_resolution
operator|-
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_FTOTAL
argument_list|,
name|tv_ftotal
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_VSCALER_CNTL1
argument_list|,
name|tv_vscaler_cntl1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_VSCALER_CNTL2
argument_list|,
name|tv_vscaler_cntl2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_Y_FALL_CNTL
argument_list|,
name|tv_y_fall_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_Y_RISE_CNTL
argument_list|,
name|tv_y_rise_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_Y_SAW_TOOTH_CNTL
argument_list|,
name|tv_y_saw_tooth_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_MASTER_CNTL
argument_list|,
operator|(
name|tv_master_cntl
operator||
name|RADEON_TV_ASYNC_RST
operator||
name|RADEON_CRT_ASYNC_RST
operator|)
argument_list|)
expr_stmt|;
comment|/* TV restarts */
name|radeon_legacy_write_tv_restarts
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
comment|/* tv timings */
name|radeon_restore_tv_timing_tables
argument_list|(
name|radeon_encoder
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_MASTER_CNTL
argument_list|,
operator|(
name|tv_master_cntl
operator||
name|RADEON_TV_ASYNC_RST
operator|)
argument_list|)
expr_stmt|;
comment|/* tv std */
name|WREG32
argument_list|(
name|RADEON_TV_SYNC_CNTL
argument_list|,
operator|(
name|RADEON_SYNC_PUB
operator||
name|RADEON_TV_SYNC_IO_DRIVE
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_TIMING_CNTL
argument_list|,
name|tv_dac
operator|->
name|tv
operator|.
name|timing_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_MODULATOR_CNTL1
argument_list|,
name|tv_modulator_cntl1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_MODULATOR_CNTL2
argument_list|,
name|tv_modulator_cntl2
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_PRE_DAC_MUX_CNTL
argument_list|,
operator|(
name|RADEON_Y_RED_EN
operator||
name|RADEON_C_GRN_EN
operator||
name|RADEON_CMP_BLU_EN
operator||
name|RADEON_DAC_DITHER_EN
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_CRC_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_MASTER_CNTL
argument_list|,
name|tv_master_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_GAIN_LIMIT_SETTINGS
argument_list|,
operator|(
operator|(
literal|0x17f
operator|<<
name|RADEON_UV_GAIN_LIMIT_SHIFT
operator|)
operator||
operator|(
literal|0x5ff
operator|<<
name|RADEON_Y_GAIN_LIMIT_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_LINEAR_GAIN_SETTINGS
argument_list|,
operator|(
operator|(
literal|0x100
operator|<<
name|RADEON_UV_GAIN_SHIFT
operator|)
operator||
operator|(
literal|0x100
operator|<<
name|RADEON_Y_GAIN_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|tv_dac_cntl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_legacy_tv_adjust_crtc_reg
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|uint32_t
modifier|*
name|h_total_disp
parameter_list|,
name|uint32_t
modifier|*
name|h_sync_strt_wid
parameter_list|,
name|uint32_t
modifier|*
name|v_total_disp
parameter_list|,
name|uint32_t
modifier|*
name|v_sync_strt_wid
parameter_list|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|radeon_tv_mode_constants
modifier|*
name|const_ptr
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|const_ptr
operator|=
name|radeon_legacy_tv_get_std_mode
argument_list|(
name|radeon_encoder
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|const_ptr
condition|)
return|return;
operator|*
name|h_total_disp
operator|=
operator|(
operator|(
operator|(
name|const_ptr
operator|->
name|hor_resolution
operator|/
literal|8
operator|)
operator|-
literal|1
operator|)
operator|<<
name|RADEON_CRTC_H_DISP_SHIFT
operator|)
operator||
operator|(
operator|(
operator|(
name|const_ptr
operator|->
name|hor_total
operator|/
literal|8
operator|)
operator|-
literal|1
operator|)
operator|<<
name|RADEON_CRTC_H_TOTAL_SHIFT
operator|)
expr_stmt|;
name|tmp
operator|=
operator|*
name|h_sync_strt_wid
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RADEON_CRTC_H_SYNC_STRT_PIX
operator||
name|RADEON_CRTC_H_SYNC_STRT_CHAR
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
operator|(
name|const_ptr
operator|->
name|hor_syncstart
operator|/
literal|8
operator|)
operator|-
literal|1
operator|)
operator|<<
name|RADEON_CRTC_H_SYNC_STRT_CHAR_SHIFT
operator|)
operator||
operator|(
name|const_ptr
operator|->
name|hor_syncstart
operator|&
literal|7
operator|)
expr_stmt|;
operator|*
name|h_sync_strt_wid
operator|=
name|tmp
expr_stmt|;
operator|*
name|v_total_disp
operator|=
operator|(
operator|(
name|const_ptr
operator|->
name|ver_resolution
operator|-
literal|1
operator|)
operator|<<
name|RADEON_CRTC_V_DISP_SHIFT
operator|)
operator||
operator|(
operator|(
name|const_ptr
operator|->
name|ver_total
operator|-
literal|1
operator|)
operator|<<
name|RADEON_CRTC_V_TOTAL_SHIFT
operator|)
expr_stmt|;
name|tmp
operator|=
operator|*
name|v_sync_strt_wid
expr_stmt|;
name|tmp
operator|&=
operator|~
name|RADEON_CRTC_V_SYNC_STRT
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|const_ptr
operator|->
name|ver_syncstart
operator|-
literal|1
operator|)
operator|<<
name|RADEON_CRTC_V_SYNC_STRT_SHIFT
operator|)
expr_stmt|;
operator|*
name|v_sync_strt_wid
operator|=
name|tmp
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_post_div
parameter_list|(
name|int
name|value
parameter_list|)
block|{
name|int
name|post_div
decl_stmt|;
switch|switch
condition|(
name|value
condition|)
block|{
case|case
literal|1
case|:
name|post_div
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|post_div
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|post_div
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|post_div
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|post_div
operator|=
literal|6
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|post_div
operator|=
literal|3
expr_stmt|;
break|break;
case|case
literal|12
case|:
name|post_div
operator|=
literal|7
expr_stmt|;
break|break;
case|case
literal|16
case|:
default|default:
name|post_div
operator|=
literal|5
expr_stmt|;
break|break;
block|}
return|return
name|post_div
return|;
block|}
end_function

begin_function
name|void
name|radeon_legacy_tv_adjust_pll1
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|uint32_t
modifier|*
name|htotal_cntl
parameter_list|,
name|uint32_t
modifier|*
name|ppll_ref_div
parameter_list|,
name|uint32_t
modifier|*
name|ppll_div_3
parameter_list|,
name|uint32_t
modifier|*
name|pixclks_cntl
parameter_list|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|radeon_tv_mode_constants
modifier|*
name|const_ptr
decl_stmt|;
name|const_ptr
operator|=
name|radeon_legacy_tv_get_std_mode
argument_list|(
name|radeon_encoder
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|const_ptr
condition|)
return|return;
operator|*
name|htotal_cntl
operator|=
operator|(
name|const_ptr
operator|->
name|hor_total
operator|&
literal|0x7
operator|)
operator||
name|RADEON_HTOT_CNTL_VGA_EN
expr_stmt|;
operator|*
name|ppll_ref_div
operator|=
name|const_ptr
operator|->
name|crtcPLL_M
expr_stmt|;
operator|*
name|ppll_div_3
operator|=
operator|(
name|const_ptr
operator|->
name|crtcPLL_N
operator|&
literal|0x7ff
operator|)
operator||
operator|(
name|get_post_div
argument_list|(
name|const_ptr
operator|->
name|crtcPLL_post_div
argument_list|)
operator|<<
literal|16
operator|)
expr_stmt|;
operator|*
name|pixclks_cntl
operator|&=
operator|~
operator|(
name|RADEON_PIX2CLK_SRC_SEL_MASK
operator||
name|RADEON_PIXCLK_TV_SRC_SEL
operator|)
expr_stmt|;
operator|*
name|pixclks_cntl
operator||=
name|RADEON_PIX2CLK_SRC_SEL_P2PLLCLK
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_legacy_tv_adjust_pll2
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|uint32_t
modifier|*
name|htotal2_cntl
parameter_list|,
name|uint32_t
modifier|*
name|p2pll_ref_div
parameter_list|,
name|uint32_t
modifier|*
name|p2pll_div_0
parameter_list|,
name|uint32_t
modifier|*
name|pixclks_cntl
parameter_list|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|radeon_tv_mode_constants
modifier|*
name|const_ptr
decl_stmt|;
name|const_ptr
operator|=
name|radeon_legacy_tv_get_std_mode
argument_list|(
name|radeon_encoder
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|const_ptr
condition|)
return|return;
operator|*
name|htotal2_cntl
operator|=
operator|(
name|const_ptr
operator|->
name|hor_total
operator|&
literal|0x7
operator|)
expr_stmt|;
operator|*
name|p2pll_ref_div
operator|=
name|const_ptr
operator|->
name|crtcPLL_M
expr_stmt|;
operator|*
name|p2pll_div_0
operator|=
operator|(
name|const_ptr
operator|->
name|crtcPLL_N
operator|&
literal|0x7ff
operator|)
operator||
operator|(
name|get_post_div
argument_list|(
name|const_ptr
operator|->
name|crtcPLL_post_div
argument_list|)
operator|<<
literal|16
operator|)
expr_stmt|;
operator|*
name|pixclks_cntl
operator|&=
operator|~
name|RADEON_PIX2CLK_SRC_SEL_MASK
expr_stmt|;
operator|*
name|pixclks_cntl
operator||=
name|RADEON_PIX2CLK_SRC_SEL_P2PLLCLK
operator||
name|RADEON_PIXCLK_TV_SRC_SEL
expr_stmt|;
block|}
end_function

end_unit


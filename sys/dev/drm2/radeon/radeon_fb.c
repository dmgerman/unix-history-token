begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright Â© 2007 David Airlie  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *     David Airlie  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<machine/_inttypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc_helper.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_fb_helper.h>
end_include

begin_comment
comment|/* object hierarchy -    this contains a helper + a radeon fb    the helper contains a pointer to radeon framebuffer baseclass. */
end_comment

begin_struct
struct|struct
name|radeon_fbdev
block|{
name|struct
name|drm_fb_helper
name|helper
decl_stmt|;
name|struct
name|radeon_framebuffer
name|rfb
decl_stmt|;
name|struct
name|list_head
name|fbdev_list
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
decl_stmt|;
block|}
struct|;
end_struct

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__linux__
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|struct
name|fb_ops
name|radeonfb_ops
init|=
block|{
operator|.
name|owner
operator|=
name|THIS_MODULE
block|,
operator|.
name|fb_check_var
operator|=
name|drm_fb_helper_check_var
block|,
operator|.
name|fb_set_par
operator|=
name|drm_fb_helper_set_par
block|,
operator|.
name|fb_fillrect
operator|=
name|cfb_fillrect
block|,
operator|.
name|fb_copyarea
operator|=
name|cfb_copyarea
block|,
operator|.
name|fb_imageblit
operator|=
name|cfb_imageblit
block|,
operator|.
name|fb_pan_display
operator|=
name|drm_fb_helper_pan_display
block|,
operator|.
name|fb_blank
operator|=
name|drm_fb_helper_blank
block|,
operator|.
name|fb_setcmap
operator|=
name|drm_fb_helper_setcmap
block|,
operator|.
name|fb_debug_enter
operator|=
name|drm_fb_helper_debug_enter
block|,
operator|.
name|fb_debug_leave
operator|=
name|drm_fb_helper_debug_leave
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|radeon_align_pitch
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|bpp
parameter_list|,
name|bool
name|tiled
parameter_list|)
block|{
name|int
name|aligned
init|=
name|width
decl_stmt|;
name|int
name|align_large
init|=
operator|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
operator|)
operator|||
name|tiled
decl_stmt|;
name|int
name|pitch_mask
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|bpp
operator|/
literal|8
condition|)
block|{
case|case
literal|1
case|:
name|pitch_mask
operator|=
name|align_large
condition|?
literal|255
else|:
literal|127
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|pitch_mask
operator|=
name|align_large
condition|?
literal|127
else|:
literal|31
expr_stmt|;
break|break;
case|case
literal|3
case|:
case|case
literal|4
case|:
name|pitch_mask
operator|=
name|align_large
condition|?
literal|63
else|:
literal|15
expr_stmt|;
break|break;
block|}
name|aligned
operator|+=
name|pitch_mask
expr_stmt|;
name|aligned
operator|&=
operator|~
name|pitch_mask
expr_stmt|;
return|return
name|aligned
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeonfb_destroy_pinned_object
parameter_list|(
name|struct
name|drm_gem_object
modifier|*
name|gobj
parameter_list|)
block|{
name|struct
name|radeon_bo
modifier|*
name|rbo
init|=
name|gem_to_radeon_bo
argument_list|(
name|gobj
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|radeon_bo_reserve
argument_list|(
name|rbo
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
name|ret
operator|==
literal|0
argument_list|)
condition|)
block|{
name|radeon_bo_kunmap
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
name|radeon_bo_unpin
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
block|}
name|drm_gem_object_unreference_unlocked
argument_list|(
name|gobj
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeonfb_create_pinned_object
parameter_list|(
name|struct
name|radeon_fbdev
modifier|*
name|rfbdev
parameter_list|,
name|struct
name|drm_mode_fb_cmd2
modifier|*
name|mode_cmd
parameter_list|,
name|struct
name|drm_gem_object
modifier|*
modifier|*
name|gobj_p
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|rfbdev
operator|->
name|rdev
decl_stmt|;
name|struct
name|drm_gem_object
modifier|*
name|gobj
init|=
name|NULL
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|rbo
init|=
name|NULL
decl_stmt|;
name|bool
name|fb_tiled
init|=
name|false
decl_stmt|;
comment|/* useful for testing */
name|u32
name|tiling_flags
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|aligned_size
decl_stmt|,
name|size
decl_stmt|;
name|int
name|height
init|=
name|mode_cmd
operator|->
name|height
decl_stmt|;
name|u32
name|bpp
decl_stmt|,
name|depth
decl_stmt|;
name|drm_fb_get_bpp_depth
argument_list|(
name|mode_cmd
operator|->
name|pixel_format
argument_list|,
operator|&
name|depth
argument_list|,
operator|&
name|bpp
argument_list|)
expr_stmt|;
comment|/* need to align pitch with crtc limits */
name|mode_cmd
operator|->
name|pitches
index|[
literal|0
index|]
operator|=
name|radeon_align_pitch
argument_list|(
name|rdev
argument_list|,
name|mode_cmd
operator|->
name|width
argument_list|,
name|bpp
argument_list|,
name|fb_tiled
argument_list|)
operator|*
operator|(
operator|(
name|bpp
operator|+
literal|1
operator|)
operator|/
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
name|height
operator|=
name|roundup2
argument_list|(
name|mode_cmd
operator|->
name|height
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|size
operator|=
name|mode_cmd
operator|->
name|pitches
index|[
literal|0
index|]
operator|*
name|height
expr_stmt|;
name|aligned_size
operator|=
name|roundup2
argument_list|(
name|size
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|radeon_gem_object_create
argument_list|(
name|rdev
argument_list|,
name|aligned_size
argument_list|,
literal|0
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|false
argument_list|,
name|true
argument_list|,
operator|&
name|gobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to allocate framebuffer (%d)\n"
argument_list|,
name|aligned_size
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|rbo
operator|=
name|gem_to_radeon_bo
argument_list|(
name|gobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|fb_tiled
condition|)
name|tiling_flags
operator|=
name|RADEON_TILING_MACRO
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
switch|switch
condition|(
name|bpp
condition|)
block|{
case|case
literal|32
case|:
name|tiling_flags
operator||=
name|RADEON_TILING_SWAP_32BIT
expr_stmt|;
break|break;
case|case
literal|16
case|:
name|tiling_flags
operator||=
name|RADEON_TILING_SWAP_16BIT
expr_stmt|;
default|default:
break|break;
block|}
endif|#
directive|endif
if|if
condition|(
name|tiling_flags
condition|)
block|{
name|ret
operator|=
name|radeon_bo_set_tiling_flags
argument_list|(
name|rbo
argument_list|,
name|tiling_flags
operator||
name|RADEON_TILING_SURFACE
argument_list|,
name|mode_cmd
operator|->
name|pitches
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"FB failed to set tiling flags\n"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|radeon_bo_reserve
argument_list|(
name|rbo
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ret
operator|!=
literal|0
argument_list|)
condition|)
goto|goto
name|out_unref
goto|;
comment|/* Only 27 bit offset for legacy CRTC */
name|ret
operator|=
name|radeon_bo_pin_restricted
argument_list|(
name|rbo
argument_list|,
name|RADEON_GEM_DOMAIN_VRAM
argument_list|,
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|?
literal|0
else|:
literal|1
operator|<<
literal|27
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|radeon_bo_unreserve
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
goto|goto
name|out_unref
goto|;
block|}
if|if
condition|(
name|fb_tiled
condition|)
name|radeon_bo_check_tiling
argument_list|(
name|rbo
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
name|radeon_bo_kmap
argument_list|(
name|rbo
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|radeon_bo_unreserve
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
goto|goto
name|out_unref
goto|;
block|}
operator|*
name|gobj_p
operator|=
name|gobj
expr_stmt|;
return|return
literal|0
return|;
name|out_unref
label|:
name|radeonfb_destroy_pinned_object
argument_list|(
name|gobj
argument_list|)
expr_stmt|;
operator|*
name|gobj_p
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeonfb_create
parameter_list|(
name|struct
name|radeon_fbdev
modifier|*
name|rfbdev
parameter_list|,
name|struct
name|drm_fb_helper_surface_size
modifier|*
name|sizes
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|rfbdev
operator|->
name|rdev
decl_stmt|;
name|struct
name|fb_info
modifier|*
name|info
decl_stmt|;
name|struct
name|drm_framebuffer
modifier|*
name|fb
init|=
name|NULL
decl_stmt|;
name|struct
name|drm_mode_fb_cmd2
name|mode_cmd
decl_stmt|;
name|struct
name|drm_gem_object
modifier|*
name|gobj
init|=
name|NULL
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|rbo
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|unsigned
name|long
name|tmp
decl_stmt|;
name|mode_cmd
operator|.
name|width
operator|=
name|sizes
operator|->
name|surface_width
expr_stmt|;
name|mode_cmd
operator|.
name|height
operator|=
name|sizes
operator|->
name|surface_height
expr_stmt|;
comment|/* avivo can't scanout real 24bpp */
if|if
condition|(
operator|(
name|sizes
operator|->
name|surface_bpp
operator|==
literal|24
operator|)
operator|&&
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
name|sizes
operator|->
name|surface_bpp
operator|=
literal|32
expr_stmt|;
name|mode_cmd
operator|.
name|pixel_format
operator|=
name|drm_mode_legacy_fb_format
argument_list|(
name|sizes
operator|->
name|surface_bpp
argument_list|,
name|sizes
operator|->
name|surface_depth
argument_list|)
expr_stmt|;
name|ret
operator|=
name|radeonfb_create_pinned_object
argument_list|(
name|rfbdev
argument_list|,
operator|&
name|mode_cmd
argument_list|,
operator|&
name|gobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to create fbcon object %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|rbo
operator|=
name|gem_to_radeon_bo
argument_list|(
name|gobj
argument_list|)
expr_stmt|;
name|info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|ret
operator|=
name|radeon_framebuffer_init
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
operator|&
name|rfbdev
operator|->
name|rfb
argument_list|,
operator|&
name|mode_cmd
argument_list|,
name|gobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to initalise framebuffer %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out_unref
goto|;
block|}
name|fb
operator|=
operator|&
name|rfbdev
operator|->
name|rfb
operator|.
name|base
expr_stmt|;
comment|/* setup helper */
name|rfbdev
operator|->
name|helper
operator|.
name|fb
operator|=
name|fb
expr_stmt|;
name|rfbdev
operator|->
name|helper
operator|.
name|fbdev
operator|=
name|info
expr_stmt|;
name|memset
argument_list|(
name|rbo
operator|->
name|kptr
argument_list|,
literal|0x0
argument_list|,
name|radeon_bo_size
argument_list|(
name|rbo
argument_list|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|radeon_bo_gpu_offset
argument_list|(
name|rbo
argument_list|)
operator|-
name|rdev
operator|->
name|mc
operator|.
name|vram_start
expr_stmt|;
name|info
operator|->
name|fb_size
operator|=
name|radeon_bo_size
argument_list|(
name|rbo
argument_list|)
expr_stmt|;
name|info
operator|->
name|fb_bpp
operator|=
name|sizes
operator|->
name|surface_bpp
expr_stmt|;
name|info
operator|->
name|fb_width
operator|=
name|sizes
operator|->
name|surface_width
expr_stmt|;
name|info
operator|->
name|fb_height
operator|=
name|sizes
operator|->
name|surface_height
expr_stmt|;
name|info
operator|->
name|fb_pbase
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_base
operator|+
name|tmp
expr_stmt|;
name|info
operator|->
name|fb_vbase
operator|=
operator|(
name|vm_offset_t
operator|)
name|rbo
operator|->
name|kptr
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"fb mappable at 0x%"
name|PRIXPTR
literal|"\n"
argument_list|,
name|info
operator|->
name|fb_pbase
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"vram apper at 0x%lX\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|rdev
operator|->
name|mc
operator|.
name|aper_base
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"size %lu\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|radeon_bo_size
argument_list|(
name|rbo
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"fb depth is %d\n"
argument_list|,
name|fb
operator|->
name|depth
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"   pitch is %d\n"
argument_list|,
name|fb
operator|->
name|pitches
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out_unref
label|:
if|if
condition|(
name|rbo
condition|)
block|{
comment|/* TODO? dumbbell@ */
block|}
if|if
condition|(
name|fb
operator|&&
name|ret
condition|)
block|{
name|drm_gem_object_unreference
argument_list|(
name|gobj
argument_list|)
expr_stmt|;
name|drm_framebuffer_cleanup
argument_list|(
name|fb
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fb
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
comment|/* XXX malloc'd in radeon_user_framebuffer_create? */
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_fb_find_or_create_single
parameter_list|(
name|struct
name|drm_fb_helper
modifier|*
name|helper
parameter_list|,
name|struct
name|drm_fb_helper_surface_size
modifier|*
name|sizes
parameter_list|)
block|{
name|struct
name|radeon_fbdev
modifier|*
name|rfbdev
init|=
operator|(
expr|struct
name|radeon_fbdev
operator|*
operator|)
name|helper
decl_stmt|;
name|int
name|new_fb
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|helper
operator|->
name|fb
condition|)
block|{
name|ret
operator|=
name|radeonfb_create
argument_list|(
name|rfbdev
argument_list|,
name|sizes
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|new_fb
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|new_fb
return|;
block|}
end_function

begin_function
name|void
name|radeon_fb_output_poll_changed
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|drm_fb_helper_hotplug_event
argument_list|(
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|rfbdev
operator|->
name|helper
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_fbdev_destroy
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|radeon_fbdev
modifier|*
name|rfbdev
parameter_list|)
block|{
name|struct
name|fb_info
modifier|*
name|info
decl_stmt|;
name|struct
name|radeon_framebuffer
modifier|*
name|rfb
init|=
operator|&
name|rfbdev
operator|->
name|rfb
decl_stmt|;
if|if
condition|(
name|rfbdev
operator|->
name|helper
operator|.
name|fbdev
condition|)
block|{
name|info
operator|=
name|rfbdev
operator|->
name|helper
operator|.
name|fbdev
expr_stmt|;
name|free
argument_list|(
name|info
operator|->
name|fb_priv
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|info
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rfb
operator|->
name|obj
condition|)
block|{
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Work around lock recursion. dumbbell@ */
name|radeonfb_destroy_pinned_object
argument_list|(
name|rfb
operator|->
name|obj
argument_list|)
expr_stmt|;
name|DRM_LOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|rfb
operator|->
name|obj
operator|=
name|NULL
expr_stmt|;
block|}
name|drm_fb_helper_fini
argument_list|(
operator|&
name|rfbdev
operator|->
name|helper
argument_list|)
expr_stmt|;
name|drm_framebuffer_cleanup
argument_list|(
operator|&
name|rfb
operator|->
name|base
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|drm_fb_helper_funcs
name|radeon_fb_helper_funcs
init|=
block|{
operator|.
name|gamma_set
operator|=
name|radeon_crtc_fb_gamma_set
block|,
operator|.
name|gamma_get
operator|=
name|radeon_crtc_fb_gamma_get
block|,
operator|.
name|fb_probe
operator|=
name|radeon_fb_find_or_create_single
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|radeon_fbdev_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_fbdev
modifier|*
name|rfbdev
decl_stmt|;
name|int
name|bpp_sel
init|=
literal|32
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* select 8 bpp console on RN50 or 16MB cards */
if|if
condition|(
name|ASIC_IS_RN50
argument_list|(
name|rdev
argument_list|)
operator|||
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|<=
operator|(
literal|32
operator|*
literal|1024
operator|*
literal|1024
operator|)
condition|)
name|bpp_sel
operator|=
literal|8
expr_stmt|;
name|rfbdev
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_fbdev
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rfbdev
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|rfbdev
operator|->
name|rdev
operator|=
name|rdev
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|rfbdev
operator|=
name|rfbdev
expr_stmt|;
name|rfbdev
operator|->
name|helper
operator|.
name|funcs
operator|=
operator|&
name|radeon_fb_helper_funcs
expr_stmt|;
name|ret
operator|=
name|drm_fb_helper_init
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
operator|&
name|rfbdev
operator|->
name|helper
argument_list|,
name|rdev
operator|->
name|num_crtc
argument_list|,
name|RADEONFB_CONN_LIMIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|rfbdev
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|drm_fb_helper_single_add_all_connectors
argument_list|(
operator|&
name|rfbdev
operator|->
name|helper
argument_list|)
expr_stmt|;
name|drm_fb_helper_initial_config
argument_list|(
operator|&
name|rfbdev
operator|->
name|helper
argument_list|,
name|bpp_sel
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|radeon_fbdev_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|rdev
operator|->
name|mode_info
operator|.
name|rfbdev
condition|)
return|return;
name|radeon_fbdev_destroy
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|rfbdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|rfbdev
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|rfbdev
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_fbdev_set_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|state
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
name|fb_set_suspend
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|rfbdev
operator|->
name|helper
operator|.
name|fbdev
argument_list|,
name|state
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
block|}
end_function

begin_function
name|int
name|radeon_fbdev_total_size
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_bo
modifier|*
name|robj
decl_stmt|;
name|int
name|size
init|=
literal|0
decl_stmt|;
name|robj
operator|=
name|gem_to_radeon_bo
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|rfbdev
operator|->
name|rfb
operator|.
name|obj
argument_list|)
expr_stmt|;
name|size
operator|+=
name|radeon_bo_size
argument_list|(
name|robj
argument_list|)
expr_stmt|;
return|return
name|size
return|;
block|}
end_function

begin_function
name|bool
name|radeon_fbdev_robj_is_fb
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_bo
modifier|*
name|robj
parameter_list|)
block|{
if|if
condition|(
name|robj
operator|==
name|gem_to_radeon_bo
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|rfbdev
operator|->
name|rfb
operator|.
name|obj
argument_list|)
condition|)
return|return
name|true
return|;
return|return
name|false
return|;
block|}
end_function

begin_function
name|struct
name|fb_info
modifier|*
name|radeon_fb_helper_getinfo
parameter_list|(
name|device_t
name|kdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
decl_stmt|;
name|struct
name|radeon_fbdev
modifier|*
name|rfbdev
decl_stmt|;
name|struct
name|fb_info
modifier|*
name|info
decl_stmt|;
name|dev
operator|=
name|device_get_softc
argument_list|(
name|kdev
argument_list|)
expr_stmt|;
name|rdev
operator|=
name|dev
operator|->
name|dev_private
expr_stmt|;
name|rfbdev
operator|=
name|rdev
operator|->
name|mode_info
operator|.
name|rfbdev
expr_stmt|;
if|if
condition|(
name|rfbdev
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|info
operator|=
name|rfbdev
operator|->
name|helper
operator|.
name|fbdev
expr_stmt|;
return|return
operator|(
name|info
operator|)
return|;
block|}
end_function

end_unit


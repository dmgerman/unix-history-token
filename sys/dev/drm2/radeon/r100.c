begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  * Copyright 2009 Jerome Glisse.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  *          Jerome Glisse  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon_reg.h"
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_include
include|#
directive|include
file|"r100d.h"
end_include

begin_include
include|#
directive|include
file|"rs100d.h"
end_include

begin_include
include|#
directive|include
file|"rv200d.h"
end_include

begin_include
include|#
directive|include
file|"rv250d.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"r100_reg_safe.h"
end_include

begin_include
include|#
directive|include
file|"rn50_reg_safe.h"
end_include

begin_comment
comment|/* Firmware Names */
end_comment

begin_define
define|#
directive|define
name|FIRMWARE_R100
value|"radeonkmsfw_R100_cp"
end_define

begin_define
define|#
directive|define
name|FIRMWARE_R200
value|"radeonkmsfw_R200_cp"
end_define

begin_define
define|#
directive|define
name|FIRMWARE_R300
value|"radeonkmsfw_R300_cp"
end_define

begin_define
define|#
directive|define
name|FIRMWARE_R420
value|"radeonkmsfw_R420_cp"
end_define

begin_define
define|#
directive|define
name|FIRMWARE_RS690
value|"radeonkmsfw_RS690_cp"
end_define

begin_define
define|#
directive|define
name|FIRMWARE_RS600
value|"radeonkmsfw_RS600_cp"
end_define

begin_define
define|#
directive|define
name|FIRMWARE_R520
value|"radeonkmsfw_R520_cp"
end_define

begin_include
include|#
directive|include
file|"r100_track.h"
end_include

begin_comment
comment|/* This files gather functions specifics to:  * r100,rv100,rs100,rv200,rs200,r200,rv250,rs300,rv280  * and others in some cases.  */
end_comment

begin_comment
comment|/**  * r100_wait_for_vblank - vblank wait asic callback.  *  * @rdev: radeon_device pointer  * @crtc: crtc to wait for vblank on  *  * Wait for vblank on the requested crtc (r1xx-r4xx).  */
end_comment

begin_function
name|void
name|r100_wait_for_vblank
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|crtc
operator|>=
name|rdev
operator|->
name|num_crtc
condition|)
return|return;
if|if
condition|(
name|crtc
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|)
operator|&
name|RADEON_CRTC_EN
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|RADEON_CRTC_STATUS
argument_list|)
operator|&
name|RADEON_CRTC_VBLANK_CUR
operator|)
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_CRTC_STATUS
argument_list|)
operator|&
name|RADEON_CRTC_VBLANK_CUR
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|)
operator|&
name|RADEON_CRTC2_EN
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RREG32
argument_list|(
name|RADEON_CRTC2_STATUS
argument_list|)
operator|&
name|RADEON_CRTC2_VBLANK_CUR
operator|)
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_CRTC2_STATUS
argument_list|)
operator|&
name|RADEON_CRTC2_VBLANK_CUR
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * r100_pre_page_flip - pre-pageflip callback.  *  * @rdev: radeon_device pointer  * @crtc: crtc to prepare for pageflip on  *  * Pre-pageflip callback (r1xx-r4xx).  * Enables the pageflip irq (vblank irq).  */
end_comment

begin_function
name|void
name|r100_pre_page_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
comment|/* enable the pflip int */
name|radeon_irq_kms_pflip_irq_get
argument_list|(
name|rdev
argument_list|,
name|crtc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * r100_post_page_flip - pos-pageflip callback.  *  * @rdev: radeon_device pointer  * @crtc: crtc to cleanup pageflip on  *  * Post-pageflip callback (r1xx-r4xx).  * Disables the pageflip irq (vblank irq).  */
end_comment

begin_function
name|void
name|r100_post_page_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
comment|/* disable the pflip int */
name|radeon_irq_kms_pflip_irq_put
argument_list|(
name|rdev
argument_list|,
name|crtc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * r100_page_flip - pageflip callback.  *  * @rdev: radeon_device pointer  * @crtc_id: crtc to cleanup pageflip on  * @crtc_base: new address of the crtc (GPU MC address)  *  * Does the actual pageflip (r1xx-r4xx).  * During vblank we take the crtc lock and wait for the update_pending  * bit to go high, when it does, we release the lock, and allow the  * double buffered update to take place.  * Returns the current update pending status.  */
end_comment

begin_function
name|u32
name|r100_page_flip
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc_id
parameter_list|,
name|u64
name|crtc_base
parameter_list|)
block|{
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
init|=
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
name|crtc_id
index|]
decl_stmt|;
name|u32
name|tmp
init|=
operator|(
operator|(
name|u32
operator|)
name|crtc_base
operator|)
operator||
name|RADEON_CRTC_OFFSET__OFFSET_LOCK
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Lock the graphics update lock */
comment|/* update the scanout addresses */
name|WREG32
argument_list|(
name|RADEON_CRTC_OFFSET
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Wait for update_pending to go high. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_CRTC_OFFSET
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
operator|&
name|RADEON_CRTC_OFFSET__GUI_TRIG_OFFSET
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"Update pending now high. Unlocking vupdate_lock.\n"
argument_list|)
expr_stmt|;
comment|/* Unlock the lock, so double-buffering can take place inside vblank */
name|tmp
operator|&=
operator|~
name|RADEON_CRTC_OFFSET__OFFSET_LOCK
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_OFFSET
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Return current update_pending status: */
return|return
name|RREG32
argument_list|(
name|RADEON_CRTC_OFFSET
operator|+
name|radeon_crtc
operator|->
name|crtc_offset
argument_list|)
operator|&
name|RADEON_CRTC_OFFSET__GUI_TRIG_OFFSET
return|;
block|}
end_function

begin_comment
comment|/**  * r100_pm_get_dynpm_state - look up dynpm power state callback.  *  * @rdev: radeon_device pointer  *  * Look up the optimal power state based on the  * current state of the GPU (r1xx-r5xx).  * Used for dynpm only.  */
end_comment

begin_function
name|void
name|r100_pm_get_dynpm_state
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_upclock
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_downclock
operator|=
name|true
expr_stmt|;
switch|switch
condition|(
name|rdev
operator|->
name|pm
operator|.
name|dynpm_planned_action
condition|)
block|{
case|case
name|DYNPM_ACTION_MINIMUM
case|:
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_downclock
operator|=
name|false
expr_stmt|;
break|break;
case|case
name|DYNPM_ACTION_DOWNCLOCK
case|:
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|==
literal|0
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_downclock
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|active_crtc_count
operator|>
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
condition|)
continue|continue;
elseif|else
if|if
condition|(
name|i
operator|>=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
expr_stmt|;
break|break;
block|}
else|else
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|-
literal|1
expr_stmt|;
block|}
comment|/* don't use the power state if crtcs are active and no display flag is set */
if|if
condition|(
operator|(
name|rdev
operator|->
name|pm
operator|.
name|active_crtc_count
operator|>
literal|0
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|flags
operator|&
name|RADEON_PM_MODE_NO_DISPLAY
operator|)
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|DYNPM_ACTION_UPCLOCK
case|:
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|==
operator|(
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|-
literal|1
operator|)
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_upclock
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|active_crtc_count
operator|>
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
operator|(
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|-
literal|1
operator|)
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
condition|)
continue|continue;
elseif|else
if|if
condition|(
name|i
operator|<=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
expr_stmt|;
break|break;
block|}
else|else
block|{
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|+
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|DYNPM_ACTION_DEFAULT
case|:
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|dynpm_can_upclock
operator|=
name|false
expr_stmt|;
break|break;
case|case
name|DYNPM_ACTION_NONE
case|:
default|default:
name|DRM_ERROR
argument_list|(
literal|"Requested mode for not defined action\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* only one clock mode per power state */
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
operator|=
literal|0
expr_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Requested: e: %d m: %d p: %d\n"
argument_list|,
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|clock_info
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
index|]
operator|.
name|sclk
argument_list|,
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|clock_info
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_clock_mode_index
index|]
operator|.
name|mclk
argument_list|,
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
index|]
operator|.
name|pcie_lanes
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * r100_pm_init_profile - Initialize power profiles callback.  *  * @rdev: radeon_device pointer  *  * Initialize the power states used in profile mode  * (r1xx-r3xx).  * Used for profile mode only.  */
end_comment

begin_function
name|void
name|r100_pm_init_profile
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* default */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_DEFAULT_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high sh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_SH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* low mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_LOW_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* mid mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_MID_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
comment|/* high mh */
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_ps_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_ps_idx
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_off_cm_idx
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|profiles
index|[
name|PM_PROFILE_HIGH_MH_IDX
index|]
operator|.
name|dpms_on_cm_idx
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * r100_pm_misc - set additional pm hw parameters callback.  *  * @rdev: radeon_device pointer  *  * Set non-clock parameters associated with a power state  * (voltage, pcie lanes, etc.) (r1xx-r4xx).  */
end_comment

begin_function
name|void
name|r100_pm_misc
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|requested_index
init|=
name|rdev
operator|->
name|pm
operator|.
name|requested_power_state_index
decl_stmt|;
name|struct
name|radeon_power_state
modifier|*
name|ps
init|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|requested_index
index|]
decl_stmt|;
name|struct
name|radeon_voltage
modifier|*
name|voltage
init|=
operator|&
name|ps
operator|->
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
decl_stmt|;
name|u32
name|tmp
decl_stmt|,
name|sclk_cntl
decl_stmt|,
name|sclk_cntl2
decl_stmt|,
name|sclk_more_cntl
decl_stmt|;
if|if
condition|(
operator|(
name|voltage
operator|->
name|type
operator|==
name|VOLTAGE_GPIO
operator|)
operator|&&
operator|(
name|voltage
operator|->
name|gpio
operator|.
name|valid
operator|)
condition|)
block|{
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_SUPPORT
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|voltage
operator|->
name|gpio
operator|.
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|voltage
operator|->
name|active_high
condition|)
name|tmp
operator||=
name|voltage
operator|->
name|gpio
operator|.
name|mask
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
operator|(
name|voltage
operator|->
name|gpio
operator|.
name|mask
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|voltage
operator|->
name|gpio
operator|.
name|reg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|voltage
operator|->
name|delay
condition|)
name|DRM_UDELAY
argument_list|(
name|voltage
operator|->
name|delay
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|voltage
operator|->
name|gpio
operator|.
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|voltage
operator|->
name|active_high
condition|)
name|tmp
operator|&=
operator|~
name|voltage
operator|->
name|gpio
operator|.
name|mask
expr_stmt|;
else|else
name|tmp
operator||=
name|voltage
operator|->
name|gpio
operator|.
name|mask
expr_stmt|;
name|WREG32
argument_list|(
name|voltage
operator|->
name|gpio
operator|.
name|reg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|voltage
operator|->
name|delay
condition|)
name|DRM_UDELAY
argument_list|(
name|voltage
operator|->
name|delay
argument_list|)
expr_stmt|;
block|}
block|}
name|sclk_cntl
operator|=
name|RREG32_PLL
argument_list|(
name|SCLK_CNTL
argument_list|)
expr_stmt|;
name|sclk_cntl2
operator|=
name|RREG32_PLL
argument_list|(
name|SCLK_CNTL2
argument_list|)
expr_stmt|;
name|sclk_cntl2
operator|&=
operator|~
name|REDUCED_SPEED_SCLK_SEL
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|sclk_more_cntl
operator|=
name|RREG32_PLL
argument_list|(
name|SCLK_MORE_CNTL
argument_list|)
expr_stmt|;
name|sclk_more_cntl
operator|&=
operator|~
name|VOLTAGE_DELAY_SEL
argument_list|(
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_ASIC_REDUCED_SPEED_SCLK_EN
condition|)
block|{
name|sclk_more_cntl
operator||=
name|REDUCED_SPEED_SCLK_EN
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_DYN_CLK_3D_IDLE
condition|)
name|sclk_cntl2
operator||=
name|REDUCED_SPEED_SCLK_MODE
expr_stmt|;
else|else
name|sclk_cntl2
operator|&=
operator|~
name|REDUCED_SPEED_SCLK_MODE
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_DYNAMIC_CLOCK_DIVIDER_BY_2
condition|)
name|sclk_cntl2
operator||=
name|REDUCED_SPEED_SCLK_SEL
argument_list|(
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_DYNAMIC_CLOCK_DIVIDER_BY_4
condition|)
name|sclk_cntl2
operator||=
name|REDUCED_SPEED_SCLK_SEL
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
name|sclk_more_cntl
operator|&=
operator|~
name|REDUCED_SPEED_SCLK_EN
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_ASIC_DYNAMIC_VOLTAGE_EN
condition|)
block|{
name|sclk_more_cntl
operator||=
name|IO_CG_VOLTAGE_DROP
expr_stmt|;
if|if
condition|(
name|voltage
operator|->
name|delay
condition|)
block|{
name|sclk_more_cntl
operator||=
name|VOLTAGE_DROP_SYNC
expr_stmt|;
switch|switch
condition|(
name|voltage
operator|->
name|delay
condition|)
block|{
case|case
literal|33
case|:
name|sclk_more_cntl
operator||=
name|VOLTAGE_DELAY_SEL
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|66
case|:
name|sclk_more_cntl
operator||=
name|VOLTAGE_DELAY_SEL
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|99
case|:
name|sclk_more_cntl
operator||=
name|VOLTAGE_DELAY_SEL
argument_list|(
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|132
case|:
name|sclk_more_cntl
operator||=
name|VOLTAGE_DELAY_SEL
argument_list|(
literal|3
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
name|sclk_more_cntl
operator|&=
operator|~
name|VOLTAGE_DROP_SYNC
expr_stmt|;
block|}
else|else
name|sclk_more_cntl
operator|&=
operator|~
name|IO_CG_VOLTAGE_DROP
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|misc
operator|&
name|ATOM_PM_MISCINFO_DYNAMIC_HDP_BLOCK_EN
condition|)
name|sclk_cntl
operator|&=
operator|~
name|FORCE_HDP
expr_stmt|;
else|else
name|sclk_cntl
operator||=
name|FORCE_HDP
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|SCLK_CNTL
argument_list|,
name|sclk_cntl
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|SCLK_CNTL2
argument_list|,
name|sclk_cntl2
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|SCLK_MORE_CNTL
argument_list|,
name|sclk_more_cntl
argument_list|)
expr_stmt|;
comment|/* set pcie lanes */
if|if
condition|(
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
operator|)
operator|&&
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
operator|&&
name|rdev
operator|->
name|asic
operator|->
name|pm
operator|.
name|set_pcie_lanes
operator|&&
operator|(
name|ps
operator|->
name|pcie_lanes
operator|!=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
index|]
operator|.
name|pcie_lanes
operator|)
condition|)
block|{
name|radeon_set_pcie_lanes
argument_list|(
name|rdev
argument_list|,
name|ps
operator|->
name|pcie_lanes
argument_list|)
expr_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Setting: p: %d\n"
argument_list|,
name|ps
operator|->
name|pcie_lanes
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * r100_pm_prepare - pre-power state change callback.  *  * @rdev: radeon_device pointer  *  * Prepare for a power state change (r1xx-r4xx).  */
end_comment

begin_function
name|void
name|r100_pm_prepare
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|ddev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* disable any active CRTCs */
name|list_for_each_entry
argument_list|(
argument|crtc
argument_list|,
argument|&ddev->mode_config.crtc_list
argument_list|,
argument|head
argument_list|)
block|{
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|enabled
condition|)
block|{
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|RADEON_CRTC2_DISP_REQ_EN_B
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|RADEON_CRTC_DISP_REQ_EN_B
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * r100_pm_finish - post-power state change callback.  *  * @rdev: radeon_device pointer  *  * Clean up after a power state change (r1xx-r4xx).  */
end_comment

begin_function
name|void
name|r100_pm_finish
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|ddev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* enable any active CRTCs */
name|list_for_each_entry
argument_list|(
argument|crtc
argument_list|,
argument|&ddev->mode_config.crtc_list
argument_list|,
argument|head
argument_list|)
block|{
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_crtc
operator|->
name|enabled
condition|)
block|{
if|if
condition|(
name|radeon_crtc
operator|->
name|crtc_id
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|RADEON_CRTC2_DISP_REQ_EN_B
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC2_GEN_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|RADEON_CRTC_DISP_REQ_EN_B
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * r100_gui_idle - gui idle callback.  *  * @rdev: radeon_device pointer  *  * Check of the GUI (2D/3D engines) are idle (r1xx-r5xx).  * Returns true if idle, false if not.  */
end_comment

begin_function
name|bool
name|r100_gui_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_RBBM_STATUS
argument_list|)
operator|&
name|RADEON_RBBM_ACTIVE
condition|)
return|return
name|false
return|;
else|else
return|return
name|true
return|;
block|}
end_function

begin_comment
comment|/* hpd for digital panel detect/disconnect */
end_comment

begin_comment
comment|/**  * r100_hpd_sense - hpd sense callback.  *  * @rdev: radeon_device pointer  * @hpd: hpd (hotplug detect) pin  *  * Checks if a digital monitor is connected (r1xx-r4xx).  * Returns true if connected, false if not connected.  */
end_comment

begin_function
name|bool
name|r100_hpd_sense
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|enum
name|radeon_hpd_id
name|hpd
parameter_list|)
block|{
name|bool
name|connected
init|=
name|false
decl_stmt|;
switch|switch
condition|(
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_FP_GEN_CNTL
argument_list|)
operator|&
name|RADEON_FP_DETECT_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|)
operator|&
name|RADEON_FP2_DETECT_SENSE
condition|)
name|connected
operator|=
name|true
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|connected
return|;
block|}
end_function

begin_comment
comment|/**  * r100_hpd_set_polarity - hpd set polarity callback.  *  * @rdev: radeon_device pointer  * @hpd: hpd (hotplug detect) pin  *  * Set the polarity of the hpd pin (r1xx-r4xx).  */
end_comment

begin_function
name|void
name|r100_hpd_set_polarity
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|enum
name|radeon_hpd_id
name|hpd
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|bool
name|connected
init|=
name|r100_hpd_sense
argument_list|(
name|rdev
argument_list|,
name|hpd
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|hpd
condition|)
block|{
case|case
name|RADEON_HPD_1
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_FP_GEN_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|RADEON_FP_DETECT_INT_POL
expr_stmt|;
else|else
name|tmp
operator||=
name|RADEON_FP_DETECT_INT_POL
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP_GEN_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_HPD_2
case|:
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|tmp
operator|&=
operator|~
name|RADEON_FP2_DETECT_INT_POL
expr_stmt|;
else|else
name|tmp
operator||=
name|RADEON_FP2_DETECT_INT_POL
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_FP2_GEN_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_comment
comment|/**  * r100_hpd_init - hpd setup callback.  *  * @rdev: radeon_device pointer  *  * Setup the hpd pins used by the card (r1xx-r4xx).  * Set the polarity, and enable the hpd interrupts.  */
end_comment

begin_function
name|void
name|r100_hpd_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|unsigned
name|enable
init|=
literal|0
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|connector
argument_list|,
argument|&dev->mode_config.connector_list
argument_list|,
argument|head
argument_list|)
block|{
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
init|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|enable
operator||=
literal|1
operator|<<
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
expr_stmt|;
name|radeon_hpd_set_polarity
argument_list|(
name|rdev
argument_list|,
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
argument_list|)
expr_stmt|;
block|}
name|radeon_irq_kms_enable_hpd
argument_list|(
name|rdev
argument_list|,
name|enable
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * r100_hpd_fini - hpd tear down callback.  *  * @rdev: radeon_device pointer  *  * Tear down the hpd pins used by the card (r1xx-r4xx).  * Disable the hpd interrupts.  */
end_comment

begin_function
name|void
name|r100_hpd_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|unsigned
name|disable
init|=
literal|0
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|connector
argument_list|,
argument|&dev->mode_config.connector_list
argument_list|,
argument|head
argument_list|)
block|{
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
init|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|disable
operator||=
literal|1
operator|<<
name|radeon_connector
operator|->
name|hpd
operator|.
name|hpd
expr_stmt|;
block|}
name|radeon_irq_kms_disable_hpd
argument_list|(
name|rdev
argument_list|,
name|disable
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PCI GART  */
end_comment

begin_function
name|void
name|r100_pci_gart_tlb_flush
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* TODO: can we do somethings here ? */
comment|/* It seems hw only cache one entry so we should discard this 	 * entry otherwise if first GPU GART read hit this entry it 	 * could end up in wrong address. */
block|}
end_function

begin_function
name|int
name|r100_pci_gart_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|gart
operator|.
name|ptr
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"R100 PCI GART already initialized\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Initialize common gart structure */
name|r
operator|=
name|radeon_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|rdev
operator|->
name|gart
operator|.
name|table_size
operator|=
name|rdev
operator|->
name|gart
operator|.
name|num_gpu_pages
operator|*
literal|4
expr_stmt|;
name|rdev
operator|->
name|asic
operator|->
name|gart
operator|.
name|tlb_flush
operator|=
operator|&
name|r100_pci_gart_tlb_flush
expr_stmt|;
name|rdev
operator|->
name|asic
operator|->
name|gart
operator|.
name|set_page
operator|=
operator|&
name|r100_pci_gart_set_page
expr_stmt|;
return|return
name|radeon_gart_table_ram_alloc
argument_list|(
name|rdev
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|r100_pci_gart_enable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|radeon_gart_restore
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* discard memory request outside of configured range */
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_AIC_CNTL
argument_list|)
operator||
name|RADEON_DIS_OUT_OF_PCI_GART_ACCESS
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_AIC_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* set address range for PCI address translate */
name|WREG32
argument_list|(
name|RADEON_AIC_LO_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_AIC_HI_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
argument_list|)
expr_stmt|;
comment|/* set PCI GART page-table base address */
name|WREG32
argument_list|(
name|RADEON_AIC_PT_BASE
argument_list|,
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_AIC_CNTL
argument_list|)
operator||
name|RADEON_PCIGART_TRANSLATE_EN
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_AIC_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|r100_pci_gart_tlb_flush
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"PCI GART of %uM enabled (table at 0x%016llX).\n"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_size
operator|>>
literal|20
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|rdev
operator|->
name|gart
operator|.
name|table_addr
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|gart
operator|.
name|ready
operator|=
name|true
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r100_pci_gart_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
comment|/* discard memory request outside of configured range */
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_AIC_CNTL
argument_list|)
operator||
name|RADEON_DIS_OUT_OF_PCI_GART_ACCESS
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_AIC_CNTL
argument_list|,
name|tmp
operator|&
operator|~
name|RADEON_PCIGART_TRANSLATE_EN
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_AIC_LO_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_AIC_HI_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r100_pci_gart_set_page
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|i
parameter_list|,
name|uint64_t
name|addr
parameter_list|)
block|{
name|u32
modifier|*
name|gtt
init|=
name|rdev
operator|->
name|gart
operator|.
name|ptr
decl_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
operator|||
name|i
operator|>
name|rdev
operator|->
name|gart
operator|.
name|num_gpu_pages
condition|)
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
name|gtt
index|[
name|i
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|lower_32_bits
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r100_pci_gart_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|radeon_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_pci_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gart_table_ram_free
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r100_irq_set
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|irq
operator|.
name|installed
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Can't enable IRQ/MSI because no handler is installed\n"
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000040_GEN_INT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|ring_int
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|)
condition|)
block|{
name|tmp
operator||=
name|RADEON_SW_INT_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|0
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|tmp
operator||=
name|RADEON_CRTC_VBLANK_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|1
index|]
operator|||
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|tmp
operator||=
name|RADEON_CRTC2_VBLANK_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|0
index|]
condition|)
block|{
name|tmp
operator||=
name|RADEON_FP_DETECT_MASK
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|hpd
index|[
literal|1
index|]
condition|)
block|{
name|tmp
operator||=
name|RADEON_FP2_DETECT_MASK
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_GEN_INT_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r100_irq_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|WREG32
argument_list|(
name|R_000040_GEN_INT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Wait and acknowledge irq */
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_000044_GEN_INT_STATUS
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000044_GEN_INT_STATUS
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|r100_irq_ack
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|irqs
init|=
name|RREG32
argument_list|(
name|RADEON_GEN_INT_STATUS
argument_list|)
decl_stmt|;
name|uint32_t
name|irq_mask
init|=
name|RADEON_SW_INT_TEST
operator||
name|RADEON_CRTC_VBLANK_STAT
operator||
name|RADEON_CRTC2_VBLANK_STAT
operator||
name|RADEON_FP_DETECT_STAT
operator||
name|RADEON_FP2_DETECT_STAT
decl_stmt|;
if|if
condition|(
name|irqs
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_GEN_INT_STATUS
argument_list|,
name|irqs
argument_list|)
expr_stmt|;
block|}
return|return
name|irqs
operator|&
name|irq_mask
return|;
block|}
end_function

begin_function
name|irqreturn_t
name|r100_irq_process
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|status
decl_stmt|,
name|msi_rearm
decl_stmt|;
name|bool
name|queue_hotplug
init|=
name|false
decl_stmt|;
name|status
operator|=
name|r100_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
block|{
return|return
name|IRQ_NONE
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|shutdown
condition|)
block|{
return|return
name|IRQ_NONE
return|;
block|}
while|while
condition|(
name|status
condition|)
block|{
comment|/* SW interrupt */
if|if
condition|(
name|status
operator|&
name|RADEON_SW_INT_TEST
condition|)
block|{
name|radeon_fence_process
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
block|}
comment|/* Vertical blank interrupts */
if|if
condition|(
name|status
operator|&
name|RADEON_CRTC_VBLANK_STAT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|0
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|0
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|RADEON_CRTC2_VBLANK_STAT
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|irq
operator|.
name|crtc_vblank_int
index|[
literal|1
index|]
condition|)
block|{
name|drm_handle_vblank
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|vblank_sync
operator|=
name|true
expr_stmt|;
name|DRM_WAKEUP
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|vblank_queue
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|rdev
operator|->
name|irq
operator|.
name|pflip
index|[
literal|1
index|]
argument_list|)
condition|)
name|radeon_crtc_handle_flip
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|RADEON_FP_DETECT_STAT
condition|)
block|{
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"HPD1\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|RADEON_FP2_DETECT_STAT
condition|)
block|{
name|queue_hotplug
operator|=
name|true
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"HPD2\n"
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|r100_irq_ack
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|queue_hotplug
condition|)
name|taskqueue_enqueue
argument_list|(
name|rdev
operator|->
name|tq
argument_list|,
operator|&
name|rdev
operator|->
name|hotplug_work
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|msi_enabled
condition|)
block|{
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_RS400
case|:
case|case
name|CHIP_RS480
case|:
name|msi_rearm
operator|=
name|RREG32
argument_list|(
name|RADEON_AIC_CNTL
argument_list|)
operator|&
operator|~
name|RS400_MSI_REARM
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_AIC_CNTL
argument_list|,
name|msi_rearm
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_AIC_CNTL
argument_list|,
name|msi_rearm
operator||
name|RS400_MSI_REARM
argument_list|)
expr_stmt|;
break|break;
default|default:
name|WREG32
argument_list|(
name|RADEON_MSI_REARM_EN
argument_list|,
name|RV370_MSI_REARM_EN
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
name|IRQ_HANDLED
return|;
block|}
end_function

begin_function
name|u32
name|r100_get_vblank_counter
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
if|if
condition|(
name|crtc
operator|==
literal|0
condition|)
return|return
name|RREG32
argument_list|(
name|RADEON_CRTC_CRNT_FRAME
argument_list|)
return|;
else|else
return|return
name|RREG32
argument_list|(
name|RADEON_CRTC2_CRNT_FRAME
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Who ever call radeon_fence_emit should call ring_lock and ask  * for enough space (today caller are ib schedule and buffer move) */
end_comment

begin_function
name|void
name|r100_fence_ring_emit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_fence
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|fence
operator|->
name|ring
index|]
decl_stmt|;
comment|/* We have to make sure that caches are flushed before 	 * CPU might read something from VRAM. */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_RB3D_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_RB3D_DC_FLUSH_ALL
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_RB3D_ZCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_RB3D_ZC_FLUSH_ALL
argument_list|)
expr_stmt|;
comment|/* Wait until IDLE& CLEAN */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_WAIT_2D_IDLECLEAN
operator||
name|RADEON_WAIT_3D_IDLECLEAN
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|hdp_cntl
operator||
name|RADEON_HDP_READ_BUFFER_INVALIDATE
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|hdp_cntl
argument_list|)
expr_stmt|;
comment|/* Emit fence sequence& fire IRQ */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|rdev
operator|->
name|fence_drv
index|[
name|fence
operator|->
name|ring
index|]
operator|.
name|scratch_reg
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|fence
operator|->
name|seq
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_GEN_INT_STATUS
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_SW_INT_FIRE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r100_semaphore_ring_emit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|,
name|struct
name|radeon_semaphore
modifier|*
name|semaphore
parameter_list|,
name|bool
name|emit_wait
parameter_list|)
block|{
comment|/* Unused on older asics, since we don't have semaphores or multiple rings */
name|panic
argument_list|(
literal|"%s: Unused on older asics"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r100_copy_blit
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint64_t
name|src_offset
parameter_list|,
name|uint64_t
name|dst_offset
parameter_list|,
name|unsigned
name|num_gpu_pages
parameter_list|,
name|struct
name|radeon_fence
modifier|*
modifier|*
name|fence
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|uint32_t
name|cur_pages
decl_stmt|;
name|uint32_t
name|stride_bytes
init|=
name|RADEON_GPU_PAGE_SIZE
decl_stmt|;
name|uint32_t
name|pitch
decl_stmt|;
name|uint32_t
name|stride_pixels
decl_stmt|;
name|unsigned
name|ndw
decl_stmt|;
name|int
name|num_loops
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
comment|/* radeon limited to 16k stride */
name|stride_bytes
operator|&=
literal|0x3fff
expr_stmt|;
comment|/* radeon pitch is /64 */
name|pitch
operator|=
name|stride_bytes
operator|/
literal|64
expr_stmt|;
name|stride_pixels
operator|=
name|stride_bytes
operator|/
literal|4
expr_stmt|;
name|num_loops
operator|=
name|DIV_ROUND_UP
argument_list|(
name|num_gpu_pages
argument_list|,
literal|8191
argument_list|)
expr_stmt|;
comment|/* Ask for enough room for blit + flush + fence */
name|ndw
operator|=
literal|64
operator|+
operator|(
literal|10
operator|*
name|num_loops
operator|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ndw
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: moving bo (%d) asking for %u dw.\n"
argument_list|,
name|r
argument_list|,
name|ndw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
while|while
condition|(
name|num_gpu_pages
operator|>
literal|0
condition|)
block|{
name|cur_pages
operator|=
name|num_gpu_pages
expr_stmt|;
if|if
condition|(
name|cur_pages
operator|>
literal|8191
condition|)
block|{
name|cur_pages
operator|=
literal|8191
expr_stmt|;
block|}
name|num_gpu_pages
operator|-=
name|cur_pages
expr_stmt|;
comment|/* pages are in Y direction - height 		   page width in X direction - width */
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET3
argument_list|(
name|PACKET3_BITBLT_MULTI
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_GMC_SRC_PITCH_OFFSET_CNTL
operator||
name|RADEON_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|RADEON_GMC_SRC_CLIPPING
operator||
name|RADEON_GMC_DST_CLIPPING
operator||
name|RADEON_GMC_BRUSH_NONE
operator||
operator|(
name|RADEON_COLOR_FORMAT_ARGB8888
operator|<<
literal|8
operator|)
operator||
name|RADEON_GMC_SRC_DATATYPE_COLOR
operator||
name|RADEON_ROP3_S
operator||
name|RADEON_DP_SRC_SOURCE_MEMORY
operator||
name|RADEON_GMC_CLR_CMP_CNTL_DIS
operator||
name|RADEON_GMC_WR_MSK_DIS
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|pitch
operator|<<
literal|22
operator|)
operator||
operator|(
name|src_offset
operator|>>
literal|10
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
name|pitch
operator|<<
literal|22
operator|)
operator||
operator|(
name|dst_offset
operator|>>
literal|10
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|0x1fff
operator|)
operator||
operator|(
literal|0x1fff
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
operator|(
literal|0x1fff
operator|)
operator||
operator|(
literal|0x1fff
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|num_gpu_pages
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|num_gpu_pages
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|cur_pages
operator||
operator|(
name|stride_pixels
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_DSTCACHE_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_RB2D_DC_FLUSH_ALL
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_WAIT_UNTIL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_WAIT_2D_IDLECLEAN
operator||
name|RADEON_WAIT_HOST_IDLECLEAN
operator||
name|RADEON_WAIT_DMA_GUI_IDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|fence
condition|)
block|{
name|r
operator|=
name|radeon_fence_emit
argument_list|(
name|rdev
argument_list|,
name|fence
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_cp_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|G_000E40_CP_CMDSTRM_BUSY
argument_list|(
name|tmp
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|r100_ring_start
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_ISYNC_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|RADEON_ISYNC_ANY2D_IDLE3D
operator||
name|RADEON_ISYNC_ANY3D_IDLE2D
operator||
name|RADEON_ISYNC_WAIT_IDLEGUI
operator||
name|RADEON_ISYNC_CPSCRATCH_IDLEGUI
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Load the microcode for the CP */
end_comment

begin_function
specifier|static
name|int
name|r100_cp_init_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|fw_name
init|=
name|NULL
decl_stmt|;
name|int
name|err
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R100
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV100
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV200
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS100
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS200
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading R100 Microcode\n"
argument_list|)
expr_stmt|;
name|fw_name
operator|=
name|FIRMWARE_R100
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV250
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV280
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS300
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading R200 Microcode\n"
argument_list|)
expr_stmt|;
name|fw_name
operator|=
name|FIRMWARE_R200
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R350
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV350
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV380
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS400
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading R300 Microcode\n"
argument_list|)
expr_stmt|;
name|fw_name
operator|=
name|FIRMWARE_R300
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R420
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R423
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV410
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading R400 Microcode\n"
argument_list|)
expr_stmt|;
name|fw_name
operator|=
name|FIRMWARE_R420
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS740
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading RS690/RS740 Microcode\n"
argument_list|)
expr_stmt|;
name|fw_name
operator|=
name|FIRMWARE_RS690
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS600
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading RS600 Microcode\n"
argument_list|)
expr_stmt|;
name|fw_name
operator|=
name|FIRMWARE_RS600
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV515
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R520
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV530
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R580
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV560
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV570
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading R500 Microcode\n"
argument_list|)
expr_stmt|;
name|fw_name
operator|=
name|FIRMWARE_R520
expr_stmt|;
block|}
name|err
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|firmware_get
argument_list|(
name|fw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon_cp: Failed to load firmware \"%s\"\n"
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOENT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|->
name|datasize
operator|%
literal|8
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon_cp: Bogus length %zu in firmware \"%s\"\n"
argument_list|,
name|rdev
operator|->
name|me_fw
operator|->
name|datasize
argument_list|,
name|fw_name
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|firmware_put
argument_list|(
name|rdev
operator|->
name|me_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/**  * r100_cp_fini_microcode - drop the firmware image reference  *  * @rdev: radeon_device pointer  *  * Drop the me firmware image reference.  * Called at driver shutdown.  */
end_comment

begin_function
specifier|static
name|void
name|r100_cp_fini_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|rdev
operator|->
name|me_fw
operator|!=
name|NULL
condition|)
block|{
name|firmware_put
argument_list|(
name|rdev
operator|->
name|me_fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|me_fw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|r100_cp_load_microcode
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
specifier|const
name|__be32
modifier|*
name|fw_data
decl_stmt|;
name|int
name|i
decl_stmt|,
name|size
decl_stmt|;
if|if
condition|(
name|r100_gui_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to wait GUI idle while "
literal|"programming pipes. Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|me_fw
condition|)
block|{
name|size
operator|=
name|rdev
operator|->
name|me_fw
operator|->
name|datasize
operator|/
literal|4
expr_stmt|;
name|fw_data
operator|=
operator|(
specifier|const
name|__be32
operator|*
operator|)
name|rdev
operator|->
name|me_fw
operator|->
name|data
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_ME_RAM_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|WREG32
argument_list|(
name|RADEON_CP_ME_RAM_DATAH
argument_list|,
name|be32_to_cpup
argument_list|(
operator|&
name|fw_data
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_ME_RAM_DATAL
argument_list|,
name|be32_to_cpup
argument_list|(
operator|&
name|fw_data
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|r100_cp_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|unsigned
name|ring_size
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|unsigned
name|rb_bufsz
decl_stmt|;
name|unsigned
name|rb_blksz
decl_stmt|;
name|unsigned
name|max_fetch
decl_stmt|;
name|unsigned
name|pre_write_timer
decl_stmt|;
name|unsigned
name|pre_write_limit
decl_stmt|;
name|unsigned
name|indirect2_start
decl_stmt|;
name|unsigned
name|indirect1_start
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|r100_debugfs_cp_init
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to register debugfs file for CP !\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|rdev
operator|->
name|me_fw
condition|)
block|{
name|r
operator|=
name|r100_cp_init_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to load firmware!\n"
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
comment|/* Align ring size */
name|rb_bufsz
operator|=
name|drm_order
argument_list|(
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|ring_size
operator|=
operator|(
literal|1
operator|<<
operator|(
name|rb_bufsz
operator|+
literal|1
operator|)
operator|)
operator|*
literal|4
expr_stmt|;
name|r100_cp_load_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_init
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
name|ring_size
argument_list|,
name|RADEON_WB_CP_RPTR_OFFSET
argument_list|,
name|RADEON_CP_RB_RPTR
argument_list|,
name|RADEON_CP_RB_WPTR
argument_list|,
literal|0
argument_list|,
literal|0x7fffff
argument_list|,
name|RADEON_CP_PACKET2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
comment|/* Each time the cp read 1024 bytes (16 dword/quadword) update 	 * the rptr copy in system ram */
name|rb_blksz
operator|=
literal|9
expr_stmt|;
comment|/* cp will read 128bytes at a time (4 dwords) */
name|max_fetch
operator|=
literal|1
expr_stmt|;
name|ring
operator|->
name|align_mask
operator|=
literal|16
operator|-
literal|1
expr_stmt|;
comment|/* Write to CP_RB_WPTR will be delayed for pre_write_timer clocks */
name|pre_write_timer
operator|=
literal|64
expr_stmt|;
comment|/* Force CP_RB_WPTR write if written more than one time before the 	 * delay expire 	 */
name|pre_write_limit
operator|=
literal|0
expr_stmt|;
comment|/* Setup the cp cache like this (cache size is 96 dwords) : 	 *	RING		0  to 15 	 *	INDIRECT1	16 to 79 	 *	INDIRECT2	80 to 95 	 * So ring cache size is 16dwords (> (2 * max_fetch = 2 * 4dwords)) 	 *    indirect1 cache size is 64dwords (> (2 * max_fetch = 2 * 4dwords)) 	 *    indirect2 cache size is 16dwords (> (2 * max_fetch = 2 * 4dwords)) 	 * Idea being that most of the gpu cmd will be through indirect1 buffer 	 * so it gets the bigger cache. 	 */
name|indirect2_start
operator|=
literal|80
expr_stmt|;
name|indirect1_start
operator|=
literal|16
expr_stmt|;
comment|/* cp setup */
name|WREG32
argument_list|(
literal|0x718
argument_list|,
name|pre_write_timer
operator||
operator|(
name|pre_write_limit
operator|<<
literal|28
operator|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|REG_SET
argument_list|(
name|RADEON_RB_BUFSZ
argument_list|,
name|rb_bufsz
argument_list|)
operator||
name|REG_SET
argument_list|(
name|RADEON_RB_BLKSZ
argument_list|,
name|rb_blksz
argument_list|)
operator||
name|REG_SET
argument_list|(
name|RADEON_MAX_FETCH
argument_list|,
name|max_fetch
argument_list|)
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|tmp
operator||=
name|RADEON_BUF_SWAP_32BIT
expr_stmt|;
endif|#
directive|endif
name|WREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|tmp
operator||
name|RADEON_RB_NO_UPDATE
argument_list|)
expr_stmt|;
comment|/* Set ring address */
name|DRM_INFO
argument_list|(
literal|"radeon: ring at 0x%016lX\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ring
operator|->
name|gpu_addr
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_BASE
argument_list|,
name|ring
operator|->
name|gpu_addr
argument_list|)
expr_stmt|;
comment|/* Force read& write ptr to 0 */
name|WREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|tmp
operator||
name|RADEON_RB_RPTR_WR_ENA
operator||
name|RADEON_RB_NO_UPDATE
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_RPTR_WR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ring
operator|->
name|wptr
operator|=
literal|0
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_WPTR
argument_list|,
name|ring
operator|->
name|wptr
argument_list|)
expr_stmt|;
comment|/* set the wb address whether it's enabled or not */
name|WREG32
argument_list|(
name|R_00070C_CP_RB_RPTR_ADDR
argument_list|,
name|S_00070C_RB_RPTR_ADDR
argument_list|(
operator|(
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_CP_RPTR_OFFSET
operator|)
operator|>>
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000774_SCRATCH_ADDR
argument_list|,
name|rdev
operator|->
name|wb
operator|.
name|gpu_addr
operator|+
name|RADEON_WB_SCRATCH_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|wb
operator|.
name|enabled
condition|)
name|WREG32
argument_list|(
name|R_000770_SCRATCH_UMSK
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
else|else
block|{
name|tmp
operator||=
name|RADEON_RB_NO_UPDATE
expr_stmt|;
name|WREG32
argument_list|(
name|R_000770_SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_RB_RPTR
argument_list|)
expr_stmt|;
comment|/* Set cp mode to bus mastering& enable cp*/
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_MODE
argument_list|,
name|REG_SET
argument_list|(
name|RADEON_INDIRECT2_START
argument_list|,
name|indirect2_start
argument_list|)
operator||
name|REG_SET
argument_list|(
name|RADEON_INDIRECT1_START
argument_list|,
name|indirect1_start
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_WPTR_DELAY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_MODE
argument_list|,
literal|0x00004D4D
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_CNTL
argument_list|,
name|RADEON_CSQ_PRIBM_INDBM
argument_list|)
expr_stmt|;
comment|/* at this point everything should be setup correctly to enable master */
name|pci_enable_busmaster
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
expr_stmt|;
name|radeon_ring_start
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_test
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|,
name|ring
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp isn't working (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|ring
operator|->
name|ready
operator|=
name|true
expr_stmt|;
name|radeon_ttm_set_active_vram_size
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ring
operator|->
name|rptr_save_reg
comment|/* not resuming from suspend */
operator|&&
name|radeon_ring_supports_scratch_reg
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
condition|)
block|{
name|r
operator|=
name|radeon_scratch_get
argument_list|(
name|rdev
argument_list|,
operator|&
name|ring
operator|->
name|rptr_save_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to get scratch reg for rptr save (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rptr_save_reg
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r100_cp_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|r100_cp_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Wait for CP idle timeout, shutting down CP.\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Disable ring */
name|r100_cp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|rptr_save_reg
argument_list|)
expr_stmt|;
name|radeon_ring_fini
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"radeon: cp finalized\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r100_cp_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* Disable ring */
name|radeon_ttm_set_active_vram_size
argument_list|(
name|rdev
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_MODE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000770_SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r100_gui_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to wait GUI idle while "
literal|"programming pipes. Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * CS functions  */
end_comment

begin_function
name|int
name|r100_reloc_pitch_offset
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|unsigned
name|idx
parameter_list|,
name|unsigned
name|reg
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|u32
name|tile_flags
init|=
literal|0
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|u32
name|value
decl_stmt|;
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|value
operator|&
literal|0x003fffff
expr_stmt|;
name|tmp
operator|+=
operator|(
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
operator|>>
literal|10
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|tile_flags
operator||=
name|RADEON_DST_TILE_MACRO
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
block|{
if|if
condition|(
name|reg
operator|==
name|RADEON_SRC_PITCH_OFFSET
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Cannot src blit from microtiled surface\n"
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|tile_flags
operator||=
name|RADEON_DST_TILE_MICRO
expr_stmt|;
block|}
name|tmp
operator||=
name|tile_flags
expr_stmt|;
name|p
operator|->
name|ib
operator|.
name|ptr
index|[
name|idx
index|]
operator|=
operator|(
name|value
operator|&
literal|0x3fc00000
operator|)
operator||
name|tmp
expr_stmt|;
block|}
else|else
name|p
operator|->
name|ib
operator|.
name|ptr
index|[
name|idx
index|]
operator|=
operator|(
name|value
operator|&
literal|0xffc00000
operator|)
operator||
name|tmp
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r100_packet3_load_vbpntr
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|unsigned
name|c
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|struct
name|r100_cs_track
modifier|*
name|track
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ib
decl_stmt|;
name|u32
name|idx_value
decl_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
name|track
operator|=
operator|(
expr|struct
name|r100_cs_track
operator|*
operator|)
name|p
operator|->
name|track
expr_stmt|;
name|c
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|++
argument_list|)
operator|&
literal|0x1F
expr_stmt|;
if|if
condition|(
name|c
operator|>
literal|16
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Only 16 vertex buffers are allowed %d\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|num_arrays
operator|=
name|c
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|c
operator|-
literal|1
operator|)
condition|;
name|i
operator|+=
literal|2
operator|,
name|idx
operator|+=
literal|3
control|)
block|{
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for packet3 %d\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|idx_value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|track
operator|->
name|arrays
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|esize
operator|=
name|idx_value
operator|>>
literal|8
expr_stmt|;
name|track
operator|->
name|arrays
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|arrays
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|esize
operator|&=
literal|0x7F
expr_stmt|;
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for packet3 %d\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|2
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|track
operator|->
name|arrays
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|arrays
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|esize
operator|=
name|idx_value
operator|>>
literal|24
expr_stmt|;
name|track
operator|->
name|arrays
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|esize
operator|&=
literal|0x7F
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|&
literal|1
condition|)
block|{
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for packet3 %d\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|idx_value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|track
operator|->
name|arrays
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|arrays
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|esize
operator|=
name|idx_value
operator|>>
literal|8
expr_stmt|;
name|track
operator|->
name|arrays
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|esize
operator|&=
literal|0x7F
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|r100_cs_parse_packet0
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
specifier|const
name|unsigned
modifier|*
name|auth
parameter_list|,
name|unsigned
name|n
parameter_list|,
name|radeon_packet0_check_t
name|check
parameter_list|)
block|{
name|unsigned
name|reg
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|j
decl_stmt|,
name|m
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|int
name|r
decl_stmt|;
name|idx
operator|=
name|pkt
operator|->
name|idx
operator|+
literal|1
expr_stmt|;
name|reg
operator|=
name|pkt
operator|->
name|reg
expr_stmt|;
comment|/* Check that register fall into register range 	 * determined by the number of entry (n) in the 	 * safe register bitmap. 	 */
if|if
condition|(
name|pkt
operator|->
name|one_reg_wr
condition|)
block|{
if|if
condition|(
operator|(
name|reg
operator|>>
literal|7
operator|)
operator|>
name|n
condition|)
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|(
name|reg
operator|+
operator|(
name|pkt
operator|->
name|count
operator|<<
literal|2
operator|)
operator|)
operator|>>
literal|7
operator|)
operator|>
name|n
condition|)
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|pkt
operator|->
name|count
condition|;
name|i
operator|++
operator|,
name|idx
operator|++
control|)
block|{
name|j
operator|=
operator|(
name|reg
operator|>>
literal|7
operator|)
expr_stmt|;
name|m
operator|=
literal|1
operator|<<
operator|(
operator|(
name|reg
operator|>>
literal|2
operator|)
operator|&
literal|31
operator|)
expr_stmt|;
if|if
condition|(
name|auth
index|[
name|j
index|]
operator|&
name|m
condition|)
block|{
name|r
operator|=
name|check
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
block|}
if|if
condition|(
name|pkt
operator|->
name|one_reg_wr
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|auth
index|[
name|j
index|]
operator|&
name|m
operator|)
condition|)
block|{
break|break;
block|}
block|}
else|else
block|{
name|reg
operator|+=
literal|4
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r100_cs_dump_packet
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
specifier|volatile
name|uint32_t
modifier|*
name|ib
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
name|idx
operator|=
name|pkt
operator|->
name|idx
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
operator|(
name|pkt
operator|->
name|count
operator|+
literal|1
operator|)
condition|;
name|i
operator|++
operator|,
name|idx
operator|++
control|)
block|{
name|DRM_INFO
argument_list|(
literal|"ib[%d]=0x%08X\n"
argument_list|,
name|idx
argument_list|,
name|ib
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * r100_cs_packet_parse() - parse cp packet and point ib index to next packet  * @parser:	parser structure holding parsing context.  * @pkt:	where to store packet informations  *  * Assume that chunk_ib_index is properly set. Will return -EINVAL  * if packet is bigger than remaining ib size. or if packets is unknown.  **/
end_comment

begin_function
name|int
name|r100_cs_packet_parse
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|unsigned
name|idx
parameter_list|)
block|{
name|struct
name|radeon_cs_chunk
modifier|*
name|ib_chunk
init|=
operator|&
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
decl_stmt|;
name|uint32_t
name|header
decl_stmt|;
if|if
condition|(
name|idx
operator|>=
name|ib_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Can not parse packet at %d after CS end %d !\n"
argument_list|,
name|idx
argument_list|,
name|ib_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|header
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|idx
operator|=
name|idx
expr_stmt|;
name|pkt
operator|->
name|type
operator|=
name|CP_PACKET_GET_TYPE
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|count
operator|=
name|CP_PACKET_GET_COUNT
argument_list|(
name|header
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|type
condition|)
block|{
case|case
name|PACKET_TYPE0
case|:
name|pkt
operator|->
name|reg
operator|=
name|CP_PACKET0_GET_REG
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|one_reg_wr
operator|=
name|CP_PACKET0_GET_ONE_REG_WR
argument_list|(
name|header
argument_list|)
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE3
case|:
name|pkt
operator|->
name|opcode
operator|=
name|CP_PACKET3_GET_OPCODE
argument_list|(
name|header
argument_list|)
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE2
case|:
name|pkt
operator|->
name|count
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet type %d at %d !\n"
argument_list|,
name|pkt
operator|->
name|type
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|pkt
operator|->
name|count
operator|+
literal|1
operator|+
name|pkt
operator|->
name|idx
operator|)
operator|>=
name|ib_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Packet (%d:%d:%d) end after CS buffer (%d) !\n"
argument_list|,
name|pkt
operator|->
name|idx
argument_list|,
name|pkt
operator|->
name|type
argument_list|,
name|pkt
operator|->
name|count
argument_list|,
name|ib_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * r100_cs_packet_next_vline() - parse userspace VLINE packet  * @parser:		parser structure holding parsing context.  *  * Userspace sends a special sequence for VLINE waits.  * PACKET0 - VLINE_START_END + value  * PACKET0 - WAIT_UNTIL +_value  * RELOC (P3) - crtc_id in reloc.  *  * This function parses this and relocates the VLINE START END  * and WAIT UNTIL packets to the correct crtc.  * It also detects a switched off crtc and nulls out the  * wait in that case.  */
end_comment

begin_function
name|int
name|r100_cs_packet_parse_vline
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|drm_mode_object
modifier|*
name|obj
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
decl_stmt|;
name|struct
name|radeon_crtc
modifier|*
name|radeon_crtc
decl_stmt|;
name|struct
name|radeon_cs_packet
name|p3reloc
decl_stmt|,
name|waitreloc
decl_stmt|;
name|int
name|crtc_id
decl_stmt|;
name|int
name|r
decl_stmt|;
name|uint32_t
name|header
decl_stmt|,
name|h_idx
decl_stmt|,
name|reg
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ib
decl_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
comment|/* parse the wait until */
name|r
operator|=
name|r100_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|waitreloc
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* check its a wait until and only 1 count */
if|if
condition|(
name|waitreloc
operator|.
name|reg
operator|!=
name|RADEON_WAIT_UNTIL
operator|||
name|waitreloc
operator|.
name|count
operator|!=
literal|0
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline wait had illegal wait until segment\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|waitreloc
operator|.
name|idx
operator|+
literal|1
argument_list|)
operator|!=
name|RADEON_WAIT_CRTC_VLINE
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"vline wait had illegal wait until\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* jump over the NOP */
name|r
operator|=
name|r100_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|,
name|p
operator|->
name|idx
operator|+
name|waitreloc
operator|.
name|count
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|h_idx
operator|=
name|p
operator|->
name|idx
operator|-
literal|2
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
name|waitreloc
operator|.
name|count
operator|+
literal|2
expr_stmt|;
name|p
operator|->
name|idx
operator|+=
name|p3reloc
operator|.
name|count
operator|+
literal|2
expr_stmt|;
name|header
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|h_idx
argument_list|)
expr_stmt|;
name|crtc_id
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|h_idx
operator|+
literal|5
argument_list|)
expr_stmt|;
name|reg
operator|=
name|CP_PACKET0_GET_REG
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|obj
operator|=
name|drm_mode_object_find
argument_list|(
name|p
operator|->
name|rdev
operator|->
name|ddev
argument_list|,
name|crtc_id
argument_list|,
name|DRM_MODE_OBJECT_CRTC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|obj
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"cannot find crtc %d\n"
argument_list|,
name|crtc_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|crtc
operator|=
name|obj_to_crtc
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|radeon_crtc
operator|=
name|to_radeon_crtc
argument_list|(
name|crtc
argument_list|)
expr_stmt|;
name|crtc_id
operator|=
name|radeon_crtc
operator|->
name|crtc_id
expr_stmt|;
if|if
condition|(
operator|!
name|crtc
operator|->
name|enabled
condition|)
block|{
comment|/* if the CRTC isn't enabled - we need to nop out the wait until */
name|ib
index|[
name|h_idx
operator|+
literal|2
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|3
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|crtc_id
operator|==
literal|1
condition|)
block|{
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|AVIVO_D1MODE_VLINE_START_END
case|:
name|header
operator|&=
operator|~
name|R300_CP_PACKET0_REG_MASK
expr_stmt|;
name|header
operator||=
name|AVIVO_D2MODE_VLINE_START_END
operator|>>
literal|2
expr_stmt|;
break|break;
case|case
name|RADEON_CRTC_GUI_TRIG_VLINE
case|:
name|header
operator|&=
operator|~
name|R300_CP_PACKET0_REG_MASK
expr_stmt|;
name|header
operator||=
name|RADEON_CRTC2_GUI_TRIG_VLINE
operator|>>
literal|2
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"unknown crtc reloc\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ib
index|[
name|h_idx
index|]
operator|=
name|header
expr_stmt|;
name|ib
index|[
name|h_idx
operator|+
literal|3
index|]
operator||=
name|RADEON_ENG_DISPLAY_SELECT_CRTC1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * r100_cs_packet_next_reloc() - parse next packet which should be reloc packet3  * @parser:		parser structure holding parsing context.  * @data:		pointer to relocation data  * @offset_start:	starting offset  * @offset_mask:	offset mask (to align start offset on)  * @reloc:		reloc informations  *  * Check next packet is relocation packet3, do bo validation and compute  * GPU offset using the provided start.  **/
end_comment

begin_function
name|int
name|r100_cs_packet_next_reloc
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_reloc
modifier|*
modifier|*
name|cs_reloc
parameter_list|)
block|{
name|struct
name|radeon_cs_chunk
modifier|*
name|relocs_chunk
decl_stmt|;
name|struct
name|radeon_cs_packet
name|p3reloc
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|chunk_relocs_idx
operator|==
operator|-
literal|1
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No relocation chunk !\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
operator|*
name|cs_reloc
operator|=
name|NULL
expr_stmt|;
name|relocs_chunk
operator|=
operator|&
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_relocs_idx
index|]
expr_stmt|;
name|r
operator|=
name|r100_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
name|p
operator|->
name|idx
operator|+=
name|p3reloc
operator|.
name|count
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|p3reloc
operator|.
name|type
operator|!=
name|PACKET_TYPE3
operator|||
name|p3reloc
operator|.
name|opcode
operator|!=
name|PACKET3_NOP
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No packet3 for relocation for packet at %d.\n"
argument_list|,
name|p3reloc
operator|.
name|idx
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|idx
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|p3reloc
operator|.
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|>=
name|relocs_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Relocs at %d after relocations chunk end %d !\n"
argument_list|,
name|idx
argument_list|,
name|relocs_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
operator|&
name|p3reloc
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* FIXME: we assume reloc size is 4 dwords */
operator|*
name|cs_reloc
operator|=
name|p
operator|->
name|relocs_ptr
index|[
operator|(
name|idx
operator|/
literal|4
operator|)
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_get_vtx_size
parameter_list|(
name|uint32_t
name|vtx_fmt
parameter_list|)
block|{
name|int
name|vtx_size
decl_stmt|;
name|vtx_size
operator|=
literal|2
expr_stmt|;
comment|/* ordered according to bits in spec */
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_W0
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_FPCOLOR
condition|)
name|vtx_size
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_FPALPHA
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_PKCOLOR
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_FPSPEC
condition|)
name|vtx_size
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_FPFOG
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_PKSPEC
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_ST0
condition|)
name|vtx_size
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_ST1
condition|)
name|vtx_size
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_Q1
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_ST2
condition|)
name|vtx_size
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_Q2
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_ST3
condition|)
name|vtx_size
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_Q3
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_Q0
condition|)
name|vtx_size
operator|++
expr_stmt|;
comment|/* blend weight */
if|if
condition|(
name|vtx_fmt
operator|&
operator|(
literal|0x7
operator|<<
literal|15
operator|)
condition|)
name|vtx_size
operator|+=
operator|(
name|vtx_fmt
operator|>>
literal|15
operator|)
operator|&
literal|0x7
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_N0
condition|)
name|vtx_size
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_XY1
condition|)
name|vtx_size
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_Z1
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_W1
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_N1
condition|)
name|vtx_size
operator|++
expr_stmt|;
if|if
condition|(
name|vtx_fmt
operator|&
name|RADEON_SE_VTX_FMT_Z
condition|)
name|vtx_size
operator|++
expr_stmt|;
return|return
name|vtx_size
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_packet0_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|unsigned
name|idx
parameter_list|,
name|unsigned
name|reg
parameter_list|)
block|{
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|struct
name|r100_cs_track
modifier|*
name|track
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ib
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|r
decl_stmt|;
name|int
name|i
decl_stmt|,
name|face
decl_stmt|;
name|u32
name|tile_flags
init|=
literal|0
decl_stmt|;
name|u32
name|idx_value
decl_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
name|track
operator|=
operator|(
expr|struct
name|r100_cs_track
operator|*
operator|)
name|p
operator|->
name|track
expr_stmt|;
name|idx_value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|RADEON_CRTC_GUI_TRIG_VLINE
case|:
name|r
operator|=
name|r100_cs_packet_parse_vline
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
break|break;
comment|/* FIXME: only allow PACKET3 blit? easier to check for out of 		 * range access */
case|case
name|RADEON_DST_PITCH_OFFSET
case|:
case|case
name|RADEON_SRC_PITCH_OFFSET
case|:
name|r
operator|=
name|r100_reloc_pitch_offset
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
case|case
name|RADEON_RB3D_DEPTHOFFSET
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|zb
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|zb
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_COLOROFFSET
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
break|break;
case|case
name|RADEON_PP_TXOFFSET_0
case|:
case|case
name|RADEON_PP_TXOFFSET_1
case|:
case|case
name|RADEON_PP_TXOFFSET_2
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|RADEON_PP_TXOFFSET_0
operator|)
operator|/
literal|24
expr_stmt|;
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|tile_flags
operator||=
name|RADEON_TXO_MACRO_TILE
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|tile_flags
operator||=
name|RADEON_TXO_MICRO_TILE_X2
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|&
operator|~
operator|(
literal|0x7
operator|<<
literal|2
operator|)
expr_stmt|;
name|tmp
operator||=
name|tile_flags
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|tmp
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
block|}
else|else
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_PP_CUBIC_OFFSET_T0_0
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T0_1
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T0_2
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T0_3
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T0_4
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|RADEON_PP_CUBIC_OFFSET_T0_0
operator|)
operator|/
literal|4
expr_stmt|;
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|textures
index|[
literal|0
index|]
operator|.
name|cube_info
index|[
name|i
index|]
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
literal|0
index|]
operator|.
name|cube_info
index|[
name|i
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_PP_CUBIC_OFFSET_T1_0
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T1_1
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T1_2
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T1_3
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T1_4
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|RADEON_PP_CUBIC_OFFSET_T1_0
operator|)
operator|/
literal|4
expr_stmt|;
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|textures
index|[
literal|1
index|]
operator|.
name|cube_info
index|[
name|i
index|]
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
literal|1
index|]
operator|.
name|cube_info
index|[
name|i
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_PP_CUBIC_OFFSET_T2_0
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T2_1
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T2_2
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T2_3
case|:
case|case
name|RADEON_PP_CUBIC_OFFSET_T2_4
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|RADEON_PP_CUBIC_OFFSET_T2_0
operator|)
operator|/
literal|4
expr_stmt|;
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|track
operator|->
name|textures
index|[
literal|2
index|]
operator|.
name|cube_info
index|[
name|i
index|]
operator|.
name|offset
operator|=
name|idx_value
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
literal|2
index|]
operator|.
name|cube_info
index|[
name|i
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RE_WIDTH_HEIGHT
case|:
name|track
operator|->
name|maxy
operator|=
operator|(
operator|(
name|idx_value
operator|>>
literal|16
operator|)
operator|&
literal|0x7FF
operator|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_COLORPITCH
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|p
operator|->
name|cs_flags
operator|&
name|RADEON_CS_KEEP_TILING_FLAGS
operator|)
condition|)
block|{
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|tile_flags
operator||=
name|RADEON_COLOR_TILE_ENABLE
expr_stmt|;
if|if
condition|(
name|reloc
operator|->
name|lobj
operator|.
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|tile_flags
operator||=
name|RADEON_COLOR_MICROTILE_ENABLE
expr_stmt|;
name|tmp
operator|=
name|idx_value
operator|&
operator|~
operator|(
literal|0x7
operator|<<
literal|16
operator|)
expr_stmt|;
name|tmp
operator||=
name|tile_flags
expr_stmt|;
name|ib
index|[
name|idx
index|]
operator|=
name|tmp
expr_stmt|;
block|}
else|else
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
expr_stmt|;
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|pitch
operator|=
name|idx_value
operator|&
name|RADEON_COLORPITCH_MASK
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_DEPTHPITCH
case|:
name|track
operator|->
name|zb
operator|.
name|pitch
operator|=
name|idx_value
operator|&
name|RADEON_DEPTHPITCH_MASK
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_CNTL
case|:
switch|switch
condition|(
operator|(
name|idx_value
operator|>>
name|RADEON_RB3D_COLOR_FORMAT_SHIFT
operator|)
operator|&
literal|0x1f
condition|)
block|{
case|case
literal|7
case|:
case|case
literal|8
case|:
case|case
literal|9
case|:
case|case
literal|11
case|:
case|case
literal|12
case|:
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|3
case|:
case|case
literal|4
case|:
case|case
literal|15
case|:
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|cpp
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|cpp
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid color buffer format (%d) !\n"
argument_list|,
operator|(
operator|(
name|idx_value
operator|>>
name|RADEON_RB3D_COLOR_FORMAT_SHIFT
operator|)
operator|&
literal|0x1f
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|z_enabled
operator|=
operator|!
operator|!
operator|(
name|idx_value
operator|&
name|RADEON_Z_ENABLE
operator|)
expr_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_ZSTENCILCNTL
case|:
switch|switch
condition|(
name|idx_value
operator|&
literal|0xf
condition|)
block|{
case|case
literal|0
case|:
name|track
operator|->
name|zb
operator|.
name|cpp
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
case|case
literal|3
case|:
case|case
literal|4
case|:
case|case
literal|5
case|:
case|case
literal|9
case|:
case|case
literal|11
case|:
name|track
operator|->
name|zb
operator|.
name|cpp
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_RB3D_ZPASS_ADDR
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for ib[%d]=0x%04X\n"
argument_list|,
name|idx
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|=
name|idx_value
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
break|break;
case|case
name|RADEON_PP_CNTL
case|:
block|{
name|uint32_t
name|temp
init|=
name|idx_value
operator|>>
literal|4
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|track
operator|->
name|num_texture
condition|;
name|i
operator|++
control|)
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|enabled
operator|=
operator|!
operator|!
operator|(
name|temp
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|RADEON_SE_VF_CNTL
case|:
name|track
operator|->
name|vap_vf_cntl
operator|=
name|idx_value
expr_stmt|;
break|break;
case|case
name|RADEON_SE_VTX_FMT
case|:
name|track
operator|->
name|vtx_size
operator|=
name|r100_get_vtx_size
argument_list|(
name|idx_value
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_PP_TEX_SIZE_0
case|:
case|case
name|RADEON_PP_TEX_SIZE_1
case|:
case|case
name|RADEON_PP_TEX_SIZE_2
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|RADEON_PP_TEX_SIZE_0
operator|)
operator|/
literal|8
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|width
operator|=
operator|(
name|idx_value
operator|&
name|RADEON_TEX_USIZE_MASK
operator|)
operator|+
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|height
operator|=
operator|(
operator|(
name|idx_value
operator|&
name|RADEON_TEX_VSIZE_MASK
operator|)
operator|>>
name|RADEON_TEX_VSIZE_SHIFT
operator|)
operator|+
literal|1
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_PP_TEX_PITCH_0
case|:
case|case
name|RADEON_PP_TEX_PITCH_1
case|:
case|case
name|RADEON_PP_TEX_PITCH_2
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|RADEON_PP_TEX_PITCH_0
operator|)
operator|/
literal|8
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|pitch
operator|=
name|idx_value
operator|+
literal|32
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_PP_TXFILTER_0
case|:
case|case
name|RADEON_PP_TXFILTER_1
case|:
case|case
name|RADEON_PP_TXFILTER_2
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|RADEON_PP_TXFILTER_0
operator|)
operator|/
literal|24
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|num_levels
operator|=
operator|(
operator|(
name|idx_value
operator|&
name|RADEON_MAX_MIP_LEVEL_MASK
operator|)
operator|>>
name|RADEON_MAX_MIP_LEVEL_SHIFT
operator|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|idx_value
operator|>>
literal|23
operator|)
operator|&
literal|0x7
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|2
operator|||
name|tmp
operator|==
literal|6
condition|)
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|roundup_w
operator|=
name|false
expr_stmt|;
name|tmp
operator|=
operator|(
name|idx_value
operator|>>
literal|27
operator|)
operator|&
literal|0x7
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|2
operator|||
name|tmp
operator|==
literal|6
condition|)
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|roundup_h
operator|=
name|false
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_PP_TXFORMAT_0
case|:
case|case
name|RADEON_PP_TXFORMAT_1
case|:
case|case
name|RADEON_PP_TXFORMAT_2
case|:
name|i
operator|=
operator|(
name|reg
operator|-
name|RADEON_PP_TXFORMAT_0
operator|)
operator|/
literal|24
expr_stmt|;
if|if
condition|(
name|idx_value
operator|&
name|RADEON_TXFORMAT_NON_POWER2
condition|)
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|use_pitch
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|use_pitch
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|width
operator|=
literal|1
operator|<<
operator|(
operator|(
name|idx_value
operator|>>
name|RADEON_TXFORMAT_WIDTH_SHIFT
operator|)
operator|&
name|RADEON_TXFORMAT_WIDTH_MASK
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|height
operator|=
literal|1
operator|<<
operator|(
operator|(
name|idx_value
operator|>>
name|RADEON_TXFORMAT_HEIGHT_SHIFT
operator|)
operator|&
name|RADEON_TXFORMAT_HEIGHT_MASK
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|idx_value
operator|&
name|RADEON_TXFORMAT_CUBIC_MAP_ENABLE
condition|)
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|tex_coord_type
operator|=
literal|2
expr_stmt|;
switch|switch
condition|(
operator|(
name|idx_value
operator|&
name|RADEON_TXFORMAT_FORMAT_MASK
operator|)
condition|)
block|{
case|case
name|RADEON_TXFORMAT_I8
case|:
case|case
name|RADEON_TXFORMAT_RGB332
case|:
case|case
name|RADEON_TXFORMAT_Y8
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|RADEON_TXFORMAT_AI88
case|:
case|case
name|RADEON_TXFORMAT_ARGB1555
case|:
case|case
name|RADEON_TXFORMAT_RGB565
case|:
case|case
name|RADEON_TXFORMAT_ARGB4444
case|:
case|case
name|RADEON_TXFORMAT_VYUY422
case|:
case|case
name|RADEON_TXFORMAT_YVYU422
case|:
case|case
name|RADEON_TXFORMAT_SHADOW16
case|:
case|case
name|RADEON_TXFORMAT_LDUDV655
case|:
case|case
name|RADEON_TXFORMAT_DUDV88
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|2
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|RADEON_TXFORMAT_ARGB8888
case|:
case|case
name|RADEON_TXFORMAT_RGBA8888
case|:
case|case
name|RADEON_TXFORMAT_SHADOW32
case|:
case|case
name|RADEON_TXFORMAT_LDUDUV8888
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|4
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
break|break;
case|case
name|RADEON_TXFORMAT_DXT1
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_DXT1
expr_stmt|;
break|break;
case|case
name|RADEON_TXFORMAT_DXT23
case|:
case|case
name|RADEON_TXFORMAT_DXT45
case|:
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|1
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_DXT35
expr_stmt|;
break|break;
block|}
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
literal|4
index|]
operator|.
name|width
operator|=
literal|1
operator|<<
operator|(
operator|(
name|idx_value
operator|>>
literal|16
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
literal|4
index|]
operator|.
name|height
operator|=
literal|1
operator|<<
operator|(
operator|(
name|idx_value
operator|>>
literal|20
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_PP_CUBIC_FACES_0
case|:
case|case
name|RADEON_PP_CUBIC_FACES_1
case|:
case|case
name|RADEON_PP_CUBIC_FACES_2
case|:
name|tmp
operator|=
name|idx_value
expr_stmt|;
name|i
operator|=
operator|(
name|reg
operator|-
name|RADEON_PP_CUBIC_FACES_0
operator|)
operator|/
literal|4
expr_stmt|;
for|for
control|(
name|face
operator|=
literal|0
init|;
name|face
operator|<
literal|4
condition|;
name|face
operator|++
control|)
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|width
operator|=
literal|1
operator|<<
operator|(
operator|(
name|tmp
operator|>>
operator|(
name|face
operator|*
literal|8
operator|)
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|height
operator|=
literal|1
operator|<<
operator|(
operator|(
name|tmp
operator|>>
operator|(
operator|(
name|face
operator|*
literal|8
operator|)
operator|+
literal|4
operator|)
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
block|}
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Forbidden register 0x%04X in cs at %d\n"
argument_list|,
name|reg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r100_cs_track_check_pkt3_indx_buffer
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|,
name|struct
name|radeon_bo
modifier|*
name|robj
parameter_list|)
block|{
name|unsigned
name|idx
decl_stmt|;
name|u32
name|value
decl_stmt|;
name|idx
operator|=
name|pkt
operator|->
name|idx
operator|+
literal|1
expr_stmt|;
name|value
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|+
literal|1
operator|)
operator|>
name|radeon_bo_size
argument_list|(
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"[drm] Buffer too small for PACKET3 INDX_BUFFER "
literal|"(need %u have %lu) !\n"
argument_list|,
name|value
operator|+
literal|1
argument_list|,
name|radeon_bo_size
argument_list|(
name|robj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_packet3_check
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|,
name|struct
name|radeon_cs_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|struct
name|radeon_cs_reloc
modifier|*
name|reloc
decl_stmt|;
name|struct
name|r100_cs_track
modifier|*
name|track
decl_stmt|;
name|unsigned
name|idx
decl_stmt|;
specifier|volatile
name|uint32_t
modifier|*
name|ib
decl_stmt|;
name|int
name|r
decl_stmt|;
name|ib
operator|=
name|p
operator|->
name|ib
operator|.
name|ptr
expr_stmt|;
name|idx
operator|=
name|pkt
operator|->
name|idx
operator|+
literal|1
expr_stmt|;
name|track
operator|=
operator|(
expr|struct
name|r100_cs_track
operator|*
operator|)
name|p
operator|->
name|track
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|opcode
condition|)
block|{
case|case
name|PACKET3_3D_LOAD_VBPNTR
case|:
name|r
operator|=
name|r100_packet3_load_vbpntr
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
case|case
name|PACKET3_INDX_BUFFER
case|:
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for packet3 %d\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|ib
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check_pkt3_indx_buffer
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|,
name|reloc
operator|->
name|robj
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
return|return
name|r
return|;
block|}
break|break;
case|case
literal|0x23
case|:
comment|/* 3D_RNDR_GEN_INDX_PRIM on r100/r200 */
name|r
operator|=
name|r100_cs_packet_next_reloc
argument_list|(
name|p
argument_list|,
operator|&
name|reloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No reloc for packet3 %d\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|r100_cs_dump_packet
argument_list|(
name|p
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|ib
index|[
name|idx
index|]
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|+
operator|(
operator|(
name|u32
operator|)
name|reloc
operator|->
name|lobj
operator|.
name|gpu_offset
operator|)
expr_stmt|;
name|track
operator|->
name|num_arrays
operator|=
literal|1
expr_stmt|;
name|track
operator|->
name|vtx_size
operator|=
name|r100_get_vtx_size
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|track
operator|->
name|arrays
index|[
literal|0
index|]
operator|.
name|robj
operator|=
name|reloc
operator|->
name|robj
expr_stmt|;
name|track
operator|->
name|arrays
index|[
literal|0
index|]
operator|.
name|esize
operator|=
name|track
operator|->
name|vtx_size
expr_stmt|;
name|track
operator|->
name|max_indx
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|3
argument_list|)
expr_stmt|;
name|track
operator|->
name|immd_dwords
operator|=
name|pkt
operator|->
name|count
operator|-
literal|1
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
case|case
name|PACKET3_3D_DRAW_IMMD
case|:
if|if
condition|(
operator|(
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
operator|>>
literal|4
operator|)
operator|&
literal|0x3
operator|)
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"PRIM_WALK must be 3 for IMMD draw\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|vtx_size
operator|=
name|r100_get_vtx_size
argument_list|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|track
operator|->
name|immd_dwords
operator|=
name|pkt
operator|->
name|count
operator|-
literal|1
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
comment|/* triggers drawing using in-packet vertex data */
case|case
name|PACKET3_3D_DRAW_IMMD_2
case|:
if|if
condition|(
operator|(
operator|(
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
operator|>>
literal|4
operator|)
operator|&
literal|0x3
operator|)
operator|!=
literal|3
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"PRIM_WALK must be 3 for IMMD draw\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|track
operator|->
name|immd_dwords
operator|=
name|pkt
operator|->
name|count
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
comment|/* triggers drawing using in-packet vertex data */
case|case
name|PACKET3_3D_DRAW_VBUF_2
case|:
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
comment|/* triggers drawing of vertex buffers setup elsewhere */
case|case
name|PACKET3_3D_DRAW_INDX_2
case|:
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
comment|/* triggers drawing using indices to vertex buffer */
case|case
name|PACKET3_3D_DRAW_VBUF
case|:
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
comment|/* triggers drawing of vertex buffers setup elsewhere */
case|case
name|PACKET3_3D_DRAW_INDX
case|:
name|track
operator|->
name|vap_vf_cntl
operator|=
name|radeon_get_ib_value
argument_list|(
name|p
argument_list|,
name|idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|r
operator|=
name|r100_cs_track_check
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
break|break;
comment|/* triggers drawing using indices to vertex buffer */
case|case
name|PACKET3_3D_CLEAR_HIZ
case|:
case|case
name|PACKET3_3D_CLEAR_ZMASK
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|hyperz_filp
operator|!=
name|p
operator|->
name|filp
condition|)
return|return
operator|-
name|EINVAL
return|;
break|break;
case|case
name|PACKET3_NOP
case|:
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Packet3 opcode %x not supported\n"
argument_list|,
name|pkt
operator|->
name|opcode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r100_cs_parse
parameter_list|(
name|struct
name|radeon_cs_parser
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|radeon_cs_packet
name|pkt
decl_stmt|;
name|struct
name|r100_cs_track
modifier|*
name|track
decl_stmt|;
name|int
name|r
decl_stmt|;
name|track
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|track
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|track
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|r100_cs_track_clear
argument_list|(
name|p
operator|->
name|rdev
argument_list|,
name|track
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|track
expr_stmt|;
do|do
block|{
name|r
operator|=
name|r100_cs_packet_parse
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|,
name|p
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
name|r
return|;
block|}
name|p
operator|->
name|idx
operator|+=
name|pkt
operator|.
name|count
operator|+
literal|2
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|.
name|type
condition|)
block|{
case|case
name|PACKET_TYPE0
case|:
if|if
condition|(
name|p
operator|->
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R200
condition|)
name|r
operator|=
name|r100_cs_parse_packet0
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|,
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|reg_safe_bm
argument_list|,
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|reg_safe_bm_size
argument_list|,
operator|&
name|r200_packet0_check
argument_list|)
expr_stmt|;
else|else
name|r
operator|=
name|r100_cs_parse_packet0
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|,
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|reg_safe_bm
argument_list|,
name|p
operator|->
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|reg_safe_bm_size
argument_list|,
operator|&
name|r100_packet0_check
argument_list|)
expr_stmt|;
break|break;
case|case
name|PACKET_TYPE2
case|:
break|break;
case|case
name|PACKET_TYPE3
case|:
name|r
operator|=
name|r100_packet3_check
argument_list|(
name|p
argument_list|,
operator|&
name|pkt
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown packet type %d !\n"
argument_list|,
name|pkt
operator|.
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|r
condition|)
block|{
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
do|while
condition|(
name|p
operator|->
name|idx
operator|<
name|p
operator|->
name|chunks
index|[
name|p
operator|->
name|chunk_ib_idx
index|]
operator|.
name|length_dw
condition|)
do|;
name|free
argument_list|(
name|p
operator|->
name|track
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|p
operator|->
name|track
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r100_cs_track_texture_print
parameter_list|(
name|struct
name|r100_cs_track_texture
modifier|*
name|t
parameter_list|)
block|{
name|DRM_ERROR
argument_list|(
literal|"pitch                      %d\n"
argument_list|,
name|t
operator|->
name|pitch
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"use_pitch                  %d\n"
argument_list|,
name|t
operator|->
name|use_pitch
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"width                      %d\n"
argument_list|,
name|t
operator|->
name|width
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"width_11                   %d\n"
argument_list|,
name|t
operator|->
name|width_11
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"height                     %d\n"
argument_list|,
name|t
operator|->
name|height
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"height_11                  %d\n"
argument_list|,
name|t
operator|->
name|height_11
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"num levels                 %d\n"
argument_list|,
name|t
operator|->
name|num_levels
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"depth                      %d\n"
argument_list|,
name|t
operator|->
name|txdepth
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"bpp                        %d\n"
argument_list|,
name|t
operator|->
name|cpp
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"coordinate type            %d\n"
argument_list|,
name|t
operator|->
name|tex_coord_type
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"width round to power of 2  %d\n"
argument_list|,
name|t
operator|->
name|roundup_w
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"height round to power of 2 %d\n"
argument_list|,
name|t
operator|->
name|roundup_h
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"compress format            %d\n"
argument_list|,
name|t
operator|->
name|compress_format
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_track_compress_size
parameter_list|(
name|int
name|compress_format
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|)
block|{
name|int
name|block_width
decl_stmt|,
name|block_height
decl_stmt|,
name|block_bytes
decl_stmt|;
name|int
name|wblocks
decl_stmt|,
name|hblocks
decl_stmt|;
name|int
name|min_wblocks
decl_stmt|;
name|int
name|sz
decl_stmt|;
name|block_width
operator|=
literal|4
expr_stmt|;
name|block_height
operator|=
literal|4
expr_stmt|;
switch|switch
condition|(
name|compress_format
condition|)
block|{
case|case
name|R100_TRACK_COMP_DXT1
case|:
name|block_bytes
operator|=
literal|8
expr_stmt|;
name|min_wblocks
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
case|case
name|R100_TRACK_COMP_DXT35
case|:
name|block_bytes
operator|=
literal|16
expr_stmt|;
name|min_wblocks
operator|=
literal|2
expr_stmt|;
break|break;
block|}
name|hblocks
operator|=
operator|(
name|h
operator|+
name|block_height
operator|-
literal|1
operator|)
operator|/
name|block_height
expr_stmt|;
name|wblocks
operator|=
operator|(
name|w
operator|+
name|block_width
operator|-
literal|1
operator|)
operator|/
name|block_width
expr_stmt|;
if|if
condition|(
name|wblocks
operator|<
name|min_wblocks
condition|)
name|wblocks
operator|=
name|min_wblocks
expr_stmt|;
name|sz
operator|=
name|wblocks
operator|*
name|hblocks
operator|*
name|block_bytes
expr_stmt|;
return|return
name|sz
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_cs_track_cube
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|r100_cs_track
modifier|*
name|track
parameter_list|,
name|unsigned
name|idx
parameter_list|)
block|{
name|unsigned
name|face
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
name|struct
name|radeon_bo
modifier|*
name|cube_robj
decl_stmt|;
name|unsigned
name|long
name|size
decl_stmt|;
name|unsigned
name|compress_format
init|=
name|track
operator|->
name|textures
index|[
name|idx
index|]
operator|.
name|compress_format
decl_stmt|;
for|for
control|(
name|face
operator|=
literal|0
init|;
name|face
operator|<
literal|5
condition|;
name|face
operator|++
control|)
block|{
name|cube_robj
operator|=
name|track
operator|->
name|textures
index|[
name|idx
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|robj
expr_stmt|;
name|w
operator|=
name|track
operator|->
name|textures
index|[
name|idx
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|width
expr_stmt|;
name|h
operator|=
name|track
operator|->
name|textures
index|[
name|idx
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|height
expr_stmt|;
if|if
condition|(
name|compress_format
condition|)
block|{
name|size
operator|=
name|r100_track_compress_size
argument_list|(
name|compress_format
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
block|}
else|else
name|size
operator|=
name|w
operator|*
name|h
expr_stmt|;
name|size
operator|*=
name|track
operator|->
name|textures
index|[
name|idx
index|]
operator|.
name|cpp
expr_stmt|;
name|size
operator|+=
name|track
operator|->
name|textures
index|[
name|idx
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|offset
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|radeon_bo_size
argument_list|(
name|cube_robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Cube texture offset greater than object size %lu %lu\n"
argument_list|,
name|size
argument_list|,
name|radeon_bo_size
argument_list|(
name|cube_robj
argument_list|)
argument_list|)
expr_stmt|;
name|r100_cs_track_texture_print
argument_list|(
operator|&
name|track
operator|->
name|textures
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_cs_track_texture_check
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|r100_cs_track
modifier|*
name|track
parameter_list|)
block|{
name|struct
name|radeon_bo
modifier|*
name|robj
decl_stmt|;
name|unsigned
name|long
name|size
decl_stmt|;
name|unsigned
name|u
decl_stmt|,
name|i
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|,
name|d
decl_stmt|;
name|int
name|ret
decl_stmt|;
for|for
control|(
name|u
operator|=
literal|0
init|;
name|u
operator|<
name|track
operator|->
name|num_texture
condition|;
name|u
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|enabled
condition|)
continue|continue;
if|if
condition|(
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|lookup_disable
condition|)
continue|continue;
name|robj
operator|=
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|robj
expr_stmt|;
if|if
condition|(
name|robj
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"No texture bound to unit %u\n"
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|num_levels
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|use_pitch
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|family
operator|<
name|CHIP_R300
condition|)
name|w
operator|=
operator|(
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|pitch
operator|/
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|cpp
operator|)
operator|/
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
else|else
name|w
operator|=
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|pitch
operator|/
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
block|}
else|else
block|{
name|w
operator|=
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|width
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV515
condition|)
name|w
operator||=
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|width_11
expr_stmt|;
name|w
operator|=
name|w
operator|/
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|roundup_w
condition|)
name|w
operator|=
name|roundup_pow_of_two
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
name|h
operator|=
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|height
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV515
condition|)
name|h
operator||=
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|height_11
expr_stmt|;
name|h
operator|=
name|h
operator|/
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|roundup_h
condition|)
name|h
operator|=
name|roundup_pow_of_two
argument_list|(
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|tex_coord_type
operator|==
literal|1
condition|)
block|{
name|d
operator|=
operator|(
literal|1
operator|<<
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|txdepth
operator|)
operator|/
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|d
condition|)
name|d
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|d
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|compress_format
condition|)
block|{
name|size
operator|+=
name|r100_track_compress_size
argument_list|(
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|compress_format
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
operator|*
name|d
expr_stmt|;
comment|/* compressed textures are block based */
block|}
else|else
name|size
operator|+=
name|w
operator|*
name|h
operator|*
name|d
expr_stmt|;
block|}
name|size
operator|*=
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|cpp
expr_stmt|;
switch|switch
condition|(
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|tex_coord_type
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|1
case|:
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|track
operator|->
name|separate_cube
condition|)
block|{
name|ret
operator|=
name|r100_cs_track_cube
argument_list|(
name|rdev
argument_list|,
name|track
argument_list|,
name|u
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
else|else
name|size
operator|*=
literal|6
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Invalid texture coordinate type %u for unit "
literal|"%u\n"
argument_list|,
name|track
operator|->
name|textures
index|[
name|u
index|]
operator|.
name|tex_coord_type
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|size
operator|>
name|radeon_bo_size
argument_list|(
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Texture of unit %u needs %lu bytes but is "
literal|"%lu\n"
argument_list|,
name|u
argument_list|,
name|size
argument_list|,
name|radeon_bo_size
argument_list|(
name|robj
argument_list|)
argument_list|)
expr_stmt|;
name|r100_cs_track_texture_print
argument_list|(
operator|&
name|track
operator|->
name|textures
index|[
name|u
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r100_cs_track_check
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|r100_cs_track
modifier|*
name|track
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|unsigned
name|long
name|size
decl_stmt|;
name|unsigned
name|prim_walk
decl_stmt|;
name|unsigned
name|nverts
decl_stmt|;
name|unsigned
name|num_cb
init|=
name|track
operator|->
name|cb_dirty
condition|?
name|track
operator|->
name|num_cb
else|:
literal|0
decl_stmt|;
if|if
condition|(
name|num_cb
operator|&&
operator|!
name|track
operator|->
name|zb_cb_clear
operator|&&
operator|!
name|track
operator|->
name|color_channel_mask
operator|&&
operator|!
name|track
operator|->
name|blend_read_enable
condition|)
name|num_cb
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_cb
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"[drm] No buffer for color buffer %d !\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|size
operator|=
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|pitch
operator|*
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|cpp
operator|*
name|track
operator|->
name|maxy
expr_stmt|;
name|size
operator|+=
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|offset
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"[drm] Buffer too small for color buffer %d "
literal|"(need %lu have %lu) !\n"
argument_list|,
name|i
argument_list|,
name|size
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|robj
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"[drm] color buffer %d (%u %u %u %u)\n"
argument_list|,
name|i
argument_list|,
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|pitch
argument_list|,
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|cpp
argument_list|,
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|offset
argument_list|,
name|track
operator|->
name|maxy
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
name|track
operator|->
name|cb_dirty
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|track
operator|->
name|zb_dirty
operator|&&
name|track
operator|->
name|z_enabled
condition|)
block|{
if|if
condition|(
name|track
operator|->
name|zb
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"[drm] No buffer for z buffer !\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|size
operator|=
name|track
operator|->
name|zb
operator|.
name|pitch
operator|*
name|track
operator|->
name|zb
operator|.
name|cpp
operator|*
name|track
operator|->
name|maxy
expr_stmt|;
name|size
operator|+=
name|track
operator|->
name|zb
operator|.
name|offset
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|zb
operator|.
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"[drm] Buffer too small for z buffer "
literal|"(need %lu have %lu) !\n"
argument_list|,
name|size
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|zb
operator|.
name|robj
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"[drm] zbuffer (%u %u %u %u)\n"
argument_list|,
name|track
operator|->
name|zb
operator|.
name|pitch
argument_list|,
name|track
operator|->
name|zb
operator|.
name|cpp
argument_list|,
name|track
operator|->
name|zb
operator|.
name|offset
argument_list|,
name|track
operator|->
name|maxy
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
name|track
operator|->
name|zb_dirty
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|track
operator|->
name|aa_dirty
operator|&&
name|track
operator|->
name|aaresolve
condition|)
block|{
if|if
condition|(
name|track
operator|->
name|aa
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"[drm] No buffer for AA resolve buffer %d !\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* I believe the format comes from colorbuffer0. */
name|size
operator|=
name|track
operator|->
name|aa
operator|.
name|pitch
operator|*
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|cpp
operator|*
name|track
operator|->
name|maxy
expr_stmt|;
name|size
operator|+=
name|track
operator|->
name|aa
operator|.
name|offset
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|aa
operator|.
name|robj
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"[drm] Buffer too small for AA resolve buffer %d "
literal|"(need %lu have %lu) !\n"
argument_list|,
name|i
argument_list|,
name|size
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|aa
operator|.
name|robj
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"[drm] AA resolve buffer %d (%u %u %u %u)\n"
argument_list|,
name|i
argument_list|,
name|track
operator|->
name|aa
operator|.
name|pitch
argument_list|,
name|track
operator|->
name|cb
index|[
literal|0
index|]
operator|.
name|cpp
argument_list|,
name|track
operator|->
name|aa
operator|.
name|offset
argument_list|,
name|track
operator|->
name|maxy
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
name|track
operator|->
name|aa_dirty
operator|=
name|false
expr_stmt|;
name|prim_walk
operator|=
operator|(
name|track
operator|->
name|vap_vf_cntl
operator|>>
literal|4
operator|)
operator|&
literal|0x3
expr_stmt|;
if|if
condition|(
name|track
operator|->
name|vap_vf_cntl
operator|&
operator|(
literal|1
operator|<<
literal|14
operator|)
condition|)
block|{
name|nverts
operator|=
name|track
operator|->
name|vap_alt_nverts
expr_stmt|;
block|}
else|else
block|{
name|nverts
operator|=
operator|(
name|track
operator|->
name|vap_vf_cntl
operator|>>
literal|16
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
block|}
switch|switch
condition|(
name|prim_walk
condition|)
block|{
case|case
literal|1
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|track
operator|->
name|num_arrays
condition|;
name|i
operator|++
control|)
block|{
name|size
operator|=
name|track
operator|->
name|arrays
index|[
name|i
index|]
operator|.
name|esize
operator|*
name|track
operator|->
name|max_indx
operator|*
literal|4
expr_stmt|;
if|if
condition|(
name|track
operator|->
name|arrays
index|[
name|i
index|]
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"(PW %u) Vertex array %u no buffer "
literal|"bound\n"
argument_list|,
name|prim_walk
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|size
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|arrays
index|[
name|i
index|]
operator|.
name|robj
argument_list|)
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(PW %u) Vertex array %u "
literal|"need %lu dwords have %lu dwords\n"
argument_list|,
name|prim_walk
argument_list|,
name|i
argument_list|,
name|size
operator|>>
literal|2
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|arrays
index|[
name|i
index|]
operator|.
name|robj
argument_list|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"Max indices %u\n"
argument_list|,
name|track
operator|->
name|max_indx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
break|break;
case|case
literal|2
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|track
operator|->
name|num_arrays
condition|;
name|i
operator|++
control|)
block|{
name|size
operator|=
name|track
operator|->
name|arrays
index|[
name|i
index|]
operator|.
name|esize
operator|*
operator|(
name|nverts
operator|-
literal|1
operator|)
operator|*
literal|4
expr_stmt|;
if|if
condition|(
name|track
operator|->
name|arrays
index|[
name|i
index|]
operator|.
name|robj
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"(PW %u) Vertex array %u no buffer "
literal|"bound\n"
argument_list|,
name|prim_walk
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|size
operator|>
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|arrays
index|[
name|i
index|]
operator|.
name|robj
argument_list|)
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(PW %u) Vertex array %u "
literal|"need %lu dwords have %lu dwords\n"
argument_list|,
name|prim_walk
argument_list|,
name|i
argument_list|,
name|size
operator|>>
literal|2
argument_list|,
name|radeon_bo_size
argument_list|(
name|track
operator|->
name|arrays
index|[
name|i
index|]
operator|.
name|robj
argument_list|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
break|break;
case|case
literal|3
case|:
name|size
operator|=
name|track
operator|->
name|vtx_size
operator|*
name|nverts
expr_stmt|;
if|if
condition|(
name|size
operator|!=
name|track
operator|->
name|immd_dwords
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"IMMD draw %u dwors but needs %lu dwords\n"
argument_list|,
name|track
operator|->
name|immd_dwords
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"VAP_VF_CNTL.NUM_VERTICES %u, VTX_SIZE %u\n"
argument_list|,
name|nverts
argument_list|,
name|track
operator|->
name|vtx_size
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"[drm] Invalid primitive walk %d for VAP_VF_CNTL\n"
argument_list|,
name|prim_walk
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|track
operator|->
name|tex_dirty
condition|)
block|{
name|track
operator|->
name|tex_dirty
operator|=
name|false
expr_stmt|;
return|return
name|r100_cs_track_texture_check
argument_list|(
name|rdev
argument_list|,
name|track
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r100_cs_track_clear
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|r100_cs_track
modifier|*
name|track
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|,
name|face
decl_stmt|;
name|track
operator|->
name|cb_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|zb_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|tex_dirty
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|aa_dirty
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|<
name|CHIP_R300
condition|)
block|{
name|track
operator|->
name|num_cb
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RS200
condition|)
name|track
operator|->
name|num_texture
operator|=
literal|3
expr_stmt|;
else|else
name|track
operator|->
name|num_texture
operator|=
literal|6
expr_stmt|;
name|track
operator|->
name|maxy
operator|=
literal|2048
expr_stmt|;
name|track
operator|->
name|separate_cube
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|track
operator|->
name|num_cb
operator|=
literal|4
expr_stmt|;
name|track
operator|->
name|num_texture
operator|=
literal|16
expr_stmt|;
name|track
operator|->
name|maxy
operator|=
literal|4096
expr_stmt|;
name|track
operator|->
name|separate_cube
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|aaresolve
operator|=
name|false
expr_stmt|;
name|track
operator|->
name|aa
operator|.
name|robj
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|track
operator|->
name|num_cb
condition|;
name|i
operator|++
control|)
block|{
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|robj
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|pitch
operator|=
literal|8192
expr_stmt|;
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|16
expr_stmt|;
name|track
operator|->
name|cb
index|[
name|i
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
block|}
name|track
operator|->
name|z_enabled
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|zb
operator|.
name|robj
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|zb
operator|.
name|pitch
operator|=
literal|8192
expr_stmt|;
name|track
operator|->
name|zb
operator|.
name|cpp
operator|=
literal|4
expr_stmt|;
name|track
operator|->
name|zb
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|vtx_size
operator|=
literal|0x7F
expr_stmt|;
name|track
operator|->
name|immd_dwords
operator|=
literal|0xFFFFFFFFUL
expr_stmt|;
name|track
operator|->
name|num_arrays
operator|=
literal|11
expr_stmt|;
name|track
operator|->
name|max_indx
operator|=
literal|0x00FFFFFFUL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|track
operator|->
name|num_arrays
condition|;
name|i
operator|++
control|)
block|{
name|track
operator|->
name|arrays
index|[
name|i
index|]
operator|.
name|robj
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|arrays
index|[
name|i
index|]
operator|.
name|esize
operator|=
literal|0x7F
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|track
operator|->
name|num_texture
condition|;
name|i
operator|++
control|)
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|compress_format
operator|=
name|R100_TRACK_COMP_NONE
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|pitch
operator|=
literal|16536
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|width
operator|=
literal|16536
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|height
operator|=
literal|16536
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|width_11
operator|=
literal|1
operator|<<
literal|11
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|height_11
operator|=
literal|1
operator|<<
literal|11
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|num_levels
operator|=
literal|12
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RS200
condition|)
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|tex_coord_type
operator|=
literal|0
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|txdepth
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|txdepth
operator|=
literal|16
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|tex_coord_type
operator|=
literal|1
expr_stmt|;
block|}
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cpp
operator|=
literal|64
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|robj
operator|=
name|NULL
expr_stmt|;
comment|/* CS IB emission code makes sure texture unit are disabled */
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|enabled
operator|=
name|false
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|lookup_disable
operator|=
name|false
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|roundup_w
operator|=
name|true
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|roundup_h
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|track
operator|->
name|separate_cube
condition|)
for|for
control|(
name|face
operator|=
literal|0
init|;
name|face
operator|<
literal|5
condition|;
name|face
operator|++
control|)
block|{
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|robj
operator|=
name|NULL
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|width
operator|=
literal|16536
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|height
operator|=
literal|16536
expr_stmt|;
name|track
operator|->
name|textures
index|[
name|i
index|]
operator|.
name|cube_info
index|[
name|face
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Global GPU functions  */
end_comment

begin_function
specifier|static
name|void
name|r100_errata
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|rdev
operator|->
name|pll_errata
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV200
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS200
condition|)
block|{
name|rdev
operator|->
name|pll_errata
operator||=
name|CHIP_ERRATA_PLL_DUMMYREADS
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV100
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS100
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS200
condition|)
block|{
name|rdev
operator|->
name|pll_errata
operator||=
name|CHIP_ERRATA_PLL_DELAY
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|r100_rbbm_fifo_wait_for_entry
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|unsigned
name|n
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_RBBM_STATUS
argument_list|)
operator|&
name|RADEON_RBBM_FIFOCNT_MASK
expr_stmt|;
if|if
condition|(
name|tmp
operator|>=
name|n
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|r100_gui_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|r100_rbbm_fifo_wait_for_entry
argument_list|(
name|rdev
argument_list|,
literal|64
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: wait for empty RBBM fifo failed !"
literal|" Bad things might happen.\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_RBBM_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RADEON_RBBM_ACTIVE
operator|)
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|r100_mc_wait_for_idle
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
comment|/* read MC_STATUS */
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MC_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_MC_IDLE
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|bool
name|r100_gpu_is_lockup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|u32
name|rbbm_status
decl_stmt|;
name|rbbm_status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|G_000E40_GUI_ACTIVE
argument_list|(
name|rbbm_status
argument_list|)
condition|)
block|{
name|radeon_ring_lockup_update
argument_list|(
name|ring
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* force CP activities */
name|radeon_ring_force_activity
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|radeon_ring_test_lockup
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* required on r1xx, r2xx, r300, r(v)350, r420/r481, rs400/rs480 */
end_comment

begin_function
name|void
name|r100_enable_bm
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
comment|/* Enable bus mastering */
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
operator|&
operator|~
name|RADEON_BUS_MASTER_DIS
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r100_bm_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
comment|/* disable bus mastering */
name|tmp
operator|=
name|RREG32
argument_list|(
name|R_000030_BUS_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000030_BUS_CNTL
argument_list|,
operator|(
name|tmp
operator|&
literal|0xFFFFFFFF
operator|)
operator||
literal|0x00000044
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000030_BUS_CNTL
argument_list|,
operator|(
name|tmp
operator|&
literal|0xFFFFFFFF
operator|)
operator||
literal|0x00000042
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000030_BUS_CNTL
argument_list|,
operator|(
name|tmp
operator|&
literal|0xFFFFFFFF
operator|)
operator||
literal|0x00000040
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|pci_disable_busmaster
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r100_asic_reset
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|r100_mc_save
name|save
decl_stmt|;
name|u32
name|status
decl_stmt|,
name|tmp
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|G_000E40_GUI_ACTIVE
argument_list|(
name|status
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
name|r100_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%s:%d) RBBM_STATUS=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* stop CP */
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|tmp
operator||
name|RADEON_RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_RPTR_WR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* save PCI state */
name|pci_save_state
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
expr_stmt|;
comment|/* disable bus mastering */
name|r100_bm_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
name|S_0000F0_SOFT_RESET_SE
argument_list|(
literal|1
argument_list|)
operator||
name|S_0000F0_SOFT_RESET_RE
argument_list|(
literal|1
argument_list|)
operator||
name|S_0000F0_SOFT_RESET_PP
argument_list|(
literal|1
argument_list|)
operator||
name|S_0000F0_SOFT_RESET_RB
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%s:%d) RBBM_STATUS=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* reset CP */
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
name|S_0000F0_SOFT_RESET_CP
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0000F0_RBBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
expr_stmt|;
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"(%s:%d) RBBM_STATUS=0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* restore PCI& busmastering */
name|pci_restore_state
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
expr_stmt|;
name|r100_enable_bm
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Check if GPU is idle */
if|if
condition|(
name|G_000E40_SE_BUSY
argument_list|(
name|status
argument_list|)
operator|||
name|G_000E40_RE_BUSY
argument_list|(
name|status
argument_list|)
operator|||
name|G_000E40_TAM_BUSY
argument_list|(
name|status
argument_list|)
operator|||
name|G_000E40_PB_BUSY
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed to reset GPU\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|dev_info
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset succeed\n"
argument_list|)
expr_stmt|;
name|r100_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|r100_set_common_regs
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|bool
name|force_dac2
init|=
name|false
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* set these so they don't interfere with anything */
name|WREG32
argument_list|(
name|RADEON_OV0_SCALE_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_SUBPIC_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_VIPH_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_I2C_CNTL_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DVI_I2C_CNTL_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CAP0_TRIG_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CAP1_TRIG_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* always set up dac2 on rn50 and some rv100 as lots 	 * of servers seem to wire it up to a VGA port but 	 * don't report it in the bios connector 	 * table. 	 */
switch|switch
condition|(
name|dev
operator|->
name|pci_device
condition|)
block|{
comment|/* RN50 */
case|case
literal|0x515e
case|:
case|case
literal|0x5969
case|:
name|force_dac2
operator|=
name|true
expr_stmt|;
break|break;
comment|/* RV100*/
case|case
literal|0x5159
case|:
case|case
literal|0x515a
case|:
comment|/* DELL triple head servers */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1028
comment|/* DELL */
operator|)
operator|&&
operator|(
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x016c
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x016d
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x016e
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x016f
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x0170
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x017d
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x017e
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x0183
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x018a
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x019a
operator|)
operator|)
condition|)
name|force_dac2
operator|=
name|true
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|force_dac2
condition|)
block|{
name|u32
name|disp_hw_debug
init|=
name|RREG32
argument_list|(
name|RADEON_DISP_HW_DEBUG
argument_list|)
decl_stmt|;
name|u32
name|tv_dac_cntl
init|=
name|RREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|)
decl_stmt|;
name|u32
name|dac2_cntl
init|=
name|RREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|)
decl_stmt|;
comment|/* For CRT on DAC2, don't turn it on if BIOS didn't 		   enable it, even it's detected. 		*/
comment|/* force it to crtc0 */
name|dac2_cntl
operator|&=
operator|~
name|RADEON_DAC2_DAC_CLK_SEL
expr_stmt|;
name|dac2_cntl
operator||=
name|RADEON_DAC2_DAC2_CLK_SEL
expr_stmt|;
name|disp_hw_debug
operator||=
name|RADEON_CRT2_DISP1_SEL
expr_stmt|;
comment|/* set up the TV DAC */
name|tv_dac_cntl
operator|&=
operator|~
operator|(
name|RADEON_TV_DAC_PEDESTAL
operator||
name|RADEON_TV_DAC_STD_MASK
operator||
name|RADEON_TV_DAC_RDACPD
operator||
name|RADEON_TV_DAC_GDACPD
operator||
name|RADEON_TV_DAC_BDACPD
operator||
name|RADEON_TV_DAC_BGADJ_MASK
operator||
name|RADEON_TV_DAC_DACADJ_MASK
operator|)
expr_stmt|;
name|tv_dac_cntl
operator||=
operator|(
name|RADEON_TV_DAC_NBLANK
operator||
name|RADEON_TV_DAC_NHOLD
operator||
name|RADEON_TV_DAC_STD_PS2
operator||
operator|(
literal|0x58
operator|<<
literal|16
operator|)
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_TV_DAC_CNTL
argument_list|,
name|tv_dac_cntl
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DISP_HW_DEBUG
argument_list|,
name|disp_hw_debug
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_DAC_CNTL2
argument_list|,
name|dac2_cntl
argument_list|)
expr_stmt|;
block|}
comment|/* switch PM block to ACPI mode */
name|tmp
operator|=
name|RREG32_PLL
argument_list|(
name|RADEON_PLL_PWRMGT_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|RADEON_PM_MODE_SEL
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|RADEON_PLL_PWRMGT_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * VRAM info  */
end_comment

begin_function
specifier|static
name|void
name|r100_vram_get_type
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
elseif|else
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_MEM_SDRAM_MODE_REG
argument_list|)
operator|&
name|RADEON_MEM_CFG_TYPE_DDR
condition|)
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV100
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS100
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS200
operator|)
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MEM_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RV100_HALF_MODE
condition|)
block|{
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|32
expr_stmt|;
block|}
else|else
block|{
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|64
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
condition|)
block|{
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|/=
literal|4
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|=
name|true
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RV280
condition|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MEM_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_MEM_NUM_CHANNELS_MASK
condition|)
block|{
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
block|}
else|else
block|{
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|64
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* newer IGPs */
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|=
literal|128
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|u32
name|r100_get_accessible_vram
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|aper_size
decl_stmt|;
name|u8
name|byte
decl_stmt|;
name|aper_size
operator|=
name|RREG32
argument_list|(
name|RADEON_CONFIG_APER_SIZE
argument_list|)
expr_stmt|;
comment|/* Set HDP_APER_CNTL only on cards that are known not to be broken, 	 * that is has the 2nd generation multifunction PCI interface 	 */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV280
operator|||
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV350
condition|)
block|{
name|WREG32_P
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|,
name|RADEON_HDP_APER_CNTL
argument_list|,
operator|~
name|RADEON_HDP_APER_CNTL
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"Generation 2 PCI interface, using max accessible memory\n"
argument_list|)
expr_stmt|;
return|return
name|aper_size
operator|*
literal|2
return|;
block|}
comment|/* Older cards have all sorts of funny issues to deal with. First 	 * check if it's a multifunction card by reading the PCI config 	 * header type... Limit those to one aperture size 	 */
name|byte
operator|=
name|pci_read_config
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|0xe
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|byte
operator|&
literal|0x80
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Generation 1 PCI interface in multifunction mode\n"
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"Limiting VRAM to one aperture\n"
argument_list|)
expr_stmt|;
return|return
name|aper_size
return|;
block|}
comment|/* Single function older card. We read HDP_APER_CNTL to see how the BIOS 	 * have set it up. We don't write this as it's broken on some ASICs but 	 * we expect the BIOS to have done the right thing (might be too optimistic...) 	 */
if|if
condition|(
name|RREG32
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|)
operator|&
name|RADEON_HDP_APER_CNTL
condition|)
return|return
name|aper_size
operator|*
literal|2
return|;
return|return
name|aper_size
return|;
block|}
end_function

begin_function
name|void
name|r100_vram_init_sizes
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u64
name|config_aper_size
decl_stmt|;
comment|/* work out accessible VRAM */
name|rdev
operator|->
name|mc
operator|.
name|aper_base
operator|=
name|drm_get_resource_start
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|aper_size
operator|=
name|drm_get_resource_len
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
operator|=
name|r100_get_accessible_vram
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* FIXME we don't use the second aperture yet when we could use it */
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
operator|>
name|rdev
operator|->
name|mc
operator|.
name|aper_size
condition|)
name|rdev
operator|->
name|mc
operator|.
name|visible_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_size
expr_stmt|;
name|config_aper_size
operator|=
name|RREG32
argument_list|(
name|RADEON_CONFIG_APER_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
name|uint32_t
name|tom
decl_stmt|;
comment|/* read NB_TOM to get the amount of ram stolen for the GPU */
name|tom
operator|=
name|RREG32
argument_list|(
name|RADEON_NB_TOM
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|=
operator|(
operator|(
operator|(
name|tom
operator|>>
literal|16
operator|)
operator|-
operator|(
name|tom
operator|&
literal|0xffff
operator|)
operator|+
literal|1
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CONFIG_MEMSIZE
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|mc_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
expr_stmt|;
block|}
else|else
block|{
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|=
name|RREG32
argument_list|(
name|RADEON_CONFIG_MEMSIZE
argument_list|)
expr_stmt|;
comment|/* Some production boards of m6 will report 0 		 * if it's 8 MB 		 */
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|==
literal|0
condition|)
block|{
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
operator|=
literal|8192
operator|*
literal|1024
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CONFIG_MEMSIZE
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
argument_list|)
expr_stmt|;
block|}
comment|/* Fix for RN50, M6, M7 with 8/16/32(??) MBs of VRAM -  		 * Novell bug 204882 + along with lots of ubuntu ones 		 */
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|aper_size
operator|>
name|config_aper_size
condition|)
name|config_aper_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_size
expr_stmt|;
if|if
condition|(
name|config_aper_size
operator|>
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
condition|)
name|rdev
operator|->
name|mc
operator|.
name|mc_vram_size
operator|=
name|config_aper_size
expr_stmt|;
else|else
name|rdev
operator|->
name|mc
operator|.
name|mc_vram_size
operator|=
name|rdev
operator|->
name|mc
operator|.
name|real_vram_size
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|r100_vga_set_state
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|bool
name|state
parameter_list|)
block|{
name|uint32_t
name|temp
decl_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|RADEON_CONFIG_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|false
condition|)
block|{
name|temp
operator|&=
operator|~
name|RADEON_CFG_VGA_RAM_EN
expr_stmt|;
name|temp
operator||=
name|RADEON_CFG_VGA_IO_DIS
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|&=
operator|~
name|RADEON_CFG_VGA_IO_DIS
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_CONFIG_CNTL
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r100_mc_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u64
name|base
decl_stmt|;
name|r100_vram_get_type
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_vram_init_sizes
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|base
operator|=
name|rdev
operator|->
name|mc
operator|.
name|aper_base
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
name|base
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_NB_TOM
argument_list|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
expr_stmt|;
name|radeon_vram_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|mc
operator|.
name|gtt_base_align
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
condition|)
name|radeon_gtt_location
argument_list|(
name|rdev
argument_list|,
operator|&
name|rdev
operator|->
name|mc
argument_list|)
expr_stmt|;
name|radeon_update_bandwidth_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Indirect registers accessor  */
end_comment

begin_function
name|void
name|r100_pll_errata_after_index
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pll_errata
operator|&
name|CHIP_ERRATA_PLL_DUMMYREADS
condition|)
block|{
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|RADEON_CLOCK_CNTL_DATA
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RREG32
argument_list|(
name|RADEON_CRTC_GEN_CNTL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|r100_pll_errata_after_data
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
comment|/* This workarounds is necessary on RV100, RS100 and RS200 chips 	 * or the chip could hang on a subsequent access 	 */
if|if
condition|(
name|rdev
operator|->
name|pll_errata
operator|&
name|CHIP_ERRATA_PLL_DELAY
condition|)
block|{
name|DRM_MDELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
comment|/* This function is required to workaround a hardware bug in some (all?) 	 * revisions of the R300.  This workaround should be called after every 	 * CLOCK_CNTL_INDEX register access.  If not, register reads afterward 	 * may not be correct. 	 */
if|if
condition|(
name|rdev
operator|->
name|pll_errata
operator|&
name|CHIP_ERRATA_R300_CG
condition|)
block|{
name|uint32_t
name|save
decl_stmt|,
name|tmp
decl_stmt|;
name|save
operator|=
name|RREG32
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|save
operator|&
operator|~
operator|(
literal|0x3f
operator||
name|RADEON_PLL_WR_EN
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CLOCK_CNTL_DATA
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|,
name|save
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|uint32_t
name|r100_pll_rreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|)
block|{
name|uint32_t
name|data
decl_stmt|;
name|WREG8
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|,
name|reg
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
name|r100_pll_errata_after_index
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|data
operator|=
name|RREG32
argument_list|(
name|RADEON_CLOCK_CNTL_DATA
argument_list|)
expr_stmt|;
name|r100_pll_errata_after_data
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_function
name|void
name|r100_pll_wreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|v
parameter_list|)
block|{
name|WREG8
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|,
operator|(
operator|(
name|reg
operator|&
literal|0x3f
operator|)
operator||
name|RADEON_PLL_WR_EN
operator|)
argument_list|)
expr_stmt|;
name|r100_pll_errata_after_index
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_CLOCK_CNTL_DATA
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|r100_pll_errata_after_data
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r100_set_safe_registers
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|if
condition|(
name|ASIC_IS_RN50
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|reg_safe_bm
operator|=
name|rn50_reg_safe_bm
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|reg_safe_bm_size
operator|=
name|DRM_ARRAY_SIZE
argument_list|(
name|rn50_reg_safe_bm
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|<
name|CHIP_R200
condition|)
block|{
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|reg_safe_bm
operator|=
name|r100_reg_safe_bm
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|reg_safe_bm_size
operator|=
name|DRM_ARRAY_SIZE
argument_list|(
name|r100_reg_safe_bm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r200_set_safe_registers
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Debugfs info  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
end_if

begin_function
specifier|static
name|int
name|r100_debugfs_rbbm_info
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_info_node
modifier|*
name|node
init|=
operator|(
expr|struct
name|drm_info_node
operator|*
operator|)
name|m
operator|->
name|private
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|node
operator|->
name|minor
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|,
name|value
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"RBBM_STATUS 0x%08x\n"
argument_list|,
name|RREG32
argument_list|(
name|RADEON_RBBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"RBBM_CMDFIFO_STAT 0x%08x\n"
argument_list|,
name|RREG32
argument_list|(
literal|0xE7C
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"CP_STAT 0x%08x\n"
argument_list|,
name|RREG32
argument_list|(
name|RADEON_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RADEON_RBBM_CMDFIFO_ADDR
argument_list|,
name|i
operator||
literal|0x100
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_RBBM_CMDFIFO_DATA
argument_list|)
operator|-
literal|1
operator|)
operator|>>
literal|2
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_RBBM_CMDFIFO_ADDR
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|value
operator|=
name|RREG32
argument_list|(
name|RADEON_RBBM_CMDFIFO_DATA
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"[0x%03X] 0x%04X=0x%08X\n"
argument_list|,
name|i
argument_list|,
name|reg
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_debugfs_cp_ring_info
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_info_node
modifier|*
name|node
init|=
operator|(
expr|struct
name|drm_info_node
operator|*
operator|)
name|m
operator|->
name|private
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|node
operator|->
name|minor
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
name|uint32_t
name|rdp
decl_stmt|,
name|wdp
decl_stmt|;
name|unsigned
name|count
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|radeon_ring_free_size
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
name|rdp
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_RB_RPTR
argument_list|)
expr_stmt|;
name|wdp
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_RB_WPTR
argument_list|)
expr_stmt|;
name|count
operator|=
operator|(
name|rdp
operator|+
name|ring
operator|->
name|ring_size
operator|-
name|wdp
operator|)
operator|&
name|ring
operator|->
name|ptr_mask
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"CP_STAT 0x%08x\n"
argument_list|,
name|RREG32
argument_list|(
name|RADEON_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"CP_RB_WPTR 0x%08x\n"
argument_list|,
name|wdp
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"CP_RB_RPTR 0x%08x\n"
argument_list|,
name|rdp
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"%u free dwords in ring\n"
argument_list|,
name|ring
operator|->
name|ring_free_dw
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"%u dwords in ring\n"
argument_list|,
name|count
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<=
name|count
condition|;
name|j
operator|++
control|)
block|{
name|i
operator|=
operator|(
name|rdp
operator|+
name|j
operator|)
operator|&
name|ring
operator|->
name|ptr_mask
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"r[%04d]=0x%08x\n"
argument_list|,
name|i
argument_list|,
name|ring
operator|->
name|ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_debugfs_cp_csq_fifo
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_info_node
modifier|*
name|node
init|=
operator|(
expr|struct
name|drm_info_node
operator|*
operator|)
name|m
operator|->
name|private
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|node
operator|->
name|minor
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|csq_stat
decl_stmt|,
name|csq2_stat
decl_stmt|,
name|tmp
decl_stmt|;
name|unsigned
name|r_rptr
decl_stmt|,
name|r_wptr
decl_stmt|,
name|ib1_rptr
decl_stmt|,
name|ib1_wptr
decl_stmt|,
name|ib2_rptr
decl_stmt|,
name|ib2_wptr
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"CP_STAT 0x%08x\n"
argument_list|,
name|RREG32
argument_list|(
name|RADEON_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"CP_CSQ_MODE 0x%08x\n"
argument_list|,
name|RREG32
argument_list|(
name|RADEON_CP_CSQ_MODE
argument_list|)
argument_list|)
expr_stmt|;
name|csq_stat
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_CSQ_STAT
argument_list|)
expr_stmt|;
name|csq2_stat
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_CSQ2_STAT
argument_list|)
expr_stmt|;
name|r_rptr
operator|=
operator|(
name|csq_stat
operator|>>
literal|0
operator|)
operator|&
literal|0x3ff
expr_stmt|;
name|r_wptr
operator|=
operator|(
name|csq_stat
operator|>>
literal|10
operator|)
operator|&
literal|0x3ff
expr_stmt|;
name|ib1_rptr
operator|=
operator|(
name|csq_stat
operator|>>
literal|20
operator|)
operator|&
literal|0x3ff
expr_stmt|;
name|ib1_wptr
operator|=
operator|(
name|csq2_stat
operator|>>
literal|0
operator|)
operator|&
literal|0x3ff
expr_stmt|;
name|ib2_rptr
operator|=
operator|(
name|csq2_stat
operator|>>
literal|10
operator|)
operator|&
literal|0x3ff
expr_stmt|;
name|ib2_wptr
operator|=
operator|(
name|csq2_stat
operator|>>
literal|20
operator|)
operator|&
literal|0x3ff
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"CP_CSQ_STAT 0x%08x\n"
argument_list|,
name|csq_stat
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"CP_CSQ2_STAT 0x%08x\n"
argument_list|,
name|csq2_stat
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"Ring rptr %u\n"
argument_list|,
name|r_rptr
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"Ring wptr %u\n"
argument_list|,
name|r_wptr
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"Indirect1 rptr %u\n"
argument_list|,
name|ib1_rptr
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"Indirect1 wptr %u\n"
argument_list|,
name|ib1_wptr
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"Indirect2 rptr %u\n"
argument_list|,
name|ib2_rptr
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"Indirect2 wptr %u\n"
argument_list|,
name|ib2_wptr
argument_list|)
expr_stmt|;
comment|/* FIXME: 0, 128, 640 depends on fifo setup see cp_init_kms 	 * 128 = indirect1_start * 8& 640 = indirect2_start * 8 */
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"Ring fifo:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_ADDR
argument_list|,
name|i
operator|<<
literal|2
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_CSQ_DATA
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"rfifo[%04d]=0x%08X\n"
argument_list|,
name|i
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"Indirect1 fifo:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|256
init|;
name|i
operator|<=
literal|512
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_ADDR
argument_list|,
name|i
operator|<<
literal|2
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_CSQ_DATA
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"ib1fifo[%04d]=0x%08X\n"
argument_list|,
name|i
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"Indirect2 fifo:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|640
init|;
name|i
operator|<
name|ib1_wptr
condition|;
name|i
operator|++
control|)
block|{
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_ADDR
argument_list|,
name|i
operator|<<
literal|2
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_CSQ_DATA
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"ib2fifo[%04d]=0x%08X\n"
argument_list|,
name|i
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_debugfs_mc_info
parameter_list|(
name|struct
name|seq_file
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_info_node
modifier|*
name|node
init|=
operator|(
expr|struct
name|drm_info_node
operator|*
operator|)
name|m
operator|->
name|private
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|node
operator|->
name|minor
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CONFIG_MEMSIZE
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"CONFIG_MEMSIZE 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MC_FB_LOCATION
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MC_FB_LOCATION 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"BUS_CNTL 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MC_AGP_LOCATION
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"MC_AGP_LOCATION 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_AGP_BASE
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"AGP_BASE 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"HOST_PATH_CNTL 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
literal|0x01D0
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"AIC_CTRL 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_AIC_LO_ADDR
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"AIC_LO_ADDR 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_AIC_HI_ADDR
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"AIC_HI_ADDR 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
literal|0x01E4
argument_list|)
expr_stmt|;
name|seq_printf
argument_list|(
name|m
argument_list|,
literal|"AIC_TLB_ADDR 0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|drm_info_list
name|r100_debugfs_rbbm_list
index|[]
init|=
block|{
block|{
literal|"r100_rbbm_info"
block|,
name|r100_debugfs_rbbm_info
block|,
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|drm_info_list
name|r100_debugfs_cp_list
index|[]
init|=
block|{
block|{
literal|"r100_cp_ring_info"
block|,
name|r100_debugfs_cp_ring_info
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
literal|"r100_cp_csq_fifo"
block|,
name|r100_debugfs_cp_csq_fifo
block|,
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|drm_info_list
name|r100_debugfs_mc_info_list
index|[]
init|=
block|{
block|{
literal|"r100_mc_info"
block|,
name|r100_debugfs_mc_info
block|,
literal|0
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|r100_debugfs_rbbm_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
return|return
name|radeon_debugfs_add_files
argument_list|(
name|rdev
argument_list|,
name|r100_debugfs_rbbm_list
argument_list|,
literal|1
argument_list|)
return|;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|r100_debugfs_cp_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
return|return
name|radeon_debugfs_add_files
argument_list|(
name|rdev
argument_list|,
name|r100_debugfs_cp_list
argument_list|,
literal|2
argument_list|)
return|;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|r100_debugfs_mc_info_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_DEBUG_FS
argument_list|)
return|return
name|radeon_debugfs_add_files
argument_list|(
name|rdev
argument_list|,
name|r100_debugfs_mc_info_list
argument_list|,
literal|1
argument_list|)
return|;
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|r100_set_surface_reg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|reg
parameter_list|,
name|uint32_t
name|tiling_flags
parameter_list|,
name|uint32_t
name|pitch
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint32_t
name|obj_size
parameter_list|)
block|{
name|int
name|surf_index
init|=
name|reg
operator|*
literal|16
decl_stmt|;
name|int
name|flags
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RS200
condition|)
block|{
if|if
condition|(
operator|(
name|tiling_flags
operator|&
operator|(
name|RADEON_TILING_MACRO
operator||
name|RADEON_TILING_MICRO
operator|)
operator|)
operator|==
operator|(
name|RADEON_TILING_MACRO
operator||
name|RADEON_TILING_MICRO
operator|)
condition|)
name|flags
operator||=
name|RADEON_SURF_TILE_COLOR_BOTH
expr_stmt|;
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|flags
operator||=
name|RADEON_SURF_TILE_COLOR_MACRO
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RV280
condition|)
block|{
if|if
condition|(
name|tiling_flags
operator|&
operator|(
name|RADEON_TILING_MACRO
operator|)
condition|)
name|flags
operator||=
name|R200_SURF_TILE_COLOR_MACRO
expr_stmt|;
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|flags
operator||=
name|R200_SURF_TILE_COLOR_MICRO
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MACRO
condition|)
name|flags
operator||=
name|R300_SURF_TILE_MACRO
expr_stmt|;
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_MICRO
condition|)
name|flags
operator||=
name|R300_SURF_TILE_MICRO
expr_stmt|;
block|}
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_SWAP_16BIT
condition|)
name|flags
operator||=
name|RADEON_SURF_AP0_SWP_16BPP
operator||
name|RADEON_SURF_AP1_SWP_16BPP
expr_stmt|;
if|if
condition|(
name|tiling_flags
operator|&
name|RADEON_TILING_SWAP_32BIT
condition|)
name|flags
operator||=
name|RADEON_SURF_AP0_SWP_32BPP
operator||
name|RADEON_SURF_AP1_SWP_32BPP
expr_stmt|;
comment|/* when we aren't tiling the pitch seems to needs to be furtherdivided down. - tested on power5 + rn50 server */
if|if
condition|(
name|tiling_flags
operator|&
operator|(
name|RADEON_TILING_SWAP_16BIT
operator||
name|RADEON_TILING_SWAP_32BIT
operator|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|tiling_flags
operator|&
operator|(
name|RADEON_TILING_MACRO
operator||
name|RADEON_TILING_MICRO
operator|)
operator|)
condition|)
if|if
condition|(
name|ASIC_IS_RN50
argument_list|(
name|rdev
argument_list|)
condition|)
name|pitch
operator|/=
literal|16
expr_stmt|;
block|}
comment|/* r100/r200 divide by 16 */
if|if
condition|(
name|rdev
operator|->
name|family
operator|<
name|CHIP_R300
condition|)
name|flags
operator||=
name|pitch
operator|/
literal|16
expr_stmt|;
else|else
name|flags
operator||=
name|pitch
operator|/
literal|8
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"writing surface %d %d %x %x\n"
argument_list|,
name|reg
argument_list|,
name|flags
argument_list|,
name|offset
argument_list|,
name|offset
operator|+
name|obj_size
operator|-
literal|1
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_SURFACE0_INFO
operator|+
name|surf_index
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_SURFACE0_LOWER_BOUND
operator|+
name|surf_index
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_SURFACE0_UPPER_BOUND
operator|+
name|surf_index
argument_list|,
name|offset
operator|+
name|obj_size
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r100_clear_surface_reg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|int
name|surf_index
init|=
name|reg
operator|*
literal|16
decl_stmt|;
name|WREG32
argument_list|(
name|RADEON_SURFACE0_INFO
operator|+
name|surf_index
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r100_bandwidth_update
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|fixed20_12
name|trcd_ff
decl_stmt|,
name|trp_ff
decl_stmt|,
name|tras_ff
decl_stmt|,
name|trbs_ff
decl_stmt|,
name|tcas_ff
decl_stmt|;
name|fixed20_12
name|sclk_ff
decl_stmt|,
name|mclk_ff
decl_stmt|,
name|sclk_eff_ff
decl_stmt|,
name|sclk_delay_ff
decl_stmt|;
name|fixed20_12
name|peak_disp_bw
decl_stmt|,
name|mem_bw
decl_stmt|,
name|pix_clk
decl_stmt|,
name|pix_clk2
decl_stmt|,
name|temp_ff
decl_stmt|,
name|crit_point_ff
decl_stmt|;
name|uint32_t
name|temp
decl_stmt|,
name|data
decl_stmt|,
name|mem_trcd
decl_stmt|,
name|mem_trp
decl_stmt|,
name|mem_tras
decl_stmt|;
name|fixed20_12
name|memtcas_ff
index|[
literal|8
index|]
init|=
block|{
name|dfixed_init
argument_list|(
literal|1
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|2
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|3
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|0
argument_list|)
block|,
name|dfixed_init_half
argument_list|(
literal|1
argument_list|)
block|,
name|dfixed_init_half
argument_list|(
literal|2
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|0
argument_list|)
block|, 	}
decl_stmt|;
name|fixed20_12
name|memtcas_rs480_ff
index|[
literal|8
index|]
init|=
block|{
name|dfixed_init
argument_list|(
literal|0
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|1
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|2
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|3
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|0
argument_list|)
block|,
name|dfixed_init_half
argument_list|(
literal|1
argument_list|)
block|,
name|dfixed_init_half
argument_list|(
literal|2
argument_list|)
block|,
name|dfixed_init_half
argument_list|(
literal|3
argument_list|)
block|, 	}
decl_stmt|;
name|fixed20_12
name|memtcas2_ff
index|[
literal|8
index|]
init|=
block|{
name|dfixed_init
argument_list|(
literal|0
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|1
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|2
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|3
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|4
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|5
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|6
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|7
argument_list|)
block|, 	}
decl_stmt|;
name|fixed20_12
name|memtrbs
index|[
literal|8
index|]
init|=
block|{
name|dfixed_init
argument_list|(
literal|1
argument_list|)
block|,
name|dfixed_init_half
argument_list|(
literal|1
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|2
argument_list|)
block|,
name|dfixed_init_half
argument_list|(
literal|2
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|3
argument_list|)
block|,
name|dfixed_init_half
argument_list|(
literal|3
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|4
argument_list|)
block|,
name|dfixed_init_half
argument_list|(
literal|4
argument_list|)
block|}
decl_stmt|;
name|fixed20_12
name|memtrbs_r4xx
index|[
literal|8
index|]
init|=
block|{
name|dfixed_init
argument_list|(
literal|4
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|5
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|6
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|7
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|8
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|9
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|10
argument_list|)
block|,
name|dfixed_init
argument_list|(
literal|11
argument_list|)
block|}
decl_stmt|;
name|fixed20_12
name|min_mem_eff
decl_stmt|;
name|fixed20_12
name|mc_latency_sclk
decl_stmt|,
name|mc_latency_mclk
decl_stmt|,
name|k1
decl_stmt|;
name|fixed20_12
name|cur_latency_mclk
decl_stmt|,
name|cur_latency_sclk
decl_stmt|;
name|fixed20_12
name|disp_latency
decl_stmt|,
name|disp_latency_overhead
decl_stmt|,
name|disp_drain_rate
decl_stmt|,
name|disp_drain_rate2
decl_stmt|,
name|read_return_rate
decl_stmt|;
name|fixed20_12
name|time_disp1_drop_priority
decl_stmt|;
name|int
name|c
decl_stmt|;
name|int
name|cur_size
init|=
literal|16
decl_stmt|;
comment|/* in octawords */
name|int
name|critical_point
init|=
literal|0
decl_stmt|,
name|critical_point2
decl_stmt|;
comment|/* 	uint32_t read_return_rate, time_disp1_drop_priority; */
name|int
name|stop_req
decl_stmt|,
name|max_stop_req
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|mode1
init|=
name|NULL
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|mode2
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|pixel_bytes1
init|=
literal|0
decl_stmt|;
name|uint32_t
name|pixel_bytes2
init|=
literal|0
decl_stmt|;
name|radeon_update_display_priority
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
block|{
name|mode1
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
name|pixel_bytes1
operator|=
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|0
index|]
operator|->
name|base
operator|.
name|fb
operator|->
name|bits_per_pixel
operator|/
literal|8
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
operator|)
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|enabled
condition|)
block|{
name|mode2
operator|=
operator|&
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|mode
expr_stmt|;
name|pixel_bytes2
operator|=
name|rdev
operator|->
name|mode_info
operator|.
name|crtcs
index|[
literal|1
index|]
operator|->
name|base
operator|.
name|fb
operator|->
name|bits_per_pixel
operator|/
literal|8
expr_stmt|;
block|}
block|}
name|min_mem_eff
operator|.
name|full
operator|=
name|dfixed_const_8
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* get modes */
if|if
condition|(
operator|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
operator|)
operator|&&
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|uint32_t
name|mc_init_misc_lat_timer
init|=
name|RREG32
argument_list|(
name|R300_MC_INIT_MISC_LAT_TIMER
argument_list|)
decl_stmt|;
name|mc_init_misc_lat_timer
operator|&=
operator|~
operator|(
name|R300_MC_DISP1R_INIT_LAT_MASK
operator|<<
name|R300_MC_DISP1R_INIT_LAT_SHIFT
operator|)
expr_stmt|;
name|mc_init_misc_lat_timer
operator|&=
operator|~
operator|(
name|R300_MC_DISP0R_INIT_LAT_MASK
operator|<<
name|R300_MC_DISP0R_INIT_LAT_SHIFT
operator|)
expr_stmt|;
comment|/* check crtc enables */
if|if
condition|(
name|mode2
condition|)
name|mc_init_misc_lat_timer
operator||=
operator|(
literal|1
operator|<<
name|R300_MC_DISP1R_INIT_LAT_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|mode1
condition|)
name|mc_init_misc_lat_timer
operator||=
operator|(
literal|1
operator|<<
name|R300_MC_DISP0R_INIT_LAT_SHIFT
operator|)
expr_stmt|;
name|WREG32
argument_list|(
name|R300_MC_INIT_MISC_LAT_TIMER
argument_list|,
name|mc_init_misc_lat_timer
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * determine is there is enough bw for current mode 	 */
name|sclk_ff
operator|=
name|rdev
operator|->
name|pm
operator|.
name|sclk
expr_stmt|;
name|mclk_ff
operator|=
name|rdev
operator|->
name|pm
operator|.
name|mclk
expr_stmt|;
name|temp
operator|=
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|/
literal|8
operator|)
operator|*
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
condition|?
literal|2
else|:
literal|1
operator|)
expr_stmt|;
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|mem_bw
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|mclk_ff
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
name|pix_clk
operator|.
name|full
operator|=
literal|0
expr_stmt|;
name|pix_clk2
operator|.
name|full
operator|=
literal|0
expr_stmt|;
name|peak_disp_bw
operator|.
name|full
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mode1
condition|)
block|{
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|pix_clk
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mode1
operator|->
name|clock
argument_list|)
expr_stmt|;
comment|/* convert to fixed point */
name|pix_clk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|pix_clk
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|pixel_bytes1
argument_list|)
expr_stmt|;
name|peak_disp_bw
operator|.
name|full
operator|+=
name|dfixed_mul
argument_list|(
name|pix_clk
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mode2
condition|)
block|{
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|pix_clk2
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mode2
operator|->
name|clock
argument_list|)
expr_stmt|;
comment|/* convert to fixed point */
name|pix_clk2
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|pix_clk2
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|pixel_bytes2
argument_list|)
expr_stmt|;
name|peak_disp_bw
operator|.
name|full
operator|+=
name|dfixed_mul
argument_list|(
name|pix_clk2
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
block|}
name|mem_bw
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|mem_bw
argument_list|,
name|min_mem_eff
argument_list|)
expr_stmt|;
if|if
condition|(
name|peak_disp_bw
operator|.
name|full
operator|>=
name|mem_bw
operator|.
name|full
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"You may not have enough display bandwidth for current mode\n"
literal|"If you have flickering problem, try to lower resolution, refresh rate, or color depth\n"
argument_list|)
expr_stmt|;
block|}
comment|/*  Get values from the EXT_MEM_CNTL register...converting its contents. */
name|temp
operator|=
name|RREG32
argument_list|(
name|RADEON_MEM_TIMING_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV100
operator|)
operator|||
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
condition|)
block|{
comment|/* RV100, M6, IGPs */
name|mem_trcd
operator|=
operator|(
operator|(
name|temp
operator|>>
literal|2
operator|)
operator|&
literal|0x3
operator|)
operator|+
literal|1
expr_stmt|;
name|mem_trp
operator|=
operator|(
operator|(
name|temp
operator|&
literal|0x3
operator|)
operator|)
operator|+
literal|1
expr_stmt|;
name|mem_tras
operator|=
operator|(
operator|(
name|temp
operator|&
literal|0x70
operator|)
operator|>>
literal|4
operator|)
operator|+
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R350
condition|)
block|{
comment|/* r300, r350 */
name|mem_trcd
operator|=
operator|(
name|temp
operator|&
literal|0x7
operator|)
operator|+
literal|1
expr_stmt|;
name|mem_trp
operator|=
operator|(
operator|(
name|temp
operator|>>
literal|8
operator|)
operator|&
literal|0x7
operator|)
operator|+
literal|1
expr_stmt|;
name|mem_tras
operator|=
operator|(
operator|(
name|temp
operator|>>
literal|11
operator|)
operator|&
literal|0xf
operator|)
operator|+
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV350
operator|||
name|rdev
operator|->
name|family
operator|<=
name|CHIP_RV380
condition|)
block|{
comment|/* rv3x0 */
name|mem_trcd
operator|=
operator|(
name|temp
operator|&
literal|0x7
operator|)
operator|+
literal|3
expr_stmt|;
name|mem_trp
operator|=
operator|(
operator|(
name|temp
operator|>>
literal|8
operator|)
operator|&
literal|0x7
operator|)
operator|+
literal|3
expr_stmt|;
name|mem_tras
operator|=
operator|(
operator|(
name|temp
operator|>>
literal|11
operator|)
operator|&
literal|0xf
operator|)
operator|+
literal|6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R420
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R423
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV410
condition|)
block|{
comment|/* r4xx */
name|mem_trcd
operator|=
operator|(
name|temp
operator|&
literal|0xf
operator|)
operator|+
literal|3
expr_stmt|;
if|if
condition|(
name|mem_trcd
operator|>
literal|15
condition|)
name|mem_trcd
operator|=
literal|15
expr_stmt|;
name|mem_trp
operator|=
operator|(
operator|(
name|temp
operator|>>
literal|8
operator|)
operator|&
literal|0xf
operator|)
operator|+
literal|3
expr_stmt|;
if|if
condition|(
name|mem_trp
operator|>
literal|15
condition|)
name|mem_trp
operator|=
literal|15
expr_stmt|;
name|mem_tras
operator|=
operator|(
operator|(
name|temp
operator|>>
literal|12
operator|)
operator|&
literal|0x1f
operator|)
operator|+
literal|6
expr_stmt|;
if|if
condition|(
name|mem_tras
operator|>
literal|31
condition|)
name|mem_tras
operator|=
literal|31
expr_stmt|;
block|}
else|else
block|{
comment|/* RV200, R200 */
name|mem_trcd
operator|=
operator|(
name|temp
operator|&
literal|0x7
operator|)
operator|+
literal|1
expr_stmt|;
name|mem_trp
operator|=
operator|(
operator|(
name|temp
operator|>>
literal|8
operator|)
operator|&
literal|0x7
operator|)
operator|+
literal|1
expr_stmt|;
name|mem_tras
operator|=
operator|(
operator|(
name|temp
operator|>>
literal|12
operator|)
operator|&
literal|0xf
operator|)
operator|+
literal|4
expr_stmt|;
block|}
comment|/* convert to FF */
name|trcd_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mem_trcd
argument_list|)
expr_stmt|;
name|trp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mem_trp
argument_list|)
expr_stmt|;
name|tras_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|mem_tras
argument_list|)
expr_stmt|;
comment|/* Get values from the MEM_SDRAM_MODE_REG register...converting its */
name|temp
operator|=
name|RREG32
argument_list|(
name|RADEON_MEM_SDRAM_MODE_REG
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|temp
operator|&
operator|(
literal|7
operator|<<
literal|20
operator|)
operator|)
operator|>>
literal|20
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV100
operator|)
operator|||
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
condition|)
comment|/* don't think rs400 */
name|tcas_ff
operator|=
name|memtcas_rs480_ff
index|[
name|data
index|]
expr_stmt|;
else|else
name|tcas_ff
operator|=
name|memtcas_ff
index|[
name|data
index|]
expr_stmt|;
block|}
else|else
name|tcas_ff
operator|=
name|memtcas2_ff
index|[
name|data
index|]
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS400
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
condition|)
block|{
comment|/* extra cas latency stored in bits 23-25 0-4 clocks */
name|data
operator|=
operator|(
name|temp
operator|>>
literal|23
operator|)
operator|&
literal|0x7
expr_stmt|;
if|if
condition|(
name|data
operator|<
literal|5
condition|)
name|tcas_ff
operator|.
name|full
operator|+=
name|dfixed_const
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
operator|&&
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
condition|)
block|{
comment|/* on the R300, Tcas is included in Trbs. 		 */
name|temp
operator|=
name|RREG32
argument_list|(
name|RADEON_MEM_CNTL
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|R300_MEM_NUM_CHANNELS_MASK
operator|&
name|temp
operator|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|R300_MEM_USE_CD_CH_ONLY
operator|&
name|temp
condition|)
block|{
name|temp
operator|=
name|RREG32
argument_list|(
name|R300_MC_IND_INDEX
argument_list|)
expr_stmt|;
name|temp
operator|&=
operator|~
name|R300_MC_IND_ADDR_MASK
expr_stmt|;
name|temp
operator||=
name|R300_MC_READ_CNTL_CD_mcind
expr_stmt|;
name|WREG32
argument_list|(
name|R300_MC_IND_INDEX
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|temp
operator|=
name|RREG32
argument_list|(
name|R300_MC_IND_DATA
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|R300_MEM_RBS_POSITION_C_MASK
operator|&
name|temp
operator|)
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|=
name|RREG32
argument_list|(
name|R300_MC_READ_CNTL_AB
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|R300_MEM_RBS_POSITION_A_MASK
operator|&
name|temp
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|temp
operator|=
name|RREG32
argument_list|(
name|R300_MC_READ_CNTL_AB
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|R300_MEM_RBS_POSITION_A_MASK
operator|&
name|temp
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV410
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R420
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R423
condition|)
name|trbs_ff
operator|=
name|memtrbs_r4xx
index|[
name|data
index|]
expr_stmt|;
else|else
name|trbs_ff
operator|=
name|memtrbs
index|[
name|data
index|]
expr_stmt|;
name|tcas_ff
operator|.
name|full
operator|+=
name|trbs_ff
operator|.
name|full
expr_stmt|;
block|}
name|sclk_eff_ff
operator|.
name|full
operator|=
name|sclk_ff
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|fixed20_12
name|agpmode_ff
decl_stmt|;
name|agpmode_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|radeon_agpmode
argument_list|)
expr_stmt|;
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const_666
argument_list|(
literal|16
argument_list|)
expr_stmt|;
name|sclk_eff_ff
operator|.
name|full
operator|-=
name|dfixed_mul
argument_list|(
name|agpmode_ff
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
block|}
comment|/* TODO PCIE lanes may affect this - agpmode == 16?? */
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|sclk_delay_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|250
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV100
operator|)
operator|||
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
condition|)
name|sclk_delay_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|41
argument_list|)
expr_stmt|;
else|else
name|sclk_delay_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|33
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|==
literal|128
condition|)
name|sclk_delay_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|57
argument_list|)
expr_stmt|;
else|else
name|sclk_delay_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|41
argument_list|)
expr_stmt|;
block|}
block|}
name|mc_latency_sclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|sclk_delay_ff
argument_list|,
name|sclk_eff_ff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|==
literal|32
condition|)
block|{
name|k1
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|40
argument_list|)
expr_stmt|;
name|c
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|k1
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|c
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|k1
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|40
argument_list|)
expr_stmt|;
name|c
operator|=
literal|3
expr_stmt|;
block|}
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|mc_latency_mclk
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|trcd_ff
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|mc_latency_mclk
operator|.
name|full
operator|+=
name|dfixed_mul
argument_list|(
name|tcas_ff
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|mc_latency_mclk
operator|.
name|full
operator|+=
name|dfixed_mul
argument_list|(
name|tras_ff
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
name|mc_latency_mclk
operator|.
name|full
operator|+=
name|dfixed_mul
argument_list|(
name|trp_ff
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
name|mc_latency_mclk
operator|.
name|full
operator|+=
name|k1
operator|.
name|full
expr_stmt|;
name|mc_latency_mclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|mc_latency_mclk
argument_list|,
name|mclk_ff
argument_list|)
expr_stmt|;
name|mc_latency_mclk
operator|.
name|full
operator|+=
name|dfixed_div
argument_list|(
name|temp_ff
argument_list|,
name|sclk_eff_ff
argument_list|)
expr_stmt|;
comment|/* 	  HW cursor time assuming worst case of full size colour cursor. 	*/
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
operator|(
literal|2
operator|*
operator|(
name|cur_size
operator|-
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|+
literal|1
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
name|temp_ff
operator|.
name|full
operator|+=
name|trcd_ff
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|temp_ff
operator|.
name|full
operator|<
name|tras_ff
operator|.
name|full
condition|)
name|temp_ff
operator|.
name|full
operator|=
name|tras_ff
operator|.
name|full
expr_stmt|;
name|cur_latency_mclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|temp_ff
argument_list|,
name|mclk_ff
argument_list|)
expr_stmt|;
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|cur_size
argument_list|)
expr_stmt|;
name|cur_latency_sclk
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|temp_ff
argument_list|,
name|sclk_eff_ff
argument_list|)
expr_stmt|;
comment|/* 	  Find the total latency for the display data. 	*/
name|disp_latency_overhead
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|disp_latency_overhead
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|disp_latency_overhead
argument_list|,
name|sclk_ff
argument_list|)
expr_stmt|;
name|mc_latency_mclk
operator|.
name|full
operator|+=
name|disp_latency_overhead
operator|.
name|full
operator|+
name|cur_latency_mclk
operator|.
name|full
expr_stmt|;
name|mc_latency_sclk
operator|.
name|full
operator|+=
name|disp_latency_overhead
operator|.
name|full
operator|+
name|cur_latency_sclk
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|mc_latency_mclk
operator|.
name|full
operator|>
name|mc_latency_sclk
operator|.
name|full
condition|)
name|disp_latency
operator|.
name|full
operator|=
name|mc_latency_mclk
operator|.
name|full
expr_stmt|;
else|else
name|disp_latency
operator|.
name|full
operator|=
name|mc_latency_sclk
operator|.
name|full
expr_stmt|;
comment|/* setup Max GRPH_STOP_REQ default value */
if|if
condition|(
name|ASIC_IS_RV100
argument_list|(
name|rdev
argument_list|)
condition|)
name|max_stop_req
operator|=
literal|0x5c
expr_stmt|;
else|else
name|max_stop_req
operator|=
literal|0x7c
expr_stmt|;
if|if
condition|(
name|mode1
condition|)
block|{
comment|/*  CRTC1 		    Set GRPH_BUFFER_CNTL register using h/w defined optimal values. 		    GRPH_STOP_REQ<= MIN[ 0x7C, (CRTC_H_DISP + 1) * (bit depth) / 0x10 ] 		*/
name|stop_req
operator|=
name|mode1
operator|->
name|hdisplay
operator|*
name|pixel_bytes1
operator|/
literal|16
expr_stmt|;
if|if
condition|(
name|stop_req
operator|>
name|max_stop_req
condition|)
name|stop_req
operator|=
name|max_stop_req
expr_stmt|;
comment|/* 		  Find the drain rate of the display buffer. 		*/
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
operator|(
literal|16
operator|/
name|pixel_bytes1
operator|)
argument_list|)
expr_stmt|;
name|disp_drain_rate
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|pix_clk
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
comment|/* 		  Find the critical point of the display buffer. 		*/
name|crit_point_ff
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|disp_drain_rate
argument_list|,
name|disp_latency
argument_list|)
expr_stmt|;
name|crit_point_ff
operator|.
name|full
operator|+=
name|dfixed_const_half
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|critical_point
operator|=
name|dfixed_trunc
argument_list|(
name|crit_point_ff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
condition|)
block|{
name|critical_point
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 		  The critical point should never be above max_stop_req-4.  Setting 		  GRPH_CRITICAL_CNTL = 0 will thus force high priority all the time. 		*/
if|if
condition|(
name|max_stop_req
operator|-
name|critical_point
operator|<
literal|4
condition|)
name|critical_point
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|critical_point
operator|==
literal|0
operator|&&
name|mode2
operator|&&
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
condition|)
block|{
comment|/* some R300 cards have problem with this set to 0, when CRTC2 is enabled.*/
name|critical_point
operator|=
literal|0x10
expr_stmt|;
block|}
name|temp
operator|=
name|RREG32
argument_list|(
name|RADEON_GRPH_BUFFER_CNTL
argument_list|)
expr_stmt|;
name|temp
operator|&=
operator|~
operator|(
name|RADEON_GRPH_STOP_REQ_MASK
operator|)
expr_stmt|;
name|temp
operator||=
operator|(
name|stop_req
operator|<<
name|RADEON_GRPH_STOP_REQ_SHIFT
operator|)
expr_stmt|;
name|temp
operator|&=
operator|~
operator|(
name|RADEON_GRPH_START_REQ_MASK
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R350
operator|)
operator|&&
operator|(
name|stop_req
operator|>
literal|0x15
operator|)
condition|)
block|{
name|stop_req
operator|-=
literal|0x10
expr_stmt|;
block|}
name|temp
operator||=
operator|(
name|stop_req
operator|<<
name|RADEON_GRPH_START_REQ_SHIFT
operator|)
expr_stmt|;
name|temp
operator||=
name|RADEON_GRPH_BUFFER_SIZE
expr_stmt|;
name|temp
operator|&=
operator|~
operator|(
name|RADEON_GRPH_CRITICAL_CNTL
operator||
name|RADEON_GRPH_CRITICAL_AT_SOF
operator||
name|RADEON_GRPH_STOP_CNTL
operator|)
expr_stmt|;
comment|/* 		  Write the result into the register. 		*/
name|WREG32
argument_list|(
name|RADEON_GRPH_BUFFER_CNTL
argument_list|,
operator|(
operator|(
name|temp
operator|&
operator|~
name|RADEON_GRPH_CRITICAL_POINT_MASK
operator|)
operator||
operator|(
name|critical_point
operator|<<
name|RADEON_GRPH_CRITICAL_POINT_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if ((rdev->family == CHIP_RS400) || 		    (rdev->family == CHIP_RS480)) {
comment|/* attempt to program RS400 disp regs correctly ??? */
block|temp = RREG32(RS400_DISP1_REG_CNTL); 			temp&= ~(RS400_DISP1_START_REQ_LEVEL_MASK | 				  RS400_DISP1_STOP_REQ_LEVEL_MASK); 			WREG32(RS400_DISP1_REQ_CNTL1, (temp | 						       (critical_point<< RS400_DISP1_START_REQ_LEVEL_SHIFT) | 						       (critical_point<< RS400_DISP1_STOP_REQ_LEVEL_SHIFT))); 			temp = RREG32(RS400_DMIF_MEM_CNTL1); 			temp&= ~(RS400_DISP1_CRITICAL_POINT_START_MASK | 				  RS400_DISP1_CRITICAL_POINT_STOP_MASK); 			WREG32(RS400_DMIF_MEM_CNTL1, (temp | 						      (critical_point<< RS400_DISP1_CRITICAL_POINT_START_SHIFT) | 						      (critical_point<< RS400_DISP1_CRITICAL_POINT_STOP_SHIFT))); 		}
endif|#
directive|endif
name|DRM_DEBUG_KMS
argument_list|(
literal|"GRPH_BUFFER_CNTL from to %x\n"
argument_list|,
comment|/* 	  (unsigned int)info->SavedReg->grph_buffer_cntl, */
operator|(
name|unsigned
name|int
operator|)
name|RREG32
argument_list|(
name|RADEON_GRPH_BUFFER_CNTL
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mode2
condition|)
block|{
name|u32
name|grph2_cntl
decl_stmt|;
name|stop_req
operator|=
name|mode2
operator|->
name|hdisplay
operator|*
name|pixel_bytes2
operator|/
literal|16
expr_stmt|;
if|if
condition|(
name|stop_req
operator|>
name|max_stop_req
condition|)
name|stop_req
operator|=
name|max_stop_req
expr_stmt|;
comment|/* 		  Find the drain rate of the display buffer. 		*/
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
operator|(
literal|16
operator|/
name|pixel_bytes2
operator|)
argument_list|)
expr_stmt|;
name|disp_drain_rate2
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|pix_clk2
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
name|grph2_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_GRPH2_BUFFER_CNTL
argument_list|)
expr_stmt|;
name|grph2_cntl
operator|&=
operator|~
operator|(
name|RADEON_GRPH_STOP_REQ_MASK
operator|)
expr_stmt|;
name|grph2_cntl
operator||=
operator|(
name|stop_req
operator|<<
name|RADEON_GRPH_STOP_REQ_SHIFT
operator|)
expr_stmt|;
name|grph2_cntl
operator|&=
operator|~
operator|(
name|RADEON_GRPH_START_REQ_MASK
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R350
operator|)
operator|&&
operator|(
name|stop_req
operator|>
literal|0x15
operator|)
condition|)
block|{
name|stop_req
operator|-=
literal|0x10
expr_stmt|;
block|}
name|grph2_cntl
operator||=
operator|(
name|stop_req
operator|<<
name|RADEON_GRPH_START_REQ_SHIFT
operator|)
expr_stmt|;
name|grph2_cntl
operator||=
name|RADEON_GRPH_BUFFER_SIZE
expr_stmt|;
name|grph2_cntl
operator|&=
operator|~
operator|(
name|RADEON_GRPH_CRITICAL_CNTL
operator||
name|RADEON_GRPH_CRITICAL_AT_SOF
operator||
name|RADEON_GRPH_STOP_CNTL
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS100
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS200
operator|)
condition|)
name|critical_point2
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|temp
operator|=
operator|(
name|rdev
operator|->
name|mc
operator|.
name|vram_width
operator|*
name|rdev
operator|->
name|mc
operator|.
name|vram_is_ddr
operator|+
literal|1
operator|)
operator|/
literal|128
expr_stmt|;
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_const
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|temp_ff
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|mclk_ff
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
if|if
condition|(
name|sclk_ff
operator|.
name|full
operator|<
name|temp_ff
operator|.
name|full
condition|)
name|temp_ff
operator|.
name|full
operator|=
name|sclk_ff
operator|.
name|full
expr_stmt|;
name|read_return_rate
operator|.
name|full
operator|=
name|temp_ff
operator|.
name|full
expr_stmt|;
if|if
condition|(
name|mode1
condition|)
block|{
name|temp_ff
operator|.
name|full
operator|=
name|read_return_rate
operator|.
name|full
operator|-
name|disp_drain_rate
operator|.
name|full
expr_stmt|;
name|time_disp1_drop_priority
operator|.
name|full
operator|=
name|dfixed_div
argument_list|(
name|crit_point_ff
argument_list|,
name|temp_ff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|time_disp1_drop_priority
operator|.
name|full
operator|=
literal|0
expr_stmt|;
block|}
name|crit_point_ff
operator|.
name|full
operator|=
name|disp_latency
operator|.
name|full
operator|+
name|time_disp1_drop_priority
operator|.
name|full
operator|+
name|disp_latency
operator|.
name|full
expr_stmt|;
name|crit_point_ff
operator|.
name|full
operator|=
name|dfixed_mul
argument_list|(
name|crit_point_ff
argument_list|,
name|disp_drain_rate2
argument_list|)
expr_stmt|;
name|crit_point_ff
operator|.
name|full
operator|+=
name|dfixed_const_half
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|critical_point2
operator|=
name|dfixed_trunc
argument_list|(
name|crit_point_ff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|disp_priority
operator|==
literal|2
condition|)
block|{
name|critical_point2
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|max_stop_req
operator|-
name|critical_point2
operator|<
literal|4
condition|)
name|critical_point2
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|critical_point2
operator|==
literal|0
operator|&&
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
condition|)
block|{
comment|/* some R300 cards have problem with this set to 0 */
name|critical_point2
operator|=
literal|0x10
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_GRPH2_BUFFER_CNTL
argument_list|,
operator|(
operator|(
name|grph2_cntl
operator|&
operator|~
name|RADEON_GRPH_CRITICAL_POINT_MASK
operator|)
operator||
operator|(
name|critical_point2
operator|<<
name|RADEON_GRPH_CRITICAL_POINT_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS400
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
operator|)
condition|)
block|{
if|#
directive|if
literal|0
comment|/* attempt to program RS400 disp2 regs correctly ??? */
block|temp = RREG32(RS400_DISP2_REQ_CNTL1); 			temp&= ~(RS400_DISP2_START_REQ_LEVEL_MASK | 				  RS400_DISP2_STOP_REQ_LEVEL_MASK); 			WREG32(RS400_DISP2_REQ_CNTL1, (temp | 						       (critical_point2<< RS400_DISP1_START_REQ_LEVEL_SHIFT) | 						       (critical_point2<< RS400_DISP1_STOP_REQ_LEVEL_SHIFT))); 			temp = RREG32(RS400_DISP2_REQ_CNTL2); 			temp&= ~(RS400_DISP2_CRITICAL_POINT_START_MASK | 				  RS400_DISP2_CRITICAL_POINT_STOP_MASK); 			WREG32(RS400_DISP2_REQ_CNTL2, (temp | 						       (critical_point2<< RS400_DISP2_CRITICAL_POINT_START_SHIFT) | 						       (critical_point2<< RS400_DISP2_CRITICAL_POINT_STOP_SHIFT)));
endif|#
directive|endif
name|WREG32
argument_list|(
name|RS400_DISP2_REQ_CNTL1
argument_list|,
literal|0x105DC1CC
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RS400_DISP2_REQ_CNTL2
argument_list|,
literal|0x2749D000
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RS400_DMIF_MEM_CNTL1
argument_list|,
literal|0x29CA71DC
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RS400_DISP1_REQ_CNTL1
argument_list|,
literal|0x28FBC3AC
argument_list|)
expr_stmt|;
block|}
name|DRM_DEBUG_KMS
argument_list|(
literal|"GRPH2_BUFFER_CNTL from to %x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|RREG32
argument_list|(
name|RADEON_GRPH2_BUFFER_CNTL
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|r100_ring_test
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|uint32_t
name|scratch
decl_stmt|;
name|uint32_t
name|tmp
init|=
literal|0
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|int
name|r
decl_stmt|;
name|r
operator|=
name|radeon_scratch_get
argument_list|(
name|rdev
argument_list|,
operator|&
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to get scratch reg (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|WREG32
argument_list|(
name|scratch
argument_list|,
literal|0xCAFEDEAD
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ring_lock
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: cp failed to lock ring (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|scratch
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|scratch
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
literal|0xDEADBEEF
argument_list|)
expr_stmt|;
name|radeon_ring_unlock_commit
argument_list|(
name|rdev
argument_list|,
name|ring
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0xDEADBEEF
condition|)
block|{
break|break;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"ring test succeeded in %d usecs\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: ring test failed (scratch(0x%04X)=0x%08X)\n"
argument_list|,
name|scratch
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|r
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|scratch
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|r100_ring_ib_execute
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ib
modifier|*
name|ib
parameter_list|)
block|{
name|struct
name|radeon_ring
modifier|*
name|ring
init|=
operator|&
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
decl_stmt|;
if|if
condition|(
name|ring
operator|->
name|rptr_save_reg
condition|)
block|{
name|u32
name|next_rptr
init|=
name|ring
operator|->
name|wptr
operator|+
literal|2
operator|+
literal|3
decl_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|ring
operator|->
name|rptr_save_reg
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|next_rptr
argument_list|)
expr_stmt|;
block|}
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|PACKET0
argument_list|(
name|RADEON_CP_IB_BASE
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ib
operator|->
name|gpu_addr
argument_list|)
expr_stmt|;
name|radeon_ring_write
argument_list|(
name|ring
argument_list|,
name|ib
operator|->
name|length_dw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r100_ib_test
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|radeon_ib
name|ib
decl_stmt|;
name|uint32_t
name|scratch
decl_stmt|;
name|uint32_t
name|tmp
init|=
literal|0
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|int
name|r
decl_stmt|;
name|r
operator|=
name|radeon_scratch_get
argument_list|(
name|rdev
argument_list|,
operator|&
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to get scratch reg (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|WREG32
argument_list|(
name|scratch
argument_list|,
literal|0xCAFEDEAD
argument_list|)
expr_stmt|;
name|r
operator|=
name|radeon_ib_get
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|,
operator|&
name|ib
argument_list|,
name|NULL
argument_list|,
literal|256
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to get ib (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
goto|goto
name|free_scratch
goto|;
block|}
name|ib
operator|.
name|ptr
index|[
literal|0
index|]
operator|=
name|PACKET0
argument_list|(
name|scratch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|1
index|]
operator|=
literal|0xDEADBEEF
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|2
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|3
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|4
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|5
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|6
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
operator|.
name|ptr
index|[
literal|7
index|]
operator|=
name|PACKET2
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ib
operator|.
name|length_dw
operator|=
literal|8
expr_stmt|;
name|r
operator|=
name|radeon_ib_schedule
argument_list|(
name|rdev
argument_list|,
operator|&
name|ib
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: failed to schedule ib (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
goto|goto
name|free_ib
goto|;
block|}
name|r
operator|=
name|radeon_fence_wait
argument_list|(
name|ib
operator|.
name|fence
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: fence wait failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
goto|goto
name|free_ib
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|RREG32
argument_list|(
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0xDEADBEEF
condition|)
block|{
break|break;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
name|rdev
operator|->
name|usec_timeout
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"ib test succeeded in %u usecs\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_ERROR
argument_list|(
literal|"radeon: ib test failed (scratch(0x%04X)=0x%08X)\n"
argument_list|,
name|scratch
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|r
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
name|free_ib
label|:
name|radeon_ib_free
argument_list|(
name|rdev
argument_list|,
operator|&
name|ib
argument_list|)
expr_stmt|;
name|free_scratch
label|:
name|radeon_scratch_free
argument_list|(
name|rdev
argument_list|,
name|scratch
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|r100_mc_stop
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|r100_mc_save
modifier|*
name|save
parameter_list|)
block|{
comment|/* Shutdown CP we shouldn't need to do that but better be safe than 	 * sorry 	 */
name|rdev
operator|->
name|ring
index|[
name|RADEON_RING_TYPE_GFX_INDEX
index|]
operator|.
name|ready
operator|=
name|false
expr_stmt|;
name|WREG32
argument_list|(
name|R_000740_CP_CSQ_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Save few CRTC registers */
name|save
operator|->
name|GENMO_WT
operator|=
name|RREG8
argument_list|(
name|R_0003C2_GENMO_WT
argument_list|)
expr_stmt|;
name|save
operator|->
name|CRTC_EXT_CNTL
operator|=
name|RREG32
argument_list|(
name|R_000054_CRTC_EXT_CNTL
argument_list|)
expr_stmt|;
name|save
operator|->
name|CRTC_GEN_CNTL
operator|=
name|RREG32
argument_list|(
name|R_000050_CRTC_GEN_CNTL
argument_list|)
expr_stmt|;
name|save
operator|->
name|CUR_OFFSET
operator|=
name|RREG32
argument_list|(
name|R_000260_CUR_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
operator|)
condition|)
block|{
name|save
operator|->
name|CRTC2_GEN_CNTL
operator|=
name|RREG32
argument_list|(
name|R_0003F8_CRTC2_GEN_CNTL
argument_list|)
expr_stmt|;
name|save
operator|->
name|CUR2_OFFSET
operator|=
name|RREG32
argument_list|(
name|R_000360_CUR2_OFFSET
argument_list|)
expr_stmt|;
block|}
comment|/* Disable VGA aperture access */
name|WREG8
argument_list|(
name|R_0003C2_GENMO_WT
argument_list|,
name|C_0003C2_VGA_RAM_EN
operator|&
name|save
operator|->
name|GENMO_WT
argument_list|)
expr_stmt|;
comment|/* Disable cursor, overlay, crtc */
name|WREG32
argument_list|(
name|R_000260_CUR_OFFSET
argument_list|,
name|save
operator|->
name|CUR_OFFSET
operator||
name|S_000260_CUR_LOCK
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000054_CRTC_EXT_CNTL
argument_list|,
name|save
operator|->
name|CRTC_EXT_CNTL
operator||
name|S_000054_CRTC_DISPLAY_DIS
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000050_CRTC_GEN_CNTL
argument_list|,
operator|(
name|C_000050_CRTC_CUR_EN
operator|&
name|save
operator|->
name|CRTC_GEN_CNTL
operator|)
operator||
name|S_000050_CRTC_DISP_REQ_EN_B
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000420_OV0_SCALE_CNTL
argument_list|,
name|C_000420_OV0_OVERLAY_EN
operator|&
name|RREG32
argument_list|(
name|R_000420_OV0_SCALE_CNTL
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000260_CUR_OFFSET
argument_list|,
name|C_000260_CUR_LOCK
operator|&
name|save
operator|->
name|CUR_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
operator|)
condition|)
block|{
name|WREG32
argument_list|(
name|R_000360_CUR2_OFFSET
argument_list|,
name|save
operator|->
name|CUR2_OFFSET
operator||
name|S_000360_CUR2_LOCK
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_0003F8_CRTC2_GEN_CNTL
argument_list|,
operator|(
name|C_0003F8_CRTC2_CUR_EN
operator|&
name|save
operator|->
name|CRTC2_GEN_CNTL
operator|)
operator||
name|S_0003F8_CRTC2_DISPLAY_DIS
argument_list|(
literal|1
argument_list|)
operator||
name|S_0003F8_CRTC2_DISP_REQ_EN_B
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000360_CUR2_OFFSET
argument_list|,
name|C_000360_CUR2_LOCK
operator|&
name|save
operator|->
name|CUR2_OFFSET
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|r100_mc_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|r100_mc_save
modifier|*
name|save
parameter_list|)
block|{
comment|/* Update base address for crtc */
name|WREG32
argument_list|(
name|R_00023C_DISPLAY_BASE_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
operator|)
condition|)
block|{
name|WREG32
argument_list|(
name|R_00033C_CRTC2_DISPLAY_BASE_ADDR
argument_list|,
name|rdev
operator|->
name|mc
operator|.
name|vram_start
argument_list|)
expr_stmt|;
block|}
comment|/* Restore CRTC registers */
name|WREG8
argument_list|(
name|R_0003C2_GENMO_WT
argument_list|,
name|save
operator|->
name|GENMO_WT
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000054_CRTC_EXT_CNTL
argument_list|,
name|save
operator|->
name|CRTC_EXT_CNTL
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000050_CRTC_GEN_CNTL
argument_list|,
name|save
operator|->
name|CRTC_GEN_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
operator|)
condition|)
block|{
name|WREG32
argument_list|(
name|R_0003F8_CRTC2_GEN_CNTL
argument_list|,
name|save
operator|->
name|CRTC2_GEN_CNTL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|r100_vga_render_disable
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RREG8
argument_list|(
name|R_0003C2_GENMO_WT
argument_list|)
expr_stmt|;
name|WREG8
argument_list|(
name|R_0003C2_GENMO_WT
argument_list|,
name|C_0003C2_VGA_RAM_EN
operator|&
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r100_debugfs
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|r
operator|=
name|r100_debugfs_mc_info_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Failed to create r100_mc debugfs file.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r100_mc_program
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|r100_mc_save
name|save
decl_stmt|;
comment|/* Stops all mc clients */
name|r100_mc_stop
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|WREG32
argument_list|(
name|R_00014C_MC_AGP_LOCATION
argument_list|,
name|S_00014C_MC_AGP_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_start
operator|>>
literal|16
argument_list|)
operator||
name|S_00014C_MC_AGP_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|gtt_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000170_AGP_BASE
argument_list|,
name|lower_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|agp_base
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>
name|CHIP_RV200
condition|)
name|WREG32
argument_list|(
name|R_00015C_AGP_BASE_2
argument_list|,
name|upper_32_bits
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|agp_base
argument_list|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|R_00014C_MC_AGP_LOCATION
argument_list|,
literal|0x0FFFFFFF
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R_000170_AGP_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>
name|CHIP_RV200
condition|)
name|WREG32
argument_list|(
name|R_00015C_AGP_BASE_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Wait for mc idle */
if|if
condition|(
name|r100_mc_wait_for_idle
argument_list|(
name|rdev
argument_list|)
condition|)
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Wait for MC idle timeout.\n"
argument_list|)
expr_stmt|;
comment|/* Program MC, should be a 32bits limited address space */
name|WREG32
argument_list|(
name|R_000148_MC_FB_LOCATION
argument_list|,
name|S_000148_MC_FB_START
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_start
operator|>>
literal|16
argument_list|)
operator||
name|S_000148_MC_FB_TOP
argument_list|(
name|rdev
operator|->
name|mc
operator|.
name|vram_end
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|r100_mc_resume
argument_list|(
name|rdev
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r100_clock_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
name|radeon_dynclks
operator|!=
operator|-
literal|1
operator|&&
name|radeon_dynclks
condition|)
name|radeon_legacy_set_clock_gating
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* We need to force on some of the block */
name|tmp
operator|=
name|RREG32_PLL
argument_list|(
name|R_00000D_SCLK_CNTL
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|S_00000D_FORCE_CP
argument_list|(
literal|1
argument_list|)
operator||
name|S_00000D_FORCE_VIP
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV250
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV280
operator|)
condition|)
name|tmp
operator||=
name|S_00000D_FORCE_DISP1
argument_list|(
literal|1
argument_list|)
operator||
name|S_00000D_FORCE_DISP2
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|R_00000D_SCLK_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|r100_startup
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* set common regs */
name|r100_set_common_regs
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* program mc */
name|r100_mc_program
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock */
name|r100_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize GART (initialize after TTM so we can allocate 	 * memory through TTM but finalize after TTM) */
name|r100_enable_bm
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
block|{
name|r
operator|=
name|r100_pci_gart_enable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
comment|/* allocate wb buffer */
name|r
operator|=
name|radeon_wb_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_fence_driver_start_ring
argument_list|(
name|rdev
argument_list|,
name|RADEON_RING_TYPE_GFX_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP fences (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
comment|/* Enable IRQ */
name|r100_irq_set
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|config
operator|.
name|r100
operator|.
name|hdp_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
comment|/* 1M ring buffer */
name|r
operator|=
name|r100_cp_init
argument_list|(
name|rdev
argument_list|,
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"failed initializing CP (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
name|r
operator|=
name|radeon_ib_pool_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"IB initialization failed (%d).\n"
argument_list|,
name|r
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r100_resume
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Make sur GART are not working */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
name|r100_pci_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Resume clock before doing reset */
name|r100_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* post */
name|radeon_combios_asic_init
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* Resume clock after posting */
name|r100_clock_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|r100_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|r100_suspend
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r100_cp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_irq_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
name|r100_pci_gart_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r100_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_gem_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
name|r100_pci_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_agp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_fence_driver_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_bo_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_atombios_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|r100_cp_fini_microcode
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rdev
operator|->
name|bios
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|bios
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Due to how kexec works, it can leave the hw fully initialised when it  * boots the new kernel. However doing our init sequence with the CP and  * WB stuff setup causes GPU hangs on the RN50 at least. So at startup  * do some quick sanity checks and restore sane values to avoid this  * problem.  */
end_comment

begin_function
name|void
name|r100_restore_sanity
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_CSQ_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_CP_CSQ_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_SCRATCH_UMSK
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
block|{
name|WREG32
argument_list|(
name|RADEON_SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|r100_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
comment|/* Register debugfs file specific to this group of asics */
name|r100_debugfs
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Disable VGA */
name|r100_vga_render_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize scratch registers */
name|radeon_scratch_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize surface registers */
name|radeon_surface_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* sanity check some register to avoid hangs like after kexec */
name|r100_restore_sanity
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* TODO: disable VGA need to use VGA request */
comment|/* BIOS*/
if|if
condition|(
operator|!
name|radeon_get_bios
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Expecting combios for RS400/RS480 GPU\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
name|r
operator|=
name|radeon_combios_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
comment|/* Reset gpu before posting otherwise ATOM will enter infinite loop */
if|if
condition|(
name|radeon_asic_reset
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|dev_warn
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n"
argument_list|,
name|RREG32
argument_list|(
name|R_000E40_RBBM_STATUS
argument_list|)
argument_list|,
name|RREG32
argument_list|(
name|R_0007C0_CP_STAT
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* check if cards are posted or not */
if|if
condition|(
name|radeon_boot_test_post_card
argument_list|(
name|rdev
argument_list|)
operator|==
name|false
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Set asic errata */
name|r100_errata
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Initialize clocks */
name|radeon_get_clock_info
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|)
expr_stmt|;
comment|/* initialize AGP */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|r
operator|=
name|radeon_agp_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|radeon_agp_disable
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* initialize VRAM */
name|r100_mc_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
comment|/* Fence driver */
name|r
operator|=
name|radeon_fence_driver_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|r
operator|=
name|radeon_irq_kms_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
comment|/* Memory manager */
name|r
operator|=
name|radeon_bo_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
block|{
name|r
operator|=
name|r100_pci_gart_init
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
block|}
name|r100_set_safe_registers
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|true
expr_stmt|;
name|r
operator|=
name|r100_startup
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
comment|/* Somethings want wront with the accel init stop accel */
name|dev_err
argument_list|(
name|rdev
operator|->
name|dev
argument_list|,
literal|"Disabling GPU acceleration\n"
argument_list|)
expr_stmt|;
name|r100_cp_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_wb_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_ib_pool_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|radeon_irq_kms_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_PCI
condition|)
name|r100_pci_gart_fini
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|accel_working
operator|=
name|false
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|uint32_t
name|r100_mm_rreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|bool
name|always_indirect
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|<
name|rdev
operator|->
name|rmmio_size
operator|&&
operator|!
name|always_indirect
condition|)
return|return
name|bus_read_4
argument_list|(
name|rdev
operator|->
name|rmmio
argument_list|,
name|reg
argument_list|)
return|;
else|else
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
name|uint32_t
name|ret
decl_stmt|;
name|DRM_SPINLOCK_IRQSAVE
argument_list|(
operator|&
name|rdev
operator|->
name|mmio_idx_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|bus_write_4
argument_list|(
name|rdev
operator|->
name|rmmio
argument_list|,
name|RADEON_MM_INDEX
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|bus_read_4
argument_list|(
name|rdev
operator|->
name|rmmio
argument_list|,
name|RADEON_MM_DATA
argument_list|)
expr_stmt|;
name|DRM_SPINUNLOCK_IRQRESTORE
argument_list|(
operator|&
name|rdev
operator|->
name|mmio_idx_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
end_function

begin_function
name|void
name|r100_mm_wreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|v
parameter_list|,
name|bool
name|always_indirect
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|<
name|rdev
operator|->
name|rmmio_size
operator|&&
operator|!
name|always_indirect
condition|)
name|bus_write_4
argument_list|(
name|rdev
operator|->
name|rmmio
argument_list|,
name|reg
argument_list|,
name|v
argument_list|)
expr_stmt|;
else|else
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
name|DRM_SPINLOCK_IRQSAVE
argument_list|(
operator|&
name|rdev
operator|->
name|mmio_idx_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|bus_write_4
argument_list|(
name|rdev
operator|->
name|rmmio
argument_list|,
name|RADEON_MM_INDEX
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|bus_write_4
argument_list|(
name|rdev
operator|->
name|rmmio
argument_list|,
name|RADEON_MM_DATA
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|DRM_SPINUNLOCK_IRQRESTORE
argument_list|(
operator|&
name|rdev
operator|->
name|mmio_idx_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|u32
name|r100_io_rreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|reg
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|<
name|rdev
operator|->
name|rio_mem_size
condition|)
return|return
name|bus_read_4
argument_list|(
name|rdev
operator|->
name|rio_mem
argument_list|,
name|reg
argument_list|)
return|;
else|else
block|{
comment|/* XXX No locking? -- dumbbell@ */
name|bus_write_4
argument_list|(
name|rdev
operator|->
name|rio_mem
argument_list|,
name|RADEON_MM_INDEX
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|bus_read_4
argument_list|(
name|rdev
operator|->
name|rio_mem
argument_list|,
name|RADEON_MM_DATA
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|void
name|r100_io_wreg
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u32
name|v
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|<
name|rdev
operator|->
name|rio_mem_size
condition|)
name|bus_write_4
argument_list|(
name|rdev
operator|->
name|rio_mem
argument_list|,
name|reg
argument_list|,
name|v
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* XXX No locking? -- dumbbell@ */
name|bus_write_4
argument_list|(
name|rdev
operator|->
name|rio_mem
argument_list|,
name|RADEON_MM_INDEX
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|bus_write_4
argument_list|(
name|rdev
operator|->
name|rio_mem
argument_list|,
name|RADEON_MM_DATA
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


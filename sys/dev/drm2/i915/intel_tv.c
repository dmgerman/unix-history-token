begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright Â© 2006-2008 Intel Corporation  *   Jesse Barnes<jesse.barnes@intel.com>  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Eric Anholt<eric@anholt.net>  *  */
end_comment

begin_comment
comment|/** @file  * Integrated TV-out support for the 915GM and 945GM.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_edid.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/i915_drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/i915_drv.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/intel_drv.h>
end_include

begin_enum
enum|enum
name|tv_margin
block|{
name|TV_MARGIN_LEFT
block|,
name|TV_MARGIN_TOP
block|,
name|TV_MARGIN_RIGHT
block|,
name|TV_MARGIN_BOTTOM
block|}
enum|;
end_enum

begin_comment
comment|/** Private structure for the integrated TV support */
end_comment

begin_struct
struct|struct
name|intel_tv
block|{
name|struct
name|intel_encoder
name|base
decl_stmt|;
name|int
name|type
decl_stmt|;
specifier|const
name|char
modifier|*
name|tv_format
decl_stmt|;
name|int
name|margin
index|[
literal|4
index|]
decl_stmt|;
name|u32
name|save_TV_H_CTL_1
decl_stmt|;
name|u32
name|save_TV_H_CTL_2
decl_stmt|;
name|u32
name|save_TV_H_CTL_3
decl_stmt|;
name|u32
name|save_TV_V_CTL_1
decl_stmt|;
name|u32
name|save_TV_V_CTL_2
decl_stmt|;
name|u32
name|save_TV_V_CTL_3
decl_stmt|;
name|u32
name|save_TV_V_CTL_4
decl_stmt|;
name|u32
name|save_TV_V_CTL_5
decl_stmt|;
name|u32
name|save_TV_V_CTL_6
decl_stmt|;
name|u32
name|save_TV_V_CTL_7
decl_stmt|;
name|u32
name|save_TV_SC_CTL_1
decl_stmt|,
name|save_TV_SC_CTL_2
decl_stmt|,
name|save_TV_SC_CTL_3
decl_stmt|;
name|u32
name|save_TV_CSC_Y
decl_stmt|;
name|u32
name|save_TV_CSC_Y2
decl_stmt|;
name|u32
name|save_TV_CSC_U
decl_stmt|;
name|u32
name|save_TV_CSC_U2
decl_stmt|;
name|u32
name|save_TV_CSC_V
decl_stmt|;
name|u32
name|save_TV_CSC_V2
decl_stmt|;
name|u32
name|save_TV_CLR_KNOBS
decl_stmt|;
name|u32
name|save_TV_CLR_LEVEL
decl_stmt|;
name|u32
name|save_TV_WIN_POS
decl_stmt|;
name|u32
name|save_TV_WIN_SIZE
decl_stmt|;
name|u32
name|save_TV_FILTER_CTL_1
decl_stmt|;
name|u32
name|save_TV_FILTER_CTL_2
decl_stmt|;
name|u32
name|save_TV_FILTER_CTL_3
decl_stmt|;
name|u32
name|save_TV_H_LUMA
index|[
literal|60
index|]
decl_stmt|;
name|u32
name|save_TV_H_CHROMA
index|[
literal|60
index|]
decl_stmt|;
name|u32
name|save_TV_V_LUMA
index|[
literal|43
index|]
decl_stmt|;
name|u32
name|save_TV_V_CHROMA
index|[
literal|43
index|]
decl_stmt|;
name|u32
name|save_TV_DAC
decl_stmt|;
name|u32
name|save_TV_CTL
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|video_levels
block|{
name|int
name|blank
decl_stmt|,
name|black
decl_stmt|,
name|burst
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|color_conversion
block|{
name|u16
name|ry
decl_stmt|,
name|gy
decl_stmt|,
name|by
decl_stmt|,
name|ay
decl_stmt|;
name|u16
name|ru
decl_stmt|,
name|gu
decl_stmt|,
name|bu
decl_stmt|,
name|au
decl_stmt|;
name|u16
name|rv
decl_stmt|,
name|gv
decl_stmt|,
name|bv
decl_stmt|,
name|av
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|u32
name|filter_table
index|[]
init|=
block|{
literal|0xB1403000
block|,
literal|0x2E203500
block|,
literal|0x35002E20
block|,
literal|0x3000B140
block|,
literal|0x35A0B160
block|,
literal|0x2DC02E80
block|,
literal|0xB1403480
block|,
literal|0xB1603000
block|,
literal|0x2EA03640
block|,
literal|0x34002D80
block|,
literal|0x3000B120
block|,
literal|0x36E0B160
block|,
literal|0x2D202EF0
block|,
literal|0xB1203380
block|,
literal|0xB1603000
block|,
literal|0x2F303780
block|,
literal|0x33002CC0
block|,
literal|0x3000B100
block|,
literal|0x3820B160
block|,
literal|0x2C802F50
block|,
literal|0xB10032A0
block|,
literal|0xB1603000
block|,
literal|0x2F9038C0
block|,
literal|0x32202C20
block|,
literal|0x3000B0E0
block|,
literal|0x3980B160
block|,
literal|0x2BC02FC0
block|,
literal|0xB0E031C0
block|,
literal|0xB1603000
block|,
literal|0x2FF03A20
block|,
literal|0x31602B60
block|,
literal|0xB020B0C0
block|,
literal|0x3AE0B160
block|,
literal|0x2B001810
block|,
literal|0xB0C03120
block|,
literal|0xB140B020
block|,
literal|0x18283BA0
block|,
literal|0x30C02A80
block|,
literal|0xB020B0A0
block|,
literal|0x3C60B140
block|,
literal|0x2A201838
block|,
literal|0xB0A03080
block|,
literal|0xB120B020
block|,
literal|0x18383D20
block|,
literal|0x304029C0
block|,
literal|0xB040B080
block|,
literal|0x3DE0B100
block|,
literal|0x29601848
block|,
literal|0xB0803000
block|,
literal|0xB100B040
block|,
literal|0x18483EC0
block|,
literal|0xB0402900
block|,
literal|0xB040B060
block|,
literal|0x3F80B0C0
block|,
literal|0x28801858
block|,
literal|0xB060B080
block|,
literal|0xB0A0B060
block|,
literal|0x18602820
block|,
literal|0xB0A02820
block|,
literal|0x0000B060
block|,
literal|0xB1403000
block|,
literal|0x2E203500
block|,
literal|0x35002E20
block|,
literal|0x3000B140
block|,
literal|0x35A0B160
block|,
literal|0x2DC02E80
block|,
literal|0xB1403480
block|,
literal|0xB1603000
block|,
literal|0x2EA03640
block|,
literal|0x34002D80
block|,
literal|0x3000B120
block|,
literal|0x36E0B160
block|,
literal|0x2D202EF0
block|,
literal|0xB1203380
block|,
literal|0xB1603000
block|,
literal|0x2F303780
block|,
literal|0x33002CC0
block|,
literal|0x3000B100
block|,
literal|0x3820B160
block|,
literal|0x2C802F50
block|,
literal|0xB10032A0
block|,
literal|0xB1603000
block|,
literal|0x2F9038C0
block|,
literal|0x32202C20
block|,
literal|0x3000B0E0
block|,
literal|0x3980B160
block|,
literal|0x2BC02FC0
block|,
literal|0xB0E031C0
block|,
literal|0xB1603000
block|,
literal|0x2FF03A20
block|,
literal|0x31602B60
block|,
literal|0xB020B0C0
block|,
literal|0x3AE0B160
block|,
literal|0x2B001810
block|,
literal|0xB0C03120
block|,
literal|0xB140B020
block|,
literal|0x18283BA0
block|,
literal|0x30C02A80
block|,
literal|0xB020B0A0
block|,
literal|0x3C60B140
block|,
literal|0x2A201838
block|,
literal|0xB0A03080
block|,
literal|0xB120B020
block|,
literal|0x18383D20
block|,
literal|0x304029C0
block|,
literal|0xB040B080
block|,
literal|0x3DE0B100
block|,
literal|0x29601848
block|,
literal|0xB0803000
block|,
literal|0xB100B040
block|,
literal|0x18483EC0
block|,
literal|0xB0402900
block|,
literal|0xB040B060
block|,
literal|0x3F80B0C0
block|,
literal|0x28801858
block|,
literal|0xB060B080
block|,
literal|0xB0A0B060
block|,
literal|0x18602820
block|,
literal|0xB0A02820
block|,
literal|0x0000B060
block|,
literal|0x36403000
block|,
literal|0x2D002CC0
block|,
literal|0x30003640
block|,
literal|0x2D0036C0
block|,
literal|0x35C02CC0
block|,
literal|0x37403000
block|,
literal|0x2C802D40
block|,
literal|0x30003540
block|,
literal|0x2D8037C0
block|,
literal|0x34C02C40
block|,
literal|0x38403000
block|,
literal|0x2BC02E00
block|,
literal|0x30003440
block|,
literal|0x2E2038C0
block|,
literal|0x34002B80
block|,
literal|0x39803000
block|,
literal|0x2B402E40
block|,
literal|0x30003380
block|,
literal|0x2E603A00
block|,
literal|0x33402B00
block|,
literal|0x3A803040
block|,
literal|0x2A802EA0
block|,
literal|0x30403300
block|,
literal|0x2EC03B40
block|,
literal|0x32802A40
block|,
literal|0x3C003040
block|,
literal|0x2A002EC0
block|,
literal|0x30803240
block|,
literal|0x2EC03C80
block|,
literal|0x320029C0
block|,
literal|0x3D403080
block|,
literal|0x29402F00
block|,
literal|0x308031C0
block|,
literal|0x2F203DC0
block|,
literal|0x31802900
block|,
literal|0x3E8030C0
block|,
literal|0x28802F40
block|,
literal|0x30C03140
block|,
literal|0x2F203F40
block|,
literal|0x31402840
block|,
literal|0x28003100
block|,
literal|0x28002F00
block|,
literal|0x00003100
block|,
literal|0x36403000
block|,
literal|0x2D002CC0
block|,
literal|0x30003640
block|,
literal|0x2D0036C0
block|,
literal|0x35C02CC0
block|,
literal|0x37403000
block|,
literal|0x2C802D40
block|,
literal|0x30003540
block|,
literal|0x2D8037C0
block|,
literal|0x34C02C40
block|,
literal|0x38403000
block|,
literal|0x2BC02E00
block|,
literal|0x30003440
block|,
literal|0x2E2038C0
block|,
literal|0x34002B80
block|,
literal|0x39803000
block|,
literal|0x2B402E40
block|,
literal|0x30003380
block|,
literal|0x2E603A00
block|,
literal|0x33402B00
block|,
literal|0x3A803040
block|,
literal|0x2A802EA0
block|,
literal|0x30403300
block|,
literal|0x2EC03B40
block|,
literal|0x32802A40
block|,
literal|0x3C003040
block|,
literal|0x2A002EC0
block|,
literal|0x30803240
block|,
literal|0x2EC03C80
block|,
literal|0x320029C0
block|,
literal|0x3D403080
block|,
literal|0x29402F00
block|,
literal|0x308031C0
block|,
literal|0x2F203DC0
block|,
literal|0x31802900
block|,
literal|0x3E8030C0
block|,
literal|0x28802F40
block|,
literal|0x30C03140
block|,
literal|0x2F203F40
block|,
literal|0x31402840
block|,
literal|0x28003100
block|,
literal|0x28002F00
block|,
literal|0x00003100
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Color conversion values have 3 separate fixed point formats:  *  * 10 bit fields (ay, au)  *   1.9 fixed point (b.bbbbbbbbb)  * 11 bit fields (ry, by, ru, gu, gv)  *   exp.mantissa (ee.mmmmmmmmm)  *   ee = 00 = 10^-1 (0.mmmmmmmmm)  *   ee = 01 = 10^-2 (0.0mmmmmmmmm)  *   ee = 10 = 10^-3 (0.00mmmmmmmmm)  *   ee = 11 = 10^-4 (0.000mmmmmmmmm)  * 12 bit fields (gy, rv, bu)  *   exp.mantissa (eee.mmmmmmmmm)  *   eee = 000 = 10^-1 (0.mmmmmmmmm)  *   eee = 001 = 10^-2 (0.0mmmmmmmmm)  *   eee = 010 = 10^-3 (0.00mmmmmmmmm)  *   eee = 011 = 10^-4 (0.000mmmmmmmmm)  *   eee = 100 = reserved  *   eee = 101 = reserved  *   eee = 110 = reserved  *   eee = 111 = 10^0 (m.mmmmmmmm) (only usable for 1.0 representation)  *  * Saturation and contrast are 8 bits, with their own representation:  * 8 bit field (saturation, contrast)  *   exp.mantissa (ee.mmmmmm)  *   ee = 00 = 10^-1 (0.mmmmmm)  *   ee = 01 = 10^0 (m.mmmmm)  *   ee = 10 = 10^1 (mm.mmmm)  *   ee = 11 = 10^2 (mmm.mmm)  *  * Simple conversion function:  *  * static u32  * float_to_csc_11(float f)  * {  *     u32 exp;  *     u32 mant;  *     u32 ret;  *  *     if (f< 0)  *         f = -f;  *  *     if (f>= 1) {  *         exp = 0x7;  *	   mant = 1<< 8;  *     } else {  *         for (exp = 0; exp< 3&& f< 0.5; exp++)  *	   f *= 2.0;  *         mant = (f * (1<< 9) + 0.5);  *         if (mant>= (1<< 9))  *             mant = (1<< 9) - 1;  *     }  *     ret = (exp<< 9) | mant;  *     return ret;  * }  */
end_comment

begin_comment
comment|/*  * Behold, magic numbers!  If we plant them they might grow a big  * s-video cable to the sky... or something.  *  * Pre-converted to appropriate hex value.  */
end_comment

begin_comment
comment|/*  * PAL& NTSC values for composite& s-video connections  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|ntsc_m_csc_composite
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x0104
block|,
operator|.
name|ru
operator|=
literal|0x0733
block|,
operator|.
name|gu
operator|=
literal|0x052d
block|,
operator|.
name|bu
operator|=
literal|0x05c7
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x0340
block|,
operator|.
name|gv
operator|=
literal|0x030c
block|,
operator|.
name|bv
operator|=
literal|0x06d0
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|ntsc_m_levels_composite
init|=
block|{
operator|.
name|blank
operator|=
literal|225
block|,
operator|.
name|black
operator|=
literal|267
block|,
operator|.
name|burst
operator|=
literal|113
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|ntsc_m_csc_svideo
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x0133
block|,
operator|.
name|ru
operator|=
literal|0x076a
block|,
operator|.
name|gu
operator|=
literal|0x0564
block|,
operator|.
name|bu
operator|=
literal|0x030d
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x037a
block|,
operator|.
name|gv
operator|=
literal|0x033d
block|,
operator|.
name|bv
operator|=
literal|0x06f6
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|ntsc_m_levels_svideo
init|=
block|{
operator|.
name|blank
operator|=
literal|266
block|,
operator|.
name|black
operator|=
literal|316
block|,
operator|.
name|burst
operator|=
literal|133
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|ntsc_j_csc_composite
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x0119
block|,
operator|.
name|ru
operator|=
literal|0x074c
block|,
operator|.
name|gu
operator|=
literal|0x0546
block|,
operator|.
name|bu
operator|=
literal|0x05ec
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x035a
block|,
operator|.
name|gv
operator|=
literal|0x0322
block|,
operator|.
name|bv
operator|=
literal|0x06e1
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|ntsc_j_levels_composite
init|=
block|{
operator|.
name|blank
operator|=
literal|225
block|,
operator|.
name|black
operator|=
literal|225
block|,
operator|.
name|burst
operator|=
literal|113
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|ntsc_j_csc_svideo
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x014c
block|,
operator|.
name|ru
operator|=
literal|0x0788
block|,
operator|.
name|gu
operator|=
literal|0x0581
block|,
operator|.
name|bu
operator|=
literal|0x0322
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x0399
block|,
operator|.
name|gv
operator|=
literal|0x0356
block|,
operator|.
name|bv
operator|=
literal|0x070a
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|ntsc_j_levels_svideo
init|=
block|{
operator|.
name|blank
operator|=
literal|266
block|,
operator|.
name|black
operator|=
literal|266
block|,
operator|.
name|burst
operator|=
literal|133
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|pal_csc_composite
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x0113
block|,
operator|.
name|ru
operator|=
literal|0x0745
block|,
operator|.
name|gu
operator|=
literal|0x053f
block|,
operator|.
name|bu
operator|=
literal|0x05e1
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x0353
block|,
operator|.
name|gv
operator|=
literal|0x031c
block|,
operator|.
name|bv
operator|=
literal|0x06dc
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|pal_levels_composite
init|=
block|{
operator|.
name|blank
operator|=
literal|237
block|,
operator|.
name|black
operator|=
literal|237
block|,
operator|.
name|burst
operator|=
literal|118
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|pal_csc_svideo
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x0145
block|,
operator|.
name|ru
operator|=
literal|0x0780
block|,
operator|.
name|gu
operator|=
literal|0x0579
block|,
operator|.
name|bu
operator|=
literal|0x031c
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x0390
block|,
operator|.
name|gv
operator|=
literal|0x034f
block|,
operator|.
name|bv
operator|=
literal|0x0705
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|pal_levels_svideo
init|=
block|{
operator|.
name|blank
operator|=
literal|280
block|,
operator|.
name|black
operator|=
literal|280
block|,
operator|.
name|burst
operator|=
literal|139
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|pal_m_csc_composite
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x0104
block|,
operator|.
name|ru
operator|=
literal|0x0733
block|,
operator|.
name|gu
operator|=
literal|0x052d
block|,
operator|.
name|bu
operator|=
literal|0x05c7
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x0340
block|,
operator|.
name|gv
operator|=
literal|0x030c
block|,
operator|.
name|bv
operator|=
literal|0x06d0
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|pal_m_levels_composite
init|=
block|{
operator|.
name|blank
operator|=
literal|225
block|,
operator|.
name|black
operator|=
literal|267
block|,
operator|.
name|burst
operator|=
literal|113
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|pal_m_csc_svideo
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x0133
block|,
operator|.
name|ru
operator|=
literal|0x076a
block|,
operator|.
name|gu
operator|=
literal|0x0564
block|,
operator|.
name|bu
operator|=
literal|0x030d
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x037a
block|,
operator|.
name|gv
operator|=
literal|0x033d
block|,
operator|.
name|bv
operator|=
literal|0x06f6
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|pal_m_levels_svideo
init|=
block|{
operator|.
name|blank
operator|=
literal|266
block|,
operator|.
name|black
operator|=
literal|316
block|,
operator|.
name|burst
operator|=
literal|133
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|pal_n_csc_composite
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x0104
block|,
operator|.
name|ru
operator|=
literal|0x0733
block|,
operator|.
name|gu
operator|=
literal|0x052d
block|,
operator|.
name|bu
operator|=
literal|0x05c7
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x0340
block|,
operator|.
name|gv
operator|=
literal|0x030c
block|,
operator|.
name|bv
operator|=
literal|0x06d0
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|pal_n_levels_composite
init|=
block|{
operator|.
name|blank
operator|=
literal|225
block|,
operator|.
name|black
operator|=
literal|267
block|,
operator|.
name|burst
operator|=
literal|118
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|pal_n_csc_svideo
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x0133
block|,
operator|.
name|ru
operator|=
literal|0x076a
block|,
operator|.
name|gu
operator|=
literal|0x0564
block|,
operator|.
name|bu
operator|=
literal|0x030d
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x037a
block|,
operator|.
name|gv
operator|=
literal|0x033d
block|,
operator|.
name|bv
operator|=
literal|0x06f6
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|pal_n_levels_svideo
init|=
block|{
operator|.
name|blank
operator|=
literal|266
block|,
operator|.
name|black
operator|=
literal|316
block|,
operator|.
name|burst
operator|=
literal|139
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Component connections  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|sdtv_csc_yprpb
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0332
block|,
operator|.
name|gy
operator|=
literal|0x012d
block|,
operator|.
name|by
operator|=
literal|0x07d3
block|,
operator|.
name|ay
operator|=
literal|0x0145
block|,
operator|.
name|ru
operator|=
literal|0x0559
block|,
operator|.
name|gu
operator|=
literal|0x0353
block|,
operator|.
name|bu
operator|=
literal|0x0100
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x0100
block|,
operator|.
name|gv
operator|=
literal|0x03ad
block|,
operator|.
name|bv
operator|=
literal|0x074d
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|sdtv_csc_rgb
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0000
block|,
operator|.
name|gy
operator|=
literal|0x0f00
block|,
operator|.
name|by
operator|=
literal|0x0000
block|,
operator|.
name|ay
operator|=
literal|0x0166
block|,
operator|.
name|ru
operator|=
literal|0x0000
block|,
operator|.
name|gu
operator|=
literal|0x0000
block|,
operator|.
name|bu
operator|=
literal|0x0f00
block|,
operator|.
name|au
operator|=
literal|0x0166
block|,
operator|.
name|rv
operator|=
literal|0x0f00
block|,
operator|.
name|gv
operator|=
literal|0x0000
block|,
operator|.
name|bv
operator|=
literal|0x0000
block|,
operator|.
name|av
operator|=
literal|0x0166
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|hdtv_csc_yprpb
init|=
block|{
operator|.
name|ry
operator|=
literal|0x05b3
block|,
operator|.
name|gy
operator|=
literal|0x016e
block|,
operator|.
name|by
operator|=
literal|0x0728
block|,
operator|.
name|ay
operator|=
literal|0x0145
block|,
operator|.
name|ru
operator|=
literal|0x07d5
block|,
operator|.
name|gu
operator|=
literal|0x038b
block|,
operator|.
name|bu
operator|=
literal|0x0100
block|,
operator|.
name|au
operator|=
literal|0x0200
block|,
operator|.
name|rv
operator|=
literal|0x0100
block|,
operator|.
name|gv
operator|=
literal|0x03d1
block|,
operator|.
name|bv
operator|=
literal|0x06bc
block|,
operator|.
name|av
operator|=
literal|0x0200
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|color_conversion
name|hdtv_csc_rgb
init|=
block|{
operator|.
name|ry
operator|=
literal|0x0000
block|,
operator|.
name|gy
operator|=
literal|0x0f00
block|,
operator|.
name|by
operator|=
literal|0x0000
block|,
operator|.
name|ay
operator|=
literal|0x0166
block|,
operator|.
name|ru
operator|=
literal|0x0000
block|,
operator|.
name|gu
operator|=
literal|0x0000
block|,
operator|.
name|bu
operator|=
literal|0x0f00
block|,
operator|.
name|au
operator|=
literal|0x0166
block|,
operator|.
name|rv
operator|=
literal|0x0f00
block|,
operator|.
name|gv
operator|=
literal|0x0000
block|,
operator|.
name|bv
operator|=
literal|0x0000
block|,
operator|.
name|av
operator|=
literal|0x0166
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|video_levels
name|component_levels
init|=
block|{
operator|.
name|blank
operator|=
literal|279
block|,
operator|.
name|black
operator|=
literal|279
block|,
operator|.
name|burst
operator|=
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|tv_mode
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|clock
decl_stmt|;
name|int
name|refresh
decl_stmt|;
comment|/* in millihertz (for precision) */
name|u32
name|oversample
decl_stmt|;
name|int
name|hsync_end
decl_stmt|,
name|hblank_start
decl_stmt|,
name|hblank_end
decl_stmt|,
name|htotal
decl_stmt|;
name|bool
name|progressive
decl_stmt|,
name|trilevel_sync
decl_stmt|,
name|component_only
decl_stmt|;
name|int
name|vsync_start_f1
decl_stmt|,
name|vsync_start_f2
decl_stmt|,
name|vsync_len
decl_stmt|;
name|bool
name|veq_ena
decl_stmt|;
name|int
name|veq_start_f1
decl_stmt|,
name|veq_start_f2
decl_stmt|,
name|veq_len
decl_stmt|;
name|int
name|vi_end_f1
decl_stmt|,
name|vi_end_f2
decl_stmt|,
name|nbr_end
decl_stmt|;
name|bool
name|burst_ena
decl_stmt|;
name|int
name|hburst_start
decl_stmt|,
name|hburst_len
decl_stmt|;
name|int
name|vburst_start_f1
decl_stmt|,
name|vburst_end_f1
decl_stmt|;
name|int
name|vburst_start_f2
decl_stmt|,
name|vburst_end_f2
decl_stmt|;
name|int
name|vburst_start_f3
decl_stmt|,
name|vburst_end_f3
decl_stmt|;
name|int
name|vburst_start_f4
decl_stmt|,
name|vburst_end_f4
decl_stmt|;
comment|/* 	 * subcarrier programming 	 */
name|int
name|dda2_size
decl_stmt|,
name|dda3_size
decl_stmt|,
name|dda1_inc
decl_stmt|,
name|dda2_inc
decl_stmt|,
name|dda3_inc
decl_stmt|;
name|u32
name|sc_reset
decl_stmt|;
name|bool
name|pal_burst
decl_stmt|;
comment|/* 	 * blank/black levels 	 */
specifier|const
name|struct
name|video_levels
modifier|*
name|composite_levels
decl_stmt|,
modifier|*
name|svideo_levels
decl_stmt|;
specifier|const
name|struct
name|color_conversion
modifier|*
name|composite_color
decl_stmt|,
modifier|*
name|svideo_color
decl_stmt|;
specifier|const
name|u32
modifier|*
name|filter_table
decl_stmt|;
name|int
name|max_srcw
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Sub carrier DDA  *  *  I think this works as follows:  *  *  subcarrier freq = pixel_clock * (dda1_inc + dda2_inc / dda2_size) / 4096  *  * Presumably, when dda3 is added in, it gets to adjust the dda2_inc value  *  * So,  *  dda1_ideal = subcarrier/pixel * 4096  *  dda1_inc = floor (dda1_ideal)  *  dda2 = dda1_ideal - dda1_inc  *  *  then pick a ratio for dda2 that gives the closest approximation. If  *  you can't get close enough, you can play with dda3 as well. This  *  seems likely to happen when dda2 is small as the jumps would be larger  *  * To invert this,  *  *  pixel_clock = subcarrier * 4096 / (dda1_inc + dda2_inc / dda2_size)  *  * The constants below were all computed using a 107.520MHz clock  */
end_comment

begin_comment
comment|/**  * Register programming values for TV modes.  *  * These values account for -1s required.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tv_mode
name|tv_modes
index|[]
init|=
block|{
block|{
operator|.
name|name
operator|=
literal|"NTSC-M"
block|,
operator|.
name|clock
operator|=
literal|108000
block|,
operator|.
name|refresh
operator|=
literal|59940
block|,
operator|.
name|oversample
operator|=
name|TV_OVERSAMPLE_8X
block|,
operator|.
name|component_only
operator|=
literal|0
block|,
comment|/* 525 Lines, 60 Fields, 15.734KHz line, Sub-Carrier 3.580MHz */
operator|.
name|hsync_end
operator|=
literal|64
block|,
operator|.
name|hblank_end
operator|=
literal|124
block|,
operator|.
name|hblank_start
operator|=
literal|836
block|,
operator|.
name|htotal
operator|=
literal|857
block|,
operator|.
name|progressive
operator|=
name|false
block|,
operator|.
name|trilevel_sync
operator|=
name|false
block|,
operator|.
name|vsync_start_f1
operator|=
literal|6
block|,
operator|.
name|vsync_start_f2
operator|=
literal|7
block|,
operator|.
name|vsync_len
operator|=
literal|6
block|,
operator|.
name|veq_ena
operator|=
name|true
block|,
operator|.
name|veq_start_f1
operator|=
literal|0
block|,
operator|.
name|veq_start_f2
operator|=
literal|1
block|,
operator|.
name|veq_len
operator|=
literal|18
block|,
operator|.
name|vi_end_f1
operator|=
literal|20
block|,
operator|.
name|vi_end_f2
operator|=
literal|21
block|,
operator|.
name|nbr_end
operator|=
literal|240
block|,
operator|.
name|burst_ena
operator|=
name|true
block|,
operator|.
name|hburst_start
operator|=
literal|72
block|,
operator|.
name|hburst_len
operator|=
literal|34
block|,
operator|.
name|vburst_start_f1
operator|=
literal|9
block|,
operator|.
name|vburst_end_f1
operator|=
literal|240
block|,
operator|.
name|vburst_start_f2
operator|=
literal|10
block|,
operator|.
name|vburst_end_f2
operator|=
literal|240
block|,
operator|.
name|vburst_start_f3
operator|=
literal|9
block|,
operator|.
name|vburst_end_f3
operator|=
literal|240
block|,
operator|.
name|vburst_start_f4
operator|=
literal|10
block|,
operator|.
name|vburst_end_f4
operator|=
literal|240
block|,
comment|/* desired 3.5800000 actual 3.5800000 clock 107.52 */
operator|.
name|dda1_inc
operator|=
literal|135
block|,
operator|.
name|dda2_inc
operator|=
literal|20800
block|,
operator|.
name|dda2_size
operator|=
literal|27456
block|,
operator|.
name|dda3_inc
operator|=
literal|0
block|,
operator|.
name|dda3_size
operator|=
literal|0
block|,
operator|.
name|sc_reset
operator|=
name|TV_SC_RESET_EVERY_4
block|,
operator|.
name|pal_burst
operator|=
name|false
block|,
operator|.
name|composite_levels
operator|=
operator|&
name|ntsc_m_levels_composite
block|,
operator|.
name|composite_color
operator|=
operator|&
name|ntsc_m_csc_composite
block|,
operator|.
name|svideo_levels
operator|=
operator|&
name|ntsc_m_levels_svideo
block|,
operator|.
name|svideo_color
operator|=
operator|&
name|ntsc_m_csc_svideo
block|,
operator|.
name|filter_table
operator|=
name|filter_table
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"NTSC-443"
block|,
operator|.
name|clock
operator|=
literal|108000
block|,
operator|.
name|refresh
operator|=
literal|59940
block|,
operator|.
name|oversample
operator|=
name|TV_OVERSAMPLE_8X
block|,
operator|.
name|component_only
operator|=
literal|0
block|,
comment|/* 525 Lines, 60 Fields, 15.734KHz line, Sub-Carrier 4.43MHz */
operator|.
name|hsync_end
operator|=
literal|64
block|,
operator|.
name|hblank_end
operator|=
literal|124
block|,
operator|.
name|hblank_start
operator|=
literal|836
block|,
operator|.
name|htotal
operator|=
literal|857
block|,
operator|.
name|progressive
operator|=
name|false
block|,
operator|.
name|trilevel_sync
operator|=
name|false
block|,
operator|.
name|vsync_start_f1
operator|=
literal|6
block|,
operator|.
name|vsync_start_f2
operator|=
literal|7
block|,
operator|.
name|vsync_len
operator|=
literal|6
block|,
operator|.
name|veq_ena
operator|=
name|true
block|,
operator|.
name|veq_start_f1
operator|=
literal|0
block|,
operator|.
name|veq_start_f2
operator|=
literal|1
block|,
operator|.
name|veq_len
operator|=
literal|18
block|,
operator|.
name|vi_end_f1
operator|=
literal|20
block|,
operator|.
name|vi_end_f2
operator|=
literal|21
block|,
operator|.
name|nbr_end
operator|=
literal|240
block|,
operator|.
name|burst_ena
operator|=
name|true
block|,
operator|.
name|hburst_start
operator|=
literal|72
block|,
operator|.
name|hburst_len
operator|=
literal|34
block|,
operator|.
name|vburst_start_f1
operator|=
literal|9
block|,
operator|.
name|vburst_end_f1
operator|=
literal|240
block|,
operator|.
name|vburst_start_f2
operator|=
literal|10
block|,
operator|.
name|vburst_end_f2
operator|=
literal|240
block|,
operator|.
name|vburst_start_f3
operator|=
literal|9
block|,
operator|.
name|vburst_end_f3
operator|=
literal|240
block|,
operator|.
name|vburst_start_f4
operator|=
literal|10
block|,
operator|.
name|vburst_end_f4
operator|=
literal|240
block|,
comment|/* desired 4.4336180 actual 4.4336180 clock 107.52 */
operator|.
name|dda1_inc
operator|=
literal|168
block|,
operator|.
name|dda2_inc
operator|=
literal|4093
block|,
operator|.
name|dda2_size
operator|=
literal|27456
block|,
operator|.
name|dda3_inc
operator|=
literal|310
block|,
operator|.
name|dda3_size
operator|=
literal|525
block|,
operator|.
name|sc_reset
operator|=
name|TV_SC_RESET_NEVER
block|,
operator|.
name|pal_burst
operator|=
name|false
block|,
operator|.
name|composite_levels
operator|=
operator|&
name|ntsc_m_levels_composite
block|,
operator|.
name|composite_color
operator|=
operator|&
name|ntsc_m_csc_composite
block|,
operator|.
name|svideo_levels
operator|=
operator|&
name|ntsc_m_levels_svideo
block|,
operator|.
name|svideo_color
operator|=
operator|&
name|ntsc_m_csc_svideo
block|,
operator|.
name|filter_table
operator|=
name|filter_table
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"NTSC-J"
block|,
operator|.
name|clock
operator|=
literal|108000
block|,
operator|.
name|refresh
operator|=
literal|59940
block|,
operator|.
name|oversample
operator|=
name|TV_OVERSAMPLE_8X
block|,
operator|.
name|component_only
operator|=
literal|0
block|,
comment|/* 525 Lines, 60 Fields, 15.734KHz line, Sub-Carrier 3.580MHz */
operator|.
name|hsync_end
operator|=
literal|64
block|,
operator|.
name|hblank_end
operator|=
literal|124
block|,
operator|.
name|hblank_start
operator|=
literal|836
block|,
operator|.
name|htotal
operator|=
literal|857
block|,
operator|.
name|progressive
operator|=
name|false
block|,
operator|.
name|trilevel_sync
operator|=
name|false
block|,
operator|.
name|vsync_start_f1
operator|=
literal|6
block|,
operator|.
name|vsync_start_f2
operator|=
literal|7
block|,
operator|.
name|vsync_len
operator|=
literal|6
block|,
operator|.
name|veq_ena
operator|=
name|true
block|,
operator|.
name|veq_start_f1
operator|=
literal|0
block|,
operator|.
name|veq_start_f2
operator|=
literal|1
block|,
operator|.
name|veq_len
operator|=
literal|18
block|,
operator|.
name|vi_end_f1
operator|=
literal|20
block|,
operator|.
name|vi_end_f2
operator|=
literal|21
block|,
operator|.
name|nbr_end
operator|=
literal|240
block|,
operator|.
name|burst_ena
operator|=
name|true
block|,
operator|.
name|hburst_start
operator|=
literal|72
block|,
operator|.
name|hburst_len
operator|=
literal|34
block|,
operator|.
name|vburst_start_f1
operator|=
literal|9
block|,
operator|.
name|vburst_end_f1
operator|=
literal|240
block|,
operator|.
name|vburst_start_f2
operator|=
literal|10
block|,
operator|.
name|vburst_end_f2
operator|=
literal|240
block|,
operator|.
name|vburst_start_f3
operator|=
literal|9
block|,
operator|.
name|vburst_end_f3
operator|=
literal|240
block|,
operator|.
name|vburst_start_f4
operator|=
literal|10
block|,
operator|.
name|vburst_end_f4
operator|=
literal|240
block|,
comment|/* desired 3.5800000 actual 3.5800000 clock 107.52 */
operator|.
name|dda1_inc
operator|=
literal|135
block|,
operator|.
name|dda2_inc
operator|=
literal|20800
block|,
operator|.
name|dda2_size
operator|=
literal|27456
block|,
operator|.
name|dda3_inc
operator|=
literal|0
block|,
operator|.
name|dda3_size
operator|=
literal|0
block|,
operator|.
name|sc_reset
operator|=
name|TV_SC_RESET_EVERY_4
block|,
operator|.
name|pal_burst
operator|=
name|false
block|,
operator|.
name|composite_levels
operator|=
operator|&
name|ntsc_j_levels_composite
block|,
operator|.
name|composite_color
operator|=
operator|&
name|ntsc_j_csc_composite
block|,
operator|.
name|svideo_levels
operator|=
operator|&
name|ntsc_j_levels_svideo
block|,
operator|.
name|svideo_color
operator|=
operator|&
name|ntsc_j_csc_svideo
block|,
operator|.
name|filter_table
operator|=
name|filter_table
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"PAL-M"
block|,
operator|.
name|clock
operator|=
literal|108000
block|,
operator|.
name|refresh
operator|=
literal|59940
block|,
operator|.
name|oversample
operator|=
name|TV_OVERSAMPLE_8X
block|,
operator|.
name|component_only
operator|=
literal|0
block|,
comment|/* 525 Lines, 60 Fields, 15.734KHz line, Sub-Carrier 3.580MHz */
operator|.
name|hsync_end
operator|=
literal|64
block|,
operator|.
name|hblank_end
operator|=
literal|124
block|,
operator|.
name|hblank_start
operator|=
literal|836
block|,
operator|.
name|htotal
operator|=
literal|857
block|,
operator|.
name|progressive
operator|=
name|false
block|,
operator|.
name|trilevel_sync
operator|=
name|false
block|,
operator|.
name|vsync_start_f1
operator|=
literal|6
block|,
operator|.
name|vsync_start_f2
operator|=
literal|7
block|,
operator|.
name|vsync_len
operator|=
literal|6
block|,
operator|.
name|veq_ena
operator|=
name|true
block|,
operator|.
name|veq_start_f1
operator|=
literal|0
block|,
operator|.
name|veq_start_f2
operator|=
literal|1
block|,
operator|.
name|veq_len
operator|=
literal|18
block|,
operator|.
name|vi_end_f1
operator|=
literal|20
block|,
operator|.
name|vi_end_f2
operator|=
literal|21
block|,
operator|.
name|nbr_end
operator|=
literal|240
block|,
operator|.
name|burst_ena
operator|=
name|true
block|,
operator|.
name|hburst_start
operator|=
literal|72
block|,
operator|.
name|hburst_len
operator|=
literal|34
block|,
operator|.
name|vburst_start_f1
operator|=
literal|9
block|,
operator|.
name|vburst_end_f1
operator|=
literal|240
block|,
operator|.
name|vburst_start_f2
operator|=
literal|10
block|,
operator|.
name|vburst_end_f2
operator|=
literal|240
block|,
operator|.
name|vburst_start_f3
operator|=
literal|9
block|,
operator|.
name|vburst_end_f3
operator|=
literal|240
block|,
operator|.
name|vburst_start_f4
operator|=
literal|10
block|,
operator|.
name|vburst_end_f4
operator|=
literal|240
block|,
comment|/* desired 3.5800000 actual 3.5800000 clock 107.52 */
operator|.
name|dda1_inc
operator|=
literal|135
block|,
operator|.
name|dda2_inc
operator|=
literal|16704
block|,
operator|.
name|dda2_size
operator|=
literal|27456
block|,
operator|.
name|dda3_inc
operator|=
literal|0
block|,
operator|.
name|dda3_size
operator|=
literal|0
block|,
operator|.
name|sc_reset
operator|=
name|TV_SC_RESET_EVERY_8
block|,
operator|.
name|pal_burst
operator|=
name|true
block|,
operator|.
name|composite_levels
operator|=
operator|&
name|pal_m_levels_composite
block|,
operator|.
name|composite_color
operator|=
operator|&
name|pal_m_csc_composite
block|,
operator|.
name|svideo_levels
operator|=
operator|&
name|pal_m_levels_svideo
block|,
operator|.
name|svideo_color
operator|=
operator|&
name|pal_m_csc_svideo
block|,
operator|.
name|filter_table
operator|=
name|filter_table
block|, 	}
block|,
block|{
comment|/* 625 Lines, 50 Fields, 15.625KHz line, Sub-Carrier 4.434MHz */
operator|.
name|name
operator|=
literal|"PAL-N"
block|,
operator|.
name|clock
operator|=
literal|108000
block|,
operator|.
name|refresh
operator|=
literal|50000
block|,
operator|.
name|oversample
operator|=
name|TV_OVERSAMPLE_8X
block|,
operator|.
name|component_only
operator|=
literal|0
block|,
operator|.
name|hsync_end
operator|=
literal|64
block|,
operator|.
name|hblank_end
operator|=
literal|128
block|,
operator|.
name|hblank_start
operator|=
literal|844
block|,
operator|.
name|htotal
operator|=
literal|863
block|,
operator|.
name|progressive
operator|=
name|false
block|,
operator|.
name|trilevel_sync
operator|=
name|false
block|,
operator|.
name|vsync_start_f1
operator|=
literal|6
block|,
operator|.
name|vsync_start_f2
operator|=
literal|7
block|,
operator|.
name|vsync_len
operator|=
literal|6
block|,
operator|.
name|veq_ena
operator|=
name|true
block|,
operator|.
name|veq_start_f1
operator|=
literal|0
block|,
operator|.
name|veq_start_f2
operator|=
literal|1
block|,
operator|.
name|veq_len
operator|=
literal|18
block|,
operator|.
name|vi_end_f1
operator|=
literal|24
block|,
operator|.
name|vi_end_f2
operator|=
literal|25
block|,
operator|.
name|nbr_end
operator|=
literal|286
block|,
operator|.
name|burst_ena
operator|=
name|true
block|,
operator|.
name|hburst_start
operator|=
literal|73
block|,
operator|.
name|hburst_len
operator|=
literal|34
block|,
operator|.
name|vburst_start_f1
operator|=
literal|8
block|,
operator|.
name|vburst_end_f1
operator|=
literal|285
block|,
operator|.
name|vburst_start_f2
operator|=
literal|8
block|,
operator|.
name|vburst_end_f2
operator|=
literal|286
block|,
operator|.
name|vburst_start_f3
operator|=
literal|9
block|,
operator|.
name|vburst_end_f3
operator|=
literal|286
block|,
operator|.
name|vburst_start_f4
operator|=
literal|9
block|,
operator|.
name|vburst_end_f4
operator|=
literal|285
block|,
comment|/* desired 4.4336180 actual 4.4336180 clock 107.52 */
operator|.
name|dda1_inc
operator|=
literal|135
block|,
operator|.
name|dda2_inc
operator|=
literal|23578
block|,
operator|.
name|dda2_size
operator|=
literal|27648
block|,
operator|.
name|dda3_inc
operator|=
literal|134
block|,
operator|.
name|dda3_size
operator|=
literal|625
block|,
operator|.
name|sc_reset
operator|=
name|TV_SC_RESET_EVERY_8
block|,
operator|.
name|pal_burst
operator|=
name|true
block|,
operator|.
name|composite_levels
operator|=
operator|&
name|pal_n_levels_composite
block|,
operator|.
name|composite_color
operator|=
operator|&
name|pal_n_csc_composite
block|,
operator|.
name|svideo_levels
operator|=
operator|&
name|pal_n_levels_svideo
block|,
operator|.
name|svideo_color
operator|=
operator|&
name|pal_n_csc_svideo
block|,
operator|.
name|filter_table
operator|=
name|filter_table
block|, 	}
block|,
block|{
comment|/* 625 Lines, 50 Fields, 15.625KHz line, Sub-Carrier 4.434MHz */
operator|.
name|name
operator|=
literal|"PAL"
block|,
operator|.
name|clock
operator|=
literal|108000
block|,
operator|.
name|refresh
operator|=
literal|50000
block|,
operator|.
name|oversample
operator|=
name|TV_OVERSAMPLE_8X
block|,
operator|.
name|component_only
operator|=
literal|0
block|,
operator|.
name|hsync_end
operator|=
literal|64
block|,
operator|.
name|hblank_end
operator|=
literal|142
block|,
operator|.
name|hblank_start
operator|=
literal|844
block|,
operator|.
name|htotal
operator|=
literal|863
block|,
operator|.
name|progressive
operator|=
name|false
block|,
operator|.
name|trilevel_sync
operator|=
name|false
block|,
operator|.
name|vsync_start_f1
operator|=
literal|5
block|,
operator|.
name|vsync_start_f2
operator|=
literal|6
block|,
operator|.
name|vsync_len
operator|=
literal|5
block|,
operator|.
name|veq_ena
operator|=
name|true
block|,
operator|.
name|veq_start_f1
operator|=
literal|0
block|,
operator|.
name|veq_start_f2
operator|=
literal|1
block|,
operator|.
name|veq_len
operator|=
literal|15
block|,
operator|.
name|vi_end_f1
operator|=
literal|24
block|,
operator|.
name|vi_end_f2
operator|=
literal|25
block|,
operator|.
name|nbr_end
operator|=
literal|286
block|,
operator|.
name|burst_ena
operator|=
name|true
block|,
operator|.
name|hburst_start
operator|=
literal|73
block|,
operator|.
name|hburst_len
operator|=
literal|32
block|,
operator|.
name|vburst_start_f1
operator|=
literal|8
block|,
operator|.
name|vburst_end_f1
operator|=
literal|285
block|,
operator|.
name|vburst_start_f2
operator|=
literal|8
block|,
operator|.
name|vburst_end_f2
operator|=
literal|286
block|,
operator|.
name|vburst_start_f3
operator|=
literal|9
block|,
operator|.
name|vburst_end_f3
operator|=
literal|286
block|,
operator|.
name|vburst_start_f4
operator|=
literal|9
block|,
operator|.
name|vburst_end_f4
operator|=
literal|285
block|,
comment|/* desired 4.4336180 actual 4.4336180 clock 107.52 */
operator|.
name|dda1_inc
operator|=
literal|168
block|,
operator|.
name|dda2_inc
operator|=
literal|4122
block|,
operator|.
name|dda2_size
operator|=
literal|27648
block|,
operator|.
name|dda3_inc
operator|=
literal|67
block|,
operator|.
name|dda3_size
operator|=
literal|625
block|,
operator|.
name|sc_reset
operator|=
name|TV_SC_RESET_EVERY_8
block|,
operator|.
name|pal_burst
operator|=
name|true
block|,
operator|.
name|composite_levels
operator|=
operator|&
name|pal_levels_composite
block|,
operator|.
name|composite_color
operator|=
operator|&
name|pal_csc_composite
block|,
operator|.
name|svideo_levels
operator|=
operator|&
name|pal_levels_svideo
block|,
operator|.
name|svideo_color
operator|=
operator|&
name|pal_csc_svideo
block|,
operator|.
name|filter_table
operator|=
name|filter_table
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"720p@60Hz"
block|,
operator|.
name|clock
operator|=
literal|148800
block|,
operator|.
name|refresh
operator|=
literal|60000
block|,
operator|.
name|oversample
operator|=
name|TV_OVERSAMPLE_2X
block|,
operator|.
name|component_only
operator|=
literal|1
block|,
operator|.
name|hsync_end
operator|=
literal|80
block|,
operator|.
name|hblank_end
operator|=
literal|300
block|,
operator|.
name|hblank_start
operator|=
literal|1580
block|,
operator|.
name|htotal
operator|=
literal|1649
block|,
operator|.
name|progressive
operator|=
name|true
block|,
operator|.
name|trilevel_sync
operator|=
name|true
block|,
operator|.
name|vsync_start_f1
operator|=
literal|10
block|,
operator|.
name|vsync_start_f2
operator|=
literal|10
block|,
operator|.
name|vsync_len
operator|=
literal|10
block|,
operator|.
name|veq_ena
operator|=
name|false
block|,
operator|.
name|vi_end_f1
operator|=
literal|29
block|,
operator|.
name|vi_end_f2
operator|=
literal|29
block|,
operator|.
name|nbr_end
operator|=
literal|719
block|,
operator|.
name|burst_ena
operator|=
name|false
block|,
operator|.
name|filter_table
operator|=
name|filter_table
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"720p@50Hz"
block|,
operator|.
name|clock
operator|=
literal|148800
block|,
operator|.
name|refresh
operator|=
literal|50000
block|,
operator|.
name|oversample
operator|=
name|TV_OVERSAMPLE_2X
block|,
operator|.
name|component_only
operator|=
literal|1
block|,
operator|.
name|hsync_end
operator|=
literal|80
block|,
operator|.
name|hblank_end
operator|=
literal|300
block|,
operator|.
name|hblank_start
operator|=
literal|1580
block|,
operator|.
name|htotal
operator|=
literal|1979
block|,
operator|.
name|progressive
operator|=
name|true
block|,
operator|.
name|trilevel_sync
operator|=
name|true
block|,
operator|.
name|vsync_start_f1
operator|=
literal|10
block|,
operator|.
name|vsync_start_f2
operator|=
literal|10
block|,
operator|.
name|vsync_len
operator|=
literal|10
block|,
operator|.
name|veq_ena
operator|=
name|false
block|,
operator|.
name|vi_end_f1
operator|=
literal|29
block|,
operator|.
name|vi_end_f2
operator|=
literal|29
block|,
operator|.
name|nbr_end
operator|=
literal|719
block|,
operator|.
name|burst_ena
operator|=
name|false
block|,
operator|.
name|filter_table
operator|=
name|filter_table
block|,
operator|.
name|max_srcw
operator|=
literal|800
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"1080i@50Hz"
block|,
operator|.
name|clock
operator|=
literal|148800
block|,
operator|.
name|refresh
operator|=
literal|50000
block|,
operator|.
name|oversample
operator|=
name|TV_OVERSAMPLE_2X
block|,
operator|.
name|component_only
operator|=
literal|1
block|,
operator|.
name|hsync_end
operator|=
literal|88
block|,
operator|.
name|hblank_end
operator|=
literal|235
block|,
operator|.
name|hblank_start
operator|=
literal|2155
block|,
operator|.
name|htotal
operator|=
literal|2639
block|,
operator|.
name|progressive
operator|=
name|false
block|,
operator|.
name|trilevel_sync
operator|=
name|true
block|,
operator|.
name|vsync_start_f1
operator|=
literal|4
block|,
operator|.
name|vsync_start_f2
operator|=
literal|5
block|,
operator|.
name|vsync_len
operator|=
literal|10
block|,
operator|.
name|veq_ena
operator|=
name|true
block|,
operator|.
name|veq_start_f1
operator|=
literal|4
block|,
operator|.
name|veq_start_f2
operator|=
literal|4
block|,
operator|.
name|veq_len
operator|=
literal|10
block|,
operator|.
name|vi_end_f1
operator|=
literal|21
block|,
operator|.
name|vi_end_f2
operator|=
literal|22
block|,
operator|.
name|nbr_end
operator|=
literal|539
block|,
operator|.
name|burst_ena
operator|=
name|false
block|,
operator|.
name|filter_table
operator|=
name|filter_table
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"1080i@60Hz"
block|,
operator|.
name|clock
operator|=
literal|148800
block|,
operator|.
name|refresh
operator|=
literal|60000
block|,
operator|.
name|oversample
operator|=
name|TV_OVERSAMPLE_2X
block|,
operator|.
name|component_only
operator|=
literal|1
block|,
operator|.
name|hsync_end
operator|=
literal|88
block|,
operator|.
name|hblank_end
operator|=
literal|235
block|,
operator|.
name|hblank_start
operator|=
literal|2155
block|,
operator|.
name|htotal
operator|=
literal|2199
block|,
operator|.
name|progressive
operator|=
name|false
block|,
operator|.
name|trilevel_sync
operator|=
name|true
block|,
operator|.
name|vsync_start_f1
operator|=
literal|4
block|,
operator|.
name|vsync_start_f2
operator|=
literal|5
block|,
operator|.
name|vsync_len
operator|=
literal|10
block|,
operator|.
name|veq_ena
operator|=
name|true
block|,
operator|.
name|veq_start_f1
operator|=
literal|4
block|,
operator|.
name|veq_start_f2
operator|=
literal|4
block|,
operator|.
name|veq_len
operator|=
literal|10
block|,
operator|.
name|vi_end_f1
operator|=
literal|21
block|,
operator|.
name|vi_end_f2
operator|=
literal|22
block|,
operator|.
name|nbr_end
operator|=
literal|539
block|,
operator|.
name|burst_ena
operator|=
name|false
block|,
operator|.
name|filter_table
operator|=
name|filter_table
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|intel_tv
modifier|*
name|enc_to_intel_tv
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
return|return
name|container_of
argument_list|(
name|encoder
argument_list|,
expr|struct
name|intel_tv
argument_list|,
name|base
operator|.
name|base
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|intel_tv
modifier|*
name|intel_attached_tv
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
return|return
name|container_of
argument_list|(
name|intel_attached_encoder
argument_list|(
name|connector
argument_list|)
argument_list|,
expr|struct
name|intel_tv
argument_list|,
name|base
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|intel_tv_dpms
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|DRM_MODE_DPMS_ON
case|:
name|I915_WRITE
argument_list|(
name|TV_CTL
argument_list|,
name|I915_READ
argument_list|(
name|TV_CTL
argument_list|)
operator||
name|TV_ENC_ENABLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|DRM_MODE_DPMS_STANDBY
case|:
case|case
name|DRM_MODE_DPMS_SUSPEND
case|:
case|case
name|DRM_MODE_DPMS_OFF
case|:
name|I915_WRITE
argument_list|(
name|TV_CTL
argument_list|,
name|I915_READ
argument_list|(
name|TV_CTL
argument_list|)
operator|&
operator|~
name|TV_ENC_ENABLE
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|struct
name|tv_mode
modifier|*
name|intel_tv_mode_lookup
parameter_list|(
specifier|const
name|char
modifier|*
name|tv_format
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DRM_ARRAY_SIZE
argument_list|(
name|tv_modes
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|struct
name|tv_mode
modifier|*
name|tv_mode
init|=
operator|&
name|tv_modes
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|tv_format
argument_list|,
name|tv_mode
operator|->
name|name
argument_list|)
condition|)
return|return
name|tv_mode
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|struct
name|tv_mode
modifier|*
name|intel_tv_mode_find
parameter_list|(
name|struct
name|intel_tv
modifier|*
name|intel_tv
parameter_list|)
block|{
return|return
name|intel_tv_mode_lookup
argument_list|(
name|intel_tv
operator|->
name|tv_format
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|drm_mode_status
name|intel_tv_mode_valid
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
name|struct
name|intel_tv
modifier|*
name|intel_tv
init|=
name|intel_attached_tv
argument_list|(
name|connector
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|tv_mode
modifier|*
name|tv_mode
init|=
name|intel_tv_mode_find
argument_list|(
name|intel_tv
argument_list|)
decl_stmt|;
comment|/* Ensure TV refresh is close to desired refresh */
if|if
condition|(
name|tv_mode
operator|&&
name|abs
argument_list|(
name|tv_mode
operator|->
name|refresh
operator|-
name|drm_mode_vrefresh
argument_list|(
name|mode
argument_list|)
operator|*
literal|1000
argument_list|)
operator|<
literal|1000
condition|)
return|return
name|MODE_OK
return|;
return|return
name|MODE_CLOCK_RANGE
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|intel_tv_mode_fixup
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
specifier|const
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|drm_mode_config
modifier|*
name|drm_config
init|=
operator|&
name|dev
operator|->
name|mode_config
decl_stmt|;
name|struct
name|intel_tv
modifier|*
name|intel_tv
init|=
name|enc_to_intel_tv
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|tv_mode
modifier|*
name|tv_mode
init|=
name|intel_tv_mode_find
argument_list|(
name|intel_tv
argument_list|)
decl_stmt|;
name|struct
name|drm_encoder
modifier|*
name|other_encoder
decl_stmt|;
if|if
condition|(
operator|!
name|tv_mode
condition|)
return|return
name|false
return|;
comment|/* FIXME: lock encoder list */
name|list_for_each_entry
argument_list|(
argument|other_encoder
argument_list|,
argument|&drm_config->encoder_list
argument_list|,
argument|head
argument_list|)
block|{
if|if
condition|(
name|other_encoder
operator|!=
name|encoder
operator|&&
name|other_encoder
operator|->
name|crtc
operator|==
name|encoder
operator|->
name|crtc
condition|)
return|return
name|false
return|;
block|}
name|adjusted_mode
operator|->
name|clock
operator|=
name|tv_mode
operator|->
name|clock
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|intel_tv_mode_set
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
init|=
name|encoder
operator|->
name|crtc
decl_stmt|;
name|struct
name|intel_crtc
modifier|*
name|intel_crtc
init|=
name|to_intel_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|intel_tv
modifier|*
name|intel_tv
init|=
name|enc_to_intel_tv
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|tv_mode
modifier|*
name|tv_mode
init|=
name|intel_tv_mode_find
argument_list|(
name|intel_tv
argument_list|)
decl_stmt|;
name|u32
name|tv_ctl
decl_stmt|;
name|u32
name|hctl1
decl_stmt|,
name|hctl2
decl_stmt|,
name|hctl3
decl_stmt|;
name|u32
name|vctl1
decl_stmt|,
name|vctl2
decl_stmt|,
name|vctl3
decl_stmt|,
name|vctl4
decl_stmt|,
name|vctl5
decl_stmt|,
name|vctl6
decl_stmt|,
name|vctl7
decl_stmt|;
name|u32
name|scctl1
decl_stmt|,
name|scctl2
decl_stmt|,
name|scctl3
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|const
name|struct
name|video_levels
modifier|*
name|video_levels
decl_stmt|;
specifier|const
name|struct
name|color_conversion
modifier|*
name|color_conversion
decl_stmt|;
name|bool
name|burst_ena
decl_stmt|;
name|int
name|pipe
init|=
name|intel_crtc
operator|->
name|pipe
decl_stmt|;
if|if
condition|(
operator|!
name|tv_mode
condition|)
return|return;
comment|/* can't happen (mode_prepare prevents this) */
name|tv_ctl
operator|=
name|I915_READ
argument_list|(
name|TV_CTL
argument_list|)
expr_stmt|;
name|tv_ctl
operator|&=
name|TV_CTL_SAVE
expr_stmt|;
switch|switch
condition|(
name|intel_tv
operator|->
name|type
condition|)
block|{
default|default:
case|case
name|DRM_MODE_CONNECTOR_Unknown
case|:
case|case
name|DRM_MODE_CONNECTOR_Composite
case|:
name|tv_ctl
operator||=
name|TV_ENC_OUTPUT_COMPOSITE
expr_stmt|;
name|video_levels
operator|=
name|tv_mode
operator|->
name|composite_levels
expr_stmt|;
name|color_conversion
operator|=
name|tv_mode
operator|->
name|composite_color
expr_stmt|;
name|burst_ena
operator|=
name|tv_mode
operator|->
name|burst_ena
expr_stmt|;
break|break;
case|case
name|DRM_MODE_CONNECTOR_Component
case|:
name|tv_ctl
operator||=
name|TV_ENC_OUTPUT_COMPONENT
expr_stmt|;
name|video_levels
operator|=
operator|&
name|component_levels
expr_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|burst_ena
condition|)
name|color_conversion
operator|=
operator|&
name|sdtv_csc_yprpb
expr_stmt|;
else|else
name|color_conversion
operator|=
operator|&
name|hdtv_csc_yprpb
expr_stmt|;
name|burst_ena
operator|=
name|false
expr_stmt|;
break|break;
case|case
name|DRM_MODE_CONNECTOR_SVIDEO
case|:
name|tv_ctl
operator||=
name|TV_ENC_OUTPUT_SVIDEO
expr_stmt|;
name|video_levels
operator|=
name|tv_mode
operator|->
name|svideo_levels
expr_stmt|;
name|color_conversion
operator|=
name|tv_mode
operator|->
name|svideo_color
expr_stmt|;
name|burst_ena
operator|=
name|tv_mode
operator|->
name|burst_ena
expr_stmt|;
break|break;
block|}
name|hctl1
operator|=
operator|(
name|tv_mode
operator|->
name|hsync_end
operator|<<
name|TV_HSYNC_END_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|htotal
operator|<<
name|TV_HTOTAL_SHIFT
operator|)
expr_stmt|;
name|hctl2
operator|=
operator|(
name|tv_mode
operator|->
name|hburst_start
operator|<<
literal|16
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|hburst_len
operator|<<
name|TV_HBURST_LEN_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|burst_ena
condition|)
name|hctl2
operator||=
name|TV_BURST_ENA
expr_stmt|;
name|hctl3
operator|=
operator|(
name|tv_mode
operator|->
name|hblank_start
operator|<<
name|TV_HBLANK_START_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|hblank_end
operator|<<
name|TV_HBLANK_END_SHIFT
operator|)
expr_stmt|;
name|vctl1
operator|=
operator|(
name|tv_mode
operator|->
name|nbr_end
operator|<<
name|TV_NBR_END_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|vi_end_f1
operator|<<
name|TV_VI_END_F1_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|vi_end_f2
operator|<<
name|TV_VI_END_F2_SHIFT
operator|)
expr_stmt|;
name|vctl2
operator|=
operator|(
name|tv_mode
operator|->
name|vsync_len
operator|<<
name|TV_VSYNC_LEN_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|vsync_start_f1
operator|<<
name|TV_VSYNC_START_F1_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|vsync_start_f2
operator|<<
name|TV_VSYNC_START_F2_SHIFT
operator|)
expr_stmt|;
name|vctl3
operator|=
operator|(
name|tv_mode
operator|->
name|veq_len
operator|<<
name|TV_VEQ_LEN_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|veq_start_f1
operator|<<
name|TV_VEQ_START_F1_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|veq_start_f2
operator|<<
name|TV_VEQ_START_F2_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|veq_ena
condition|)
name|vctl3
operator||=
name|TV_EQUAL_ENA
expr_stmt|;
name|vctl4
operator|=
operator|(
name|tv_mode
operator|->
name|vburst_start_f1
operator|<<
name|TV_VBURST_START_F1_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|vburst_end_f1
operator|<<
name|TV_VBURST_END_F1_SHIFT
operator|)
expr_stmt|;
name|vctl5
operator|=
operator|(
name|tv_mode
operator|->
name|vburst_start_f2
operator|<<
name|TV_VBURST_START_F2_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|vburst_end_f2
operator|<<
name|TV_VBURST_END_F2_SHIFT
operator|)
expr_stmt|;
name|vctl6
operator|=
operator|(
name|tv_mode
operator|->
name|vburst_start_f3
operator|<<
name|TV_VBURST_START_F3_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|vburst_end_f3
operator|<<
name|TV_VBURST_END_F3_SHIFT
operator|)
expr_stmt|;
name|vctl7
operator|=
operator|(
name|tv_mode
operator|->
name|vburst_start_f4
operator|<<
name|TV_VBURST_START_F4_SHIFT
operator|)
operator||
operator|(
name|tv_mode
operator|->
name|vburst_end_f4
operator|<<
name|TV_VBURST_END_F4_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|intel_crtc
operator|->
name|pipe
operator|==
literal|1
condition|)
name|tv_ctl
operator||=
name|TV_ENC_PIPEB_SELECT
expr_stmt|;
name|tv_ctl
operator||=
name|tv_mode
operator|->
name|oversample
expr_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|progressive
condition|)
name|tv_ctl
operator||=
name|TV_PROGRESSIVE
expr_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|trilevel_sync
condition|)
name|tv_ctl
operator||=
name|TV_TRILEVEL_SYNC
expr_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|pal_burst
condition|)
name|tv_ctl
operator||=
name|TV_PAL_BURST
expr_stmt|;
name|scctl1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|dda1_inc
condition|)
name|scctl1
operator||=
name|TV_SC_DDA1_EN
expr_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|dda2_inc
condition|)
name|scctl1
operator||=
name|TV_SC_DDA2_EN
expr_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|dda3_inc
condition|)
name|scctl1
operator||=
name|TV_SC_DDA3_EN
expr_stmt|;
name|scctl1
operator||=
name|tv_mode
operator|->
name|sc_reset
expr_stmt|;
if|if
condition|(
name|video_levels
condition|)
name|scctl1
operator||=
name|video_levels
operator|->
name|burst
operator|<<
name|TV_BURST_LEVEL_SHIFT
expr_stmt|;
name|scctl1
operator||=
name|tv_mode
operator|->
name|dda1_inc
operator|<<
name|TV_SCDDA1_INC_SHIFT
expr_stmt|;
name|scctl2
operator|=
name|tv_mode
operator|->
name|dda2_size
operator|<<
name|TV_SCDDA2_SIZE_SHIFT
operator||
name|tv_mode
operator|->
name|dda2_inc
operator|<<
name|TV_SCDDA2_INC_SHIFT
expr_stmt|;
name|scctl3
operator|=
name|tv_mode
operator|->
name|dda3_size
operator|<<
name|TV_SCDDA3_SIZE_SHIFT
operator||
name|tv_mode
operator|->
name|dda3_inc
operator|<<
name|TV_SCDDA3_INC_SHIFT
expr_stmt|;
comment|/* Enable two fixes for the chips that need them. */
if|if
condition|(
name|dev
operator|->
name|pci_device
operator|<
literal|0x2772
condition|)
name|tv_ctl
operator||=
name|TV_ENC_C0_FIX
operator||
name|TV_ENC_SDP_FIX
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_H_CTL_1
argument_list|,
name|hctl1
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_H_CTL_2
argument_list|,
name|hctl2
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_H_CTL_3
argument_list|,
name|hctl3
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_V_CTL_1
argument_list|,
name|vctl1
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_V_CTL_2
argument_list|,
name|vctl2
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_V_CTL_3
argument_list|,
name|vctl3
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_V_CTL_4
argument_list|,
name|vctl4
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_V_CTL_5
argument_list|,
name|vctl5
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_V_CTL_6
argument_list|,
name|vctl6
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_V_CTL_7
argument_list|,
name|vctl7
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_SC_CTL_1
argument_list|,
name|scctl1
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_SC_CTL_2
argument_list|,
name|scctl2
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_SC_CTL_3
argument_list|,
name|scctl3
argument_list|)
expr_stmt|;
if|if
condition|(
name|color_conversion
condition|)
block|{
name|I915_WRITE
argument_list|(
name|TV_CSC_Y
argument_list|,
operator|(
name|color_conversion
operator|->
name|ry
operator|<<
literal|16
operator|)
operator||
name|color_conversion
operator|->
name|gy
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_CSC_Y2
argument_list|,
operator|(
name|color_conversion
operator|->
name|by
operator|<<
literal|16
operator|)
operator||
name|color_conversion
operator|->
name|ay
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_CSC_U
argument_list|,
operator|(
name|color_conversion
operator|->
name|ru
operator|<<
literal|16
operator|)
operator||
name|color_conversion
operator|->
name|gu
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_CSC_U2
argument_list|,
operator|(
name|color_conversion
operator|->
name|bu
operator|<<
literal|16
operator|)
operator||
name|color_conversion
operator|->
name|au
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_CSC_V
argument_list|,
operator|(
name|color_conversion
operator|->
name|rv
operator|<<
literal|16
operator|)
operator||
name|color_conversion
operator|->
name|gv
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_CSC_V2
argument_list|,
operator|(
name|color_conversion
operator|->
name|bv
operator|<<
literal|16
operator|)
operator||
name|color_conversion
operator|->
name|av
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|INTEL_INFO
argument_list|(
name|dev
argument_list|)
operator|->
name|gen
operator|>=
literal|4
condition|)
name|I915_WRITE
argument_list|(
name|TV_CLR_KNOBS
argument_list|,
literal|0x00404000
argument_list|)
expr_stmt|;
else|else
name|I915_WRITE
argument_list|(
name|TV_CLR_KNOBS
argument_list|,
literal|0x00606000
argument_list|)
expr_stmt|;
if|if
condition|(
name|video_levels
condition|)
name|I915_WRITE
argument_list|(
name|TV_CLR_LEVEL
argument_list|,
operator|(
operator|(
name|video_levels
operator|->
name|black
operator|<<
name|TV_BLACK_LEVEL_SHIFT
operator|)
operator||
operator|(
name|video_levels
operator|->
name|blank
operator|<<
name|TV_BLANK_LEVEL_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
block|{
name|int
name|pipeconf_reg
init|=
name|PIPECONF
argument_list|(
name|pipe
argument_list|)
decl_stmt|;
name|int
name|dspcntr_reg
init|=
name|DSPCNTR
argument_list|(
name|intel_crtc
operator|->
name|plane
argument_list|)
decl_stmt|;
name|int
name|pipeconf
init|=
name|I915_READ
argument_list|(
name|pipeconf_reg
argument_list|)
decl_stmt|;
name|int
name|dspcntr
init|=
name|I915_READ
argument_list|(
name|dspcntr_reg
argument_list|)
decl_stmt|;
name|int
name|dspbase_reg
init|=
name|DSPADDR
argument_list|(
name|intel_crtc
operator|->
name|plane
argument_list|)
decl_stmt|;
name|int
name|xpos
init|=
literal|0x0
decl_stmt|,
name|ypos
init|=
literal|0x0
decl_stmt|;
name|unsigned
name|int
name|xsize
decl_stmt|,
name|ysize
decl_stmt|;
comment|/* Pipe must be off here */
name|I915_WRITE
argument_list|(
name|dspcntr_reg
argument_list|,
name|dspcntr
operator|&
operator|~
name|DISPLAY_PLANE_ENABLE
argument_list|)
expr_stmt|;
comment|/* Flush the plane changes */
name|I915_WRITE
argument_list|(
name|dspbase_reg
argument_list|,
name|I915_READ
argument_list|(
name|dspbase_reg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Wait for vblank for the disable to take effect */
if|if
condition|(
name|IS_GEN2
argument_list|(
name|dev
argument_list|)
condition|)
name|intel_wait_for_vblank
argument_list|(
name|dev
argument_list|,
name|intel_crtc
operator|->
name|pipe
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|pipeconf_reg
argument_list|,
name|pipeconf
operator|&
operator|~
name|PIPECONF_ENABLE
argument_list|)
expr_stmt|;
comment|/* Wait for vblank for the disable to take effect. */
name|intel_wait_for_pipe_off
argument_list|(
name|dev
argument_list|,
name|intel_crtc
operator|->
name|pipe
argument_list|)
expr_stmt|;
comment|/* Filter ctl must be set before TV_WIN_SIZE */
name|I915_WRITE
argument_list|(
name|TV_FILTER_CTL_1
argument_list|,
name|TV_AUTO_SCALE
argument_list|)
expr_stmt|;
name|xsize
operator|=
name|tv_mode
operator|->
name|hblank_start
operator|-
name|tv_mode
operator|->
name|hblank_end
expr_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|progressive
condition|)
name|ysize
operator|=
name|tv_mode
operator|->
name|nbr_end
operator|+
literal|1
expr_stmt|;
else|else
name|ysize
operator|=
literal|2
operator|*
name|tv_mode
operator|->
name|nbr_end
operator|+
literal|1
expr_stmt|;
name|xpos
operator|+=
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_LEFT
index|]
expr_stmt|;
name|ypos
operator|+=
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_TOP
index|]
expr_stmt|;
name|xsize
operator|-=
operator|(
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_LEFT
index|]
operator|+
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_RIGHT
index|]
operator|)
expr_stmt|;
name|ysize
operator|-=
operator|(
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_TOP
index|]
operator|+
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_BOTTOM
index|]
operator|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_WIN_POS
argument_list|,
operator|(
name|xpos
operator|<<
literal|16
operator|)
operator||
name|ypos
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_WIN_SIZE
argument_list|,
operator|(
name|xsize
operator|<<
literal|16
operator|)
operator||
name|ysize
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|pipeconf_reg
argument_list|,
name|pipeconf
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|dspcntr_reg
argument_list|,
name|dspcntr
argument_list|)
expr_stmt|;
comment|/* Flush the plane changes */
name|I915_WRITE
argument_list|(
name|dspbase_reg
argument_list|,
name|I915_READ
argument_list|(
name|dspbase_reg
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|60
condition|;
name|i
operator|++
control|)
name|I915_WRITE
argument_list|(
name|TV_H_LUMA_0
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
argument_list|,
name|tv_mode
operator|->
name|filter_table
index|[
name|j
operator|++
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|60
condition|;
name|i
operator|++
control|)
name|I915_WRITE
argument_list|(
name|TV_H_CHROMA_0
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
argument_list|,
name|tv_mode
operator|->
name|filter_table
index|[
name|j
operator|++
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|43
condition|;
name|i
operator|++
control|)
name|I915_WRITE
argument_list|(
name|TV_V_LUMA_0
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
argument_list|,
name|tv_mode
operator|->
name|filter_table
index|[
name|j
operator|++
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|43
condition|;
name|i
operator|++
control|)
name|I915_WRITE
argument_list|(
name|TV_V_CHROMA_0
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
argument_list|,
name|tv_mode
operator|->
name|filter_table
index|[
name|j
operator|++
index|]
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_DAC
argument_list|,
name|I915_READ
argument_list|(
name|TV_DAC
argument_list|)
operator|&
name|TV_DAC_SAVE
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_CTL
argument_list|,
name|tv_ctl
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_display_mode
name|reported_modes
index|[]
init|=
block|{
block|{
operator|.
name|name
operator|=
literal|"NTSC 480i"
block|,
operator|.
name|clock
operator|=
literal|107520
block|,
operator|.
name|hdisplay
operator|=
literal|1280
block|,
operator|.
name|hsync_start
operator|=
literal|1368
block|,
operator|.
name|hsync_end
operator|=
literal|1496
block|,
operator|.
name|htotal
operator|=
literal|1712
block|,
operator|.
name|vdisplay
operator|=
literal|1024
block|,
operator|.
name|vsync_start
operator|=
literal|1027
block|,
operator|.
name|vsync_end
operator|=
literal|1034
block|,
operator|.
name|vtotal
operator|=
literal|1104
block|,
operator|.
name|type
operator|=
name|DRM_MODE_TYPE_DRIVER
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * Detects TV presence by checking for load.  *  * Requires that the current pipe's DPLL is active.   * \return true if TV is connected.  * \return false if TV is disconnected.  */
end_comment

begin_function
specifier|static
name|int
name|intel_tv_detect_type
parameter_list|(
name|struct
name|intel_tv
modifier|*
name|intel_tv
parameter_list|,
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
name|struct
name|drm_encoder
modifier|*
name|encoder
init|=
operator|&
name|intel_tv
operator|->
name|base
operator|.
name|base
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
init|=
name|encoder
operator|->
name|crtc
decl_stmt|;
name|struct
name|intel_crtc
modifier|*
name|intel_crtc
init|=
name|to_intel_crtc
argument_list|(
name|crtc
argument_list|)
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u32
name|tv_ctl
decl_stmt|,
name|save_tv_ctl
decl_stmt|;
name|u32
name|tv_dac
decl_stmt|,
name|save_tv_dac
decl_stmt|;
name|int
name|type
decl_stmt|;
comment|/* Disable TV interrupts around load detect or we'll recurse */
if|if
condition|(
name|connector
operator|->
name|polled
operator|&
name|DRM_CONNECTOR_POLL_HPD
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|dev_priv
operator|->
name|irq_lock
argument_list|)
expr_stmt|;
name|i915_disable_pipestat
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|,
name|PIPE_HOTPLUG_INTERRUPT_ENABLE
operator||
name|PIPE_HOTPLUG_TV_INTERRUPT_ENABLE
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|irq_lock
argument_list|)
expr_stmt|;
block|}
name|save_tv_dac
operator|=
name|tv_dac
operator|=
name|I915_READ
argument_list|(
name|TV_DAC
argument_list|)
expr_stmt|;
name|save_tv_ctl
operator|=
name|tv_ctl
operator|=
name|I915_READ
argument_list|(
name|TV_CTL
argument_list|)
expr_stmt|;
comment|/* Poll for TV detection */
name|tv_ctl
operator|&=
operator|~
operator|(
name|TV_ENC_ENABLE
operator||
name|TV_TEST_MODE_MASK
operator|)
expr_stmt|;
name|tv_ctl
operator||=
name|TV_TEST_MODE_MONITOR_DETECT
expr_stmt|;
if|if
condition|(
name|intel_crtc
operator|->
name|pipe
operator|==
literal|1
condition|)
name|tv_ctl
operator||=
name|TV_ENC_PIPEB_SELECT
expr_stmt|;
else|else
name|tv_ctl
operator|&=
operator|~
name|TV_ENC_PIPEB_SELECT
expr_stmt|;
name|tv_dac
operator|&=
operator|~
operator|(
name|TVDAC_SENSE_MASK
operator||
name|DAC_A_MASK
operator||
name|DAC_B_MASK
operator||
name|DAC_C_MASK
operator|)
expr_stmt|;
name|tv_dac
operator||=
operator|(
name|TVDAC_STATE_CHG_EN
operator||
name|TVDAC_A_SENSE_CTL
operator||
name|TVDAC_B_SENSE_CTL
operator||
name|TVDAC_C_SENSE_CTL
operator||
name|DAC_CTL_OVERRIDE
operator||
name|DAC_A_0_7_V
operator||
name|DAC_B_0_7_V
operator||
name|DAC_C_0_7_V
operator|)
expr_stmt|;
comment|/* 	 * The TV sense state should be cleared to zero on cantiga platform. Otherwise 	 * the TV is misdetected. This is hardware requirement. 	 */
if|if
condition|(
name|IS_GM45
argument_list|(
name|dev
argument_list|)
condition|)
name|tv_dac
operator|&=
operator|~
operator|(
name|TVDAC_STATE_CHG_EN
operator||
name|TVDAC_A_SENSE_CTL
operator||
name|TVDAC_B_SENSE_CTL
operator||
name|TVDAC_C_SENSE_CTL
operator|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_CTL
argument_list|,
name|tv_ctl
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_DAC
argument_list|,
name|tv_dac
argument_list|)
expr_stmt|;
name|POSTING_READ
argument_list|(
name|TV_DAC
argument_list|)
expr_stmt|;
name|intel_wait_for_vblank
argument_list|(
name|intel_tv
operator|->
name|base
operator|.
name|base
operator|.
name|dev
argument_list|,
name|to_intel_crtc
argument_list|(
name|intel_tv
operator|->
name|base
operator|.
name|base
operator|.
name|crtc
argument_list|)
operator|->
name|pipe
argument_list|)
expr_stmt|;
name|type
operator|=
operator|-
literal|1
expr_stmt|;
name|tv_dac
operator|=
name|I915_READ
argument_list|(
name|TV_DAC
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"TV detected: %x, %x\n"
argument_list|,
name|tv_ctl
argument_list|,
name|tv_dac
argument_list|)
expr_stmt|;
comment|/* 	 *  A B C 	 *  0 1 1 Composite 	 *  1 0 X svideo 	 *  0 0 0 Component 	 */
if|if
condition|(
operator|(
name|tv_dac
operator|&
name|TVDAC_SENSE_MASK
operator|)
operator|==
operator|(
name|TVDAC_B_SENSE
operator||
name|TVDAC_C_SENSE
operator|)
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Detected Composite TV connection\n"
argument_list|)
expr_stmt|;
name|type
operator|=
name|DRM_MODE_CONNECTOR_Composite
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|tv_dac
operator|&
operator|(
name|TVDAC_A_SENSE
operator||
name|TVDAC_B_SENSE
operator|)
operator|)
operator|==
name|TVDAC_A_SENSE
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Detected S-Video TV connection\n"
argument_list|)
expr_stmt|;
name|type
operator|=
name|DRM_MODE_CONNECTOR_SVIDEO
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|tv_dac
operator|&
name|TVDAC_SENSE_MASK
operator|)
operator|==
literal|0
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Detected Component TV connection\n"
argument_list|)
expr_stmt|;
name|type
operator|=
name|DRM_MODE_CONNECTOR_Component
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Unrecognised TV connection\n"
argument_list|)
expr_stmt|;
name|type
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|I915_WRITE
argument_list|(
name|TV_DAC
argument_list|,
name|save_tv_dac
operator|&
operator|~
name|TVDAC_STATE_CHG_EN
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_CTL
argument_list|,
name|save_tv_ctl
argument_list|)
expr_stmt|;
comment|/* Restore interrupt config */
if|if
condition|(
name|connector
operator|->
name|polled
operator|&
name|DRM_CONNECTOR_POLL_HPD
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|dev_priv
operator|->
name|irq_lock
argument_list|)
expr_stmt|;
name|i915_enable_pipestat
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|,
name|PIPE_HOTPLUG_INTERRUPT_ENABLE
operator||
name|PIPE_HOTPLUG_TV_INTERRUPT_ENABLE
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|irq_lock
argument_list|)
expr_stmt|;
block|}
return|return
name|type
return|;
block|}
end_function

begin_comment
comment|/*  * Here we set accurate tv format according to connector type  * i.e Component TV should not be assigned by NTSC or PAL  */
end_comment

begin_function
specifier|static
name|void
name|intel_tv_find_better_format
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
name|struct
name|intel_tv
modifier|*
name|intel_tv
init|=
name|intel_attached_tv
argument_list|(
name|connector
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|tv_mode
modifier|*
name|tv_mode
init|=
name|intel_tv_mode_find
argument_list|(
name|intel_tv
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|intel_tv
operator|->
name|type
operator|==
name|DRM_MODE_CONNECTOR_Component
operator|)
operator|==
name|tv_mode
operator|->
name|component_only
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|tv_modes
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|tv_modes
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|tv_mode
operator|=
name|tv_modes
operator|+
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|intel_tv
operator|->
name|type
operator|==
name|DRM_MODE_CONNECTOR_Component
operator|)
operator|==
name|tv_mode
operator|->
name|component_only
condition|)
break|break;
block|}
name|intel_tv
operator|->
name|tv_format
operator|=
name|tv_mode
operator|->
name|name
expr_stmt|;
name|drm_object_property_set_value
argument_list|(
operator|&
name|connector
operator|->
name|base
argument_list|,
name|connector
operator|->
name|dev
operator|->
name|mode_config
operator|.
name|tv_mode_property
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Detect the TV connection.  *  * Currently this always returns CONNECTOR_STATUS_UNKNOWN, as we need to be sure  * we have a pipe programmed in order to probe the TV.  */
end_comment

begin_function
specifier|static
name|enum
name|drm_connector_status
name|intel_tv_detect
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|,
name|bool
name|force
parameter_list|)
block|{
name|struct
name|drm_display_mode
name|mode
decl_stmt|;
name|struct
name|intel_tv
modifier|*
name|intel_tv
init|=
name|intel_attached_tv
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|int
name|type
decl_stmt|;
name|mode
operator|=
name|reported_modes
index|[
literal|0
index|]
expr_stmt|;
name|drm_mode_set_crtcinfo
argument_list|(
operator|&
name|mode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|force
condition|)
block|{
name|struct
name|intel_load_detect_pipe
name|tmp
decl_stmt|;
if|if
condition|(
name|intel_get_load_detect_pipe
argument_list|(
operator|&
name|intel_tv
operator|->
name|base
argument_list|,
name|connector
argument_list|,
operator|&
name|mode
argument_list|,
operator|&
name|tmp
argument_list|)
condition|)
block|{
name|type
operator|=
name|intel_tv_detect_type
argument_list|(
name|intel_tv
argument_list|,
name|connector
argument_list|)
expr_stmt|;
name|intel_release_load_detect_pipe
argument_list|(
operator|&
name|intel_tv
operator|->
name|base
argument_list|,
name|connector
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
return|return
name|connector_status_unknown
return|;
block|}
else|else
return|return
name|connector
operator|->
name|status
return|;
if|if
condition|(
name|type
operator|<
literal|0
condition|)
return|return
name|connector_status_disconnected
return|;
name|intel_tv
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|intel_tv_find_better_format
argument_list|(
name|connector
argument_list|)
expr_stmt|;
return|return
name|connector_status_connected
return|;
block|}
end_function

begin_struct
specifier|static
specifier|const
struct|struct
name|input_res
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|w
decl_stmt|,
name|h
decl_stmt|;
block|}
name|input_res_table
index|[]
init|=
block|{
block|{
literal|"640x480"
block|,
literal|640
block|,
literal|480
block|}
block|,
block|{
literal|"800x600"
block|,
literal|800
block|,
literal|600
block|}
block|,
block|{
literal|"1024x768"
block|,
literal|1024
block|,
literal|768
block|}
block|,
block|{
literal|"1280x1024"
block|,
literal|1280
block|,
literal|1024
block|}
block|,
block|{
literal|"848x480"
block|,
literal|848
block|,
literal|480
block|}
block|,
block|{
literal|"1280x720"
block|,
literal|1280
block|,
literal|720
block|}
block|,
block|{
literal|"1920x1080"
block|,
literal|1920
block|,
literal|1080
block|}
block|, }
struct|;
end_struct

begin_comment
comment|/*  * Chose preferred mode  according to line number of TV format  */
end_comment

begin_function
specifier|static
name|void
name|intel_tv_chose_preferred_modes
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode_ptr
parameter_list|)
block|{
name|struct
name|intel_tv
modifier|*
name|intel_tv
init|=
name|intel_attached_tv
argument_list|(
name|connector
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|tv_mode
modifier|*
name|tv_mode
init|=
name|intel_tv_mode_find
argument_list|(
name|intel_tv
argument_list|)
decl_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|nbr_end
operator|<
literal|480
operator|&&
name|mode_ptr
operator|->
name|vdisplay
operator|==
literal|480
condition|)
name|mode_ptr
operator|->
name|type
operator||=
name|DRM_MODE_TYPE_PREFERRED
expr_stmt|;
elseif|else
if|if
condition|(
name|tv_mode
operator|->
name|nbr_end
operator|>
literal|480
condition|)
block|{
if|if
condition|(
name|tv_mode
operator|->
name|progressive
operator|==
name|true
operator|&&
name|tv_mode
operator|->
name|nbr_end
operator|<
literal|720
condition|)
block|{
if|if
condition|(
name|mode_ptr
operator|->
name|vdisplay
operator|==
literal|720
condition|)
name|mode_ptr
operator|->
name|type
operator||=
name|DRM_MODE_TYPE_PREFERRED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode_ptr
operator|->
name|vdisplay
operator|==
literal|1080
condition|)
name|mode_ptr
operator|->
name|type
operator||=
name|DRM_MODE_TYPE_PREFERRED
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * Stub get_modes function.  *  * This should probably return a set of fixed modes, unless we can figure out  * how to probe modes off of TV connections.  */
end_comment

begin_function
specifier|static
name|int
name|intel_tv_get_modes
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
name|struct
name|drm_display_mode
modifier|*
name|mode_ptr
decl_stmt|;
name|struct
name|intel_tv
modifier|*
name|intel_tv
init|=
name|intel_attached_tv
argument_list|(
name|connector
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|tv_mode
modifier|*
name|tv_mode
init|=
name|intel_tv_mode_find
argument_list|(
name|intel_tv
argument_list|)
decl_stmt|;
name|int
name|j
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|u64
name|tmp
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ARRAY_SIZE
argument_list|(
name|input_res_table
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
specifier|const
name|struct
name|input_res
modifier|*
name|input
init|=
operator|&
name|input_res_table
index|[
name|j
index|]
decl_stmt|;
name|unsigned
name|int
name|hactive_s
init|=
name|input
operator|->
name|w
decl_stmt|;
name|unsigned
name|int
name|vactive_s
init|=
name|input
operator|->
name|h
decl_stmt|;
if|if
condition|(
name|tv_mode
operator|->
name|max_srcw
operator|&&
name|input
operator|->
name|w
operator|>
name|tv_mode
operator|->
name|max_srcw
condition|)
continue|continue;
if|if
condition|(
name|input
operator|->
name|w
operator|>
literal|1024
operator|&&
operator|(
operator|!
name|tv_mode
operator|->
name|progressive
operator|&&
operator|!
name|tv_mode
operator|->
name|component_only
operator|)
condition|)
continue|continue;
name|mode_ptr
operator|=
name|drm_mode_create
argument_list|(
name|connector
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mode_ptr
condition|)
continue|continue;
name|strncpy
argument_list|(
name|mode_ptr
operator|->
name|name
argument_list|,
name|input
operator|->
name|name
argument_list|,
name|DRM_DISPLAY_MODE_LEN
argument_list|)
expr_stmt|;
name|mode_ptr
operator|->
name|hdisplay
operator|=
name|hactive_s
expr_stmt|;
name|mode_ptr
operator|->
name|hsync_start
operator|=
name|hactive_s
operator|+
literal|1
expr_stmt|;
name|mode_ptr
operator|->
name|hsync_end
operator|=
name|hactive_s
operator|+
literal|64
expr_stmt|;
if|if
condition|(
name|mode_ptr
operator|->
name|hsync_end
operator|<=
name|mode_ptr
operator|->
name|hsync_start
condition|)
name|mode_ptr
operator|->
name|hsync_end
operator|=
name|mode_ptr
operator|->
name|hsync_start
operator|+
literal|1
expr_stmt|;
name|mode_ptr
operator|->
name|htotal
operator|=
name|hactive_s
operator|+
literal|96
expr_stmt|;
name|mode_ptr
operator|->
name|vdisplay
operator|=
name|vactive_s
expr_stmt|;
name|mode_ptr
operator|->
name|vsync_start
operator|=
name|vactive_s
operator|+
literal|1
expr_stmt|;
name|mode_ptr
operator|->
name|vsync_end
operator|=
name|vactive_s
operator|+
literal|32
expr_stmt|;
if|if
condition|(
name|mode_ptr
operator|->
name|vsync_end
operator|<=
name|mode_ptr
operator|->
name|vsync_start
condition|)
name|mode_ptr
operator|->
name|vsync_end
operator|=
name|mode_ptr
operator|->
name|vsync_start
operator|+
literal|1
expr_stmt|;
name|mode_ptr
operator|->
name|vtotal
operator|=
name|vactive_s
operator|+
literal|33
expr_stmt|;
name|tmp
operator|=
operator|(
name|u64
operator|)
name|tv_mode
operator|->
name|refresh
operator|*
name|mode_ptr
operator|->
name|vtotal
expr_stmt|;
name|tmp
operator|*=
name|mode_ptr
operator|->
name|htotal
expr_stmt|;
name|tmp
operator|=
name|tmp
operator|/
literal|1000000
expr_stmt|;
name|mode_ptr
operator|->
name|clock
operator|=
operator|(
name|int
operator|)
name|tmp
expr_stmt|;
name|mode_ptr
operator|->
name|type
operator|=
name|DRM_MODE_TYPE_DRIVER
expr_stmt|;
name|intel_tv_chose_preferred_modes
argument_list|(
name|connector
argument_list|,
name|mode_ptr
argument_list|)
expr_stmt|;
name|drm_mode_probed_add
argument_list|(
name|connector
argument_list|,
name|mode_ptr
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|intel_tv_destroy
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|)
block|{
if|#
directive|if
literal|0
block|drm_sysfs_connector_remove(connector);
endif|#
directive|endif
name|drm_connector_cleanup
argument_list|(
name|connector
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|connector
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|intel_tv_set_property
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|,
name|struct
name|drm_property
modifier|*
name|property
parameter_list|,
name|uint64_t
name|val
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|connector
operator|->
name|dev
decl_stmt|;
name|struct
name|intel_tv
modifier|*
name|intel_tv
init|=
name|intel_attached_tv
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|struct
name|drm_crtc
modifier|*
name|crtc
init|=
name|intel_tv
operator|->
name|base
operator|.
name|base
operator|.
name|crtc
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|bool
name|changed
init|=
name|false
decl_stmt|;
name|ret
operator|=
name|drm_object_property_set_value
argument_list|(
operator|&
name|connector
operator|->
name|base
argument_list|,
name|property
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|property
operator|==
name|dev
operator|->
name|mode_config
operator|.
name|tv_left_margin_property
operator|&&
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_LEFT
index|]
operator|!=
name|val
condition|)
block|{
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_LEFT
index|]
operator|=
name|val
expr_stmt|;
name|changed
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|property
operator|==
name|dev
operator|->
name|mode_config
operator|.
name|tv_right_margin_property
operator|&&
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_RIGHT
index|]
operator|!=
name|val
condition|)
block|{
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_RIGHT
index|]
operator|=
name|val
expr_stmt|;
name|changed
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|property
operator|==
name|dev
operator|->
name|mode_config
operator|.
name|tv_top_margin_property
operator|&&
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_TOP
index|]
operator|!=
name|val
condition|)
block|{
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_TOP
index|]
operator|=
name|val
expr_stmt|;
name|changed
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|property
operator|==
name|dev
operator|->
name|mode_config
operator|.
name|tv_bottom_margin_property
operator|&&
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_BOTTOM
index|]
operator|!=
name|val
condition|)
block|{
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_BOTTOM
index|]
operator|=
name|val
expr_stmt|;
name|changed
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|property
operator|==
name|dev
operator|->
name|mode_config
operator|.
name|tv_mode_property
condition|)
block|{
if|if
condition|(
name|val
operator|>=
name|ARRAY_SIZE
argument_list|(
name|tv_modes
argument_list|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|intel_tv
operator|->
name|tv_format
argument_list|,
name|tv_modes
index|[
name|val
index|]
operator|.
name|name
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|intel_tv
operator|->
name|tv_format
operator|=
name|tv_modes
index|[
name|val
index|]
operator|.
name|name
expr_stmt|;
name|changed
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|changed
operator|&&
name|crtc
condition|)
name|drm_crtc_helper_set_mode
argument_list|(
name|crtc
argument_list|,
operator|&
name|crtc
operator|->
name|mode
argument_list|,
name|crtc
operator|->
name|x
argument_list|,
name|crtc
operator|->
name|y
argument_list|,
name|crtc
operator|->
name|fb
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_helper_funcs
name|intel_tv_helper_funcs
init|=
block|{
operator|.
name|dpms
operator|=
name|intel_tv_dpms
block|,
operator|.
name|mode_fixup
operator|=
name|intel_tv_mode_fixup
block|,
operator|.
name|prepare
operator|=
name|intel_encoder_prepare
block|,
operator|.
name|mode_set
operator|=
name|intel_tv_mode_set
block|,
operator|.
name|commit
operator|=
name|intel_encoder_commit
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_connector_funcs
name|intel_tv_connector_funcs
init|=
block|{
operator|.
name|dpms
operator|=
name|drm_helper_connector_dpms
block|,
operator|.
name|detect
operator|=
name|intel_tv_detect
block|,
operator|.
name|destroy
operator|=
name|intel_tv_destroy
block|,
operator|.
name|set_property
operator|=
name|intel_tv_set_property
block|,
operator|.
name|fill_modes
operator|=
name|drm_helper_probe_single_connector_modes
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_connector_helper_funcs
name|intel_tv_connector_helper_funcs
init|=
block|{
operator|.
name|mode_valid
operator|=
name|intel_tv_mode_valid
block|,
operator|.
name|get_modes
operator|=
name|intel_tv_get_modes
block|,
operator|.
name|best_encoder
operator|=
name|intel_best_encoder
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_funcs
name|intel_tv_enc_funcs
init|=
block|{
operator|.
name|destroy
operator|=
name|intel_encoder_destroy
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Enumerate the child dev array parsed from VBT to check whether  * the integrated TV is present.  * If it is present, return 1.  * If it is not present, return false.  * If no child dev is parsed from VBT, it assumes that the TV is present.  */
end_comment

begin_function
specifier|static
name|int
name|tv_is_present_in_vbt
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|child_device_config
modifier|*
name|p_child
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|child_dev_num
condition|)
return|return
literal|1
return|;
name|ret
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|child_dev_num
condition|;
name|i
operator|++
control|)
block|{
name|p_child
operator|=
name|dev_priv
operator|->
name|child_dev
operator|+
name|i
expr_stmt|;
comment|/* 		 * If the device type is not TV, continue. 		 */
if|if
condition|(
name|p_child
operator|->
name|device_type
operator|!=
name|DEVICE_TYPE_INT_TV
operator|&&
name|p_child
operator|->
name|device_type
operator|!=
name|DEVICE_TYPE_TV
condition|)
continue|continue;
comment|/* Only when the addin_offset is non-zero, it is regarded 		 * as present. 		 */
if|if
condition|(
name|p_child
operator|->
name|addin_offset
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|intel_tv_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_connector
modifier|*
name|connector
decl_stmt|;
name|struct
name|intel_tv
modifier|*
name|intel_tv
decl_stmt|;
name|struct
name|intel_encoder
modifier|*
name|intel_encoder
decl_stmt|;
name|struct
name|intel_connector
modifier|*
name|intel_connector
decl_stmt|;
name|u32
name|tv_dac_on
decl_stmt|,
name|tv_dac_off
decl_stmt|,
name|save_tv_dac
decl_stmt|;
name|char
modifier|*
name|tv_format_names
index|[
name|ARRAY_SIZE
argument_list|(
name|tv_modes
argument_list|)
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|initial_mode
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|I915_READ
argument_list|(
name|TV_CTL
argument_list|)
operator|&
name|TV_FUSE_STATE_MASK
operator|)
operator|==
name|TV_FUSE_STATE_DISABLED
condition|)
return|return;
if|if
condition|(
operator|!
name|tv_is_present_in_vbt
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Integrated TV is not present.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Even if we have an encoder we may not have a connector */
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|int_tv_support
condition|)
return|return;
comment|/* 	 * Sanity check the TV output by checking to see if the 	 * DAC register holds a value 	 */
name|save_tv_dac
operator|=
name|I915_READ
argument_list|(
name|TV_DAC
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_DAC
argument_list|,
name|save_tv_dac
operator||
name|TVDAC_STATE_CHG_EN
argument_list|)
expr_stmt|;
name|tv_dac_on
operator|=
name|I915_READ
argument_list|(
name|TV_DAC
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_DAC
argument_list|,
name|save_tv_dac
operator|&
operator|~
name|TVDAC_STATE_CHG_EN
argument_list|)
expr_stmt|;
name|tv_dac_off
operator|=
name|I915_READ
argument_list|(
name|TV_DAC
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|TV_DAC
argument_list|,
name|save_tv_dac
argument_list|)
expr_stmt|;
comment|/* 	 * If the register does not hold the state change enable 	 * bit, (either as a 0 or a 1), assume it doesn't really 	 * exist 	 */
if|if
condition|(
operator|(
name|tv_dac_on
operator|&
name|TVDAC_STATE_CHG_EN
operator|)
operator|==
literal|0
operator|||
operator|(
name|tv_dac_off
operator|&
name|TVDAC_STATE_CHG_EN
operator|)
operator|!=
literal|0
condition|)
return|return;
name|intel_tv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|intel_tv
argument_list|)
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|intel_connector
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|intel_connector
argument_list|)
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|intel_encoder
operator|=
operator|&
name|intel_tv
operator|->
name|base
expr_stmt|;
name|connector
operator|=
operator|&
name|intel_connector
operator|->
name|base
expr_stmt|;
comment|/* The documentation, for the older chipsets at least, recommend 	 * using a polling method rather than hotplug detection for TVs. 	 * This is because in order to perform the hotplug detection, the PLLs 	 * for the TV must be kept alive increasing power drain and starving 	 * bandwidth from other encoders. Notably for instance, it causes 	 * pipe underruns on Crestline when this encoder is supposedly idle. 	 * 	 * More recent chipsets favour HDMI rather than integrated S-Video. 	 */
name|connector
operator|->
name|polled
operator|=
name|DRM_CONNECTOR_POLL_CONNECT
expr_stmt|;
name|drm_connector_init
argument_list|(
name|dev
argument_list|,
name|connector
argument_list|,
operator|&
name|intel_tv_connector_funcs
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|)
expr_stmt|;
name|drm_encoder_init
argument_list|(
name|dev
argument_list|,
operator|&
name|intel_encoder
operator|->
name|base
argument_list|,
operator|&
name|intel_tv_enc_funcs
argument_list|,
name|DRM_MODE_ENCODER_TVDAC
argument_list|)
expr_stmt|;
name|intel_connector_attach_encoder
argument_list|(
name|intel_connector
argument_list|,
name|intel_encoder
argument_list|)
expr_stmt|;
name|intel_encoder
operator|->
name|type
operator|=
name|INTEL_OUTPUT_TVOUT
expr_stmt|;
name|intel_encoder
operator|->
name|crtc_mask
operator|=
operator|(
literal|1
operator|<<
literal|0
operator|)
operator||
operator|(
literal|1
operator|<<
literal|1
operator|)
expr_stmt|;
name|intel_encoder
operator|->
name|clone_mask
operator|=
operator|(
literal|1
operator|<<
name|INTEL_TV_CLONE_BIT
operator|)
expr_stmt|;
name|intel_encoder
operator|->
name|base
operator|.
name|possible_crtcs
operator|=
operator|(
operator|(
literal|1
operator|<<
literal|0
operator|)
operator||
operator|(
literal|1
operator|<<
literal|1
operator|)
operator|)
expr_stmt|;
name|intel_encoder
operator|->
name|base
operator|.
name|possible_clones
operator|=
operator|(
literal|1
operator|<<
name|INTEL_OUTPUT_TVOUT
operator|)
expr_stmt|;
name|intel_tv
operator|->
name|type
operator|=
name|DRM_MODE_CONNECTOR_Unknown
expr_stmt|;
comment|/* BIOS margin values */
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_LEFT
index|]
operator|=
literal|54
expr_stmt|;
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_TOP
index|]
operator|=
literal|36
expr_stmt|;
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_RIGHT
index|]
operator|=
literal|46
expr_stmt|;
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_BOTTOM
index|]
operator|=
literal|37
expr_stmt|;
name|intel_tv
operator|->
name|tv_format
operator|=
name|tv_modes
index|[
name|initial_mode
index|]
operator|.
name|name
expr_stmt|;
name|drm_encoder_helper_add
argument_list|(
operator|&
name|intel_encoder
operator|->
name|base
argument_list|,
operator|&
name|intel_tv_helper_funcs
argument_list|)
expr_stmt|;
name|drm_connector_helper_add
argument_list|(
name|connector
argument_list|,
operator|&
name|intel_tv_connector_helper_funcs
argument_list|)
expr_stmt|;
name|connector
operator|->
name|interlace_allowed
operator|=
name|false
expr_stmt|;
name|connector
operator|->
name|doublescan_allowed
operator|=
name|false
expr_stmt|;
comment|/* Create TV properties then attach current values */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|tv_modes
argument_list|)
condition|;
name|i
operator|++
control|)
name|tv_format_names
index|[
name|i
index|]
operator|=
name|__DECONST
argument_list|(
name|char
operator|*
argument_list|,
name|tv_modes
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|drm_mode_create_tv_properties
argument_list|(
name|dev
argument_list|,
name|ARRAY_SIZE
argument_list|(
name|tv_modes
argument_list|)
argument_list|,
name|tv_format_names
argument_list|)
expr_stmt|;
name|drm_object_attach_property
argument_list|(
operator|&
name|connector
operator|->
name|base
argument_list|,
name|dev
operator|->
name|mode_config
operator|.
name|tv_mode_property
argument_list|,
name|initial_mode
argument_list|)
expr_stmt|;
name|drm_object_attach_property
argument_list|(
operator|&
name|connector
operator|->
name|base
argument_list|,
name|dev
operator|->
name|mode_config
operator|.
name|tv_left_margin_property
argument_list|,
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_LEFT
index|]
argument_list|)
expr_stmt|;
name|drm_object_attach_property
argument_list|(
operator|&
name|connector
operator|->
name|base
argument_list|,
name|dev
operator|->
name|mode_config
operator|.
name|tv_top_margin_property
argument_list|,
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_TOP
index|]
argument_list|)
expr_stmt|;
name|drm_object_attach_property
argument_list|(
operator|&
name|connector
operator|->
name|base
argument_list|,
name|dev
operator|->
name|mode_config
operator|.
name|tv_right_margin_property
argument_list|,
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_RIGHT
index|]
argument_list|)
expr_stmt|;
name|drm_object_attach_property
argument_list|(
operator|&
name|connector
operator|->
name|base
argument_list|,
name|dev
operator|->
name|mode_config
operator|.
name|tv_bottom_margin_property
argument_list|,
name|intel_tv
operator|->
name|margin
index|[
name|TV_MARGIN_BOTTOM
index|]
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|drm_sysfs_connector_add(connector);
endif|#
directive|endif
block|}
end_function

end_unit


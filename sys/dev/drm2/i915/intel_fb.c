begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright Â© 2007 David Airlie  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *     David Airlie  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_syscons.h"
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_fb_helper.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/i915_drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/i915_drv.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/intel_drv.h>
end_include

begin_function
specifier|static
name|int
name|intelfb_create
parameter_list|(
name|struct
name|intel_fbdev
modifier|*
name|ifbdev
parameter_list|,
name|struct
name|drm_fb_helper_surface_size
modifier|*
name|sizes
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|ifbdev
operator|->
name|helper
operator|.
name|dev
decl_stmt|;
if|#
directive|if
literal|0
block|struct drm_i915_private *dev_priv = dev->dev_private;
endif|#
directive|endif
name|struct
name|fb_info
modifier|*
name|info
decl_stmt|;
name|struct
name|drm_framebuffer
modifier|*
name|fb
decl_stmt|;
name|struct
name|drm_mode_fb_cmd2
name|mode_cmd
decl_stmt|;
name|struct
name|drm_i915_gem_object
modifier|*
name|obj
decl_stmt|;
name|int
name|size
decl_stmt|,
name|ret
decl_stmt|;
comment|/* we don't do packed 24bpp */
if|if
condition|(
name|sizes
operator|->
name|surface_bpp
operator|==
literal|24
condition|)
name|sizes
operator|->
name|surface_bpp
operator|=
literal|32
expr_stmt|;
name|mode_cmd
operator|.
name|width
operator|=
name|sizes
operator|->
name|surface_width
expr_stmt|;
name|mode_cmd
operator|.
name|height
operator|=
name|sizes
operator|->
name|surface_height
expr_stmt|;
name|mode_cmd
operator|.
name|pitches
index|[
literal|0
index|]
operator|=
name|roundup2
argument_list|(
name|mode_cmd
operator|.
name|width
operator|*
operator|(
operator|(
name|sizes
operator|->
name|surface_bpp
operator|+
literal|7
operator|)
operator|/
literal|8
operator|)
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|mode_cmd
operator|.
name|pixel_format
operator|=
name|drm_mode_legacy_fb_format
argument_list|(
name|sizes
operator|->
name|surface_bpp
argument_list|,
name|sizes
operator|->
name|surface_depth
argument_list|)
expr_stmt|;
name|size
operator|=
name|mode_cmd
operator|.
name|pitches
index|[
literal|0
index|]
operator|*
name|mode_cmd
operator|.
name|height
expr_stmt|;
name|size
operator|=
name|roundup2
argument_list|(
name|size
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|obj
operator|=
name|i915_gem_alloc_object
argument_list|(
name|dev
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|obj
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to allocate framebuffer\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|DRM_LOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Flush everything out, we'll be doing GTT only from now on */
name|ret
operator|=
name|intel_pin_and_fence_fb_obj
argument_list|(
name|dev
argument_list|,
name|obj
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to pin fb: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out_unref
goto|;
block|}
if|#
directive|if
literal|0
block|info = framebuffer_alloc(0, device); 	if (!info) { 		ret = -ENOMEM; 		goto out_unpin; 	}  	info->par = ifbdev;
else|#
directive|else
name|info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|fb_info
argument_list|)
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|info
operator|->
name|fb_size
operator|=
name|size
expr_stmt|;
name|info
operator|->
name|fb_bpp
operator|=
name|sizes
operator|->
name|surface_bpp
expr_stmt|;
name|info
operator|->
name|fb_width
operator|=
name|sizes
operator|->
name|fb_width
expr_stmt|;
name|info
operator|->
name|fb_height
operator|=
name|sizes
operator|->
name|fb_height
expr_stmt|;
name|info
operator|->
name|fb_pbase
operator|=
name|dev
operator|->
name|agp
operator|->
name|base
operator|+
name|obj
operator|->
name|gtt_offset
expr_stmt|;
name|info
operator|->
name|fb_vbase
operator|=
operator|(
name|vm_offset_t
operator|)
name|pmap_mapdev_attr
argument_list|(
name|info
operator|->
name|fb_pbase
argument_list|,
name|size
argument_list|,
name|PAT_WRITE_COMBINING
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ret
operator|=
name|intel_framebuffer_init
argument_list|(
name|dev
argument_list|,
operator|&
name|ifbdev
operator|->
name|ifb
argument_list|,
operator|&
name|mode_cmd
argument_list|,
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out_unpin
goto|;
name|fb
operator|=
operator|&
name|ifbdev
operator|->
name|ifb
operator|.
name|base
expr_stmt|;
name|ifbdev
operator|->
name|helper
operator|.
name|fb
operator|=
name|fb
expr_stmt|;
name|ifbdev
operator|->
name|helper
operator|.
name|fbdev
operator|=
name|info
expr_stmt|;
if|#
directive|if
literal|0
block|strcpy(info->fix.id, "inteldrmfb");  	info->flags = FBINFO_DEFAULT | FBINFO_CAN_FORCE_OUTPUT; 	info->fbops =&intelfb_ops;  	ret = fb_alloc_cmap(&info->cmap, 256, 0); 	if (ret) { 		ret = -ENOMEM; 		goto out_unpin; 	}
comment|/* setup aperture base/size for vesafb takeover */
block|info->apertures = alloc_apertures(1); 	if (!info->apertures) { 		ret = -ENOMEM; 		goto out_unpin; 	} 	info->apertures->ranges[0].base = dev->mode_config.fb_base; 	info->apertures->ranges[0].size = 		dev_priv->mm.gtt->gtt_mappable_entries<< PAGE_SHIFT;  	info->fix.smem_start = dev->mode_config.fb_base + obj->gtt_offset; 	info->fix.smem_len = size;  	info->screen_base = ioremap_wc(dev->agp->base + obj->gtt_offset, size); 	if (!info->screen_base) { 		ret = -ENOSPC; 		goto out_unpin; 	} 	info->screen_size = size;
comment|//	memset(info->screen_base, 0, size);
block|drm_fb_helper_fill_fix(info, fb->pitches[0], fb->depth); 	drm_fb_helper_fill_var(info,&ifbdev->helper, sizes->fb_width, sizes->fb_height);
comment|/* Use default scratch pixmap (info->pixmap.flags = FB_PIXMAP_SYSTEM) */
endif|#
directive|endif
name|DRM_DEBUG_KMS
argument_list|(
literal|"allocated %dx%d (s %dbits) fb: 0x%08x, bo %p\n"
argument_list|,
name|fb
operator|->
name|width
argument_list|,
name|fb
operator|->
name|height
argument_list|,
name|fb
operator|->
name|depth
argument_list|,
name|obj
operator|->
name|gtt_offset
argument_list|,
name|obj
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|#
directive|if
literal|1
name|KIB_NOTYET
argument_list|()
expr_stmt|;
else|#
directive|else
name|vga_switcheroo_client_fb_set
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
name|info
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
name|out_unpin
label|:
name|i915_gem_object_unpin
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|out_unref
label|:
name|drm_gem_object_unreference
argument_list|(
operator|&
name|obj
operator|->
name|base
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|intel_fb_find_or_create_single
parameter_list|(
name|struct
name|drm_fb_helper
modifier|*
name|helper
parameter_list|,
name|struct
name|drm_fb_helper_surface_size
modifier|*
name|sizes
parameter_list|)
block|{
name|struct
name|intel_fbdev
modifier|*
name|ifbdev
init|=
operator|(
expr|struct
name|intel_fbdev
operator|*
operator|)
name|helper
decl_stmt|;
name|int
name|new_fb
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|helper
operator|->
name|fb
condition|)
block|{
name|ret
operator|=
name|intelfb_create
argument_list|(
name|ifbdev
argument_list|,
name|sizes
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|new_fb
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|new_fb
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|drm_fb_helper_funcs
name|intel_fb_helper_funcs
init|=
block|{
operator|.
name|gamma_set
operator|=
name|intel_crtc_fb_gamma_set
block|,
operator|.
name|gamma_get
operator|=
name|intel_crtc_fb_gamma_get
block|,
operator|.
name|fb_probe
operator|=
name|intel_fb_find_or_create_single
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|intel_fbdev_destroy
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|intel_fbdev
modifier|*
name|ifbdev
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct fb_info *info;
endif|#
directive|endif
name|struct
name|intel_framebuffer
modifier|*
name|ifb
init|=
operator|&
name|ifbdev
operator|->
name|ifb
decl_stmt|;
if|#
directive|if
literal|0
block|if (ifbdev->helper.fbdev) { 		info = ifbdev->helper.fbdev; 		unregister_framebuffer(info); 		iounmap(info->screen_base); 		if (info->cmap.len) 			fb_dealloc_cmap(&info->cmap); 		framebuffer_release(info); 	}
endif|#
directive|endif
name|drm_fb_helper_fini
argument_list|(
operator|&
name|ifbdev
operator|->
name|helper
argument_list|)
expr_stmt|;
name|drm_framebuffer_cleanup
argument_list|(
operator|&
name|ifb
operator|->
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifb
operator|->
name|obj
condition|)
block|{
name|drm_gem_object_unreference_unlocked
argument_list|(
operator|&
name|ifb
operator|->
name|obj
operator|->
name|base
argument_list|)
expr_stmt|;
name|ifb
operator|->
name|obj
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEV_SC
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|sc_txtmouse_no_retrace_wait
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|intel_fbdev_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|intel_fbdev
modifier|*
name|ifbdev
decl_stmt|;
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ifbdev
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|intel_fbdev
argument_list|)
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|fbdev
operator|=
name|ifbdev
expr_stmt|;
name|ifbdev
operator|->
name|helper
operator|.
name|funcs
operator|=
operator|&
name|intel_fb_helper_funcs
expr_stmt|;
name|ret
operator|=
name|drm_fb_helper_init
argument_list|(
name|dev
argument_list|,
operator|&
name|ifbdev
operator|->
name|helper
argument_list|,
name|dev_priv
operator|->
name|num_pipe
argument_list|,
name|INTELFB_CONN_LIMIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|ifbdev
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|drm_fb_helper_single_add_all_connectors
argument_list|(
operator|&
name|ifbdev
operator|->
name|helper
argument_list|)
expr_stmt|;
name|drm_fb_helper_initial_config
argument_list|(
operator|&
name|ifbdev
operator|->
name|helper
argument_list|,
literal|32
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEV_SC
name|sc_txtmouse_no_retrace_wait
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|intel_fbdev_fini
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|fbdev
condition|)
return|return;
name|intel_fbdev_destroy
argument_list|(
name|dev
argument_list|,
name|dev_priv
operator|->
name|fbdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dev_priv
operator|->
name|fbdev
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|fbdev
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|intel_fb_output_poll_changed
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_fb_helper_hotplug_event
argument_list|(
operator|&
name|dev_priv
operator|->
name|fbdev
operator|->
name|helper
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|intel_fb_restore_mode
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_mode_config
modifier|*
name|config
init|=
operator|&
name|dev
operator|->
name|mode_config
decl_stmt|;
name|struct
name|drm_plane
modifier|*
name|plane
decl_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
name|ret
operator|=
name|drm_fb_helper_restore_fbdev_mode
argument_list|(
operator|&
name|dev_priv
operator|->
name|fbdev
operator|->
name|helper
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_DEBUG
argument_list|(
literal|"failed to restore crtc mode\n"
argument_list|)
expr_stmt|;
comment|/* Be sure to shut off any planes that may be active */
name|list_for_each_entry
argument_list|(
argument|plane
argument_list|,
argument|&config->plane_list
argument_list|,
argument|head
argument_list|)
name|plane
operator|->
name|funcs
operator|->
name|disable_plane
argument_list|(
name|plane
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


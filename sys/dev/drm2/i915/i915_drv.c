begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* i915_drv.c -- Intel i915 driver -*- linux-c -*-  * Created: Wed Feb 14 17:10:04 2001 by gareth@valinux.com  */
end_comment

begin_comment
comment|/*-  * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Gareth Hughes<gareth@valinux.com>  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_mm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/i915_drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/i915_drv.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_pciids.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/intel_drv.h>
end_include

begin_comment
comment|/* drv_PCI_IDs comes from drm_pciids.h, generated from drm_pciids.txt. */
end_comment

begin_decl_stmt
specifier|static
name|drm_pci_id_list_t
name|i915_pciidlist
index|[]
init|=
block|{
name|i915_PCI_IDS
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_i830_info
init|=
block|{
operator|.
name|gen
operator|=
literal|2
block|,
operator|.
name|is_mobile
operator|=
literal|1
block|,
operator|.
name|cursor_needs_physical
operator|=
literal|1
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|,
operator|.
name|overlay_needs_physical
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_845g_info
init|=
block|{
operator|.
name|gen
operator|=
literal|2
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|,
operator|.
name|overlay_needs_physical
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_i85x_info
init|=
block|{
operator|.
name|gen
operator|=
literal|2
block|,
operator|.
name|is_i85x
operator|=
literal|1
block|,
operator|.
name|is_mobile
operator|=
literal|1
block|,
operator|.
name|cursor_needs_physical
operator|=
literal|1
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|,
operator|.
name|overlay_needs_physical
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_i865g_info
init|=
block|{
operator|.
name|gen
operator|=
literal|2
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|,
operator|.
name|overlay_needs_physical
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_i915g_info
init|=
block|{
operator|.
name|gen
operator|=
literal|3
block|,
operator|.
name|is_i915g
operator|=
literal|1
block|,
operator|.
name|cursor_needs_physical
operator|=
literal|1
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|,
operator|.
name|overlay_needs_physical
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_i915gm_info
init|=
block|{
operator|.
name|gen
operator|=
literal|3
block|,
operator|.
name|is_mobile
operator|=
literal|1
block|,
operator|.
name|cursor_needs_physical
operator|=
literal|1
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|,
operator|.
name|overlay_needs_physical
operator|=
literal|1
block|,
operator|.
name|supports_tv
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_i945g_info
init|=
block|{
operator|.
name|gen
operator|=
literal|3
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|cursor_needs_physical
operator|=
literal|1
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|,
operator|.
name|overlay_needs_physical
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_i945gm_info
init|=
block|{
operator|.
name|gen
operator|=
literal|3
block|,
operator|.
name|is_i945gm
operator|=
literal|1
block|,
operator|.
name|is_mobile
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|cursor_needs_physical
operator|=
literal|1
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|,
operator|.
name|overlay_needs_physical
operator|=
literal|1
block|,
operator|.
name|supports_tv
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_i965g_info
init|=
block|{
operator|.
name|gen
operator|=
literal|4
block|,
operator|.
name|is_broadwater
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_i965gm_info
init|=
block|{
operator|.
name|gen
operator|=
literal|4
block|,
operator|.
name|is_crestline
operator|=
literal|1
block|,
operator|.
name|is_mobile
operator|=
literal|1
block|,
operator|.
name|has_fbc
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|,
operator|.
name|supports_tv
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_g33_info
init|=
block|{
operator|.
name|gen
operator|=
literal|3
block|,
operator|.
name|is_g33
operator|=
literal|1
block|,
operator|.
name|need_gfx_hws
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_g45_info
init|=
block|{
operator|.
name|gen
operator|=
literal|4
block|,
operator|.
name|is_g4x
operator|=
literal|1
block|,
operator|.
name|need_gfx_hws
operator|=
literal|1
block|,
operator|.
name|has_pipe_cxsr
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_bsd_ring
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_gm45_info
init|=
block|{
operator|.
name|gen
operator|=
literal|4
block|,
operator|.
name|is_g4x
operator|=
literal|1
block|,
operator|.
name|is_mobile
operator|=
literal|1
block|,
operator|.
name|need_gfx_hws
operator|=
literal|1
block|,
operator|.
name|has_fbc
operator|=
literal|1
block|,
operator|.
name|has_pipe_cxsr
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|supports_tv
operator|=
literal|1
block|,
operator|.
name|has_bsd_ring
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_pineview_info
init|=
block|{
operator|.
name|gen
operator|=
literal|3
block|,
operator|.
name|is_g33
operator|=
literal|1
block|,
operator|.
name|is_pineview
operator|=
literal|1
block|,
operator|.
name|is_mobile
operator|=
literal|1
block|,
operator|.
name|need_gfx_hws
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_overlay
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_ironlake_d_info
init|=
block|{
operator|.
name|gen
operator|=
literal|5
block|,
operator|.
name|need_gfx_hws
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_bsd_ring
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_ironlake_m_info
init|=
block|{
operator|.
name|gen
operator|=
literal|5
block|,
operator|.
name|is_mobile
operator|=
literal|1
block|,
operator|.
name|need_gfx_hws
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_fbc
operator|=
literal|0
block|,
comment|/* disabled due to buggy hardware */
operator|.
name|has_bsd_ring
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_sandybridge_d_info
init|=
block|{
operator|.
name|gen
operator|=
literal|6
block|,
operator|.
name|need_gfx_hws
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_bsd_ring
operator|=
literal|1
block|,
operator|.
name|has_blt_ring
operator|=
literal|1
block|,
operator|.
name|has_llc
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_sandybridge_m_info
init|=
block|{
operator|.
name|gen
operator|=
literal|6
block|,
operator|.
name|is_mobile
operator|=
literal|1
block|,
operator|.
name|need_gfx_hws
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_fbc
operator|=
literal|1
block|,
operator|.
name|has_bsd_ring
operator|=
literal|1
block|,
operator|.
name|has_blt_ring
operator|=
literal|1
block|,
operator|.
name|has_llc
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_ivybridge_d_info
init|=
block|{
operator|.
name|is_ivybridge
operator|=
literal|1
block|,
operator|.
name|gen
operator|=
literal|7
block|,
operator|.
name|need_gfx_hws
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_bsd_ring
operator|=
literal|1
block|,
operator|.
name|has_blt_ring
operator|=
literal|1
block|,
operator|.
name|has_llc
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|intel_device_info
name|intel_ivybridge_m_info
init|=
block|{
operator|.
name|is_ivybridge
operator|=
literal|1
block|,
operator|.
name|gen
operator|=
literal|7
block|,
operator|.
name|is_mobile
operator|=
literal|1
block|,
operator|.
name|need_gfx_hws
operator|=
literal|1
block|,
operator|.
name|has_hotplug
operator|=
literal|1
block|,
operator|.
name|has_fbc
operator|=
literal|0
block|,
comment|/* FBC is not enabled on Ivybridge mobile yet */
operator|.
name|has_bsd_ring
operator|=
literal|1
block|,
operator|.
name|has_blt_ring
operator|=
literal|1
block|,
operator|.
name|has_llc
operator|=
literal|1
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|INTEL_VGA_DEVICE
parameter_list|(
name|id
parameter_list|,
name|info_
parameter_list|)
value|{		\ 	.device = id,				\ 	.info = info_,				\ }
end_define

begin_struct
specifier|static
specifier|const
struct|struct
name|intel_gfx_device_id
block|{
name|int
name|device
decl_stmt|;
specifier|const
name|struct
name|intel_device_info
modifier|*
name|info
decl_stmt|;
block|}
name|pciidlist
index|[]
init|=
block|{
comment|/* aka */
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x3577
argument_list|,
operator|&
name|intel_i830_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2562
argument_list|,
operator|&
name|intel_845g_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x3582
argument_list|,
operator|&
name|intel_i85x_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x358e
argument_list|,
operator|&
name|intel_i85x_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2572
argument_list|,
operator|&
name|intel_i865g_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2582
argument_list|,
operator|&
name|intel_i915g_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x258a
argument_list|,
operator|&
name|intel_i915g_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2592
argument_list|,
operator|&
name|intel_i915gm_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2772
argument_list|,
operator|&
name|intel_i945g_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x27a2
argument_list|,
operator|&
name|intel_i945gm_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x27ae
argument_list|,
operator|&
name|intel_i945gm_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2972
argument_list|,
operator|&
name|intel_i965g_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2982
argument_list|,
operator|&
name|intel_i965g_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2992
argument_list|,
operator|&
name|intel_i965g_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x29a2
argument_list|,
operator|&
name|intel_i965g_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x29b2
argument_list|,
operator|&
name|intel_g33_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x29c2
argument_list|,
operator|&
name|intel_g33_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x29d2
argument_list|,
operator|&
name|intel_g33_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2a02
argument_list|,
operator|&
name|intel_i965gm_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2a12
argument_list|,
operator|&
name|intel_i965gm_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2a42
argument_list|,
operator|&
name|intel_gm45_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2e02
argument_list|,
operator|&
name|intel_g45_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2e12
argument_list|,
operator|&
name|intel_g45_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2e22
argument_list|,
operator|&
name|intel_g45_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2e32
argument_list|,
operator|&
name|intel_g45_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2e42
argument_list|,
operator|&
name|intel_g45_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x2e92
argument_list|,
operator|&
name|intel_g45_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0xa001
argument_list|,
operator|&
name|intel_pineview_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0xa011
argument_list|,
operator|&
name|intel_pineview_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0042
argument_list|,
operator|&
name|intel_ironlake_d_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0046
argument_list|,
operator|&
name|intel_ironlake_m_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0102
argument_list|,
operator|&
name|intel_sandybridge_d_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0112
argument_list|,
operator|&
name|intel_sandybridge_d_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0122
argument_list|,
operator|&
name|intel_sandybridge_d_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0106
argument_list|,
operator|&
name|intel_sandybridge_m_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0116
argument_list|,
operator|&
name|intel_sandybridge_m_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0126
argument_list|,
operator|&
name|intel_sandybridge_m_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x010A
argument_list|,
operator|&
name|intel_sandybridge_d_info
argument_list|)
block|,
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0156
argument_list|,
operator|&
name|intel_ivybridge_m_info
argument_list|)
block|,
comment|/* GT1 mobile */
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0166
argument_list|,
operator|&
name|intel_ivybridge_m_info
argument_list|)
block|,
comment|/* GT2 mobile */
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0152
argument_list|,
operator|&
name|intel_ivybridge_d_info
argument_list|)
block|,
comment|/* GT1 desktop */
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x0162
argument_list|,
operator|&
name|intel_ivybridge_d_info
argument_list|)
block|,
comment|/* GT2 desktop */
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x015a
argument_list|,
operator|&
name|intel_ivybridge_d_info
argument_list|)
block|,
comment|/* GT1 server */
name|INTEL_VGA_DEVICE
argument_list|(
literal|0x016a
argument_list|,
operator|&
name|intel_ivybridge_d_info
argument_list|)
block|,
comment|/* GT2 server */
block|{
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|i915_drm_freeze
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dev_priv
operator|=
name|dev
operator|->
name|dev_private
expr_stmt|;
name|drm_kms_helper_poll_disable
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|pci_save_state(dev->pdev);
endif|#
directive|endif
name|DRM_LOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* If KMS is active, we do the leavevt stuff here */
if|if
condition|(
name|drm_core_check_feature
argument_list|(
name|dev
argument_list|,
name|DRIVER_MODESET
argument_list|)
condition|)
block|{
name|error
operator|=
operator|-
name|i915_gem_idle
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
operator|->
name|device
argument_list|,
literal|"GEM idle failed, resume might fail\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|drm_irq_uninstall
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|i915_save_state
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|intel_opregion_fini
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Modeset on resume, not lid events */
name|dev_priv
operator|->
name|modeset_on_lid
operator|=
literal|0
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_suspend
parameter_list|(
name|device_t
name|kdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dev
operator|=
name|device_get_softc
argument_list|(
name|kdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
operator|||
name|dev
operator|->
name|dev_private
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"DRM not initialized, aborting suspend.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENODEV
return|;
block|}
name|DRM_DEBUG_KMS
argument_list|(
literal|"starting suspend\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|i915_drm_freeze
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|bus_generic_suspend
argument_list|(
name|kdev
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"finished suspend %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_drm_thaw
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|DRM_LOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|drm_core_check_feature
argument_list|(
name|dev
argument_list|,
name|DRIVER_MODESET
argument_list|)
condition|)
block|{
name|i915_gem_restore_gtt_mappings
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|i915_restore_state
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|intel_opregion_setup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* KMS EnterVT equivalent */
if|if
condition|(
name|drm_core_check_feature
argument_list|(
name|dev
argument_list|,
name|DRIVER_MODESET
argument_list|)
condition|)
block|{
name|dev_priv
operator|->
name|mm
operator|.
name|suspended
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|i915_gem_init_hw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAS_PCH_SPLIT
argument_list|(
name|dev
argument_list|)
condition|)
name|ironlake_init_pch_refclk
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
name|drm_mode_config_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
name|drm_irq_install
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
comment|/* Resume the modeset for every activated CRTC */
name|drm_helper_resume_force_mode
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_IRONLAKE_M
argument_list|(
name|dev
argument_list|)
condition|)
name|ironlake_enable_rc6
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|DRM_LOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|intel_opregion_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|modeset_on_lid
operator|=
literal|0
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_resume
parameter_list|(
name|device_t
name|kdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|dev
operator|=
name|device_get_softc
argument_list|(
name|kdev
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"starting resume\n"
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (pci_enable_device(dev->pdev)) 		return -EIO;  	pci_set_master(dev->pdev);
endif|#
directive|endif
name|ret
operator|=
operator|-
name|i915_drm_thaw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|drm_kms_helper_poll_enable
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ret
operator|=
name|bus_generic_resume
argument_list|(
name|kdev
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"finished resume %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_probe
parameter_list|(
name|device_t
name|kdev
parameter_list|)
block|{
return|return
name|drm_probe
argument_list|(
name|kdev
argument_list|,
name|i915_pciidlist
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
name|int
name|i915_modeset
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|i915_attach
parameter_list|(
name|device_t
name|kdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
decl_stmt|;
name|dev
operator|=
name|device_get_softc
argument_list|(
name|kdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|i915_modeset
operator|==
literal|1
condition|)
name|i915_driver_info
operator|.
name|driver_features
operator||=
name|DRIVER_MODESET
expr_stmt|;
name|dev
operator|->
name|driver
operator|=
operator|&
name|i915_driver_info
expr_stmt|;
return|return
operator|(
name|drm_attach
argument_list|(
name|kdev
argument_list|,
name|i915_pciidlist
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|struct
name|intel_device_info
modifier|*
name|i915_get_device_id
parameter_list|(
name|int
name|device
parameter_list|)
block|{
specifier|const
name|struct
name|intel_gfx_device_id
modifier|*
name|did
decl_stmt|;
for|for
control|(
name|did
operator|=
operator|&
name|pciidlist
index|[
literal|0
index|]
init|;
name|did
operator|->
name|device
operator|!=
literal|0
condition|;
name|did
operator|++
control|)
block|{
if|if
condition|(
name|did
operator|->
name|device
operator|!=
name|device
condition|)
continue|continue;
return|return
operator|(
name|did
operator|->
name|info
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|i915_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|i915_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|i915_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|i915_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|i915_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|drm_detach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|i915_driver
init|=
block|{
literal|"drmn"
block|,
name|i915_methods
block|,
expr|sizeof
operator|(
expr|struct
name|drm_device
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|devclass_t
name|drm_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE_ORDERED
argument_list|(
name|i915kms
argument_list|,
name|vgapci
argument_list|,
name|i915_driver
argument_list|,
name|drm_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SI_ORDER_ANY
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|i915kms
argument_list|,
name|drmn
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|i915kms
argument_list|,
name|agp
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|i915kms
argument_list|,
name|iicbus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|i915kms
argument_list|,
name|iic
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|i915kms
argument_list|,
name|iicbb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|intel_iommu_enabled
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.intel_iommu_enabled"
argument_list|,
operator|&
name|intel_iommu_enabled
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|i915_semaphores
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.semaphores"
argument_list|,
operator|&
name|i915_semaphores
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|i915_try_reset
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.try_reset"
argument_list|,
operator|&
name|i915_try_reset
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|unsigned
name|int
name|i915_lvds_downclock
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.lvds_downclock"
argument_list|,
operator|&
name|i915_lvds_downclock
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|i915_vbt_sdvo_panel_type
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.vbt_sdvo_panel_type"
argument_list|,
operator|&
name|i915_vbt_sdvo_panel_type
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|unsigned
name|int
name|i915_powersave
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.powersave"
argument_list|,
operator|&
name|i915_powersave
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|i915_enable_fbc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.enable_fbc"
argument_list|,
operator|&
name|i915_enable_fbc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|i915_enable_rc6
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.enable_rc6"
argument_list|,
operator|&
name|i915_enable_rc6
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|i915_panel_use_ssc
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.panel_use_ssc"
argument_list|,
operator|&
name|i915_panel_use_ssc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|i915_panel_ignore_lid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.panel_ignore_lid"
argument_list|,
operator|&
name|i915_panel_ignore_lid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|i915_modeset
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.modeset"
argument_list|,
operator|&
name|i915_modeset
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|i915_enable_ppgtt
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.enable_ppgtt"
argument_list|,
operator|&
name|i915_enable_ppgtt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|i915_enable_hangcheck
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"drm.i915.enable_hangcheck"
argument_list|,
operator|&
name|i915_enable_hangcheck
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|PCI_VENDOR_INTEL
value|0x8086
end_define

begin_define
define|#
directive|define
name|INTEL_PCH_DEVICE_ID_MASK
value|0xff00
end_define

begin_define
define|#
directive|define
name|INTEL_PCH_IBX_DEVICE_ID_TYPE
value|0x3b00
end_define

begin_define
define|#
directive|define
name|INTEL_PCH_CPT_DEVICE_ID_TYPE
value|0x1c00
end_define

begin_define
define|#
directive|define
name|INTEL_PCH_PPT_DEVICE_ID_TYPE
value|0x1e00
end_define

begin_function
name|void
name|intel_detect_pch
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
decl_stmt|;
name|device_t
name|pch
decl_stmt|;
name|uint32_t
name|id
decl_stmt|;
name|dev_priv
operator|=
name|dev
operator|->
name|dev_private
expr_stmt|;
name|pch
operator|=
name|pci_find_class
argument_list|(
name|PCIC_BRIDGE
argument_list|,
name|PCIS_BRIDGE_ISA
argument_list|)
expr_stmt|;
if|if
condition|(
name|pch
operator|!=
name|NULL
operator|&&
name|pci_get_vendor
argument_list|(
name|pch
argument_list|)
operator|==
name|PCI_VENDOR_INTEL
condition|)
block|{
name|id
operator|=
name|pci_get_device
argument_list|(
name|pch
argument_list|)
operator|&
name|INTEL_PCH_DEVICE_ID_MASK
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|INTEL_PCH_IBX_DEVICE_ID_TYPE
condition|)
block|{
name|dev_priv
operator|->
name|pch_type
operator|=
name|PCH_IBX
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Found Ibex Peak PCH\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|id
operator|==
name|INTEL_PCH_CPT_DEVICE_ID_TYPE
condition|)
block|{
name|dev_priv
operator|->
name|pch_type
operator|=
name|PCH_CPT
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Found CougarPoint PCH\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|id
operator|==
name|INTEL_PCH_PPT_DEVICE_ID_TYPE
condition|)
block|{
comment|/* PantherPoint is CPT compatible */
name|dev_priv
operator|->
name|pch_type
operator|=
name|PCH_CPT
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Found PatherPoint PCH\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|DRM_DEBUG_KMS
argument_list|(
literal|"No PCH detected\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|DRM_DEBUG_KMS
argument_list|(
literal|"No Intel PCI-ISA bridge found\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|__gen6_gt_force_wake_get
parameter_list|(
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|count
operator|++
operator|<
literal|50
operator|&&
operator|(
name|I915_READ_NOTRACE
argument_list|(
name|FORCEWAKE_ACK
argument_list|)
operator|&
literal|1
operator|)
condition|)
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|I915_WRITE_NOTRACE
argument_list|(
name|FORCEWAKE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|POSTING_READ
argument_list|(
name|FORCEWAKE
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|count
operator|++
operator|<
literal|50
operator|&&
operator|(
name|I915_READ_NOTRACE
argument_list|(
name|FORCEWAKE_ACK
argument_list|)
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|__gen6_gt_force_wake_mt_get
parameter_list|(
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|count
operator|++
operator|<
literal|50
operator|&&
operator|(
name|I915_READ_NOTRACE
argument_list|(
name|FORCEWAKE_MT_ACK
argument_list|)
operator|&
literal|1
operator|)
condition|)
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|I915_WRITE_NOTRACE
argument_list|(
name|FORCEWAKE_MT
argument_list|,
operator|(
literal|1
operator|<<
literal|16
operator|)
operator||
literal|1
argument_list|)
expr_stmt|;
name|POSTING_READ
argument_list|(
name|FORCEWAKE_MT
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|count
operator|++
operator|<
literal|50
operator|&&
operator|(
name|I915_READ_NOTRACE
argument_list|(
name|FORCEWAKE_MT_ACK
argument_list|)
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|gen6_gt_force_wake_get
parameter_list|(
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|dev_priv
operator|->
name|gt_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|forcewake_count
operator|++
operator|==
literal|0
condition|)
name|dev_priv
operator|->
name|display
operator|.
name|force_wake_get
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|gt_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|gen6_gt_check_fifodbg
parameter_list|(
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|gtfifodbg
decl_stmt|;
name|gtfifodbg
operator|=
name|I915_READ_NOTRACE
argument_list|(
name|GTFIFODBG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|gtfifodbg
operator|&
name|GT_FIFO_CPU_ERROR_MASK
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"MMIO read or write has been dropped %x\n"
argument_list|,
name|gtfifodbg
argument_list|)
expr_stmt|;
name|I915_WRITE_NOTRACE
argument_list|(
name|GTFIFODBG
argument_list|,
name|GT_FIFO_CPU_ERROR_MASK
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|__gen6_gt_force_wake_put
parameter_list|(
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
parameter_list|)
block|{
name|I915_WRITE_NOTRACE
argument_list|(
name|FORCEWAKE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* The below doubles as a POSTING_READ */
name|gen6_gt_check_fifodbg
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|__gen6_gt_force_wake_mt_put
parameter_list|(
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
parameter_list|)
block|{
name|I915_WRITE_NOTRACE
argument_list|(
name|FORCEWAKE_MT
argument_list|,
operator|(
literal|1
operator|<<
literal|16
operator|)
operator||
literal|0
argument_list|)
expr_stmt|;
comment|/* The below doubles as a POSTING_READ */
name|gen6_gt_check_fifodbg
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|gen6_gt_force_wake_put
parameter_list|(
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|dev_priv
operator|->
name|gt_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|dev_priv
operator|->
name|forcewake_count
operator|==
literal|0
condition|)
name|dev_priv
operator|->
name|display
operator|.
name|force_wake_put
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|gt_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|__gen6_gt_wait_for_fifo
parameter_list|(
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|gt_fifo_count
operator|<
name|GT_FIFO_NUM_RESERVED_ENTRIES
condition|)
block|{
name|int
name|loop
init|=
literal|500
decl_stmt|;
name|u32
name|fifo
init|=
name|I915_READ_NOTRACE
argument_list|(
name|GT_FIFO_FREE_ENTRIES
argument_list|)
decl_stmt|;
while|while
condition|(
name|fifo
operator|<=
name|GT_FIFO_NUM_RESERVED_ENTRIES
operator|&&
name|loop
operator|--
condition|)
block|{
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|fifo
operator|=
name|I915_READ_NOTRACE
argument_list|(
name|GT_FIFO_FREE_ENTRIES
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|loop
operator|<
literal|0
operator|&&
name|fifo
operator|<=
name|GT_FIFO_NUM_RESERVED_ENTRIES
condition|)
block|{
name|printf
argument_list|(
literal|"%s loop\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|++
name|ret
expr_stmt|;
block|}
name|dev_priv
operator|->
name|gt_fifo_count
operator|=
name|fifo
expr_stmt|;
block|}
name|dev_priv
operator|->
name|gt_fifo_count
operator|--
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i8xx_do_reset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|u8
name|flags
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|onems
decl_stmt|;
if|if
condition|(
name|IS_I85X
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|-
name|ENODEV
return|;
name|onems
operator|=
name|hz
operator|/
literal|1000
expr_stmt|;
if|if
condition|(
name|onems
operator|==
literal|0
condition|)
name|onems
operator|=
literal|1
expr_stmt|;
name|I915_WRITE
argument_list|(
name|D_STATE
argument_list|,
name|I915_READ
argument_list|(
name|D_STATE
argument_list|)
operator||
name|DSTATE_GFX_RESET_I830
argument_list|)
expr_stmt|;
name|POSTING_READ
argument_list|(
name|D_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_I830
argument_list|(
name|dev
argument_list|)
operator|||
name|IS_845G
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|I915_WRITE
argument_list|(
name|DEBUG_RESET_I830
argument_list|,
name|DEBUG_RESET_DISPLAY
operator||
name|DEBUG_RESET_RENDER
operator||
name|DEBUG_RESET_FULL
argument_list|)
expr_stmt|;
name|POSTING_READ
argument_list|(
name|DEBUG_RESET_I830
argument_list|)
expr_stmt|;
name|pause
argument_list|(
literal|"i8xxrst1"
argument_list|,
name|onems
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|DEBUG_RESET_I830
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|POSTING_READ
argument_list|(
name|DEBUG_RESET_I830
argument_list|)
expr_stmt|;
block|}
name|pause
argument_list|(
literal|"i8xxrst2"
argument_list|,
name|onems
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|D_STATE
argument_list|,
name|I915_READ
argument_list|(
name|D_STATE
argument_list|)
operator|&
operator|~
name|DSTATE_GFX_RESET_I830
argument_list|)
expr_stmt|;
name|POSTING_READ
argument_list|(
name|D_STATE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i965_reset_complete
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|u8
name|gdrst
decl_stmt|;
name|gdrst
operator|=
name|pci_read_config
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|I965_GDRST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|gdrst
operator|&
literal|0x1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i965_do_reset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|u8
name|flags
parameter_list|)
block|{
name|u8
name|gdrst
decl_stmt|;
comment|/* 	 * Set the domains we want to reset (GRDOM/bits 2 and 3) as 	 * well as the reset bit (GR/bit 0).  Setting the GR bit 	 * triggers the reset; when done, the hardware will clear it. 	 */
name|gdrst
operator|=
name|pci_read_config
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|I965_GDRST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|I965_GDRST
argument_list|,
name|gdrst
operator||
name|flags
operator||
literal|0x1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|_intel_wait_for
argument_list|(
name|dev
argument_list|,
name|i965_reset_complete
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|500
argument_list|,
literal|1
argument_list|,
literal|"915rst"
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ironlake_do_reset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|u8
name|flags
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
decl_stmt|;
name|u32
name|gdrst
decl_stmt|;
name|dev_priv
operator|=
name|dev
operator|->
name|dev_private
expr_stmt|;
name|gdrst
operator|=
name|I915_READ
argument_list|(
name|MCHBAR_MIRROR_BASE
operator|+
name|ILK_GDSR
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|MCHBAR_MIRROR_BASE
operator|+
name|ILK_GDSR
argument_list|,
name|gdrst
operator||
name|flags
operator||
literal|0x1
argument_list|)
expr_stmt|;
return|return
operator|(
name|_intel_wait_for
argument_list|(
name|dev
argument_list|,
operator|(
name|I915_READ
argument_list|(
name|MCHBAR_MIRROR_BASE
operator|+
name|ILK_GDSR
argument_list|)
operator|&
literal|0x1
operator|)
operator|!=
literal|0
argument_list|,
literal|500
argument_list|,
literal|1
argument_list|,
literal|"915rst"
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gen6_do_reset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|u8
name|flags
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|dev_priv
operator|=
name|dev
operator|->
name|dev_private
expr_stmt|;
comment|/* Hold gt_lock across reset to prevent any register access 	 * with forcewake not set correctly 	 */
name|mtx_lock
argument_list|(
operator|&
name|dev_priv
operator|->
name|gt_lock
argument_list|)
expr_stmt|;
comment|/* Reset the chip */
comment|/* GEN6_GDRST is not in the gt power well, no need to check 	 * for fifo space for the write or forcewake the chip for 	 * the read 	 */
name|I915_WRITE_NOTRACE
argument_list|(
name|GEN6_GDRST
argument_list|,
name|GEN6_GRDOM_FULL
argument_list|)
expr_stmt|;
comment|/* Spin waiting for the device to ack the reset request */
name|ret
operator|=
name|_intel_wait_for
argument_list|(
name|dev
argument_list|,
operator|(
name|I915_READ
argument_list|(
name|GEN6_GDRST
argument_list|)
operator|&
name|GEN6_GRDOM_FULL
operator|)
operator|==
literal|0
argument_list|,
literal|500
argument_list|,
literal|1
argument_list|,
literal|"915rst"
argument_list|)
expr_stmt|;
comment|/* If reset with a user forcewake, try to restore, otherwise turn it off */
if|if
condition|(
name|dev_priv
operator|->
name|forcewake_count
condition|)
name|dev_priv
operator|->
name|display
operator|.
name|force_wake_get
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
else|else
name|dev_priv
operator|->
name|display
operator|.
name|force_wake_put
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* Restore fifo count */
name|dev_priv
operator|->
name|gt_fifo_count
operator|=
name|I915_READ_NOTRACE
argument_list|(
name|GT_FIFO_FREE_ENTRIES
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|gt_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|i915_reset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|u8
name|flags
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
comment|/* 	 * We really should only reset the display subsystem if we actually 	 * need to 	 */
name|bool
name|need_display
init|=
name|true
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|i915_try_reset
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|sx_try_xlock
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|(
operator|-
name|EBUSY
operator|)
return|;
name|i915_gem_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENODEV
expr_stmt|;
if|if
condition|(
name|time_second
operator|-
name|dev_priv
operator|->
name|last_gpu_reset
operator|<
literal|5
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"GPU hanging too fast, declaring wedged!\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|INTEL_INFO
argument_list|(
name|dev
argument_list|)
operator|->
name|gen
condition|)
block|{
case|case
literal|7
case|:
case|case
literal|6
case|:
name|ret
operator|=
name|gen6_do_reset
argument_list|(
name|dev
argument_list|,
name|flags
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|ret
operator|=
name|ironlake_do_reset
argument_list|(
name|dev
argument_list|,
name|flags
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|ret
operator|=
name|i965_do_reset
argument_list|(
name|dev
argument_list|,
name|flags
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|ret
operator|=
name|i8xx_do_reset
argument_list|(
name|dev
argument_list|,
name|flags
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|dev_priv
operator|->
name|last_gpu_reset
operator|=
name|time_second
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to reset chip.\n"
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
if|if
condition|(
name|drm_core_check_feature
argument_list|(
name|dev
argument_list|,
name|DRIVER_MODESET
argument_list|)
operator|||
operator|!
name|dev_priv
operator|->
name|mm
operator|.
name|suspended
condition|)
block|{
name|dev_priv
operator|->
name|mm
operator|.
name|suspended
operator|=
literal|0
expr_stmt|;
name|i915_gem_init_swizzling
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|rings
index|[
name|RCS
index|]
operator|.
name|init
argument_list|(
operator|&
name|dev_priv
operator|->
name|rings
index|[
name|RCS
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAS_BSD
argument_list|(
name|dev
argument_list|)
condition|)
name|dev_priv
operator|->
name|rings
index|[
name|VCS
index|]
operator|.
name|init
argument_list|(
operator|&
name|dev_priv
operator|->
name|rings
index|[
name|VCS
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAS_BLT
argument_list|(
name|dev
argument_list|)
condition|)
name|dev_priv
operator|->
name|rings
index|[
name|BCS
index|]
operator|.
name|init
argument_list|(
operator|&
name|dev_priv
operator|->
name|rings
index|[
name|BCS
index|]
argument_list|)
expr_stmt|;
name|i915_gem_init_ppgtt
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|drm_irq_uninstall
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|drm_mode_config_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|drm_irq_install
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|DRM_LOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_display
condition|)
block|{
name|sx_xlock
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
name|drm_helper_resume_force_mode
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|__i915_read
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
define|\
value|u##x i915_read##x(struct drm_i915_private *dev_priv, u32 reg) { \ 	u##x val = 0; \ 	if (NEEDS_FORCE_WAKE((dev_priv), (reg))) { \ 		mtx_lock(&dev_priv->gt_lock); \ 		if (dev_priv->forcewake_count == 0) \ 			dev_priv->display.force_wake_get(dev_priv); \ 		val = DRM_READ##y(dev_priv->mmio_map, reg);	\ 		if (dev_priv->forcewake_count == 0) \ 			dev_priv->display.force_wake_put(dev_priv); \ 		mtx_unlock(&dev_priv->gt_lock); \ 	} else { \ 		val = DRM_READ##y(dev_priv->mmio_map, reg);	\ 	} \ 	trace_i915_reg_rw(false, reg, val, sizeof(val)); \ 	return val; \ }
end_define

begin_macro
name|__i915_read
argument_list|(
literal|8
argument_list|,
literal|8
argument_list|)
end_macro

begin_macro
name|__i915_read
argument_list|(
literal|16
argument_list|,
literal|16
argument_list|)
end_macro

begin_macro
name|__i915_read
argument_list|(
literal|32
argument_list|,
literal|32
argument_list|)
end_macro

begin_macro
name|__i915_read
argument_list|(
literal|64
argument_list|,
literal|64
argument_list|)
end_macro

begin_undef
undef|#
directive|undef
name|__i915_read
end_undef

begin_define
define|#
directive|define
name|__i915_write
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
define|\
value|void i915_write##x(struct drm_i915_private *dev_priv, u32 reg, u##x val) { \ 	u32 __fifo_ret = 0; \ 	trace_i915_reg_rw(true, reg, val, sizeof(val)); \ 	if (NEEDS_FORCE_WAKE((dev_priv), (reg))) { \ 		__fifo_ret = __gen6_gt_wait_for_fifo(dev_priv); \ 	} \ 	DRM_WRITE##y(dev_priv->mmio_map, reg, val); \ 	if (__predict_false(__fifo_ret)) { \ 		gen6_gt_check_fifodbg(dev_priv); \ 	} \ }
end_define

begin_macro
name|__i915_write
argument_list|(
literal|8
argument_list|,
literal|8
argument_list|)
end_macro

begin_macro
name|__i915_write
argument_list|(
literal|16
argument_list|,
literal|16
argument_list|)
end_macro

begin_macro
name|__i915_write
argument_list|(
literal|32
argument_list|,
literal|32
argument_list|)
end_macro

begin_macro
name|__i915_write
argument_list|(
literal|64
argument_list|,
literal|64
argument_list|)
end_macro

begin_undef
undef|#
directive|undef
name|__i915_write
end_undef

end_unit


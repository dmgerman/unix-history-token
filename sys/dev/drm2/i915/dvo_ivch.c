begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright Â© 2006 Intel Corporation  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Eric Anholt<eric@anholt.net>  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"dvo.h"
end_include

begin_comment
comment|/*  * register definitions for the i82807aa.  *  * Documentation on this chipset can be found in datasheet #29069001 at  * intel.com.  */
end_comment

begin_comment
comment|/*  * VCH Revision& GMBus Base Addr  */
end_comment

begin_define
define|#
directive|define
name|VR00
value|0x00
end_define

begin_define
define|#
directive|define
name|VR00_BASE_ADDRESS_MASK
value|0x007f
end_define

begin_comment
comment|/*  * Functionality Enable  */
end_comment

begin_define
define|#
directive|define
name|VR01
value|0x01
end_define

begin_comment
comment|/*  * Enable the panel fitter  */
end_comment

begin_define
define|#
directive|define
name|VR01_PANEL_FIT_ENABLE
value|(1<< 3)
end_define

begin_comment
comment|/*  * Enables the LCD display.  *  * This must not be set while VR01_DVO_BYPASS_ENABLE is set.  */
end_comment

begin_define
define|#
directive|define
name|VR01_LCD_ENABLE
value|(1<< 2)
end_define

begin_comment
comment|/** Enables the DVO repeater. */
end_comment

begin_define
define|#
directive|define
name|VR01_DVO_BYPASS_ENABLE
value|(1<< 1)
end_define

begin_comment
comment|/** Enables the DVO clock */
end_comment

begin_define
define|#
directive|define
name|VR01_DVO_ENABLE
value|(1<< 0)
end_define

begin_comment
comment|/*  * LCD Interface Format  */
end_comment

begin_define
define|#
directive|define
name|VR10
value|0x10
end_define

begin_comment
comment|/** Enables LVDS output instead of CMOS */
end_comment

begin_define
define|#
directive|define
name|VR10_LVDS_ENABLE
value|(1<< 4)
end_define

begin_comment
comment|/** Enables 18-bit LVDS output. */
end_comment

begin_define
define|#
directive|define
name|VR10_INTERFACE_1X18
value|(0<< 2)
end_define

begin_comment
comment|/** Enables 24-bit LVDS or CMOS output */
end_comment

begin_define
define|#
directive|define
name|VR10_INTERFACE_1X24
value|(1<< 2)
end_define

begin_comment
comment|/** Enables 2x18-bit LVDS or CMOS output. */
end_comment

begin_define
define|#
directive|define
name|VR10_INTERFACE_2X18
value|(2<< 2)
end_define

begin_comment
comment|/** Enables 2x24-bit LVDS output */
end_comment

begin_define
define|#
directive|define
name|VR10_INTERFACE_2X24
value|(3<< 2)
end_define

begin_comment
comment|/*  * VR20 LCD Horizontal Display Size  */
end_comment

begin_define
define|#
directive|define
name|VR20
value|0x20
end_define

begin_comment
comment|/*  * LCD Vertical Display Size  */
end_comment

begin_define
define|#
directive|define
name|VR21
value|0x20
end_define

begin_comment
comment|/*  * Panel power down status  */
end_comment

begin_define
define|#
directive|define
name|VR30
value|0x30
end_define

begin_comment
comment|/** Read only bit indicating that the panel is not in a safe poweroff state. */
end_comment

begin_define
define|#
directive|define
name|VR30_PANEL_ON
value|(1<< 15)
end_define

begin_define
define|#
directive|define
name|VR40
value|0x40
end_define

begin_define
define|#
directive|define
name|VR40_STALL_ENABLE
value|(1<< 13)
end_define

begin_define
define|#
directive|define
name|VR40_VERTICAL_INTERP_ENABLE
value|(1<< 12)
end_define

begin_define
define|#
directive|define
name|VR40_ENHANCED_PANEL_FITTING
value|(1<< 11)
end_define

begin_define
define|#
directive|define
name|VR40_HORIZONTAL_INTERP_ENABLE
value|(1<< 10)
end_define

begin_define
define|#
directive|define
name|VR40_AUTO_RATIO_ENABLE
value|(1<< 9)
end_define

begin_define
define|#
directive|define
name|VR40_CLOCK_GATING_ENABLE
value|(1<< 8)
end_define

begin_comment
comment|/*  * Panel Fitting Vertical Ratio  * (((image_height - 1)<< 16) / ((panel_height - 1)))>> 2  */
end_comment

begin_define
define|#
directive|define
name|VR41
value|0x41
end_define

begin_comment
comment|/*  * Panel Fitting Horizontal Ratio  * (((image_width - 1)<< 16) / ((panel_width - 1)))>> 2  */
end_comment

begin_define
define|#
directive|define
name|VR42
value|0x42
end_define

begin_comment
comment|/*  * Horizontal Image Size  */
end_comment

begin_define
define|#
directive|define
name|VR43
value|0x43
end_define

begin_comment
comment|/* VR80 GPIO 0  */
end_comment

begin_define
define|#
directive|define
name|VR80
value|0x80
end_define

begin_define
define|#
directive|define
name|VR81
value|0x81
end_define

begin_define
define|#
directive|define
name|VR82
value|0x82
end_define

begin_define
define|#
directive|define
name|VR83
value|0x83
end_define

begin_define
define|#
directive|define
name|VR84
value|0x84
end_define

begin_define
define|#
directive|define
name|VR85
value|0x85
end_define

begin_define
define|#
directive|define
name|VR86
value|0x86
end_define

begin_define
define|#
directive|define
name|VR87
value|0x87
end_define

begin_comment
comment|/* VR88 GPIO 8  */
end_comment

begin_define
define|#
directive|define
name|VR88
value|0x88
end_define

begin_comment
comment|/* Graphics BIOS scratch 0  */
end_comment

begin_define
define|#
directive|define
name|VR8E
value|0x8E
end_define

begin_define
define|#
directive|define
name|VR8E_PANEL_TYPE_MASK
value|(0xf<< 0)
end_define

begin_define
define|#
directive|define
name|VR8E_PANEL_INTERFACE_CMOS
value|(0<< 4)
end_define

begin_define
define|#
directive|define
name|VR8E_PANEL_INTERFACE_LVDS
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|VR8E_FORCE_DEFAULT_PANEL
value|(1<< 5)
end_define

begin_comment
comment|/* Graphics BIOS scratch 1  */
end_comment

begin_define
define|#
directive|define
name|VR8F
value|0x8F
end_define

begin_define
define|#
directive|define
name|VR8F_VCH_PRESENT
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|VR8F_DISPLAY_CONN
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|VR8F_POWER_MASK
value|(0x3c)
end_define

begin_define
define|#
directive|define
name|VR8F_POWER_POS
value|(2)
end_define

begin_struct
struct|struct
name|ivch_priv
block|{
name|bool
name|quiet
decl_stmt|;
name|uint16_t
name|width
decl_stmt|,
name|height
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|ivch_dump_regs
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**  * Reads a register on the ivch.  *  * Each of the 256 registers are 16 bits long.  */
end_comment

begin_function
specifier|static
name|bool
name|ivch_read
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|int
name|addr
parameter_list|,
name|uint16_t
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ivch_priv
modifier|*
name|priv
init|=
name|dvo
operator|->
name|dev_priv
decl_stmt|;
name|device_t
name|adapter
init|=
name|dvo
operator|->
name|i2c_bus
decl_stmt|;
name|u8
name|out_buf
index|[
literal|1
index|]
decl_stmt|;
name|u8
name|in_buf
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|iic_msg
name|msgs
index|[]
init|=
block|{
block|{
operator|.
name|slave
operator|=
name|dvo
operator|->
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
name|I2C_M_RD
block|,
operator|.
name|len
operator|=
literal|0
block|, 		}
block|,
block|{
operator|.
name|slave
operator|=
literal|0
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
name|I2C_M_NOSTART
block|,
operator|.
name|len
operator|=
literal|1
block|,
operator|.
name|buf
operator|=
name|out_buf
block|, 		}
block|,
block|{
operator|.
name|slave
operator|=
name|dvo
operator|->
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
name|I2C_M_RD
operator||
name|I2C_M_NOSTART
block|,
operator|.
name|len
operator|=
literal|2
block|,
operator|.
name|buf
operator|=
name|in_buf
block|, 		}
block|}
decl_stmt|;
name|out_buf
index|[
literal|0
index|]
operator|=
name|addr
expr_stmt|;
if|if
condition|(
operator|-
name|iicbus_transfer
argument_list|(
name|adapter
argument_list|,
name|msgs
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|data
operator|=
operator|(
name|in_buf
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
name|in_buf
index|[
literal|0
index|]
expr_stmt|;
return|return
name|true
return|;
block|}
if|if
condition|(
operator|!
name|priv
operator|->
name|quiet
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Unable to read register 0x%02x from "
literal|"%s:%02x.\n"
argument_list|,
name|addr
argument_list|,
name|device_get_nameunit
argument_list|(
name|adapter
argument_list|)
argument_list|,
name|dvo
operator|->
name|slave_addr
argument_list|)
expr_stmt|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_comment
comment|/** Writes a 16-bit register on the ivch */
end_comment

begin_function
specifier|static
name|bool
name|ivch_write
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|int
name|addr
parameter_list|,
name|uint16_t
name|data
parameter_list|)
block|{
name|struct
name|ivch_priv
modifier|*
name|priv
init|=
name|dvo
operator|->
name|dev_priv
decl_stmt|;
name|device_t
name|adapter
init|=
name|dvo
operator|->
name|i2c_bus
decl_stmt|;
name|u8
name|out_buf
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|iic_msg
name|msg
init|=
block|{
operator|.
name|slave
operator|=
name|dvo
operator|->
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
literal|0
block|,
operator|.
name|len
operator|=
literal|3
block|,
operator|.
name|buf
operator|=
name|out_buf
block|, 	}
decl_stmt|;
name|out_buf
index|[
literal|0
index|]
operator|=
name|addr
expr_stmt|;
name|out_buf
index|[
literal|1
index|]
operator|=
name|data
operator|&
literal|0xff
expr_stmt|;
name|out_buf
index|[
literal|2
index|]
operator|=
name|data
operator|>>
literal|8
expr_stmt|;
if|if
condition|(
operator|-
name|iicbus_transfer
argument_list|(
name|adapter
argument_list|,
operator|&
name|msg
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
return|return
name|true
return|;
if|if
condition|(
operator|!
name|priv
operator|->
name|quiet
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Unable to write register 0x%02x to %s:%d.\n"
argument_list|,
name|addr
argument_list|,
name|device_get_nameunit
argument_list|(
name|adapter
argument_list|)
argument_list|,
name|dvo
operator|->
name|slave_addr
argument_list|)
expr_stmt|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_comment
comment|/** Probes the given bus and slave address for an ivch */
end_comment

begin_function
specifier|static
name|bool
name|ivch_init
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|device_t
name|adapter
parameter_list|)
block|{
name|struct
name|ivch_priv
modifier|*
name|priv
decl_stmt|;
name|uint16_t
name|temp
decl_stmt|;
name|priv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ivch_priv
argument_list|)
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|==
name|NULL
condition|)
return|return
name|false
return|;
name|dvo
operator|->
name|i2c_bus
operator|=
name|adapter
expr_stmt|;
name|dvo
operator|->
name|dev_priv
operator|=
name|priv
expr_stmt|;
name|priv
operator|->
name|quiet
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|!
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR00
argument_list|,
operator|&
name|temp
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|priv
operator|->
name|quiet
operator|=
name|false
expr_stmt|;
comment|/* Since the identification bits are probably zeroes, which doesn't seem 	 * very unique, check that the value in the base address field matches 	 * the address it's responding on. 	 */
if|if
condition|(
operator|(
name|temp
operator|&
name|VR00_BASE_ADDRESS_MASK
operator|)
operator|!=
name|dvo
operator|->
name|slave_addr
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"ivch detect failed due to address mismatch "
literal|"(%d vs %d)\n"
argument_list|,
operator|(
name|temp
operator|&
name|VR00_BASE_ADDRESS_MASK
operator|)
argument_list|,
name|dvo
operator|->
name|slave_addr
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR20
argument_list|,
operator|&
name|priv
operator|->
name|width
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR21
argument_list|,
operator|&
name|priv
operator|->
name|height
argument_list|)
expr_stmt|;
return|return
name|true
return|;
name|out
label|:
name|free
argument_list|(
name|priv
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|drm_connector_status
name|ivch_detect
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
return|return
name|connector_status_connected
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|drm_mode_status
name|ivch_mode_valid
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
if|if
condition|(
name|mode
operator|->
name|clock
operator|>
literal|112000
condition|)
return|return
name|MODE_CLOCK_HIGH
return|;
return|return
name|MODE_OK
return|;
block|}
end_function

begin_comment
comment|/** Sets the power state of the panel connected to the ivch */
end_comment

begin_function
specifier|static
name|void
name|ivch_dpms
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint16_t
name|vr01
decl_stmt|,
name|vr30
decl_stmt|,
name|backlight
decl_stmt|;
comment|/* Set the new power state of the panel. */
if|if
condition|(
operator|!
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR01
argument_list|,
operator|&
name|vr01
argument_list|)
condition|)
return|return;
if|if
condition|(
name|enable
condition|)
name|backlight
operator|=
literal|1
expr_stmt|;
else|else
name|backlight
operator|=
literal|0
expr_stmt|;
name|ivch_write
argument_list|(
name|dvo
argument_list|,
name|VR80
argument_list|,
name|backlight
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|vr01
operator||=
name|VR01_LCD_ENABLE
operator||
name|VR01_DVO_ENABLE
expr_stmt|;
else|else
name|vr01
operator|&=
operator|~
operator|(
name|VR01_LCD_ENABLE
operator||
name|VR01_DVO_ENABLE
operator|)
expr_stmt|;
name|ivch_write
argument_list|(
name|dvo
argument_list|,
name|VR01
argument_list|,
name|vr01
argument_list|)
expr_stmt|;
comment|/* Wait for the panel to make its state transition */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR30
argument_list|,
operator|&
name|vr30
argument_list|)
condition|)
break|break;
if|if
condition|(
operator|(
operator|(
name|vr30
operator|&
name|VR30_PANEL_ON
operator|)
operator|!=
literal|0
operator|)
operator|==
name|enable
condition|)
break|break;
name|udelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
comment|/* wait some more; vch may fail to resync sometimes without this */
name|udelay
argument_list|(
literal|16
operator|*
literal|1000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ivch_get_hw_state
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
name|uint16_t
name|vr01
decl_stmt|;
comment|/* Set the new power state of the panel. */
if|if
condition|(
operator|!
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR01
argument_list|,
operator|&
name|vr01
argument_list|)
condition|)
return|return
name|false
return|;
if|if
condition|(
name|vr01
operator|&
name|VR01_LCD_ENABLE
condition|)
return|return
name|true
return|;
else|else
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ivch_mode_set
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|uint16_t
name|vr40
init|=
literal|0
decl_stmt|;
name|uint16_t
name|vr01
decl_stmt|;
name|vr01
operator|=
literal|0
expr_stmt|;
name|vr40
operator|=
operator|(
name|VR40_STALL_ENABLE
operator||
name|VR40_VERTICAL_INTERP_ENABLE
operator||
name|VR40_HORIZONTAL_INTERP_ENABLE
operator|)
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|hdisplay
operator|!=
name|adjusted_mode
operator|->
name|hdisplay
operator|||
name|mode
operator|->
name|vdisplay
operator|!=
name|adjusted_mode
operator|->
name|vdisplay
condition|)
block|{
name|uint16_t
name|x_ratio
decl_stmt|,
name|y_ratio
decl_stmt|;
name|vr01
operator||=
name|VR01_PANEL_FIT_ENABLE
expr_stmt|;
name|vr40
operator||=
name|VR40_CLOCK_GATING_ENABLE
expr_stmt|;
name|x_ratio
operator|=
operator|(
operator|(
operator|(
name|mode
operator|->
name|hdisplay
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator|/
operator|(
name|adjusted_mode
operator|->
name|hdisplay
operator|-
literal|1
operator|)
operator|)
operator|>>
literal|2
expr_stmt|;
name|y_ratio
operator|=
operator|(
operator|(
operator|(
name|mode
operator|->
name|vdisplay
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator|/
operator|(
name|adjusted_mode
operator|->
name|vdisplay
operator|-
literal|1
operator|)
operator|)
operator|>>
literal|2
expr_stmt|;
name|ivch_write
argument_list|(
name|dvo
argument_list|,
name|VR42
argument_list|,
name|x_ratio
argument_list|)
expr_stmt|;
name|ivch_write
argument_list|(
name|dvo
argument_list|,
name|VR41
argument_list|,
name|y_ratio
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vr01
operator|&=
operator|~
name|VR01_PANEL_FIT_ENABLE
expr_stmt|;
name|vr40
operator|&=
operator|~
name|VR40_CLOCK_GATING_ENABLE
expr_stmt|;
block|}
name|vr40
operator|&=
operator|~
name|VR40_AUTO_RATIO_ENABLE
expr_stmt|;
name|ivch_write
argument_list|(
name|dvo
argument_list|,
name|VR01
argument_list|,
name|vr01
argument_list|)
expr_stmt|;
name|ivch_write
argument_list|(
name|dvo
argument_list|,
name|VR40
argument_list|,
name|vr40
argument_list|)
expr_stmt|;
name|ivch_dump_regs
argument_list|(
name|dvo
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ivch_dump_regs
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR00
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR00: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR01
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR01: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR30
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR30: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR40
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR40: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* GPIO registers */
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR80
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR80: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR81
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR81: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR82
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR82: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR83
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR83: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR84
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR84: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR85
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR85: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR86
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR86: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR87
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR87: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR88
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR88: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Scratch register 0 - AIM Panel type */
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR8E
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR8E: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Scratch register 1 - Status register */
name|ivch_read
argument_list|(
name|dvo
argument_list|,
name|VR8F
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"VR8F: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ivch_destroy
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
name|struct
name|ivch_priv
modifier|*
name|priv
init|=
name|dvo
operator|->
name|dev_priv
decl_stmt|;
if|if
condition|(
name|priv
condition|)
block|{
name|free
argument_list|(
name|priv
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
name|dvo
operator|->
name|dev_priv
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
name|struct
name|intel_dvo_dev_ops
name|ivch_ops
init|=
block|{
operator|.
name|init
operator|=
name|ivch_init
block|,
operator|.
name|dpms
operator|=
name|ivch_dpms
block|,
operator|.
name|get_hw_state
operator|=
name|ivch_get_hw_state
block|,
operator|.
name|mode_valid
operator|=
name|ivch_mode_valid
block|,
operator|.
name|mode_set
operator|=
name|ivch_mode_set
block|,
operator|.
name|detect
operator|=
name|ivch_detect
block|,
operator|.
name|dump_regs
operator|=
name|ivch_dump_regs
block|,
operator|.
name|destroy
operator|=
name|ivch_destroy
block|, }
decl_stmt|;
end_decl_stmt

end_unit


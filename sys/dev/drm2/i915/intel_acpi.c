begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Intel ACPI functions  *  * _DSM related code stolen from nouveau_acpi.c.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/i915_drv.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/include/acpi.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/include/accommon.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_define
define|#
directive|define
name|INTEL_DSM_REVISION_ID
value|1
end_define

begin_comment
comment|/* For Calpella anyway... */
end_comment

begin_define
define|#
directive|define
name|INTEL_DSM_FN_SUPPORTED_FUNCTIONS
value|0
end_define

begin_comment
comment|/* No args */
end_comment

begin_define
define|#
directive|define
name|INTEL_DSM_FN_PLATFORM_MUX_INFO
value|1
end_define

begin_comment
comment|/* No args */
end_comment

begin_struct
specifier|static
struct|struct
name|intel_dsm_priv
block|{
name|ACPI_HANDLE
name|dhandle
decl_stmt|;
block|}
name|intel_dsm_priv
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|u8
name|intel_dsm_guid
index|[]
init|=
block|{
literal|0xd3
block|,
literal|0x73
block|,
literal|0xd8
block|,
literal|0x7e
block|,
literal|0xd0
block|,
literal|0xc2
block|,
literal|0x4f
block|,
literal|0x4e
block|,
literal|0xa8
block|,
literal|0x54
block|,
literal|0x0f
block|,
literal|0x13
block|,
literal|0x17
block|,
literal|0xb0
block|,
literal|0x1c
block|,
literal|0x2c
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|intel_dsm
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|int
name|func
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|ACPI_BUFFER
name|output
init|=
block|{
name|ACPI_ALLOCATE_BUFFER
block|,
name|NULL
block|}
decl_stmt|;
name|ACPI_OBJECT_LIST
name|input
decl_stmt|;
name|ACPI_OBJECT
name|params
index|[
literal|4
index|]
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|obj
decl_stmt|;
name|u32
name|result
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|input
operator|.
name|Count
operator|=
literal|4
expr_stmt|;
name|input
operator|.
name|Pointer
operator|=
name|params
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_BUFFER
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Buffer
operator|.
name|Length
operator|=
sizeof|sizeof
argument_list|(
name|intel_dsm_guid
argument_list|)
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Buffer
operator|.
name|Pointer
operator|=
name|__DECONST
argument_list|(
name|char
operator|*
argument_list|,
name|intel_dsm_guid
argument_list|)
expr_stmt|;
name|params
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|1
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|INTEL_DSM_REVISION_ID
expr_stmt|;
name|params
index|[
literal|2
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|2
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|func
expr_stmt|;
name|params
index|[
literal|3
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|3
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|arg
expr_stmt|;
name|ret
operator|=
name|AcpiEvaluateObject
argument_list|(
name|handle
argument_list|,
literal|"_DSM"
argument_list|,
operator|&
name|input
argument_list|,
operator|&
name|output
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"failed to evaluate _DSM: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|obj
operator|=
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|output
operator|.
name|Pointer
expr_stmt|;
name|result
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|obj
operator|->
name|Type
condition|)
block|{
case|case
name|ACPI_TYPE_INTEGER
case|:
name|result
operator|=
name|obj
operator|->
name|Integer
operator|.
name|Value
expr_stmt|;
break|break;
case|case
name|ACPI_TYPE_BUFFER
case|:
if|if
condition|(
name|obj
operator|->
name|Buffer
operator|.
name|Length
operator|==
literal|4
condition|)
block|{
name|result
operator|=
operator|(
name|obj
operator|->
name|Buffer
operator|.
name|Pointer
index|[
literal|0
index|]
operator||
operator|(
name|obj
operator|->
name|Buffer
operator|.
name|Pointer
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|obj
operator|->
name|Buffer
operator|.
name|Pointer
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|obj
operator|->
name|Buffer
operator|.
name|Pointer
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator|)
expr_stmt|;
break|break;
block|}
default|default:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|result
operator|==
literal|0x80000002
condition|)
name|ret
operator|=
operator|-
name|ENODEV
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|output
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|intel_dsm_port_name
parameter_list|(
name|u8
name|id
parameter_list|)
block|{
switch|switch
condition|(
name|id
condition|)
block|{
case|case
literal|0
case|:
return|return
literal|"Reserved"
return|;
case|case
literal|1
case|:
return|return
literal|"Analog VGA"
return|;
case|case
literal|2
case|:
return|return
literal|"LVDS"
return|;
case|case
literal|3
case|:
return|return
literal|"Reserved"
return|;
case|case
literal|4
case|:
return|return
literal|"HDMI/DVI_B"
return|;
case|case
literal|5
case|:
return|return
literal|"HDMI/DVI_C"
return|;
case|case
literal|6
case|:
return|return
literal|"HDMI/DVI_D"
return|;
case|case
literal|7
case|:
return|return
literal|"DisplayPort_A"
return|;
case|case
literal|8
case|:
return|return
literal|"DisplayPort_B"
return|;
case|case
literal|9
case|:
return|return
literal|"DisplayPort_C"
return|;
case|case
literal|0xa
case|:
return|return
literal|"DisplayPort_D"
return|;
case|case
literal|0xb
case|:
case|case
literal|0xc
case|:
case|case
literal|0xd
case|:
return|return
literal|"Reserved"
return|;
case|case
literal|0xe
case|:
return|return
literal|"WiDi"
return|;
default|default:
return|return
literal|"bad type"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|intel_dsm_mux_type
parameter_list|(
name|u8
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|0
case|:
return|return
literal|"unknown"
return|;
case|case
literal|1
case|:
return|return
literal|"No MUX, iGPU only"
return|;
case|case
literal|2
case|:
return|return
literal|"No MUX, dGPU only"
return|;
case|case
literal|3
case|:
return|return
literal|"MUXed between iGPU and dGPU"
return|;
default|default:
return|return
literal|"bad type"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|intel_dsm_platform_mux_info
parameter_list|(
name|void
parameter_list|)
block|{
name|ACPI_BUFFER
name|output
init|=
block|{
name|ACPI_ALLOCATE_BUFFER
block|,
name|NULL
block|}
decl_stmt|;
name|ACPI_OBJECT_LIST
name|input
decl_stmt|;
name|ACPI_OBJECT
name|params
index|[
literal|4
index|]
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|pkg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|input
operator|.
name|Count
operator|=
literal|4
expr_stmt|;
name|input
operator|.
name|Pointer
operator|=
name|params
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_BUFFER
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Buffer
operator|.
name|Length
operator|=
sizeof|sizeof
argument_list|(
name|intel_dsm_guid
argument_list|)
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Buffer
operator|.
name|Pointer
operator|=
name|__DECONST
argument_list|(
name|char
operator|*
argument_list|,
name|intel_dsm_guid
argument_list|)
expr_stmt|;
name|params
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|1
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|INTEL_DSM_REVISION_ID
expr_stmt|;
name|params
index|[
literal|2
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|2
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|INTEL_DSM_FN_PLATFORM_MUX_INFO
expr_stmt|;
name|params
index|[
literal|3
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|3
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|AcpiEvaluateObject
argument_list|(
name|intel_dsm_priv
operator|.
name|dhandle
argument_list|,
literal|"_DSM"
argument_list|,
operator|&
name|input
argument_list|,
operator|&
name|output
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"failed to evaluate _DSM: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pkg
operator|=
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|output
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
name|pkg
operator|->
name|Type
operator|==
name|ACPI_TYPE_PACKAGE
condition|)
block|{
name|ACPI_OBJECT
modifier|*
name|connector_count
init|=
operator|&
name|pkg
operator|->
name|Package
operator|.
name|Elements
index|[
literal|0
index|]
decl_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"MUX info connectors: %lld\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|connector_count
operator|->
name|Integer
operator|.
name|Value
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|pkg
operator|->
name|Package
operator|.
name|Count
condition|;
name|i
operator|++
control|)
block|{
name|ACPI_OBJECT
modifier|*
name|obj
init|=
operator|&
name|pkg
operator|->
name|Package
operator|.
name|Elements
index|[
name|i
index|]
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|connector_id
init|=
operator|&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|0
index|]
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|info
init|=
operator|&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|1
index|]
decl_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Connector id: 0x%016llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|connector_id
operator|->
name|Integer
operator|.
name|Value
argument_list|)
expr_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"  port id: %s\n"
argument_list|,
name|intel_dsm_port_name
argument_list|(
name|info
operator|->
name|Buffer
operator|.
name|Pointer
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"  display mux info: %s\n"
argument_list|,
name|intel_dsm_mux_type
argument_list|(
name|info
operator|->
name|Buffer
operator|.
name|Pointer
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"  aux/dc mux info: %s\n"
argument_list|,
name|intel_dsm_mux_type
argument_list|(
name|info
operator|->
name|Buffer
operator|.
name|Pointer
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"  hpd mux info: %s\n"
argument_list|,
name|intel_dsm_mux_type
argument_list|(
name|info
operator|->
name|Buffer
operator|.
name|Pointer
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|out
label|:
name|AcpiOsFree
argument_list|(
name|output
operator|.
name|Pointer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|intel_dsm_pci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|ACPI_HANDLE
name|dhandle
decl_stmt|,
name|intel_handle
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|dhandle
operator|=
name|acpi_get_handle
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dhandle
condition|)
return|return
name|false
return|;
name|status
operator|=
name|AcpiGetHandle
argument_list|(
name|dhandle
argument_list|,
literal|"_DSM"
argument_list|,
operator|&
name|intel_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"no _DSM method for intel device\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|ret
operator|=
name|intel_dsm
argument_list|(
name|dhandle
argument_list|,
name|INTEL_DSM_FN_SUPPORTED_FUNCTIONS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"failed to get supported _DSM functions\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|intel_dsm_priv
operator|.
name|dhandle
operator|=
name|dhandle
expr_stmt|;
name|intel_dsm_platform_mux_info
argument_list|()
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|intel_dsm_detect
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|acpi_method_name
index|[
literal|255
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ACPI_BUFFER
name|buffer
init|=
block|{
sizeof|sizeof
argument_list|(
name|acpi_method_name
argument_list|)
block|,
name|acpi_method_name
block|}
decl_stmt|;
name|device_t
name|dev
init|=
name|NULL
decl_stmt|;
name|bool
name|has_dsm
init|=
name|false
decl_stmt|;
name|int
name|vga_count
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|FREEBSD_WIP
while|while
condition|(
operator|(
name|pdev
operator|=
name|pci_get_class
argument_list|(
name|PCI_CLASS_DISPLAY_VGA
operator|<<
literal|8
argument_list|,
name|pdev
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
endif|#
directive|endif
comment|/* FREEBSD_WIP */
if|if
condition|(
operator|(
name|dev
operator|=
name|pci_find_class
argument_list|(
name|PCIC_DISPLAY
argument_list|,
name|PCIS_DISPLAY_VGA
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|vga_count
operator|++
expr_stmt|;
name|has_dsm
operator||=
name|intel_dsm_pci_probe
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vga_count
operator|==
literal|2
operator|&&
name|has_dsm
condition|)
block|{
name|AcpiGetName
argument_list|(
name|intel_dsm_priv
operator|.
name|dhandle
argument_list|,
name|ACPI_FULL_PATHNAME
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"VGA switcheroo: detected DSM switching method %s handle\n"
argument_list|,
name|acpi_method_name
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
return|return
name|false
return|;
block|}
name|void
name|intel_register_dsm_handler
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|intel_dsm_detect
argument_list|()
condition|)
return|return;
block|}
name|void
name|intel_unregister_dsm_handler
parameter_list|(
name|void
parameter_list|)
block|{ }
end_function

end_unit


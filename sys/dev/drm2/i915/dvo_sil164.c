begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**************************************************************************  Copyright Â© 2006 Dave Airlie  All Rights Reserved.  Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sub license, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:  The above copyright notice and this permission notice (including the next paragraph) shall be included in all copies or substantial portions of the Software.  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.  **************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"dvo.h"
end_include

begin_define
define|#
directive|define
name|SIL164_VID
value|0x0001
end_define

begin_define
define|#
directive|define
name|SIL164_DID
value|0x0006
end_define

begin_define
define|#
directive|define
name|SIL164_VID_LO
value|0x00
end_define

begin_define
define|#
directive|define
name|SIL164_VID_HI
value|0x01
end_define

begin_define
define|#
directive|define
name|SIL164_DID_LO
value|0x02
end_define

begin_define
define|#
directive|define
name|SIL164_DID_HI
value|0x03
end_define

begin_define
define|#
directive|define
name|SIL164_REV
value|0x04
end_define

begin_define
define|#
directive|define
name|SIL164_RSVD
value|0x05
end_define

begin_define
define|#
directive|define
name|SIL164_FREQ_LO
value|0x06
end_define

begin_define
define|#
directive|define
name|SIL164_FREQ_HI
value|0x07
end_define

begin_define
define|#
directive|define
name|SIL164_REG8
value|0x08
end_define

begin_define
define|#
directive|define
name|SIL164_8_VEN
value|(1<<5)
end_define

begin_define
define|#
directive|define
name|SIL164_8_HEN
value|(1<<4)
end_define

begin_define
define|#
directive|define
name|SIL164_8_DSEL
value|(1<<3)
end_define

begin_define
define|#
directive|define
name|SIL164_8_BSEL
value|(1<<2)
end_define

begin_define
define|#
directive|define
name|SIL164_8_EDGE
value|(1<<1)
end_define

begin_define
define|#
directive|define
name|SIL164_8_PD
value|(1<<0)
end_define

begin_define
define|#
directive|define
name|SIL164_REG9
value|0x09
end_define

begin_define
define|#
directive|define
name|SIL164_9_VLOW
value|(1<<7)
end_define

begin_define
define|#
directive|define
name|SIL164_9_MSEL_MASK
value|(0x7<<4)
end_define

begin_define
define|#
directive|define
name|SIL164_9_TSEL
value|(1<<3)
end_define

begin_define
define|#
directive|define
name|SIL164_9_RSEN
value|(1<<2)
end_define

begin_define
define|#
directive|define
name|SIL164_9_HTPLG
value|(1<<1)
end_define

begin_define
define|#
directive|define
name|SIL164_9_MDI
value|(1<<0)
end_define

begin_define
define|#
directive|define
name|SIL164_REGC
value|0x0c
end_define

begin_struct
struct|struct
name|sil164_priv
block|{
comment|//I2CDevRec d;
name|bool
name|quiet
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SILPTR
parameter_list|(
name|d
parameter_list|)
value|((SIL164Ptr)(d->DriverPrivate.ptr))
end_define

begin_function
specifier|static
name|bool
name|sil164_readb
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|int
name|addr
parameter_list|,
name|uint8_t
modifier|*
name|ch
parameter_list|)
block|{
name|struct
name|sil164_priv
modifier|*
name|sil
init|=
name|dvo
operator|->
name|dev_priv
decl_stmt|;
name|device_t
name|adapter
init|=
name|dvo
operator|->
name|i2c_bus
decl_stmt|;
name|u8
name|out_buf
index|[
literal|2
index|]
decl_stmt|;
name|u8
name|in_buf
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|iic_msg
name|msgs
index|[]
init|=
block|{
block|{
operator|.
name|slave
operator|=
name|dvo
operator|->
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
literal|0
block|,
operator|.
name|len
operator|=
literal|1
block|,
operator|.
name|buf
operator|=
name|out_buf
block|, 		}
block|,
block|{
operator|.
name|slave
operator|=
name|dvo
operator|->
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
name|I2C_M_RD
block|,
operator|.
name|len
operator|=
literal|1
block|,
operator|.
name|buf
operator|=
name|in_buf
block|, 		}
block|}
decl_stmt|;
name|out_buf
index|[
literal|0
index|]
operator|=
name|addr
expr_stmt|;
name|out_buf
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|-
name|iicbus_transfer
argument_list|(
name|adapter
argument_list|,
name|msgs
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|ch
operator|=
name|in_buf
index|[
literal|0
index|]
expr_stmt|;
return|return
name|true
return|;
block|}
if|if
condition|(
operator|!
name|sil
operator|->
name|quiet
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Unable to read register 0x%02x from %s:%02x.\n"
argument_list|,
name|addr
argument_list|,
name|device_get_nameunit
argument_list|(
name|adapter
argument_list|)
argument_list|,
name|dvo
operator|->
name|slave_addr
argument_list|)
expr_stmt|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|sil164_writeb
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|int
name|addr
parameter_list|,
name|uint8_t
name|ch
parameter_list|)
block|{
name|struct
name|sil164_priv
modifier|*
name|sil
init|=
name|dvo
operator|->
name|dev_priv
decl_stmt|;
name|device_t
name|adapter
init|=
name|dvo
operator|->
name|i2c_bus
decl_stmt|;
name|uint8_t
name|out_buf
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|iic_msg
name|msg
init|=
block|{
operator|.
name|slave
operator|=
name|dvo
operator|->
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
literal|0
block|,
operator|.
name|len
operator|=
literal|2
block|,
operator|.
name|buf
operator|=
name|out_buf
block|, 	}
decl_stmt|;
name|out_buf
index|[
literal|0
index|]
operator|=
name|addr
expr_stmt|;
name|out_buf
index|[
literal|1
index|]
operator|=
name|ch
expr_stmt|;
if|if
condition|(
operator|-
name|iicbus_transfer
argument_list|(
name|adapter
argument_list|,
operator|&
name|msg
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
return|return
name|true
return|;
if|if
condition|(
operator|!
name|sil
operator|->
name|quiet
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Unable to write register 0x%02x to %s:%d.\n"
argument_list|,
name|addr
argument_list|,
name|device_get_nameunit
argument_list|(
name|adapter
argument_list|)
argument_list|,
name|dvo
operator|->
name|slave_addr
argument_list|)
expr_stmt|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_comment
comment|/* Silicon Image 164 driver for chip on i2c bus */
end_comment

begin_function
specifier|static
name|bool
name|sil164_init
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|device_t
name|adapter
parameter_list|)
block|{
comment|/* this will detect the SIL164 chip on the specified i2c bus */
name|struct
name|sil164_priv
modifier|*
name|sil
decl_stmt|;
name|unsigned
name|char
name|ch
decl_stmt|;
name|sil
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sil164_priv
argument_list|)
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|sil
operator|==
name|NULL
condition|)
return|return
name|false
return|;
name|dvo
operator|->
name|i2c_bus
operator|=
name|adapter
expr_stmt|;
name|dvo
operator|->
name|dev_priv
operator|=
name|sil
expr_stmt|;
name|sil
operator|->
name|quiet
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|!
name|sil164_readb
argument_list|(
name|dvo
argument_list|,
name|SIL164_VID_LO
argument_list|,
operator|&
name|ch
argument_list|)
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|ch
operator|!=
operator|(
name|SIL164_VID
operator|&
literal|0xff
operator|)
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"sil164 not detected got %d: from %s Slave %d.\n"
argument_list|,
name|ch
argument_list|,
name|device_get_nameunit
argument_list|(
name|adapter
argument_list|)
argument_list|,
name|dvo
operator|->
name|slave_addr
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|sil164_readb
argument_list|(
name|dvo
argument_list|,
name|SIL164_DID_LO
argument_list|,
operator|&
name|ch
argument_list|)
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|ch
operator|!=
operator|(
name|SIL164_DID
operator|&
literal|0xff
operator|)
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"sil164 not detected got %d: from %s Slave %d.\n"
argument_list|,
name|ch
argument_list|,
name|device_get_nameunit
argument_list|(
name|adapter
argument_list|)
argument_list|,
name|dvo
operator|->
name|slave_addr
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|sil
operator|->
name|quiet
operator|=
name|false
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"init sil164 dvo controller successfully!\n"
argument_list|)
expr_stmt|;
return|return
name|true
return|;
name|out
label|:
name|free
argument_list|(
name|sil
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|drm_connector_status
name|sil164_detect
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
name|uint8_t
name|reg9
decl_stmt|;
name|sil164_readb
argument_list|(
name|dvo
argument_list|,
name|SIL164_REG9
argument_list|,
operator|&
name|reg9
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg9
operator|&
name|SIL164_9_HTPLG
condition|)
return|return
name|connector_status_connected
return|;
else|else
return|return
name|connector_status_disconnected
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|drm_mode_status
name|sil164_mode_valid
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
return|return
name|MODE_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sil164_mode_set
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
comment|/* As long as the basics are set up, since we don't have clock 	 * dependencies in the mode setup, we can just leave the 	 * registers alone and everything will work fine. 	 */
comment|/* recommended programming sequence from doc */
comment|/*sil164_writeb(sil, 0x08, 0x30); 	  sil164_writeb(sil, 0x09, 0x00); 	  sil164_writeb(sil, 0x0a, 0x90); 	  sil164_writeb(sil, 0x0c, 0x89); 	  sil164_writeb(sil, 0x08, 0x31);*/
comment|/* don't do much */
return|return;
block|}
end_function

begin_comment
comment|/* set the SIL164 power state */
end_comment

begin_function
specifier|static
name|void
name|sil164_dpms
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|char
name|ch
decl_stmt|;
name|ret
operator|=
name|sil164_readb
argument_list|(
name|dvo
argument_list|,
name|SIL164_REG8
argument_list|,
operator|&
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|false
condition|)
return|return;
if|if
condition|(
name|enable
condition|)
name|ch
operator||=
name|SIL164_8_PD
expr_stmt|;
else|else
name|ch
operator|&=
operator|~
name|SIL164_8_PD
expr_stmt|;
name|sil164_writeb
argument_list|(
name|dvo
argument_list|,
name|SIL164_REG8
argument_list|,
name|ch
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|bool
name|sil164_get_hw_state
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|char
name|ch
decl_stmt|;
name|ret
operator|=
name|sil164_readb
argument_list|(
name|dvo
argument_list|,
name|SIL164_REG8
argument_list|,
operator|&
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|false
condition|)
return|return
name|false
return|;
if|if
condition|(
name|ch
operator|&
name|SIL164_8_PD
condition|)
return|return
name|true
return|;
else|else
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sil164_dump_regs
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
name|sil164_readb
argument_list|(
name|dvo
argument_list|,
name|SIL164_FREQ_LO
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"SIL164_FREQ_LO: 0x%02x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sil164_readb
argument_list|(
name|dvo
argument_list|,
name|SIL164_FREQ_HI
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"SIL164_FREQ_HI: 0x%02x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sil164_readb
argument_list|(
name|dvo
argument_list|,
name|SIL164_REG8
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"SIL164_REG8: 0x%02x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sil164_readb
argument_list|(
name|dvo
argument_list|,
name|SIL164_REG9
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"SIL164_REG9: 0x%02x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sil164_readb
argument_list|(
name|dvo
argument_list|,
name|SIL164_REGC
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|DRM_LOG_KMS
argument_list|(
literal|"SIL164_REGC: 0x%02x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sil164_destroy
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
name|struct
name|sil164_priv
modifier|*
name|sil
init|=
name|dvo
operator|->
name|dev_priv
decl_stmt|;
if|if
condition|(
name|sil
condition|)
block|{
name|free
argument_list|(
name|sil
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
name|dvo
operator|->
name|dev_priv
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
name|struct
name|intel_dvo_dev_ops
name|sil164_ops
init|=
block|{
operator|.
name|init
operator|=
name|sil164_init
block|,
operator|.
name|detect
operator|=
name|sil164_detect
block|,
operator|.
name|mode_valid
operator|=
name|sil164_mode_valid
block|,
operator|.
name|mode_set
operator|=
name|sil164_mode_set
block|,
operator|.
name|dpms
operator|=
name|sil164_dpms
block|,
operator|.
name|get_hw_state
operator|=
name|sil164_get_hw_state
block|,
operator|.
name|dump_regs
operator|=
name|sil164_dump_regs
block|,
operator|.
name|destroy
operator|=
name|sil164_destroy
block|, }
decl_stmt|;
end_decl_stmt

end_unit


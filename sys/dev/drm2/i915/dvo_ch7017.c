begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright Â© 2006 Intel Corporation  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Eric Anholt<eric@anholt.net>  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"dvo.h"
end_include

begin_define
define|#
directive|define
name|CH7017_TV_DISPLAY_MODE
value|0x00
end_define

begin_define
define|#
directive|define
name|CH7017_FLICKER_FILTER
value|0x01
end_define

begin_define
define|#
directive|define
name|CH7017_VIDEO_BANDWIDTH
value|0x02
end_define

begin_define
define|#
directive|define
name|CH7017_TEXT_ENHANCEMENT
value|0x03
end_define

begin_define
define|#
directive|define
name|CH7017_START_ACTIVE_VIDEO
value|0x04
end_define

begin_define
define|#
directive|define
name|CH7017_HORIZONTAL_POSITION
value|0x05
end_define

begin_define
define|#
directive|define
name|CH7017_VERTICAL_POSITION
value|0x06
end_define

begin_define
define|#
directive|define
name|CH7017_BLACK_LEVEL
value|0x07
end_define

begin_define
define|#
directive|define
name|CH7017_CONTRAST_ENHANCEMENT
value|0x08
end_define

begin_define
define|#
directive|define
name|CH7017_TV_PLL
value|0x09
end_define

begin_define
define|#
directive|define
name|CH7017_TV_PLL_M
value|0x0a
end_define

begin_define
define|#
directive|define
name|CH7017_TV_PLL_N
value|0x0b
end_define

begin_define
define|#
directive|define
name|CH7017_SUB_CARRIER_0
value|0x0c
end_define

begin_define
define|#
directive|define
name|CH7017_CIV_CONTROL
value|0x10
end_define

begin_define
define|#
directive|define
name|CH7017_CIV_0
value|0x11
end_define

begin_define
define|#
directive|define
name|CH7017_CHROMA_BOOST
value|0x14
end_define

begin_define
define|#
directive|define
name|CH7017_CLOCK_MODE
value|0x1c
end_define

begin_define
define|#
directive|define
name|CH7017_INPUT_CLOCK
value|0x1d
end_define

begin_define
define|#
directive|define
name|CH7017_GPIO_CONTROL
value|0x1e
end_define

begin_define
define|#
directive|define
name|CH7017_INPUT_DATA_FORMAT
value|0x1f
end_define

begin_define
define|#
directive|define
name|CH7017_CONNECTION_DETECT
value|0x20
end_define

begin_define
define|#
directive|define
name|CH7017_DAC_CONTROL
value|0x21
end_define

begin_define
define|#
directive|define
name|CH7017_BUFFERED_CLOCK_OUTPUT
value|0x22
end_define

begin_define
define|#
directive|define
name|CH7017_DEFEAT_VSYNC
value|0x47
end_define

begin_define
define|#
directive|define
name|CH7017_TEST_PATTERN
value|0x48
end_define

begin_define
define|#
directive|define
name|CH7017_POWER_MANAGEMENT
value|0x49
end_define

begin_comment
comment|/** Enables the TV output path. */
end_comment

begin_define
define|#
directive|define
name|CH7017_TV_EN
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|CH7017_DAC0_POWER_DOWN
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|CH7017_DAC1_POWER_DOWN
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|CH7017_DAC2_POWER_DOWN
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|CH7017_DAC3_POWER_DOWN
value|(1<< 4)
end_define

begin_comment
comment|/** Powers down the TV out block, and DAC0-3 */
end_comment

begin_define
define|#
directive|define
name|CH7017_TV_POWER_DOWN_EN
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|CH7017_VERSION_ID
value|0x4a
end_define

begin_define
define|#
directive|define
name|CH7017_DEVICE_ID
value|0x4b
end_define

begin_define
define|#
directive|define
name|CH7017_DEVICE_ID_VALUE
value|0x1b
end_define

begin_define
define|#
directive|define
name|CH7018_DEVICE_ID_VALUE
value|0x1a
end_define

begin_define
define|#
directive|define
name|CH7019_DEVICE_ID_VALUE
value|0x19
end_define

begin_define
define|#
directive|define
name|CH7017_XCLK_D2_ADJUST
value|0x53
end_define

begin_define
define|#
directive|define
name|CH7017_UP_SCALER_COEFF_0
value|0x55
end_define

begin_define
define|#
directive|define
name|CH7017_UP_SCALER_COEFF_1
value|0x56
end_define

begin_define
define|#
directive|define
name|CH7017_UP_SCALER_COEFF_2
value|0x57
end_define

begin_define
define|#
directive|define
name|CH7017_UP_SCALER_COEFF_3
value|0x58
end_define

begin_define
define|#
directive|define
name|CH7017_UP_SCALER_COEFF_4
value|0x59
end_define

begin_define
define|#
directive|define
name|CH7017_UP_SCALER_VERTICAL_INC_0
value|0x5a
end_define

begin_define
define|#
directive|define
name|CH7017_UP_SCALER_VERTICAL_INC_1
value|0x5b
end_define

begin_define
define|#
directive|define
name|CH7017_GPIO_INVERT
value|0x5c
end_define

begin_define
define|#
directive|define
name|CH7017_UP_SCALER_HORIZONTAL_INC_0
value|0x5d
end_define

begin_define
define|#
directive|define
name|CH7017_UP_SCALER_HORIZONTAL_INC_1
value|0x5e
end_define

begin_define
define|#
directive|define
name|CH7017_HORIZONTAL_ACTIVE_PIXEL_INPUT
value|0x5f
end_define

begin_comment
comment|/**< Low bits of horizontal active pixel input */
end_comment

begin_define
define|#
directive|define
name|CH7017_ACTIVE_INPUT_LINE_OUTPUT
value|0x60
end_define

begin_comment
comment|/** High bits of horizontal active pixel input */
end_comment

begin_define
define|#
directive|define
name|CH7017_LVDS_HAP_INPUT_MASK
value|(0x7<< 0)
end_define

begin_comment
comment|/** High bits of vertical active line output */
end_comment

begin_define
define|#
directive|define
name|CH7017_LVDS_VAL_HIGH_MASK
value|(0x7<< 3)
end_define

begin_define
define|#
directive|define
name|CH7017_VERTICAL_ACTIVE_LINE_OUTPUT
value|0x61
end_define

begin_comment
comment|/**< Low bits of vertical active line output */
end_comment

begin_define
define|#
directive|define
name|CH7017_HORIZONTAL_ACTIVE_PIXEL_OUTPUT
value|0x62
end_define

begin_comment
comment|/**< Low bits of horizontal active pixel output */
end_comment

begin_define
define|#
directive|define
name|CH7017_LVDS_POWER_DOWN
value|0x63
end_define

begin_comment
comment|/** High bits of horizontal active pixel output */
end_comment

begin_define
define|#
directive|define
name|CH7017_LVDS_HAP_HIGH_MASK
value|(0x7<< 0)
end_define

begin_comment
comment|/** Enables the LVDS power down state transition */
end_comment

begin_define
define|#
directive|define
name|CH7017_LVDS_POWER_DOWN_EN
value|(1<< 6)
end_define

begin_comment
comment|/** Enables the LVDS upscaler */
end_comment

begin_define
define|#
directive|define
name|CH7017_LVDS_UPSCALER_EN
value|(1<< 7)
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_POWER_DOWN_DEFAULT_RESERVED
value|0x08
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_ENCODING
value|0x64
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_DITHER_2D
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_DITHER_DIS
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_DUAL_CHANNEL_EN
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_24_BIT
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_ENCODING_2
value|0x65
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_PLL_CONTROL
value|0x66
end_define

begin_comment
comment|/** Enables the LVDS panel output path */
end_comment

begin_define
define|#
directive|define
name|CH7017_LVDS_PANEN
value|(1<< 0)
end_define

begin_comment
comment|/** Enables the LVDS panel backlight */
end_comment

begin_define
define|#
directive|define
name|CH7017_LVDS_BKLEN
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|CH7017_POWER_SEQUENCING_T1
value|0x67
end_define

begin_define
define|#
directive|define
name|CH7017_POWER_SEQUENCING_T2
value|0x68
end_define

begin_define
define|#
directive|define
name|CH7017_POWER_SEQUENCING_T3
value|0x69
end_define

begin_define
define|#
directive|define
name|CH7017_POWER_SEQUENCING_T4
value|0x6a
end_define

begin_define
define|#
directive|define
name|CH7017_POWER_SEQUENCING_T5
value|0x6b
end_define

begin_define
define|#
directive|define
name|CH7017_GPIO_DRIVER_TYPE
value|0x6c
end_define

begin_define
define|#
directive|define
name|CH7017_GPIO_DATA
value|0x6d
end_define

begin_define
define|#
directive|define
name|CH7017_GPIO_DIRECTION_CONTROL
value|0x6e
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_PLL_FEEDBACK_DIV
value|0x71
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_PLL_FEED_BACK_DIVIDER_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_PLL_FEED_FORWARD_DIVIDER_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_PLL_FEEDBACK_DEFAULT_RESERVED
value|0x80
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_PLL_VCO_CONTROL
value|0x72
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED
value|0x80
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_PLL_VCO_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|CH7017_OUTPUTS_ENABLE
value|0x73
end_define

begin_define
define|#
directive|define
name|CH7017_CHARGE_PUMP_LOW
value|0x0
end_define

begin_define
define|#
directive|define
name|CH7017_CHARGE_PUMP_HIGH
value|0x3
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_CHANNEL_A
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_CHANNEL_B
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|CH7017_TV_DAC_A
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|CH7017_TV_DAC_B
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|CH7017_DDC_SELECT_DC2
value|(1<< 7)
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_OUTPUT_AMPLITUDE
value|0x74
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_PLL_EMI_REDUCTION
value|0x75
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_POWER_DOWN_FLICKER
value|0x76
end_define

begin_define
define|#
directive|define
name|CH7017_LVDS_CONTROL_2
value|0x78
end_define

begin_define
define|#
directive|define
name|CH7017_LOOP_FILTER_SHIFT
value|5
end_define

begin_define
define|#
directive|define
name|CH7017_PHASE_DETECTOR_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|CH7017_BANG_LIMIT_CONTROL
value|0x7f
end_define

begin_struct
struct|struct
name|ch7017_priv
block|{
name|uint8_t
name|dummy
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|ch7017_dump_regs
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ch7017_dpms
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|bool
name|enable
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|bool
name|ch7017_read
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|u8
name|addr
parameter_list|,
name|u8
modifier|*
name|val
parameter_list|)
block|{
name|struct
name|iic_msg
name|msgs
index|[]
init|=
block|{
block|{
operator|.
name|slave
operator|=
name|dvo
operator|->
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
literal|0
block|,
operator|.
name|len
operator|=
literal|1
block|,
operator|.
name|buf
operator|=
operator|&
name|addr
block|, 		}
block|,
block|{
operator|.
name|slave
operator|=
name|dvo
operator|->
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
name|I2C_M_RD
block|,
operator|.
name|len
operator|=
literal|1
block|,
operator|.
name|buf
operator|=
name|val
block|, 		}
block|}
decl_stmt|;
return|return
operator|-
name|iicbus_transfer
argument_list|(
name|dvo
operator|->
name|i2c_bus
argument_list|,
name|msgs
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ch7017_write
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|u8
name|addr
parameter_list|,
name|u8
name|val
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
literal|2
index|]
init|=
block|{
name|addr
block|,
name|val
block|}
decl_stmt|;
name|struct
name|iic_msg
name|msg
init|=
block|{
operator|.
name|slave
operator|=
name|dvo
operator|->
name|slave_addr
operator|<<
literal|1
block|,
operator|.
name|flags
operator|=
literal|0
block|,
operator|.
name|len
operator|=
literal|2
block|,
operator|.
name|buf
operator|=
name|buf
block|, 	}
decl_stmt|;
return|return
operator|-
name|iicbus_transfer
argument_list|(
name|dvo
operator|->
name|i2c_bus
argument_list|,
operator|&
name|msg
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Probes for a CH7017 on the given bus and slave address. */
end_comment

begin_function
specifier|static
name|bool
name|ch7017_init
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|device_t
name|adapter
parameter_list|)
block|{
name|struct
name|ch7017_priv
modifier|*
name|priv
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|u8
name|val
decl_stmt|;
name|priv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ch7017_priv
argument_list|)
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|==
name|NULL
condition|)
return|return
name|false
return|;
name|dvo
operator|->
name|i2c_bus
operator|=
name|adapter
expr_stmt|;
name|dvo
operator|->
name|dev_priv
operator|=
name|priv
expr_stmt|;
if|if
condition|(
operator|!
name|ch7017_read
argument_list|(
name|dvo
argument_list|,
name|CH7017_DEVICE_ID
argument_list|,
operator|&
name|val
argument_list|)
condition|)
goto|goto
name|fail
goto|;
switch|switch
condition|(
name|val
condition|)
block|{
case|case
name|CH7017_DEVICE_ID_VALUE
case|:
name|str
operator|=
literal|"ch7017"
expr_stmt|;
break|break;
case|case
name|CH7018_DEVICE_ID_VALUE
case|:
name|str
operator|=
literal|"ch7018"
expr_stmt|;
break|break;
case|case
name|CH7019_DEVICE_ID_VALUE
case|:
name|str
operator|=
literal|"ch7019"
expr_stmt|;
break|break;
default|default:
name|DRM_DEBUG_KMS
argument_list|(
literal|"ch701x not detected, got %d: from %s "
literal|"slave %d.\n"
argument_list|,
name|val
argument_list|,
name|device_get_nameunit
argument_list|(
name|adapter
argument_list|)
argument_list|,
name|dvo
operator|->
name|slave_addr
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|DRM_DEBUG_KMS
argument_list|(
literal|"%s detected on %s, addr %d\n"
argument_list|,
name|str
argument_list|,
name|device_get_nameunit
argument_list|(
name|adapter
argument_list|)
argument_list|,
name|dvo
operator|->
name|slave_addr
argument_list|)
expr_stmt|;
return|return
name|true
return|;
name|fail
label|:
name|free
argument_list|(
name|priv
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|drm_connector_status
name|ch7017_detect
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
return|return
name|connector_status_connected
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|drm_mode_status
name|ch7017_mode_valid
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
if|if
condition|(
name|mode
operator|->
name|clock
operator|>
literal|160000
condition|)
return|return
name|MODE_CLOCK_HIGH
return|;
return|return
name|MODE_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ch7017_mode_set
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted_mode
parameter_list|)
block|{
name|uint8_t
name|lvds_pll_feedback_div
decl_stmt|,
name|lvds_pll_vco_control
decl_stmt|;
name|uint8_t
name|outputs_enable
decl_stmt|,
name|lvds_control_2
decl_stmt|,
name|lvds_power_down
decl_stmt|;
name|uint8_t
name|horizontal_active_pixel_input
decl_stmt|;
name|uint8_t
name|horizontal_active_pixel_output
decl_stmt|,
name|vertical_active_line_output
decl_stmt|;
name|uint8_t
name|active_input_line_output
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Registers before mode setting\n"
argument_list|)
expr_stmt|;
name|ch7017_dump_regs
argument_list|(
name|dvo
argument_list|)
expr_stmt|;
comment|/* LVDS PLL settings from page 75 of 7017-7017ds.pdf*/
if|if
condition|(
name|mode
operator|->
name|clock
operator|<
literal|100000
condition|)
block|{
name|outputs_enable
operator|=
name|CH7017_LVDS_CHANNEL_A
operator||
name|CH7017_CHARGE_PUMP_LOW
expr_stmt|;
name|lvds_pll_feedback_div
operator|=
name|CH7017_LVDS_PLL_FEEDBACK_DEFAULT_RESERVED
operator||
operator|(
literal|2
operator|<<
name|CH7017_LVDS_PLL_FEED_BACK_DIVIDER_SHIFT
operator|)
operator||
operator|(
literal|13
operator|<<
name|CH7017_LVDS_PLL_FEED_FORWARD_DIVIDER_SHIFT
operator|)
expr_stmt|;
name|lvds_pll_vco_control
operator|=
name|CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED
operator||
operator|(
literal|2
operator|<<
name|CH7017_LVDS_PLL_VCO_SHIFT
operator|)
operator||
operator|(
literal|3
operator|<<
name|CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT
operator|)
expr_stmt|;
name|lvds_control_2
operator|=
operator|(
literal|1
operator|<<
name|CH7017_LOOP_FILTER_SHIFT
operator|)
operator||
operator|(
literal|0
operator|<<
name|CH7017_PHASE_DETECTOR_SHIFT
operator|)
expr_stmt|;
block|}
else|else
block|{
name|outputs_enable
operator|=
name|CH7017_LVDS_CHANNEL_A
operator||
name|CH7017_CHARGE_PUMP_HIGH
expr_stmt|;
name|lvds_pll_feedback_div
operator|=
name|CH7017_LVDS_PLL_FEEDBACK_DEFAULT_RESERVED
operator||
operator|(
literal|2
operator|<<
name|CH7017_LVDS_PLL_FEED_BACK_DIVIDER_SHIFT
operator|)
operator||
operator|(
literal|3
operator|<<
name|CH7017_LVDS_PLL_FEED_FORWARD_DIVIDER_SHIFT
operator|)
expr_stmt|;
name|lvds_pll_feedback_div
operator|=
literal|35
expr_stmt|;
name|lvds_control_2
operator|=
operator|(
literal|3
operator|<<
name|CH7017_LOOP_FILTER_SHIFT
operator|)
operator||
operator|(
literal|0
operator|<<
name|CH7017_PHASE_DETECTOR_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
literal|1
condition|)
block|{
comment|/* XXX: dual channel panel detection.  Assume yes for now. */
name|outputs_enable
operator||=
name|CH7017_LVDS_CHANNEL_B
expr_stmt|;
name|lvds_pll_vco_control
operator|=
name|CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED
operator||
operator|(
literal|2
operator|<<
name|CH7017_LVDS_PLL_VCO_SHIFT
operator|)
operator||
operator|(
literal|13
operator|<<
name|CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT
operator|)
expr_stmt|;
block|}
else|else
block|{
name|lvds_pll_vco_control
operator|=
name|CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED
operator||
operator|(
literal|1
operator|<<
name|CH7017_LVDS_PLL_VCO_SHIFT
operator|)
operator||
operator|(
literal|13
operator|<<
name|CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT
operator|)
expr_stmt|;
block|}
block|}
name|horizontal_active_pixel_input
operator|=
name|mode
operator|->
name|hdisplay
operator|&
literal|0x00ff
expr_stmt|;
name|vertical_active_line_output
operator|=
name|mode
operator|->
name|vdisplay
operator|&
literal|0x00ff
expr_stmt|;
name|horizontal_active_pixel_output
operator|=
name|mode
operator|->
name|hdisplay
operator|&
literal|0x00ff
expr_stmt|;
name|active_input_line_output
operator|=
operator|(
operator|(
name|mode
operator|->
name|hdisplay
operator|&
literal|0x0700
operator|)
operator|>>
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|mode
operator|->
name|vdisplay
operator|&
literal|0x0700
operator|)
operator|>>
literal|8
operator|)
operator|<<
literal|3
operator|)
expr_stmt|;
name|lvds_power_down
operator|=
name|CH7017_LVDS_POWER_DOWN_DEFAULT_RESERVED
operator||
operator|(
name|mode
operator|->
name|hdisplay
operator|&
literal|0x0700
operator|)
operator|>>
literal|8
expr_stmt|;
name|ch7017_dpms
argument_list|(
name|dvo
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_HORIZONTAL_ACTIVE_PIXEL_INPUT
argument_list|,
name|horizontal_active_pixel_input
argument_list|)
expr_stmt|;
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_HORIZONTAL_ACTIVE_PIXEL_OUTPUT
argument_list|,
name|horizontal_active_pixel_output
argument_list|)
expr_stmt|;
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_VERTICAL_ACTIVE_LINE_OUTPUT
argument_list|,
name|vertical_active_line_output
argument_list|)
expr_stmt|;
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_ACTIVE_INPUT_LINE_OUTPUT
argument_list|,
name|active_input_line_output
argument_list|)
expr_stmt|;
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_LVDS_PLL_VCO_CONTROL
argument_list|,
name|lvds_pll_vco_control
argument_list|)
expr_stmt|;
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_LVDS_PLL_FEEDBACK_DIV
argument_list|,
name|lvds_pll_feedback_div
argument_list|)
expr_stmt|;
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_LVDS_CONTROL_2
argument_list|,
name|lvds_control_2
argument_list|)
expr_stmt|;
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_OUTPUTS_ENABLE
argument_list|,
name|outputs_enable
argument_list|)
expr_stmt|;
comment|/* Turn the LVDS back on with new settings. */
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_LVDS_POWER_DOWN
argument_list|,
name|lvds_power_down
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Registers after mode setting\n"
argument_list|)
expr_stmt|;
name|ch7017_dump_regs
argument_list|(
name|dvo
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* set the CH7017 power state */
end_comment

begin_function
specifier|static
name|void
name|ch7017_dpms
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
name|ch7017_read
argument_list|(
name|dvo
argument_list|,
name|CH7017_LVDS_POWER_DOWN
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
comment|/* Turn off TV/VGA, and never turn it on since we don't support it. */
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_POWER_MANAGEMENT
argument_list|,
name|CH7017_DAC0_POWER_DOWN
operator||
name|CH7017_DAC1_POWER_DOWN
operator||
name|CH7017_DAC2_POWER_DOWN
operator||
name|CH7017_DAC3_POWER_DOWN
operator||
name|CH7017_TV_POWER_DOWN_EN
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
block|{
comment|/* Turn on the LVDS */
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_LVDS_POWER_DOWN
argument_list|,
name|val
operator|&
operator|~
name|CH7017_LVDS_POWER_DOWN_EN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Turn off the LVDS */
name|ch7017_write
argument_list|(
name|dvo
argument_list|,
name|CH7017_LVDS_POWER_DOWN
argument_list|,
name|val
operator||
name|CH7017_LVDS_POWER_DOWN_EN
argument_list|)
expr_stmt|;
block|}
comment|/* XXX: Should actually wait for update power status somehow */
name|drm_msleep
argument_list|(
literal|20
argument_list|,
literal|"ch7017"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ch7017_get_hw_state
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
name|ch7017_read
argument_list|(
name|dvo
argument_list|,
name|CH7017_LVDS_POWER_DOWN
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|CH7017_LVDS_POWER_DOWN_EN
condition|)
return|return
name|false
return|;
else|else
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ch7017_dump_regs
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
define|#
directive|define
name|DUMP
parameter_list|(
name|reg
parameter_list|)
define|\
value|do {							\ 	ch7017_read(dvo, reg,&val);			\ 	DRM_DEBUG_KMS(#reg ": %02x\n", val);		\ } while (0)
name|DUMP
argument_list|(
name|CH7017_HORIZONTAL_ACTIVE_PIXEL_INPUT
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
name|CH7017_HORIZONTAL_ACTIVE_PIXEL_OUTPUT
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
name|CH7017_VERTICAL_ACTIVE_LINE_OUTPUT
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
name|CH7017_ACTIVE_INPUT_LINE_OUTPUT
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
name|CH7017_LVDS_PLL_VCO_CONTROL
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
name|CH7017_LVDS_PLL_FEEDBACK_DIV
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
name|CH7017_LVDS_CONTROL_2
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
name|CH7017_OUTPUTS_ENABLE
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
name|CH7017_LVDS_POWER_DOWN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ch7017_destroy
parameter_list|(
name|struct
name|intel_dvo_device
modifier|*
name|dvo
parameter_list|)
block|{
name|struct
name|ch7017_priv
modifier|*
name|priv
init|=
name|dvo
operator|->
name|dev_priv
decl_stmt|;
if|if
condition|(
name|priv
condition|)
block|{
name|free
argument_list|(
name|priv
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
name|dvo
operator|->
name|dev_priv
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
name|struct
name|intel_dvo_dev_ops
name|ch7017_ops
init|=
block|{
operator|.
name|init
operator|=
name|ch7017_init
block|,
operator|.
name|detect
operator|=
name|ch7017_detect
block|,
operator|.
name|mode_valid
operator|=
name|ch7017_mode_valid
block|,
operator|.
name|mode_set
operator|=
name|ch7017_mode_set
block|,
operator|.
name|dpms
operator|=
name|ch7017_dpms
block|,
operator|.
name|get_hw_state
operator|=
name|ch7017_get_hw_state
block|,
operator|.
name|dump_regs
operator|=
name|ch7017_dump_regs
block|,
operator|.
name|destroy
operator|=
name|ch7017_destroy
block|, }
decl_stmt|;
end_decl_stmt

end_unit


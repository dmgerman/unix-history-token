begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright Â© 2008 Intel Corporation  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS  * IN THE SOFTWARE.  *  * Authors:  *    Eric Anholt<eric@anholt.net>  *    Keith Packard<keithp@keithp.com>  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/i915_drm.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/i915_drv.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/intel_drv.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/i915/intel_ringbuffer.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_enum
enum|enum
block|{
name|ACTIVE_LIST
block|,
name|FLUSHING_LIST
block|,
name|INACTIVE_LIST
block|,
name|PINNED_LIST
block|, }
enum|;
end_enum

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|yesno
parameter_list|(
name|int
name|v
parameter_list|)
block|{
return|return
name|v
condition|?
literal|"yes"
else|:
literal|"no"
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_capabilities
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
specifier|const
name|struct
name|intel_device_info
modifier|*
name|info
init|=
name|INTEL_INFO
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"gen: %d\n"
argument_list|,
name|info
operator|->
name|gen
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAS_PCH_SPLIT
argument_list|(
name|dev
argument_list|)
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"pch: %d\n"
argument_list|,
name|INTEL_PCH_TYPE
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
define|#
directive|define
name|B
parameter_list|(
name|x
parameter_list|)
value|sbuf_printf(m, #x ": %s\n", yesno(info->x))
name|B
argument_list|(
name|is_mobile
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|is_i85x
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|is_i915g
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|is_i945gm
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|is_g33
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|need_gfx_hws
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|is_g4x
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|is_pineview
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|has_fbc
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|has_pipe_cxsr
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|has_hotplug
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|cursor_needs_physical
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|has_overlay
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|overlay_needs_physical
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|supports_tv
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|has_bsd_ring
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|has_blt_ring
argument_list|)
expr_stmt|;
name|B
argument_list|(
name|has_llc
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|B
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_pin_flag
parameter_list|(
name|struct
name|drm_i915_gem_object
modifier|*
name|obj
parameter_list|)
block|{
if|if
condition|(
name|obj
operator|->
name|user_pin_count
operator|>
literal|0
condition|)
return|return
literal|"P"
return|;
elseif|else
if|if
condition|(
name|obj
operator|->
name|pin_count
operator|>
literal|0
condition|)
return|return
literal|"p"
return|;
else|else
return|return
literal|" "
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_tiling_flag
parameter_list|(
name|struct
name|drm_i915_gem_object
modifier|*
name|obj
parameter_list|)
block|{
switch|switch
condition|(
name|obj
operator|->
name|tiling_mode
condition|)
block|{
default|default:
case|case
name|I915_TILING_NONE
case|:
return|return
literal|" "
return|;
case|case
name|I915_TILING_X
case|:
return|return
literal|"X"
return|;
case|case
name|I915_TILING_Y
case|:
return|return
literal|"Y"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|cache_level_str
parameter_list|(
name|int
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|I915_CACHE_NONE
case|:
return|return
literal|" uncached"
return|;
case|case
name|I915_CACHE_LLC
case|:
return|return
literal|" snooped (LLC)"
return|;
case|case
name|I915_CACHE_LLC_MLC
case|:
return|return
literal|" snooped (LLC+MLC)"
return|;
default|default:
return|return
literal|""
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|describe_obj
parameter_list|(
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|struct
name|drm_i915_gem_object
modifier|*
name|obj
parameter_list|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%p: %s%s %8zdKiB %04x %04x %d %d%s%s%s"
argument_list|,
operator|&
name|obj
operator|->
name|base
argument_list|,
name|get_pin_flag
argument_list|(
name|obj
argument_list|)
argument_list|,
name|get_tiling_flag
argument_list|(
name|obj
argument_list|)
argument_list|,
name|obj
operator|->
name|base
operator|.
name|size
operator|/
literal|1024
argument_list|,
name|obj
operator|->
name|base
operator|.
name|read_domains
argument_list|,
name|obj
operator|->
name|base
operator|.
name|write_domain
argument_list|,
name|obj
operator|->
name|last_rendering_seqno
argument_list|,
name|obj
operator|->
name|last_fenced_seqno
argument_list|,
name|cache_level_str
argument_list|(
name|obj
operator|->
name|cache_level
argument_list|)
argument_list|,
name|obj
operator|->
name|dirty
condition|?
literal|" dirty"
else|:
literal|""
argument_list|,
name|obj
operator|->
name|madv
operator|==
name|I915_MADV_DONTNEED
condition|?
literal|" purgeable"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|->
name|base
operator|.
name|name
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|" (name: %d)"
argument_list|,
name|obj
operator|->
name|base
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|->
name|pin_display
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|" (display)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|->
name|fence_reg
operator|!=
name|I915_FENCE_REG_NONE
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|" (fence: %d)"
argument_list|,
name|obj
operator|->
name|fence_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|->
name|gtt_space
operator|!=
name|NULL
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|" (gtt offset: %08x, size: %08x)"
argument_list|,
name|obj
operator|->
name|gtt_offset
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|obj
operator|->
name|gtt_space
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|->
name|pin_mappable
operator|||
name|obj
operator|->
name|fault_mappable
condition|)
block|{
name|char
name|s
index|[
literal|3
index|]
decl_stmt|,
modifier|*
name|t
init|=
name|s
decl_stmt|;
if|if
condition|(
name|obj
operator|->
name|pin_mappable
condition|)
operator|*
name|t
operator|++
operator|=
literal|'p'
expr_stmt|;
if|if
condition|(
name|obj
operator|->
name|fault_mappable
condition|)
operator|*
name|t
operator|++
operator|=
literal|'f'
expr_stmt|;
operator|*
name|t
operator|=
literal|'\0'
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|" (%s mappable)"
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|obj
operator|->
name|ring
operator|!=
name|NULL
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|" (%s)"
argument_list|,
name|obj
operator|->
name|ring
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_gem_object_list_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|uintptr_t
name|list
init|=
operator|(
name|uintptr_t
operator|)
name|data
decl_stmt|;
name|struct
name|list_head
modifier|*
name|head
decl_stmt|;
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_i915_gem_object
modifier|*
name|obj
decl_stmt|;
name|size_t
name|total_obj_size
decl_stmt|,
name|total_gtt_size
decl_stmt|;
name|int
name|count
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
switch|switch
condition|(
name|list
condition|)
block|{
case|case
name|ACTIVE_LIST
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Active:\n"
argument_list|)
expr_stmt|;
name|head
operator|=
operator|&
name|dev_priv
operator|->
name|mm
operator|.
name|active_list
expr_stmt|;
break|break;
case|case
name|INACTIVE_LIST
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Inactive:\n"
argument_list|)
expr_stmt|;
name|head
operator|=
operator|&
name|dev_priv
operator|->
name|mm
operator|.
name|inactive_list
expr_stmt|;
break|break;
case|case
name|FLUSHING_LIST
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Flushing:\n"
argument_list|)
expr_stmt|;
name|head
operator|=
operator|&
name|dev_priv
operator|->
name|mm
operator|.
name|flushing_list
expr_stmt|;
break|break;
default|default:
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|total_obj_size
operator|=
name|total_gtt_size
operator|=
name|count
operator|=
literal|0
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|obj
argument_list|,
argument|head
argument_list|,
argument|mm_list
argument_list|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"   "
argument_list|)
expr_stmt|;
name|describe_obj
argument_list|(
name|m
argument_list|,
name|obj
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|total_obj_size
operator|+=
name|obj
operator|->
name|base
operator|.
name|size
expr_stmt|;
name|total_gtt_size
operator|+=
name|obj
operator|->
name|gtt_space
operator|->
name|size
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Total %d objects, %zu bytes, %zu GTT size\n"
argument_list|,
name|count
argument_list|,
name|total_obj_size
argument_list|,
name|total_gtt_size
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|count_objects
parameter_list|(
name|list
parameter_list|,
name|member
parameter_list|)
value|do { \ 	list_for_each_entry(obj, list, member) { \ 		size += obj->gtt_space->size; \ 		++count; \ 		if (obj->map_and_fenceable) { \ 			mappable_size += obj->gtt_space->size; \ 			++mappable_count; \ 		} \ 	} \ } while (0)
end_define

begin_function
specifier|static
name|int
name|i915_gem_object_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u32
name|count
decl_stmt|,
name|mappable_count
decl_stmt|;
name|size_t
name|size
decl_stmt|,
name|mappable_size
decl_stmt|;
name|struct
name|drm_i915_gem_object
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%u objects, %zu bytes\n"
argument_list|,
name|dev_priv
operator|->
name|mm
operator|.
name|object_count
argument_list|,
name|dev_priv
operator|->
name|mm
operator|.
name|object_memory
argument_list|)
expr_stmt|;
name|size
operator|=
name|count
operator|=
name|mappable_size
operator|=
name|mappable_count
operator|=
literal|0
expr_stmt|;
name|count_objects
argument_list|(
operator|&
name|dev_priv
operator|->
name|mm
operator|.
name|gtt_list
argument_list|,
name|gtt_list
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%u [%u] objects, %zu [%zu] bytes in gtt\n"
argument_list|,
name|count
argument_list|,
name|mappable_count
argument_list|,
name|size
argument_list|,
name|mappable_size
argument_list|)
expr_stmt|;
name|size
operator|=
name|count
operator|=
name|mappable_size
operator|=
name|mappable_count
operator|=
literal|0
expr_stmt|;
name|count_objects
argument_list|(
operator|&
name|dev_priv
operator|->
name|mm
operator|.
name|active_list
argument_list|,
name|mm_list
argument_list|)
expr_stmt|;
name|count_objects
argument_list|(
operator|&
name|dev_priv
operator|->
name|mm
operator|.
name|flushing_list
argument_list|,
name|mm_list
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  %u [%u] active objects, %zu [%zu] bytes\n"
argument_list|,
name|count
argument_list|,
name|mappable_count
argument_list|,
name|size
argument_list|,
name|mappable_size
argument_list|)
expr_stmt|;
name|size
operator|=
name|count
operator|=
name|mappable_size
operator|=
name|mappable_count
operator|=
literal|0
expr_stmt|;
name|count_objects
argument_list|(
operator|&
name|dev_priv
operator|->
name|mm
operator|.
name|inactive_list
argument_list|,
name|mm_list
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  %u [%u] inactive objects, %zu [%zu] bytes\n"
argument_list|,
name|count
argument_list|,
name|mappable_count
argument_list|,
name|size
argument_list|,
name|mappable_size
argument_list|)
expr_stmt|;
name|size
operator|=
name|count
operator|=
name|mappable_size
operator|=
name|mappable_count
operator|=
literal|0
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|obj
argument_list|,
argument|&dev_priv->mm.gtt_list
argument_list|,
argument|gtt_list
argument_list|)
block|{
if|if
condition|(
name|obj
operator|->
name|fault_mappable
condition|)
block|{
name|size
operator|+=
name|obj
operator|->
name|gtt_space
operator|->
name|size
expr_stmt|;
operator|++
name|count
expr_stmt|;
block|}
if|if
condition|(
name|obj
operator|->
name|pin_mappable
condition|)
block|{
name|mappable_size
operator|+=
name|obj
operator|->
name|gtt_space
operator|->
name|size
expr_stmt|;
operator|++
name|mappable_count
expr_stmt|;
block|}
block|}
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%u pinned mappable objects, %zu bytes\n"
argument_list|,
name|mappable_count
argument_list|,
name|mappable_size
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%u fault mappable objects, %zu bytes\n"
argument_list|,
name|count
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%zu [%zu] gtt total\n"
argument_list|,
name|dev_priv
operator|->
name|mm
operator|.
name|gtt_total
argument_list|,
name|dev_priv
operator|->
name|mm
operator|.
name|mappable_gtt_total
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_gem_gtt_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uintptr_t
name|list
init|=
operator|(
name|uintptr_t
operator|)
name|data
decl_stmt|;
name|struct
name|drm_i915_gem_object
modifier|*
name|obj
decl_stmt|;
name|size_t
name|total_obj_size
decl_stmt|,
name|total_gtt_size
decl_stmt|;
name|int
name|count
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|total_obj_size
operator|=
name|total_gtt_size
operator|=
name|count
operator|=
literal|0
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|obj
argument_list|,
argument|&dev_priv->mm.gtt_list
argument_list|,
argument|gtt_list
argument_list|)
block|{
if|if
condition|(
name|list
operator|==
name|PINNED_LIST
operator|&&
name|obj
operator|->
name|pin_count
operator|==
literal|0
condition|)
continue|continue;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"   "
argument_list|)
expr_stmt|;
name|describe_obj
argument_list|(
name|m
argument_list|,
name|obj
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|total_obj_size
operator|+=
name|obj
operator|->
name|base
operator|.
name|size
expr_stmt|;
name|total_gtt_size
operator|+=
name|obj
operator|->
name|gtt_space
operator|->
name|size
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Total %d objects, %zu bytes, %zu GTT size\n"
argument_list|,
name|count
argument_list|,
name|total_obj_size
argument_list|,
name|total_gtt_size
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_gem_pageflip_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|intel_crtc
modifier|*
name|crtc
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|crtc
argument_list|,
argument|&dev->mode_config.crtc_list
argument_list|,
argument|base.head
argument_list|)
block|{
specifier|const
name|char
name|pipe
init|=
name|pipe_name
argument_list|(
name|crtc
operator|->
name|pipe
argument_list|)
decl_stmt|;
specifier|const
name|char
name|plane
init|=
name|plane_name
argument_list|(
name|crtc
operator|->
name|plane
argument_list|)
decl_stmt|;
name|struct
name|intel_unpin_work
modifier|*
name|work
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|dev
operator|->
name|event_lock
argument_list|)
expr_stmt|;
name|work
operator|=
name|crtc
operator|->
name|unpin_work
expr_stmt|;
if|if
condition|(
name|work
operator|==
name|NULL
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"No flip due on pipe %c (plane %c)\n"
argument_list|,
name|pipe
argument_list|,
name|plane
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|work
operator|->
name|pending
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Flip queued on pipe %c (plane %c)\n"
argument_list|,
name|pipe
argument_list|,
name|plane
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Flip pending (waiting for vsync) on pipe %c (plane %c)\n"
argument_list|,
name|pipe
argument_list|,
name|plane
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|work
operator|->
name|enable_stall_check
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Stall check enabled, "
argument_list|)
expr_stmt|;
else|else
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Stall check waiting for page flip ioctl, "
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%d prepares\n"
argument_list|,
name|work
operator|->
name|pending
argument_list|)
expr_stmt|;
if|if
condition|(
name|work
operator|->
name|old_fb_obj
condition|)
block|{
name|struct
name|drm_i915_gem_object
modifier|*
name|obj
init|=
name|work
operator|->
name|old_fb_obj
decl_stmt|;
if|if
condition|(
name|obj
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Old framebuffer gtt_offset 0x%08x\n"
argument_list|,
name|obj
operator|->
name|gtt_offset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|work
operator|->
name|pending_flip_obj
condition|)
block|{
name|struct
name|drm_i915_gem_object
modifier|*
name|obj
init|=
name|work
operator|->
name|pending_flip_obj
decl_stmt|;
if|if
condition|(
name|obj
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"New framebuffer gtt_offset 0x%08x\n"
argument_list|,
name|obj
operator|->
name|gtt_offset
argument_list|)
expr_stmt|;
block|}
block|}
name|mtx_unlock
argument_list|(
operator|&
name|dev
operator|->
name|event_lock
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_gem_request_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_i915_gem_request
modifier|*
name|gem_request
decl_stmt|;
name|int
name|count
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|dev_priv
operator|->
name|rings
index|[
name|RCS
index|]
operator|.
name|request_list
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Render requests:\n"
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|gem_request
argument_list|,
argument|&dev_priv->rings[RCS].request_list
argument_list|,
argument|list
argument_list|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"    %d @ %d\n"
argument_list|,
name|gem_request
operator|->
name|seqno
argument_list|,
call|(
name|int
call|)
argument_list|(
name|jiffies
operator|-
name|gem_request
operator|->
name|emitted_jiffies
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|dev_priv
operator|->
name|rings
index|[
name|VCS
index|]
operator|.
name|request_list
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"BSD requests:\n"
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|gem_request
argument_list|,
argument|&dev_priv->rings[VCS].request_list
argument_list|,
argument|list
argument_list|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"    %d @ %d\n"
argument_list|,
name|gem_request
operator|->
name|seqno
argument_list|,
call|(
name|int
call|)
argument_list|(
name|jiffies
operator|-
name|gem_request
operator|->
name|emitted_jiffies
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|dev_priv
operator|->
name|rings
index|[
name|BCS
index|]
operator|.
name|request_list
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"BLT requests:\n"
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|gem_request
argument_list|,
argument|&dev_priv->rings[BCS].request_list
argument_list|,
argument|list
argument_list|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"    %d @ %d\n"
argument_list|,
name|gem_request
operator|->
name|seqno
argument_list|,
call|(
name|int
call|)
argument_list|(
name|jiffies
operator|-
name|gem_request
operator|->
name|emitted_jiffies
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|count
operator|++
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"No requests\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|i915_ring_seqno_info
parameter_list|(
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|struct
name|intel_ring_buffer
modifier|*
name|ring
parameter_list|)
block|{
if|if
condition|(
name|ring
operator|->
name|get_seqno
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Current sequence (%s): %d\n"
argument_list|,
name|ring
operator|->
name|name
argument_list|,
name|ring
operator|->
name|get_seqno
argument_list|(
name|ring
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|i915_gem_seqno_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|I915_NUM_RINGS
condition|;
name|i
operator|++
control|)
name|i915_ring_seqno_info
argument_list|(
name|m
argument_list|,
operator|&
name|dev_priv
operator|->
name|rings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_interrupt_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|,
name|pipe
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
if|if
condition|(
name|IS_VALLEYVIEW
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Display IER:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|VLV_IER
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Display IIR:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|VLV_IIR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Display IIR_RW:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|VLV_IIR_RW
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Display IMR:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|VLV_IMR
argument_list|)
argument_list|)
expr_stmt|;
name|for_each_pipe
argument_list|(
argument|pipe
argument_list|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Pipe %c stat:\t%08x\n"
argument_list|,
name|pipe_name
argument_list|(
name|pipe
argument_list|)
argument_list|,
name|I915_READ
argument_list|(
name|PIPESTAT
argument_list|(
name|pipe
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Master IER:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|VLV_MASTER_IER
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Render IER:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GTIER
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Render IIR:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GTIIR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Render IMR:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GTIMR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"PM IER:\t\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GEN6_PMIER
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"PM IIR:\t\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GEN6_PMIIR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"PM IMR:\t\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GEN6_PMIMR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Port hotplug:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|PORT_HOTPLUG_EN
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPFLIPSTAT:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|VLV_DPFLIPSTAT
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPINVGTT:\t%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|DPINVGTT
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|HAS_PCH_SPLIT
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Interrupt enable:    %08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|IER
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Interrupt identity:  %08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|IIR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Interrupt mask:      %08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|IMR
argument_list|)
argument_list|)
expr_stmt|;
name|for_each_pipe
argument_list|(
argument|pipe
argument_list|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Pipe %c stat:         %08x\n"
argument_list|,
name|pipe_name
argument_list|(
name|pipe
argument_list|)
argument_list|,
name|I915_READ
argument_list|(
name|PIPESTAT
argument_list|(
name|pipe
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"North Display Interrupt enable:		%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|DEIER
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"North Display Interrupt identity:	%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|DEIIR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"North Display Interrupt mask:		%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|DEIMR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"South Display Interrupt enable:		%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|SDEIER
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"South Display Interrupt identity:	%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|SDEIIR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"South Display Interrupt mask:		%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|SDEIMR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Graphics Interrupt enable:		%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GTIER
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Graphics Interrupt identity:		%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GTIIR
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Graphics Interrupt mask:		%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GTIMR
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Interrupts received: %d\n"
argument_list|,
name|atomic_read
argument_list|(
operator|&
name|dev_priv
operator|->
name|irq_received
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|I915_NUM_RINGS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|IS_GEN6
argument_list|(
name|dev
argument_list|)
operator|||
name|IS_GEN7
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Graphics Interrupt mask (%s):	%08x\n"
argument_list|,
name|dev_priv
operator|->
name|rings
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|I915_READ_IMR
argument_list|(
operator|&
name|dev_priv
operator|->
name|rings
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|i915_ring_seqno_info
argument_list|(
name|m
argument_list|,
operator|&
name|dev_priv
operator|->
name|rings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_gem_fence_regs_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Reserved fences = %d\n"
argument_list|,
name|dev_priv
operator|->
name|fence_reg_start
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Total fences = %d\n"
argument_list|,
name|dev_priv
operator|->
name|num_fence_regs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|num_fence_regs
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|drm_i915_gem_object
modifier|*
name|obj
init|=
name|dev_priv
operator|->
name|fence_regs
index|[
name|i
index|]
operator|.
name|obj
decl_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Fenced object[%2d] = "
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|==
name|NULL
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"unused"
argument_list|)
expr_stmt|;
else|else
name|describe_obj
argument_list|(
name|m
argument_list|,
name|obj
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_hws_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|intel_ring_buffer
modifier|*
name|ring
decl_stmt|;
specifier|const
specifier|volatile
name|u32
name|__iomem
modifier|*
name|hws
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ring
operator|=
operator|&
name|dev_priv
operator|->
name|rings
index|[
operator|(
name|uintptr_t
operator|)
name|data
index|]
expr_stmt|;
name|hws
operator|=
operator|(
specifier|volatile
name|u32
operator|*
operator|)
name|ring
operator|->
name|status_page
operator|.
name|page_addr
expr_stmt|;
if|if
condition|(
name|hws
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4096
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|/
literal|4
condition|;
name|i
operator|+=
literal|4
control|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"0x%08x: 0x%08x 0x%08x 0x%08x 0x%08x\n"
argument_list|,
name|i
operator|*
literal|4
argument_list|,
name|hws
index|[
name|i
index|]
argument_list|,
name|hws
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|hws
index|[
name|i
operator|+
literal|2
index|]
argument_list|,
name|hws
index|[
name|i
operator|+
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|ring_str
parameter_list|(
name|int
name|ring
parameter_list|)
block|{
switch|switch
condition|(
name|ring
condition|)
block|{
case|case
name|RCS
case|:
return|return
literal|" render"
return|;
case|case
name|VCS
case|:
return|return
literal|" bsd"
return|;
case|case
name|BCS
case|:
return|return
literal|" blt"
return|;
default|default:
return|return
literal|""
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|pin_flag
parameter_list|(
name|int
name|pinned
parameter_list|)
block|{
if|if
condition|(
name|pinned
operator|>
literal|0
condition|)
return|return
literal|" P"
return|;
elseif|else
if|if
condition|(
name|pinned
operator|<
literal|0
condition|)
return|return
literal|" p"
return|;
else|else
return|return
literal|""
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|tiling_flag
parameter_list|(
name|int
name|tiling
parameter_list|)
block|{
switch|switch
condition|(
name|tiling
condition|)
block|{
default|default:
case|case
name|I915_TILING_NONE
case|:
return|return
literal|""
return|;
case|case
name|I915_TILING_X
case|:
return|return
literal|" X"
return|;
case|case
name|I915_TILING_Y
case|:
return|return
literal|" Y"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dirty_flag
parameter_list|(
name|int
name|dirty
parameter_list|)
block|{
return|return
name|dirty
condition|?
literal|" dirty"
else|:
literal|""
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|purgeable_flag
parameter_list|(
name|int
name|purgeable
parameter_list|)
block|{
return|return
name|purgeable
condition|?
literal|" purgeable"
else|:
literal|""
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_error_buffers
parameter_list|(
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|drm_i915_error_buffer
modifier|*
name|err
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%s [%d]:\n"
argument_list|,
name|name
argument_list|,
name|count
argument_list|)
expr_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  %08x %8u %04x %04x %08x%s%s%s%s%s%s%s"
argument_list|,
name|err
operator|->
name|gtt_offset
argument_list|,
name|err
operator|->
name|size
argument_list|,
name|err
operator|->
name|read_domains
argument_list|,
name|err
operator|->
name|write_domain
argument_list|,
name|err
operator|->
name|seqno
argument_list|,
name|pin_flag
argument_list|(
name|err
operator|->
name|pinned
argument_list|)
argument_list|,
name|tiling_flag
argument_list|(
name|err
operator|->
name|tiling
argument_list|)
argument_list|,
name|dirty_flag
argument_list|(
name|err
operator|->
name|dirty
argument_list|)
argument_list|,
name|purgeable_flag
argument_list|(
name|err
operator|->
name|purgeable
argument_list|)
argument_list|,
name|err
operator|->
name|ring
operator|!=
operator|-
literal|1
condition|?
literal|" "
else|:
literal|""
argument_list|,
name|ring_str
argument_list|(
name|err
operator|->
name|ring
argument_list|)
argument_list|,
name|cache_level_str
argument_list|(
name|err
operator|->
name|cache_level
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|->
name|name
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|" (name: %d)"
argument_list|,
name|err
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|->
name|fence_reg
operator|!=
name|I915_FENCE_REG_NONE
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|" (fence: %d)"
argument_list|,
name|err
operator|->
name|fence_reg
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|err
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|i915_ring_error_state
parameter_list|(
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_i915_error_state
modifier|*
name|error
parameter_list|,
name|unsigned
name|ring
parameter_list|)
block|{
name|MPASS
argument_list|(
operator|(
name|ring
operator|<
name|I915_NUM_RINGS
operator|)
argument_list|)
expr_stmt|;
comment|/* shut up confused gcc */
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%s command stream:\n"
argument_list|,
name|ring_str
argument_list|(
name|ring
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  HEAD: 0x%08x\n"
argument_list|,
name|error
operator|->
name|head
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  TAIL: 0x%08x\n"
argument_list|,
name|error
operator|->
name|tail
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  ACTHD: 0x%08x\n"
argument_list|,
name|error
operator|->
name|acthd
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  IPEIR: 0x%08x\n"
argument_list|,
name|error
operator|->
name|ipeir
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  IPEHR: 0x%08x\n"
argument_list|,
name|error
operator|->
name|ipehr
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  INSTDONE: 0x%08x\n"
argument_list|,
name|error
operator|->
name|instdone
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|==
name|RCS
operator|&&
name|INTEL_INFO
argument_list|(
name|dev
argument_list|)
operator|->
name|gen
operator|>=
literal|4
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  INSTDONE1: 0x%08x\n"
argument_list|,
name|error
operator|->
name|instdone1
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  BBADDR: 0x%08jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|error
operator|->
name|bbaddr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|INTEL_INFO
argument_list|(
name|dev
argument_list|)
operator|->
name|gen
operator|>=
literal|4
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  INSTPS: 0x%08x\n"
argument_list|,
name|error
operator|->
name|instps
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  INSTPM: 0x%08x\n"
argument_list|,
name|error
operator|->
name|instpm
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  FADDR: 0x%08x\n"
argument_list|,
name|error
operator|->
name|faddr
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|INTEL_INFO
argument_list|(
name|dev
argument_list|)
operator|->
name|gen
operator|>=
literal|6
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  FAULT_REG: 0x%08x\n"
argument_list|,
name|error
operator|->
name|fault_reg
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  SYNC_0: 0x%08x\n"
argument_list|,
name|error
operator|->
name|semaphore_mboxes
index|[
name|ring
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  SYNC_1: 0x%08x\n"
argument_list|,
name|error
operator|->
name|semaphore_mboxes
index|[
name|ring
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  seqno: 0x%08x\n"
argument_list|,
name|error
operator|->
name|seqno
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  waiting: %s\n"
argument_list|,
name|yesno
argument_list|(
name|error
operator|->
name|waiting
index|[
name|ring
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  ring->head: 0x%08x\n"
argument_list|,
name|error
operator|->
name|cpu_ring_head
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  ring->tail: 0x%08x\n"
argument_list|,
name|error
operator|->
name|cpu_ring_tail
index|[
name|ring
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_error_state
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_i915_error_state
modifier|*
name|error
decl_stmt|;
name|struct
name|intel_ring_buffer
modifier|*
name|ring
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|page
decl_stmt|,
name|offset
decl_stmt|,
name|elt
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|dev_priv
operator|->
name|error_lock
argument_list|)
expr_stmt|;
name|error
operator|=
name|dev_priv
operator|->
name|first_error
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|NULL
condition|)
name|refcount_acquire
argument_list|(
operator|&
name|error
operator|->
name|ref
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|error_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"no error state collected\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Time: %jd s %jd us\n"
argument_list|,
operator|(
name|intmax_t
operator|)
name|error
operator|->
name|time
operator|.
name|tv_sec
argument_list|,
operator|(
name|intmax_t
operator|)
name|error
operator|->
name|time
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"PCI ID: 0x%04x\n"
argument_list|,
name|dev
operator|->
name|pci_device
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"EIR: 0x%08x\n"
argument_list|,
name|error
operator|->
name|eir
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"IER: 0x%08x\n"
argument_list|,
name|error
operator|->
name|ier
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"PGTBL_ER: 0x%08x\n"
argument_list|,
name|error
operator|->
name|pgtbl_er
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|num_fence_regs
condition|;
name|i
operator|++
control|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  fence[%d] = %08jx\n"
argument_list|,
name|i
argument_list|,
operator|(
name|uintmax_t
operator|)
name|error
operator|->
name|fence
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|INTEL_INFO
argument_list|(
name|dev
argument_list|)
operator|->
name|gen
operator|>=
literal|6
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"ERROR: 0x%08x\n"
argument_list|,
name|error
operator|->
name|error
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DONE_REG: 0x%08x\n"
argument_list|,
name|error
operator|->
name|done_reg
argument_list|)
expr_stmt|;
block|}
name|for_each_ring
argument_list|(
argument|ring
argument_list|,
argument|dev_priv
argument_list|,
argument|i
argument_list|)
name|i915_ring_error_state
argument_list|(
name|m
argument_list|,
name|dev
argument_list|,
name|error
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|->
name|active_bo
condition|)
name|print_error_buffers
argument_list|(
name|m
argument_list|,
literal|"Active"
argument_list|,
name|error
operator|->
name|active_bo
argument_list|,
name|error
operator|->
name|active_bo_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|->
name|pinned_bo
condition|)
name|print_error_buffers
argument_list|(
name|m
argument_list|,
literal|"Pinned"
argument_list|,
name|error
operator|->
name|pinned_bo
argument_list|,
name|error
operator|->
name|pinned_bo_count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|error
operator|->
name|ring
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|drm_i915_error_object
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|(
name|obj
operator|=
name|error
operator|->
name|ring
index|[
name|i
index|]
operator|.
name|batchbuffer
operator|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%s --- gtt_offset = 0x%08x\n"
argument_list|,
name|dev_priv
operator|->
name|rings
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|obj
operator|->
name|gtt_offset
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|page
operator|=
literal|0
init|;
name|page
operator|<
name|obj
operator|->
name|page_count
condition|;
name|page
operator|++
control|)
block|{
for|for
control|(
name|elt
operator|=
literal|0
init|;
name|elt
operator|<
name|PAGE_SIZE
operator|/
literal|4
condition|;
name|elt
operator|++
control|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%08x :  %08x\n"
argument_list|,
name|offset
argument_list|,
name|obj
operator|->
name|pages
index|[
name|page
index|]
index|[
name|elt
index|]
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|4
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|error
operator|->
name|ring
index|[
name|i
index|]
operator|.
name|num_requests
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%s --- %d requests\n"
argument_list|,
name|dev_priv
operator|->
name|rings
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|error
operator|->
name|ring
index|[
name|i
index|]
operator|.
name|num_requests
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|error
operator|->
name|ring
index|[
name|i
index|]
operator|.
name|num_requests
condition|;
name|j
operator|++
control|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"  seqno 0x%08x, emitted %ld, tail 0x%08x\n"
argument_list|,
name|error
operator|->
name|ring
index|[
name|i
index|]
operator|.
name|requests
index|[
name|j
index|]
operator|.
name|seqno
argument_list|,
name|error
operator|->
name|ring
index|[
name|i
index|]
operator|.
name|requests
index|[
name|j
index|]
operator|.
name|jiffies
argument_list|,
name|error
operator|->
name|ring
index|[
name|i
index|]
operator|.
name|requests
index|[
name|j
index|]
operator|.
name|tail
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|obj
operator|=
name|error
operator|->
name|ring
index|[
name|i
index|]
operator|.
name|ringbuffer
operator|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%s --- ringbuffer = 0x%08x\n"
argument_list|,
name|dev_priv
operator|->
name|rings
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|obj
operator|->
name|gtt_offset
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|page
operator|=
literal|0
init|;
name|page
operator|<
name|obj
operator|->
name|page_count
condition|;
name|page
operator|++
control|)
block|{
for|for
control|(
name|elt
operator|=
literal|0
init|;
name|elt
operator|<
name|PAGE_SIZE
operator|/
literal|4
condition|;
name|elt
operator|++
control|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%08x :  %08x\n"
argument_list|,
name|offset
argument_list|,
name|obj
operator|->
name|pages
index|[
name|page
index|]
index|[
name|elt
index|]
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|4
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|error
operator|->
name|overlay
condition|)
name|intel_overlay_print_error_state
argument_list|(
name|m
argument_list|,
name|error
operator|->
name|overlay
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|->
name|display
condition|)
name|intel_display_print_error_state
argument_list|(
name|m
argument_list|,
name|dev
argument_list|,
name|error
operator|->
name|display
argument_list|)
expr_stmt|;
if|if
condition|(
name|refcount_release
argument_list|(
operator|&
name|error
operator|->
name|ref
argument_list|)
condition|)
name|i915_error_state_free
argument_list|(
name|error
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_error_state_write
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_i915_error_state
modifier|*
name|error
decl_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Resetting error state\n"
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|dev_priv
operator|->
name|error_lock
argument_list|)
expr_stmt|;
name|error
operator|=
name|dev_priv
operator|->
name|first_error
expr_stmt|;
name|dev_priv
operator|->
name|first_error
operator|=
name|NULL
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|error_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|NULL
operator|&&
name|refcount_release
argument_list|(
operator|&
name|error
operator|->
name|ref
argument_list|)
condition|)
name|i915_error_state_free
argument_list|(
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_rstdby_delays
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u16
name|crstanddelay
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|crstanddelay
operator|=
name|I915_READ16
argument_list|(
name|CRSTANDVID
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"w/ctx: %d, w/o ctx: %d\n"
argument_list|,
operator|(
name|crstanddelay
operator|>>
literal|8
operator|)
operator|&
literal|0x3f
argument_list|,
operator|(
name|crstanddelay
operator|&
literal|0x3f
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_cur_delayinfo
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|IS_GEN5
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|u16
name|rgvswctl
init|=
name|I915_READ16
argument_list|(
name|MEMSWCTL
argument_list|)
decl_stmt|;
name|u16
name|rgvstat
init|=
name|I915_READ16
argument_list|(
name|MEMSTAT_ILK
argument_list|)
decl_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Requested P-state: %d\n"
argument_list|,
operator|(
name|rgvswctl
operator|>>
literal|8
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Requested VID: %d\n"
argument_list|,
name|rgvswctl
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Current VID: %d\n"
argument_list|,
operator|(
name|rgvstat
operator|&
name|MEMSTAT_VID_MASK
operator|)
operator|>>
name|MEMSTAT_VID_SHIFT
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Current P-state: %d\n"
argument_list|,
operator|(
name|rgvstat
operator|&
name|MEMSTAT_PSTATE_MASK
operator|)
operator|>>
name|MEMSTAT_PSTATE_SHIFT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_GEN6
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|u32
name|gt_perf_status
init|=
name|I915_READ
argument_list|(
name|GEN6_GT_PERF_STATUS
argument_list|)
decl_stmt|;
name|u32
name|rp_state_limits
init|=
name|I915_READ
argument_list|(
name|GEN6_RP_STATE_LIMITS
argument_list|)
decl_stmt|;
name|u32
name|rp_state_cap
init|=
name|I915_READ
argument_list|(
name|GEN6_RP_STATE_CAP
argument_list|)
decl_stmt|;
name|u32
name|rpstat
decl_stmt|;
name|u32
name|rpupei
decl_stmt|,
name|rpcurup
decl_stmt|,
name|rpprevup
decl_stmt|;
name|u32
name|rpdownei
decl_stmt|,
name|rpcurdown
decl_stmt|,
name|rpprevdown
decl_stmt|;
name|int
name|max_freq
decl_stmt|;
comment|/* RPSTAT1 is in the GT power well */
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|gen6_gt_force_wake_get
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|rpstat
operator|=
name|I915_READ
argument_list|(
name|GEN6_RPSTAT1
argument_list|)
expr_stmt|;
name|rpupei
operator|=
name|I915_READ
argument_list|(
name|GEN6_RP_CUR_UP_EI
argument_list|)
expr_stmt|;
name|rpcurup
operator|=
name|I915_READ
argument_list|(
name|GEN6_RP_CUR_UP
argument_list|)
expr_stmt|;
name|rpprevup
operator|=
name|I915_READ
argument_list|(
name|GEN6_RP_PREV_UP
argument_list|)
expr_stmt|;
name|rpdownei
operator|=
name|I915_READ
argument_list|(
name|GEN6_RP_CUR_DOWN_EI
argument_list|)
expr_stmt|;
name|rpcurdown
operator|=
name|I915_READ
argument_list|(
name|GEN6_RP_CUR_DOWN
argument_list|)
expr_stmt|;
name|rpprevdown
operator|=
name|I915_READ
argument_list|(
name|GEN6_RP_PREV_DOWN
argument_list|)
expr_stmt|;
name|gen6_gt_force_wake_put
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"GT_PERF_STATUS: 0x%08x\n"
argument_list|,
name|gt_perf_status
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RPSTAT1: 0x%08x\n"
argument_list|,
name|rpstat
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Render p-state ratio: %d\n"
argument_list|,
operator|(
name|gt_perf_status
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Render p-state VID: %d\n"
argument_list|,
name|gt_perf_status
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Render p-state limit: %d\n"
argument_list|,
name|rp_state_limits
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"CAGF: %dMHz\n"
argument_list|,
operator|(
operator|(
name|rpstat
operator|&
name|GEN6_CAGF_MASK
operator|)
operator|>>
name|GEN6_CAGF_SHIFT
operator|)
operator|*
literal|50
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RP CUR UP EI: %dus\n"
argument_list|,
name|rpupei
operator|&
name|GEN6_CURICONT_MASK
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RP CUR UP: %dus\n"
argument_list|,
name|rpcurup
operator|&
name|GEN6_CURBSYTAVG_MASK
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RP PREV UP: %dus\n"
argument_list|,
name|rpprevup
operator|&
name|GEN6_CURBSYTAVG_MASK
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RP CUR DOWN EI: %dus\n"
argument_list|,
name|rpdownei
operator|&
name|GEN6_CURIAVG_MASK
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RP CUR DOWN: %dus\n"
argument_list|,
name|rpcurdown
operator|&
name|GEN6_CURBSYTAVG_MASK
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RP PREV DOWN: %dus\n"
argument_list|,
name|rpprevdown
operator|&
name|GEN6_CURBSYTAVG_MASK
argument_list|)
expr_stmt|;
name|max_freq
operator|=
operator|(
name|rp_state_cap
operator|&
literal|0xff0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Lowest (RPN) frequency: %dMHz\n"
argument_list|,
name|max_freq
operator|*
literal|50
argument_list|)
expr_stmt|;
name|max_freq
operator|=
operator|(
name|rp_state_cap
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Nominal (RP1) frequency: %dMHz\n"
argument_list|,
name|max_freq
operator|*
literal|50
argument_list|)
expr_stmt|;
name|max_freq
operator|=
name|rp_state_cap
operator|&
literal|0xff
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Max non-overclocked (RP0) frequency: %dMHz\n"
argument_list|,
name|max_freq
operator|*
literal|50
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"no P-state info available\n"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_delayfreq_table
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u32
name|delayfreq
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|delayfreq
operator|=
name|I915_READ
argument_list|(
name|PXVFREQ_BASE
operator|+
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"P%02dVIDFREQ: 0x%08x (VID: %d)\n"
argument_list|,
name|i
argument_list|,
name|delayfreq
argument_list|,
operator|(
name|delayfreq
operator|&
name|PXVFREQ_PX_MASK
operator|)
operator|>>
name|PXVFREQ_PX_SHIFT
argument_list|)
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|MAP_TO_MV
parameter_list|(
name|int
name|map
parameter_list|)
block|{
return|return
literal|1250
operator|-
operator|(
name|map
operator|*
literal|25
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_inttoext_table
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u32
name|inttoext
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|inttoext
operator|=
name|I915_READ
argument_list|(
name|INTTOEXT_BASE_ILK
operator|+
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"INTTOEXT%02d: 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|inttoext
argument_list|)
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ironlake_drpc_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u32
name|rgvmodectl
decl_stmt|,
name|rstdbyctl
decl_stmt|;
name|u16
name|crstandvid
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|rgvmodectl
operator|=
name|I915_READ
argument_list|(
name|MEMMODECTL
argument_list|)
expr_stmt|;
name|rstdbyctl
operator|=
name|I915_READ
argument_list|(
name|RSTDBYCTL
argument_list|)
expr_stmt|;
name|crstandvid
operator|=
name|I915_READ16
argument_list|(
name|CRSTANDVID
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"HD boost: %s\n"
argument_list|,
operator|(
name|rgvmodectl
operator|&
name|MEMMODE_BOOST_EN
operator|)
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Boost freq: %d\n"
argument_list|,
operator|(
name|rgvmodectl
operator|&
name|MEMMODE_BOOST_FREQ_MASK
operator|)
operator|>>
name|MEMMODE_BOOST_FREQ_SHIFT
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"HW control enabled: %s\n"
argument_list|,
name|rgvmodectl
operator|&
name|MEMMODE_HWIDLE_EN
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"SW control enabled: %s\n"
argument_list|,
name|rgvmodectl
operator|&
name|MEMMODE_SWMODE_EN
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Gated voltage change: %s\n"
argument_list|,
name|rgvmodectl
operator|&
name|MEMMODE_RCLK_GATE
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Starting frequency: P%d\n"
argument_list|,
operator|(
name|rgvmodectl
operator|&
name|MEMMODE_FSTART_MASK
operator|)
operator|>>
name|MEMMODE_FSTART_SHIFT
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Max P-state: P%d\n"
argument_list|,
operator|(
name|rgvmodectl
operator|&
name|MEMMODE_FMAX_MASK
operator|)
operator|>>
name|MEMMODE_FMAX_SHIFT
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Min P-state: P%d\n"
argument_list|,
operator|(
name|rgvmodectl
operator|&
name|MEMMODE_FMIN_MASK
operator|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RS1 VID: %d\n"
argument_list|,
operator|(
name|crstandvid
operator|&
literal|0x3f
operator|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RS2 VID: %d\n"
argument_list|,
operator|(
operator|(
name|crstandvid
operator|>>
literal|8
operator|)
operator|&
literal|0x3f
operator|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Render standby enabled: %s\n"
argument_list|,
operator|(
name|rstdbyctl
operator|&
name|RCX_SW_EXIT
operator|)
condition|?
literal|"no"
else|:
literal|"yes"
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Current RS state: "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rstdbyctl
operator|&
name|RSX_STATUS_MASK
condition|)
block|{
case|case
name|RSX_STATUS_ON
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"on\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSX_STATUS_RC1
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC1\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSX_STATUS_RC1E
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC1E\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSX_STATUS_RS1
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RS1\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSX_STATUS_RS2
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RS2 (RC6)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSX_STATUS_RS3
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC3 (RC6+)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"unknown\n"
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gen6_drpc_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u32
name|rpmodectl1
decl_stmt|,
name|gt_core_status
decl_stmt|,
name|rcctl1
decl_stmt|;
name|unsigned
name|forcewake_count
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|mtx_lock
argument_list|(
operator|&
name|dev_priv
operator|->
name|gt_lock
argument_list|)
expr_stmt|;
name|forcewake_count
operator|=
name|dev_priv
operator|->
name|forcewake_count
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|gt_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|forcewake_count
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC information inaccurate because userspace "
literal|"holds a reference \n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* NB: we cannot use forcewake, else we read the wrong values */
while|while
condition|(
name|count
operator|++
operator|<
literal|50
operator|&&
operator|(
name|I915_READ_NOTRACE
argument_list|(
name|FORCEWAKE_ACK
argument_list|)
operator|&
literal|1
operator|)
condition|)
name|udelay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC information accurate: %s\n"
argument_list|,
name|yesno
argument_list|(
name|count
operator|<
literal|51
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|gt_core_status
operator|=
name|DRM_READ32
argument_list|(
name|dev_priv
operator|->
name|mmio_map
argument_list|,
name|GEN6_GT_CORE_STATUS
argument_list|)
expr_stmt|;
name|trace_i915_reg_rw
argument_list|(
name|false
argument_list|,
name|GEN6_GT_CORE_STATUS
argument_list|,
name|gt_core_status
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rpmodectl1
operator|=
name|I915_READ
argument_list|(
name|GEN6_RP_CONTROL
argument_list|)
expr_stmt|;
name|rcctl1
operator|=
name|I915_READ
argument_list|(
name|GEN6_RC_CONTROL
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Video Turbo Mode: %s\n"
argument_list|,
name|yesno
argument_list|(
name|rpmodectl1
operator|&
name|GEN6_RP_MEDIA_TURBO
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"HW control enabled: %s\n"
argument_list|,
name|yesno
argument_list|(
name|rpmodectl1
operator|&
name|GEN6_RP_ENABLE
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"SW control enabled: %s\n"
argument_list|,
name|yesno
argument_list|(
operator|(
name|rpmodectl1
operator|&
name|GEN6_RP_MEDIA_MODE_MASK
operator|)
operator|==
name|GEN6_RP_MEDIA_SW_MODE
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC1e Enabled: %s\n"
argument_list|,
name|yesno
argument_list|(
name|rcctl1
operator|&
name|GEN6_RC_CTL_RC1e_ENABLE
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC6 Enabled: %s\n"
argument_list|,
name|yesno
argument_list|(
name|rcctl1
operator|&
name|GEN6_RC_CTL_RC6_ENABLE
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Deep RC6 Enabled: %s\n"
argument_list|,
name|yesno
argument_list|(
name|rcctl1
operator|&
name|GEN6_RC_CTL_RC6p_ENABLE
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Deepest RC6 Enabled: %s\n"
argument_list|,
name|yesno
argument_list|(
name|rcctl1
operator|&
name|GEN6_RC_CTL_RC6pp_ENABLE
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Current RC state: "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|gt_core_status
operator|&
name|GEN6_RCn_MASK
condition|)
block|{
case|case
name|GEN6_RC0
case|:
if|if
condition|(
name|gt_core_status
operator|&
name|GEN6_CORE_CPD_STATE_MASK
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Core Power Down\n"
argument_list|)
expr_stmt|;
else|else
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"on\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN6_RC3
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC3\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN6_RC6
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC6\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN6_RC7
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC7\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Unknown\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Core Power Down: %s\n"
argument_list|,
name|yesno
argument_list|(
name|gt_core_status
operator|&
name|GEN6_CORE_CPD_STATE_MASK
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Not exactly sure what this is */
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC6 \"Locked to RPn\" residency since boot: %u\n"
argument_list|,
name|I915_READ
argument_list|(
name|GEN6_GT_GFX_RC6_LOCKED
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC6 residency since boot: %u\n"
argument_list|,
name|I915_READ
argument_list|(
name|GEN6_GT_GFX_RC6
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC6+ residency since boot: %u\n"
argument_list|,
name|I915_READ
argument_list|(
name|GEN6_GT_GFX_RC6p
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"RC6++ residency since boot: %u\n"
argument_list|,
name|I915_READ
argument_list|(
name|GEN6_GT_GFX_RC6pp
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_drpc_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
if|if
condition|(
name|IS_GEN6
argument_list|(
name|dev
argument_list|)
operator|||
name|IS_GEN7
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|gen6_drpc_info
argument_list|(
name|dev
argument_list|,
name|m
argument_list|)
return|;
else|else
return|return
name|ironlake_drpc_info
argument_list|(
name|dev
argument_list|,
name|m
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_fbc_status
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
operator|!
name|I915_HAS_FBC
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"FBC unsupported on this chipset"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|intel_fbc_enabled
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"FBC enabled"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"FBC disabled: "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|no_fbc_reason
condition|)
block|{
case|case
name|FBC_NO_OUTPUT
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"no outputs"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBC_STOLEN_TOO_SMALL
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"not enough stolen memory"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBC_UNSUPPORTED_MODE
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"mode not supported"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBC_MODE_TOO_LARGE
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"mode too large"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBC_BAD_PLANE
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"FBC unsupported on plane"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBC_NOT_TILED
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"scanout buffer not tiled"
argument_list|)
expr_stmt|;
break|break;
case|case
name|FBC_MULTIPLE_PIPES
case|:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"multiple pipes are enabled"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"unknown reason"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_sr_status
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|bool
name|sr_enabled
init|=
name|false
decl_stmt|;
if|if
condition|(
name|HAS_PCH_SPLIT
argument_list|(
name|dev
argument_list|)
condition|)
name|sr_enabled
operator|=
name|I915_READ
argument_list|(
name|WM1_LP_ILK
argument_list|)
operator|&
name|WM1_LP_SR_EN
expr_stmt|;
elseif|else
if|if
condition|(
name|IS_CRESTLINE
argument_list|(
name|dev
argument_list|)
operator|||
name|IS_I945G
argument_list|(
name|dev
argument_list|)
operator|||
name|IS_I945GM
argument_list|(
name|dev
argument_list|)
condition|)
name|sr_enabled
operator|=
name|I915_READ
argument_list|(
name|FW_BLC_SELF
argument_list|)
operator|&
name|FW_BLC_SELF_EN
expr_stmt|;
elseif|else
if|if
condition|(
name|IS_I915GM
argument_list|(
name|dev
argument_list|)
condition|)
name|sr_enabled
operator|=
name|I915_READ
argument_list|(
name|INSTPM
argument_list|)
operator|&
name|INSTPM_SELF_EN
expr_stmt|;
elseif|else
if|if
condition|(
name|IS_PINEVIEW
argument_list|(
name|dev
argument_list|)
condition|)
name|sr_enabled
operator|=
name|I915_READ
argument_list|(
name|DSPFW3
argument_list|)
operator|&
name|PINEVIEW_SELF_REFRESH_EN
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"self-refresh: %s"
argument_list|,
name|sr_enabled
condition|?
literal|"enabled"
else|:
literal|"disabled"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_emon_status
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|unsigned
name|long
name|temp
decl_stmt|,
name|chipset
decl_stmt|,
name|gfx
decl_stmt|;
if|if
condition|(
operator|!
name|IS_GEN5
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|-
name|ENODEV
return|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|temp
operator|=
name|i915_mch_val
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|chipset
operator|=
name|i915_chipset_val
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|gfx
operator|=
name|i915_gfx_val
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"GMCH temp: %ld\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Chipset power: %ld\n"
argument_list|,
name|chipset
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"GFX power: %ld\n"
argument_list|,
name|gfx
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"Total power: %ld\n"
argument_list|,
name|chipset
operator|+
name|gfx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_ring_freq_table
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|gpu_freq
decl_stmt|,
name|ia_freq
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|IS_GEN6
argument_list|(
name|dev
argument_list|)
operator|||
name|IS_GEN7
argument_list|(
name|dev
argument_list|)
operator|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"unsupported on this chipset"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"GPU freq (MHz)\tEffective CPU freq (MHz)\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|gpu_freq
operator|=
name|dev_priv
operator|->
name|min_delay
init|;
name|gpu_freq
operator|<=
name|dev_priv
operator|->
name|max_delay
condition|;
name|gpu_freq
operator|++
control|)
block|{
name|I915_WRITE
argument_list|(
name|GEN6_PCODE_DATA
argument_list|,
name|gpu_freq
argument_list|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|GEN6_PCODE_MAILBOX
argument_list|,
name|GEN6_PCODE_READY
operator||
name|GEN6_PCODE_READ_MIN_FREQ_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|_intel_wait_for
argument_list|(
name|dev
argument_list|,
operator|(
name|I915_READ
argument_list|(
name|GEN6_PCODE_MAILBOX
argument_list|)
operator|&
name|GEN6_PCODE_READY
operator|)
operator|==
literal|0
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|,
literal|"915frq"
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"pcode read of freq table timed out\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ia_freq
operator|=
name|I915_READ
argument_list|(
name|GEN6_PCODE_DATA
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%d\t\t%d\n"
argument_list|,
name|gpu_freq
operator|*
literal|50
argument_list|,
name|ia_freq
operator|*
literal|100
argument_list|)
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_gfxec
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"GFXEC: %ld\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|I915_READ
argument_list|(
literal|0x112f4
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static int i915_opregion(struct drm_device *dev, struct sbuf *m, void *unused) { 	drm_i915_private_t *dev_priv = dev->dev_private; 	struct intel_opregion *opregion =&dev_priv->opregion;  	if (sx_xlock_sig(&dev->dev_struct_lock)) 		return -EINTR;  	if (opregion->header) 		seq_write(m, opregion->header, OPREGION_SIZE);  	DRM_UNLOCK(dev);  	return 0; }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|i915_gem_framebuffer_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|intel_fbdev
modifier|*
name|ifbdev
decl_stmt|;
name|struct
name|intel_framebuffer
modifier|*
name|fb
decl_stmt|;
if|if
condition|(
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
condition|)
return|return
operator|-
name|EINTR
return|;
name|ifbdev
operator|=
name|dev_priv
operator|->
name|fbdev
expr_stmt|;
if|if
condition|(
name|ifbdev
operator|==
name|NULL
condition|)
block|{
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|fb
operator|=
name|to_intel_framebuffer
argument_list|(
name|ifbdev
operator|->
name|helper
operator|.
name|fb
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"fbcon size: %d x %d, depth %d, %d bpp, obj "
argument_list|,
name|fb
operator|->
name|base
operator|.
name|width
argument_list|,
name|fb
operator|->
name|base
operator|.
name|height
argument_list|,
name|fb
operator|->
name|base
operator|.
name|depth
argument_list|,
name|fb
operator|->
name|base
operator|.
name|bits_per_pixel
argument_list|)
expr_stmt|;
name|describe_obj
argument_list|(
name|m
argument_list|,
name|fb
operator|->
name|obj
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|fb
argument_list|,
argument|&dev->mode_config.fb_list
argument_list|,
argument|base.head
argument_list|)
block|{
if|if
condition|(
operator|&
name|fb
operator|->
name|base
operator|==
name|ifbdev
operator|->
name|helper
operator|.
name|fb
condition|)
continue|continue;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"user size: %d x %d, depth %d, %d bpp, obj "
argument_list|,
name|fb
operator|->
name|base
operator|.
name|width
argument_list|,
name|fb
operator|->
name|base
operator|.
name|height
argument_list|,
name|fb
operator|->
name|base
operator|.
name|depth
argument_list|,
name|fb
operator|->
name|base
operator|.
name|bits_per_pixel
argument_list|)
expr_stmt|;
name|describe_obj
argument_list|(
name|m
argument_list|,
name|fb
operator|->
name|obj
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_context_status
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|drm_i915_private_t
modifier|*
name|dev_priv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|dev_priv
operator|=
name|dev
operator|->
name|dev_private
expr_stmt|;
name|ret
operator|=
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
operator|-
name|EINTR
return|;
if|if
condition|(
name|dev_priv
operator|->
name|pwrctx
operator|!=
name|NULL
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"power context "
argument_list|)
expr_stmt|;
name|describe_obj
argument_list|(
name|m
argument_list|,
name|dev_priv
operator|->
name|pwrctx
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dev_priv
operator|->
name|renderctx
operator|!=
name|NULL
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"render context "
argument_list|)
expr_stmt|;
name|describe_obj
argument_list|(
name|m
argument_list|,
name|dev_priv
operator|->
name|renderctx
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|sx_xunlock
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_gen6_forcewake_count_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|unsigned
name|forcewake_count
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|dev_priv
operator|->
name|gt_lock
argument_list|)
expr_stmt|;
name|forcewake_count
operator|=
name|dev_priv
operator|->
name|forcewake_count
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|gt_lock
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"forcewake count = %u\n"
argument_list|,
name|forcewake_count
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|swizzle_string
parameter_list|(
name|unsigned
name|swizzle
parameter_list|)
block|{
switch|switch
condition|(
name|swizzle
condition|)
block|{
case|case
name|I915_BIT_6_SWIZZLE_NONE
case|:
return|return
literal|"none"
return|;
case|case
name|I915_BIT_6_SWIZZLE_9
case|:
return|return
literal|"bit9"
return|;
case|case
name|I915_BIT_6_SWIZZLE_9_10
case|:
return|return
literal|"bit9/bit10"
return|;
case|case
name|I915_BIT_6_SWIZZLE_9_11
case|:
return|return
literal|"bit9/bit11"
return|;
case|case
name|I915_BIT_6_SWIZZLE_9_10_11
case|:
return|return
literal|"bit9/bit10/bit11"
return|;
case|case
name|I915_BIT_6_SWIZZLE_9_17
case|:
return|return
literal|"bit9/bit17"
return|;
case|case
name|I915_BIT_6_SWIZZLE_9_10_17
case|:
return|return
literal|"bit9/bit10/bit17"
return|;
case|case
name|I915_BIT_6_SWIZZLE_UNKNOWN
case|:
return|return
literal|"unknown"
return|;
block|}
return|return
literal|"bug"
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_swizzle_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|-
name|EINTR
return|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"bit6 swizzle for X-tiling = %s\n"
argument_list|,
name|swizzle_string
argument_list|(
name|dev_priv
operator|->
name|mm
operator|.
name|bit_6_swizzle_x
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"bit6 swizzle for Y-tiling = %s\n"
argument_list|,
name|swizzle_string
argument_list|(
name|dev_priv
operator|->
name|mm
operator|.
name|bit_6_swizzle_y
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_GEN3
argument_list|(
name|dev
argument_list|)
operator|||
name|IS_GEN4
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DDC = 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|DCC
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"C0DRB3 = 0x%04x\n"
argument_list|,
name|I915_READ16
argument_list|(
name|C0DRB3
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"C1DRB3 = 0x%04x\n"
argument_list|,
name|I915_READ16
argument_list|(
name|C1DRB3
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_GEN6
argument_list|(
name|dev
argument_list|)
operator|||
name|IS_GEN7
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"MAD_DIMM_C0 = 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|MAD_DIMM_C0
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"MAD_DIMM_C1 = 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|MAD_DIMM_C1
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"MAD_DIMM_C2 = 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|MAD_DIMM_C2
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"TILECTL = 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|TILECTL
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"ARB_MODE = 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|ARB_MODE
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DISP_ARB_CTL = 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|DISP_ARB_CTL
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_ppgtt_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|intel_ring_buffer
modifier|*
name|ring
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|ret
operator|=
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|dev_struct_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|-
name|EINTR
return|;
if|if
condition|(
name|INTEL_INFO
argument_list|(
name|dev
argument_list|)
operator|->
name|gen
operator|==
literal|6
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"GFX_MODE: 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GFX_MODE
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|I915_NUM_RINGS
condition|;
name|i
operator|++
control|)
block|{
name|ring
operator|=
operator|&
name|dev_priv
operator|->
name|rings
index|[
name|i
index|]
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"%s\n"
argument_list|,
name|ring
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|INTEL_INFO
argument_list|(
name|dev
argument_list|)
operator|->
name|gen
operator|==
literal|7
condition|)
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"GFX_MODE: 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|RING_MODE_GEN7
argument_list|(
name|ring
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"PP_DIR_BASE: 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|RING_PP_DIR_BASE
argument_list|(
name|ring
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"PP_DIR_BASE_READ: 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|RING_PP_DIR_BASE_READ
argument_list|(
name|ring
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"PP_DIR_DCLV: 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|RING_PP_DIR_DCLV
argument_list|(
name|ring
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dev_priv
operator|->
name|mm
operator|.
name|aliasing_ppgtt
condition|)
block|{
name|struct
name|i915_hw_ppgtt
modifier|*
name|ppgtt
init|=
name|dev_priv
operator|->
name|mm
operator|.
name|aliasing_ppgtt
decl_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"aliasing PPGTT:\n"
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"pd gtt offset: 0x%08x\n"
argument_list|,
name|ppgtt
operator|->
name|pd_offset
argument_list|)
expr_stmt|;
block|}
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"ECOCHK: 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|GAM_ECOCHK
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_dpio_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|drm_i915_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|IS_VALLEYVIEW
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"unsupported\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ret
operator|=
name|sx_xlock_sig
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|-
name|EINTR
return|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPIO_CTL: 0x%08x\n"
argument_list|,
name|I915_READ
argument_list|(
name|DPIO_CTL
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPIO_DIV_A: 0x%08x\n"
argument_list|,
name|intel_dpio_read
argument_list|(
name|dev_priv
argument_list|,
name|_DPIO_DIV_A
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPIO_DIV_B: 0x%08x\n"
argument_list|,
name|intel_dpio_read
argument_list|(
name|dev_priv
argument_list|,
name|_DPIO_DIV_B
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPIO_REFSFR_A: 0x%08x\n"
argument_list|,
name|intel_dpio_read
argument_list|(
name|dev_priv
argument_list|,
name|_DPIO_REFSFR_A
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPIO_REFSFR_B: 0x%08x\n"
argument_list|,
name|intel_dpio_read
argument_list|(
name|dev_priv
argument_list|,
name|_DPIO_REFSFR_B
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPIO_CORE_CLK_A: 0x%08x\n"
argument_list|,
name|intel_dpio_read
argument_list|(
name|dev_priv
argument_list|,
name|_DPIO_CORE_CLK_A
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPIO_CORE_CLK_B: 0x%08x\n"
argument_list|,
name|intel_dpio_read
argument_list|(
name|dev_priv
argument_list|,
name|_DPIO_CORE_CLK_B
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPIO_LFP_COEFF_A: 0x%08x\n"
argument_list|,
name|intel_dpio_read
argument_list|(
name|dev_priv
argument_list|,
name|_DPIO_LFP_COEFF_A
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPIO_LFP_COEFF_B: 0x%08x\n"
argument_list|,
name|intel_dpio_read
argument_list|(
name|dev_priv
argument_list|,
name|_DPIO_LFP_COEFF_B
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|m
argument_list|,
literal|"DPIO_FASTCLK_DISABLE: 0x%08x\n"
argument_list|,
name|intel_dpio_read
argument_list|(
name|dev_priv
argument_list|,
name|DPIO_FASTCLK_DISABLE
argument_list|)
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|dev
operator|->
name|mode_config
operator|.
name|mutex
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_debug_set_wedged
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|arg1
decl_stmt|;
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|error
decl_stmt|,
name|wedged
decl_stmt|;
if|if
condition|(
name|dev_priv
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|wedged
operator|=
name|dev_priv
operator|->
name|mm
operator|.
name|wedged
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|wedged
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|DRM_INFO
argument_list|(
literal|"Manually setting wedged to %d\n"
argument_list|,
name|wedged
argument_list|)
expr_stmt|;
name|i915_handle_error
argument_list|(
name|dev
argument_list|,
name|wedged
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_max_freq
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|arg1
decl_stmt|;
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|error
decl_stmt|,
name|max_freq
decl_stmt|;
if|if
condition|(
name|dev_priv
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|max_freq
operator|=
name|dev_priv
operator|->
name|max_delay
operator|*
literal|50
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|max_freq
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|DRM_DEBUG
argument_list|(
literal|"Manually setting max freq to %d\n"
argument_list|,
name|max_freq
argument_list|)
expr_stmt|;
comment|/* 	 * Turbo will still be enabled, but won't go above the set value. 	 */
name|dev_priv
operator|->
name|max_delay
operator|=
name|max_freq
operator|/
literal|50
expr_stmt|;
name|gen6_set_rps
argument_list|(
name|dev
argument_list|,
name|max_freq
operator|/
literal|50
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_cache_sharing
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|arg1
decl_stmt|;
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|error
decl_stmt|,
name|snpcr
decl_stmt|,
name|cache_sharing
decl_stmt|;
if|if
condition|(
name|dev_priv
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|DRM_LOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|snpcr
operator|=
name|I915_READ
argument_list|(
name|GEN6_MBCUNIT_SNPCR
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|cache_sharing
operator|=
operator|(
name|snpcr
operator|&
name|GEN6_MBC_SNPCR_MASK
operator|)
operator|>>
name|GEN6_MBC_SNPCR_SHIFT
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|cache_sharing
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|cache_sharing
operator|<
literal|0
operator|||
name|cache_sharing
operator|>
literal|3
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|DRM_DEBUG
argument_list|(
literal|"Manually setting uncore sharing to %d\n"
argument_list|,
name|cache_sharing
argument_list|)
expr_stmt|;
name|DRM_LOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Update the cache sharing policy here as well */
name|snpcr
operator|=
name|I915_READ
argument_list|(
name|GEN6_MBCUNIT_SNPCR
argument_list|)
expr_stmt|;
name|snpcr
operator|&=
operator|~
name|GEN6_MBC_SNPCR_MASK
expr_stmt|;
name|snpcr
operator||=
operator|(
name|cache_sharing
operator|<<
name|GEN6_MBC_SNPCR_SHIFT
operator|)
expr_stmt|;
name|I915_WRITE
argument_list|(
name|GEN6_MBCUNIT_SNPCR
argument_list|,
name|snpcr
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i915_stop_rings
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|arg1
decl_stmt|;
name|drm_i915_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|error
decl_stmt|,
name|val
decl_stmt|;
if|if
condition|(
name|dev_priv
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|DRM_LOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|val
operator|=
name|dev_priv
operator|->
name|stop_rings
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|DRM_DEBUG
argument_list|(
literal|"Stopping rings 0x%08x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DRM_LOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|stop_rings
operator|=
name|val
expr_stmt|;
name|DRM_UNLOCK
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_struct
specifier|static
struct|struct
name|i915_info_sysctl_list
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
function_decl|(
modifier|*
name|ptr
function_decl|)
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|ptr_w
function_decl|)
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
name|int
name|flags
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
block|}
name|i915_info_sysctl_list
index|[]
init|=
block|{
block|{
literal|"i915_capabilities"
block|,
name|i915_capabilities
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_gem_objects"
block|,
name|i915_gem_object_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_gem_gtt"
block|,
name|i915_gem_gtt_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_gem_pinned"
block|,
name|i915_gem_gtt_info
block|,
name|NULL
block|,
literal|0
block|,
operator|(
name|void
operator|*
operator|)
name|PINNED_LIST
block|}
block|,
block|{
literal|"i915_gem_active"
block|,
name|i915_gem_object_list_info
block|,
name|NULL
block|,
literal|0
block|,
operator|(
name|void
operator|*
operator|)
name|ACTIVE_LIST
block|}
block|,
block|{
literal|"i915_gem_flushing"
block|,
name|i915_gem_object_list_info
block|,
name|NULL
block|,
literal|0
block|,
operator|(
name|void
operator|*
operator|)
name|FLUSHING_LIST
block|}
block|,
block|{
literal|"i915_gem_inactive"
block|,
name|i915_gem_object_list_info
block|,
name|NULL
block|,
literal|0
block|,
operator|(
name|void
operator|*
operator|)
name|INACTIVE_LIST
block|}
block|,
block|{
literal|"i915_gem_pageflip"
block|,
name|i915_gem_pageflip_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_gem_request"
block|,
name|i915_gem_request_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_gem_seqno"
block|,
name|i915_gem_seqno_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_gem_fence_regs"
block|,
name|i915_gem_fence_regs_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_gem_interrupt"
block|,
name|i915_interrupt_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_gem_hws"
block|,
name|i915_hws_info
block|,
name|NULL
block|,
literal|0
block|,
operator|(
name|void
operator|*
operator|)
name|RCS
block|}
block|,
block|{
literal|"i915_gem_hws_blt"
block|,
name|i915_hws_info
block|,
name|NULL
block|,
literal|0
block|,
operator|(
name|void
operator|*
operator|)
name|BCS
block|}
block|,
block|{
literal|"i915_gem_hws_bsd"
block|,
name|i915_hws_info
block|,
name|NULL
block|,
literal|0
block|,
operator|(
name|void
operator|*
operator|)
name|VCS
block|}
block|,
block|{
literal|"i915_error_state"
block|,
name|i915_error_state
block|,
name|i915_error_state_write
block|,
literal|0
block|}
block|,
block|{
literal|"i915_rstdby_delays"
block|,
name|i915_rstdby_delays
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_cur_delayinfo"
block|,
name|i915_cur_delayinfo
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_delayfreq_table"
block|,
name|i915_delayfreq_table
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_inttoext_table"
block|,
name|i915_inttoext_table
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_drpc_info"
block|,
name|i915_drpc_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_emon_status"
block|,
name|i915_emon_status
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_ring_freq_table"
block|,
name|i915_ring_freq_table
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_gfxec"
block|,
name|i915_gfxec
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_fbc_status"
block|,
name|i915_fbc_status
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_sr_status"
block|,
name|i915_sr_status
block|,
name|NULL
block|,
literal|0
block|}
block|,
if|#
directive|if
literal|0
block|{"i915_opregion", i915_opregion, NULL, 0},
endif|#
directive|endif
block|{
literal|"i915_gem_framebuffer"
block|,
name|i915_gem_framebuffer_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_context_status"
block|,
name|i915_context_status
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_gen6_forcewake_count_info"
block|,
name|i915_gen6_forcewake_count_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_swizzle_info"
block|,
name|i915_swizzle_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_ppgtt_info"
block|,
name|i915_ppgtt_info
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"i915_dpio"
block|,
name|i915_dpio_info
block|,
name|NULL
block|,
literal|0
block|}
block|, }
struct|;
end_struct

begin_struct
struct|struct
name|i915_info_sysctl_thunk
block|{
name|struct
name|drm_device
modifier|*
name|dev
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|i915_info_sysctl_handler
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|sbuf
name|m
decl_stmt|;
name|struct
name|i915_info_sysctl_thunk
modifier|*
name|thunk
decl_stmt|;
name|struct
name|drm_device
modifier|*
name|dev
decl_stmt|;
name|drm_i915_private_t
modifier|*
name|dev_priv
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|error
decl_stmt|;
name|thunk
operator|=
name|arg1
expr_stmt|;
name|dev
operator|=
name|thunk
operator|->
name|dev
expr_stmt|;
name|dev_priv
operator|=
name|dev
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|error
operator|=
name|sysctl_wire_old_buffer
argument_list|(
name|req
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|sbuf_new_for_sysctl
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|,
literal|128
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
name|i915_info_sysctl_list
index|[
name|thunk
operator|->
name|idx
index|]
operator|.
name|ptr
argument_list|(
name|dev
argument_list|,
operator|&
name|m
argument_list|,
name|thunk
operator|->
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|error
operator|=
name|sbuf_finish
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|sbuf_delete
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
operator|||
name|req
operator|->
name|newptr
operator|==
name|NULL
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|req
operator|->
name|newlen
operator|>
literal|2048
condition|)
return|return
operator|(
name|E2BIG
operator|)
return|;
name|p
operator|=
name|malloc
argument_list|(
name|req
operator|->
name|newlen
operator|+
literal|1
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|SYSCTL_IN
argument_list|(
name|req
argument_list|,
name|p
argument_list|,
name|req
operator|->
name|newlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|p
index|[
name|req
operator|->
name|newlen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|error
operator|=
name|i915_info_sysctl_list
index|[
name|thunk
operator|->
name|idx
index|]
operator|.
name|ptr_w
argument_list|(
name|dev
argument_list|,
name|p
argument_list|,
name|thunk
operator|->
name|arg
argument_list|)
expr_stmt|;
name|out
label|:
name|free
argument_list|(
name|p
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|extern
name|int
name|i915_gem_sync_exec_requests
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|i915_fix_mi_batchbuffer_end
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|i915_intr_pf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|long
name|i915_gem_wired_pages_cnt
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|i915_sysctl_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
parameter_list|,
name|struct
name|sysctl_oid
modifier|*
name|top
parameter_list|)
block|{
name|struct
name|sysctl_oid
modifier|*
name|oid
decl_stmt|,
modifier|*
name|info
decl_stmt|;
name|struct
name|i915_info_sysctl_thunk
modifier|*
name|thunks
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|thunks
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|thunks
argument_list|)
operator|*
name|ARRAY_SIZE
argument_list|(
name|i915_info_sysctl_list
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|i915_info_sysctl_list
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|thunks
index|[
name|i
index|]
operator|.
name|dev
operator|=
name|dev
expr_stmt|;
name|thunks
index|[
name|i
index|]
operator|.
name|idx
operator|=
name|i
expr_stmt|;
name|thunks
index|[
name|i
index|]
operator|.
name|arg
operator|=
name|i915_info_sysctl_list
index|[
name|i
index|]
operator|.
name|data
expr_stmt|;
block|}
name|dev
operator|->
name|sysctl_private
operator|=
name|thunks
expr_stmt|;
name|info
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|top
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"info"
argument_list|,
name|CTLFLAG_RW
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|i915_info_sysctl_list
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|oid
operator|=
name|SYSCTL_ADD_OID
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|info
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|i915_info_sysctl_list
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|CTLTYPE_STRING
operator||
operator|(
name|i915_info_sysctl_list
index|[
name|i
index|]
operator|.
name|ptr_w
operator|!=
name|NULL
condition|?
name|CTLFLAG_RW
else|:
name|CTLFLAG_RD
operator|)
argument_list|,
operator|&
name|thunks
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
name|i915_info_sysctl_handler
argument_list|,
literal|"A"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
name|oid
operator|=
name|SYSCTL_ADD_LONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|info
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"i915_gem_wired_pages"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|i915_gem_wired_pages_cnt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|oid
operator|=
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|top
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"wedged"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|i915_debug_set_wedged
argument_list|,
literal|"I"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|oid
operator|=
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|top
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"max_freq"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|i915_max_freq
argument_list|,
literal|"I"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|oid
operator|=
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|top
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cache_sharing"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|i915_cache_sharing
argument_list|,
literal|"I"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|oid
operator|=
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|top
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"stop_rings"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|,
name|i915_stop_rings
argument_list|,
literal|"I"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|oid
operator|=
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|top
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"sync_exec"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|i915_gem_sync_exec_requests
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|oid
operator|=
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|top
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"fix_mi"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|i915_fix_mi_batchbuffer_end
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|oid
operator|=
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|top
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"intr_pf"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|i915_intr_pf
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|error
operator|=
name|drm_add_busid_modesetting
argument_list|(
name|dev
argument_list|,
name|ctx
argument_list|,
name|top
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|i915_sysctl_cleanup
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|free
argument_list|(
name|dev
operator|->
name|sysctl_private
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2008 Nathan Whitehorn  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL TOOLS GMBH BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;  * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mouse.h>
end_include

begin_include
include|#
directive|include
file|<sys/poll.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/selinfo.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|"adb.h"
end_include

begin_define
define|#
directive|define
name|CDEV_GET_SOFTC
parameter_list|(
name|x
parameter_list|)
value|(x)->si_drv1
end_define

begin_function_decl
specifier|static
name|int
name|adb_mouse_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|adb_mouse_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|adb_mouse_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|adb_init_trackpad
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|adb_tapping_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|d_open_t
name|ams_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|ams_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_read_t
name|ams_read
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_ioctl_t
name|ams_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_poll_t
name|ams_poll
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|u_int
name|adb_mouse_receive_packet
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|status
parameter_list|,
name|u_char
name|command
parameter_list|,
name|u_char
name|reg
parameter_list|,
name|int
name|len
parameter_list|,
name|u_char
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|adb_mouse_softc
block|{
name|device_t
name|sc_dev
decl_stmt|;
name|struct
name|mtx
name|sc_mtx
decl_stmt|;
name|struct
name|cv
name|sc_cv
decl_stmt|;
name|int
name|flags
decl_stmt|;
define|#
directive|define
name|AMS_EXTENDED
value|0x1
define|#
directive|define
name|AMS_TOUCHPAD
value|0x2
name|uint16_t
name|dpi
decl_stmt|;
name|mousehw_t
name|hw
decl_stmt|;
name|mousemode_t
name|mode
decl_stmt|;
name|u_char
name|id
index|[
literal|4
index|]
decl_stmt|;
name|int
name|buttons
decl_stmt|;
name|u_int
name|sc_tapping
decl_stmt|;
name|int
name|button_buf
decl_stmt|;
name|int
name|last_buttons
decl_stmt|;
name|int
name|xdelta
decl_stmt|,
name|ydelta
decl_stmt|;
name|int8_t
name|packet
index|[
literal|8
index|]
decl_stmt|;
name|size_t
name|packet_read_len
decl_stmt|;
name|struct
name|cdev
modifier|*
name|cdev
decl_stmt|;
name|struct
name|selinfo
name|rsel
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|device_method_t
name|adb_mouse_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|adb_mouse_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|adb_mouse_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|adb_mouse_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|bus_generic_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|bus_generic_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|bus_generic_resume
argument_list|)
block|,
comment|/* ADB interface */
name|DEVMETHOD
argument_list|(
name|adb_receive_packet
argument_list|,
name|adb_mouse_receive_packet
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|adb_mouse_driver
init|=
block|{
literal|"ams"
block|,
name|adb_mouse_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|adb_mouse_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|adb_mouse_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ams
argument_list|,
name|adb
argument_list|,
name|adb_mouse_driver
argument_list|,
name|adb_mouse_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|cdevsw
name|ams_cdevsw
init|=
block|{
operator|.
name|d_version
operator|=
name|D_VERSION
block|,
operator|.
name|d_flags
operator|=
literal|0
block|,
operator|.
name|d_open
operator|=
name|ams_open
block|,
operator|.
name|d_close
operator|=
name|ams_close
block|,
operator|.
name|d_read
operator|=
name|ams_read
block|,
operator|.
name|d_ioctl
operator|=
name|ams_ioctl
block|,
operator|.
name|d_poll
operator|=
name|ams_poll
block|,
operator|.
name|d_name
operator|=
literal|"ams"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|adb_mouse_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|uint8_t
name|type
decl_stmt|;
name|type
operator|=
name|adb_get_device_type
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|ADB_DEVICE_MOUSE
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"ADB Mouse"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|adb_mouse_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|adb_mouse_softc
modifier|*
name|sc
decl_stmt|;
name|char
modifier|*
name|description
init|=
literal|"Unknown Pointing Device"
decl_stmt|;
name|size_t
name|r1_len
decl_stmt|;
name|u_char
name|r1
index|[
literal|8
index|]
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|"ams"
argument_list|,
name|MTX_DEF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cv_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_cv
argument_list|,
literal|"ams"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|hw
operator|.
name|buttons
operator|=
literal|2
expr_stmt|;
name|sc
operator|->
name|hw
operator|.
name|iftype
operator|=
name|MOUSE_IF_UNKNOWN
expr_stmt|;
name|sc
operator|->
name|hw
operator|.
name|type
operator|=
name|MOUSE_UNKNOWN
expr_stmt|;
name|sc
operator|->
name|hw
operator|.
name|model
operator|=
name|sc
operator|->
name|hw
operator|.
name|hwid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mode
operator|.
name|protocol
operator|=
name|MOUSE_PROTO_SYSMOUSE
expr_stmt|;
name|sc
operator|->
name|mode
operator|.
name|rate
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|mode
operator|.
name|resolution
operator|=
literal|100
expr_stmt|;
name|sc
operator|->
name|mode
operator|.
name|accelfactor
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mode
operator|.
name|level
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mode
operator|.
name|packetsize
operator|=
literal|5
expr_stmt|;
name|sc
operator|->
name|buttons
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_tapping
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|button_buf
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|last_buttons
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|packet_read_len
operator|=
literal|0
expr_stmt|;
comment|/* Try to switch to extended protocol */
name|adb_set_device_handler
argument_list|(
name|dev
argument_list|,
literal|4
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|adb_get_device_handler
argument_list|(
name|dev
argument_list|)
condition|)
block|{
case|case
literal|1
case|:
name|sc
operator|->
name|mode
operator|.
name|resolution
operator|=
literal|100
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|sc
operator|->
name|mode
operator|.
name|resolution
operator|=
literal|200
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|r1_len
operator|=
name|adb_read_register
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|r1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r1_len
operator|<
literal|8
condition|)
break|break;
name|sc
operator|->
name|flags
operator||=
name|AMS_EXTENDED
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|hw
operator|.
name|hwid
argument_list|,
name|r1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mode
operator|.
name|resolution
operator|=
operator|(
name|r1
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|r1
index|[
literal|5
index|]
expr_stmt|;
switch|switch
condition|(
name|r1
index|[
literal|6
index|]
condition|)
block|{
case|case
literal|0
case|:
name|sc
operator|->
name|hw
operator|.
name|type
operator|=
name|MOUSE_PAD
expr_stmt|;
name|description
operator|=
literal|"Tablet"
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|sc
operator|->
name|hw
operator|.
name|type
operator|=
name|MOUSE_MOUSE
expr_stmt|;
name|description
operator|=
literal|"Mouse"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|sc
operator|->
name|hw
operator|.
name|type
operator|=
name|MOUSE_TRACKBALL
expr_stmt|;
name|description
operator|=
literal|"Trackball"
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|sc
operator|->
name|flags
operator||=
name|AMS_TOUCHPAD
expr_stmt|;
name|sc
operator|->
name|hw
operator|.
name|type
operator|=
name|MOUSE_PAD
expr_stmt|;
name|adb_init_trackpad
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|description
operator|=
literal|"Touchpad"
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|hw
operator|.
name|buttons
operator|=
name|r1
index|[
literal|7
index|]
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%d-button %d-dpi %s\n"
argument_list|,
name|sc
operator|->
name|hw
operator|.
name|buttons
argument_list|,
name|sc
operator|->
name|mode
operator|.
name|resolution
argument_list|,
name|description
argument_list|)
expr_stmt|;
comment|/* 		 * Check for one of MacAlly's non-compliant 2-button mice. 		 * These claim to speak the extended mouse protocol, but 		 * instead speak the standard protocol and only when their 		 * handler is set to 0x42. 		 */
if|if
condition|(
name|sc
operator|->
name|hw
operator|.
name|hwid
operator|==
literal|0x4b4f4954
condition|)
block|{
name|adb_set_device_handler
argument_list|(
name|dev
argument_list|,
literal|0x42
argument_list|)
expr_stmt|;
if|if
condition|(
name|adb_get_device_handler
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x42
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"MacAlly 2-Button Mouse\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|flags
operator|&=
operator|~
name|AMS_EXTENDED
expr_stmt|;
block|}
block|}
break|break;
block|}
name|sc
operator|->
name|cdev
operator|=
name|make_dev
argument_list|(
operator|&
name|ams_cdevsw
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_OPERATOR
argument_list|,
literal|0644
argument_list|,
literal|"ams%d"
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cdev
operator|->
name|si_drv1
operator|=
name|sc
expr_stmt|;
name|adb_set_autopoll
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|adb_mouse_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|adb_mouse_softc
modifier|*
name|sc
decl_stmt|;
name|adb_set_autopoll
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|destroy_dev
argument_list|(
name|sc
operator|->
name|cdev
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|cv_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_cv
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|adb_init_trackpad
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|adb_mouse_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tree
decl_stmt|;
name|size_t
name|r1_len
decl_stmt|;
name|u_char
name|r1
index|[
literal|8
index|]
decl_stmt|;
name|u_char
name|r2
index|[
literal|8
index|]
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|r1_len
operator|=
name|adb_read_register
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|r1
argument_list|)
expr_stmt|;
comment|/* An Extended Mouse register1 must return 8 bytes. */
if|if
condition|(
name|r1_len
operator|!=
literal|8
condition|)
return|return;
if|if
condition|(
operator|(
name|r1
index|[
literal|6
index|]
operator|!=
literal|0x0d
operator|)
condition|)
block|{
name|r1
index|[
literal|6
index|]
operator|=
literal|0x0d
expr_stmt|;
name|adb_write_register
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|,
name|r1
argument_list|)
expr_stmt|;
name|r1_len
operator|=
name|adb_read_register
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|r1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r1
index|[
literal|6
index|]
operator|!=
literal|0x0d
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ADB Mouse = 0x%x "
literal|"(non-Extended Mode)\n"
argument_list|,
name|r1
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ADB Mouse = 0x%x "
literal|"(Extended Mode)\n"
argument_list|,
name|r1
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
comment|/* Set ADB Extended Features to default values, 			   enabled. */
name|r2
index|[
literal|0
index|]
operator|=
literal|0x19
expr_stmt|;
comment|/* Clicking: 0x19 disabled 0x99 enabled */
name|r2
index|[
literal|1
index|]
operator|=
literal|0x94
expr_stmt|;
comment|/* Dragging: 0x14 disabled 0x94 enabled */
name|r2
index|[
literal|2
index|]
operator|=
literal|0x19
expr_stmt|;
name|r2
index|[
literal|3
index|]
operator|=
literal|0xff
expr_stmt|;
comment|/* DragLock: 0xff disabled 0xb2 enabled */
name|r2
index|[
literal|4
index|]
operator|=
literal|0xb2
expr_stmt|;
name|r2
index|[
literal|5
index|]
operator|=
literal|0x8a
expr_stmt|;
name|r2
index|[
literal|6
index|]
operator|=
literal|0x1b
expr_stmt|;
name|r2
index|[
literal|7
index|]
operator|=
literal|0x57
expr_stmt|;
comment|/* 0x57 bits 3:0 for W mode */
name|adb_write_register
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
literal|8
argument_list|,
name|r2
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Set up sysctl 	 */
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|tree
operator|=
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tapping"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|adb_tapping_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"Tapping the pad causes button events"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|u_int
name|adb_mouse_receive_packet
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|status
parameter_list|,
name|u_char
name|command
parameter_list|,
name|u_char
name|reg
parameter_list|,
name|int
name|len
parameter_list|,
name|u_char
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|adb_mouse_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|xdelta
decl_stmt|,
name|ydelta
decl_stmt|;
name|int
name|buttons
decl_stmt|,
name|tmp_buttons
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|command
operator|!=
name|ADB_COMMAND_TALK
operator|||
name|reg
operator|!=
literal|0
operator|||
name|len
operator|<
literal|2
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|ydelta
operator|=
name|data
index|[
literal|0
index|]
operator|&
literal|0x7f
expr_stmt|;
name|xdelta
operator|=
name|data
index|[
literal|1
index|]
operator|&
literal|0x7f
expr_stmt|;
name|buttons
operator|=
literal|0
expr_stmt|;
name|buttons
operator||=
operator|!
operator|(
name|data
index|[
literal|0
index|]
operator|&
literal|0x80
operator|)
expr_stmt|;
name|buttons
operator||=
operator|!
operator|(
name|data
index|[
literal|1
index|]
operator|&
literal|0x80
operator|)
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|AMS_EXTENDED
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|len
operator|&&
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|xdelta
operator||=
operator|(
name|data
index|[
name|i
index|]
operator|&
literal|0x07
operator|)
operator|<<
operator|(
literal|3
operator|*
name|i
operator|+
literal|1
operator|)
expr_stmt|;
name|ydelta
operator||=
operator|(
name|data
index|[
name|i
index|]
operator|&
literal|0x70
operator|)
operator|<<
operator|(
literal|3
operator|*
name|i
operator|-
literal|3
operator|)
expr_stmt|;
name|buttons
operator||=
operator|!
operator|(
name|data
index|[
name|i
index|]
operator|&
literal|0x08
operator|)
operator|<<
operator|(
literal|2
operator|*
name|i
operator|-
literal|2
operator|)
expr_stmt|;
name|buttons
operator||=
operator|!
operator|(
name|data
index|[
name|i
index|]
operator|&
literal|0x80
operator|)
operator|<<
operator|(
literal|2
operator|*
name|i
operator|-
literal|1
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|len
operator|=
literal|2
expr_stmt|;
comment|/* Ignore extra data */
block|}
comment|/* Do sign extension as necessary */
if|if
condition|(
name|xdelta
operator|&
operator|(
literal|0x40
operator|<<
literal|3
operator|*
operator|(
name|len
operator|-
literal|2
operator|)
operator|)
condition|)
name|xdelta
operator||=
literal|0xffffffc0
operator|<<
literal|3
operator|*
operator|(
name|len
operator|-
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|ydelta
operator|&
operator|(
literal|0x40
operator|<<
literal|3
operator|*
operator|(
name|len
operator|-
literal|2
operator|)
operator|)
condition|)
name|ydelta
operator||=
literal|0xffffffc0
operator|<<
literal|3
operator|*
operator|(
name|len
operator|-
literal|2
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|flags
operator|&
name|AMS_TOUCHPAD
operator|)
operator|&&
operator|(
name|sc
operator|->
name|sc_tapping
operator|==
literal|1
operator|)
condition|)
block|{
name|tmp_buttons
operator|=
name|buttons
expr_stmt|;
if|if
condition|(
name|buttons
operator|==
literal|0x12
condition|)
block|{
comment|/* Map a double tap on button 3. 			   Keep the button state for the next sequence. 			   A double tap sequence is followed by a single tap 			   sequence. 			*/
name|tmp_buttons
operator|=
literal|0x3
expr_stmt|;
name|sc
operator|->
name|button_buf
operator|=
name|tmp_buttons
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|buttons
operator|==
literal|0x2
condition|)
block|{
comment|/* Map a single tap on button 2. But only if it is 			   not a successor from a double tap. 			*/
if|if
condition|(
name|sc
operator|->
name|button_buf
operator|!=
literal|0x3
condition|)
name|tmp_buttons
operator|=
literal|0x2
expr_stmt|;
else|else
name|tmp_buttons
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|button_buf
operator|=
literal|0
expr_stmt|;
block|}
name|buttons
operator|=
name|tmp_buttons
expr_stmt|;
block|}
comment|/* 	 * Some mice report high-numbered buttons on the wrong button number, 	 * so set the highest-numbered real button as pressed if there are 	 * mysterious high-numbered ones set. 	 * 	 * Don't do this for touchpads, because touchpads also trigger 	 * high button events when they are touched. 	 */
if|if
condition|(
name|buttons
operator|&
operator|~
operator|(
operator|(
literal|1
operator|<<
name|sc
operator|->
name|hw
operator|.
name|buttons
operator|)
operator|-
literal|1
operator|)
operator|&&
operator|!
operator|(
name|sc
operator|->
name|flags
operator|&
name|AMS_TOUCHPAD
operator|)
condition|)
block|{
name|buttons
operator||=
literal|1
operator|<<
operator|(
name|sc
operator|->
name|hw
operator|.
name|buttons
operator|-
literal|1
operator|)
expr_stmt|;
block|}
name|buttons
operator|&=
operator|(
literal|1
operator|<<
name|sc
operator|->
name|hw
operator|.
name|buttons
operator|)
operator|-
literal|1
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
comment|/* Add in our new deltas, and take into account 	   Apple's opposite meaning for Y axis motion */
name|sc
operator|->
name|xdelta
operator|+=
name|xdelta
expr_stmt|;
name|sc
operator|->
name|ydelta
operator|-=
name|ydelta
expr_stmt|;
name|sc
operator|->
name|buttons
operator|=
name|buttons
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|cv_broadcast
argument_list|(
operator|&
name|sc
operator|->
name|sc_cv
argument_list|)
expr_stmt|;
name|selwakeuppri
argument_list|(
operator|&
name|sc
operator|->
name|rsel
argument_list|,
name|PZERO
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ams_open
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|fmt
parameter_list|,
name|struct
name|thread
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|adb_mouse_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|CDEV_GET_SOFTC
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|packet_read_len
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|xdelta
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ydelta
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|buttons
operator|=
literal|0
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ams_close
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|fmt
parameter_list|,
name|struct
name|thread
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|adb_mouse_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|CDEV_GET_SOFTC
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|cv_broadcast
argument_list|(
operator|&
name|sc
operator|->
name|sc_cv
argument_list|)
expr_stmt|;
name|selwakeuppri
argument_list|(
operator|&
name|sc
operator|->
name|rsel
argument_list|,
name|PZERO
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ams_poll
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|events
parameter_list|,
name|struct
name|thread
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|adb_mouse_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|CDEV_GET_SOFTC
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
if|if
condition|(
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|xdelta
operator|==
literal|0
operator|&&
name|sc
operator|->
name|ydelta
operator|==
literal|0
operator|&&
name|sc
operator|->
name|buttons
operator|==
name|sc
operator|->
name|last_buttons
condition|)
block|{
name|selrecord
argument_list|(
name|p
argument_list|,
operator|&
name|sc
operator|->
name|rsel
argument_list|)
expr_stmt|;
name|events
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|events
operator|&=
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
block|}
return|return
name|events
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ams_read
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|uio
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|struct
name|adb_mouse_softc
modifier|*
name|sc
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int8_t
name|outpacket
index|[
literal|8
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|CDEV_GET_SOFTC
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
if|if
condition|(
name|uio
operator|->
name|uio_resid
operator|<=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|packet_read_len
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|xdelta
operator|==
literal|0
operator|&&
name|sc
operator|->
name|ydelta
operator|==
literal|0
operator|&&
name|sc
operator|->
name|buttons
operator|==
name|sc
operator|->
name|last_buttons
condition|)
block|{
if|if
condition|(
name|flag
operator|&
name|O_NONBLOCK
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
name|EWOULDBLOCK
return|;
block|}
comment|/* Otherwise, block on new data */
name|error
operator|=
name|cv_wait_sig
argument_list|(
operator|&
name|sc
operator|->
name|sc_cv
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
name|sc
operator|->
name|packet
index|[
literal|0
index|]
operator|=
literal|1
operator|<<
literal|7
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|0
index|]
operator||=
operator|(
operator|!
operator|(
name|sc
operator|->
name|buttons
operator|&
literal|1
operator|)
operator|)
operator|<<
literal|2
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|0
index|]
operator||=
operator|(
operator|!
operator|(
name|sc
operator|->
name|buttons
operator|&
literal|4
operator|)
operator|)
operator|<<
literal|1
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|0
index|]
operator||=
operator|(
operator|!
operator|(
name|sc
operator|->
name|buttons
operator|&
literal|2
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|xdelta
operator|>
literal|127
condition|)
block|{
name|sc
operator|->
name|packet
index|[
literal|1
index|]
operator|=
literal|127
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|3
index|]
operator|=
name|sc
operator|->
name|xdelta
operator|-
literal|127
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|xdelta
operator|<
operator|-
literal|127
condition|)
block|{
name|sc
operator|->
name|packet
index|[
literal|1
index|]
operator|=
operator|-
literal|127
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|3
index|]
operator|=
name|sc
operator|->
name|xdelta
operator|+
literal|127
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|packet
index|[
literal|1
index|]
operator|=
name|sc
operator|->
name|xdelta
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|ydelta
operator|>
literal|127
condition|)
block|{
name|sc
operator|->
name|packet
index|[
literal|2
index|]
operator|=
literal|127
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|4
index|]
operator|=
name|sc
operator|->
name|ydelta
operator|-
literal|127
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|ydelta
operator|<
operator|-
literal|127
condition|)
block|{
name|sc
operator|->
name|packet
index|[
literal|2
index|]
operator|=
operator|-
literal|127
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|4
index|]
operator|=
name|sc
operator|->
name|ydelta
operator|+
literal|127
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|packet
index|[
literal|2
index|]
operator|=
name|sc
operator|->
name|ydelta
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/* No Z movement */
name|sc
operator|->
name|packet
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|packet
index|[
literal|7
index|]
operator|=
operator|~
operator|(
call|(
name|uint8_t
call|)
argument_list|(
name|sc
operator|->
name|buttons
operator|>>
literal|3
argument_list|)
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|sc
operator|->
name|last_buttons
operator|=
name|sc
operator|->
name|buttons
expr_stmt|;
name|sc
operator|->
name|xdelta
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ydelta
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|packet_read_len
operator|=
name|sc
operator|->
name|mode
operator|.
name|packetsize
expr_stmt|;
block|}
name|len
operator|=
operator|(
name|sc
operator|->
name|packet_read_len
operator|>
name|uio
operator|->
name|uio_resid
operator|)
condition|?
name|uio
operator|->
name|uio_resid
else|:
name|sc
operator|->
name|packet_read_len
expr_stmt|;
name|memcpy
argument_list|(
name|outpacket
argument_list|,
name|sc
operator|->
name|packet
operator|+
operator|(
name|sc
operator|->
name|mode
operator|.
name|packetsize
operator|-
name|sc
operator|->
name|packet_read_len
operator|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|packet_read_len
operator|-=
name|len
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|outpacket
argument_list|,
name|len
argument_list|,
name|uio
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ams_ioctl
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|addr
parameter_list|,
name|int
name|flag
parameter_list|,
name|struct
name|thread
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|adb_mouse_softc
modifier|*
name|sc
decl_stmt|;
name|mousemode_t
name|mode
decl_stmt|;
name|sc
operator|=
name|CDEV_GET_SOFTC
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|MOUSE_GETHWINFO
case|:
operator|*
operator|(
name|mousehw_t
operator|*
operator|)
name|addr
operator|=
name|sc
operator|->
name|hw
expr_stmt|;
break|break;
case|case
name|MOUSE_GETMODE
case|:
operator|*
operator|(
name|mousemode_t
operator|*
operator|)
name|addr
operator|=
name|sc
operator|->
name|mode
expr_stmt|;
break|break;
case|case
name|MOUSE_SETMODE
case|:
name|mode
operator|=
operator|*
operator|(
name|mousemode_t
operator|*
operator|)
name|addr
expr_stmt|;
name|addr
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|mode
operator|.
name|level
expr_stmt|;
comment|/* Fallthrough */
case|case
name|MOUSE_SETLEVEL
case|:
if|if
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|==
operator|-
literal|1
condition|)
break|break;
elseif|else
if|if
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|==
literal|1
condition|)
block|{
name|sc
operator|->
name|mode
operator|.
name|level
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|mode
operator|.
name|packetsize
operator|=
literal|8
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|mode
operator|.
name|level
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mode
operator|.
name|packetsize
operator|=
literal|5
expr_stmt|;
break|break;
block|}
return|return
name|EINVAL
return|;
case|case
name|MOUSE_GETLEVEL
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|addr
operator|=
name|sc
operator|->
name|mode
operator|.
name|level
expr_stmt|;
break|break;
case|case
name|MOUSE_GETSTATUS
case|:
block|{
name|mousestatus_t
modifier|*
name|status
init|=
operator|(
name|mousestatus_t
operator|*
operator|)
name|addr
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|status
operator|->
name|button
operator|=
name|sc
operator|->
name|buttons
expr_stmt|;
name|status
operator|->
name|obutton
operator|=
name|sc
operator|->
name|last_buttons
expr_stmt|;
name|status
operator|->
name|flags
operator|=
name|status
operator|->
name|button
operator|^
name|status
operator|->
name|obutton
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|xdelta
operator|!=
literal|0
operator|||
name|sc
operator|->
name|ydelta
condition|)
name|status
operator|->
name|flags
operator||=
name|MOUSE_POSCHANGED
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|button
operator|!=
name|status
operator|->
name|obutton
condition|)
name|status
operator|->
name|flags
operator||=
name|MOUSE_BUTTONSCHANGED
expr_stmt|;
name|status
operator|->
name|dx
operator|=
name|sc
operator|->
name|xdelta
expr_stmt|;
name|status
operator|->
name|dy
operator|=
name|sc
operator|->
name|ydelta
expr_stmt|;
name|status
operator|->
name|dz
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|xdelta
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ydelta
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|last_buttons
operator|=
name|sc
operator|->
name|buttons
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
return|return
name|ENOTTY
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|adb_tapping_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|adb_mouse_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_char
name|r2
index|[
literal|8
index|]
decl_stmt|;
name|u_int
name|tapping
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|sc_dev
expr_stmt|;
name|tapping
operator|=
name|sc
operator|->
name|sc_tapping
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|tapping
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|tapping
operator|==
literal|1
condition|)
block|{
name|adb_read_register
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|r2
argument_list|)
expr_stmt|;
name|r2
index|[
literal|0
index|]
operator|=
literal|0x99
expr_stmt|;
comment|/* enable tapping. */
name|adb_write_register
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
literal|8
argument_list|,
name|r2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tapping
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tapping
operator|==
literal|0
condition|)
block|{
name|adb_read_register
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|r2
argument_list|)
expr_stmt|;
name|r2
index|[
literal|0
index|]
operator|=
literal|0x19
expr_stmt|;
comment|/* disable tapping. */
name|adb_write_register
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
literal|8
argument_list|,
name|r2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tapping
operator|=
literal|0
expr_stmt|;
block|}
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


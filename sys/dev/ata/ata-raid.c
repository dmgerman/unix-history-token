begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2000 - 2007 SÃ¸ren Schmidt<sos@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_ata.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/ata.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/disk.h>
end_include

begin_include
include|#
directive|include
file|<sys/cons.h>
end_include

begin_include
include|#
directive|include
file|<sys/sema.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<vm/uma.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<geom/geom_disk.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-all.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-disk.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-raid.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-pci.h>
end_include

begin_include
include|#
directive|include
file|<ata_if.h>
end_include

begin_comment
comment|/* prototypes */
end_comment

begin_function_decl
specifier|static
name|void
name|ata_raid_done
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_config_changed
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|,
name|int
name|writeback
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_status
parameter_list|(
name|struct
name|ata_ioc_raid_config
modifier|*
name|config
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_create
parameter_list|(
name|struct
name|ata_ioc_raid_config
modifier|*
name|config
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_delete
parameter_list|(
name|int
name|array
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_addspare
parameter_list|(
name|struct
name|ata_ioc_raid_config
modifier|*
name|config
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_rebuild
parameter_list|(
name|int
name|array
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_read_metadata
parameter_list|(
name|device_t
name|subdisk
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_write_metadata
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_wipe_metadata
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_adaptec_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_hptv2_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_hptv2_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_hptv3_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_intel_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_intel_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_ite_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_jmicron_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_jmicron_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_lsiv2_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_lsiv3_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_nvidia_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_promise_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|,
name|int
name|native
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_promise_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_sii_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_sis_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_sis_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_via_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_via_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ata_request
modifier|*
name|ata_raid_init_request
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|,
name|struct
name|bio
modifier|*
name|bio
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_send_request
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_raid_rw
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_int64_t
name|lba
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int
name|bcount
parameter_list|,
name|int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ata_raid_format
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ata_raid_type
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ata_raid_flags
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* debugging only */
end_comment

begin_function_decl
specifier|static
name|void
name|ata_raid_print_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_adaptec_print_meta
parameter_list|(
name|struct
name|adaptec_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_hptv2_print_meta
parameter_list|(
name|struct
name|hptv2_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_hptv3_print_meta
parameter_list|(
name|struct
name|hptv3_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_intel_print_meta
parameter_list|(
name|struct
name|intel_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_ite_print_meta
parameter_list|(
name|struct
name|ite_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_jmicron_print_meta
parameter_list|(
name|struct
name|jmicron_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_lsiv2_print_meta
parameter_list|(
name|struct
name|lsiv2_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_lsiv3_print_meta
parameter_list|(
name|struct
name|lsiv3_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_nvidia_print_meta
parameter_list|(
name|struct
name|nvidia_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_promise_print_meta
parameter_list|(
name|struct
name|promise_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_sii_print_meta
parameter_list|(
name|struct
name|sii_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_sis_print_meta
parameter_list|(
name|struct
name|sis_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_raid_via_print_meta
parameter_list|(
name|struct
name|via_raid_conf
modifier|*
name|meta
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* internal vars */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|ar_softc
modifier|*
name|ata_raid_arrays
index|[
name|MAX_ARRAYS
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_AR
argument_list|,
literal|"ar_driver"
argument_list|,
literal|"ATA PseudoRAID driver"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|ata_raid_sub_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|testing
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* device structures */
end_comment

begin_decl_stmt
specifier|static
name|disk_strategy_t
name|ata_raid_strategy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dumper_t
name|ata_raid_dump
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|ata_raid_attach
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|,
name|int
name|writeback
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|32
index|]
decl_stmt|;
name|int
name|disk
decl_stmt|;
name|mtx_init
argument_list|(
operator|&
name|rdp
operator|->
name|lock
argument_list|,
literal|"ATA PseudoRAID metadata lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|ata_raid_config_changed
argument_list|(
name|rdp
argument_list|,
name|writeback
argument_list|)
expr_stmt|;
comment|/* sanitize arrays total_size % (width * interleave) == 0 */
if|if
condition|(
name|rdp
operator|->
name|type
operator|==
name|AR_T_RAID0
operator|||
name|rdp
operator|->
name|type
operator|==
name|AR_T_RAID01
operator|||
name|rdp
operator|->
name|type
operator|==
name|AR_T_RAID5
condition|)
block|{
name|rdp
operator|->
name|total_sectors
operator|=
operator|(
name|rdp
operator|->
name|total_sectors
operator|/
operator|(
name|rdp
operator|->
name|interleave
operator|*
name|rdp
operator|->
name|width
operator|)
operator|)
operator|*
operator|(
name|rdp
operator|->
name|interleave
operator|*
name|rdp
operator|->
name|width
operator|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|" (stripe %d KB)"
argument_list|,
operator|(
name|rdp
operator|->
name|interleave
operator|*
name|DEV_BSIZE
operator|)
operator|/
literal|1024
argument_list|)
expr_stmt|;
block|}
else|else
name|buffer
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|rdp
operator|->
name|disk
operator|=
name|disk_alloc
argument_list|()
expr_stmt|;
name|rdp
operator|->
name|disk
operator|->
name|d_strategy
operator|=
name|ata_raid_strategy
expr_stmt|;
name|rdp
operator|->
name|disk
operator|->
name|d_dump
operator|=
name|ata_raid_dump
expr_stmt|;
name|rdp
operator|->
name|disk
operator|->
name|d_name
operator|=
literal|"ar"
expr_stmt|;
name|rdp
operator|->
name|disk
operator|->
name|d_sectorsize
operator|=
name|DEV_BSIZE
expr_stmt|;
name|rdp
operator|->
name|disk
operator|->
name|d_mediasize
operator|=
operator|(
name|off_t
operator|)
name|rdp
operator|->
name|total_sectors
operator|*
name|DEV_BSIZE
expr_stmt|;
name|rdp
operator|->
name|disk
operator|->
name|d_fwsectors
operator|=
name|rdp
operator|->
name|sectors
expr_stmt|;
name|rdp
operator|->
name|disk
operator|->
name|d_fwheads
operator|=
name|rdp
operator|->
name|heads
expr_stmt|;
name|rdp
operator|->
name|disk
operator|->
name|d_maxsize
operator|=
literal|128
operator|*
name|DEV_BSIZE
expr_stmt|;
name|rdp
operator|->
name|disk
operator|->
name|d_drv1
operator|=
name|rdp
expr_stmt|;
name|rdp
operator|->
name|disk
operator|->
name|d_unit
operator|=
name|rdp
operator|->
name|lun
expr_stmt|;
comment|/* we support flushing cache if all components support it */
comment|/* XXX: not all components can be connected at this point */
name|rdp
operator|->
name|disk
operator|->
name|d_flags
operator|=
name|DISKFLAG_CANFLUSHCACHE
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
decl_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
operator|(
name|atadev
operator|=
name|device_get_softc
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|atadev
operator|->
name|param
operator|.
name|support
operator|.
name|command2
operator|&
name|ATA_SUPPORT_FLUSHCACHE
condition|)
continue|continue;
name|rdp
operator|->
name|disk
operator|->
name|d_flags
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|disk_create
argument_list|(
name|rdp
operator|->
name|disk
argument_list|,
name|DISK_VERSION
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ar%d: %juMB<%s %s%s> status: %s\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|,
name|rdp
operator|->
name|total_sectors
operator|/
operator|(
operator|(
literal|1024L
operator|*
literal|1024L
operator|)
operator|/
name|DEV_BSIZE
operator|)
argument_list|,
name|ata_raid_format
argument_list|(
name|rdp
argument_list|)
argument_list|,
name|ata_raid_type
argument_list|(
name|rdp
argument_list|)
argument_list|,
name|buffer
argument_list|,
name|ata_raid_flags
argument_list|(
name|rdp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"ar%d: %ju sectors [%dC/%dH/%dS]<%s> subdisks defined as:\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|,
name|rdp
operator|->
name|total_sectors
argument_list|,
name|rdp
operator|->
name|cylinders
argument_list|,
name|rdp
operator|->
name|heads
argument_list|,
name|rdp
operator|->
name|sectors
argument_list|,
name|rdp
operator|->
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"ar%d: disk%d "
argument_list|,
name|rdp
operator|->
name|lun
argument_list|,
name|disk
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_PRESENT
condition|)
block|{
comment|/* status of this disk in the array */
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
condition|)
name|printf
argument_list|(
literal|"READY "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_SPARE
condition|)
name|printf
argument_list|(
literal|"SPARE "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"FREE  "
argument_list|)
expr_stmt|;
comment|/* what type of disk is this in the array */
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_RAID1
case|:
case|case
name|AR_T_RAID01
case|:
if|if
condition|(
name|disk
operator|<
name|rdp
operator|->
name|width
condition|)
name|printf
argument_list|(
literal|"(master) "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"(mirror) "
argument_list|)
expr_stmt|;
block|}
comment|/* which physical disk is used */
name|printf
argument_list|(
literal|"using %s at ata%d-%s\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|device_get_parent
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|)
argument_list|,
operator|(
operator|(
operator|(
expr|struct
name|ata_device
operator|*
operator|)
name|device_get_softc
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
operator|)
operator|->
name|unit
operator|==
name|ATA_MASTER
operator|)
condition|?
literal|"master"
else|:
literal|"slave"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ASSIGNED
condition|)
name|printf
argument_list|(
literal|"DOWN\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"INVALID no RAID config on this subdisk\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"DOWN no device found for this subdisk\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_ioctl
parameter_list|(
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|ata_ioc_raid_config
modifier|*
name|config
init|=
operator|(
expr|struct
name|ata_ioc_raid_config
operator|*
operator|)
name|data
decl_stmt|;
name|int
modifier|*
name|lun
init|=
operator|(
name|int
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|error
init|=
name|EOPNOTSUPP
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|IOCATARAIDSTATUS
case|:
name|error
operator|=
name|ata_raid_status
argument_list|(
name|config
argument_list|)
expr_stmt|;
break|break;
case|case
name|IOCATARAIDCREATE
case|:
name|error
operator|=
name|ata_raid_create
argument_list|(
name|config
argument_list|)
expr_stmt|;
break|break;
case|case
name|IOCATARAIDDELETE
case|:
name|error
operator|=
name|ata_raid_delete
argument_list|(
operator|*
name|lun
argument_list|)
expr_stmt|;
break|break;
case|case
name|IOCATARAIDADDSPARE
case|:
name|error
operator|=
name|ata_raid_addspare
argument_list|(
name|config
argument_list|)
expr_stmt|;
break|break;
case|case
name|IOCATARAIDREBUILD
case|:
name|error
operator|=
name|ata_raid_rebuild
argument_list|(
operator|*
name|lun
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_flush
parameter_list|(
name|struct
name|bio
modifier|*
name|bp
parameter_list|)
block|{
name|struct
name|ar_softc
modifier|*
name|rdp
init|=
name|bp
operator|->
name|bio_disk
operator|->
name|d_drv1
decl_stmt|;
name|struct
name|ata_request
modifier|*
name|request
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|int
name|disk
decl_stmt|,
name|error
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|bp
operator|->
name|bio_pflags
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|dev
operator|=
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|)
operator|!=
name|NULL
condition|)
name|bp
operator|->
name|bio_pflags
operator|++
expr_stmt|;
block|}
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|dev
operator|=
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|)
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
operator|!
operator|(
name|request
operator|=
name|ata_raid_init_request
argument_list|(
name|rdp
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
name|request
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_FLUSHCACHE
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|=
literal|0
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
operator|=
literal|0
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
operator|=
literal|0
expr_stmt|;
name|request
operator|->
name|timeout
operator|=
literal|1
expr_stmt|;
name|request
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
name|request
operator|->
name|flags
operator||=
name|ATA_R_ORDERED
operator||
name|ATA_R_DIRECT
expr_stmt|;
name|ata_queue_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_strategy
parameter_list|(
name|struct
name|bio
modifier|*
name|bp
parameter_list|)
block|{
name|struct
name|ar_softc
modifier|*
name|rdp
init|=
name|bp
operator|->
name|bio_disk
operator|->
name|d_drv1
decl_stmt|;
name|struct
name|ata_request
modifier|*
name|request
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
name|u_int64_t
name|blkno
decl_stmt|,
name|lba
decl_stmt|,
name|blk
init|=
literal|0
decl_stmt|;
name|int
name|count
decl_stmt|,
name|chunk
decl_stmt|,
name|drv
decl_stmt|,
name|par
init|=
literal|0
decl_stmt|,
name|change
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_FLUSH
condition|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|ata_raid_flush
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|biofinish
argument_list|(
name|bp
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_READY
operator|)
operator|||
operator|(
name|bp
operator|->
name|bio_cmd
operator|!=
name|BIO_READ
operator|&&
name|bp
operator|->
name|bio_cmd
operator|!=
name|BIO_WRITE
operator|)
condition|)
block|{
name|biofinish
argument_list|(
name|bp
argument_list|,
name|NULL
argument_list|,
name|EIO
argument_list|)
expr_stmt|;
return|return;
block|}
name|bp
operator|->
name|bio_resid
operator|=
name|bp
operator|->
name|bio_bcount
expr_stmt|;
for|for
control|(
name|count
operator|=
name|howmany
argument_list|(
name|bp
operator|->
name|bio_bcount
argument_list|,
name|DEV_BSIZE
argument_list|)
operator|,
name|blkno
operator|=
name|bp
operator|->
name|bio_pblkno
operator|,
name|data
operator|=
name|bp
operator|->
name|bio_data
init|;
name|count
operator|>
literal|0
condition|;
name|count
operator|-=
name|chunk
operator|,
name|blkno
operator|+=
name|chunk
operator|,
name|data
operator|+=
operator|(
name|chunk
operator|*
name|DEV_BSIZE
operator|)
control|)
block|{
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_RAID1
case|:
name|drv
operator|=
literal|0
expr_stmt|;
name|lba
operator|=
name|blkno
expr_stmt|;
name|chunk
operator|=
name|count
expr_stmt|;
break|break;
case|case
name|AR_T_JBOD
case|:
case|case
name|AR_T_SPAN
case|:
name|drv
operator|=
literal|0
expr_stmt|;
name|lba
operator|=
name|blkno
expr_stmt|;
while|while
condition|(
name|lba
operator|>=
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|sectors
condition|)
name|lba
operator|-=
name|rdp
operator|->
name|disks
index|[
name|drv
operator|++
index|]
operator|.
name|sectors
expr_stmt|;
name|chunk
operator|=
name|min
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|sectors
operator|-
name|lba
argument_list|,
name|count
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_T_RAID0
case|:
case|case
name|AR_T_RAID01
case|:
name|chunk
operator|=
name|blkno
operator|%
name|rdp
operator|->
name|interleave
expr_stmt|;
name|drv
operator|=
operator|(
name|blkno
operator|/
name|rdp
operator|->
name|interleave
operator|)
operator|%
name|rdp
operator|->
name|width
expr_stmt|;
name|lba
operator|=
operator|(
operator|(
operator|(
name|blkno
operator|/
name|rdp
operator|->
name|interleave
operator|)
operator|/
name|rdp
operator|->
name|width
operator|)
operator|*
name|rdp
operator|->
name|interleave
operator|)
operator|+
name|chunk
expr_stmt|;
name|chunk
operator|=
name|min
argument_list|(
name|count
argument_list|,
name|rdp
operator|->
name|interleave
operator|-
name|chunk
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_T_RAID5
case|:
name|drv
operator|=
operator|(
name|blkno
operator|/
name|rdp
operator|->
name|interleave
operator|)
operator|%
operator|(
name|rdp
operator|->
name|width
operator|-
literal|1
operator|)
expr_stmt|;
name|par
operator|=
name|rdp
operator|->
name|width
operator|-
literal|1
operator|-
operator|(
name|blkno
operator|/
operator|(
name|rdp
operator|->
name|interleave
operator|*
operator|(
name|rdp
operator|->
name|width
operator|-
literal|1
operator|)
operator|)
operator|)
operator|%
name|rdp
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|drv
operator|>=
name|par
condition|)
name|drv
operator|++
expr_stmt|;
name|lba
operator|=
operator|(
operator|(
name|blkno
operator|/
name|rdp
operator|->
name|interleave
operator|)
operator|/
operator|(
name|rdp
operator|->
name|width
operator|-
literal|1
operator|)
operator|)
operator|*
operator|(
name|rdp
operator|->
name|interleave
operator|)
operator|+
operator|(
operator|(
name|blkno
operator|%
operator|(
name|rdp
operator|->
name|interleave
operator|*
operator|(
name|rdp
operator|->
name|width
operator|-
literal|1
operator|)
operator|)
operator|)
operator|%
name|rdp
operator|->
name|interleave
operator|)
expr_stmt|;
name|chunk
operator|=
name|min
argument_list|(
name|count
argument_list|,
name|rdp
operator|->
name|interleave
operator|-
operator|(
name|lba
operator|%
name|rdp
operator|->
name|interleave
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"ar%d: unknown array type in ata_raid_strategy\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
name|biofinish
argument_list|(
name|bp
argument_list|,
name|NULL
argument_list|,
name|EIO
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* offset on all but "first on HPTv2" */
if|if
condition|(
operator|!
operator|(
name|drv
operator|==
literal|0
operator|&&
name|rdp
operator|->
name|format
operator|==
name|AR_F_HPTV2_RAID
operator|)
condition|)
name|lba
operator|+=
name|rdp
operator|->
name|offset_sectors
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|request
operator|=
name|ata_raid_init_request
argument_list|(
name|rdp
argument_list|,
name|bp
argument_list|)
operator|)
condition|)
block|{
name|biofinish
argument_list|(
name|bp
argument_list|,
name|NULL
argument_list|,
name|EIO
argument_list|)
expr_stmt|;
return|return;
block|}
name|request
operator|->
name|data
operator|=
name|data
expr_stmt|;
name|request
operator|->
name|bytecount
operator|=
name|chunk
operator|*
name|DEV_BSIZE
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|=
name|lba
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
operator|=
name|request
operator|->
name|bytecount
operator|/
name|DEV_BSIZE
expr_stmt|;
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_JBOD
case|:
case|case
name|AR_T_SPAN
case|:
case|case
name|AR_T_RAID0
case|:
if|if
condition|(
operator|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|&&
operator|!
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|dev
operator|)
condition|)
block|{
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
name|ata_raid_config_changed
argument_list|(
name|rdp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ata_free_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|biofinish
argument_list|(
name|bp
argument_list|,
name|NULL
argument_list|,
name|EIO
argument_list|)
expr_stmt|;
return|return;
block|}
name|request
operator|->
name|this
operator|=
name|drv
expr_stmt|;
name|request
operator|->
name|dev
operator|=
name|rdp
operator|->
name|disks
index|[
name|request
operator|->
name|this
index|]
operator|.
name|dev
expr_stmt|;
name|ata_raid_send_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_T_RAID1
case|:
case|case
name|AR_T_RAID01
case|:
if|if
condition|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|&&
operator|!
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|dev
condition|)
block|{
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
name|change
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|&&
operator|!
name|rdp
operator|->
name|disks
index|[
name|drv
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|dev
condition|)
block|{
name|rdp
operator|->
name|disks
index|[
name|drv
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
name|change
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|change
condition|)
name|ata_raid_config_changed
argument_list|(
name|rdp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_READY
operator|)
condition|)
block|{
name|ata_free_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|biofinish
argument_list|(
name|bp
argument_list|,
name|NULL
argument_list|,
name|EIO
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_REBUILDING
condition|)
name|blk
operator|=
operator|(
operator|(
name|lba
operator|/
name|rdp
operator|->
name|interleave
operator|)
operator|*
name|rdp
operator|->
name|width
operator|)
operator|*
name|rdp
operator|->
name|interleave
operator|+
operator|(
name|rdp
operator|->
name|interleave
operator|*
operator|(
name|drv
operator|%
name|rdp
operator|->
name|width
operator|)
operator|)
operator|+
name|lba
operator|%
name|rdp
operator|->
name|interleave
expr_stmt|;
empty_stmt|;
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_READ
condition|)
block|{
name|int
name|src_online
init|=
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
decl_stmt|;
name|int
name|mir_online
init|=
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
decl_stmt|;
comment|/* if mirror gone or close to last access on source */
if|if
condition|(
operator|!
name|mir_online
operator|||
operator|(
operator|(
name|src_online
operator|)
operator|&&
name|bp
operator|->
name|bio_pblkno
operator|>=
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|last_lba
operator|-
name|AR_PROXIMITY
operator|)
operator|&&
name|bp
operator|->
name|bio_pblkno
operator|<=
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|last_lba
operator|+
name|AR_PROXIMITY
operator|)
operator|)
condition|)
block|{
name|rdp
operator|->
name|toggle
operator|=
literal|0
expr_stmt|;
block|}
comment|/* if source gone or close to last access on mirror */
elseif|else
if|if
condition|(
operator|!
name|src_online
operator|||
operator|(
operator|(
name|mir_online
operator|)
operator|&&
name|bp
operator|->
name|bio_pblkno
operator|>=
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|last_lba
operator|-
name|AR_PROXIMITY
operator|)
operator|&&
name|bp
operator|->
name|bio_pblkno
operator|<=
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|last_lba
operator|+
name|AR_PROXIMITY
operator|)
operator|)
condition|)
block|{
name|drv
operator|+=
name|rdp
operator|->
name|width
expr_stmt|;
name|rdp
operator|->
name|toggle
operator|=
literal|1
expr_stmt|;
block|}
comment|/* not close to any previous access, toggle */
else|else
block|{
if|if
condition|(
name|rdp
operator|->
name|toggle
condition|)
name|rdp
operator|->
name|toggle
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|drv
operator|+=
name|rdp
operator|->
name|width
expr_stmt|;
name|rdp
operator|->
name|toggle
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_REBUILDING
operator|)
operator|&&
operator|(
name|blk
operator|<=
name|rdp
operator|->
name|rebuild_lba
operator|)
operator|&&
operator|(
operator|(
name|blk
operator|+
name|chunk
operator|)
operator|>
name|rdp
operator|->
name|rebuild_lba
operator|)
condition|)
block|{
name|struct
name|ata_composite
modifier|*
name|composite
decl_stmt|;
name|struct
name|ata_request
modifier|*
name|rebuild
decl_stmt|;
name|int
name|this
decl_stmt|;
comment|/* figure out what part to rebuild */
if|if
condition|(
name|drv
operator|<
name|rdp
operator|->
name|width
condition|)
name|this
operator|=
name|drv
operator|+
name|rdp
operator|->
name|width
expr_stmt|;
else|else
name|this
operator|=
name|drv
operator|-
name|rdp
operator|->
name|width
expr_stmt|;
comment|/* do we have a spare to rebuild on ? */
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|this
index|]
operator|.
name|flags
operator|&
name|AR_DF_SPARE
condition|)
block|{
if|if
condition|(
operator|(
name|composite
operator|=
name|ata_alloc_composite
argument_list|()
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|rebuild
operator|=
name|ata_alloc_request
argument_list|()
operator|)
condition|)
block|{
name|rdp
operator|->
name|rebuild_lba
operator|=
name|blk
operator|+
name|chunk
expr_stmt|;
name|bcopy
argument_list|(
name|request
argument_list|,
name|rebuild
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ata_request
argument_list|)
argument_list|)
expr_stmt|;
name|rebuild
operator|->
name|this
operator|=
name|this
expr_stmt|;
name|rebuild
operator|->
name|dev
operator|=
name|rdp
operator|->
name|disks
index|[
name|this
index|]
operator|.
name|dev
expr_stmt|;
name|rebuild
operator|->
name|flags
operator|&=
operator|~
name|ATA_R_READ
expr_stmt|;
name|rebuild
operator|->
name|flags
operator||=
name|ATA_R_WRITE
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|composite
operator|->
name|lock
argument_list|,
literal|"ATA PseudoRAID rebuild lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|composite
operator|->
name|residual
operator|=
name|request
operator|->
name|bytecount
expr_stmt|;
name|composite
operator|->
name|rd_needed
operator||=
operator|(
literal|1
operator|<<
name|drv
operator|)
expr_stmt|;
name|composite
operator|->
name|wr_depend
operator||=
operator|(
literal|1
operator|<<
name|drv
operator|)
expr_stmt|;
name|composite
operator|->
name|wr_needed
operator||=
operator|(
literal|1
operator|<<
name|this
operator|)
expr_stmt|;
name|composite
operator|->
name|request
index|[
name|drv
index|]
operator|=
name|request
expr_stmt|;
name|composite
operator|->
name|request
index|[
name|this
index|]
operator|=
name|rebuild
expr_stmt|;
name|request
operator|->
name|composite
operator|=
name|composite
expr_stmt|;
name|rebuild
operator|->
name|composite
operator|=
name|composite
expr_stmt|;
name|ata_raid_send_request
argument_list|(
name|rebuild
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ata_free_composite
argument_list|(
name|composite
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DOH! ata_alloc_request failed!\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"DOH! ata_alloc_composite failed!\n"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|this
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
condition|)
block|{
comment|/* 			 * if we got here we are a chunk of a RAID01 that  			 * does not need a rebuild, but we need to increment 			 * the rebuild_lba address to get the rebuild to 			 * move to the next chunk correctly 			 */
name|rdp
operator|->
name|rebuild_lba
operator|=
name|blk
operator|+
name|chunk
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"DOH! we didn't find the rebuild part\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_WRITE
condition|)
block|{
if|if
condition|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
operator|||
operator|(
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_REBUILDING
operator|)
operator|&&
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|flags
operator|&
name|AR_DF_SPARE
operator|)
operator|&&
operator|(
operator|(
name|blk
operator|<
name|rdp
operator|->
name|rebuild_lba
operator|)
operator|||
operator|(
operator|(
name|blk
operator|<=
name|rdp
operator|->
name|rebuild_lba
operator|)
operator|&&
operator|(
operator|(
name|blk
operator|+
name|chunk
operator|)
operator|>
name|rdp
operator|->
name|rebuild_lba
operator|)
operator|)
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
operator|||
operator|(
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_REBUILDING
operator|)
operator|&&
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|flags
operator|&
name|AR_DF_SPARE
operator|)
operator|&&
operator|(
operator|(
name|blk
operator|<
name|rdp
operator|->
name|rebuild_lba
operator|)
operator|||
operator|(
operator|(
name|blk
operator|<=
name|rdp
operator|->
name|rebuild_lba
operator|)
operator|&&
operator|(
operator|(
name|blk
operator|+
name|chunk
operator|)
operator|>
name|rdp
operator|->
name|rebuild_lba
operator|)
operator|)
operator|)
operator|)
condition|)
block|{
name|struct
name|ata_request
modifier|*
name|mirror
decl_stmt|;
name|struct
name|ata_composite
modifier|*
name|composite
decl_stmt|;
name|int
name|this
init|=
name|drv
operator|+
name|rdp
operator|->
name|width
decl_stmt|;
if|if
condition|(
operator|(
name|composite
operator|=
name|ata_alloc_composite
argument_list|()
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|mirror
operator|=
name|ata_alloc_request
argument_list|()
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|blk
operator|<=
name|rdp
operator|->
name|rebuild_lba
operator|)
operator|&&
operator|(
operator|(
name|blk
operator|+
name|chunk
operator|)
operator|>
name|rdp
operator|->
name|rebuild_lba
operator|)
condition|)
name|rdp
operator|->
name|rebuild_lba
operator|=
name|blk
operator|+
name|chunk
expr_stmt|;
name|bcopy
argument_list|(
name|request
argument_list|,
name|mirror
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ata_request
argument_list|)
argument_list|)
expr_stmt|;
name|mirror
operator|->
name|this
operator|=
name|this
expr_stmt|;
name|mirror
operator|->
name|dev
operator|=
name|rdp
operator|->
name|disks
index|[
name|this
index|]
operator|.
name|dev
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|composite
operator|->
name|lock
argument_list|,
literal|"ATA PseudoRAID mirror lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|composite
operator|->
name|residual
operator|=
name|request
operator|->
name|bytecount
expr_stmt|;
name|composite
operator|->
name|wr_needed
operator||=
operator|(
literal|1
operator|<<
name|drv
operator|)
expr_stmt|;
name|composite
operator|->
name|wr_needed
operator||=
operator|(
literal|1
operator|<<
name|this
operator|)
expr_stmt|;
name|composite
operator|->
name|request
index|[
name|drv
index|]
operator|=
name|request
expr_stmt|;
name|composite
operator|->
name|request
index|[
name|this
index|]
operator|=
name|mirror
expr_stmt|;
name|request
operator|->
name|composite
operator|=
name|composite
expr_stmt|;
name|mirror
operator|->
name|composite
operator|=
name|composite
expr_stmt|;
name|ata_raid_send_request
argument_list|(
name|mirror
argument_list|)
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|this
index|]
operator|.
name|last_lba
operator|=
name|bp
operator|->
name|bio_pblkno
operator|+
name|chunk
expr_stmt|;
block|}
else|else
block|{
name|ata_free_composite
argument_list|(
name|composite
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DOH! ata_alloc_request failed!\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"DOH! ata_alloc_composite failed!\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|drv
operator|+=
name|rdp
operator|->
name|width
expr_stmt|;
block|}
block|}
name|request
operator|->
name|this
operator|=
name|drv
expr_stmt|;
name|request
operator|->
name|dev
operator|=
name|rdp
operator|->
name|disks
index|[
name|request
operator|->
name|this
index|]
operator|.
name|dev
expr_stmt|;
name|ata_raid_send_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|request
operator|->
name|this
index|]
operator|.
name|last_lba
operator|=
name|bp
operator|->
name|bio_pblkno
operator|+
name|chunk
expr_stmt|;
break|break;
case|case
name|AR_T_RAID5
case|:
if|if
condition|(
operator|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|&&
operator|!
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|dev
operator|)
condition|)
block|{
name|rdp
operator|->
name|disks
index|[
name|drv
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
name|change
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|par
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|&&
operator|!
name|rdp
operator|->
name|disks
index|[
name|par
index|]
operator|.
name|dev
operator|)
condition|)
block|{
name|rdp
operator|->
name|disks
index|[
name|par
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
name|change
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|change
condition|)
name|ata_raid_config_changed
argument_list|(
name|rdp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_READY
operator|)
condition|)
block|{
name|ata_free_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|biofinish
argument_list|(
name|bp
argument_list|,
name|NULL
argument_list|,
name|EIO
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_DEGRADED
condition|)
block|{
comment|/* do the XOR game if possible */
block|}
else|else
block|{
name|request
operator|->
name|this
operator|=
name|drv
expr_stmt|;
name|request
operator|->
name|dev
operator|=
name|rdp
operator|->
name|disks
index|[
name|request
operator|->
name|this
index|]
operator|.
name|dev
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_READ
condition|)
block|{
name|ata_raid_send_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_WRITE
condition|)
block|{
name|ata_raid_send_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
comment|// sikre at lÃ¦s-modify-skriv til hver disk er atomarisk.
comment|// par kopi af request
comment|// lÃ¦se orgdata fra drv
comment|// skriv nydata til drv
comment|// lÃ¦se parorgdata fra par
comment|// skriv orgdata xor parorgdata xor nydata til par
block|}
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"ar%d: unknown array type in ata_raid_strategy\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_done
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ar_softc
modifier|*
name|rdp
init|=
name|request
operator|->
name|driver
decl_stmt|;
name|struct
name|ata_composite
modifier|*
name|composite
init|=
name|NULL
decl_stmt|;
name|struct
name|bio
modifier|*
name|bp
init|=
name|request
operator|->
name|bio
decl_stmt|;
name|int
name|i
decl_stmt|,
name|mirror
decl_stmt|,
name|finished
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_FLUSH
condition|)
block|{
if|if
condition|(
name|bp
operator|->
name|bio_error
operator|==
literal|0
condition|)
name|bp
operator|->
name|bio_error
operator|=
name|request
operator|->
name|result
expr_stmt|;
name|ata_free_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|bp
operator|->
name|bio_pflags
operator|==
literal|0
condition|)
name|biodone
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_JBOD
case|:
case|case
name|AR_T_SPAN
case|:
case|case
name|AR_T_RAID0
case|:
if|if
condition|(
name|request
operator|->
name|result
condition|)
block|{
name|rdp
operator|->
name|disks
index|[
name|request
operator|->
name|this
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
name|ata_raid_config_changed
argument_list|(
name|rdp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bp
operator|->
name|bio_error
operator|=
name|request
operator|->
name|result
expr_stmt|;
name|finished
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|bp
operator|->
name|bio_resid
operator|-=
name|request
operator|->
name|donecount
expr_stmt|;
if|if
condition|(
operator|!
name|bp
operator|->
name|bio_resid
condition|)
name|finished
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|AR_T_RAID1
case|:
case|case
name|AR_T_RAID01
case|:
if|if
condition|(
name|request
operator|->
name|this
operator|<
name|rdp
operator|->
name|width
condition|)
name|mirror
operator|=
name|request
operator|->
name|this
operator|+
name|rdp
operator|->
name|width
expr_stmt|;
else|else
name|mirror
operator|=
name|request
operator|->
name|this
operator|-
name|rdp
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|result
condition|)
block|{
name|rdp
operator|->
name|disks
index|[
name|request
operator|->
name|this
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
name|ata_raid_config_changed
argument_list|(
name|rdp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_READY
condition|)
block|{
name|u_int64_t
name|blk
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_REBUILDING
condition|)
name|blk
operator|=
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|/
name|rdp
operator|->
name|interleave
operator|)
operator|*
name|rdp
operator|->
name|width
operator|)
operator|*
name|rdp
operator|->
name|interleave
operator|+
operator|(
name|rdp
operator|->
name|interleave
operator|*
operator|(
name|request
operator|->
name|this
operator|%
name|rdp
operator|->
name|width
operator|)
operator|)
operator|+
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|%
name|rdp
operator|->
name|interleave
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_READ
condition|)
block|{
comment|/* is this a rebuild composite */
if|if
condition|(
operator|(
name|composite
operator|=
name|request
operator|->
name|composite
operator|)
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|composite
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* handle the read part of a rebuild composite */
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|)
block|{
comment|/* if read failed array is now broken */
if|if
condition|(
name|request
operator|->
name|result
condition|)
block|{
name|rdp
operator|->
name|disks
index|[
name|request
operator|->
name|this
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
name|ata_raid_config_changed
argument_list|(
name|rdp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bp
operator|->
name|bio_error
operator|=
name|request
operator|->
name|result
expr_stmt|;
name|rdp
operator|->
name|rebuild_lba
operator|=
name|blk
expr_stmt|;
name|finished
operator|=
literal|1
expr_stmt|;
block|}
comment|/* good data, update how far we've gotten */
else|else
block|{
name|bp
operator|->
name|bio_resid
operator|-=
name|request
operator|->
name|donecount
expr_stmt|;
name|composite
operator|->
name|residual
operator|-=
name|request
operator|->
name|donecount
expr_stmt|;
if|if
condition|(
operator|!
name|composite
operator|->
name|residual
condition|)
block|{
if|if
condition|(
name|composite
operator|->
name|wr_done
operator|&
operator|(
literal|1
operator|<<
name|mirror
operator|)
condition|)
name|finished
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
comment|/* handle the write part of a rebuild composite */
elseif|else
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_WRITE
condition|)
block|{
if|if
condition|(
name|composite
operator|->
name|rd_done
operator|&
operator|(
literal|1
operator|<<
name|mirror
operator|)
condition|)
block|{
if|if
condition|(
name|request
operator|->
name|result
condition|)
block|{
name|printf
argument_list|(
literal|"DOH! rebuild failed\n"
argument_list|)
expr_stmt|;
comment|/* XXX SOS */
name|rdp
operator|->
name|rebuild_lba
operator|=
name|blk
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|composite
operator|->
name|residual
condition|)
name|finished
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|mtx_unlock
argument_list|(
operator|&
name|composite
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
comment|/* if read failed retry on the mirror */
elseif|else
if|if
condition|(
name|request
operator|->
name|result
condition|)
block|{
name|request
operator|->
name|dev
operator|=
name|rdp
operator|->
name|disks
index|[
name|mirror
index|]
operator|.
name|dev
expr_stmt|;
name|request
operator|->
name|flags
operator|&=
operator|~
name|ATA_R_TIMEOUT
expr_stmt|;
name|ata_raid_send_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* we have good data */
else|else
block|{
name|bp
operator|->
name|bio_resid
operator|-=
name|request
operator|->
name|donecount
expr_stmt|;
if|if
condition|(
operator|!
name|bp
operator|->
name|bio_resid
condition|)
name|finished
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_WRITE
condition|)
block|{
comment|/* do we have a mirror or rebuild to deal with ? */
if|if
condition|(
operator|(
name|composite
operator|=
name|request
operator|->
name|composite
operator|)
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|composite
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|composite
operator|->
name|wr_done
operator|&
operator|(
literal|1
operator|<<
name|mirror
operator|)
condition|)
block|{
if|if
condition|(
name|request
operator|->
name|result
condition|)
block|{
if|if
condition|(
name|composite
operator|->
name|request
index|[
name|mirror
index|]
operator|->
name|result
condition|)
block|{
name|printf
argument_list|(
literal|"DOH! all disks failed and got here\n"
argument_list|)
expr_stmt|;
name|bp
operator|->
name|bio_error
operator|=
name|EIO
expr_stmt|;
block|}
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_REBUILDING
condition|)
block|{
name|rdp
operator|->
name|rebuild_lba
operator|=
name|blk
expr_stmt|;
name|printf
argument_list|(
literal|"DOH! rebuild failed\n"
argument_list|)
expr_stmt|;
comment|/* XXX SOS */
block|}
name|bp
operator|->
name|bio_resid
operator|-=
name|composite
operator|->
name|request
index|[
name|mirror
index|]
operator|->
name|donecount
expr_stmt|;
name|composite
operator|->
name|residual
operator|-=
name|composite
operator|->
name|request
index|[
name|mirror
index|]
operator|->
name|donecount
expr_stmt|;
block|}
else|else
block|{
name|bp
operator|->
name|bio_resid
operator|-=
name|request
operator|->
name|donecount
expr_stmt|;
name|composite
operator|->
name|residual
operator|-=
name|request
operator|->
name|donecount
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|composite
operator|->
name|residual
condition|)
name|finished
operator|=
literal|1
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|composite
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
comment|/* no mirror we are done */
else|else
block|{
name|bp
operator|->
name|bio_resid
operator|-=
name|request
operator|->
name|donecount
expr_stmt|;
if|if
condition|(
operator|!
name|bp
operator|->
name|bio_resid
condition|)
name|finished
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
else|else
name|biofinish
argument_list|(
name|bp
argument_list|,
name|NULL
argument_list|,
name|request
operator|->
name|result
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_T_RAID5
case|:
if|if
condition|(
name|request
operator|->
name|result
condition|)
block|{
name|rdp
operator|->
name|disks
index|[
name|request
operator|->
name|this
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
name|ata_raid_config_changed
argument_list|(
name|rdp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_READY
condition|)
block|{
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_READ
condition|)
block|{
comment|/* do the XOR game to recover data */
block|}
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_WRITE
condition|)
block|{
comment|/* if the parity failed we're OK sortof */
comment|/* otherwise wee need to do the XOR long dance */
block|}
name|finished
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|biofinish
argument_list|(
name|bp
argument_list|,
name|NULL
argument_list|,
name|request
operator|->
name|result
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// did we have an XOR game going ??
name|bp
operator|->
name|bio_resid
operator|-=
name|request
operator|->
name|donecount
expr_stmt|;
if|if
condition|(
operator|!
name|bp
operator|->
name|bio_resid
condition|)
name|finished
operator|=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"ar%d: unknown array type in ata_raid_done\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|finished
condition|)
block|{
if|if
condition|(
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_REBUILDING
operator|)
operator|&&
name|rdp
operator|->
name|rebuild_lba
operator|>=
name|rdp
operator|->
name|total_sectors
condition|)
block|{
name|int
name|disk
decl_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_SPARE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_SPARE
operator|)
condition|)
block|{
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_SPARE
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|AR_DF_ONLINE
expr_stmt|;
block|}
block|}
name|rdp
operator|->
name|status
operator|&=
operator|~
name|AR_S_REBUILDING
expr_stmt|;
name|ata_raid_config_changed
argument_list|(
name|rdp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bp
operator|->
name|bio_resid
condition|)
name|biodone
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|composite
condition|)
block|{
if|if
condition|(
name|finished
condition|)
block|{
comment|/* we are done with this composite, free all resources */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|composite
operator|->
name|rd_needed
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|||
name|composite
operator|->
name|wr_needed
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|ata_free_request
argument_list|(
name|composite
operator|->
name|request
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|mtx_destroy
argument_list|(
operator|&
name|composite
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ata_free_composite
argument_list|(
name|composite
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|ata_free_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_dump
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|void
modifier|*
name|virtual
parameter_list|,
name|vm_offset_t
name|physical
parameter_list|,
name|off_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|struct
name|disk
modifier|*
name|dp
init|=
name|arg
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|rdp
init|=
name|dp
operator|->
name|d_drv1
decl_stmt|;
name|struct
name|bio
name|bp
decl_stmt|;
comment|/* length zero is special and really means flush buffers to media */
if|if
condition|(
operator|!
name|length
condition|)
block|{
name|int
name|disk
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
operator|,
name|error
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
name|error
operator||=
name|ata_controlcmd
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
name|ATA_FLUSHCACHE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
condition|?
name|EIO
else|:
literal|0
operator|)
return|;
block|}
name|bzero
argument_list|(
operator|&
name|bp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bio
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|.
name|bio_disk
operator|=
name|dp
expr_stmt|;
name|bp
operator|.
name|bio_pblkno
operator|=
name|offset
operator|/
name|DEV_BSIZE
expr_stmt|;
name|bp
operator|.
name|bio_bcount
operator|=
name|length
expr_stmt|;
name|bp
operator|.
name|bio_data
operator|=
name|virtual
expr_stmt|;
name|bp
operator|.
name|bio_cmd
operator|=
name|BIO_WRITE
expr_stmt|;
name|ata_raid_strategy
argument_list|(
operator|&
name|bp
argument_list|)
expr_stmt|;
return|return
name|bp
operator|.
name|bio_error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_config_changed
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|,
name|int
name|writeback
parameter_list|)
block|{
name|int
name|disk
decl_stmt|,
name|count
decl_stmt|,
name|status
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|rdp
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* set default all working mode */
name|status
operator|=
name|rdp
operator|->
name|status
expr_stmt|;
name|rdp
operator|->
name|status
operator|&=
operator|~
name|AR_S_DEGRADED
expr_stmt|;
name|rdp
operator|->
name|status
operator||=
name|AR_S_READY
expr_stmt|;
comment|/* make sure all lost drives are accounted for */
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_PRESENT
operator|)
condition|)
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
block|}
comment|/* depending on RAID type figure out our health status */
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_JBOD
case|:
case|case
name|AR_T_SPAN
case|:
case|case
name|AR_T_RAID0
case|:
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
if|if
condition|(
operator|!
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
condition|)
name|rdp
operator|->
name|status
operator|&=
operator|~
name|AR_S_READY
expr_stmt|;
break|break;
case|case
name|AR_T_RAID1
case|:
case|case
name|AR_T_RAID01
case|:
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|width
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
operator|&&
operator|!
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
condition|)
block|{
name|rdp
operator|->
name|status
operator|&=
operator|~
name|AR_S_READY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
operator|&&
operator|!
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
operator|)
operator|||
operator|(
operator|!
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
operator|&&
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
operator|+
name|rdp
operator|->
name|width
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
operator|)
condition|)
block|{
name|rdp
operator|->
name|status
operator||=
name|AR_S_DEGRADED
expr_stmt|;
block|}
block|}
break|break;
case|case
name|AR_T_RAID5
case|:
for|for
control|(
name|count
operator|=
literal|0
operator|,
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
operator|)
condition|)
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|count
condition|)
block|{
if|if
condition|(
name|count
operator|>
literal|1
condition|)
name|rdp
operator|->
name|status
operator|&=
operator|~
name|AR_S_READY
expr_stmt|;
else|else
name|rdp
operator|->
name|status
operator||=
name|AR_S_DEGRADED
expr_stmt|;
block|}
break|break;
default|default:
name|rdp
operator|->
name|status
operator|&=
operator|~
name|AR_S_READY
expr_stmt|;
block|}
if|if
condition|(
name|rdp
operator|->
name|status
operator|!=
name|status
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_READY
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"ar%d: FAILURE - %s array broken\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|,
name|ata_raid_type
argument_list|(
name|rdp
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_DEGRADED
condition|)
block|{
if|if
condition|(
name|rdp
operator|->
name|type
operator|&
operator|(
name|AR_T_RAID1
operator||
name|AR_T_RAID01
operator|)
condition|)
name|printf
argument_list|(
literal|"ar%d: WARNING - mirror"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ar%d: WARNING - parity"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" protection lost. %s array in DEGRADED mode\n"
argument_list|,
name|ata_raid_type
argument_list|(
name|rdp
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|mtx_unlock
argument_list|(
operator|&
name|rdp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|writeback
condition|)
name|ata_raid_write_metadata
argument_list|(
name|rdp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_status
parameter_list|(
name|struct
name|ata_ioc_raid_config
modifier|*
name|config
parameter_list|)
block|{
name|struct
name|ar_softc
modifier|*
name|rdp
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdp
operator|=
name|ata_raid_arrays
index|[
name|config
operator|->
name|lun
index|]
operator|)
condition|)
return|return
name|ENXIO
return|;
name|config
operator|->
name|type
operator|=
name|rdp
operator|->
name|type
expr_stmt|;
name|config
operator|->
name|total_disks
operator|=
name|rdp
operator|->
name|total_disks
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|AR_DF_PRESENT
operator|)
operator|&&
name|rdp
operator|->
name|disks
index|[
name|i
index|]
operator|.
name|dev
condition|)
name|config
operator|->
name|disks
index|[
name|i
index|]
operator|=
name|device_get_unit
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|i
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
else|else
name|config
operator|->
name|disks
index|[
name|i
index|]
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|config
operator|->
name|interleave
operator|=
name|rdp
operator|->
name|interleave
expr_stmt|;
name|config
operator|->
name|status
operator|=
name|rdp
operator|->
name|status
expr_stmt|;
name|config
operator|->
name|progress
operator|=
literal|100
operator|*
name|rdp
operator|->
name|rebuild_lba
operator|/
name|rdp
operator|->
name|total_sectors
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_create
parameter_list|(
name|struct
name|ata_ioc_raid_config
modifier|*
name|config
parameter_list|)
block|{
name|struct
name|ar_softc
modifier|*
name|rdp
decl_stmt|;
name|device_t
name|subdisk
decl_stmt|;
name|int
name|array
decl_stmt|,
name|disk
decl_stmt|;
name|int
name|ctlr
init|=
literal|0
decl_stmt|,
name|disk_size
init|=
literal|0
decl_stmt|,
name|total_disks
init|=
literal|0
decl_stmt|;
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ata_raid_arrays
index|[
name|array
index|]
condition|)
break|break;
block|}
if|if
condition|(
name|array
operator|>=
name|MAX_ARRAYS
condition|)
return|return
name|ENOSPC
return|;
if|if
condition|(
operator|!
operator|(
name|rdp
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"ar%d: no memory for metadata storage\n"
argument_list|,
name|array
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|config
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|subdisk
operator|=
name|devclass_get_device
argument_list|(
name|ata_raid_sub_devclass
argument_list|,
name|config
operator|->
name|disks
index|[
name|disk
index|]
argument_list|)
operator|)
condition|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|subdisk
argument_list|)
decl_stmt|;
comment|/* is device already assigned to another array ? */
if|if
condition|(
name|ars
operator|->
name|raid
index|[
name|rdp
operator|->
name|volume
index|]
condition|)
block|{
name|config
operator|->
name|disks
index|[
name|disk
index|]
operator|=
operator|-
literal|1
expr_stmt|;
name|free
argument_list|(
name|rdp
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|EBUSY
return|;
block|}
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|=
name|device_get_parent
argument_list|(
name|subdisk
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pci_get_vendor
argument_list|(
name|GRANDPARENT
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|)
condition|)
block|{
case|case
name|ATA_HIGHPOINT_ID
case|:
comment|/*  		 * we need some way to decide if it should be v2 or v3 		 * for now just use v2 since the v3 BIOS knows how to  		 * handle that as well. 		 */
name|ctlr
operator|=
name|AR_F_HPTV2_RAID
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|HPTV3_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_INTEL_ID
case|:
name|ctlr
operator|=
name|AR_F_INTEL_RAID
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|INTEL_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_ITE_ID
case|:
name|ctlr
operator|=
name|AR_F_ITE_RAID
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|ITE_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_JMICRON_ID
case|:
name|ctlr
operator|=
name|AR_F_JMICRON_RAID
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|JMICRON_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
comment|/* XXX SOS cover up for bug in our PCI code */
case|case
name|ATA_PROMISE_ID
case|:
name|ctlr
operator|=
name|AR_F_PROMISE_RAID
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|PROMISE_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_SIS_ID
case|:
name|ctlr
operator|=
name|AR_F_SIS_RAID
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|SIS_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_ATI_ID
case|:
case|case
name|ATA_VIA_ID
case|:
name|ctlr
operator|=
name|AR_F_VIA_RAID
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|VIA_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* XXX SOS 		 * right, so here we are, we have an ATA chip and we want 		 * to create a RAID and store the metadata. 		 * we need to find a way to tell what kind of metadata this 		 * hardware's BIOS might be using (good ideas are welcomed) 		 * for now we just use our own native FreeBSD format. 		 * the only way to get support for the BIOS format is to 		 * setup the RAID from there, in that case we pickup the 		 * metadata format from the disks (if we support it). 		 */
name|printf
argument_list|(
literal|"WARNING!! - not able to determine metadata format\n"
literal|"WARNING!! - Using FreeBSD PseudoRAID metadata\n"
literal|"If that is not what you want, use the BIOS to "
literal|"create the array\n"
argument_list|)
expr_stmt|;
name|ctlr
operator|=
name|AR_F_FREEBSD_RAID
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|PROMISE_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* we need all disks to be of the same format */
if|if
condition|(
operator|(
name|rdp
operator|->
name|format
operator|&
name|AR_F_FORMAT_MASK
operator|)
operator|&&
operator|(
name|rdp
operator|->
name|format
operator|&
name|AR_F_FORMAT_MASK
operator|)
operator|!=
operator|(
name|ctlr
operator|&
name|AR_F_FORMAT_MASK
operator|)
condition|)
block|{
name|free
argument_list|(
name|rdp
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|EXDEV
return|;
block|}
else|else
name|rdp
operator|->
name|format
operator|=
name|ctlr
expr_stmt|;
comment|/* use the smallest disk of the lots size */
comment|/* gigabyte boundry ??? XXX SOS */
if|if
condition|(
name|disk_size
condition|)
name|disk_size
operator|=
name|min
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
argument_list|,
name|disk_size
argument_list|)
expr_stmt|;
else|else
name|disk_size
operator|=
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_ONLINE
operator|)
expr_stmt|;
name|total_disks
operator|++
expr_stmt|;
block|}
else|else
block|{
name|config
operator|->
name|disks
index|[
name|disk
index|]
operator|=
operator|-
literal|1
expr_stmt|;
name|free
argument_list|(
name|rdp
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
block|}
if|if
condition|(
name|total_disks
operator|!=
name|config
operator|->
name|total_disks
condition|)
block|{
name|free
argument_list|(
name|rdp
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
switch|switch
condition|(
name|config
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_JBOD
case|:
case|case
name|AR_T_SPAN
case|:
case|case
name|AR_T_RAID0
case|:
break|break;
case|case
name|AR_T_RAID1
case|:
if|if
condition|(
name|total_disks
operator|!=
literal|2
condition|)
block|{
name|free
argument_list|(
name|rdp
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|EPERM
return|;
block|}
break|break;
case|case
name|AR_T_RAID01
case|:
if|if
condition|(
name|total_disks
operator|%
literal|2
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|rdp
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|EPERM
return|;
block|}
break|break;
case|case
name|AR_T_RAID5
case|:
if|if
condition|(
name|total_disks
operator|<
literal|3
condition|)
block|{
name|free
argument_list|(
name|rdp
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|EPERM
return|;
block|}
break|break;
default|default:
name|free
argument_list|(
name|rdp
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|EOPNOTSUPP
return|;
block|}
name|rdp
operator|->
name|type
operator|=
name|config
operator|->
name|type
expr_stmt|;
name|rdp
operator|->
name|lun
operator|=
name|array
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|type
operator|==
name|AR_T_RAID0
operator|||
name|rdp
operator|->
name|type
operator|==
name|AR_T_RAID01
operator|||
name|rdp
operator|->
name|type
operator|==
name|AR_T_RAID5
condition|)
block|{
name|int
name|bit
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|config
operator|->
name|interleave
operator|>>=
literal|1
condition|)
name|bit
operator|++
expr_stmt|;
name|rdp
operator|->
name|interleave
operator|=
literal|1
operator|<<
name|bit
expr_stmt|;
block|}
name|rdp
operator|->
name|offset_sectors
operator|=
literal|0
expr_stmt|;
comment|/* values that depend on metadata format */
switch|switch
condition|(
name|rdp
operator|->
name|format
condition|)
block|{
case|case
name|AR_F_ADAPTEC_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|32
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|128
argument_list|)
expr_stmt|;
comment|/*+*/
break|break;
case|case
name|AR_F_HPTV2_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|8
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|128
argument_list|)
expr_stmt|;
comment|/*+*/
name|rdp
operator|->
name|offset_sectors
operator|=
name|HPTV2_LBA
argument_list|(
name|x
argument_list|)
operator|+
literal|1
expr_stmt|;
break|break;
case|case
name|AR_F_HPTV3_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|32
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|4096
argument_list|)
expr_stmt|;
comment|/*+*/
break|break;
case|case
name|AR_F_INTEL_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|8
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|256
argument_list|)
expr_stmt|;
comment|/*+*/
break|break;
case|case
name|AR_F_ITE_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|2
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|128
argument_list|)
expr_stmt|;
comment|/*+*/
break|break;
case|case
name|AR_F_JMICRON_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|8
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|256
argument_list|)
expr_stmt|;
comment|/*+*/
break|break;
case|case
name|AR_F_LSIV2_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|2
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|4096
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_LSIV3_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|2
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|256
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_PROMISE_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|2
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
comment|/*+*/
break|break;
case|case
name|AR_F_SII_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|8
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|256
argument_list|)
expr_stmt|;
comment|/*+*/
break|break;
case|case
name|AR_F_SIS_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|32
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|512
argument_list|)
expr_stmt|;
comment|/*+*/
break|break;
case|case
name|AR_F_VIA_RAID
case|:
name|rdp
operator|->
name|interleave
operator|=
name|min
argument_list|(
name|max
argument_list|(
literal|8
argument_list|,
name|rdp
operator|->
name|interleave
argument_list|)
argument_list|,
literal|128
argument_list|)
expr_stmt|;
comment|/*+*/
break|break;
block|}
name|rdp
operator|->
name|total_disks
operator|=
name|total_disks
expr_stmt|;
name|rdp
operator|->
name|width
operator|=
name|total_disks
operator|/
operator|(
name|rdp
operator|->
name|type
operator|&
operator|(
name|AR_RAID1
operator||
name|AR_T_RAID01
operator|)
condition|?
literal|2
else|:
literal|1
operator|)
expr_stmt|;
name|rdp
operator|->
name|total_sectors
operator|=
name|disk_size
operator|*
operator|(
name|rdp
operator|->
name|width
operator|-
operator|(
name|rdp
operator|->
name|type
operator|==
name|AR_RAID5
operator|)
operator|)
expr_stmt|;
name|rdp
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|rdp
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|rdp
operator|->
name|cylinders
operator|=
name|rdp
operator|->
name|total_sectors
operator|/
operator|(
literal|255
operator|*
literal|63
operator|)
expr_stmt|;
name|rdp
operator|->
name|rebuild_lba
operator|=
literal|0
expr_stmt|;
name|rdp
operator|->
name|status
operator||=
name|AR_S_READY
expr_stmt|;
comment|/* we are committed to this array, grap the subdisks */
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|config
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|subdisk
operator|=
name|devclass_get_device
argument_list|(
name|ata_raid_sub_devclass
argument_list|,
name|config
operator|->
name|disks
index|[
name|disk
index|]
argument_list|)
operator|)
condition|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|subdisk
argument_list|)
decl_stmt|;
name|ars
operator|->
name|raid
index|[
name|rdp
operator|->
name|volume
index|]
operator|=
name|rdp
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|rdp
operator|->
name|volume
index|]
operator|=
name|disk
expr_stmt|;
block|}
block|}
name|ata_raid_attach
argument_list|(
name|rdp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ata_raid_arrays
index|[
name|array
index|]
operator|=
name|rdp
expr_stmt|;
name|config
operator|->
name|lun
operator|=
name|array
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_delete
parameter_list|(
name|int
name|array
parameter_list|)
block|{
name|struct
name|ar_softc
modifier|*
name|rdp
decl_stmt|;
name|device_t
name|subdisk
decl_stmt|;
name|int
name|disk
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdp
operator|=
name|ata_raid_arrays
index|[
name|array
index|]
operator|)
condition|)
return|return
name|ENXIO
return|;
name|rdp
operator|->
name|status
operator|&=
operator|~
name|AR_S_READY
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disk
condition|)
name|disk_destroy
argument_list|(
name|rdp
operator|->
name|disk
argument_list|)
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_PRESENT
operator|)
operator|&&
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
if|if
condition|(
operator|(
name|subdisk
operator|=
name|devclass_get_device
argument_list|(
name|ata_raid_sub_devclass
argument_list|,
name|device_get_unit
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|subdisk
argument_list|)
decl_stmt|;
if|if
condition|(
name|ars
operator|->
name|raid
index|[
name|rdp
operator|->
name|volume
index|]
operator|!=
name|rdp
condition|)
comment|/* XXX SOS */
name|device_printf
argument_list|(
name|subdisk
argument_list|,
literal|"DOH! this disk doesn't belong\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ars
operator|->
name|disk_number
index|[
name|rdp
operator|->
name|volume
index|]
operator|!=
name|disk
condition|)
comment|/* XXX SOS */
name|device_printf
argument_list|(
name|subdisk
argument_list|,
literal|"DOH! this disk number is wrong\n"
argument_list|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|rdp
operator|->
name|volume
index|]
operator|=
name|NULL
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|rdp
operator|->
name|volume
index|]
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|ata_raid_wipe_metadata
argument_list|(
name|rdp
argument_list|)
expr_stmt|;
name|ata_raid_arrays
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|rdp
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_addspare
parameter_list|(
name|struct
name|ata_ioc_raid_config
modifier|*
name|config
parameter_list|)
block|{
name|struct
name|ar_softc
modifier|*
name|rdp
decl_stmt|;
name|device_t
name|subdisk
decl_stmt|;
name|int
name|disk
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdp
operator|=
name|ata_raid_arrays
index|[
name|config
operator|->
name|lun
index|]
operator|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
operator|!
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_DEGRADED
operator|)
operator|||
operator|!
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_READY
operator|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_REBUILDING
condition|)
return|return
name|EBUSY
return|;
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_RAID1
case|:
case|case
name|AR_T_RAID01
case|:
case|case
name|AR_T_RAID5
case|:
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|)
operator|&&
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
continue|continue;
if|if
condition|(
operator|(
name|subdisk
operator|=
name|devclass_get_device
argument_list|(
name|ata_raid_sub_devclass
argument_list|,
name|config
operator|->
name|disks
index|[
literal|0
index|]
argument_list|)
operator|)
condition|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|subdisk
argument_list|)
decl_stmt|;
if|if
condition|(
name|ars
operator|->
name|raid
index|[
name|rdp
operator|->
name|volume
index|]
condition|)
return|return
name|EBUSY
return|;
comment|/* XXX SOS validate size etc etc */
name|ars
operator|->
name|raid
index|[
name|rdp
operator|->
name|volume
index|]
operator|=
name|rdp
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|rdp
operator|->
name|volume
index|]
operator|=
name|disk
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|=
name|device_get_parent
argument_list|(
name|subdisk
argument_list|)
expr_stmt|;
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_SPARE
operator|)
expr_stmt|;
name|device_printf
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
literal|"inserted into ar%d disk%d as spare\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|,
name|disk
argument_list|)
expr_stmt|;
name|ata_raid_config_changed
argument_list|(
name|rdp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
name|ENXIO
return|;
default|default:
return|return
name|EPERM
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_rebuild
parameter_list|(
name|int
name|array
parameter_list|)
block|{
name|struct
name|ar_softc
modifier|*
name|rdp
decl_stmt|;
name|int
name|disk
decl_stmt|,
name|count
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdp
operator|=
name|ata_raid_arrays
index|[
name|array
index|]
operator|)
condition|)
return|return
name|ENXIO
return|;
comment|/* XXX SOS we should lock the rdp softc here */
if|if
condition|(
operator|!
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_DEGRADED
operator|)
operator|||
operator|!
operator|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_READY
operator|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_REBUILDING
condition|)
return|return
name|EBUSY
return|;
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_RAID1
case|:
case|case
name|AR_T_RAID01
case|:
case|case
name|AR_T_RAID5
case|:
for|for
control|(
name|count
operator|=
literal|0
operator|,
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_ONLINE
operator||
name|AR_DF_SPARE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_SPARE
operator|)
operator|)
operator|&&
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
name|count
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|count
condition|)
block|{
name|rdp
operator|->
name|rebuild_lba
operator|=
literal|0
expr_stmt|;
name|rdp
operator|->
name|status
operator||=
name|AR_S_REBUILDING
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EIO
return|;
default|default:
return|return
name|EPERM
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_read_metadata
parameter_list|(
name|device_t
name|subdisk
parameter_list|)
block|{
name|devclass_t
name|pci_devclass
init|=
name|devclass_find
argument_list|(
literal|"pci"
argument_list|)
decl_stmt|;
name|devclass_t
name|devclass
init|=
name|device_get_devclass
argument_list|(
name|GRANDPARENT
argument_list|(
name|GRANDPARENT
argument_list|(
name|subdisk
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
comment|/* prioritize vendor native metadata layout if possible */
if|if
condition|(
name|devclass
operator|==
name|pci_devclass
condition|)
block|{
switch|switch
condition|(
name|pci_get_vendor
argument_list|(
name|GRANDPARENT
argument_list|(
name|device_get_parent
argument_list|(
name|subdisk
argument_list|)
argument_list|)
argument_list|)
condition|)
block|{
case|case
name|ATA_HIGHPOINT_ID
case|:
if|if
condition|(
name|ata_raid_hptv3_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ata_raid_hptv2_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
break|break;
case|case
name|ATA_INTEL_ID
case|:
if|if
condition|(
name|ata_raid_intel_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
break|break;
case|case
name|ATA_ITE_ID
case|:
if|if
condition|(
name|ata_raid_ite_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
break|break;
case|case
name|ATA_JMICRON_ID
case|:
if|if
condition|(
name|ata_raid_jmicron_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
break|break;
case|case
name|ATA_NVIDIA_ID
case|:
if|if
condition|(
name|ata_raid_nvidia_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
break|break;
case|case
literal|0
case|:
comment|/* XXX SOS cover up for bug in our PCI code */
case|case
name|ATA_PROMISE_ID
case|:
if|if
condition|(
name|ata_raid_promise_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|0
return|;
break|break;
case|case
name|ATA_ATI_ID
case|:
case|case
name|ATA_SILICON_IMAGE_ID
case|:
if|if
condition|(
name|ata_raid_sii_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
break|break;
case|case
name|ATA_SIS_ID
case|:
if|if
condition|(
name|ata_raid_sis_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
break|break;
case|case
name|ATA_VIA_ID
case|:
if|if
condition|(
name|ata_raid_via_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
break|break;
block|}
block|}
comment|/* handle controllers that have multiple layout possibilities */
comment|/* NOTE: the order of these are not insignificant */
comment|/* Adaptec HostRAID */
if|if
condition|(
name|ata_raid_adaptec_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* LSILogic v3 and v2 */
if|if
condition|(
name|ata_raid_lsiv3_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ata_raid_lsiv2_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* if none of the above matched, try FreeBSD native format */
return|return
name|ata_raid_promise_read_meta
argument_list|(
name|subdisk
argument_list|,
name|ata_raid_arrays
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_write_metadata
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
switch|switch
condition|(
name|rdp
operator|->
name|format
condition|)
block|{
case|case
name|AR_F_FREEBSD_RAID
case|:
case|case
name|AR_F_PROMISE_RAID
case|:
return|return
name|ata_raid_promise_write_meta
argument_list|(
name|rdp
argument_list|)
return|;
case|case
name|AR_F_HPTV3_RAID
case|:
case|case
name|AR_F_HPTV2_RAID
case|:
comment|/* 	 * always write HPT v2 metadata, the v3 BIOS knows it as well. 	 * this is handy since we cannot know what version BIOS is on there 	 */
return|return
name|ata_raid_hptv2_write_meta
argument_list|(
name|rdp
argument_list|)
return|;
case|case
name|AR_F_INTEL_RAID
case|:
return|return
name|ata_raid_intel_write_meta
argument_list|(
name|rdp
argument_list|)
return|;
case|case
name|AR_F_JMICRON_RAID
case|:
return|return
name|ata_raid_jmicron_write_meta
argument_list|(
name|rdp
argument_list|)
return|;
case|case
name|AR_F_SIS_RAID
case|:
return|return
name|ata_raid_sis_write_meta
argument_list|(
name|rdp
argument_list|)
return|;
case|case
name|AR_F_VIA_RAID
case|:
return|return
name|ata_raid_via_write_meta
argument_list|(
name|rdp
argument_list|)
return|;
if|#
directive|if
literal|0
block|case AR_F_HPTV3_RAID: 	return ata_raid_hptv3_write_meta(rdp);      case AR_F_ADAPTEC_RAID: 	return ata_raid_adaptec_write_meta(rdp);      case AR_F_ITE_RAID: 	return ata_raid_ite_write_meta(rdp);      case AR_F_LSIV2_RAID: 	return ata_raid_lsiv2_write_meta(rdp);      case AR_F_LSIV3_RAID: 	return ata_raid_lsiv3_write_meta(rdp);      case AR_F_NVIDIA_RAID: 	return ata_raid_nvidia_write_meta(rdp);      case AR_F_SII_RAID: 	return ata_raid_sii_write_meta(rdp);
endif|#
directive|endif
default|default:
name|printf
argument_list|(
literal|"ar%d: writing of %s metadata is NOT supported yet\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|,
name|ata_raid_format
argument_list|(
name|rdp
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_wipe_metadata
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
name|int
name|disk
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|u_int64_t
name|lba
decl_stmt|;
name|u_int32_t
name|size
decl_stmt|;
name|u_int8_t
modifier|*
name|meta
decl_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
switch|switch
condition|(
name|rdp
operator|->
name|format
condition|)
block|{
case|case
name|AR_F_ADAPTEC_RAID
case|:
name|lba
operator|=
name|ADP_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|adaptec_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_HPTV2_RAID
case|:
name|lba
operator|=
name|HPTV2_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|hptv2_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_HPTV3_RAID
case|:
name|lba
operator|=
name|HPTV3_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|hptv3_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_INTEL_RAID
case|:
name|lba
operator|=
name|INTEL_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
literal|3
operator|*
literal|512
expr_stmt|;
comment|/* XXX SOS */
break|break;
case|case
name|AR_F_ITE_RAID
case|:
name|lba
operator|=
name|ITE_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ite_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_JMICRON_RAID
case|:
name|lba
operator|=
name|JMICRON_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|jmicron_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_LSIV2_RAID
case|:
name|lba
operator|=
name|LSIV2_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|lsiv2_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_LSIV3_RAID
case|:
name|lba
operator|=
name|LSIV3_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|lsiv3_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_NVIDIA_RAID
case|:
name|lba
operator|=
name|NVIDIA_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nvidia_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_FREEBSD_RAID
case|:
case|case
name|AR_F_PROMISE_RAID
case|:
name|lba
operator|=
name|PROMISE_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|promise_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_SII_RAID
case|:
name|lba
operator|=
name|SII_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sii_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_SIS_RAID
case|:
name|lba
operator|=
name|SIS_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sis_raid_conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|AR_F_VIA_RAID
case|:
name|lba
operator|=
name|VIA_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|via_raid_conf
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"ar%d: wiping of %s metadata is NOT supported yet\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|,
name|ata_raid_format
argument_list|(
name|rdp
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
name|lba
argument_list|,
name|meta
argument_list|,
name|size
argument_list|,
name|ATA_R_WRITE
operator||
name|ATA_R_DIRECT
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
literal|"wipe metadata failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
block|}
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/* Adaptec HostRAID Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_adaptec_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|adaptec_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
decl_stmt|;
name|int
name|array
decl_stmt|,
name|disk
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|adaptec_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|adaptec_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|ADP_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|adaptec_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Adaptec read metadata failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|adaptec_out
goto|;
block|}
comment|/* check if this is a Adaptec RAID struct */
if|if
condition|(
name|meta
operator|->
name|magic_0
operator|!=
name|ADP_MAGIC_0
operator|||
name|meta
operator|->
name|magic_3
operator|!=
name|ADP_MAGIC_3
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Adaptec check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|adaptec_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_adaptec_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert Adaptec metadata into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|adaptec_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_ADAPTEC_RAID
operator|)
condition|)
continue|continue;
if|if
condition|(
name|raid
operator|->
name|magic_0
operator|&&
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|magic_0
condition|)
continue|continue;
if|if
condition|(
operator|!
name|meta
operator|->
name|generation
operator|||
name|be32toh
argument_list|(
name|meta
operator|->
name|generation
argument_list|)
operator|>
name|raid
operator|->
name|generation
condition|)
block|{
switch|switch
condition|(
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|type
condition|)
block|{
case|case
name|ADP_T_RAID0
case|:
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|magic_0
expr_stmt|;
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
literal|1
operator|<<
operator|(
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|stripe_shift
operator|>>
literal|1
operator|)
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|be16toh
argument_list|(
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|total_disks
argument_list|)
expr_stmt|;
break|break;
case|case
name|ADP_T_RAID1
case|:
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|magic_0
expr_stmt|;
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|be16toh
argument_list|(
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|total_disks
argument_list|)
operator|/
literal|2
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Adaptec unknown RAID type 0x%02x\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|adaptec_out
goto|;
block|}
name|raid
operator|->
name|format
operator|=
name|AR_F_ADAPTEC_RAID
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
name|be32toh
argument_list|(
name|meta
operator|->
name|generation
argument_list|)
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|be16toh
argument_list|(
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|total_disks
argument_list|)
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|sectors
argument_list|)
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
name|strncpy
argument_list|(
name|raid
operator|->
name|name
argument_list|,
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|name
argument_list|,
name|min
argument_list|(
sizeof|sizeof
argument_list|(
name|raid
operator|->
name|name
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|name
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* clear out any old info */
if|if
condition|(
name|raid
operator|->
name|generation
condition|)
block|{
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|raid
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|=
name|NULL
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|be32toh
argument_list|(
name|meta
operator|->
name|generation
argument_list|)
operator|>=
name|raid
operator|->
name|generation
condition|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|disk_number
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
operator|!
operator|(
name|ch
operator|->
name|flags
operator|&
name|ATA_NO_SLAVE
operator|)
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|sectors
operator|=
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|disk_number
operator|+
literal|1
index|]
operator|.
name|sectors
argument_list|)
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_ONLINE
operator||
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk_number
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
block|}
break|break;
block|}
name|adaptec_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/* Highpoint V2 RocketRAID Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_hptv2_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|hptv2_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|int
name|array
decl_stmt|,
name|disk_number
init|=
literal|0
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|hptv2_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hptv2_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|HPTV2_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hptv2_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"HighPoint (v2) read metadata failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|hptv2_out
goto|;
block|}
comment|/* check if this is a HighPoint v2 RAID struct */
if|if
condition|(
name|meta
operator|->
name|magic
operator|!=
name|HPTV2_MAGIC_OK
operator|&&
name|meta
operator|->
name|magic
operator|!=
name|HPTV2_MAGIC_BAD
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"HighPoint (v2) check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|hptv2_out
goto|;
block|}
comment|/* is this disk defined, or an old leftover/spare ? */
if|if
condition|(
operator|!
name|meta
operator|->
name|magic_0
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"HighPoint (v2) check2 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|hptv2_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_hptv2_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert HighPoint (v2) metadata into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|hptv2_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_HPTV2_RAID
operator|)
condition|)
continue|continue;
switch|switch
condition|(
name|meta
operator|->
name|type
condition|)
block|{
case|case
name|HPTV2_T_RAID0
case|:
if|if
condition|(
operator|(
name|meta
operator|->
name|order
operator|&
operator|(
name|HPTV2_O_RAID0
operator||
name|HPTV2_O_OK
operator|)
operator|)
operator|==
operator|(
name|HPTV2_O_RAID0
operator||
name|HPTV2_O_OK
operator|)
condition|)
goto|goto
name|highpoint_raid1
goto|;
if|if
condition|(
name|meta
operator|->
name|order
operator|&
operator|(
name|HPTV2_O_RAID0
operator||
name|HPTV2_O_RAID1
operator|)
condition|)
goto|goto
name|highpoint_raid01
goto|;
if|if
condition|(
name|raid
operator|->
name|magic_0
operator|&&
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|magic_0
condition|)
continue|continue;
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|magic_0
expr_stmt|;
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
literal|1
operator|<<
name|meta
operator|->
name|stripe_shift
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|disk_number
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|->
name|order
operator|&
name|HPTV2_O_OK
operator|)
condition|)
name|meta
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
comment|/* mark bad */
break|break;
case|case
name|HPTV2_T_RAID1
case|:
name|highpoint_raid1
label|:
if|if
condition|(
name|raid
operator|->
name|magic_0
operator|&&
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|magic_0
condition|)
continue|continue;
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|magic_0
expr_stmt|;
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
name|disk_number
operator|=
operator|(
name|meta
operator|->
name|disk_number
operator|>
literal|0
operator|)
expr_stmt|;
break|break;
case|case
name|HPTV2_T_RAID01_RAID0
case|:
name|highpoint_raid01
label|:
if|if
condition|(
name|meta
operator|->
name|order
operator|&
name|HPTV2_O_RAID0
condition|)
block|{
if|if
condition|(
operator|(
name|raid
operator|->
name|magic_0
operator|&&
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|magic_0
operator|)
operator|||
operator|(
name|raid
operator|->
name|magic_1
operator|&&
name|raid
operator|->
name|magic_1
operator|!=
name|meta
operator|->
name|magic_1
operator|)
condition|)
continue|continue;
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|magic_0
expr_stmt|;
name|raid
operator|->
name|magic_1
operator|=
name|meta
operator|->
name|magic_1
expr_stmt|;
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
literal|1
operator|<<
name|meta
operator|->
name|stripe_shift
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|disk_number
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|raid
operator|->
name|magic_1
operator|&&
name|raid
operator|->
name|magic_1
operator|!=
name|meta
operator|->
name|magic_1
condition|)
continue|continue;
name|raid
operator|->
name|magic_1
operator|=
name|meta
operator|->
name|magic_1
expr_stmt|;
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
literal|1
operator|<<
name|meta
operator|->
name|stripe_shift
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|disk_number
operator|+
name|meta
operator|->
name|array_width
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|->
name|order
operator|&
name|HPTV2_O_RAID1
operator|)
condition|)
name|meta
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
comment|/* mark bad */
block|}
break|break;
case|case
name|HPTV2_T_SPAN
case|:
if|if
condition|(
name|raid
operator|->
name|magic_0
operator|&&
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|magic_0
condition|)
continue|continue;
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|magic_0
expr_stmt|;
name|raid
operator|->
name|type
operator|=
name|AR_T_SPAN
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|disk_number
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Highpoint (v2) unknown RAID type 0x%02x\n"
argument_list|,
name|meta
operator|->
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|hptv2_out
goto|;
block|}
name|raid
operator|->
name|format
operator||=
name|AR_F_HPTV2_RAID
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator|)
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
name|strncpy
argument_list|(
name|raid
operator|->
name|name
argument_list|,
name|meta
operator|->
name|name_1
argument_list|,
name|min
argument_list|(
sizeof|sizeof
argument_list|(
name|raid
operator|->
name|name
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|name_1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|magic
operator|==
name|HPTV2_MAGIC_OK
condition|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator||=
name|AR_DF_ONLINE
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|array_width
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|meta
operator|->
name|total_sectors
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
name|HPTV2_LBA
argument_list|(
name|parent
argument_list|)
operator|+
literal|1
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
name|meta
operator|->
name|rebuild_lba
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|sectors
operator|=
name|raid
operator|->
name|total_sectors
operator|/
name|raid
operator|->
name|width
expr_stmt|;
block|}
else|else
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
if|if
condition|(
operator|(
name|raid
operator|->
name|type
operator|&
name|AR_T_RAID0
operator|)
operator|&&
operator|(
name|raid
operator|->
name|total_disks
operator|<
name|raid
operator|->
name|width
operator|)
condition|)
name|raid
operator|->
name|total_disks
operator|=
name|raid
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|disk_number
operator|>=
name|raid
operator|->
name|total_disks
condition|)
name|raid
operator|->
name|total_disks
operator|=
name|disk_number
operator|+
literal|1
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk_number
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|hptv2_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_hptv2_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
name|struct
name|hptv2_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|timeval
name|timestamp
decl_stmt|;
name|int
name|disk
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|hptv2_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hptv2_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"ar%d: failed to allocate metadata storage\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|microtime
argument_list|(
operator|&
name|timestamp
argument_list|)
expr_stmt|;
name|rdp
operator|->
name|magic_0
operator|=
name|timestamp
operator|.
name|tv_sec
operator|+
literal|2
expr_stmt|;
name|rdp
operator|->
name|magic_1
operator|=
name|timestamp
operator|.
name|tv_sec
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
condition|)
name|meta
operator|->
name|magic
operator|=
name|HPTV2_MAGIC_OK
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ASSIGNED
condition|)
block|{
name|meta
operator|->
name|magic_0
operator|=
name|rdp
operator|->
name|magic_0
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|rdp
operator|->
name|name
argument_list|)
condition|)
name|strncpy
argument_list|(
name|meta
operator|->
name|name_1
argument_list|,
name|rdp
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|name_1
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|meta
operator|->
name|name_1
argument_list|,
literal|"FreeBSD"
argument_list|)
expr_stmt|;
block|}
name|meta
operator|->
name|disk_number
operator|=
name|disk
expr_stmt|;
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_RAID0
case|:
name|meta
operator|->
name|type
operator|=
name|HPTV2_T_RAID0
expr_stmt|;
name|strcpy
argument_list|(
name|meta
operator|->
name|name_2
argument_list|,
literal|"RAID 0"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
condition|)
name|meta
operator|->
name|order
operator|=
name|HPTV2_O_OK
expr_stmt|;
break|break;
case|case
name|AR_T_RAID1
case|:
name|meta
operator|->
name|type
operator|=
name|HPTV2_T_RAID0
expr_stmt|;
name|strcpy
argument_list|(
name|meta
operator|->
name|name_2
argument_list|,
literal|"RAID 1"
argument_list|)
expr_stmt|;
name|meta
operator|->
name|disk_number
operator|=
operator|(
name|disk
operator|<
name|rdp
operator|->
name|width
operator|)
condition|?
name|disk
else|:
name|disk
operator|+
literal|5
expr_stmt|;
name|meta
operator|->
name|order
operator|=
name|HPTV2_O_RAID0
operator||
name|HPTV2_O_OK
expr_stmt|;
break|break;
case|case
name|AR_T_RAID01
case|:
name|meta
operator|->
name|type
operator|=
name|HPTV2_T_RAID01_RAID0
expr_stmt|;
name|strcpy
argument_list|(
name|meta
operator|->
name|name_2
argument_list|,
literal|"RAID 0+1"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
condition|)
block|{
if|if
condition|(
name|disk
operator|<
name|rdp
operator|->
name|width
condition|)
block|{
name|meta
operator|->
name|order
operator|=
operator|(
name|HPTV2_O_RAID0
operator||
name|HPTV2_O_RAID1
operator|)
expr_stmt|;
name|meta
operator|->
name|magic_0
operator|=
name|rdp
operator|->
name|magic_0
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|meta
operator|->
name|order
operator|=
name|HPTV2_O_RAID1
expr_stmt|;
name|meta
operator|->
name|disk_number
operator|-=
name|rdp
operator|->
name|width
expr_stmt|;
block|}
block|}
else|else
name|meta
operator|->
name|magic_0
operator|=
name|rdp
operator|->
name|magic_0
operator|-
literal|1
expr_stmt|;
name|meta
operator|->
name|magic_1
operator|=
name|rdp
operator|->
name|magic_1
expr_stmt|;
break|break;
case|case
name|AR_T_SPAN
case|:
name|meta
operator|->
name|type
operator|=
name|HPTV2_T_SPAN
expr_stmt|;
name|strcpy
argument_list|(
name|meta
operator|->
name|name_2
argument_list|,
literal|"SPAN"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
name|meta
operator|->
name|array_width
operator|=
name|rdp
operator|->
name|width
expr_stmt|;
name|meta
operator|->
name|stripe_shift
operator|=
operator|(
name|rdp
operator|->
name|width
operator|>
literal|1
operator|)
condition|?
operator|(
name|ffs
argument_list|(
name|rdp
operator|->
name|interleave
argument_list|)
operator|-
literal|1
operator|)
else|:
literal|0
expr_stmt|;
name|meta
operator|->
name|total_sectors
operator|=
name|rdp
operator|->
name|total_sectors
expr_stmt|;
name|meta
operator|->
name|rebuild_lba
operator|=
name|rdp
operator|->
name|rebuild_lba
expr_stmt|;
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_hptv2_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
name|HPTV2_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|promise_raid_conf
argument_list|)
argument_list|,
name|ATA_R_WRITE
operator||
name|ATA_R_DIRECT
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
literal|"write metadata failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
block|}
block|}
block|}
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/* Highpoint V3 RocketRAID Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_hptv3_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|hptv3_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|int
name|array
decl_stmt|,
name|disk_number
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|hptv3_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hptv3_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|HPTV3_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hptv3_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"HighPoint (v3) read metadata failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|hptv3_out
goto|;
block|}
comment|/* check if this is a HighPoint v3 RAID struct */
if|if
condition|(
name|meta
operator|->
name|magic
operator|!=
name|HPTV3_MAGIC
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"HighPoint (v3) check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|hptv3_out
goto|;
block|}
comment|/* check if there are any config_entries */
if|if
condition|(
name|meta
operator|->
name|config_entries
operator|<
literal|1
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"HighPoint (v3) check2 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|hptv3_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_hptv3_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert HighPoint (v3) metadata into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|hptv3_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_HPTV3_RAID
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|raid
operator|->
name|format
operator|&
name|AR_F_HPTV3_RAID
operator|)
operator|&&
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|magic_0
condition|)
continue|continue;
switch|switch
condition|(
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|type
condition|)
block|{
case|case
name|HPTV3_T_RAID0
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|total_disks
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|disk_number
expr_stmt|;
break|break;
case|case
name|HPTV3_T_RAID1
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|total_disks
operator|/
literal|2
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|disk_number
expr_stmt|;
break|break;
case|case
name|HPTV3_T_RAID5
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID5
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|total_disks
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|disk_number
expr_stmt|;
break|break;
case|case
name|HPTV3_T_SPAN
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_SPAN
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|total_disks
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|disk_number
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Highpoint (v3) unknown RAID type 0x%02x\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|hptv3_out
goto|;
block|}
if|if
condition|(
name|meta
operator|->
name|config_entries
operator|==
literal|2
condition|)
block|{
switch|switch
condition|(
name|meta
operator|->
name|configs
index|[
literal|1
index|]
operator|.
name|type
condition|)
block|{
case|case
name|HPTV3_T_RAID1
case|:
if|if
condition|(
name|raid
operator|->
name|type
operator|==
name|AR_T_RAID0
condition|)
block|{
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|configs
index|[
literal|1
index|]
operator|.
name|disk_number
operator|+
operator|(
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|disk_number
operator|<<
literal|1
operator|)
expr_stmt|;
break|break;
block|}
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Highpoint (v3) unknown level 2 0x%02x\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
literal|1
index|]
operator|.
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|hptv3_out
goto|;
block|}
block|}
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|magic_0
expr_stmt|;
name|raid
operator|->
name|format
operator|=
name|AR_F_HPTV3_RAID
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
name|meta
operator|->
name|timestamp
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
literal|1
operator|<<
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|stripe_shift
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|total_disks
operator|+
name|meta
operator|->
name|configs
index|[
literal|1
index|]
operator|.
name|total_disks
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|total_sectors
operator|+
operator|(
operator|(
name|u_int64_t
operator|)
name|meta
operator|->
name|configs_high
index|[
literal|0
index|]
operator|.
name|total_sectors
operator|<<
literal|32
operator|)
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|rebuild_lba
operator|+
operator|(
operator|(
name|u_int64_t
operator|)
name|meta
operator|->
name|configs_high
index|[
literal|0
index|]
operator|.
name|rebuild_lba
operator|<<
literal|32
operator|)
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
name|strncpy
argument_list|(
name|raid
operator|->
name|name
argument_list|,
name|meta
operator|->
name|name
argument_list|,
name|min
argument_list|(
sizeof|sizeof
argument_list|(
name|raid
operator|->
name|name
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|name
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|sectors
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
name|raid
operator|->
name|type
operator|==
name|AR_T_RAID5
condition|?
name|raid
operator|->
name|width
operator|-
literal|1
else|:
name|raid
operator|->
name|width
operator|)
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_ONLINE
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk_number
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|hptv3_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/* Intel MatrixRAID Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_intel_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|intel_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|intel_raid_mapping
modifier|*
name|map
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|u_int32_t
name|checksum
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|array
decl_stmt|,
name|count
decl_stmt|,
name|disk
decl_stmt|,
name|volume
init|=
literal|1
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|tmp
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|intel_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
literal|1536
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|INTEL_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
literal|1024
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Intel read metadata failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|intel_out
goto|;
block|}
name|tmp
operator|=
operator|(
name|char
operator|*
operator|)
name|meta
expr_stmt|;
name|bcopy
argument_list|(
name|tmp
argument_list|,
name|tmp
operator|+
literal|1024
argument_list|,
literal|512
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|tmp
operator|+
literal|512
argument_list|,
name|tmp
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|tmp
operator|+
literal|1024
argument_list|,
literal|512
argument_list|)
expr_stmt|;
comment|/* check if this is a Intel RAID struct */
if|if
condition|(
name|strncmp
argument_list|(
name|meta
operator|->
name|intel_id
argument_list|,
name|INTEL_MAGIC
argument_list|,
name|strlen
argument_list|(
name|INTEL_MAGIC
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Intel check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|intel_out
goto|;
block|}
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
operator|(
name|meta
operator|->
name|config_size
operator|/
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|)
condition|;
name|count
operator|++
control|)
block|{
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
block|}
name|checksum
operator|-=
name|meta
operator|->
name|checksum
expr_stmt|;
if|if
condition|(
name|checksum
operator|!=
name|meta
operator|->
name|checksum
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Intel check2 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|intel_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_intel_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
name|map
operator|=
operator|(
expr|struct
name|intel_raid_mapping
operator|*
operator|)
operator|&
name|meta
operator|->
name|disk
index|[
name|meta
operator|->
name|total_disks
index|]
expr_stmt|;
comment|/* now convert Intel metadata into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|intel_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_INTEL_RAID
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|raid
operator|->
name|format
operator|&
name|AR_F_INTEL_RAID
operator|)
operator|&&
operator|(
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|config_id
operator|)
condition|)
continue|continue;
comment|/* 	 * update our knowledge about the array config based on generation 	 * NOTE: there can be multiple volumes on a disk set 	 */
if|if
condition|(
operator|!
name|meta
operator|->
name|generation
operator|||
name|meta
operator|->
name|generation
operator|>
name|raid
operator|->
name|generation
condition|)
block|{
switch|switch
condition|(
name|map
operator|->
name|type
condition|)
block|{
case|case
name|INTEL_T_RAID0
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|map
operator|->
name|total_disks
expr_stmt|;
break|break;
case|case
name|INTEL_T_RAID1
case|:
if|if
condition|(
name|map
operator|->
name|total_disks
operator|==
literal|4
condition|)
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
else|else
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|map
operator|->
name|total_disks
operator|/
literal|2
expr_stmt|;
break|break;
case|case
name|INTEL_T_RAID5
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID5
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|map
operator|->
name|total_disks
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Intel unknown RAID type 0x%02x\n"
argument_list|,
name|map
operator|->
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|intel_out
goto|;
block|}
switch|switch
condition|(
name|map
operator|->
name|status
condition|)
block|{
case|case
name|INTEL_S_READY
case|:
name|raid
operator|->
name|status
operator|=
name|AR_S_READY
expr_stmt|;
break|break;
case|case
name|INTEL_S_DEGRADED
case|:
name|raid
operator|->
name|status
operator||=
name|AR_S_DEGRADED
expr_stmt|;
break|break;
case|case
name|INTEL_S_DISABLED
case|:
case|case
name|INTEL_S_FAILURE
case|:
name|raid
operator|->
name|status
operator|=
literal|0
expr_stmt|;
block|}
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|config_id
expr_stmt|;
name|raid
operator|->
name|format
operator|=
name|AR_F_INTEL_RAID
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
name|meta
operator|->
name|generation
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
name|map
operator|->
name|stripe_sectors
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|map
operator|->
name|total_disks
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|map
operator|->
name|total_sectors
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
name|map
operator|->
name|offset
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
name|raid
operator|->
name|volume
operator|=
name|volume
operator|-
literal|1
expr_stmt|;
name|strncpy
argument_list|(
name|raid
operator|->
name|name
argument_list|,
name|map
operator|->
name|name
argument_list|,
name|min
argument_list|(
sizeof|sizeof
argument_list|(
name|raid
operator|->
name|name
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|map
operator|->
name|name
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* clear out any old info */
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|raid
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|=
name|NULL
expr_stmt|;
name|bcopy
argument_list|(
name|meta
operator|->
name|disk
index|[
name|map
operator|->
name|disk_idx
index|[
name|disk
index|]
index|]
operator|.
name|serial
argument_list|,
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
argument_list|,
sizeof|sizeof
argument_list|(
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
argument_list|)
argument_list|)
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|meta
operator|->
name|disk
index|[
name|map
operator|->
name|disk_idx
index|[
name|disk
index|]
index|]
operator|.
name|sectors
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|disk
index|[
name|map
operator|->
name|disk_idx
index|[
name|disk
index|]
index|]
operator|.
name|flags
operator|&
name|INTEL_F_ONLINE
condition|)
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|AR_DF_ONLINE
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|disk
index|[
name|map
operator|->
name|disk_idx
index|[
name|disk
index|]
index|]
operator|.
name|flags
operator|&
name|INTEL_F_ASSIGNED
condition|)
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|AR_DF_ASSIGNED
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|disk
index|[
name|map
operator|->
name|disk_idx
index|[
name|disk
index|]
index|]
operator|.
name|flags
operator|&
name|INTEL_F_SPARE
condition|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&=
operator|~
operator|(
name|AR_DF_ONLINE
operator||
name|AR_DF_ASSIGNED
operator|)
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|AR_DF_SPARE
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|disk
index|[
name|map
operator|->
name|disk_idx
index|[
name|disk
index|]
index|]
operator|.
name|flags
operator|&
name|INTEL_F_DOWN
condition|)
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|meta
operator|->
name|generation
operator|>=
name|raid
operator|->
name|generation
condition|)
block|{
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|raid
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
argument_list|,
name|atadev
operator|->
name|param
operator|.
name|serial
argument_list|,
sizeof|sizeof
argument_list|(
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
argument_list|)
argument_list|)
condition|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator||=
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
else|else
goto|goto
name|intel_out
goto|;
if|if
condition|(
name|retval
condition|)
block|{
if|if
condition|(
name|volume
operator|<
name|meta
operator|->
name|total_volumes
condition|)
block|{
name|map
operator|=
operator|(
expr|struct
name|intel_raid_mapping
operator|*
operator|)
operator|&
name|map
operator|->
name|disk_idx
index|[
name|map
operator|->
name|total_disks
index|]
expr_stmt|;
name|volume
operator|++
expr_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
else|else
block|{
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|volume
operator|==
literal|2
condition|)
name|retval
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|intel_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_intel_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
name|struct
name|intel_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|intel_raid_mapping
modifier|*
name|map
decl_stmt|;
name|struct
name|timeval
name|timestamp
decl_stmt|;
name|u_int32_t
name|checksum
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|count
decl_stmt|,
name|disk
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|tmp
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|intel_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
literal|1536
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"ar%d: failed to allocate metadata storage\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|rdp
operator|->
name|generation
operator|++
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|timestamp
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|INTEL_MAGIC
argument_list|,
name|meta
operator|->
name|intel_id
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|intel_id
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|INTEL_VERSION_1100
argument_list|,
name|meta
operator|->
name|version
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|version
argument_list|)
argument_list|)
expr_stmt|;
name|meta
operator|->
name|config_id
operator|=
name|timestamp
operator|.
name|tv_sec
expr_stmt|;
name|meta
operator|->
name|generation
operator|=
name|rdp
operator|->
name|generation
expr_stmt|;
name|meta
operator|->
name|total_disks
operator|=
name|rdp
operator|->
name|total_disks
expr_stmt|;
name|meta
operator|->
name|total_volumes
operator|=
literal|1
expr_stmt|;
comment|/* XXX SOS */
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
decl_stmt|;
name|bcopy
argument_list|(
name|atadev
operator|->
name|param
operator|.
name|serial
argument_list|,
name|meta
operator|->
name|disk
index|[
name|disk
index|]
operator|.
name|serial
argument_list|,
sizeof|sizeof
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
argument_list|)
argument_list|)
expr_stmt|;
name|meta
operator|->
name|disk
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
expr_stmt|;
name|meta
operator|->
name|disk
index|[
name|disk
index|]
operator|.
name|id
operator|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|16
operator|)
operator||
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
else|else
name|meta
operator|->
name|disk
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|rdp
operator|->
name|total_sectors
operator|/
name|rdp
operator|->
name|width
expr_stmt|;
name|meta
operator|->
name|disk
index|[
name|disk
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_SPARE
condition|)
name|meta
operator|->
name|disk
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|INTEL_F_SPARE
expr_stmt|;
else|else
block|{
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
condition|)
name|meta
operator|->
name|disk
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|INTEL_F_ONLINE
expr_stmt|;
else|else
name|meta
operator|->
name|disk
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|INTEL_F_DOWN
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|AR_DF_ASSIGNED
condition|)
name|meta
operator|->
name|disk
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|INTEL_F_ASSIGNED
expr_stmt|;
block|}
block|}
name|map
operator|=
operator|(
expr|struct
name|intel_raid_mapping
operator|*
operator|)
operator|&
name|meta
operator|->
name|disk
index|[
name|meta
operator|->
name|total_disks
index|]
expr_stmt|;
name|bcopy
argument_list|(
name|rdp
operator|->
name|name
argument_list|,
name|map
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|rdp
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|map
operator|->
name|total_sectors
operator|=
name|rdp
operator|->
name|total_sectors
expr_stmt|;
name|map
operator|->
name|state
operator|=
literal|12
expr_stmt|;
comment|/* XXX SOS */
name|map
operator|->
name|offset
operator|=
name|rdp
operator|->
name|offset_sectors
expr_stmt|;
name|map
operator|->
name|stripe_count
operator|=
name|rdp
operator|->
name|total_sectors
operator|/
operator|(
name|rdp
operator|->
name|interleave
operator|*
name|rdp
operator|->
name|total_disks
operator|)
expr_stmt|;
name|map
operator|->
name|stripe_sectors
operator|=
name|rdp
operator|->
name|interleave
expr_stmt|;
name|map
operator|->
name|disk_sectors
operator|=
name|rdp
operator|->
name|total_sectors
operator|/
name|rdp
operator|->
name|width
expr_stmt|;
name|map
operator|->
name|status
operator|=
name|INTEL_S_READY
expr_stmt|;
comment|/* XXX SOS */
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_RAID0
case|:
name|map
operator|->
name|type
operator|=
name|INTEL_T_RAID0
expr_stmt|;
break|break;
case|case
name|AR_T_RAID1
case|:
name|map
operator|->
name|type
operator|=
name|INTEL_T_RAID1
expr_stmt|;
break|break;
case|case
name|AR_T_RAID01
case|:
name|map
operator|->
name|type
operator|=
name|INTEL_T_RAID1
expr_stmt|;
break|break;
case|case
name|AR_T_RAID5
case|:
name|map
operator|->
name|type
operator|=
name|INTEL_T_RAID5
expr_stmt|;
break|break;
default|default:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
name|map
operator|->
name|total_disks
operator|=
name|rdp
operator|->
name|total_disks
expr_stmt|;
name|map
operator|->
name|magic
index|[
literal|0
index|]
operator|=
literal|0x02
expr_stmt|;
name|map
operator|->
name|magic
index|[
literal|1
index|]
operator|=
literal|0xff
expr_stmt|;
name|map
operator|->
name|magic
index|[
literal|2
index|]
operator|=
literal|0x01
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
name|map
operator|->
name|disk_idx
index|[
name|disk
index|]
operator|=
name|disk
expr_stmt|;
name|meta
operator|->
name|config_size
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|map
operator|->
name|disk_idx
index|[
name|disk
index|]
operator|-
operator|(
name|char
operator|*
operator|)
name|meta
expr_stmt|;
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
operator|(
name|meta
operator|->
name|config_size
operator|/
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|)
condition|;
name|count
operator|++
control|)
block|{
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
block|}
name|meta
operator|->
name|checksum
operator|=
name|checksum
expr_stmt|;
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_intel_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|char
operator|*
operator|)
name|meta
expr_stmt|;
name|bcopy
argument_list|(
name|tmp
argument_list|,
name|tmp
operator|+
literal|1024
argument_list|,
literal|512
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|tmp
operator|+
literal|512
argument_list|,
name|tmp
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|tmp
operator|+
literal|1024
argument_list|,
literal|512
argument_list|)
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
name|INTEL_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|,
name|meta
argument_list|,
literal|1024
argument_list|,
name|ATA_R_WRITE
operator||
name|ATA_R_DIRECT
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
literal|"write metadata failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
block|}
block|}
block|}
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/* Integrated Technology Express Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_ite_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ite_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|int
name|array
decl_stmt|,
name|disk_number
decl_stmt|,
name|count
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
name|u_int16_t
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|ite_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ite_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|ITE_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ite_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"ITE read metadata failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|ite_out
goto|;
block|}
comment|/* check if this is a ITE RAID struct */
for|for
control|(
name|ptr
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
name|meta
operator|->
name|ite_id
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|ite_id
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
condition|;
name|count
operator|++
control|)
name|ptr
index|[
name|count
index|]
operator|=
name|be16toh
argument_list|(
name|ptr
index|[
name|count
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|meta
operator|->
name|ite_id
argument_list|,
name|ITE_MAGIC
argument_list|,
name|strlen
argument_list|(
name|ITE_MAGIC
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"ITE check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|ite_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_ite_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert ITE metadata into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|raid
operator|=
name|raidp
index|[
name|array
index|]
operator|)
condition|)
block|{
if|if
condition|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_ITE_RAID
condition|)
continue|continue;
if|if
condition|(
name|raid
operator|->
name|magic_0
operator|!=
operator|*
operator|(
operator|(
name|u_int64_t
operator|*
operator|)
name|meta
operator|->
name|timestamp_0
operator|)
condition|)
continue|continue;
block|}
comment|/* if we dont have a disks timestamp the RAID is invalidated */
if|if
condition|(
operator|*
operator|(
operator|(
name|u_int64_t
operator|*
operator|)
name|meta
operator|->
name|timestamp_1
operator|)
operator|==
literal|0
condition|)
goto|goto
name|ite_out
goto|;
if|if
condition|(
operator|!
name|raid
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|raid
operator|=
name|raidp
index|[
name|array
index|]
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|ite_out
goto|;
block|}
block|}
switch|switch
condition|(
name|meta
operator|->
name|type
condition|)
block|{
case|case
name|ITE_T_RAID0
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|array_width
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|meta
operator|->
name|array_width
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|disk_number
expr_stmt|;
break|break;
case|case
name|ITE_T_RAID1
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
name|raid
operator|->
name|width
operator|=
literal|1
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
literal|2
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|disk_number
expr_stmt|;
break|break;
case|case
name|ITE_T_RAID01
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|array_width
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
literal|4
expr_stmt|;
name|disk_number
operator|=
operator|(
operator|(
name|meta
operator|->
name|disk_number
operator|&
literal|0x02
operator|)
operator|>>
literal|1
operator|)
operator||
operator|(
operator|(
name|meta
operator|->
name|disk_number
operator|&
literal|0x01
operator|)
operator|<<
literal|1
operator|)
expr_stmt|;
break|break;
case|case
name|ITE_T_SPAN
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_SPAN
expr_stmt|;
name|raid
operator|->
name|width
operator|=
literal|1
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|meta
operator|->
name|array_width
expr_stmt|;
name|disk_number
operator|=
name|meta
operator|->
name|disk_number
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"ITE unknown RAID type 0x%02x\n"
argument_list|,
name|meta
operator|->
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|ite_out
goto|;
block|}
name|raid
operator|->
name|magic_0
operator|=
operator|*
operator|(
operator|(
name|u_int64_t
operator|*
operator|)
name|meta
operator|->
name|timestamp_0
operator|)
expr_stmt|;
name|raid
operator|->
name|format
operator|=
name|AR_F_ITE_RAID
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
name|meta
operator|->
name|stripe_sectors
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|meta
operator|->
name|total_sectors
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|sectors
operator|=
name|raid
operator|->
name|total_sectors
operator|/
name|raid
operator|->
name|width
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_ONLINE
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk_number
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|ite_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/* JMicron Technology Corp Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_jmicron_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|jmicron_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|checksum
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|u_int64_t
name|disk_size
decl_stmt|;
name|int
name|count
decl_stmt|,
name|array
decl_stmt|,
name|disk
decl_stmt|,
name|total_disks
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|jmicron_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|jmicron_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|JMICRON_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|jmicron_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"JMicron read metadata failed\n"
argument_list|)
expr_stmt|;
block|}
comment|/* check for JMicron signature */
if|if
condition|(
name|strncmp
argument_list|(
name|meta
operator|->
name|signature
argument_list|,
name|JMICRON_MAGIC
argument_list|,
literal|2
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"JMicron check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|jmicron_out
goto|;
block|}
comment|/* calculate checksum and compare for valid */
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|64
condition|;
name|count
operator|++
control|)
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"JMicron check2 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|jmicron_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_jmicron_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert JMicron meta into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
name|jmicron_next
label|:
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|jmicron_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_JMICRON_RAID
operator|)
condition|)
continue|continue;
for|for
control|(
name|total_disks
operator|=
literal|0
operator|,
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|JM_MAX_DISKS
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|meta
operator|->
name|disks
index|[
name|disk
index|]
condition|)
block|{
if|if
condition|(
name|raid
operator|->
name|format
operator|==
name|AR_F_JMICRON_RAID
condition|)
block|{
if|if
condition|(
name|bcmp
argument_list|(
operator|&
name|meta
operator|->
name|disks
index|[
name|disk
index|]
argument_list|,
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
condition|)
block|{
name|array
operator|++
expr_stmt|;
goto|goto
name|jmicron_next
goto|;
block|}
block|}
else|else
name|bcopy
argument_list|(
operator|&
name|meta
operator|->
name|disks
index|[
name|disk
index|]
argument_list|,
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
name|total_disks
operator|++
expr_stmt|;
block|}
block|}
comment|/* handle spares XXX SOS */
switch|switch
condition|(
name|meta
operator|->
name|type
condition|)
block|{
case|case
name|JM_T_RAID0
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|total_disks
expr_stmt|;
break|break;
case|case
name|JM_T_RAID1
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
name|raid
operator|->
name|width
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|JM_T_RAID01
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|total_disks
operator|/
literal|2
expr_stmt|;
break|break;
case|case
name|JM_T_RAID5
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID5
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|total_disks
expr_stmt|;
break|break;
case|case
name|JM_T_JBOD
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_SPAN
expr_stmt|;
name|raid
operator|->
name|width
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"JMicron unknown RAID type 0x%02x\n"
argument_list|,
name|meta
operator|->
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|jmicron_out
goto|;
block|}
name|disk_size
operator|=
operator|(
name|meta
operator|->
name|disk_sectors_high
operator|<<
literal|16
operator|)
operator|+
name|meta
operator|->
name|disk_sectors_low
expr_stmt|;
name|raid
operator|->
name|format
operator|=
name|AR_F_JMICRON_RAID
expr_stmt|;
name|strncpy
argument_list|(
name|raid
operator|->
name|name
argument_list|,
name|meta
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
literal|2
operator|<<
name|meta
operator|->
name|stripe_shift
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|total_disks
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|disk_size
operator|*
operator|(
name|raid
operator|->
name|width
operator|-
operator|(
name|raid
operator|->
name|type
operator|==
name|AR_RAID5
operator|)
operator|)
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
name|meta
operator|->
name|offset
operator|*
literal|16
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|raid
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|meta
operator|->
name|disks
index|[
name|disk
index|]
operator|==
name|meta
operator|->
name|disk_id
condition|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|disk_size
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_ONLINE
operator||
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
name|jmicron_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_jmicron_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
name|struct
name|jmicron_raid_conf
modifier|*
name|meta
decl_stmt|;
name|u_int64_t
name|disk_sectors
decl_stmt|;
name|int
name|disk
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|jmicron_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|jmicron_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"ar%d: failed to allocate metadata storage\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|rdp
operator|->
name|generation
operator|++
expr_stmt|;
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_JBOD
case|:
name|meta
operator|->
name|type
operator|=
name|JM_T_JBOD
expr_stmt|;
break|break;
case|case
name|AR_T_RAID0
case|:
name|meta
operator|->
name|type
operator|=
name|JM_T_RAID0
expr_stmt|;
break|break;
case|case
name|AR_T_RAID1
case|:
name|meta
operator|->
name|type
operator|=
name|JM_T_RAID1
expr_stmt|;
break|break;
case|case
name|AR_T_RAID5
case|:
name|meta
operator|->
name|type
operator|=
name|JM_T_RAID5
expr_stmt|;
break|break;
case|case
name|AR_T_RAID01
case|:
name|meta
operator|->
name|type
operator|=
name|JM_T_RAID01
expr_stmt|;
break|break;
default|default:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
name|bcopy
argument_list|(
name|JMICRON_MAGIC
argument_list|,
name|meta
operator|->
name|signature
argument_list|,
sizeof|sizeof
argument_list|(
name|JMICRON_MAGIC
argument_list|)
argument_list|)
expr_stmt|;
name|meta
operator|->
name|version
operator|=
name|JMICRON_VERSION
expr_stmt|;
name|meta
operator|->
name|offset
operator|=
name|rdp
operator|->
name|offset_sectors
operator|/
literal|16
expr_stmt|;
name|disk_sectors
operator|=
name|rdp
operator|->
name|total_sectors
operator|/
operator|(
name|rdp
operator|->
name|width
operator|-
operator|(
name|rdp
operator|->
name|type
operator|==
name|AR_RAID5
operator|)
operator|)
expr_stmt|;
name|meta
operator|->
name|disk_sectors_low
operator|=
name|disk_sectors
operator|&
literal|0xffff
expr_stmt|;
name|meta
operator|->
name|disk_sectors_high
operator|=
name|disk_sectors
operator|>>
literal|16
expr_stmt|;
name|strncpy
argument_list|(
name|meta
operator|->
name|name
argument_list|,
name|rdp
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|meta
operator|->
name|stripe_shift
operator|=
name|ffs
argument_list|(
name|rdp
operator|->
name|interleave
argument_list|)
operator|-
literal|2
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
index|[
literal|0
index|]
condition|)
name|bcopy
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
argument_list|,
operator|&
name|meta
operator|->
name|disks
index|[
name|disk
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|meta
operator|->
name|disks
index|[
name|disk
index|]
operator|=
operator|(
name|u_int32_t
operator|)
operator|(
name|uintptr_t
operator|)
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
expr_stmt|;
block|}
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
name|u_int16_t
name|checksum
init|=
literal|0
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|count
decl_stmt|;
name|meta
operator|->
name|disk_id
operator|=
name|meta
operator|->
name|disks
index|[
name|disk
index|]
expr_stmt|;
name|meta
operator|->
name|checksum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ptr
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|64
condition|;
name|count
operator|++
control|)
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|meta
operator|->
name|checksum
operator|-=
name|checksum
expr_stmt|;
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_jmicron_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
name|JMICRON_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|jmicron_raid_conf
argument_list|)
argument_list|,
name|ATA_R_WRITE
operator||
name|ATA_R_DIRECT
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
literal|"write metadata failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
block|}
block|}
block|}
comment|/* handle spares XXX SOS */
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/* LSILogic V2 MegaRAID Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_lsiv2_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|lsiv2_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|int
name|array
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|lsiv2_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|lsiv2_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|LSIV2_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|lsiv2_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"LSI (v2) read metadata failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|lsiv2_out
goto|;
block|}
comment|/* check if this is a LSI RAID struct */
if|if
condition|(
name|strncmp
argument_list|(
name|meta
operator|->
name|lsi_id
argument_list|,
name|LSIV2_MAGIC
argument_list|,
name|strlen
argument_list|(
name|LSIV2_MAGIC
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"LSI (v2) check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|lsiv2_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_lsiv2_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert LSI (v2) config meta into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
name|int
name|raid_entry
decl_stmt|,
name|conf_entry
decl_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
operator|+
name|meta
operator|->
name|raid_number
index|]
condition|)
block|{
name|raidp
index|[
name|array
operator|+
name|meta
operator|->
name|raid_number
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
operator|+
name|meta
operator|->
name|raid_number
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|lsiv2_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
operator|+
name|meta
operator|->
name|raid_number
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_LSIV2_RAID
operator|)
condition|)
continue|continue;
if|if
condition|(
name|raid
operator|->
name|magic_0
operator|&&
operator|(
operator|(
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|timestamp
operator|)
operator|||
operator|(
name|raid
operator|->
name|magic_1
operator|!=
name|meta
operator|->
name|raid_number
operator|)
operator|)
condition|)
continue|continue;
name|array
operator|+=
name|meta
operator|->
name|raid_number
expr_stmt|;
name|raid_entry
operator|=
name|meta
operator|->
name|raid_number
expr_stmt|;
name|conf_entry
operator|=
operator|(
name|meta
operator|->
name|configs
index|[
name|raid_entry
index|]
operator|.
name|raid
operator|.
name|config_offset
operator|>>
literal|4
operator|)
operator|+
name|meta
operator|->
name|disk_number
operator|-
literal|1
expr_stmt|;
switch|switch
condition|(
name|meta
operator|->
name|configs
index|[
name|raid_entry
index|]
operator|.
name|raid
operator|.
name|type
condition|)
block|{
case|case
name|LSIV2_T_RAID0
case|:
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|timestamp
expr_stmt|;
name|raid
operator|->
name|magic_1
operator|=
name|meta
operator|->
name|raid_number
expr_stmt|;
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
name|meta
operator|->
name|configs
index|[
name|raid_entry
index|]
operator|.
name|raid
operator|.
name|stripe_sectors
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|configs
index|[
name|raid_entry
index|]
operator|.
name|raid
operator|.
name|array_width
expr_stmt|;
break|break;
case|case
name|LSIV2_T_RAID1
case|:
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|timestamp
expr_stmt|;
name|raid
operator|->
name|magic_1
operator|=
name|meta
operator|->
name|raid_number
expr_stmt|;
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|configs
index|[
name|raid_entry
index|]
operator|.
name|raid
operator|.
name|array_width
expr_stmt|;
break|break;
case|case
name|LSIV2_T_RAID0
operator||
name|LSIV2_T_RAID1
case|:
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|timestamp
expr_stmt|;
name|raid
operator|->
name|magic_1
operator|=
name|meta
operator|->
name|raid_number
expr_stmt|;
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
name|meta
operator|->
name|configs
index|[
name|raid_entry
index|]
operator|.
name|raid
operator|.
name|stripe_sectors
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|configs
index|[
name|raid_entry
index|]
operator|.
name|raid
operator|.
name|array_width
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"LSI v2 unknown RAID type 0x%02x\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|raid_entry
index|]
operator|.
name|raid
operator|.
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|lsiv2_out
goto|;
block|}
name|raid
operator|->
name|format
operator|=
name|AR_F_LSIV2_RAID
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|meta
operator|->
name|configs
index|[
name|raid_entry
index|]
operator|.
name|raid
operator|.
name|disk_count
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|meta
operator|->
name|configs
index|[
name|raid_entry
index|]
operator|.
name|raid
operator|.
name|total_sectors
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|configs
index|[
name|conf_entry
index|]
operator|.
name|disk
operator|.
name|device
operator|!=
name|LSIV2_D_NONE
condition|)
block|{
name|raid
operator|->
name|disks
index|[
name|meta
operator|->
name|disk_number
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|meta
operator|->
name|disk_number
index|]
operator|.
name|sectors
operator|=
name|meta
operator|->
name|configs
index|[
name|conf_entry
index|]
operator|.
name|disk
operator|.
name|disk_sectors
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|meta
operator|->
name|disk_number
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_ONLINE
operator||
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|meta
operator|->
name|disk_number
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|raid
operator|->
name|disks
index|[
name|meta
operator|->
name|disk_number
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
break|break;
block|}
name|lsiv2_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/* LSILogic V3 MegaRAID Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_lsiv3_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|lsiv3_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|u_int8_t
name|checksum
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|array
decl_stmt|,
name|entry
decl_stmt|,
name|count
decl_stmt|,
name|disk_number
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|lsiv3_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|lsiv3_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|LSIV3_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|lsiv3_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"LSI (v3) read metadata failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|lsiv3_out
goto|;
block|}
comment|/* check if this is a LSI RAID struct */
if|if
condition|(
name|strncmp
argument_list|(
name|meta
operator|->
name|lsi_id
argument_list|,
name|LSIV3_MAGIC
argument_list|,
name|strlen
argument_list|(
name|LSIV3_MAGIC
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"LSI (v3) check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|lsiv3_out
goto|;
block|}
comment|/* check if the checksum is OK */
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
name|meta
operator|->
name|lsi_id
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|512
condition|;
name|count
operator|++
control|)
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"LSI (v3) check2 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|lsiv3_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_lsiv3_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert LSI (v3) config meta into our generic form */
for|for
control|(
name|array
operator|=
literal|0
operator|,
name|entry
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
operator|&&
name|entry
operator|<
literal|8
condition|;
control|)
block|{
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|lsiv3_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_LSIV3_RAID
operator|)
condition|)
block|{
name|array
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|raid
operator|->
name|format
operator|==
name|AR_F_LSIV3_RAID
operator|)
operator|&&
operator|(
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|timestamp
operator|)
condition|)
block|{
name|array
operator|++
expr_stmt|;
continue|continue;
block|}
switch|switch
condition|(
name|meta
operator|->
name|raid
index|[
name|entry
index|]
operator|.
name|total_disks
condition|)
block|{
case|case
literal|0
case|:
name|entry
operator|++
expr_stmt|;
continue|continue;
case|case
literal|1
case|:
if|if
condition|(
name|meta
operator|->
name|raid
index|[
name|entry
index|]
operator|.
name|device
operator|==
name|meta
operator|->
name|device
condition|)
block|{
name|disk_number
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|raid
operator|->
name|format
condition|)
name|array
operator|++
expr_stmt|;
name|entry
operator|++
expr_stmt|;
continue|continue;
case|case
literal|2
case|:
name|disk_number
operator|=
operator|(
name|meta
operator|->
name|device
operator|&
operator|(
name|LSIV3_D_DEVICE
operator||
name|LSIV3_D_CHANNEL
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"lsiv3> 2 disk support untested!!\n"
argument_list|)
expr_stmt|;
name|disk_number
operator|=
operator|(
name|meta
operator|->
name|device
operator|&
name|LSIV3_D_DEVICE
condition|?
literal|1
else|:
literal|0
operator|)
operator|+
operator|(
name|meta
operator|->
name|device
operator|&
name|LSIV3_D_CHANNEL
condition|?
literal|2
else|:
literal|0
operator|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|meta
operator|->
name|raid
index|[
name|entry
index|]
operator|.
name|type
condition|)
block|{
case|case
name|LSIV3_T_RAID0
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|raid
index|[
name|entry
index|]
operator|.
name|total_disks
expr_stmt|;
break|break;
case|case
name|LSIV3_T_RAID1
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|raid
index|[
name|entry
index|]
operator|.
name|array_width
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"LSI v3 unknown RAID type 0x%02x\n"
argument_list|,
name|meta
operator|->
name|raid
index|[
name|entry
index|]
operator|.
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
name|entry
operator|++
expr_stmt|;
continue|continue;
block|}
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|timestamp
expr_stmt|;
name|raid
operator|->
name|format
operator|=
name|AR_F_LSIV3_RAID
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
name|meta
operator|->
name|raid
index|[
name|entry
index|]
operator|.
name|stripe_pages
operator|*
literal|8
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|meta
operator|->
name|raid
index|[
name|entry
index|]
operator|.
name|total_disks
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|raid
operator|->
name|width
operator|*
name|meta
operator|->
name|raid
index|[
name|entry
index|]
operator|.
name|sectors
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
name|meta
operator|->
name|raid
index|[
name|entry
index|]
operator|.
name|offset
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|sectors
operator|=
name|raid
operator|->
name|total_sectors
operator|/
name|raid
operator|->
name|width
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_ONLINE
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk_number
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
name|entry
operator|++
expr_stmt|;
name|array
operator|++
expr_stmt|;
block|}
name|lsiv3_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/* nVidia MediaShield Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_nvidia_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|nvidia_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|u_int32_t
name|checksum
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|array
decl_stmt|,
name|count
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|nvidia_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|nvidia_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|NVIDIA_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nvidia_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"nVidia read metadata failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|nvidia_out
goto|;
block|}
comment|/* check if this is a nVidia RAID struct */
if|if
condition|(
name|strncmp
argument_list|(
name|meta
operator|->
name|nvidia_id
argument_list|,
name|NV_MAGIC
argument_list|,
name|strlen
argument_list|(
name|NV_MAGIC
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"nVidia check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|nvidia_out
goto|;
block|}
comment|/* check if the checksum is OK */
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
name|meta
operator|->
name|config_size
condition|;
name|count
operator|++
control|)
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"nVidia check2 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|nvidia_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_nvidia_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert nVidia meta into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|nvidia_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_NVIDIA_RAID
operator|)
condition|)
continue|continue;
if|if
condition|(
name|raid
operator|->
name|format
operator|==
name|AR_F_NVIDIA_RAID
operator|&&
operator|(
operator|(
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|magic_1
operator|)
operator|||
operator|(
name|raid
operator|->
name|magic_1
operator|!=
name|meta
operator|->
name|magic_2
operator|)
operator|)
condition|)
block|{
continue|continue;
block|}
switch|switch
condition|(
name|meta
operator|->
name|type
condition|)
block|{
case|case
name|NV_T_SPAN
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_SPAN
expr_stmt|;
break|break;
case|case
name|NV_T_RAID0
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
break|break;
case|case
name|NV_T_RAID1
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
break|break;
case|case
name|NV_T_RAID5
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID5
expr_stmt|;
break|break;
case|case
name|NV_T_RAID01
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"nVidia unknown RAID type 0x%02x\n"
argument_list|,
name|meta
operator|->
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|nvidia_out
goto|;
block|}
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|magic_1
expr_stmt|;
name|raid
operator|->
name|magic_1
operator|=
name|meta
operator|->
name|magic_2
expr_stmt|;
name|raid
operator|->
name|format
operator|=
name|AR_F_NVIDIA_RAID
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
name|meta
operator|->
name|stripe_sectors
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|array_width
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|meta
operator|->
name|total_disks
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|meta
operator|->
name|total_sectors
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
name|meta
operator|->
name|rebuild_lba
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
name|raid
operator|->
name|status
operator|=
name|AR_S_READY
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|status
operator|&
name|NV_S_DEGRADED
condition|)
name|raid
operator|->
name|status
operator||=
name|AR_S_DEGRADED
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|meta
operator|->
name|disk_number
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|meta
operator|->
name|disk_number
index|]
operator|.
name|sectors
operator|=
name|raid
operator|->
name|total_sectors
operator|/
name|raid
operator|->
name|width
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|meta
operator|->
name|disk_number
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_ONLINE
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|meta
operator|->
name|disk_number
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|nvidia_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/* Promise FastTrak Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_promise_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|,
name|int
name|native
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|promise_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
decl_stmt|;
name|u_int32_t
name|checksum
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|array
decl_stmt|,
name|count
decl_stmt|,
name|disk
decl_stmt|,
name|disksum
init|=
literal|0
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|promise_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|promise_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|PROMISE_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|promise_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"%s read metadata failed\n"
argument_list|,
name|native
condition|?
literal|"FreeBSD"
else|:
literal|"Promise"
argument_list|)
expr_stmt|;
goto|goto
name|promise_out
goto|;
block|}
comment|/* check the signature */
if|if
condition|(
name|native
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|meta
operator|->
name|promise_id
argument_list|,
name|ATA_MAGIC
argument_list|,
name|strlen
argument_list|(
name|ATA_MAGIC
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"FreeBSD check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|promise_out
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|meta
operator|->
name|promise_id
argument_list|,
name|PR_MAGIC
argument_list|,
name|strlen
argument_list|(
name|PR_MAGIC
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Promise check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|promise_out
goto|;
block|}
block|}
comment|/* check if the checksum is OK */
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|511
condition|;
name|count
operator|++
control|)
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|checksum
operator|!=
operator|*
name|ptr
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"%s check2 failed\n"
argument_list|,
name|native
condition|?
literal|"FreeBSD"
else|:
literal|"Promise"
argument_list|)
expr_stmt|;
goto|goto
name|promise_out
goto|;
block|}
comment|/* check on disk integrity status */
if|if
condition|(
name|meta
operator|->
name|raid
operator|.
name|integrity
operator|!=
name|PR_I_VALID
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"%s check3 failed\n"
argument_list|,
name|native
condition|?
literal|"FreeBSD"
else|:
literal|"Promise"
argument_list|)
expr_stmt|;
goto|goto
name|promise_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_promise_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert Promise metadata into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|promise_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
operator|(
name|native
condition|?
name|AR_F_FREEBSD_RAID
else|:
name|AR_F_PROMISE_RAID
operator|)
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|raid
operator|->
name|format
operator|==
operator|(
name|native
condition|?
name|AR_F_FREEBSD_RAID
else|:
name|AR_F_PROMISE_RAID
operator|)
operator|)
operator|&&
operator|!
operator|(
name|meta
operator|->
name|raid
operator|.
name|magic_1
operator|==
operator|(
name|raid
operator|->
name|magic_1
operator|)
operator|)
condition|)
continue|continue;
comment|/* update our knowledge about the array config based on generation */
if|if
condition|(
operator|!
name|meta
operator|->
name|raid
operator|.
name|generation
operator|||
name|meta
operator|->
name|raid
operator|.
name|generation
operator|>
name|raid
operator|->
name|generation
condition|)
block|{
switch|switch
condition|(
name|meta
operator|->
name|raid
operator|.
name|type
condition|)
block|{
case|case
name|PR_T_SPAN
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_SPAN
expr_stmt|;
break|break;
case|case
name|PR_T_JBOD
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_JBOD
expr_stmt|;
break|break;
case|case
name|PR_T_RAID0
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
break|break;
case|case
name|PR_T_RAID1
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|raid
operator|.
name|array_width
operator|>
literal|1
condition|)
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
break|break;
case|case
name|PR_T_RAID5
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID5
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"%s unknown RAID type 0x%02x\n"
argument_list|,
name|native
condition|?
literal|"FreeBSD"
else|:
literal|"Promise"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|promise_out
goto|;
block|}
name|raid
operator|->
name|magic_1
operator|=
name|meta
operator|->
name|raid
operator|.
name|magic_1
expr_stmt|;
name|raid
operator|->
name|format
operator|=
operator|(
name|native
condition|?
name|AR_F_FREEBSD_RAID
else|:
name|AR_F_PROMISE_RAID
operator|)
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
name|meta
operator|->
name|raid
operator|.
name|generation
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
literal|1
operator|<<
name|meta
operator|->
name|raid
operator|.
name|stripe_shift
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|raid
operator|.
name|array_width
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|meta
operator|->
name|raid
operator|.
name|total_disks
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
name|meta
operator|->
name|raid
operator|.
name|heads
operator|+
literal|1
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
name|meta
operator|->
name|raid
operator|.
name|sectors
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|meta
operator|->
name|raid
operator|.
name|cylinders
operator|+
literal|1
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|meta
operator|->
name|raid
operator|.
name|total_sectors
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
name|meta
operator|->
name|raid
operator|.
name|rebuild_lba
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
if|if
condition|(
operator|(
name|meta
operator|->
name|raid
operator|.
name|status
operator|&
operator|(
name|PR_S_VALID
operator||
name|PR_S_ONLINE
operator||
name|PR_S_INITED
operator||
name|PR_S_READY
operator|)
operator|)
operator|==
operator|(
name|PR_S_VALID
operator||
name|PR_S_ONLINE
operator||
name|PR_S_INITED
operator||
name|PR_S_READY
operator|)
condition|)
block|{
name|raid
operator|->
name|status
operator||=
name|AR_S_READY
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|raid
operator|.
name|status
operator|&
name|PR_S_DEGRADED
condition|)
name|raid
operator|->
name|status
operator||=
name|AR_S_DEGRADED
expr_stmt|;
block|}
else|else
name|raid
operator|->
name|status
operator|&=
operator|~
name|AR_S_READY
expr_stmt|;
comment|/* convert disk flags to our internal types */
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|meta
operator|->
name|raid
operator|.
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|=
name|NULL
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
operator|(
name|u_int64_t
operator|*
operator|)
operator|(
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
operator|)
operator|)
operator|=
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|disk
index|]
operator|.
name|magic_0
expr_stmt|;
name|disksum
operator|+=
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|disk
index|]
operator|.
name|flags
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|PR_F_ONLINE
condition|)
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|AR_DF_ONLINE
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|PR_F_ASSIGNED
condition|)
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|AR_DF_ASSIGNED
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|disk
index|]
operator|.
name|flags
operator|&
name|PR_F_SPARE
condition|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&=
operator|~
operator|(
name|AR_DF_ONLINE
operator||
name|AR_DF_ASSIGNED
operator|)
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator||=
name|AR_DF_SPARE
expr_stmt|;
block|}
if|if
condition|(
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|disk
index|]
operator|.
name|flags
operator|&
operator|(
name|PR_F_REDIR
operator||
name|PR_F_DOWN
operator|)
condition|)
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&=
operator|~
name|AR_DF_ONLINE
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|disksum
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"%s subdisks has no flags\n"
argument_list|,
name|native
condition|?
literal|"FreeBSD"
else|:
literal|"Promise"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|promise_out
goto|;
block|}
block|}
if|if
condition|(
name|meta
operator|->
name|raid
operator|.
name|generation
operator|>=
name|raid
operator|->
name|generation
condition|)
block|{
name|int
name|disk_number
init|=
name|meta
operator|->
name|raid
operator|.
name|disk_number
decl_stmt|;
if|if
condition|(
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator|&&
operator|(
name|meta
operator|->
name|magic_0
operator|==
operator|*
operator|(
operator|(
name|u_int64_t
operator|*
operator|)
operator|(
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|serial
operator|)
operator|)
operator|)
condition|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator||=
name|AR_DF_PRESENT
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|sectors
operator|=
name|meta
operator|->
name|raid
operator|.
name|disk_sectors
expr_stmt|;
if|if
condition|(
operator|(
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_ONLINE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator||
name|AR_DF_ONLINE
operator|)
condition|)
block|{
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk_number
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
break|break;
block|}
name|promise_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_promise_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
name|struct
name|promise_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|timeval
name|timestamp
decl_stmt|;
name|u_int32_t
modifier|*
name|ckptr
decl_stmt|;
name|int
name|count
decl_stmt|,
name|disk
decl_stmt|,
name|drive
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|promise_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|promise_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"ar%d: failed to allocate metadata storage\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|rdp
operator|->
name|generation
operator|++
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|timestamp
argument_list|)
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|promise_raid_conf
argument_list|)
condition|;
name|count
operator|++
control|)
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|meta
operator|)
operator|+
name|count
operator|)
operator|=
literal|255
operator|-
operator|(
name|count
operator|%
literal|256
operator|)
expr_stmt|;
name|meta
operator|->
name|dummy_0
operator|=
literal|0x00020000
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|disk_number
operator|=
name|disk
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|meta
operator|->
name|raid
operator|.
name|channel
operator|=
name|ch
operator|->
name|unit
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|device
operator|=
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|disk_sectors
operator|=
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|disk_offset
operator|=
name|rdp
operator|->
name|offset_sectors
expr_stmt|;
block|}
else|else
block|{
name|meta
operator|->
name|raid
operator|.
name|channel
operator|=
literal|0
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|disk_sectors
operator|=
literal|0
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|disk_offset
operator|=
literal|0
expr_stmt|;
block|}
name|meta
operator|->
name|magic_0
operator|=
name|PR_MAGIC0
argument_list|(
name|meta
operator|->
name|raid
argument_list|)
operator||
name|timestamp
operator|.
name|tv_sec
expr_stmt|;
name|meta
operator|->
name|magic_1
operator|=
name|timestamp
operator|.
name|tv_sec
operator|>>
literal|16
expr_stmt|;
name|meta
operator|->
name|magic_2
operator|=
name|timestamp
operator|.
name|tv_sec
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|integrity
operator|=
name|PR_I_VALID
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|magic_0
operator|=
name|meta
operator|->
name|magic_0
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|rebuild_lba
operator|=
name|rdp
operator|->
name|rebuild_lba
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|generation
operator|=
name|rdp
operator|->
name|generation
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_READY
condition|)
block|{
name|meta
operator|->
name|raid
operator|.
name|flags
operator|=
operator|(
name|PR_F_VALID
operator||
name|PR_F_ASSIGNED
operator||
name|PR_F_ONLINE
operator|)
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|status
operator|=
operator|(
name|PR_S_VALID
operator||
name|PR_S_ONLINE
operator||
name|PR_S_INITED
operator||
name|PR_S_READY
operator|)
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|status
operator|&
name|AR_S_DEGRADED
condition|)
name|meta
operator|->
name|raid
operator|.
name|status
operator||=
name|PR_S_DEGRADED
expr_stmt|;
else|else
name|meta
operator|->
name|raid
operator|.
name|status
operator||=
name|PR_S_FUNCTIONAL
expr_stmt|;
block|}
else|else
block|{
name|meta
operator|->
name|raid
operator|.
name|flags
operator|=
name|PR_F_DOWN
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|status
operator|=
literal|0
expr_stmt|;
block|}
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_RAID0
case|:
name|meta
operator|->
name|raid
operator|.
name|type
operator|=
name|PR_T_RAID0
expr_stmt|;
break|break;
case|case
name|AR_T_RAID1
case|:
name|meta
operator|->
name|raid
operator|.
name|type
operator|=
name|PR_T_RAID1
expr_stmt|;
break|break;
case|case
name|AR_T_RAID01
case|:
name|meta
operator|->
name|raid
operator|.
name|type
operator|=
name|PR_T_RAID1
expr_stmt|;
break|break;
case|case
name|AR_T_RAID5
case|:
name|meta
operator|->
name|raid
operator|.
name|type
operator|=
name|PR_T_RAID5
expr_stmt|;
break|break;
case|case
name|AR_T_SPAN
case|:
name|meta
operator|->
name|raid
operator|.
name|type
operator|=
name|PR_T_SPAN
expr_stmt|;
break|break;
case|case
name|AR_T_JBOD
case|:
name|meta
operator|->
name|raid
operator|.
name|type
operator|=
name|PR_T_JBOD
expr_stmt|;
break|break;
default|default:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
name|meta
operator|->
name|raid
operator|.
name|total_disks
operator|=
name|rdp
operator|->
name|total_disks
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|stripe_shift
operator|=
name|ffs
argument_list|(
name|rdp
operator|->
name|interleave
argument_list|)
operator|-
literal|1
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|array_width
operator|=
name|rdp
operator|->
name|width
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|array_number
operator|=
name|rdp
operator|->
name|lun
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|total_sectors
operator|=
name|rdp
operator|->
name|total_sectors
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|cylinders
operator|=
name|rdp
operator|->
name|cylinders
operator|-
literal|1
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|heads
operator|=
name|rdp
operator|->
name|heads
operator|-
literal|1
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|sectors
operator|=
name|rdp
operator|->
name|sectors
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|magic_1
operator|=
operator|(
name|u_int64_t
operator|)
name|meta
operator|->
name|magic_2
operator|<<
literal|16
operator||
name|meta
operator|->
name|magic_1
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|meta
operator|->
name|raid
operator|.
name|disk
argument_list|,
literal|8
operator|*
literal|12
argument_list|)
expr_stmt|;
for|for
control|(
name|drive
operator|=
literal|0
init|;
name|drive
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|drive
operator|++
control|)
block|{
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|drive
index|]
operator|.
name|flags
operator|&
name|AR_DF_PRESENT
condition|)
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
operator|.
name|flags
operator||=
name|PR_F_VALID
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|drive
index|]
operator|.
name|flags
operator|&
name|AR_DF_ASSIGNED
condition|)
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
operator|.
name|flags
operator||=
name|PR_F_ASSIGNED
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|drive
index|]
operator|.
name|flags
operator|&
name|AR_DF_ONLINE
condition|)
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
operator|.
name|flags
operator||=
name|PR_F_ONLINE
expr_stmt|;
elseif|else
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|drive
index|]
operator|.
name|flags
operator|&
name|AR_DF_PRESENT
condition|)
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
operator|.
name|flags
operator|=
operator|(
name|PR_F_REDIR
operator||
name|PR_F_DOWN
operator|)
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|drive
index|]
operator|.
name|flags
operator|&
name|AR_DF_SPARE
condition|)
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
operator|.
name|flags
operator||=
name|PR_F_SPARE
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
operator|.
name|dummy_0
operator|=
literal|0x0
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|drive
index|]
operator|.
name|dev
condition|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|drive
index|]
operator|.
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|drive
index|]
operator|.
name|dev
argument_list|)
decl_stmt|;
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
operator|.
name|channel
operator|=
name|ch
operator|->
name|unit
expr_stmt|;
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
operator|.
name|device
operator|=
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
operator|.
name|magic_0
operator|=
name|PR_MAGIC0
argument_list|(
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|drive
index|]
argument_list|)
operator||
name|timestamp
operator|.
name|tv_sec
expr_stmt|;
block|}
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
if|if
condition|(
operator|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|&
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
operator|)
operator|==
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
condition|)
block|{
if|if
condition|(
name|rdp
operator|->
name|format
operator|==
name|AR_F_FREEBSD_RAID
condition|)
name|bcopy
argument_list|(
name|ATA_MAGIC
argument_list|,
name|meta
operator|->
name|promise_id
argument_list|,
sizeof|sizeof
argument_list|(
name|ATA_MAGIC
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|bcopy
argument_list|(
name|PR_MAGIC
argument_list|,
name|meta
operator|->
name|promise_id
argument_list|,
sizeof|sizeof
argument_list|(
name|PR_MAGIC
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|bzero
argument_list|(
name|meta
operator|->
name|promise_id
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|promise_id
argument_list|)
argument_list|)
expr_stmt|;
name|meta
operator|->
name|checksum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ckptr
operator|=
operator|(
name|int32_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|511
condition|;
name|count
operator|++
control|)
name|meta
operator|->
name|checksum
operator|+=
operator|*
name|ckptr
operator|++
expr_stmt|;
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_promise_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
name|PROMISE_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|promise_raid_conf
argument_list|)
argument_list|,
name|ATA_R_WRITE
operator||
name|ATA_R_DIRECT
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
literal|"write metadata failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
block|}
block|}
block|}
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/* Silicon Image Medley Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_sii_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|sii_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|checksum
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|array
decl_stmt|,
name|count
decl_stmt|,
name|disk
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|sii_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sii_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|SII_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sii_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Silicon Image read metadata failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|sii_out
goto|;
block|}
comment|/* check if this is a Silicon Image (Medley) RAID struct */
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|160
condition|;
name|count
operator|++
control|)
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Silicon Image check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|sii_out
goto|;
block|}
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|256
condition|;
name|count
operator|++
control|)
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|checksum
operator|!=
name|meta
operator|->
name|checksum_1
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Silicon Image check2 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|sii_out
goto|;
block|}
comment|/* check verison */
if|if
condition|(
name|meta
operator|->
name|version_major
operator|!=
literal|0x0002
operator|||
operator|(
name|meta
operator|->
name|version_minor
operator|!=
literal|0x0000
operator|&&
name|meta
operator|->
name|version_minor
operator|!=
literal|0x0001
operator|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Silicon Image check3 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|sii_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_sii_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert Silicon Image meta into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|sii_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_SII_RAID
operator|)
condition|)
continue|continue;
if|if
condition|(
name|raid
operator|->
name|format
operator|==
name|AR_F_SII_RAID
operator|&&
operator|(
name|raid
operator|->
name|magic_0
operator|!=
operator|*
operator|(
operator|(
name|u_int64_t
operator|*
operator|)
name|meta
operator|->
name|timestamp
operator|)
operator|)
condition|)
block|{
continue|continue;
block|}
comment|/* update our knowledge about the array config based on generation */
if|if
condition|(
operator|!
name|meta
operator|->
name|generation
operator|||
name|meta
operator|->
name|generation
operator|>
name|raid
operator|->
name|generation
condition|)
block|{
switch|switch
condition|(
name|meta
operator|->
name|type
condition|)
block|{
case|case
name|SII_T_RAID0
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
break|break;
case|case
name|SII_T_RAID1
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
break|break;
case|case
name|SII_T_RAID01
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
break|break;
case|case
name|SII_T_SPARE
case|:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Silicon Image SPARE disk\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|sii_out
goto|;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Silicon Image unknown RAID type 0x%02x\n"
argument_list|,
name|meta
operator|->
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|sii_out
goto|;
block|}
name|raid
operator|->
name|magic_0
operator|=
operator|*
operator|(
operator|(
name|u_int64_t
operator|*
operator|)
name|meta
operator|->
name|timestamp
operator|)
expr_stmt|;
name|raid
operator|->
name|format
operator|=
name|AR_F_SII_RAID
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
name|meta
operator|->
name|generation
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
name|meta
operator|->
name|stripe_sectors
expr_stmt|;
name|raid
operator|->
name|width
operator|=
operator|(
name|meta
operator|->
name|raid0_disks
operator|!=
literal|0xff
operator|)
condition|?
name|meta
operator|->
name|raid0_disks
else|:
literal|1
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
operator|(
operator|(
name|meta
operator|->
name|raid0_disks
operator|!=
literal|0xff
operator|)
condition|?
name|meta
operator|->
name|raid0_disks
else|:
literal|0
operator|)
operator|+
operator|(
operator|(
name|meta
operator|->
name|raid1_disks
operator|!=
literal|0xff
operator|)
condition|?
name|meta
operator|->
name|raid1_disks
else|:
literal|0
operator|)
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|meta
operator|->
name|total_sectors
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
name|meta
operator|->
name|rebuild_lba
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
name|strncpy
argument_list|(
name|raid
operator|->
name|name
argument_list|,
name|meta
operator|->
name|name
argument_list|,
name|min
argument_list|(
sizeof|sizeof
argument_list|(
name|raid
operator|->
name|name
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|name
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* clear out any old info */
if|if
condition|(
name|raid
operator|->
name|generation
condition|)
block|{
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|raid
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|=
name|NULL
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|meta
operator|->
name|generation
operator|>=
name|raid
operator|->
name|generation
condition|)
block|{
comment|/* XXX SOS add check for the right physical disk by serial# */
if|if
condition|(
name|meta
operator|->
name|status
operator|&
name|SII_S_READY
condition|)
block|{
name|int
name|disk_number
init|=
operator|(
name|raid
operator|->
name|type
operator|==
name|AR_T_RAID01
operator|)
condition|?
name|meta
operator|->
name|raid1_ident
operator|+
operator|(
name|meta
operator|->
name|raid0_ident
operator|<<
literal|1
operator|)
else|:
name|meta
operator|->
name|disk_number
decl_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|sectors
operator|=
name|raid
operator|->
name|total_sectors
operator|/
name|raid
operator|->
name|width
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_ONLINE
operator||
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk_number
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
block|}
block|}
break|break;
block|}
name|sii_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/* Silicon Integrated Systems Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_sis_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|sis_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|int
name|array
decl_stmt|,
name|disk_number
decl_stmt|,
name|drive
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|sis_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sis_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|SIS_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sis_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Silicon Integrated Systems read metadata failed\n"
argument_list|)
expr_stmt|;
block|}
comment|/* check for SiS magic */
if|if
condition|(
name|meta
operator|->
name|magic
operator|!=
name|SIS_MAGIC
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Silicon Integrated Systems check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|sis_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_sis_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert SiS meta into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|sis_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_SIS_RAID
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|raid
operator|->
name|format
operator|==
name|AR_F_SIS_RAID
operator|)
operator|&&
operator|(
operator|(
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|controller_pci_id
operator|)
operator|||
operator|(
name|raid
operator|->
name|magic_1
operator|!=
name|meta
operator|->
name|timestamp
operator|)
operator|)
condition|)
block|{
continue|continue;
block|}
switch|switch
condition|(
name|meta
operator|->
name|type_total_disks
operator|&
name|SIS_T_MASK
condition|)
block|{
case|case
name|SIS_T_JBOD
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_JBOD
expr_stmt|;
name|raid
operator|->
name|width
operator|=
operator|(
name|meta
operator|->
name|type_total_disks
operator|&
name|SIS_D_MASK
operator|)
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|+=
name|SIS_LBA
argument_list|(
name|parent
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIS_T_RAID0
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
name|raid
operator|->
name|width
operator|=
operator|(
name|meta
operator|->
name|type_total_disks
operator|&
name|SIS_D_MASK
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|raid
operator|->
name|total_sectors
operator|||
operator|(
name|raid
operator|->
name|total_sectors
operator|>
operator|(
name|raid
operator|->
name|width
operator|*
name|SIS_LBA
argument_list|(
name|parent
argument_list|)
operator|)
operator|)
condition|)
name|raid
operator|->
name|total_sectors
operator|=
name|raid
operator|->
name|width
operator|*
name|SIS_LBA
argument_list|(
name|parent
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIS_T_RAID1
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
name|raid
operator|->
name|width
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|raid
operator|->
name|total_sectors
operator|||
operator|(
name|raid
operator|->
name|total_sectors
operator|>
name|SIS_LBA
argument_list|(
name|parent
argument_list|)
operator|)
condition|)
name|raid
operator|->
name|total_sectors
operator|=
name|SIS_LBA
argument_list|(
name|parent
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"Silicon Integrated Systems "
literal|"unknown RAID type 0x%08x\n"
argument_list|,
name|meta
operator|->
name|magic
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|sis_out
goto|;
block|}
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|controller_pci_id
expr_stmt|;
name|raid
operator|->
name|magic_1
operator|=
name|meta
operator|->
name|timestamp
expr_stmt|;
name|raid
operator|->
name|format
operator|=
name|AR_F_SIS_RAID
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
name|meta
operator|->
name|stripe_sectors
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
operator|(
name|meta
operator|->
name|type_total_disks
operator|&
name|SIS_D_MASK
operator|)
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
comment|/* XXX SOS if total_disks> 2 this doesn't float */
if|if
condition|(
operator|(
operator|(
name|meta
operator|->
name|disks
operator|&
name|SIS_D_MASTER
operator|)
operator|>>
literal|4
operator|)
operator|==
name|meta
operator|->
name|disk_number
condition|)
name|disk_number
operator|=
literal|0
expr_stmt|;
else|else
name|disk_number
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|drive
operator|=
literal|0
init|;
name|drive
operator|<
name|raid
operator|->
name|total_disks
condition|;
name|drive
operator|++
control|)
block|{
name|raid
operator|->
name|disks
index|[
name|drive
index|]
operator|.
name|sectors
operator|=
name|raid
operator|->
name|total_sectors
operator|/
name|raid
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|drive
operator|==
name|disk_number
condition|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk_number
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_ONLINE
operator||
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk_number
expr_stmt|;
block|}
block|}
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|sis_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_sis_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
name|struct
name|sis_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|timeval
name|timestamp
decl_stmt|;
name|int
name|disk
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|sis_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sis_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"ar%d: failed to allocate metadata storage\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|rdp
operator|->
name|generation
operator|++
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|timestamp
argument_list|)
expr_stmt|;
name|meta
operator|->
name|magic
operator|=
name|SIS_MAGIC
expr_stmt|;
comment|/* XXX SOS if total_disks> 2 this doesn't float */
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
decl_stmt|;
name|int
name|disk_number
init|=
literal|1
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
decl_stmt|;
name|meta
operator|->
name|disks
operator||=
name|disk_number
operator|<<
operator|(
operator|(
literal|1
operator|-
name|disk
operator|)
operator|<<
literal|2
operator|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_JBOD
case|:
name|meta
operator|->
name|type_total_disks
operator|=
name|SIS_T_JBOD
expr_stmt|;
break|break;
case|case
name|AR_T_RAID0
case|:
name|meta
operator|->
name|type_total_disks
operator|=
name|SIS_T_RAID0
expr_stmt|;
break|break;
case|case
name|AR_T_RAID1
case|:
name|meta
operator|->
name|type_total_disks
operator|=
name|SIS_T_RAID1
expr_stmt|;
break|break;
default|default:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
name|meta
operator|->
name|type_total_disks
operator||=
operator|(
name|rdp
operator|->
name|total_disks
operator|&
name|SIS_D_MASK
operator|)
expr_stmt|;
name|meta
operator|->
name|stripe_sectors
operator|=
name|rdp
operator|->
name|interleave
expr_stmt|;
name|meta
operator|->
name|timestamp
operator|=
name|timestamp
operator|.
name|tv_sec
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
decl_stmt|;
name|meta
operator|->
name|controller_pci_id
operator|=
operator|(
name|pci_get_vendor
argument_list|(
name|GRANDPARENT
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|pci_get_device
argument_list|(
name|GRANDPARENT
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|atadev
operator|->
name|param
operator|.
name|model
argument_list|,
name|meta
operator|->
name|model
argument_list|,
sizeof|sizeof
argument_list|(
name|meta
operator|->
name|model
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX SOS if total_disks> 2 this may not float */
name|meta
operator|->
name|disk_number
operator|=
literal|1
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_sis_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
name|SIS_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sis_raid_conf
argument_list|)
argument_list|,
name|ATA_R_WRITE
operator||
name|ATA_R_DIRECT
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
literal|"write metadata failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
block|}
block|}
block|}
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/* VIA Tech V-RAID Metadata */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_via_read_meta
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ar_softc
modifier|*
modifier|*
name|raidp
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|via_raid_conf
modifier|*
name|meta
decl_stmt|;
name|struct
name|ar_softc
modifier|*
name|raid
init|=
name|NULL
decl_stmt|;
name|u_int8_t
name|checksum
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|array
decl_stmt|,
name|count
decl_stmt|,
name|disk
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|via_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|via_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|parent
argument_list|,
name|VIA_LBA
argument_list|(
name|parent
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|via_raid_conf
argument_list|)
argument_list|,
name|ATA_R_READ
argument_list|)
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"VIA read metadata failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|via_out
goto|;
block|}
comment|/* check if this is a VIA RAID struct */
if|if
condition|(
name|meta
operator|->
name|magic
operator|!=
name|VIA_MAGIC
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"VIA check1 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|via_out
goto|;
block|}
comment|/* calculate checksum and compare for valid */
for|for
control|(
name|checksum
operator|=
literal|0
operator|,
name|ptr
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|50
condition|;
name|count
operator|++
control|)
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|checksum
operator|!=
name|meta
operator|->
name|checksum
condition|)
block|{
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"VIA check2 failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|via_out
goto|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_via_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
comment|/* now convert VIA meta into our generic form */
for|for
control|(
name|array
operator|=
literal|0
init|;
name|array
operator|<
name|MAX_ARRAYS
condition|;
name|array
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|raidp
index|[
name|array
index|]
operator|=
operator|(
expr|struct
name|ar_softc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ar_softc
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|raidp
index|[
name|array
index|]
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"failed to allocate metadata storage\n"
argument_list|)
expr_stmt|;
goto|goto
name|via_out
goto|;
block|}
block|}
name|raid
operator|=
name|raidp
index|[
name|array
index|]
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|format
operator|&&
operator|(
name|raid
operator|->
name|format
operator|!=
name|AR_F_VIA_RAID
operator|)
condition|)
continue|continue;
if|if
condition|(
name|raid
operator|->
name|format
operator|==
name|AR_F_VIA_RAID
operator|&&
operator|(
name|raid
operator|->
name|magic_0
operator|!=
name|meta
operator|->
name|disks
index|[
literal|0
index|]
operator|)
condition|)
continue|continue;
switch|switch
condition|(
name|meta
operator|->
name|type
operator|&
name|VIA_T_MASK
condition|)
block|{
case|case
name|VIA_T_RAID0
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID0
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|stripe_layout
operator|&
name|VIA_L_DISKS
expr_stmt|;
if|if
condition|(
operator|!
name|raid
operator|->
name|total_sectors
operator|||
operator|(
name|raid
operator|->
name|total_sectors
operator|>
operator|(
name|raid
operator|->
name|width
operator|*
name|meta
operator|->
name|disk_sectors
operator|)
operator|)
condition|)
name|raid
operator|->
name|total_sectors
operator|=
name|raid
operator|->
name|width
operator|*
name|meta
operator|->
name|disk_sectors
expr_stmt|;
break|break;
case|case
name|VIA_T_RAID1
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID1
expr_stmt|;
name|raid
operator|->
name|width
operator|=
literal|1
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|=
name|meta
operator|->
name|disk_sectors
expr_stmt|;
break|break;
case|case
name|VIA_T_RAID01
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID01
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|stripe_layout
operator|&
name|VIA_L_DISKS
expr_stmt|;
if|if
condition|(
operator|!
name|raid
operator|->
name|total_sectors
operator|||
operator|(
name|raid
operator|->
name|total_sectors
operator|>
operator|(
name|raid
operator|->
name|width
operator|*
name|meta
operator|->
name|disk_sectors
operator|)
operator|)
condition|)
name|raid
operator|->
name|total_sectors
operator|=
name|raid
operator|->
name|width
operator|*
name|meta
operator|->
name|disk_sectors
expr_stmt|;
break|break;
case|case
name|VIA_T_RAID5
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_RAID5
expr_stmt|;
name|raid
operator|->
name|width
operator|=
name|meta
operator|->
name|stripe_layout
operator|&
name|VIA_L_DISKS
expr_stmt|;
if|if
condition|(
operator|!
name|raid
operator|->
name|total_sectors
operator|||
operator|(
name|raid
operator|->
name|total_sectors
operator|>
operator|(
operator|(
name|raid
operator|->
name|width
operator|-
literal|1
operator|)
operator|*
name|meta
operator|->
name|disk_sectors
operator|)
operator|)
condition|)
name|raid
operator|->
name|total_sectors
operator|=
operator|(
name|raid
operator|->
name|width
operator|-
literal|1
operator|)
operator|*
name|meta
operator|->
name|disk_sectors
expr_stmt|;
break|break;
case|case
name|VIA_T_SPAN
case|:
name|raid
operator|->
name|type
operator|=
name|AR_T_SPAN
expr_stmt|;
name|raid
operator|->
name|width
operator|=
literal|1
expr_stmt|;
name|raid
operator|->
name|total_sectors
operator|+=
name|meta
operator|->
name|disk_sectors
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"VIA unknown RAID type 0x%02x\n"
argument_list|,
name|meta
operator|->
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raidp
index|[
name|array
index|]
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
name|raidp
index|[
name|array
index|]
operator|=
name|NULL
expr_stmt|;
goto|goto
name|via_out
goto|;
block|}
name|raid
operator|->
name|magic_0
operator|=
name|meta
operator|->
name|disks
index|[
literal|0
index|]
expr_stmt|;
name|raid
operator|->
name|format
operator|=
name|AR_F_VIA_RAID
expr_stmt|;
name|raid
operator|->
name|generation
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|interleave
operator|=
literal|0x08
operator|<<
operator|(
operator|(
name|meta
operator|->
name|stripe_layout
operator|&
name|VIA_L_MASK
operator|)
operator|>>
name|VIA_L_SHIFT
operator|)
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
operator|,
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
literal|8
condition|;
name|disk
operator|++
control|)
if|if
condition|(
name|meta
operator|->
name|disks
index|[
name|disk
index|]
condition|)
name|count
operator|++
expr_stmt|;
name|raid
operator|->
name|total_disks
operator|=
name|count
expr_stmt|;
name|raid
operator|->
name|heads
operator|=
literal|255
expr_stmt|;
name|raid
operator|->
name|sectors
operator|=
literal|63
expr_stmt|;
name|raid
operator|->
name|cylinders
operator|=
name|raid
operator|->
name|total_sectors
operator|/
operator|(
literal|63
operator|*
literal|255
operator|)
expr_stmt|;
name|raid
operator|->
name|offset_sectors
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|rebuild_lba
operator|=
literal|0
expr_stmt|;
name|raid
operator|->
name|lun
operator|=
name|array
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|raid
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|meta
operator|->
name|disks
index|[
name|disk
index|]
operator|==
name|meta
operator|->
name|disk_id
condition|)
block|{
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
operator|=
name|parent
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|meta
operator|->
name|disk_id
argument_list|,
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|serial
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|sectors
operator|=
name|meta
operator|->
name|disk_sectors
expr_stmt|;
name|raid
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|flags
operator|=
operator|(
name|AR_DF_ONLINE
operator||
name|AR_DF_PRESENT
operator||
name|AR_DF_ASSIGNED
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|raid
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|raid
operator|->
name|volume
index|]
operator|=
name|disk
expr_stmt|;
name|retval
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
name|via_out
label|:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_via_write_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
name|struct
name|via_raid_conf
modifier|*
name|meta
decl_stmt|;
name|int
name|disk
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|meta
operator|=
operator|(
expr|struct
name|via_raid_conf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|via_raid_conf
argument_list|)
argument_list|,
name|M_AR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"ar%d: failed to allocate metadata storage\n"
argument_list|,
name|rdp
operator|->
name|lun
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|rdp
operator|->
name|generation
operator|++
expr_stmt|;
name|meta
operator|->
name|magic
operator|=
name|VIA_MAGIC
expr_stmt|;
name|meta
operator|->
name|dummy_0
operator|=
literal|0x02
expr_stmt|;
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_SPAN
case|:
name|meta
operator|->
name|type
operator|=
name|VIA_T_SPAN
expr_stmt|;
name|meta
operator|->
name|stripe_layout
operator|=
operator|(
name|rdp
operator|->
name|total_disks
operator|&
name|VIA_L_DISKS
operator|)
expr_stmt|;
break|break;
case|case
name|AR_T_RAID0
case|:
name|meta
operator|->
name|type
operator|=
name|VIA_T_RAID0
expr_stmt|;
name|meta
operator|->
name|stripe_layout
operator|=
operator|(
operator|(
name|rdp
operator|->
name|interleave
operator|>>
literal|1
operator|)
operator|&
name|VIA_L_MASK
operator|)
expr_stmt|;
name|meta
operator|->
name|stripe_layout
operator||=
operator|(
name|rdp
operator|->
name|total_disks
operator|&
name|VIA_L_DISKS
operator|)
expr_stmt|;
break|break;
case|case
name|AR_T_RAID1
case|:
name|meta
operator|->
name|type
operator|=
name|VIA_T_RAID1
expr_stmt|;
name|meta
operator|->
name|stripe_layout
operator|=
operator|(
name|rdp
operator|->
name|total_disks
operator|&
name|VIA_L_DISKS
operator|)
expr_stmt|;
break|break;
case|case
name|AR_T_RAID5
case|:
name|meta
operator|->
name|type
operator|=
name|VIA_T_RAID5
expr_stmt|;
name|meta
operator|->
name|stripe_layout
operator|=
operator|(
operator|(
name|rdp
operator|->
name|interleave
operator|>>
literal|1
operator|)
operator|&
name|VIA_L_MASK
operator|)
expr_stmt|;
name|meta
operator|->
name|stripe_layout
operator||=
operator|(
name|rdp
operator|->
name|total_disks
operator|&
name|VIA_L_DISKS
operator|)
expr_stmt|;
break|break;
case|case
name|AR_T_RAID01
case|:
name|meta
operator|->
name|type
operator|=
name|VIA_T_RAID01
expr_stmt|;
name|meta
operator|->
name|stripe_layout
operator|=
operator|(
operator|(
name|rdp
operator|->
name|interleave
operator|>>
literal|1
operator|)
operator|&
name|VIA_L_MASK
operator|)
expr_stmt|;
name|meta
operator|->
name|stripe_layout
operator||=
operator|(
name|rdp
operator|->
name|width
operator|&
name|VIA_L_DISKS
operator|)
expr_stmt|;
break|break;
default|default:
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
name|meta
operator|->
name|type
operator||=
name|VIA_T_BOOTABLE
expr_stmt|;
comment|/* XXX SOS */
name|meta
operator|->
name|disk_sectors
operator|=
name|rdp
operator|->
name|total_sectors
operator|/
operator|(
name|rdp
operator|->
name|width
operator|-
operator|(
name|rdp
operator|->
name|type
operator|==
name|AR_RAID5
operator|)
operator|)
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
name|meta
operator|->
name|disks
index|[
name|disk
index|]
operator|=
operator|(
name|u_int32_t
operator|)
operator|(
name|uintptr_t
operator|)
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
expr_stmt|;
for|for
control|(
name|disk
operator|=
literal|0
init|;
name|disk
operator|<
name|rdp
operator|->
name|total_disks
condition|;
name|disk
operator|++
control|)
block|{
if|if
condition|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
condition|)
block|{
name|u_int8_t
modifier|*
name|ptr
decl_stmt|;
name|int
name|count
decl_stmt|;
name|meta
operator|->
name|disk_index
operator|=
name|disk
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|type
operator|==
name|AR_T_RAID01
condition|)
name|meta
operator|->
name|disk_index
operator|=
operator|(
operator|(
name|meta
operator|->
name|disk_index
operator|&
literal|0x08
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
name|meta
operator|->
name|disk_index
operator|&
operator|~
literal|0x08
operator|)
expr_stmt|;
name|meta
operator|->
name|disk_id
operator|=
name|meta
operator|->
name|disks
index|[
name|disk
index|]
expr_stmt|;
name|meta
operator|->
name|checksum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ptr
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
name|meta
operator|,
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|50
condition|;
name|count
operator|++
control|)
name|meta
operator|->
name|checksum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_via_print_meta
argument_list|(
name|meta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ata_raid_rw
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
name|VIA_LBA
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|)
argument_list|,
name|meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|via_raid_conf
argument_list|)
argument_list|,
name|ATA_R_WRITE
operator||
name|ATA_R_DIRECT
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|rdp
operator|->
name|disks
index|[
name|disk
index|]
operator|.
name|dev
argument_list|,
literal|"write metadata failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
block|}
block|}
block|}
name|free
argument_list|(
name|meta
argument_list|,
name|M_AR
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ata_request
modifier|*
name|ata_raid_init_request
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|,
name|struct
name|bio
modifier|*
name|bio
parameter_list|)
block|{
name|struct
name|ata_request
modifier|*
name|request
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|request
operator|=
name|ata_alloc_request
argument_list|()
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"FAILURE - out of memory in ata_raid_init_request\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|request
operator|->
name|timeout
operator|=
literal|5
expr_stmt|;
name|request
operator|->
name|retries
operator|=
literal|2
expr_stmt|;
name|request
operator|->
name|callback
operator|=
name|ata_raid_done
expr_stmt|;
name|request
operator|->
name|driver
operator|=
name|rdp
expr_stmt|;
name|request
operator|->
name|bio
operator|=
name|bio
expr_stmt|;
switch|switch
condition|(
name|request
operator|->
name|bio
operator|->
name|bio_cmd
condition|)
block|{
case|case
name|BIO_READ
case|:
name|request
operator|->
name|flags
operator|=
name|ATA_R_READ
expr_stmt|;
break|break;
case|case
name|BIO_WRITE
case|:
name|request
operator|->
name|flags
operator|=
name|ATA_R_WRITE
expr_stmt|;
break|break;
case|case
name|BIO_FLUSH
case|:
name|request
operator|->
name|flags
operator|=
name|ATA_R_CONTROL
expr_stmt|;
break|break;
block|}
return|return
name|request
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_send_request
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|dev
argument_list|)
decl_stmt|;
name|request
operator|->
name|transfersize
operator|=
name|min
argument_list|(
name|request
operator|->
name|bytecount
argument_list|,
name|atadev
operator|->
name|max_iosize
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|)
block|{
if|if
condition|(
name|atadev
operator|->
name|mode
operator|>=
name|ATA_DMA
condition|)
block|{
name|request
operator|->
name|flags
operator||=
name|ATA_R_DMA
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_READ_DMA
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|atadev
operator|->
name|max_iosize
operator|>
name|DEV_BSIZE
condition|)
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_READ_MUL
expr_stmt|;
else|else
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_READ
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_WRITE
condition|)
block|{
if|if
condition|(
name|atadev
operator|->
name|mode
operator|>=
name|ATA_DMA
condition|)
block|{
name|request
operator|->
name|flags
operator||=
name|ATA_R_DMA
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_WRITE_DMA
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|atadev
operator|->
name|max_iosize
operator|>
name|DEV_BSIZE
condition|)
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_WRITE_MUL
expr_stmt|;
else|else
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_WRITE
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|request
operator|->
name|dev
argument_list|,
literal|"FAILURE - unknown IO operation\n"
argument_list|)
expr_stmt|;
name|ata_free_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
return|return
name|EIO
return|;
block|}
name|request
operator|->
name|flags
operator||=
operator|(
name|ATA_R_ORDERED
operator||
name|ATA_R_THREAD
operator|)
expr_stmt|;
name|ata_queue_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_rw
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_int64_t
name|lba
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int
name|bcount
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|ata_device
modifier|*
name|atadev
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_request
modifier|*
name|request
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|bcount
operator|%
name|DEV_BSIZE
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"FAILURE - transfers must be modulo sectorsize\n"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|request
operator|=
name|ata_alloc_request
argument_list|()
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"FAILURE - out of memory in ata_raid_rw\n"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
comment|/* setup request */
name|request
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|request
operator|->
name|timeout
operator|=
literal|10
expr_stmt|;
name|request
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
name|request
operator|->
name|data
operator|=
name|data
expr_stmt|;
name|request
operator|->
name|bytecount
operator|=
name|bcount
expr_stmt|;
name|request
operator|->
name|transfersize
operator|=
name|DEV_BSIZE
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|=
name|lba
expr_stmt|;
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
operator|=
name|request
operator|->
name|bytecount
operator|/
name|DEV_BSIZE
expr_stmt|;
name|request
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|ATA_R_READ
condition|)
block|{
if|if
condition|(
name|atadev
operator|->
name|mode
operator|>=
name|ATA_DMA
condition|)
block|{
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_READ_DMA
expr_stmt|;
name|request
operator|->
name|flags
operator||=
name|ATA_R_DMA
expr_stmt|;
block|}
else|else
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_READ
expr_stmt|;
name|ata_queue_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flags
operator|&
name|ATA_R_WRITE
condition|)
block|{
if|if
condition|(
name|atadev
operator|->
name|mode
operator|>=
name|ATA_DMA
condition|)
block|{
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_WRITE_DMA
expr_stmt|;
name|request
operator|->
name|flags
operator||=
name|ATA_R_DMA
expr_stmt|;
block|}
else|else
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|=
name|ATA_WRITE
expr_stmt|;
name|ata_queue_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"FAILURE - unknown IO operation\n"
argument_list|)
expr_stmt|;
name|request
operator|->
name|result
operator|=
name|EIO
expr_stmt|;
block|}
name|error
operator|=
name|request
operator|->
name|result
expr_stmt|;
name|ata_free_request
argument_list|(
name|request
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * module handeling  */
end_comment

begin_function
specifier|static
name|int
name|ata_raid_subdisk_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_quiet
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_subdisk_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|volume
decl_stmt|;
for|for
control|(
name|volume
operator|=
literal|0
init|;
name|volume
operator|<
name|MAX_VOLUMES
condition|;
name|volume
operator|++
control|)
block|{
name|ars
operator|->
name|raid
index|[
name|volume
index|]
operator|=
name|NULL
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|volume
index|]
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|ata_raid_read_metadata
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_raid_subdisk_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_raid_subdisk
modifier|*
name|ars
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|volume
decl_stmt|;
for|for
control|(
name|volume
operator|=
literal|0
init|;
name|volume
operator|<
name|MAX_VOLUMES
condition|;
name|volume
operator|++
control|)
block|{
if|if
condition|(
name|ars
operator|->
name|raid
index|[
name|volume
index|]
condition|)
block|{
name|ars
operator|->
name|raid
index|[
name|volume
index|]
operator|->
name|disks
index|[
name|ars
operator|->
name|disk_number
index|[
name|volume
index|]
index|]
operator|.
name|flags
operator|&=
operator|~
operator|(
name|AR_DF_PRESENT
operator||
name|AR_DF_ONLINE
operator|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|volume
index|]
operator|->
name|disks
index|[
name|ars
operator|->
name|disk_number
index|[
name|volume
index|]
index|]
operator|.
name|dev
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|mtx_initialized
argument_list|(
operator|&
name|ars
operator|->
name|raid
index|[
name|volume
index|]
operator|->
name|lock
argument_list|)
condition|)
name|ata_raid_config_changed
argument_list|(
name|ars
operator|->
name|raid
index|[
name|volume
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ars
operator|->
name|raid
index|[
name|volume
index|]
operator|=
name|NULL
expr_stmt|;
name|ars
operator|->
name|disk_number
index|[
name|volume
index|]
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|ata_raid_sub_methods
index|[]
init|=
block|{
comment|/* device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ata_raid_subdisk_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ata_raid_subdisk_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ata_raid_subdisk_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ata_raid_sub_driver
init|=
block|{
literal|"subdisk"
block|,
name|ata_raid_sub_methods
block|,
expr|sizeof
operator|(
expr|struct
name|ata_raid_subdisk
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|subdisk
argument_list|,
name|ad
argument_list|,
name|ata_raid_sub_driver
argument_list|,
name|ata_raid_sub_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|ata_raid_module_event_handler
parameter_list|(
name|module_t
name|mod
parameter_list|,
name|int
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|what
condition|)
block|{
case|case
name|MOD_LOAD
case|:
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"ATA PseudoRAID loaded\n"
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* setup table to hold metadata for all ATA PseudoRAID arrays */
block|ata_raid_arrays = malloc(sizeof(struct ar_soft *) * MAX_ARRAYS, 				M_AR, M_NOWAIT | M_ZERO); 	if (!ata_raid_arrays) { 	    printf("ataraid: no memory for metadata storage\n"); 	    return ENOMEM; 	}
endif|#
directive|endif
comment|/* attach found PseudoRAID arrays */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_ARRAYS
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ar_softc
modifier|*
name|rdp
init|=
name|ata_raid_arrays
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|rdp
operator|||
operator|!
name|rdp
operator|->
name|format
condition|)
continue|continue;
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|ata_raid_print_meta
argument_list|(
name|rdp
argument_list|)
expr_stmt|;
name|ata_raid_attach
argument_list|(
name|rdp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|ata_raid_ioctl_func
operator|=
name|ata_raid_ioctl
expr_stmt|;
return|return
literal|0
return|;
case|case
name|MOD_UNLOAD
case|:
comment|/* detach found PseudoRAID arrays */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_ARRAYS
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ar_softc
modifier|*
name|rdp
init|=
name|ata_raid_arrays
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|rdp
operator|||
operator|!
name|rdp
operator|->
name|status
condition|)
continue|continue;
if|if
condition|(
name|mtx_initialized
argument_list|(
operator|&
name|rdp
operator|->
name|lock
argument_list|)
condition|)
name|mtx_destroy
argument_list|(
operator|&
name|rdp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdp
operator|->
name|disk
condition|)
name|disk_destroy
argument_list|(
name|rdp
operator|->
name|disk
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|testing
operator|||
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"ATA PseudoRAID unloaded\n"
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|free(ata_raid_arrays, M_AR);
endif|#
directive|endif
name|ata_raid_ioctl_func
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
name|EOPNOTSUPP
return|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|moduledata_t
name|ata_raid_moduledata
init|=
block|{
literal|"ataraid"
block|,
name|ata_raid_module_event_handler
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DECLARE_MODULE
argument_list|(
name|ata
argument_list|,
name|ata_raid_moduledata
argument_list|,
name|SI_SUB_RAID
argument_list|,
name|SI_ORDER_FIRST
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|ataraid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ataraid
argument_list|,
name|ata
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ataraid
argument_list|,
name|ad
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_format
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
switch|switch
condition|(
name|rdp
operator|->
name|format
condition|)
block|{
case|case
name|AR_F_FREEBSD_RAID
case|:
return|return
literal|"FreeBSD PseudoRAID"
return|;
case|case
name|AR_F_ADAPTEC_RAID
case|:
return|return
literal|"Adaptec HostRAID"
return|;
case|case
name|AR_F_HPTV2_RAID
case|:
return|return
literal|"HighPoint v2 RocketRAID"
return|;
case|case
name|AR_F_HPTV3_RAID
case|:
return|return
literal|"HighPoint v3 RocketRAID"
return|;
case|case
name|AR_F_INTEL_RAID
case|:
return|return
literal|"Intel MatrixRAID"
return|;
case|case
name|AR_F_ITE_RAID
case|:
return|return
literal|"Integrated Technology Express"
return|;
case|case
name|AR_F_JMICRON_RAID
case|:
return|return
literal|"JMicron Technology Corp"
return|;
case|case
name|AR_F_LSIV2_RAID
case|:
return|return
literal|"LSILogic v2 MegaRAID"
return|;
case|case
name|AR_F_LSIV3_RAID
case|:
return|return
literal|"LSILogic v3 MegaRAID"
return|;
case|case
name|AR_F_NVIDIA_RAID
case|:
return|return
literal|"nVidia MediaShield"
return|;
case|case
name|AR_F_PROMISE_RAID
case|:
return|return
literal|"Promise Fasttrak"
return|;
case|case
name|AR_F_SII_RAID
case|:
return|return
literal|"Silicon Image Medley"
return|;
case|case
name|AR_F_SIS_RAID
case|:
return|return
literal|"Silicon Integrated Systems"
return|;
case|case
name|AR_F_VIA_RAID
case|:
return|return
literal|"VIA Tech V-RAID"
return|;
default|default:
return|return
literal|"UNKNOWN"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_type
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
switch|switch
condition|(
name|rdp
operator|->
name|type
condition|)
block|{
case|case
name|AR_T_JBOD
case|:
return|return
literal|"JBOD"
return|;
case|case
name|AR_T_SPAN
case|:
return|return
literal|"SPAN"
return|;
case|case
name|AR_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|AR_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|AR_T_RAID3
case|:
return|return
literal|"RAID3"
return|;
case|case
name|AR_T_RAID4
case|:
return|return
literal|"RAID4"
return|;
case|case
name|AR_T_RAID5
case|:
return|return
literal|"RAID5"
return|;
case|case
name|AR_T_RAID01
case|:
return|return
literal|"RAID0+1"
return|;
default|default:
return|return
literal|"UNKNOWN"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_flags
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|rdp
parameter_list|)
block|{
switch|switch
condition|(
name|rdp
operator|->
name|status
operator|&
operator|(
name|AR_S_READY
operator||
name|AR_S_DEGRADED
operator||
name|AR_S_REBUILDING
operator|)
condition|)
block|{
case|case
name|AR_S_READY
case|:
return|return
literal|"READY"
return|;
case|case
name|AR_S_READY
operator||
name|AR_S_DEGRADED
case|:
return|return
literal|"DEGRADED"
return|;
case|case
name|AR_S_READY
operator||
name|AR_S_REBUILDING
case|:
case|case
name|AR_S_READY
operator||
name|AR_S_DEGRADED
operator||
name|AR_S_REBUILDING
case|:
return|return
literal|"REBUILDING"
return|;
default|default:
return|return
literal|"BROKEN"
return|;
block|}
block|}
end_function

begin_comment
comment|/* debugging gunk */
end_comment

begin_function
specifier|static
name|void
name|ata_raid_print_meta
parameter_list|(
name|struct
name|ar_softc
modifier|*
name|raid
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"********** ATA PseudoRAID ar%d Metadata **********\n"
argument_list|,
name|raid
operator|->
name|lun
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"format              %s\n"
argument_list|,
name|ata_raid_format
argument_list|(
name|raid
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                %s\n"
argument_list|,
name|ata_raid_type
argument_list|(
name|raid
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"flags               0x%02x %b\n"
argument_list|,
name|raid
operator|->
name|status
argument_list|,
name|raid
operator|->
name|status
argument_list|,
literal|"\20\3REBUILDING\2DEGRADED\1READY\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_0             0x%016jx\n"
argument_list|,
name|raid
operator|->
name|magic_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_1             0x%016jx\n"
argument_list|,
name|raid
operator|->
name|magic_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"generation          %u\n"
argument_list|,
name|raid
operator|->
name|generation
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_sectors       %ju\n"
argument_list|,
name|raid
operator|->
name|total_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"offset_sectors      %ju\n"
argument_list|,
name|raid
operator|->
name|offset_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"heads               %u\n"
argument_list|,
name|raid
operator|->
name|heads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"sectors             %u\n"
argument_list|,
name|raid
operator|->
name|sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cylinders           %u\n"
argument_list|,
name|raid
operator|->
name|cylinders
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"width               %u\n"
argument_list|,
name|raid
operator|->
name|width
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"interleave          %u\n"
argument_list|,
name|raid
operator|->
name|interleave
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_disks         %u\n"
argument_list|,
name|raid
operator|->
name|total_disks
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|raid
operator|->
name|total_disks
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"    disk %d:      flags = 0x%02x %b\n"
argument_list|,
name|i
argument_list|,
name|raid
operator|->
name|disks
index|[
name|i
index|]
operator|.
name|flags
argument_list|,
name|raid
operator|->
name|disks
index|[
name|i
index|]
operator|.
name|flags
argument_list|,
literal|"\20\4ONLINE\3SPARE\2ASSIGNED\1PRESENT\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|raid
operator|->
name|disks
index|[
name|i
index|]
operator|.
name|dev
condition|)
block|{
name|printf
argument_list|(
literal|"        "
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|raid
operator|->
name|disks
index|[
name|i
index|]
operator|.
name|dev
argument_list|,
literal|" sectors %jd\n"
argument_list|,
name|raid
operator|->
name|disks
index|[
name|i
index|]
operator|.
name|sectors
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_adaptec_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ADP_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|ADP_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_adaptec_print_meta
parameter_list|(
name|struct
name|adaptec_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"********* ATA Adaptec HostRAID Metadata *********\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_0<0x%08x>\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|magic_0
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"generation          0x%08x\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|generation
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_0             0x%04x\n"
argument_list|,
name|be16toh
argument_list|(
name|meta
operator|->
name|dummy_0
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_configs       %u\n"
argument_list|,
name|be16toh
argument_list|(
name|meta
operator|->
name|total_configs
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_1             0x%04x\n"
argument_list|,
name|be16toh
argument_list|(
name|meta
operator|->
name|dummy_1
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checksum            0x%04x\n"
argument_list|,
name|be16toh
argument_list|(
name|meta
operator|->
name|checksum
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_2             0x%08x\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|dummy_2
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_3             0x%08x\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|dummy_3
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"flags               0x%08x\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp           0x%08x\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|timestamp
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_4             0x%08x 0x%08x 0x%08x 0x%08x\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|dummy_4
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|dummy_4
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|dummy_4
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|dummy_4
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_5             0x%08x 0x%08x 0x%08x 0x%08x\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|dummy_5
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|dummy_5
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|dummy_5
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|dummy_5
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|be16toh
argument_list|(
name|meta
operator|->
name|total_configs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"    %d   total_disks  %u\n"
argument_list|,
name|i
argument_list|,
name|be16toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|disk_number
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   generation   %u\n"
argument_list|,
name|i
argument_list|,
name|be16toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|generation
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   magic_0      0x%08x\n"
argument_list|,
name|i
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|magic_0
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   dummy_0      0x%02x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   type         %s\n"
argument_list|,
name|i
argument_list|,
name|ata_raid_adaptec_type
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   dummy_1      0x%02x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   flags        %d\n"
argument_list|,
name|i
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   dummy_2      0x%02x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   dummy_3      0x%02x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   dummy_4      0x%02x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   dummy_5      0x%02x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_5
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   disk_number  %u\n"
argument_list|,
name|i
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|disk_number
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   dummy_6      0x%08x\n"
argument_list|,
name|i
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_6
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   sectors      %u\n"
argument_list|,
name|i
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|sectors
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   stripe_shift %u\n"
argument_list|,
name|i
argument_list|,
name|be16toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|stripe_shift
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   dummy_7      0x%08x\n"
argument_list|,
name|i
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_7
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   dummy_8      0x%08x 0x%08x 0x%08x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_8
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_8
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_8
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|dummy_8
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d   name<%s>\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"magic_1<0x%08x>\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|magic_1
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_2<0x%08x>\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|magic_2
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_3<0x%08x>\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|magic_3
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_4<0x%08x>\n"
argument_list|,
name|be32toh
argument_list|(
name|meta
operator|->
name|magic_4
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_hptv2_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|HPTV2_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|HPTV2_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|HPTV2_T_RAID01_RAID0
case|:
return|return
literal|"RAID01_RAID0"
return|;
case|case
name|HPTV2_T_SPAN
case|:
return|return
literal|"SPAN"
return|;
case|case
name|HPTV2_T_RAID_3
case|:
return|return
literal|"RAID3"
return|;
case|case
name|HPTV2_T_RAID_5
case|:
return|return
literal|"RAID5"
return|;
case|case
name|HPTV2_T_JBOD
case|:
return|return
literal|"JBOD"
return|;
case|case
name|HPTV2_T_RAID01_RAID1
case|:
return|return
literal|"RAID01_RAID1"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_hptv2_print_meta
parameter_list|(
name|struct
name|hptv2_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"****** ATA Highpoint V2 RocketRAID Metadata *****\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic               0x%08x\n"
argument_list|,
name|meta
operator|->
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_0             0x%08x\n"
argument_list|,
name|meta
operator|->
name|magic_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_1             0x%08x\n"
argument_list|,
name|meta
operator|->
name|magic_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"order               0x%08x\n"
argument_list|,
name|meta
operator|->
name|order
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"array_width         %u\n"
argument_list|,
name|meta
operator|->
name|array_width
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_shift        %u\n"
argument_list|,
name|meta
operator|->
name|stripe_shift
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                %s\n"
argument_list|,
name|ata_raid_hptv2_type
argument_list|(
name|meta
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_number         %u\n"
argument_list|,
name|meta
operator|->
name|disk_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_sectors       %u\n"
argument_list|,
name|meta
operator|->
name|total_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_mode           0x%08x\n"
argument_list|,
name|meta
operator|->
name|disk_mode
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"boot_mode           0x%08x\n"
argument_list|,
name|meta
operator|->
name|boot_mode
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"boot_disk           0x%02x\n"
argument_list|,
name|meta
operator|->
name|boot_disk
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"boot_protect        0x%02x\n"
argument_list|,
name|meta
operator|->
name|boot_protect
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"log_entries         0x%02x\n"
argument_list|,
name|meta
operator|->
name|error_log_entries
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"log_index           0x%02x\n"
argument_list|,
name|meta
operator|->
name|error_log_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|meta
operator|->
name|error_log_entries
condition|)
block|{
name|printf
argument_list|(
literal|"    timestamp  reason disk  status  sectors lba\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|meta
operator|->
name|error_log_index
init|;
name|i
operator|<
name|meta
operator|->
name|error_log_index
operator|+
name|meta
operator|->
name|error_log_entries
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"    0x%08x  0x%02x  0x%02x  0x%02x    0x%02x    0x%08x\n"
argument_list|,
name|meta
operator|->
name|errorlog
index|[
name|i
operator|%
literal|32
index|]
operator|.
name|timestamp
argument_list|,
name|meta
operator|->
name|errorlog
index|[
name|i
operator|%
literal|32
index|]
operator|.
name|reason
argument_list|,
name|meta
operator|->
name|errorlog
index|[
name|i
operator|%
literal|32
index|]
operator|.
name|disk
argument_list|,
name|meta
operator|->
name|errorlog
index|[
name|i
operator|%
literal|32
index|]
operator|.
name|status
argument_list|,
name|meta
operator|->
name|errorlog
index|[
name|i
operator|%
literal|32
index|]
operator|.
name|sectors
argument_list|,
name|meta
operator|->
name|errorlog
index|[
name|i
operator|%
literal|32
index|]
operator|.
name|lba
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"rebuild_lba         0x%08x\n"
argument_list|,
name|meta
operator|->
name|rebuild_lba
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_1             0x%02x\n"
argument_list|,
name|meta
operator|->
name|dummy_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"name_1<%.15s>\n"
argument_list|,
name|meta
operator|->
name|name_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_2             0x%02x\n"
argument_list|,
name|meta
operator|->
name|dummy_2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"name_2<%.15s>\n"
argument_list|,
name|meta
operator|->
name|name_2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_hptv3_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|HPTV3_T_SPARE
case|:
return|return
literal|"SPARE"
return|;
case|case
name|HPTV3_T_JBOD
case|:
return|return
literal|"JBOD"
return|;
case|case
name|HPTV3_T_SPAN
case|:
return|return
literal|"SPAN"
return|;
case|case
name|HPTV3_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|HPTV3_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|HPTV3_T_RAID3
case|:
return|return
literal|"RAID3"
return|;
case|case
name|HPTV3_T_RAID5
case|:
return|return
literal|"RAID5"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_hptv3_print_meta
parameter_list|(
name|struct
name|hptv3_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"****** ATA Highpoint V3 RocketRAID Metadata *****\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic               0x%08x\n"
argument_list|,
name|meta
operator|->
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_0             0x%08x\n"
argument_list|,
name|meta
operator|->
name|magic_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checksum_0          0x%02x\n"
argument_list|,
name|meta
operator|->
name|checksum_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"mode                0x%02x\n"
argument_list|,
name|meta
operator|->
name|mode
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"user_mode           0x%02x\n"
argument_list|,
name|meta
operator|->
name|user_mode
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"config_entries      0x%02x\n"
argument_list|,
name|meta
operator|->
name|config_entries
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|meta
operator|->
name|config_entries
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"config %d:\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    total_sectors       %ju\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
literal|0
index|]
operator|.
name|total_sectors
operator|+
operator|(
operator|(
name|u_int64_t
operator|)
name|meta
operator|->
name|configs_high
index|[
literal|0
index|]
operator|.
name|total_sectors
operator|<<
literal|32
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    type                %s\n"
argument_list|,
name|ata_raid_hptv3_type
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    total_disks         %u\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|total_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    disk_number         %u\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|disk_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    stripe_shift        %u\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|stripe_shift
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    status              %b\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|status
argument_list|,
literal|"\20\2RAID5\1NEED_REBUILD\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    critical_disks      %u\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|critical_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    rebuild_lba         %ju\n"
argument_list|,
name|meta
operator|->
name|configs_high
index|[
literal|0
index|]
operator|.
name|rebuild_lba
operator|+
operator|(
operator|(
name|u_int64_t
operator|)
name|meta
operator|->
name|configs_high
index|[
literal|0
index|]
operator|.
name|rebuild_lba
operator|<<
literal|32
operator|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"name<%.16s>\n"
argument_list|,
name|meta
operator|->
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp           0x%08x\n"
argument_list|,
name|meta
operator|->
name|timestamp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"description<%.16s>\n"
argument_list|,
name|meta
operator|->
name|description
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"creator<%.16s>\n"
argument_list|,
name|meta
operator|->
name|creator
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checksum_1          0x%02x\n"
argument_list|,
name|meta
operator|->
name|checksum_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_0             0x%02x\n"
argument_list|,
name|meta
operator|->
name|dummy_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_1             0x%02x\n"
argument_list|,
name|meta
operator|->
name|dummy_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"flags               %b\n"
argument_list|,
name|meta
operator|->
name|flags
argument_list|,
literal|"\20\4RCACHE\3WCACHE\2NCQ\1TCQ\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_intel_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|INTEL_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|INTEL_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|INTEL_T_RAID5
case|:
return|return
literal|"RAID5"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_intel_print_meta
parameter_list|(
name|struct
name|intel_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|struct
name|intel_raid_mapping
modifier|*
name|map
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|printf
argument_list|(
literal|"********* ATA Intel MatrixRAID Metadata *********\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"intel_id<%.24s>\n"
argument_list|,
name|meta
operator|->
name|intel_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"version<%.6s>\n"
argument_list|,
name|meta
operator|->
name|version
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checksum            0x%08x\n"
argument_list|,
name|meta
operator|->
name|checksum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"config_size         0x%08x\n"
argument_list|,
name|meta
operator|->
name|config_size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"config_id           0x%08x\n"
argument_list|,
name|meta
operator|->
name|config_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"generation          0x%08x\n"
argument_list|,
name|meta
operator|->
name|generation
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_disks         %u\n"
argument_list|,
name|meta
operator|->
name|total_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_volumes       %u\n"
argument_list|,
name|meta
operator|->
name|total_volumes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DISK#   serial disk_sectors disk_id flags\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|meta
operator|->
name|total_disks
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"    %d<%.16s> %u 0x%08x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|disk
index|[
name|i
index|]
operator|.
name|serial
argument_list|,
name|meta
operator|->
name|disk
index|[
name|i
index|]
operator|.
name|sectors
argument_list|,
name|meta
operator|->
name|disk
index|[
name|i
index|]
operator|.
name|id
argument_list|,
name|meta
operator|->
name|disk
index|[
name|i
index|]
operator|.
name|flags
argument_list|)
expr_stmt|;
block|}
name|map
operator|=
operator|(
expr|struct
name|intel_raid_mapping
operator|*
operator|)
operator|&
name|meta
operator|->
name|disk
index|[
name|meta
operator|->
name|total_disks
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|meta
operator|->
name|total_volumes
condition|;
name|j
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"name                %.16s\n"
argument_list|,
name|map
operator|->
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_sectors       %ju\n"
argument_list|,
name|map
operator|->
name|total_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"state               %u\n"
argument_list|,
name|map
operator|->
name|state
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"reserved            %u\n"
argument_list|,
name|map
operator|->
name|reserved
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"offset              %u\n"
argument_list|,
name|map
operator|->
name|offset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_sectors        %u\n"
argument_list|,
name|map
operator|->
name|disk_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_count        %u\n"
argument_list|,
name|map
operator|->
name|stripe_count
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_sectors      %u\n"
argument_list|,
name|map
operator|->
name|stripe_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"status              %u\n"
argument_list|,
name|map
operator|->
name|status
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                %s\n"
argument_list|,
name|ata_raid_intel_type
argument_list|(
name|map
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_disks         %u\n"
argument_list|,
name|map
operator|->
name|total_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic[0]            0x%02x\n"
argument_list|,
name|map
operator|->
name|magic
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic[1]            0x%02x\n"
argument_list|,
name|map
operator|->
name|magic
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic[2]            0x%02x\n"
argument_list|,
name|map
operator|->
name|magic
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|map
operator|->
name|total_disks
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"    disk %d at disk_idx 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|map
operator|->
name|disk_idx
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|map
operator|=
operator|(
expr|struct
name|intel_raid_mapping
operator|*
operator|)
operator|&
name|map
operator|->
name|disk_idx
index|[
name|map
operator|->
name|total_disks
index|]
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_ite_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ITE_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|ITE_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|ITE_T_RAID01
case|:
return|return
literal|"RAID0+1"
return|;
case|case
name|ITE_T_SPAN
case|:
return|return
literal|"SPAN"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_ite_print_meta
parameter_list|(
name|struct
name|ite_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|printf
argument_list|(
literal|"*** ATA Integrated Technology Express Metadata **\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ite_id<%.40s>\n"
argument_list|,
name|meta
operator|->
name|ite_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp_0         %04x/%02x/%02x %02x:%02x:%02x.%02x\n"
argument_list|,
operator|*
operator|(
operator|(
name|u_int16_t
operator|*
operator|)
name|meta
operator|->
name|timestamp_0
operator|)
argument_list|,
name|meta
operator|->
name|timestamp_0
index|[
literal|2
index|]
argument_list|,
name|meta
operator|->
name|timestamp_0
index|[
literal|3
index|]
argument_list|,
name|meta
operator|->
name|timestamp_0
index|[
literal|5
index|]
argument_list|,
name|meta
operator|->
name|timestamp_0
index|[
literal|4
index|]
argument_list|,
name|meta
operator|->
name|timestamp_0
index|[
literal|7
index|]
argument_list|,
name|meta
operator|->
name|timestamp_0
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_sectors       %jd\n"
argument_list|,
name|meta
operator|->
name|total_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                %s\n"
argument_list|,
name|ata_raid_ite_type
argument_list|(
name|meta
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_1kblocks     %u\n"
argument_list|,
name|meta
operator|->
name|stripe_1kblocks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp_1         %04x/%02x/%02x %02x:%02x:%02x.%02x\n"
argument_list|,
operator|*
operator|(
operator|(
name|u_int16_t
operator|*
operator|)
name|meta
operator|->
name|timestamp_1
operator|)
argument_list|,
name|meta
operator|->
name|timestamp_1
index|[
literal|2
index|]
argument_list|,
name|meta
operator|->
name|timestamp_1
index|[
literal|3
index|]
argument_list|,
name|meta
operator|->
name|timestamp_1
index|[
literal|5
index|]
argument_list|,
name|meta
operator|->
name|timestamp_1
index|[
literal|4
index|]
argument_list|,
name|meta
operator|->
name|timestamp_1
index|[
literal|7
index|]
argument_list|,
name|meta
operator|->
name|timestamp_1
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_sectors      %u\n"
argument_list|,
name|meta
operator|->
name|stripe_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"array_width         %u\n"
argument_list|,
name|meta
operator|->
name|array_width
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_number         %u\n"
argument_list|,
name|meta
operator|->
name|disk_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_sectors        %u\n"
argument_list|,
name|meta
operator|->
name|disk_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_jmicron_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|JM_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|JM_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|JM_T_RAID01
case|:
return|return
literal|"RAID0+1"
return|;
case|case
name|JM_T_JBOD
case|:
return|return
literal|"JBOD"
return|;
case|case
name|JM_T_RAID5
case|:
return|return
literal|"RAID5"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_jmicron_print_meta
parameter_list|(
name|struct
name|jmicron_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"***** ATA JMicron Technology Corp Metadata ******\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"signature           %.2s\n"
argument_list|,
name|meta
operator|->
name|signature
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"version             0x%04x\n"
argument_list|,
name|meta
operator|->
name|version
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checksum            0x%04x\n"
argument_list|,
name|meta
operator|->
name|checksum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_id             0x%08x\n"
argument_list|,
name|meta
operator|->
name|disk_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"offset              0x%08x\n"
argument_list|,
name|meta
operator|->
name|offset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_sectors_low    0x%08x\n"
argument_list|,
name|meta
operator|->
name|disk_sectors_low
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_sectors_high   0x%08x\n"
argument_list|,
name|meta
operator|->
name|disk_sectors_high
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"name                %.16s\n"
argument_list|,
name|meta
operator|->
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                %s\n"
argument_list|,
name|ata_raid_jmicron_type
argument_list|(
name|meta
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_shift        %d\n"
argument_list|,
name|meta
operator|->
name|stripe_shift
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"flags               0x%04x\n"
argument_list|,
name|meta
operator|->
name|flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"spare:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
operator|&&
name|meta
operator|->
name|spare
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"    %d                  0x%08x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|spare
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disks:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
operator|&&
name|meta
operator|->
name|disks
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"    %d                  0x%08x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|disks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_lsiv2_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|LSIV2_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|LSIV2_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|LSIV2_T_SPARE
case|:
return|return
literal|"SPARE"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_lsiv2_print_meta
parameter_list|(
name|struct
name|lsiv2_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"******* ATA LSILogic V2 MegaRAID Metadata *******\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"lsi_id<%s>\n"
argument_list|,
name|meta
operator|->
name|lsi_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_0             0x%02x\n"
argument_list|,
name|meta
operator|->
name|dummy_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"flags               0x%02x\n"
argument_list|,
name|meta
operator|->
name|flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"version             0x%04x\n"
argument_list|,
name|meta
operator|->
name|version
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"config_entries      0x%02x\n"
argument_list|,
name|meta
operator|->
name|config_entries
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid_count          0x%02x\n"
argument_list|,
name|meta
operator|->
name|raid_count
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_disks         0x%02x\n"
argument_list|,
name|meta
operator|->
name|total_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_1             0x%02x\n"
argument_list|,
name|meta
operator|->
name|dummy_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_2             0x%04x\n"
argument_list|,
name|meta
operator|->
name|dummy_2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|meta
operator|->
name|config_entries
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"    type             %s\n"
argument_list|,
name|ata_raid_lsiv2_type
argument_list|(
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|raid
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    dummy_0          %02x\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|raid
operator|.
name|dummy_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    stripe_sectors   %u\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|raid
operator|.
name|stripe_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    array_width      %u\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|raid
operator|.
name|array_width
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    disk_count       %u\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|raid
operator|.
name|disk_count
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    config_offset    %u\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|raid
operator|.
name|config_offset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    dummy_1          %u\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|raid
operator|.
name|dummy_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    flags            %02x\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|raid
operator|.
name|flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    total_sectors    %u\n"
argument_list|,
name|meta
operator|->
name|configs
index|[
name|i
index|]
operator|.
name|raid
operator|.
name|total_sectors
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"disk_number         0x%02x\n"
argument_list|,
name|meta
operator|->
name|disk_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid_number         0x%02x\n"
argument_list|,
name|meta
operator|->
name|raid_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp           0x%08x\n"
argument_list|,
name|meta
operator|->
name|timestamp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_lsiv3_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|LSIV3_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|LSIV3_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_lsiv3_print_meta
parameter_list|(
name|struct
name|lsiv3_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"******* ATA LSILogic V3 MegaRAID Metadata *******\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"lsi_id<%.6s>\n"
argument_list|,
name|meta
operator|->
name|lsi_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_0             0x%04x\n"
argument_list|,
name|meta
operator|->
name|dummy_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"version             0x%04x\n"
argument_list|,
name|meta
operator|->
name|version
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_0             0x%04x\n"
argument_list|,
name|meta
operator|->
name|dummy_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"RAID configs:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|meta
operator|->
name|raid
index|[
name|i
index|]
operator|.
name|total_disks
condition|)
block|{
name|printf
argument_list|(
literal|"%02d  stripe_pages       %u\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|raid
index|[
name|i
index|]
operator|.
name|stripe_pages
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02d  type               %s\n"
argument_list|,
name|i
argument_list|,
name|ata_raid_lsiv3_type
argument_list|(
name|meta
operator|->
name|raid
index|[
name|i
index|]
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02d  total_disks        %u\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|raid
index|[
name|i
index|]
operator|.
name|total_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02d  array_width        %u\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|raid
index|[
name|i
index|]
operator|.
name|array_width
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02d  sectors            %u\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|raid
index|[
name|i
index|]
operator|.
name|sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02d  offset             %u\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|raid
index|[
name|i
index|]
operator|.
name|offset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02d  device             0x%02x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|raid
index|[
name|i
index|]
operator|.
name|device
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"DISK configs:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|meta
operator|->
name|disk
index|[
name|i
index|]
operator|.
name|disk_sectors
condition|)
block|{
name|printf
argument_list|(
literal|"%02d  disk_sectors       %u\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|disk
index|[
name|i
index|]
operator|.
name|disk_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02d  flags              0x%02x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|disk
index|[
name|i
index|]
operator|.
name|flags
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"device              0x%02x\n"
argument_list|,
name|meta
operator|->
name|device
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp           0x%08x\n"
argument_list|,
name|meta
operator|->
name|timestamp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checksum_1          0x%02x\n"
argument_list|,
name|meta
operator|->
name|checksum_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_nvidia_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|NV_T_SPAN
case|:
return|return
literal|"SPAN"
return|;
case|case
name|NV_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|NV_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|NV_T_RAID3
case|:
return|return
literal|"RAID3"
return|;
case|case
name|NV_T_RAID5
case|:
return|return
literal|"RAID5"
return|;
case|case
name|NV_T_RAID01
case|:
return|return
literal|"RAID0+1"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_nvidia_print_meta
parameter_list|(
name|struct
name|nvidia_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|printf
argument_list|(
literal|"******** ATA nVidia MediaShield Metadata ********\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"nvidia_id<%.8s>\n"
argument_list|,
name|meta
operator|->
name|nvidia_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"config_size         %d\n"
argument_list|,
name|meta
operator|->
name|config_size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checksum            0x%08x\n"
argument_list|,
name|meta
operator|->
name|checksum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"version             0x%04x\n"
argument_list|,
name|meta
operator|->
name|version
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_number         %d\n"
argument_list|,
name|meta
operator|->
name|disk_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_0             0x%02x\n"
argument_list|,
name|meta
operator|->
name|dummy_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_sectors       %d\n"
argument_list|,
name|meta
operator|->
name|total_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"sectors_size        %d\n"
argument_list|,
name|meta
operator|->
name|sector_size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"serial              %.16s\n"
argument_list|,
name|meta
operator|->
name|serial
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"revision            %.4s\n"
argument_list|,
name|meta
operator|->
name|revision
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_1             0x%08x\n"
argument_list|,
name|meta
operator|->
name|dummy_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_0             0x%08x\n"
argument_list|,
name|meta
operator|->
name|magic_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_1             0x%016jx\n"
argument_list|,
name|meta
operator|->
name|magic_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_2             0x%016jx\n"
argument_list|,
name|meta
operator|->
name|magic_2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"flags               0x%02x\n"
argument_list|,
name|meta
operator|->
name|flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"array_width         %d\n"
argument_list|,
name|meta
operator|->
name|array_width
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_disks         %d\n"
argument_list|,
name|meta
operator|->
name|total_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_2             0x%02x\n"
argument_list|,
name|meta
operator|->
name|dummy_2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                %s\n"
argument_list|,
name|ata_raid_nvidia_type
argument_list|(
name|meta
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_3             0x%04x\n"
argument_list|,
name|meta
operator|->
name|dummy_3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_sectors      %d\n"
argument_list|,
name|meta
operator|->
name|stripe_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_bytes        %d\n"
argument_list|,
name|meta
operator|->
name|stripe_bytes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_shift        %d\n"
argument_list|,
name|meta
operator|->
name|stripe_shift
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_mask         0x%08x\n"
argument_list|,
name|meta
operator|->
name|stripe_mask
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_sizesectors  %d\n"
argument_list|,
name|meta
operator|->
name|stripe_sizesectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_sizebytes    %d\n"
argument_list|,
name|meta
operator|->
name|stripe_sizebytes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"rebuild_lba         %d\n"
argument_list|,
name|meta
operator|->
name|rebuild_lba
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_4             0x%08x\n"
argument_list|,
name|meta
operator|->
name|dummy_4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_5             0x%08x\n"
argument_list|,
name|meta
operator|->
name|dummy_5
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"status              0x%08x\n"
argument_list|,
name|meta
operator|->
name|status
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_promise_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|PR_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|PR_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|PR_T_RAID3
case|:
return|return
literal|"RAID3"
return|;
case|case
name|PR_T_RAID5
case|:
return|return
literal|"RAID5"
return|;
case|case
name|PR_T_SPAN
case|:
return|return
literal|"SPAN"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_promise_print_meta
parameter_list|(
name|struct
name|promise_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"********* ATA Promise FastTrak Metadata *********\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"promise_id<%s>\n"
argument_list|,
name|meta
operator|->
name|promise_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_0             0x%08x\n"
argument_list|,
name|meta
operator|->
name|dummy_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_0             0x%016jx\n"
argument_list|,
name|meta
operator|->
name|magic_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_1             0x%04x\n"
argument_list|,
name|meta
operator|->
name|magic_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_2             0x%08x\n"
argument_list|,
name|meta
operator|->
name|magic_2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"integrity           0x%08x %b\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|integrity
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|integrity
argument_list|,
literal|"\20\10VALID\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"flags               0x%02x %b\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|flags
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|flags
argument_list|,
literal|"\20\10READY\7DOWN\6REDIR\5DUPLICATE\4SPARE"
literal|"\3ASSIGNED\2ONLINE\1VALID\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_number         %d\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|disk_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"channel             0x%02x\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|channel
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"device              0x%02x\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|device
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_0             0x%016jx\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|magic_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_offset         %u\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|disk_offset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_sectors        %u\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|disk_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"rebuild_lba         0x%08x\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|rebuild_lba
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"generation          0x%04x\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|generation
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"status              0x%02x %b\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|status
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|status
argument_list|,
literal|"\20\6MARKED\5DEGRADED\4READY\3INITED\2ONLINE\1VALID\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                %s\n"
argument_list|,
name|ata_raid_promise_type
argument_list|(
name|meta
operator|->
name|raid
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_disks         %u\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|total_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_shift        %u\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|stripe_shift
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"array_width         %u\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|array_width
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"array_number        %u\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|array_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_sectors       %u\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|total_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cylinders           %u\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|cylinders
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"heads               %u\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|heads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"sectors             %u\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic_1             0x%016jx\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|magic_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DISK#   flags dummy_0 channel device  magic_0\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"  %d    %b    0x%02x  0x%02x  0x%02x  "
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|i
index|]
operator|.
name|flags
argument_list|,
literal|"\20\10READY\7DOWN\6REDIR\5DUPLICATE\4SPARE"
literal|"\3ASSIGNED\2ONLINE\1VALID\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|i
index|]
operator|.
name|dummy_0
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|i
index|]
operator|.
name|channel
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|i
index|]
operator|.
name|device
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"0x%016jx\n"
argument_list|,
name|meta
operator|->
name|raid
operator|.
name|disk
index|[
name|i
index|]
operator|.
name|magic_0
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"checksum            0x%08x\n"
argument_list|,
name|meta
operator|->
name|checksum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_sii_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SII_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|SII_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|SII_T_RAID01
case|:
return|return
literal|"RAID0+1"
return|;
case|case
name|SII_T_SPARE
case|:
return|return
literal|"SPARE"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_sii_print_meta
parameter_list|(
name|struct
name|sii_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|printf
argument_list|(
literal|"******* ATA Silicon Image Medley Metadata *******\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_sectors       %ju\n"
argument_list|,
name|meta
operator|->
name|total_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_0             0x%04x\n"
argument_list|,
name|meta
operator|->
name|dummy_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_1             0x%04x\n"
argument_list|,
name|meta
operator|->
name|dummy_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"controller_pci_id   0x%08x\n"
argument_list|,
name|meta
operator|->
name|controller_pci_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"version_minor       0x%04x\n"
argument_list|,
name|meta
operator|->
name|version_minor
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"version_major       0x%04x\n"
argument_list|,
name|meta
operator|->
name|version_major
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp           20%02x/%02x/%02x %02x:%02x:%02x\n"
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|5
index|]
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|4
index|]
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|3
index|]
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|2
index|]
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|1
index|]
argument_list|,
name|meta
operator|->
name|timestamp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_sectors      %u\n"
argument_list|,
name|meta
operator|->
name|stripe_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_2             0x%04x\n"
argument_list|,
name|meta
operator|->
name|dummy_2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_number         %u\n"
argument_list|,
name|meta
operator|->
name|disk_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                %s\n"
argument_list|,
name|ata_raid_sii_type
argument_list|(
name|meta
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid0_disks         %u\n"
argument_list|,
name|meta
operator|->
name|raid0_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid0_ident         %u\n"
argument_list|,
name|meta
operator|->
name|raid0_ident
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid1_disks         %u\n"
argument_list|,
name|meta
operator|->
name|raid1_disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid1_ident         %u\n"
argument_list|,
name|meta
operator|->
name|raid1_ident
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"rebuild_lba         %ju\n"
argument_list|,
name|meta
operator|->
name|rebuild_lba
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"generation          0x%08x\n"
argument_list|,
name|meta
operator|->
name|generation
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"status              0x%02x %b\n"
argument_list|,
name|meta
operator|->
name|status
argument_list|,
name|meta
operator|->
name|status
argument_list|,
literal|"\20\1READY\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"base_raid1_position %02x\n"
argument_list|,
name|meta
operator|->
name|base_raid1_position
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"base_raid0_position %02x\n"
argument_list|,
name|meta
operator|->
name|base_raid0_position
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"position            %02x\n"
argument_list|,
name|meta
operator|->
name|position
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_3             %04x\n"
argument_list|,
name|meta
operator|->
name|dummy_3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"name<%.16s>\n"
argument_list|,
name|meta
operator|->
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checksum_0          0x%04x\n"
argument_list|,
name|meta
operator|->
name|checksum_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checksum_1          0x%04x\n"
argument_list|,
name|meta
operator|->
name|checksum_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_sis_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SIS_T_JBOD
case|:
return|return
literal|"JBOD"
return|;
case|case
name|SIS_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|SIS_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_sis_print_meta
parameter_list|(
name|struct
name|sis_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|printf
argument_list|(
literal|"**** ATA Silicon Integrated Systems Metadata ****\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic               0x%04x\n"
argument_list|,
name|meta
operator|->
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disks               0x%02x\n"
argument_list|,
name|meta
operator|->
name|disks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                %s\n"
argument_list|,
name|ata_raid_sis_type
argument_list|(
name|meta
operator|->
name|type_total_disks
operator|&
name|SIS_T_MASK
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"total_disks         %u\n"
argument_list|,
name|meta
operator|->
name|type_total_disks
operator|&
name|SIS_D_MASK
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_0             0x%08x\n"
argument_list|,
name|meta
operator|->
name|dummy_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"controller_pci_id   0x%08x\n"
argument_list|,
name|meta
operator|->
name|controller_pci_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_sectors      %u\n"
argument_list|,
name|meta
operator|->
name|stripe_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_1             0x%04x\n"
argument_list|,
name|meta
operator|->
name|dummy_1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp           0x%08x\n"
argument_list|,
name|meta
operator|->
name|timestamp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"model               %.40s\n"
argument_list|,
name|meta
operator|->
name|model
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_number         %u\n"
argument_list|,
name|meta
operator|->
name|disk_number
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_2             0x%02x 0x%02x 0x%02x\n"
argument_list|,
name|meta
operator|->
name|dummy_2
index|[
literal|0
index|]
argument_list|,
name|meta
operator|->
name|dummy_2
index|[
literal|1
index|]
argument_list|,
name|meta
operator|->
name|dummy_2
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|ata_raid_via_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|VIA_T_RAID0
case|:
return|return
literal|"RAID0"
return|;
case|case
name|VIA_T_RAID1
case|:
return|return
literal|"RAID1"
return|;
case|case
name|VIA_T_RAID5
case|:
return|return
literal|"RAID5"
return|;
case|case
name|VIA_T_RAID01
case|:
return|return
literal|"RAID0+1"
return|;
case|case
name|VIA_T_SPAN
case|:
return|return
literal|"SPAN"
return|;
default|default:
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"UNKNOWN 0x%02x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_raid_via_print_meta
parameter_list|(
name|struct
name|via_raid_conf
modifier|*
name|meta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"*************** ATA VIA Metadata ****************\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"magic               0x%02x\n"
argument_list|,
name|meta
operator|->
name|magic
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dummy_0             0x%02x\n"
argument_list|,
name|meta
operator|->
name|dummy_0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"type                %s\n"
argument_list|,
name|ata_raid_via_type
argument_list|(
name|meta
operator|->
name|type
operator|&
name|VIA_T_MASK
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"bootable            %d\n"
argument_list|,
name|meta
operator|->
name|type
operator|&
name|VIA_T_BOOTABLE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"unknown             %d\n"
argument_list|,
name|meta
operator|->
name|type
operator|&
name|VIA_T_UNKNOWN
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_index          0x%02x\n"
argument_list|,
name|meta
operator|->
name|disk_index
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stripe_layout       0x%02x\n"
argument_list|,
name|meta
operator|->
name|stripe_layout
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" stripe_disks       %d\n"
argument_list|,
name|meta
operator|->
name|stripe_layout
operator|&
name|VIA_L_DISKS
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" stripe_sectors     %d\n"
argument_list|,
literal|0x08
operator|<<
operator|(
operator|(
name|meta
operator|->
name|stripe_layout
operator|&
name|VIA_L_MASK
operator|)
operator|>>
name|VIA_L_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_sectors        %ju\n"
argument_list|,
name|meta
operator|->
name|disk_sectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disk_id             0x%08x\n"
argument_list|,
name|meta
operator|->
name|disk_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DISK#   disk_id\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|meta
operator|->
name|disks
index|[
name|i
index|]
condition|)
name|printf
argument_list|(
literal|"  %d    0x%08x\n"
argument_list|,
name|i
argument_list|,
name|meta
operator|->
name|disks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"checksum            0x%02x\n"
argument_list|,
name|meta
operator|->
name|checksum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================================================\n"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


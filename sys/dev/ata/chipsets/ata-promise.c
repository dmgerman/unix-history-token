begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1998 - 2008 SÃ¸ren Schmidt<sos@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_ata.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/ata.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/sema.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<vm/uma.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-all.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-pci.h>
end_include

begin_include
include|#
directive|include
file|<ata_if.h>
end_include

begin_comment
comment|/* local prototypes */
end_comment

begin_function_decl
specifier|static
name|int
name|ata_promise_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_ch_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_dmastart
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_dmastop
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_dmareset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|target
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_tx2_ch_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_tx2_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_ch_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_ch_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_mio_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_command
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_mio_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_pm_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|reg
parameter_list|,
name|u_int32_t
modifier|*
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_pm_write
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|reg
parameter_list|,
name|u_int32_t
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int32_t
name|ata_promise_mio_softreset
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_mio_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_mio_setprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|target
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_getrev
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|target
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_sx4_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_sx4_command
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_apkt
parameter_list|(
name|u_int8_t
modifier|*
name|bytep
parameter_list|,
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_queue_hpkt
parameter_list|(
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
parameter_list|,
name|u_int32_t
name|hpkt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_next_hpkt
parameter_list|(
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* misc defines */
end_comment

begin_define
define|#
directive|define
name|PR_OLD
value|0
end_define

begin_define
define|#
directive|define
name|PR_NEW
value|1
end_define

begin_define
define|#
directive|define
name|PR_TX
value|2
end_define

begin_define
define|#
directive|define
name|PR_MIO
value|3
end_define

begin_define
define|#
directive|define
name|PR_TX4
value|0x01
end_define

begin_define
define|#
directive|define
name|PR_SX4X
value|0x02
end_define

begin_define
define|#
directive|define
name|PR_SX6K
value|0x04
end_define

begin_define
define|#
directive|define
name|PR_PATA
value|0x08
end_define

begin_define
define|#
directive|define
name|PR_CMBO
value|0x10
end_define

begin_define
define|#
directive|define
name|PR_CMBO2
value|0x20
end_define

begin_define
define|#
directive|define
name|PR_SATA
value|0x40
end_define

begin_define
define|#
directive|define
name|PR_SATA2
value|0x80
end_define

begin_comment
comment|/*  * Promise chipset support functions  */
end_comment

begin_define
define|#
directive|define
name|ATA_PDC_APKT_OFFSET
value|0x00000010
end_define

begin_define
define|#
directive|define
name|ATA_PDC_HPKT_OFFSET
value|0x00000040
end_define

begin_define
define|#
directive|define
name|ATA_PDC_ASG_OFFSET
value|0x00000080
end_define

begin_define
define|#
directive|define
name|ATA_PDC_LSG_OFFSET
value|0x000000c0
end_define

begin_define
define|#
directive|define
name|ATA_PDC_HSG_OFFSET
value|0x00000100
end_define

begin_define
define|#
directive|define
name|ATA_PDC_CHN_OFFSET
value|0x00000400
end_define

begin_define
define|#
directive|define
name|ATA_PDC_BUF_BASE
value|0x00400000
end_define

begin_define
define|#
directive|define
name|ATA_PDC_BUF_OFFSET
value|0x00100000
end_define

begin_define
define|#
directive|define
name|ATA_PDC_MAX_HPKT
value|8
end_define

begin_define
define|#
directive|define
name|ATA_PDC_WRITE_REG
value|0x00
end_define

begin_define
define|#
directive|define
name|ATA_PDC_WRITE_CTL
value|0x0e
end_define

begin_define
define|#
directive|define
name|ATA_PDC_WRITE_END
value|0x08
end_define

begin_define
define|#
directive|define
name|ATA_PDC_WAIT_NBUSY
value|0x10
end_define

begin_define
define|#
directive|define
name|ATA_PDC_WAIT_READY
value|0x18
end_define

begin_define
define|#
directive|define
name|ATA_PDC_1B
value|0x20
end_define

begin_define
define|#
directive|define
name|ATA_PDC_2B
value|0x40
end_define

begin_struct
struct|struct
name|host_packet
block|{
name|u_int32_t
name|addr
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|host_packet
argument_list|)
name|chain
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ata_promise_sx4
block|{
name|struct
name|mtx
name|mtx
decl_stmt|;
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|host_packet
argument_list|)
name|queue
expr_stmt|;
name|int
name|busy
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ata_promise_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_PDC20246
block|,
literal|0
block|,
name|PR_OLD
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"PDC20246"
block|}
block|,
block|{
name|ATA_PDC20262
block|,
literal|0
block|,
name|PR_NEW
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"PDC20262"
block|}
block|,
block|{
name|ATA_PDC20263
block|,
literal|0
block|,
name|PR_NEW
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"PDC20263"
block|}
block|,
block|{
name|ATA_PDC20265
block|,
literal|0
block|,
name|PR_NEW
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"PDC20265"
block|}
block|,
block|{
name|ATA_PDC20267
block|,
literal|0
block|,
name|PR_NEW
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"PDC20267"
block|}
block|,
block|{
name|ATA_PDC20268
block|,
literal|0
block|,
name|PR_TX
block|,
name|PR_TX4
block|,
name|ATA_UDMA5
block|,
literal|"PDC20268"
block|}
block|,
block|{
name|ATA_PDC20269
block|,
literal|0
block|,
name|PR_TX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"PDC20269"
block|}
block|,
block|{
name|ATA_PDC20270
block|,
literal|0
block|,
name|PR_TX
block|,
name|PR_TX4
block|,
name|ATA_UDMA5
block|,
literal|"PDC20270"
block|}
block|,
block|{
name|ATA_PDC20271
block|,
literal|0
block|,
name|PR_TX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"PDC20271"
block|}
block|,
block|{
name|ATA_PDC20275
block|,
literal|0
block|,
name|PR_TX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"PDC20275"
block|}
block|,
block|{
name|ATA_PDC20276
block|,
literal|0
block|,
name|PR_TX
block|,
name|PR_SX6K
block|,
name|ATA_UDMA6
block|,
literal|"PDC20276"
block|}
block|,
block|{
name|ATA_PDC20277
block|,
literal|0
block|,
name|PR_TX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"PDC20277"
block|}
block|,
block|{
name|ATA_PDC20318
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_SATA
block|,
name|ATA_SA150
block|,
literal|"PDC20318"
block|}
block|,
block|{
name|ATA_PDC20319
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_SATA
block|,
name|ATA_SA150
block|,
literal|"PDC20319"
block|}
block|,
block|{
name|ATA_PDC20371
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20371"
block|}
block|,
block|{
name|ATA_PDC20375
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20375"
block|}
block|,
block|{
name|ATA_PDC20376
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20376"
block|}
block|,
block|{
name|ATA_PDC20377
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20377"
block|}
block|,
block|{
name|ATA_PDC20378
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20378"
block|}
block|,
block|{
name|ATA_PDC20379
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO
block|,
name|ATA_SA150
block|,
literal|"PDC20379"
block|}
block|,
block|{
name|ATA_PDC20571
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO2
block|,
name|ATA_SA150
block|,
literal|"PDC20571"
block|}
block|,
block|{
name|ATA_PDC20575
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO2
block|,
name|ATA_SA150
block|,
literal|"PDC20575"
block|}
block|,
block|{
name|ATA_PDC20579
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO2
block|,
name|ATA_SA150
block|,
literal|"PDC20579"
block|}
block|,
block|{
name|ATA_PDC20771
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO2
block|,
name|ATA_SA300
block|,
literal|"PDC20771"
block|}
block|,
block|{
name|ATA_PDC40775
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_CMBO2
block|,
name|ATA_SA300
block|,
literal|"PDC40775"
block|}
block|,
block|{
name|ATA_PDC20617
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_PATA
block|,
name|ATA_UDMA6
block|,
literal|"PDC20617"
block|}
block|,
block|{
name|ATA_PDC20618
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_PATA
block|,
name|ATA_UDMA6
block|,
literal|"PDC20618"
block|}
block|,
block|{
name|ATA_PDC20619
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_PATA
block|,
name|ATA_UDMA6
block|,
literal|"PDC20619"
block|}
block|,
block|{
name|ATA_PDC20620
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_PATA
block|,
name|ATA_UDMA6
block|,
literal|"PDC20620"
block|}
block|,
block|{
name|ATA_PDC20621
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_SX4X
block|,
name|ATA_UDMA5
block|,
literal|"PDC20621"
block|}
block|,
block|{
name|ATA_PDC20622
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_SX4X
block|,
name|ATA_SA150
block|,
literal|"PDC20622"
block|}
block|,
block|{
name|ATA_PDC40518
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_SATA2
block|,
name|ATA_SA150
block|,
literal|"PDC40518"
block|}
block|,
block|{
name|ATA_PDC40519
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_SATA2
block|,
name|ATA_SA150
block|,
literal|"PDC40519"
block|}
block|,
block|{
name|ATA_PDC40718
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_SATA2
block|,
name|ATA_SA300
block|,
literal|"PDC40718"
block|}
block|,
block|{
name|ATA_PDC40719
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_SATA2
block|,
name|ATA_SA300
block|,
literal|"PDC40719"
block|}
block|,
block|{
name|ATA_PDC40779
block|,
literal|0
block|,
name|PR_MIO
block|,
name|PR_SATA2
block|,
name|ATA_SA300
block|,
literal|"PDC40779"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
name|uintptr_t
name|devid
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|!=
name|ATA_PROMISE_ID
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
comment|/* if we are on a SuperTrak SX6000 dont attach */
if|if
condition|(
operator|(
name|idx
operator|->
name|cfg2
operator|&
name|PR_SX6K
operator|)
operator|&&
name|pci_get_class
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|==
name|PCIC_BRIDGE
operator|&&
operator|!
name|BUS_READ_IVAR
argument_list|(
name|device_get_parent
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|,
name|PCI_IVAR_DEVID
argument_list|,
operator|&
name|devid
argument_list|)
operator|&&
name|devid
operator|==
name|ATA_I960RM
condition|)
return|return
name|ENXIO
return|;
name|strcpy
argument_list|(
name|buffer
argument_list|,
literal|"Promise "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
name|idx
operator|->
name|text
argument_list|)
expr_stmt|;
comment|/* if we are on a FastTrak TX4, adjust the interrupt resource */
if|if
condition|(
operator|(
name|idx
operator|->
name|cfg2
operator|&
name|PR_TX4
operator|)
operator|&&
name|pci_get_class
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|==
name|PCIC_BRIDGE
operator|&&
operator|!
name|BUS_READ_IVAR
argument_list|(
name|device_get_parent
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|,
name|PCI_IVAR_DEVID
argument_list|,
operator|&
name|devid
argument_list|)
operator|&&
operator|(
operator|(
name|devid
operator|==
name|ATA_DEC_21150
operator|)
operator|||
operator|(
name|devid
operator|==
name|ATA_DEC_21150_1
operator|)
operator|)
condition|)
block|{
specifier|static
name|long
name|start
init|=
literal|0
decl_stmt|,
name|end
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
operator|==
literal|1
condition|)
block|{
name|bus_get_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|" (channel 0+1)"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
operator|==
literal|2
operator|&&
name|start
operator|&&
name|end
condition|)
block|{
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|" (channel 2+3)"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|start
operator|=
name|end
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|buffer
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_promise_chipinit
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|stat_reg
decl_stmt|;
if|if
condition|(
name|ata_setup_interrupt
argument_list|(
name|dev
argument_list|,
name|ata_generic_intr
argument_list|)
condition|)
return|return
name|ENXIO
return|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|PR_NEW
case|:
comment|/* setup clocks */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|,
name|ATA_INB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|)
operator||
literal|0x0a
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|PR_OLD
case|:
comment|/* enable burst mode */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x1f
argument_list|,
name|ATA_INB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x1f
argument_list|)
operator||
literal|0x01
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|ch_attach
operator|=
name|ata_promise_ch_attach
expr_stmt|;
name|ctlr
operator|->
name|ch_detach
operator|=
name|ata_pci_ch_detach
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_promise_setmode
expr_stmt|;
return|return
literal|0
return|;
case|case
name|PR_TX
case|:
name|ctlr
operator|->
name|ch_attach
operator|=
name|ata_promise_tx2_ch_attach
expr_stmt|;
name|ctlr
operator|->
name|ch_detach
operator|=
name|ata_pci_ch_detach
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_promise_setmode
expr_stmt|;
return|return
literal|0
return|;
case|case
name|PR_MIO
case|:
name|ctlr
operator|->
name|r_type1
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid1
operator|=
name|PCIR_BAR
argument_list|(
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res1
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type1
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid1
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
goto|goto
name|failnfree
goto|;
name|ctlr
operator|->
name|r_type2
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|ctlr
operator|->
name|r_rid2
operator|=
name|PCIR_BAR
argument_list|(
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_res2
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
goto|goto
name|failnfree
goto|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SX4X
condition|)
block|{
name|struct
name|ata_promise_sx4
modifier|*
name|hpkt
decl_stmt|;
name|u_int32_t
name|dimm
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0080
argument_list|)
decl_stmt|;
if|if
condition|(
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|ctlr
operator|->
name|handle
argument_list|)
operator|||
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|ATA_INTR_FLAGS
argument_list|,
name|NULL
argument_list|,
name|ata_promise_sx4_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|failnfree
goto|;
block|}
comment|/* print info about cache memory */
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"DIMM size %dMB @ 0x%08x%s\n"
argument_list|,
operator|(
operator|(
operator|(
name|dimm
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
operator|-
operator|(
operator|(
name|dimm
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
operator|+
literal|1
operator|)
operator|<<
literal|4
argument_list|,
operator|(
operator|(
name|dimm
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0088
argument_list|)
operator|&
operator|(
literal|1
operator|<<
literal|16
operator|)
condition|?
literal|" ECC enabled"
else|:
literal|""
argument_list|)
expr_stmt|;
comment|/* adjust cache memory parameters */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c000c
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c000c
argument_list|)
operator|&
literal|0xffff0000
operator|)
argument_list|)
expr_stmt|;
comment|/* setup host packet controls */
name|hpkt
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ata_promise_sx4
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|hpkt
operator|->
name|mtx
argument_list|,
literal|"ATA promise HPKT lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|hpkt
operator|->
name|queue
argument_list|)
expr_stmt|;
name|hpkt
operator|->
name|busy
operator|=
literal|0
expr_stmt|;
name|ctlr
operator|->
name|chipset_data
operator|=
name|hpkt
expr_stmt|;
name|ctlr
operator|->
name|ch_attach
operator|=
name|ata_promise_mio_ch_attach
expr_stmt|;
name|ctlr
operator|->
name|ch_detach
operator|=
name|ata_promise_mio_ch_detach
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_promise_mio_reset
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_promise_setmode
expr_stmt|;
name|ctlr
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* mio type controllers need an interrupt intercept */
if|if
condition|(
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|ctlr
operator|->
name|handle
argument_list|)
operator|||
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|ATA_INTR_FLAGS
argument_list|,
name|NULL
argument_list|,
name|ata_promise_mio_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|failnfree
goto|;
block|}
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|PR_PATA
case|:
name|ctlr
operator|->
name|channels
operator|=
operator|(
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x48
argument_list|)
operator|&
literal|0x01
operator|)
operator|>
literal|0
operator|)
operator|+
operator|(
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x48
argument_list|)
operator|&
literal|0x02
operator|)
operator|>
literal|0
operator|)
operator|+
literal|2
expr_stmt|;
goto|goto
name|sata150
goto|;
case|case
name|PR_CMBO
case|:
name|ctlr
operator|->
name|channels
operator|=
literal|3
expr_stmt|;
goto|goto
name|sata150
goto|;
case|case
name|PR_SATA
case|:
name|ctlr
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
name|sata150
label|:
name|stat_reg
operator|=
literal|0x6c
expr_stmt|;
break|break;
case|case
name|PR_CMBO2
case|:
name|ctlr
operator|->
name|channels
operator|=
literal|3
expr_stmt|;
goto|goto
name|sataii
goto|;
case|case
name|PR_SATA2
case|:
default|default:
name|ctlr
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
name|sataii
label|:
name|stat_reg
operator|=
literal|0x60
expr_stmt|;
break|break;
block|}
comment|/* prime fake interrupt register */
name|ctlr
operator|->
name|chipset_data
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|0xffffffff
expr_stmt|;
comment|/* clear SATA status and unmask interrupts */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|stat_reg
argument_list|,
literal|0x000000ff
argument_list|)
expr_stmt|;
comment|/* enable "long burst length" on gen2 chips */
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SATA2
operator|)
operator|||
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_CMBO2
operator|)
condition|)
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x44
argument_list|,
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x44
argument_list|)
operator||
literal|0x2000
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|ch_attach
operator|=
name|ata_promise_mio_ch_attach
expr_stmt|;
name|ctlr
operator|->
name|ch_detach
operator|=
name|ata_promise_mio_ch_detach
expr_stmt|;
name|ctlr
operator|->
name|reset
operator|=
name|ata_promise_mio_reset
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_promise_mio_setmode
expr_stmt|;
name|ctlr
operator|->
name|getrev
operator|=
name|ata_promise_mio_getrev
expr_stmt|;
return|return
literal|0
return|;
block|}
name|failnfree
label|:
if|if
condition|(
name|ctlr
operator|->
name|r_res2
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type2
argument_list|,
name|ctlr
operator|->
name|r_rid2
argument_list|,
name|ctlr
operator|->
name|r_res2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|r_res1
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_type1
argument_list|,
name|ctlr
operator|->
name|r_rid1
argument_list|,
name|ctlr
operator|->
name|r_res1
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_ch_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_pci_ch_attach
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|PR_NEW
condition|)
block|{
name|ch
operator|->
name|dma
operator|.
name|start
operator|=
name|ata_promise_dmastart
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|stop
operator|=
name|ata_promise_dmastop
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|reset
operator|=
name|ata_promise_dmareset
expr_stmt|;
block|}
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_promise_status
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_ATAPI_DMA
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_CHECKS_CABLE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x1c
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x00004000
else|:
literal|0x00000400
operator|)
condition|)
block|{
return|return
name|ata_pci_status
argument_list|(
name|dev
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_dmastart
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|parent
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|parent
argument_list|)
decl_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_48BIT
condition|)
block|{
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|,
name|ATA_INB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|)
operator||
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x08
else|:
literal|0x02
operator|)
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
name|ch
operator|->
name|unit
condition|?
literal|0x24
else|:
literal|0x20
argument_list|,
operator|(
operator|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
operator|)
condition|?
literal|0x05000000
else|:
literal|0x06000000
operator|)
operator||
operator|(
name|request
operator|->
name|bytecount
operator|>>
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
operator||
operator|(
name|ATA_BMSTAT_INTERRUPT
operator||
name|ATA_BMSTAT_ERROR
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_BMDTP_PORT
argument_list|,
name|request
operator|->
name|dma
operator|->
name|sg_bus
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
operator|(
operator|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
operator|)
condition|?
name|ATA_BMCMD_WRITE_READ
else|:
literal|0
operator|)
operator||
name|ATA_BMCMD_START_STOP
argument_list|)
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|flags
operator||=
name|ATA_DMA_ACTIVE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_dmastop
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|parent
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|parent
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_48BIT
condition|)
block|{
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|,
name|ATA_INB
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
literal|0x11
argument_list|)
operator|&
operator|~
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x08
else|:
literal|0x02
operator|)
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|,
name|ch
operator|->
name|unit
condition|?
literal|0x24
else|:
literal|0x20
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|)
operator|&
operator|~
name|ATA_BMCMD_START_STOP
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|ATA_BMSTAT_INTERRUPT
operator||
name|ATA_BMSTAT_ERROR
argument_list|)
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|flags
operator|&=
operator|~
name|ATA_DMA_ACTIVE
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_dmareset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|)
operator|&
operator|~
name|ATA_BMCMD_START_STOP
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|ATA_BMSTAT_INTERRUPT
operator||
name|ATA_BMSTAT_ERROR
argument_list|)
expr_stmt|;
name|ch
operator|->
name|flags
operator|&=
operator|~
name|ATA_DMA_ACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|target
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|target
decl_stmt|;
name|u_int32_t
name|timings
index|[]
index|[
literal|2
index|]
init|=
block|{
comment|/*    PR_OLD      PR_NEW               mode */
block|{
literal|0x004ff329
block|,
literal|0x004fff2f
block|}
block|,
comment|/* PIO 0 */
block|{
literal|0x004fec25
block|,
literal|0x004ff82a
block|}
block|,
comment|/* PIO 1 */
block|{
literal|0x004fe823
block|,
literal|0x004ff026
block|}
block|,
comment|/* PIO 2 */
block|{
literal|0x004fe622
block|,
literal|0x004fec24
block|}
block|,
comment|/* PIO 3 */
block|{
literal|0x004fe421
block|,
literal|0x004fe822
block|}
block|,
comment|/* PIO 4 */
block|{
literal|0x004567f3
block|,
literal|0x004acef6
block|}
block|,
comment|/* MWDMA 0 */
block|{
literal|0x004467f3
block|,
literal|0x0048cef6
block|}
block|,
comment|/* MWDMA 1 */
block|{
literal|0x004367f3
block|,
literal|0x0046cef6
block|}
block|,
comment|/* MWDMA 2 */
block|{
literal|0x004367f3
block|,
literal|0x0046cef6
block|}
block|,
comment|/* UDMA 0 */
block|{
literal|0x004247f3
block|,
literal|0x00448ef6
block|}
block|,
comment|/* UDMA 1 */
block|{
literal|0x004127f3
block|,
literal|0x00436ef6
block|}
block|,
comment|/* UDMA 2 */
block|{
literal|0
block|,
literal|0x00424ef6
block|}
block|,
comment|/* UDMA 3 */
block|{
literal|0
block|,
literal|0x004127f3
block|}
block|,
comment|/* UDMA 4 */
block|{
literal|0
block|,
literal|0x004127f3
block|}
comment|/* UDMA 5 */
block|}
decl_stmt|;
name|mode
operator|=
name|min
argument_list|(
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|PR_OLD
case|:
case|case
name|PR_NEW
case|:
if|if
condition|(
name|ata_dma_check_80pin
operator|&&
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|(
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x50
argument_list|,
literal|2
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|1
operator|<<
literal|11
else|:
literal|1
operator|<<
literal|10
operator|)
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
break|break;
case|case
name|PR_TX
case|:
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_0
argument_list|,
literal|0x0b
argument_list|)
expr_stmt|;
if|if
condition|(
name|ata_dma_check_80pin
operator|&&
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_1
argument_list|)
operator|&
literal|0x04
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
break|break;
case|case
name|PR_MIO
case|:
if|if
condition|(
name|ata_dma_check_80pin
operator|&&
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|PR_SX4X
condition|?
literal|0x000c0260
else|:
literal|0x0260
operator|)
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|)
operator|&
literal|0x01000000
operator|)
condition|)
block|{
name|ata_print_cable
argument_list|(
name|dev
argument_list|,
literal|"controller"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|<
name|PR_TX
condition|)
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x60
operator|+
operator|(
name|devno
operator|<<
literal|2
operator|)
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
index|[
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
operator|(
name|mode
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_tx2_ch_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_pci_ch_attach
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_promise_tx2_status
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_CHECKS_CABLE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_tx2_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_0
argument_list|,
literal|0x0b
argument_list|)
expr_stmt|;
if|if
condition|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_1
argument_list|)
operator|&
literal|0x20
condition|)
block|{
return|return
name|ata_pci_status
argument_list|(
name|dev
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_ch_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|PR_SX4X
operator|)
condition|?
literal|0x000c0000
else|:
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ata_promise_mio_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ATA_DATA
init|;
name|i
operator|<=
name|ATA_COMMAND
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|offset
operator|=
name|offset
operator|+
literal|0x0200
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
expr_stmt|;
block|}
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|offset
operator|=
name|offset
operator|+
literal|0x0238
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_ADDR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ata_default_registers
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
operator|(
name|PR_SATA
operator||
name|PR_SATA2
operator|)
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
operator|(
name|PR_CMBO
operator||
name|PR_CMBO2
operator|)
operator|)
operator|&&
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
condition|)
block|{
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
literal|0x400
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
literal|0x404
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_res2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
literal|0x408
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_SATA
expr_stmt|;
block|}
name|ch
operator|->
name|flags
operator||=
name|ATA_USE_16BIT
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_CHECKS_CABLE
expr_stmt|;
name|ata_generic_hw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|PR_SX4X
condition|)
block|{
name|ch
operator|->
name|hw
operator|.
name|command
operator|=
name|ata_promise_sx4_command
expr_stmt|;
block|}
else|else
block|{
name|ch
operator|->
name|hw
operator|.
name|command
operator|=
name|ata_promise_mio_command
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|ata_promise_mio_status
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|softreset
operator|=
name|ata_promise_mio_softreset
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|pm_read
operator|=
name|ata_promise_mio_pm_read
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|pm_write
operator|=
name|ata_promise_mio_pm_write
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_ch_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|ata_dmafini
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_mio_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|vector
decl_stmt|;
name|int
name|unit
decl_stmt|;
comment|/*      * since reading interrupt status register on early "mio" chips      * clears the status bits we cannot read it for each channel later on      * in the generic interrupt routine.      */
name|vector
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x040
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x040
argument_list|,
name|vector
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipset_data
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|vector
expr_stmt|;
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|ctlr
operator|->
name|channels
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
name|ctlr
operator|->
name|chipset_data
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|0xffffffff
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int32_t
name|stat_reg
decl_stmt|,
name|vector
decl_stmt|,
name|status
decl_stmt|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|PR_PATA
case|:
case|case
name|PR_CMBO
case|:
case|case
name|PR_SATA
case|:
name|stat_reg
operator|=
literal|0x6c
expr_stmt|;
break|break;
case|case
name|PR_CMBO2
case|:
case|case
name|PR_SATA2
case|:
default|default:
name|stat_reg
operator|=
literal|0x60
expr_stmt|;
break|break;
block|}
comment|/* read and acknowledge interrupt */
name|vector
operator|=
operator|(
name|uint32_t
operator|)
operator|(
name|uintptr_t
operator|)
name|ctlr
operator|->
name|chipset_data
expr_stmt|;
comment|/* read and clear interface status */
name|status
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|stat_reg
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
name|stat_reg
argument_list|,
name|status
operator|&
operator|(
literal|0x00000011
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
comment|/* check for and handle disconnect events */
if|if
condition|(
name|status
operator|&
operator|(
literal|0x00000001
operator|<<
name|ch
operator|->
name|unit
operator|)
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"DISCONNECT requested\n"
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|ch
operator|->
name|conntask
argument_list|)
expr_stmt|;
block|}
comment|/* check for and handle connect events */
if|if
condition|(
name|status
operator|&
operator|(
literal|0x00000010
operator|<<
name|ch
operator|->
name|unit
operator|)
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"CONNECT requested\n"
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|taskqueue_thread
argument_list|,
operator|&
name|ch
operator|->
name|conntask
argument_list|)
expr_stmt|;
block|}
comment|/* do we have any device action ? */
return|return
operator|(
name|vector
operator|&
operator|(
literal|1
operator|<<
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_command
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|parent
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|parent
argument_list|)
decl_stmt|;
name|u_int32_t
modifier|*
name|wordp
init|=
operator|(
name|u_int32_t
operator|*
operator|)
name|ch
operator|->
name|dma
operator|.
name|work
decl_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|2
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SATA2
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_CMBO2
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
block|{
comment|/* set portmultiplier port */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x4e8
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|,
name|request
operator|->
name|unit
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
block|}
comment|/* XXX SOS add ATAPI commands support later */
switch|switch
condition|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
condition|)
block|{
default|default:
return|return
name|ata_generic_command
argument_list|(
name|request
argument_list|)
return|;
case|case
name|ATA_READ_DMA
case|:
case|case
name|ATA_READ_DMA48
case|:
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x04
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x00
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_WRITE_DMA
case|:
case|case
name|ATA_WRITE_DMA48
case|:
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x00
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x00
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|wordp
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
name|request
operator|->
name|dma
operator|->
name|sg_bus
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|ata_promise_apkt
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|)
name|wordp
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0240
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_bus
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_mio_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_promise_sx4
modifier|*
name|hpktp
decl_stmt|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
condition|)
block|{
case|case
name|PR_SX4X
case|:
comment|/* softreset channel ATA module */
name|hpktp
operator|=
name|ctlr
operator|->
name|chipset_data
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
name|ch
operator|->
name|unit
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ata_udelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|)
operator|&
operator|~
literal|0x00003f9f
operator|)
operator||
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* softreset HOST module */
comment|/* XXX SOS what about other outstandings */
name|mtx_lock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc012c
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc012c
argument_list|)
operator|&
operator|~
literal|0x00000f9f
operator|)
operator||
operator|(
literal|1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc012c
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0xc012c
argument_list|)
operator|&
operator|~
literal|0x00000f9f
operator|)
argument_list|)
expr_stmt|;
name|hpktp
operator|->
name|busy
operator|=
literal|0
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|PR_PATA
case|:
case|case
name|PR_CMBO
case|:
case|case
name|PR_SATA
case|:
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SATA
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_CMBO
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
block|{
comment|/* mask plug/unplug intr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x06c
argument_list|,
operator|(
literal|0x00110000
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* softreset channels ATA module */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
operator|(
literal|1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
name|ata_udelay
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|)
operator|&
operator|~
literal|0x00003f9f
operator|)
operator||
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SATA
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_CMBO
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
else|else
name|ch
operator|->
name|devices
operator|=
literal|0
expr_stmt|;
comment|/* reset and enable plug/unplug intr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x06c
argument_list|,
operator|(
literal|0x00000011
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|PR_CMBO2
case|:
case|case
name|PR_SATA2
case|:
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SATA2
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_CMBO2
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
block|{
comment|/* set portmultiplier port */
comment|//ATA_OUTL(ctlr->r_res2, 0x4e8 + (ch->unit<< 8), 0x0f);
comment|/* mask plug/unplug intr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x060
argument_list|,
operator|(
literal|0x00110000
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* softreset channels ATA module */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
operator|(
literal|1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
name|ata_udelay
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x0260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|)
operator|&
operator|~
literal|0x00003f9f
operator|)
operator||
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SATA2
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_CMBO2
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
block|{
comment|/* set PHY mode to "improved" */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x414
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|,
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x414
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|)
operator|&
operator|~
literal|0x00000003
operator|)
operator||
literal|0x00000001
argument_list|)
expr_stmt|;
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|u_int32_t
name|signature
init|=
name|ch
operator|->
name|hw
operator|.
name|softreset
argument_list|(
name|dev
argument_list|,
name|ATA_PM
argument_list|)
decl_stmt|;
if|if
condition|(
literal|1
operator||
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"SIGNATURE: %08x\n"
argument_list|,
name|signature
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|signature
operator|>>
literal|16
condition|)
block|{
case|case
literal|0x0000
case|:
name|ch
operator|->
name|devices
operator|=
name|ATA_ATA_MASTER
expr_stmt|;
break|break;
case|case
literal|0x9669
case|:
name|ch
operator|->
name|devices
operator|=
name|ATA_PORTMULTIPLIER
expr_stmt|;
name|ata_pm_identify
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xeb14
case|:
name|ch
operator|->
name|devices
operator|=
name|ATA_ATAPI_MASTER
expr_stmt|;
break|break;
default|default:
comment|/* SOS XXX */
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"No signature, assuming disk device\n"
argument_list|)
expr_stmt|;
name|ch
operator|->
name|devices
operator|=
name|ATA_ATA_MASTER
expr_stmt|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"promise_mio_reset devices=%08x\n"
argument_list|,
name|ch
operator|->
name|devices
argument_list|)
expr_stmt|;
block|}
else|else
name|ch
operator|->
name|devices
operator|=
literal|0
expr_stmt|;
comment|/* reset and enable plug/unplug intr */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x060
argument_list|,
operator|(
literal|0x00000011
operator|<<
name|ch
operator|->
name|unit
operator|)
argument_list|)
expr_stmt|;
comment|///* set portmultiplier port */
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x4e8
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
block|}
else|else
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_pm_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|reg
parameter_list|,
name|u_int32_t
modifier|*
name|result
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|timeout
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|port
operator|<
literal|0
condition|)
block|{
operator|*
name|result
operator|=
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|port
operator|<
name|ATA_PM
condition|)
block|{
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|ATA_SSTATUS
case|:
name|reg
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ATA_SERROR
case|:
name|reg
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ATA_SCONTROL
case|:
name|reg
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
comment|/* set portmultiplier port */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x4e8
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|,
literal|0x0f
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_FEATURE
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_DRIVE
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_COMMAND
argument_list|,
name|ATA_READ_PM
argument_list|)
expr_stmt|;
while|while
condition|(
name|timeout
operator|<
literal|1000000
condition|)
block|{
name|u_int8_t
name|status
init|=
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_STATUS
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|status
operator|&
name|ATA_S_BUSY
operator|)
condition|)
break|break;
name|timeout
operator|+=
literal|1000
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timeout
operator|>=
literal|1000000
condition|)
return|return
name|ATA_E_ABORT
return|;
operator|*
name|result
operator|=
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_COUNT
argument_list|)
operator||
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|)
operator|<<
literal|24
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_pm_write
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|reg
parameter_list|,
name|u_int32_t
name|value
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|timeout
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|port
operator|<
literal|0
condition|)
block|{
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|reg
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|port
operator|<
name|ATA_PM
condition|)
block|{
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|ATA_SSTATUS
case|:
name|reg
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ATA_SERROR
case|:
name|reg
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ATA_SCONTROL
case|:
name|reg
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
comment|/* set portmultiplier port */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x4e8
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|,
literal|0x0f
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_FEATURE
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_DRIVE
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_COUNT
argument_list|,
name|value
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|,
operator|(
name|value
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|,
operator|(
name|value
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|,
operator|(
name|value
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_COMMAND
argument_list|,
name|ATA_WRITE_PM
argument_list|)
expr_stmt|;
while|while
condition|(
name|timeout
operator|<
literal|1000000
condition|)
block|{
name|u_int8_t
name|status
init|=
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_STATUS
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|status
operator|&
name|ATA_S_BUSY
operator|)
condition|)
break|break;
name|timeout
operator|+=
literal|1000
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timeout
operator|>=
literal|1000000
condition|)
return|return
name|ATA_E_ABORT
return|;
return|return
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_ERROR
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* must be called with ATA channel locked and state_mtx held */
end_comment

begin_function
specifier|static
name|u_int32_t
name|ata_promise_mio_softreset
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|timeout
decl_stmt|;
comment|/* set portmultiplier port */
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x4e8
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|8
operator|)
argument_list|,
name|port
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
comment|/* softreset device on this channel */
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_DRIVE
argument_list|,
name|ATA_D_IBM
operator||
name|ATA_D_LBA
operator||
name|ATA_DEV
argument_list|(
name|ATA_MASTER
argument_list|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_CONTROL
argument_list|,
name|ATA_A_IDS
operator||
name|ATA_A_RESET
argument_list|)
expr_stmt|;
name|ata_udelay
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_CONTROL
argument_list|,
name|ATA_A_IDS
argument_list|)
expr_stmt|;
name|ata_udelay
argument_list|(
literal|150000
argument_list|)
expr_stmt|;
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_ERROR
argument_list|)
expr_stmt|;
comment|/* wait for BUSY to go inactive */
for|for
control|(
name|timeout
operator|=
literal|0
init|;
name|timeout
operator|<
literal|100
condition|;
name|timeout
operator|++
control|)
block|{
name|u_int8_t
name|err
decl_stmt|,
name|stat
decl_stmt|;
name|err
operator|=
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_ERROR
argument_list|)
expr_stmt|;
name|stat
operator|=
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_STATUS
argument_list|)
expr_stmt|;
comment|//if (stat == err&& timeout> (stat& ATA_S_BUSY ? 100 : 10))
comment|//break;
if|if
condition|(
operator|!
operator|(
name|stat
operator|&
name|ATA_S_BUSY
operator|)
condition|)
block|{
comment|//if ((err& 0x7f) == ATA_E_ILI) {
return|return
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_COUNT
argument_list|)
operator||
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_SECTOR
argument_list|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_LSB
argument_list|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_CYL_MSB
argument_list|)
operator|<<
literal|24
operator|)
return|;
comment|//}
comment|//else if (stat& 0x0f) {
comment|//stat |= ATA_S_BUSY;
comment|//}
block|}
if|if
condition|(
operator|!
operator|(
name|stat
operator|&
name|ATA_S_BUSY
operator|)
operator|||
operator|(
name|stat
operator|==
literal|0xff
operator|&&
name|timeout
operator|>
literal|10
operator|)
condition|)
break|break;
name|ata_udelay
argument_list|(
literal|100000
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_mio_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* note start and stop are not used here */
name|ch
operator|->
name|dma
operator|.
name|setprd
operator|=
name|ata_promise_mio_setprd
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|max_iosize
operator|=
literal|65536
expr_stmt|;
name|ata_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|MAXLASTSGSIZE
value|(32 * sizeof(u_int32_t))
end_define

begin_function
specifier|static
name|void
name|ata_promise_mio_setprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|ata_dmasetprd_args
modifier|*
name|args
init|=
name|xsc
decl_stmt|;
name|struct
name|ata_dma_prdentry
modifier|*
name|prd
init|=
name|args
operator|->
name|dmatab
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|args
operator|->
name|error
operator|=
name|error
operator|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|prd
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|count
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|segs
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|ds_len
operator|>
name|MAXLASTSGSIZE
condition|)
block|{
comment|//printf("split last SG element of %u\n", segs[i - 1].ds_len);
name|prd
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|count
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|ds_len
operator|-
name|MAXLASTSGSIZE
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|count
operator|=
name|htole32
argument_list|(
name|MAXLASTSGSIZE
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|ds_addr
operator|+
operator|(
name|segs
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|ds_len
operator|-
name|MAXLASTSGSIZE
operator|)
argument_list|)
expr_stmt|;
name|nsegs
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|prd
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|count
operator||=
name|htole32
argument_list|(
name|ATA_DMA_EOT
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|nsegs
operator|<=
name|ATA_DMA_ENTRIES
argument_list|,
operator|(
literal|"too many DMA segment entries\n"
operator|)
argument_list|)
expr_stmt|;
name|args
operator|->
name|nsegs
operator|=
name|nsegs
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|target
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SATA
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_CMBO
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
operator|||
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SATA2
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_CMBO2
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
name|mode
operator|=
name|ata_sata_setmode
argument_list|(
name|dev
argument_list|,
name|target
argument_list|,
name|mode
argument_list|)
expr_stmt|;
else|else
name|mode
operator|=
name|ata_promise_setmode
argument_list|(
name|dev
argument_list|,
name|target
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
operator|(
name|mode
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_getrev
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|target
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SATA
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_CMBO
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
operator|||
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_SATA2
operator|)
operator|||
operator|(
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|PR_CMBO2
operator|)
operator|&&
operator|(
name|ch
operator|->
name|unit
operator|<
literal|2
operator|)
operator|)
condition|)
return|return
operator|(
name|ata_sata_getrev
argument_list|(
name|dev
argument_list|,
name|target
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_sx4_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|vector
init|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0480
argument_list|)
decl_stmt|;
name|int
name|unit
decl_stmt|;
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|ctlr
operator|->
name|channels
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
name|vector
operator|&
operator|(
literal|1
operator|<<
operator|(
name|unit
operator|+
literal|1
operator|)
operator|)
condition|)
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|vector
operator|&
operator|(
literal|1
operator|<<
operator|(
name|unit
operator|+
literal|5
operator|)
operator|)
condition|)
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ata_promise_queue_hpkt
argument_list|(
name|ctlr
argument_list|,
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_HPKT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vector
operator|&
operator|(
literal|1
operator|<<
operator|(
name|unit
operator|+
literal|9
operator|)
operator|)
condition|)
block|{
name|ata_promise_next_hpkt
argument_list|(
name|ctlr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vector
operator|&
operator|(
literal|1
operator|<<
operator|(
name|unit
operator|+
literal|13
operator|)
operator|)
condition|)
block|{
name|ata_promise_next_hpkt
argument_list|(
name|ctlr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0240
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_APKT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_sx4_command
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|device_t
name|gparent
init|=
name|device_get_parent
argument_list|(
name|request
operator|->
name|parent
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|gparent
argument_list|)
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|parent
argument_list|)
decl_stmt|;
name|struct
name|ata_dma_prdentry
modifier|*
name|prd
decl_stmt|;
name|caddr_t
name|window
init|=
name|rman_get_virtual
argument_list|(
name|ctlr
operator|->
name|r_res1
argument_list|)
decl_stmt|;
name|u_int32_t
modifier|*
name|wordp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|idx
decl_stmt|,
name|length
init|=
literal|0
decl_stmt|;
comment|/* XXX SOS add ATAPI commands support later */
switch|switch
condition|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
condition|)
block|{
default|default:
return|return
operator|-
literal|1
return|;
case|case
name|ATA_ATA_IDENTIFY
case|:
case|case
name|ATA_READ
case|:
case|case
name|ATA_READ48
case|:
case|case
name|ATA_READ_MUL
case|:
case|case
name|ATA_READ_MUL48
case|:
case|case
name|ATA_WRITE
case|:
case|case
name|ATA_WRITE48
case|:
case|case
name|ATA_WRITE_MUL
case|:
case|case
name|ATA_WRITE_MUL48
case|:
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
return|return
name|ata_generic_command
argument_list|(
name|request
argument_list|)
return|;
case|case
name|ATA_SETFEATURES
case|:
case|case
name|ATA_FLUSHCACHE
case|:
case|case
name|ATA_FLUSHCACHE48
case|:
case|case
name|ATA_SLEEP
case|:
case|case
name|ATA_SET_MULTI
case|:
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_APKT_OFFSET
operator|)
expr_stmt|;
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x08
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x00
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|wordp
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|ata_promise_apkt
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|)
name|wordp
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0484
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0240
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_APKT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ATA_READ_DMA
case|:
case|case
name|ATA_READ_DMA48
case|:
case|case
name|ATA_WRITE_DMA
case|:
case|case
name|ATA_WRITE_DMA48
case|:
name|prd
operator|=
name|request
operator|->
name|dma
operator|->
name|sg
expr_stmt|;
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_HSG_OFFSET
operator|)
expr_stmt|;
name|i
operator|=
name|idx
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|wordp
index|[
name|idx
operator|++
index|]
operator|=
name|prd
index|[
name|i
index|]
operator|.
name|addr
expr_stmt|;
name|wordp
index|[
name|idx
operator|++
index|]
operator|=
name|prd
index|[
name|i
index|]
operator|.
name|count
expr_stmt|;
name|length
operator|+=
operator|(
name|prd
index|[
name|i
index|]
operator|.
name|count
operator|&
operator|~
name|ATA_DMA_EOT
operator|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
operator|(
name|prd
index|[
name|i
operator|++
index|]
operator|.
name|count
operator|&
name|ATA_DMA_EOT
operator|)
condition|)
do|;
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_LSG_OFFSET
operator|)
expr_stmt|;
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_BUF_OFFSET
operator|)
operator|+
name|ATA_PDC_BUF_BASE
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
name|request
operator|->
name|bytecount
operator||
name|ATA_DMA_EOT
argument_list|)
expr_stmt|;
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_ASG_OFFSET
operator|)
expr_stmt|;
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_BUF_OFFSET
operator|)
operator|+
name|ATA_PDC_BUF_BASE
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
name|request
operator|->
name|bytecount
operator||
name|ATA_DMA_EOT
argument_list|)
expr_stmt|;
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_HPKT_OFFSET
operator|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|)
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x14
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|9
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|5
operator|)
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_WRITE
condition|)
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x00
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|13
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x00
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_HSG_OFFSET
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|2
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_LSG_OFFSET
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|wordp
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|window
operator|+
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_APKT_OFFSET
operator|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|)
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x04
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|5
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x00
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_WRITE
condition|)
name|wordp
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
literal|0x10
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|13
operator|)
operator|<<
literal|24
operator|)
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_ASG_OFFSET
argument_list|)
expr_stmt|;
name|wordp
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|ata_promise_apkt
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|)
name|wordp
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0484
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|5
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|9
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0240
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
argument_list|,
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_APKT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_WRITE
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|1
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0400
operator|+
operator|(
operator|(
name|ch
operator|->
name|unit
operator|+
literal|13
operator|)
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ata_promise_queue_hpkt
argument_list|(
name|ctlr
argument_list|,
name|htole32
argument_list|(
operator|(
name|ch
operator|->
name|unit
operator|*
name|ATA_PDC_CHN_OFFSET
operator|)
operator|+
name|ATA_PDC_HPKT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_apkt
parameter_list|(
name|u_int8_t
modifier|*
name|bytep
parameter_list|,
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|int
name|i
init|=
literal|12
decl_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_PDC_WAIT_NBUSY
operator||
name|ATA_DRIVE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_D_IBM
operator||
name|ATA_D_LBA
operator||
name|ATA_DEV
argument_list|(
name|request
operator|->
name|unit
argument_list|)
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_CTL
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_A_4BIT
expr_stmt|;
if|if
condition|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_48BIT
condition|)
block|{
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_2B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_FEATURE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
operator|>>
literal|8
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_2B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_COUNT
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
operator|>>
literal|8
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_2B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_SECTOR
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_2B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_CYL_LSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|32
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_2B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_CYL_MSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|40
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_DRIVE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_D_LBA
operator||
name|ATA_DEV
argument_list|(
name|request
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_FEATURE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_COUNT
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_SECTOR
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_CYL_LSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_CYL_MSB
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_REG
operator||
name|ATA_DRIVE
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_D_LBA
operator||
name|ATA_D_IBM
operator||
name|ATA_DEV
argument_list|(
name|request
operator|->
name|unit
argument_list|)
operator||
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
block|}
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|ATA_PDC_1B
operator||
name|ATA_PDC_WRITE_END
operator||
name|ATA_COMMAND
expr_stmt|;
name|bytep
index|[
name|i
operator|++
index|]
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
expr_stmt|;
return|return
name|i
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_queue_hpkt
parameter_list|(
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
parameter_list|,
name|u_int32_t
name|hpkt
parameter_list|)
block|{
name|struct
name|ata_promise_sx4
modifier|*
name|hpktp
init|=
name|ctlr
operator|->
name|chipset_data
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|hpktp
operator|->
name|busy
condition|)
block|{
name|struct
name|host_packet
modifier|*
name|hp
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|host_packet
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
decl_stmt|;
name|hp
operator|->
name|addr
operator|=
name|hpkt
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|hpktp
operator|->
name|queue
argument_list|,
name|hp
argument_list|,
name|chain
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hpktp
operator|->
name|busy
operator|=
literal|1
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0100
argument_list|,
name|hpkt
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_next_hpkt
parameter_list|(
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
parameter_list|)
block|{
name|struct
name|ata_promise_sx4
modifier|*
name|hpktp
init|=
name|ctlr
operator|->
name|chipset_data
decl_stmt|;
name|struct
name|host_packet
modifier|*
name|hp
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|hpktp
operator|->
name|queue
argument_list|)
operator|)
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|hpktp
operator|->
name|queue
argument_list|,
name|hp
argument_list|,
name|chain
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_res2
argument_list|,
literal|0x000c0100
argument_list|,
name|hp
operator|->
name|addr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|hp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
block|}
else|else
name|hpktp
operator|->
name|busy
operator|=
literal|0
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|hpktp
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|ATA_DECLARE_DRIVER
argument_list|(
name|ata_promise
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1998 - 2003 SÃ¸ren Schmidt<sos@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ata.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/ata.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-all.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-pci.h>
end_include

begin_comment
comment|/* misc defines */
end_comment

begin_define
define|#
directive|define
name|GRANDPARENT
parameter_list|(
name|dev
parameter_list|)
value|device_get_parent(device_get_parent(dev))
end_define

begin_define
define|#
directive|define
name|ATAPI_DEVICE
parameter_list|(
name|atadev
parameter_list|)
define|\
value|((atadev->unit == ATA_MASTER&& \ 				atadev->channel->devices& ATA_ATAPI_MASTER) ||\ 				(atadev->unit == ATA_SLAVE&& \ 				atadev->channel->devices& ATA_ATAPI_SLAVE))
end_define

begin_comment
comment|/* local prototypes */
end_comment

begin_function_decl
specifier|static
name|int
name|ata_generic_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_generic_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_generic_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_acard_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_acard_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_acard_850_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_acard_86X_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_ali_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_ali_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_amd_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_cyrix_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_cyrix_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_cypress_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_cypress_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_highpoint_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_highpoint_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_highpoint_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_highpoint_check_80pin
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_intel_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_intel_old_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_intel_new_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_nvidia_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_via_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_via_family_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_via_southbridge_fixup
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_allocate
parameter_list|(
name|device_t
parameter_list|,
name|struct
name|ata_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_old_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_tx2_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_mio_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_promise_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_old_dmainit
parameter_list|(
name|struct
name|ata_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_old_dmastart
parameter_list|(
name|struct
name|ata_channel
modifier|*
parameter_list|,
name|caddr_t
parameter_list|,
name|int32_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_old_dmastop
parameter_list|(
name|struct
name|ata_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_dmainit
parameter_list|(
name|struct
name|ata_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_dmastart
parameter_list|(
name|struct
name|ata_channel
modifier|*
parameter_list|,
name|caddr_t
parameter_list|,
name|int32_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_promise_mio_dmastop
parameter_list|(
name|struct
name|ata_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_serverworks_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_serverworks_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_sii_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_cmd_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_sii_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_cmd_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_sis_chipinit
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_sis_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_mode2idx
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_check_80pin
parameter_list|(
name|struct
name|ata_device
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ata_chip_id
modifier|*
name|ata_find_chip
parameter_list|(
name|device_t
parameter_list|,
name|struct
name|ata_chip_id
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ata_chip_id
modifier|*
name|ata_match_chip
parameter_list|(
name|device_t
parameter_list|,
name|struct
name|ata_chip_id
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ata_default_interrupt
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ata_pci_serialize
parameter_list|(
name|struct
name|ata_channel
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* generic or unknown ATA chipset init code */
end_comment

begin_function
name|int
name|ata_generic_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"GENERIC ATA controller"
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_generic_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_generic_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_default_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_generic_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_generic_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int8_t
name|dmastat
decl_stmt|;
name|int
name|unit
decl_stmt|;
comment|/* implement this as a toggle instead to balance load XXX */
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
literal|2
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
continue|continue;
if|if
condition|(
name|ch
operator|->
name|dma
operator|->
name|flags
operator|&
name|ATA_DMA_ACTIVE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|dmastat
operator|=
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
operator|&
name|ATA_BMSTAT_MASK
operator|)
operator|)
operator|&
name|ATA_BMSTAT_INTERRUPT
operator|)
condition|)
continue|continue;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|dmastat
operator||
name|ATA_BMSTAT_INTERRUPT
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_generic_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_DMA
condition|)
name|atadev
operator|->
name|mode
operator|=
name|ATA_DMA
expr_stmt|;
else|else
name|atadev
operator|->
name|mode
operator|=
name|ATA_PIO
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Acard chipset support functions  */
end_comment

begin_function
name|int
name|ata_acard_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_ATP850R
block|,
literal|0
block|,
name|ATPOLD
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"Acard ATP850"
block|}
block|,
block|{
name|ATA_ATP860A
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"Acard ATP860A"
block|}
block|,
block|{
name|ATA_ATP860R
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"Acard ATP860R"
block|}
block|,
block|{
name|ATA_ATP865A
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"Acard ATP865A"
block|}
block|,
block|{
name|ATA_ATP865R
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"Acard ATP865R"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_acard_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_acard_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|rid
init|=
name|ATA_IRQ_RID
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_irq
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
operator|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|INTR_TYPE_BIO
operator||
name|INTR_ENTROPY
argument_list|,
name|ata_acard_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|ATPOLD
condition|)
block|{
name|ctlr
operator|->
name|setmode
operator|=
name|ata_acard_850_setmode
expr_stmt|;
name|ctlr
operator|->
name|locking
operator|=
name|ata_pci_serialize
expr_stmt|;
block|}
else|else
name|ctlr
operator|->
name|setmode
operator|=
name|ata_acard_86X_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_acard_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int8_t
name|dmastat
decl_stmt|;
name|int
name|unit
decl_stmt|;
comment|/* implement this as a toggle instead to balance load XXX */
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
literal|2
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|ATPOLD
operator|&&
name|ctlr
operator|->
name|locked_ch
operator|!=
name|unit
condition|)
continue|continue;
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dma
operator|->
name|flags
operator|&
name|ATA_DMA_ACTIVE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|dmastat
operator|=
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
operator|&
name|ATA_BMSTAT_MASK
operator|)
operator|)
operator|&
name|ATA_BMSTAT_INTERRUPT
operator|)
condition|)
continue|continue;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|dmastat
operator||
name|ATA_BMSTAT_INTERRUPT
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|)
operator|&
operator|~
name|ATA_BMCMD_START_STOP
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_acard_850_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ATAPI_DEVICE
argument_list|(
name|atadev
argument_list|)
condition|?
name|ATA_PIO_MAX
else|:
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
comment|/* XXX missing WDMA0+1 + PIO modes */
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA2
condition|)
block|{
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|u_int8_t
name|reg54
init|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|reg54
operator|&=
operator|~
operator|(
literal|0x03
operator|<<
operator|(
name|devno
operator|<<
literal|1
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
name|reg54
operator||=
operator|(
operator|(
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|+
literal|1
operator|)
operator|<<
operator|(
name|devno
operator|<<
literal|1
operator|)
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
name|reg54
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x4a
argument_list|,
literal|0xa6
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|1
operator|)
argument_list|,
literal|0x0301
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
return|return;
block|}
block|}
comment|/* we could set PIO mode timings, but we assume the BIOS did that */
block|}
end_function

begin_function
specifier|static
name|void
name|ata_acard_86X_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ATAPI_DEVICE
argument_list|(
name|atadev
argument_list|)
condition|?
name|ATA_PIO_MAX
else|:
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
comment|/* XXX missing WDMA0+1 + PIO modes */
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA2
condition|)
block|{
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|u_int16_t
name|reg44
init|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x44
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|reg44
operator|&=
operator|~
operator|(
literal|0x000f
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
name|reg44
operator||=
operator|(
operator|(
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|+
literal|1
operator|)
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x44
argument_list|,
name|reg44
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x4a
argument_list|,
literal|0xa6
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x40
operator|+
name|devno
argument_list|,
literal|0x31
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
return|return;
block|}
block|}
comment|/* we could set PIO mode timings, but we assume the BIOS did that */
block|}
end_function

begin_comment
comment|/*  * Acer Labs Inc (ALI) chipset support functions  */
end_comment

begin_function
name|int
name|ata_ali_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_ALI_5229
block|,
literal|0xc4
block|,
literal|0
block|,
name|ALINEW
block|,
name|ATA_UDMA5
block|,
literal|"AcerLabs Aladdin"
block|}
block|,
block|{
name|ATA_ALI_5229
block|,
literal|0xc2
block|,
literal|0
block|,
name|ALINEW
block|,
name|ATA_UDMA4
block|,
literal|"AcerLabs Aladdin"
block|}
block|,
block|{
name|ATA_ALI_5229
block|,
literal|0x20
block|,
literal|0
block|,
name|ALIOLD
block|,
name|ATA_UDMA2
block|,
literal|"AcerLabs Aladdin"
block|}
block|,
block|{
name|ATA_ALI_5229
block|,
literal|0x00
block|,
literal|0
block|,
name|ALIOLD
block|,
name|ATA_WDMA2
block|,
literal|"AcerLabs Aladdin"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_ali_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_ali_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_default_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* deactivate the ATAPI FIFO and enable ATAPI UDMA */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x53
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x53
argument_list|,
literal|1
argument_list|)
operator||
literal|0x03
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* enable cable detection and UDMA support on newer chips */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|ALINEW
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x4b
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x4b
argument_list|,
literal|1
argument_list|)
operator||
literal|0x09
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_ali_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_ali_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|ALINEW
condition|)
block|{
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x4a
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|)
condition|)
block|{
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"DMA limited to UDMA33, non-ATA66 cable or device\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
block|}
else|else
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|ALIOLD
condition|)
block|{
comment|/* doesn't support ATAPI DMA on write */
name|atadev
operator|->
name|channel
operator|->
name|flags
operator||=
name|ATA_ATAPI_DMA_RO
expr_stmt|;
if|if
condition|(
name|atadev
operator|->
name|channel
operator|->
name|devices
operator|&
name|ATA_ATAPI_MASTER
operator|&&
name|atadev
operator|->
name|channel
operator|->
name|devices
operator|&
name|ATA_ATAPI_SLAVE
condition|)
block|{
comment|/* doesn't support ATAPI DMA on two ATAPI devices */
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"two atapi devices on this channel, no DMA\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ATA_PIO_MAX
argument_list|)
expr_stmt|;
block|}
block|}
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|u_int8_t
name|udma
index|[]
init|=
block|{
literal|0x0c
block|,
literal|0x0b
block|,
literal|0x0a
block|,
literal|0x09
block|,
literal|0x08
block|,
literal|0x0f
block|}
decl_stmt|;
name|u_int32_t
name|word54
init|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
literal|4
argument_list|)
decl_stmt|;
name|word54
operator|&=
operator|~
operator|(
literal|0x000f000f
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|word54
operator||=
operator|(
operator|(
operator|(
name|udma
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
operator|<<
literal|16
operator|)
operator||
literal|0x05
operator|)
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
name|word54
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x58
operator|+
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|2
operator|)
argument_list|,
literal|0x00310001
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u_int32_t
name|piotimings
index|[]
init|=
block|{
literal|0x006d0003
block|,
literal|0x00580002
block|,
literal|0x00440001
block|,
literal|0x00330001
block|,
literal|0x00310001
block|,
literal|0x00440001
block|,
literal|0x00330001
block|,
literal|0x00310001
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
operator|(
literal|0x0008000f
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x58
operator|+
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|2
operator|)
argument_list|,
name|piotimings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * American Micro Devices (AMD) support function  */
end_comment

begin_function
name|int
name|ata_amd_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_AMD756
block|,
literal|0x00
block|,
name|AMDNVIDIA
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"AMD 756"
block|}
block|,
block|{
name|ATA_AMD766
block|,
literal|0x00
block|,
name|AMDNVIDIA
block|,
name|AMDCABLE
operator||
name|AMDBUG
block|,
name|ATA_UDMA5
block|,
literal|"AMD 766"
block|}
block|,
block|{
name|ATA_AMD768
block|,
literal|0x00
block|,
name|AMDNVIDIA
block|,
name|AMDCABLE
block|,
name|ATA_UDMA5
block|,
literal|"AMD 768"
block|}
block|,
block|{
name|ATA_AMD8111
block|,
literal|0x00
block|,
name|AMDNVIDIA
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"AMD 8111"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_amd_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_amd_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_default_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* set prefetch, postwrite */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|AMDBUG
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x0f
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
literal|1
argument_list|)
operator||
literal|0xf0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_via_family_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Cyrix chipset support functions  */
end_comment

begin_function
name|int
name|ata_cyrix_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|ATA_CYRIX_5530
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Cyrix 5530 ATA33 controller"
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_cyrix_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_cyrix_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_default_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|r_io1
condition|)
name|ctlr
operator|->
name|setmode
operator|=
name|ata_cyrix_setmode
expr_stmt|;
else|else
name|ctlr
operator|->
name|setmode
operator|=
name|ata_generic_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_cyrix_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|ata_channel
modifier|*
name|ch
init|=
name|atadev
operator|->
name|channel
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|u_int32_t
name|piotiming
index|[]
init|=
block|{
literal|0x00009172
block|,
literal|0x00012171
block|,
literal|0x00020080
block|,
literal|0x00032010
block|,
literal|0x00040010
block|}
decl_stmt|;
name|u_int32_t
name|dmatiming
index|[]
init|=
block|{
literal|0x00077771
block|,
literal|0x00012121
block|,
literal|0x00002020
block|}
decl_stmt|;
name|u_int32_t
name|udmatiming
index|[]
init|=
block|{
literal|0x00921250
block|,
literal|0x00911140
block|,
literal|0x00911030
block|}
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ATA_UDMA2
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|channel
operator|->
name|dma
operator|->
name|alignment
operator|=
literal|16
expr_stmt|;
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on Cyrix chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCMD_PORT
index|]
operator|.
name|res
argument_list|,
literal|0x24
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
name|udmatiming
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA0
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCMD_PORT
index|]
operator|.
name|res
argument_list|,
literal|0x24
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
name|dmatiming
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCMD_PORT
index|]
operator|.
name|res
argument_list|,
literal|0x20
operator|+
operator|(
name|devno
operator|<<
literal|3
operator|)
argument_list|,
name|piotiming
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|)
expr_stmt|;
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Cypress chipset support functions  */
end_comment

begin_function
name|int
name|ata_cypress_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/*      * the Cypress chip is a mess, it contains two ATA functions, but      * both channels are visible on the first one.      * simply ignore the second function for now, as the right      * solution (ignoring the second channel on the first function)      * doesn't work with the crappy ATA interrupt setup on the alpha.      */
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|ATA_CYPRESS_82C693
operator|&&
name|pci_get_function
argument_list|(
name|dev
argument_list|)
operator|==
literal|1
operator|&&
name|pci_get_subclass
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIS_STORAGE_IDE
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Cypress 82C693 ATA controller"
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_cypress_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_cypress_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_default_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_cypress_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_cypress_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ATA_WDMA2
argument_list|)
expr_stmt|;
comment|/* XXX missing WDMA0+1 + PIO modes */
if|if
condition|(
name|mode
operator|==
name|ATA_WDMA2
condition|)
block|{
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting WDMA2 on Cypress chip\n"
argument_list|,
name|error
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|atadev
operator|->
name|channel
operator|->
name|unit
condition|?
literal|0x4e
else|:
literal|0x4c
argument_list|,
literal|0x2020
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
return|return;
block|}
block|}
comment|/* we could set PIO mode timings, but we assume the BIOS did that */
block|}
end_function

begin_comment
comment|/*  * HighPoint chipset support functions  */
end_comment

begin_function
name|int
name|ata_highpoint_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_HPT366
block|,
literal|0x05
block|,
name|HPT372
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"HighPoint HPT372"
block|}
block|,
block|{
name|ATA_HPT366
block|,
literal|0x03
block|,
name|HPT370
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"HighPoint HPT370"
block|}
block|,
block|{
name|ATA_HPT366
block|,
literal|0x02
block|,
name|HPT366
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"HighPoint HPT368"
block|}
block|,
block|{
name|ATA_HPT366
block|,
literal|0x00
block|,
name|HPT366
block|,
name|HPTOLD
block|,
name|ATA_UDMA4
block|,
literal|"HighPoint HPT366"
block|}
block|,
block|{
name|ATA_HPT372
block|,
literal|0x01
block|,
name|HPT372
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"HighPoint HPT372"
block|}
block|,
block|{
name|ATA_HPT374
block|,
literal|0x07
block|,
name|HPT374
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"HighPoint HPT374"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|idx
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|->
name|cfg1
operator|==
name|HPT374
condition|)
block|{
if|if
condition|(
name|pci_get_function
argument_list|(
name|dev
argument_list|)
operator|==
literal|0
condition|)
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|" (channel 0+1)"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pci_get_function
argument_list|(
name|dev
argument_list|)
operator|==
literal|1
condition|)
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|" (channel 2+3)"
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|buffer
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_highpoint_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_highpoint_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|rid
init|=
name|ATA_IRQ_RID
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_irq
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
operator|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|INTR_TYPE_BIO
operator||
name|INTR_ENTROPY
argument_list|,
name|ata_highpoint_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|==
name|HPTOLD
condition|)
block|{
comment|/* turn off interrupt prediction */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x80
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* turn off interrupt prediction */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x03
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x55
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x55
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x03
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* turn on interrupts */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x10
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set clocks etc */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|<
name|HPT372
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5b
argument_list|,
literal|0x22
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5b
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x5b
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x01
operator|)
operator||
literal|0x20
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|ctlr
operator|->
name|setmode
operator|=
name|ata_highpoint_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_highpoint_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int8_t
name|dmastat
decl_stmt|;
name|int
name|unit
decl_stmt|;
comment|/* implement this as a toggle instead to balance load XXX */
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
literal|2
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
operator|(
name|dmastat
operator|=
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
operator|&
name|ATA_BMSTAT_MASK
operator|)
operator|)
operator|&
operator|(
name|ATA_BMSTAT_ACTIVE
operator||
name|ATA_BMSTAT_INTERRUPT
operator|)
operator|)
operator|!=
name|ATA_BMSTAT_INTERRUPT
condition|)
continue|continue;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|dmastat
operator||
name|ATA_BMSTAT_INTERRUPT
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_highpoint_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int32_t
name|timings33
index|[]
index|[
literal|4
index|]
init|=
block|{
comment|/*	  HPT366      HPT370	  HPT372      HPT374		   mode */
block|{
literal|0x40d0a7aa
block|,
literal|0x06914e57
block|,
literal|0x0d029d5e
block|,
literal|0x0ac1f48a
block|}
block|,
comment|/* PIO 0 */
block|{
literal|0x40d0a7a3
block|,
literal|0x06914e43
block|,
literal|0x0d029d26
block|,
literal|0x0ac1f465
block|}
block|,
comment|/* PIO 1 */
block|{
literal|0x40d0a753
block|,
literal|0x06514e33
block|,
literal|0x0c829ca6
block|,
literal|0x0a81f454
block|}
block|,
comment|/* PIO 2 */
block|{
literal|0x40c8a742
block|,
literal|0x06514e22
block|,
literal|0x0c829c84
block|,
literal|0x0a81f443
block|}
block|,
comment|/* PIO 3 */
block|{
literal|0x40c8a731
block|,
literal|0x06514e21
block|,
literal|0x0c829c62
block|,
literal|0x0a81f442
block|}
block|,
comment|/* PIO 4 */
block|{
literal|0x20c8a797
block|,
literal|0x26514e97
block|,
literal|0x2c82922e
block|,
literal|0x228082ea
block|}
block|,
comment|/* MWDMA 0 */
block|{
literal|0x20c8a732
block|,
literal|0x26514e33
block|,
literal|0x2c829266
block|,
literal|0x22808254
block|}
block|,
comment|/* MWDMA 1 */
block|{
literal|0x20c8a731
block|,
literal|0x26514e21
block|,
literal|0x2c829262
block|,
literal|0x22808242
block|}
block|,
comment|/* MWDMA 2 */
block|{
literal|0x10c8a731
block|,
literal|0x16514e31
block|,
literal|0x1c82dc62
block|,
literal|0x121882ea
block|}
block|,
comment|/* UDMA 0 */
block|{
literal|0x10cba731
block|,
literal|0x164d4e31
block|,
literal|0x1c9adc62
block|,
literal|0x12148254
block|}
block|,
comment|/* UDMA 1 */
block|{
literal|0x10caa731
block|,
literal|0x16494e31
block|,
literal|0x1c91dc62
block|,
literal|0x120c8242
block|}
block|,
comment|/* UDMA 2 */
block|{
literal|0x10cfa731
block|,
literal|0x166d4e31
block|,
literal|0x1c8edc62
block|,
literal|0x128c8242
block|}
block|,
comment|/* UDMA 3 */
block|{
literal|0x10c9a731
block|,
literal|0x16454e31
block|,
literal|0x1c8ddc62
block|,
literal|0x12ac8242
block|}
block|,
comment|/* UDMA 4 */
block|{
literal|0
block|,
literal|0x16454e31
block|,
literal|0x1c6ddc62
block|,
literal|0x12848242
block|}
block|,
comment|/* UDMA 5 */
block|{
literal|0
block|,
literal|0
block|,
literal|0x1c81dc62
block|,
literal|0x12448242
block|}
comment|/* UDMA 6 */
block|}
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|HPT366
operator|&&
name|ATAPI_DEVICE
argument_list|(
name|atadev
argument_list|)
condition|)
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ATA_PIO_MAX
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_highpoint_check_80pin
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on HighPoint chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|2
operator|)
argument_list|,
name|timings33
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
index|[
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_highpoint_check_80pin
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|u_int8_t
name|reg
decl_stmt|,
name|val
decl_stmt|,
name|res
decl_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|HPT374
operator|&&
name|pci_get_function
argument_list|(
name|parent
argument_list|)
operator|==
literal|1
condition|)
block|{
name|reg
operator|=
name|atadev
operator|->
name|channel
operator|->
name|unit
condition|?
literal|0x57
else|:
literal|0x53
expr_stmt|;
name|val
operator|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
name|val
operator||
literal|0x80
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reg
operator|=
literal|0x5b
expr_stmt|;
name|val
operator|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
name|val
operator|&
literal|0xfe
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|res
operator|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x5a
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
condition|?
literal|0x1
else|:
literal|0x2
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
name|val
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|res
condition|)
block|{
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"DMA limited to UDMA33, non-ATA66 cable or device\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
return|return
name|mode
return|;
block|}
end_function

begin_comment
comment|/*  * Intel chipset support functions  */
end_comment

begin_function
name|int
name|ata_intel_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_I82371FB
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_WDMA2
block|,
literal|"Intel PIIX"
block|}
block|,
block|{
name|ATA_I82371SB
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_WDMA2
block|,
literal|"Intel PIIX3"
block|}
block|,
block|{
name|ATA_I82371AB
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"Intel PIIX4"
block|}
block|,
block|{
name|ATA_I82443MX
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"Intel PIIX4"
block|}
block|,
block|{
name|ATA_I82451NX
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"Intel PIIX4"
block|}
block|,
block|{
name|ATA_I82801AB
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"Intel ICH0"
block|}
block|,
block|{
name|ATA_I82801AA
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"Intel ICH"
block|}
block|,
block|{
name|ATA_I82372FB
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"Intel ICH"
block|}
block|,
block|{
name|ATA_I82801BA
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"Intel ICH2"
block|}
block|,
block|{
name|ATA_I82801BA_1
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"Intel ICH2"
block|}
block|,
block|{
name|ATA_I82801CA
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"Intel ICH3"
block|}
block|,
block|{
name|ATA_I82801CA_1
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"Intel ICH3"
block|}
block|,
block|{
name|ATA_I82801DB
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"Intel ICH4"
block|}
block|,
block|{
name|ATA_I82801DB_1
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"Intel ICH4"
block|}
block|,
block|{
name|ATA_I82801EB
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"Intel ICH5"
block|}
block|,
block|{
name|ATA_I82801EB_1
block|,
literal|0
block|,
literal|0
block|,
literal|0x00
block|,
name|ATA_SA150
block|,
literal|"Intel ICH5"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_intel_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_intel_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_default_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|chipid
operator|==
name|ATA_I82371FB
condition|)
name|ctlr
operator|->
name|setmode
operator|=
name|ata_intel_old_setmode
expr_stmt|;
else|else
name|ctlr
operator|->
name|setmode
operator|=
name|ata_intel_new_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_intel_old_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
comment|/* NOT YET */
block|}
end_function

begin_function
specifier|static
name|void
name|ata_intel_new_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|u_int32_t
name|reg40
init|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x40
argument_list|,
literal|4
argument_list|)
decl_stmt|;
name|u_int8_t
name|reg44
init|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x44
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|u_int8_t
name|reg48
init|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x48
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|u_int16_t
name|reg4a
init|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x4a
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|u_int16_t
name|reg54
init|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|u_int32_t
name|mask40
init|=
literal|0
decl_stmt|,
name|new40
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|mask44
init|=
literal|0
decl_stmt|,
name|new44
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int8_t
name|timings
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x10
block|,
literal|0x21
block|,
literal|0x23
block|,
literal|0x10
block|,
literal|0x21
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|,
literal|0x23
block|}
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_SA150
condition|)
block|{
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
operator|&&
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|!
operator|(
name|reg54
operator|&
operator|(
literal|0x10
operator|<<
name|devno
operator|)
operator|)
condition|)
block|{
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"DMA limited to UDMA33, non-ATA66 cable or device\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x48
argument_list|,
name|reg48
operator||
operator|(
literal|0x0001
operator|<<
name|devno
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x4a
argument_list|,
operator|(
name|reg4a
operator|&
operator|~
operator|(
literal|0x3
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
operator|)
operator||
operator|(
literal|0x01
operator|+
operator|!
operator|(
name|mode
operator|&
literal|0x01
operator|)
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x48
argument_list|,
name|reg48
operator|&
operator|~
operator|(
literal|0x0001
operator|<<
name|devno
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x4a
argument_list|,
operator|(
name|reg4a
operator|&
operator|~
operator|(
literal|0x3
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA2
condition|)
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
name|reg54
operator||
operator|(
literal|0x1
operator|<<
name|devno
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
else|else
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
name|reg54
operator|&
operator|~
operator|(
literal|0x1
operator|<<
name|devno
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA5
condition|)
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
name|reg54
operator||
operator|(
literal|0x10000
operator|<<
name|devno
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
else|else
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
name|reg54
operator|&
operator|~
operator|(
literal|0x10000
operator|<<
name|devno
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|reg40
operator|&=
operator|~
literal|0x00ff00ff
expr_stmt|;
name|reg40
operator||=
literal|0x40774077
expr_stmt|;
if|if
condition|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_MASTER
condition|)
block|{
name|mask40
operator|=
literal|0x3300
expr_stmt|;
name|new40
operator|=
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|<<
literal|8
expr_stmt|;
block|}
else|else
block|{
name|mask44
operator|=
literal|0x0f
expr_stmt|;
name|new44
operator|=
operator|(
operator|(
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|&
literal|0x30
operator|)
operator|>>
literal|2
operator|)
operator||
operator|(
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|&
literal|0x03
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|atadev
operator|->
name|channel
operator|->
name|unit
condition|)
block|{
name|mask40
operator|<<=
literal|16
expr_stmt|;
name|new40
operator|<<=
literal|16
expr_stmt|;
name|mask44
operator|<<=
literal|4
expr_stmt|;
name|new44
operator|<<=
literal|4
expr_stmt|;
block|}
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x40
argument_list|,
operator|(
name|reg40
operator|&
operator|~
name|mask40
operator|)
operator||
name|new40
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x44
argument_list|,
operator|(
name|reg44
operator|&
operator|~
name|mask44
operator|)
operator||
name|new44
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * nVidia chipset support functions  */
end_comment

begin_function
name|int
name|ata_nvidia_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_NFORCE1
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
operator||
name|AMDBUG
block|,
name|ATA_UDMA5
block|,
literal|"nVidia nForce"
block|}
block|,
block|{
name|ATA_NFORCE2
block|,
literal|0
block|,
name|AMDNVIDIA
block|,
name|NVIDIA
operator||
name|AMDBUG
block|,
name|ATA_UDMA6
block|,
literal|"nVidia nForce2"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_nvidia_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_nvidia_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_default_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* set prefetch, postwrite */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|AMDBUG
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x0f
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x51
argument_list|,
literal|1
argument_list|)
operator||
literal|0xf0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_via_family_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Promise chipset support functions  */
end_comment

begin_function
name|int
name|ata_promise_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_PDC20246
block|,
literal|0
block|,
name|PROLD
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"Promise PDC20246"
block|}
block|,
block|{
name|ATA_PDC20262
block|,
literal|0
block|,
name|PRNEW
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"Promise PDC20262"
block|}
block|,
block|{
name|ATA_PDC20263
block|,
literal|0
block|,
name|PRNEW
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"Promise PDC20263"
block|}
block|,
block|{
name|ATA_PDC20265
block|,
literal|0
block|,
name|PRNEW
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"Promise PDC20265"
block|}
block|,
block|{
name|ATA_PDC20267
block|,
literal|0
block|,
name|PRNEW
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"Promise PDC20267"
block|}
block|,
block|{
name|ATA_PDC20268
block|,
literal|0
block|,
name|PRTX
block|,
name|PRTX4
block|,
name|ATA_UDMA5
block|,
literal|"Promise PDC20268"
block|}
block|,
block|{
name|ATA_PDC20269
block|,
literal|0
block|,
name|PRTX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"Promise PDC20269"
block|}
block|,
block|{
name|ATA_PDC20270
block|,
literal|0
block|,
name|PRTX
block|,
name|PRTX4
block|,
name|ATA_UDMA5
block|,
literal|"Promise PDC20270"
block|}
block|,
block|{
name|ATA_PDC20271
block|,
literal|0
block|,
name|PRTX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"Promise PDC20271"
block|}
block|,
block|{
name|ATA_PDC20275
block|,
literal|0
block|,
name|PRTX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"Promise PDC20275"
block|}
block|,
block|{
name|ATA_PDC20276
block|,
literal|0
block|,
name|PRTX
block|,
name|PRSX6K
block|,
name|ATA_UDMA6
block|,
literal|"Promise PDC20276"
block|}
block|,
block|{
name|ATA_PDC20277
block|,
literal|0
block|,
name|PRTX
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"Promise PDC20277"
block|}
block|,
block|{
name|ATA_PDC20318
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA
block|,
name|ATA_SA150
block|,
literal|"Promise PDC20318"
block|}
block|,
block|{
name|ATA_PDC20319
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA
block|,
name|ATA_SA150
block|,
literal|"Promise PDC20319"
block|}
block|,
block|{
name|ATA_PDC20371
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA
block|,
name|ATA_SA150
block|,
literal|"Promise PDC20371"
block|}
block|,
block|{
name|ATA_PDC20375
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA
block|,
name|ATA_SA150
block|,
literal|"Promise PDC20375"
block|}
block|,
block|{
name|ATA_PDC20376
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA
block|,
name|ATA_SA150
block|,
literal|"Promise PDC20376"
block|}
block|,
block|{
name|ATA_PDC20377
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA
block|,
name|ATA_SA150
block|,
literal|"Promise PDC20377"
block|}
block|,
block|{
name|ATA_PDC20378
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA
block|,
name|ATA_SA150
block|,
literal|"Promise PDC20378"
block|}
block|,
block|{
name|ATA_PDC20379
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRSATA
block|,
name|ATA_SA150
block|,
literal|"Promise PDC20379"
block|}
block|,
block|{
name|ATA_PDC20617
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRDUAL
block|,
name|ATA_UDMA6
block|,
literal|"Promise PDC20617"
block|}
block|,
block|{
name|ATA_PDC20618
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRDUAL
block|,
name|ATA_UDMA6
block|,
literal|"Promise PDC20618"
block|}
block|,
block|{
name|ATA_PDC20619
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRDUAL
block|,
name|ATA_UDMA6
block|,
literal|"Promise PDC20619"
block|}
block|,
block|{
name|ATA_PDC20620
block|,
literal|0
block|,
name|PRMIO
block|,
name|PRDUAL
block|,
name|ATA_UDMA6
block|,
literal|"Promise PDC20620"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
name|uintptr_t
name|devid
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
comment|/* if we are on a SuperTrak SX6000 dont attach */
if|if
condition|(
operator|(
name|idx
operator|->
name|cfg2
operator|&
name|PRSX6K
operator|)
operator|&&
name|pci_get_class
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|==
name|PCIC_BRIDGE
operator|&&
operator|!
name|BUS_READ_IVAR
argument_list|(
name|device_get_parent
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|,
name|PCI_IVAR_DEVID
argument_list|,
operator|&
name|devid
argument_list|)
operator|&&
name|devid
operator|==
name|ATA_I960RM
condition|)
return|return
name|ENXIO
return|;
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|idx
operator|->
name|text
argument_list|)
expr_stmt|;
comment|/* if we are on a FastTrak TX4, adjust the interrupt resource */
if|if
condition|(
operator|(
name|idx
operator|->
name|cfg2
operator|&
name|PRTX4
operator|)
operator|&&
name|pci_get_class
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|==
name|PCIC_BRIDGE
operator|&&
operator|!
name|BUS_READ_IVAR
argument_list|(
name|device_get_parent
argument_list|(
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|GRANDPARENT
argument_list|(
name|dev
argument_list|)
argument_list|,
name|PCI_IVAR_DEVID
argument_list|,
operator|&
name|devid
argument_list|)
operator|&&
name|devid
operator|==
name|ATA_DEC_21150
condition|)
block|{
specifier|static
name|long
name|start
init|=
literal|0
decl_stmt|,
name|end
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
operator|==
literal|1
condition|)
block|{
name|bus_get_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|" (channel 0+1)"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
operator|==
literal|2
operator|&&
name|start
operator|&&
name|end
condition|)
block|{
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|start
operator|=
name|end
operator|=
literal|0
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|" (channel 2+3)"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|start
operator|=
name|end
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|buffer
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_promise_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|rid
init|=
name|ATA_IRQ_RID
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_irq
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|PRNEW
case|:
name|ctlr
operator|->
name|dmainit
operator|=
name|ata_promise_old_dmainit
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|PROLD
case|:
if|if
condition|(
operator|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|INTR_TYPE_BIO
operator||
name|INTR_ENTROPY
argument_list|,
name|ata_promise_old_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
break|break;
case|case
name|PRTX
case|:
if|if
condition|(
operator|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|INTR_TYPE_BIO
operator||
name|INTR_ENTROPY
argument_list|,
name|ata_promise_tx2_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
break|break;
case|case
name|PRMIO
case|:
name|rid
operator|=
literal|0x1c
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_io2
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|ctlr
operator|->
name|dmainit
operator|=
name|ata_promise_mio_dmainit
expr_stmt|;
name|ctlr
operator|->
name|allocate
operator|=
name|ata_promise_mio_allocate
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|PRDUAL
condition|)
block|{
name|ctlr
operator|->
name|channels
operator|=
operator|(
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_io2
argument_list|,
literal|0x48
argument_list|)
operator|&
literal|0x01
operator|)
operator|>
literal|0
operator|)
operator|+
operator|(
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_io2
argument_list|,
literal|0x48
argument_list|)
operator|&
literal|0x02
operator|)
operator|>
literal|0
operator|)
operator|+
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|PRSATA
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_io2
argument_list|,
literal|0x06c
argument_list|,
literal|0x00ff0033
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|channels
operator|=
operator|(
operator|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_io2
argument_list|,
literal|0x48
argument_list|)
operator|&
literal|0x02
operator|)
operator|>
literal|0
operator|)
operator|+
literal|3
expr_stmt|;
block|}
else|else
name|ctlr
operator|->
name|channels
operator|=
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|INTR_TYPE_BIO
operator||
name|INTR_ENTROPY
argument_list|,
name|ata_promise_mio_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
break|break;
block|}
name|ctlr
operator|->
name|setmode
operator|=
name|ata_promise_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_allocate
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|ATA_DATA
init|;
name|i
operator|<=
name|ATA_STATUS
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_io2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|offset
operator|=
literal|0x200
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
expr_stmt|;
block|}
name|ch
operator|->
name|r_io
index|[
name|ATA_ALTSTAT
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_io2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_ALTSTAT
index|]
operator|.
name|offset
operator|=
literal|0x238
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCTL_PORT
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_io2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMCTL_PORT
index|]
operator|.
name|offset
operator|=
literal|0x260
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMDTP_PORT
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_io2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMDTP_PORT
index|]
operator|.
name|offset
operator|=
literal|0x244
operator|+
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|7
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMDEVSPEC_0
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_io2
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_BMDEVSPEC_0
index|]
operator|.
name|offset
operator|=
operator|(
name|ch
operator|->
name|unit
operator|<<
literal|2
operator|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_ADDR
index|]
operator|.
name|res
operator|=
name|ctlr
operator|->
name|r_io2
expr_stmt|;
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
operator|(
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|)
operator|&
operator|~
literal|0x00000f8f
operator|)
operator||
name|ch
operator|->
name|unit
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_0
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_NO_SLAVE
expr_stmt|;
name|ctlr
operator|->
name|dmainit
argument_list|(
name|ch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_old_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int8_t
name|dmastat
decl_stmt|;
name|int
name|unit
decl_stmt|;
comment|/* implement this as a toggle instead to balance load XXX */
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
literal|2
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
continue|continue;
if|if
condition|(
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_io1
argument_list|,
literal|0x1c
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x00004000
else|:
literal|0x00000400
operator|)
condition|)
block|{
if|if
condition|(
name|ch
operator|->
name|dma
operator|->
name|flags
operator|&
name|ATA_DMA_ACTIVE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|dmastat
operator|=
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
operator|&
name|ATA_BMSTAT_MASK
operator|)
operator|)
operator|&
name|ATA_BMSTAT_INTERRUPT
operator|)
condition|)
continue|continue;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|dmastat
operator||
name|ATA_BMSTAT_INTERRUPT
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_tx2_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int8_t
name|dmastat
decl_stmt|;
name|int
name|unit
decl_stmt|;
comment|/* implement this as a toggle instead to balance load XXX */
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
literal|2
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
continue|continue;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_0
argument_list|,
literal|0x0b
argument_list|)
expr_stmt|;
if|if
condition|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_1
argument_list|)
operator|&
literal|0x20
condition|)
block|{
if|if
condition|(
name|ch
operator|->
name|dma
operator|->
name|flags
operator|&
name|ATA_DMA_ACTIVE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|dmastat
operator|=
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
operator|&
name|ATA_BMSTAT_MASK
operator|)
operator|)
operator|&
name|ATA_BMSTAT_INTERRUPT
operator|)
condition|)
continue|continue;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|dmastat
operator||
name|ATA_BMSTAT_INTERRUPT
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_mio_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|irq_vector
decl_stmt|;
name|int
name|unit
decl_stmt|;
name|irq_vector
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_io2
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|ctlr
operator|->
name|channels
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
name|irq_vector
operator|&
operator|(
literal|1
operator|<<
name|unit
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
block|{
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_BMDEVSPEC_0
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_promise_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int32_t
name|timings33
index|[]
index|[
literal|2
index|]
init|=
block|{
comment|/*	  PROLD	      PRNEW		   mode */
block|{
literal|0x004ff329
block|,
literal|0x004fff2f
block|}
block|,
comment|/* PIO 0 */
block|{
literal|0x004fec25
block|,
literal|0x004ff82a
block|}
block|,
comment|/* PIO 1 */
block|{
literal|0x004fe823
block|,
literal|0x004ff026
block|}
block|,
comment|/* PIO 2 */
block|{
literal|0x004fe622
block|,
literal|0x004fec24
block|}
block|,
comment|/* PIO 3 */
block|{
literal|0x004fe421
block|,
literal|0x004fe822
block|}
block|,
comment|/* PIO 4 */
block|{
literal|0x004567f3
block|,
literal|0x004acef6
block|}
block|,
comment|/* MWDMA 0 */
block|{
literal|0x004467f3
block|,
literal|0x0048cef6
block|}
block|,
comment|/* MWDMA 1 */
block|{
literal|0x004367f3
block|,
literal|0x0046cef6
block|}
block|,
comment|/* MWDMA 2 */
block|{
literal|0x004367f3
block|,
literal|0x0046cef6
block|}
block|,
comment|/* UDMA 0 */
block|{
literal|0x004247f3
block|,
literal|0x00448ef6
block|}
block|,
comment|/* UDMA 1 */
block|{
literal|0x004127f3
block|,
literal|0x00436ef6
block|}
block|,
comment|/* UDMA 2 */
block|{
literal|0
block|,
literal|0x00424ef6
block|}
block|,
comment|/* UDMA 3 */
block|{
literal|0
block|,
literal|0x004127f3
block|}
block|,
comment|/* UDMA 4 */
block|{
literal|0
block|,
literal|0x004127f3
block|}
comment|/* UDMA 5 */
block|}
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|PROLD
case|:
case|case
name|PRNEW
case|:
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|(
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x50
argument_list|,
literal|2
argument_list|)
operator|&
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
condition|?
literal|1
operator|<<
literal|11
else|:
literal|1
operator|<<
literal|10
operator|)
operator|)
condition|)
block|{
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"DMA limited to UDMA33, non-ATA66 cable or device\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
if|if
condition|(
name|ATAPI_DEVICE
argument_list|(
name|atadev
argument_list|)
operator|&&
name|mode
operator|>
name|ATA_PIO_MAX
condition|)
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ATA_PIO_MAX
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRTX
case|:
name|ATA_IDX_OUTB
argument_list|(
name|atadev
operator|->
name|channel
argument_list|,
name|ATA_BMDEVSPEC_0
argument_list|,
literal|0x0b
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|ATA_IDX_INB
argument_list|(
name|atadev
operator|->
name|channel
argument_list|,
name|ATA_BMDEVSPEC_1
argument_list|)
operator|&
literal|0x04
condition|)
block|{
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"DMA limited to UDMA33, non-ATA66 cable or device\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
break|break;
case|case
name|PRMIO
case|:
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|(
name|ATA_IDX_INL
argument_list|(
name|atadev
operator|->
name|channel
argument_list|,
name|ATA_BMCTL_PORT
argument_list|)
operator|&
literal|0x01000000
operator|)
condition|)
block|{
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"DMA limited to UDMA33, non-ATA66 cable or device\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|mode
operator|>=
name|ATA_SA150
condition|)
block|{
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
return|return;
block|}
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|<
name|PRTX
condition|)
name|pci_write_config
argument_list|(
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
argument_list|,
literal|0x60
operator|+
operator|(
name|devno
operator|<<
literal|2
operator|)
argument_list|,
name|timings33
index|[
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
index|]
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_old_dmainit
parameter_list|(
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|ata_dmainit
argument_list|(
name|ch
argument_list|)
operator|)
condition|)
return|return
name|error
return|;
name|ch
operator|->
name|dma
operator|->
name|start
operator|=
name|ata_promise_old_dmastart
expr_stmt|;
name|ch
operator|->
name|dma
operator|->
name|stop
operator|=
name|ata_promise_old_dmastop
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_old_dmastart
parameter_list|(
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int32_t
name|count
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|ata_dmastart
argument_list|(
name|ch
argument_list|,
name|data
argument_list|,
name|count
argument_list|,
name|dir
argument_list|)
operator|)
condition|)
return|return
name|error
return|;
if|if
condition|(
name|ch
operator|->
name|flags
operator|&
name|ATA_48BIT_ACTIVE
condition|)
block|{
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_io1
argument_list|,
literal|0x11
argument_list|,
name|ATA_INB
argument_list|(
name|ctlr
operator|->
name|r_io1
argument_list|,
literal|0x11
argument_list|)
operator||
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x08
else|:
literal|0x02
operator|)
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_io1
argument_list|,
literal|0x20
argument_list|,
operator|(
name|dir
condition|?
literal|0x05000000
else|:
literal|0x06000000
operator|)
operator||
operator|(
name|count
operator|>>
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_BMDTP_PORT
argument_list|,
name|ch
operator|->
name|dma
operator|->
name|mdmatab
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
name|dir
condition|?
name|ATA_BMCMD_WRITE_READ
else|:
literal|0
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
operator||
operator|(
name|ATA_BMSTAT_INTERRUPT
operator||
name|ATA_BMSTAT_ERROR
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|)
operator||
name|ATA_BMCMD_START_STOP
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_old_dmastop
parameter_list|(
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|ch
operator|->
name|flags
operator|&
name|ATA_48BIT_ACTIVE
condition|)
block|{
name|ATA_OUTB
argument_list|(
name|ctlr
operator|->
name|r_io1
argument_list|,
literal|0x11
argument_list|,
name|ATA_INB
argument_list|(
name|ctlr
operator|->
name|r_io1
argument_list|,
literal|0x11
argument_list|)
operator|&
operator|~
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x08
else|:
literal|0x02
operator|)
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_io1
argument_list|,
literal|0x20
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|,
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMCMD_PORT
argument_list|)
operator|&
operator|~
name|ATA_BMCMD_START_STOP
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|ATA_BMSTAT_INTERRUPT
operator||
name|ATA_BMSTAT_ERROR
argument_list|)
expr_stmt|;
name|ata_dmastop
argument_list|(
name|ch
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_dmainit
parameter_list|(
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|ata_dmainit
argument_list|(
name|ch
argument_list|)
operator|)
condition|)
return|return
name|error
return|;
name|ch
operator|->
name|dma
operator|->
name|start
operator|=
name|ata_promise_mio_dmastart
expr_stmt|;
name|ch
operator|->
name|dma
operator|->
name|stop
operator|=
name|ata_promise_mio_dmastop
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_dmastart
parameter_list|(
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int32_t
name|count
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|ata_dmastart
argument_list|(
name|ch
argument_list|,
name|data
argument_list|,
name|count
argument_list|,
name|dir
argument_list|)
operator|)
condition|)
return|return
name|error
return|;
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_BMDTP_PORT
argument_list|,
name|ch
operator|->
name|dma
operator|->
name|mdmatab
argument_list|)
expr_stmt|;
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_BMCTL_PORT
argument_list|,
operator|(
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_BMCTL_PORT
argument_list|)
operator|&
operator|~
literal|0x000000c0
operator|)
operator||
operator|(
operator|(
name|dir
operator|)
condition|?
literal|0x00000080
else|:
literal|0x000000c0
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_promise_mio_dmastop
parameter_list|(
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|)
block|{
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_BMCTL_PORT
argument_list|,
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_BMCTL_PORT
argument_list|)
operator|&
operator|~
literal|0x00000080
argument_list|)
expr_stmt|;
return|return
name|ata_dmastop
argument_list|(
name|ch
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * ServerWorks chipset support functions  */
end_comment

begin_function
name|int
name|ata_serverworks_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_ROSB4
block|,
literal|0x00
block|,
name|SWKS33
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"ServerWorks ROSB4"
block|}
block|,
block|{
name|ATA_CSB5
block|,
literal|0x92
block|,
name|SWKS100
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"ServerWorks CSB5"
block|}
block|,
block|{
name|ATA_CSB5
block|,
literal|0x00
block|,
name|SWKS66
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"ServerWorks CSB5"
block|}
block|,
block|{
name|ATA_CSB6
block|,
literal|0x00
block|,
name|SWKS100
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"ServerWorks CSB6"
block|}
block|,
block|{
name|ATA_CSB6_1
block|,
literal|0x00
block|,
name|SWKS66
block|,
literal|0x00
block|,
name|ATA_UDMA4
block|,
literal|"ServerWorks CSB6"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_serverworks_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_serverworks_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_default_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|>
name|SWKS33
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x5a
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
literal|0x40
operator|)
operator||
operator|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|SWKS100
operator|)
condition|?
literal|0x03
else|:
literal|0x02
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x64
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x64
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
literal|0x00002000
operator|)
operator||
literal|0x00004000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_serverworks_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_serverworks_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|offset
init|=
name|devno
operator|^
literal|0x01
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int8_t
name|timings
index|[]
init|=
block|{
literal|0x5d
block|,
literal|0x47
block|,
literal|0x34
block|,
literal|0x22
block|,
literal|0x20
block|,
literal|0x34
block|,
literal|0x22
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|,
literal|0x20
block|}
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
literal|1
argument_list|)
operator||
operator|(
literal|0x01
operator|<<
name|devno
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x56
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x56
argument_list|,
literal|2
argument_list|)
operator|&
operator|~
operator|(
literal|0xf
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
operator|)
operator||
operator|(
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|<<
operator|(
name|devno
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x54
argument_list|,
literal|1
argument_list|)
operator||
operator|~
operator|(
literal|0x01
operator|<<
name|devno
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
literal|0x44
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x44
argument_list|,
literal|4
argument_list|)
operator|&
operator|~
operator|(
literal|0xff
operator|<<
operator|(
name|offset
operator|<<
literal|8
operator|)
operator|)
operator|)
operator||
operator|(
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
operator|<<
operator|(
name|offset
operator|<<
literal|8
operator|)
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Silicon Image (former CMD) chipset support functions  */
end_comment

begin_function
name|int
name|ata_sii_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_SII0680
block|,
literal|0x00
block|,
literal|0
block|,
name|SII_SETCLK
block|,
name|ATA_UDMA6
block|,
literal|"SiI 0680"
block|}
block|,
block|{
name|ATA_CMD649
block|,
literal|0x00
block|,
literal|0
block|,
name|SII_INTR
block|,
name|ATA_UDMA5
block|,
literal|"CMD 649"
block|}
block|,
block|{
name|ATA_CMD648
block|,
literal|0x00
block|,
literal|0
block|,
name|SII_INTR
block|,
name|ATA_UDMA4
block|,
literal|"CMD 648"
block|}
block|,
block|{
name|ATA_CMD646
block|,
literal|0x07
block|,
literal|0
block|,
name|SII_ENINTR
block|,
name|ATA_UDMA2
block|,
literal|"CMD 646U2"
block|}
block|,
block|{
name|ATA_CMD646
block|,
literal|0x00
block|,
literal|0
block|,
name|SII_ENINTR
block|,
name|ATA_WDMA2
block|,
literal|"CMD 646"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_match_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_sii_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_sii_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|rid
init|=
name|ATA_IRQ_RID
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_irq
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
operator|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|INTR_TYPE_BIO
operator||
name|INTR_ENTROPY
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|SII_INTR
condition|?
name|ata_cmd_intr
else|:
name|ata_generic_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|SII_ENINTR
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x71
argument_list|,
literal|0x01
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|SII_SETCLK
condition|)
block|{
if|if
condition|(
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x30
operator|)
operator|!=
literal|0x10
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x0F
operator|)
operator||
literal|0x10
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x8a
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x30
operator|)
operator|!=
literal|0x10
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s could not set ATA133 clock\n"
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sii_setmode
expr_stmt|;
block|}
else|else
name|ctlr
operator|->
name|setmode
operator|=
name|ata_cmd_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_cmd_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|data
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|u_int8_t
name|dmastat
decl_stmt|;
name|int
name|unit
decl_stmt|;
comment|/* implement this as a toggle instead to balance load XXX */
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
literal|2
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|ch
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|!
operator|(
name|pci_read_config
argument_list|(
name|device_get_parent
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
argument_list|,
literal|0x71
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x08
else|:
literal|0x04
operator|)
operator|)
condition|)
continue|continue;
name|pci_write_config
argument_list|(
name|device_get_parent
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
argument_list|,
literal|0x71
argument_list|,
operator|(
name|ch
operator|->
name|unit
condition|?
literal|0x08
else|:
literal|0x04
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dma
operator|->
name|flags
operator|&
name|ATA_DMA_ACTIVE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|dmastat
operator|=
operator|(
name|ATA_IDX_INB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|)
operator|&
name|ATA_BMSTAT_MASK
operator|)
operator|)
operator|&
name|ATA_BMSTAT_INTERRUPT
operator|)
condition|)
continue|continue;
name|ATA_IDX_OUTB
argument_list|(
name|ch
argument_list|,
name|ATA_BMSTAT_PORT
argument_list|,
name|dmastat
operator||
name|ATA_BMSTAT_INTERRUPT
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_sii_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|4
operator|)
operator|+
operator|(
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|<<
literal|1
operator|)
decl_stmt|;
name|int
name|mreg
init|=
name|atadev
operator|->
name|channel
operator|->
name|unit
condition|?
literal|0x84
else|:
literal|0x80
decl_stmt|;
name|int
name|mask
init|=
literal|0x03
operator|<<
operator|(
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|<<
literal|2
operator|)
decl_stmt|;
name|int
name|mval
init|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
name|mreg
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
name|mask
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|u_int8_t
name|udmatimings
index|[]
init|=
block|{
literal|0xf
block|,
literal|0xb
block|,
literal|0x7
block|,
literal|0x5
block|,
literal|0x3
block|,
literal|0x2
block|,
literal|0x1
block|}
decl_stmt|;
name|u_int8_t
name|ureg
init|=
literal|0xac
operator|+
name|devno
decl_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|mreg
argument_list|,
name|mval
operator||
operator|(
literal|0x03
operator|<<
operator|(
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|ureg
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|parent
argument_list|,
name|ureg
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x3f
operator|)
operator||
name|udmatimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA0
condition|)
block|{
name|u_int8_t
name|dreg
init|=
literal|0xa8
operator|+
name|devno
decl_stmt|;
name|u_int16_t
name|dmatimings
index|[]
init|=
block|{
literal|0x2208
block|,
literal|0x10c2
block|,
literal|0x10c1
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|mreg
argument_list|,
name|mval
operator||
operator|(
literal|0x02
operator|<<
operator|(
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|dreg
argument_list|,
name|dmatimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u_int8_t
name|preg
init|=
literal|0xa4
operator|+
name|devno
decl_stmt|;
name|u_int16_t
name|piotimings
index|[]
init|=
block|{
literal|0x328a
block|,
literal|0x2283
block|,
literal|0x1104
block|,
literal|0x10c3
block|,
literal|0x10c1
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|mreg
argument_list|,
name|mval
operator||
operator|(
literal|0x01
operator|<<
operator|(
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|preg
argument_list|,
name|piotimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ata_cmd_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|int
name|treg
init|=
literal|0x54
operator|+
operator|(
name|devno
operator|<
literal|3
operator|)
condition|?
operator|(
name|devno
operator|<<
literal|1
operator|)
else|:
literal|7
decl_stmt|;
name|int
name|ureg
init|=
name|atadev
operator|->
name|channel
operator|->
name|unit
condition|?
literal|0x7b
else|:
literal|0x73
decl_stmt|;
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
block|{
name|int
name|udmatimings
index|[]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x31
block|,
literal|0xc2
block|}
block|,
block|{
literal|0x21
block|,
literal|0x82
block|}
block|,
block|{
literal|0x11
block|,
literal|0x42
block|}
block|,
block|{
literal|0x25
block|,
literal|0x8a
block|}
block|,
block|{
literal|0x15
block|,
literal|0x4a
block|}
block|,
block|{
literal|0x05
block|,
literal|0x0a
block|}
block|}
decl_stmt|;
name|u_int8_t
name|umode
init|=
name|pci_read_config
argument_list|(
name|parent
argument_list|,
name|ureg
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|umode
operator|&=
operator|~
operator|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_MASTER
condition|?
literal|0x35
else|:
literal|0xca
operator|)
expr_stmt|;
name|umode
operator||=
name|udmatimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
index|[
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
index|]
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|ureg
argument_list|,
name|umode
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|>=
name|ATA_WDMA0
condition|)
block|{
name|int
name|dmatimings
index|[]
init|=
block|{
literal|0x87
block|,
literal|0x32
block|,
literal|0x3f
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|treg
argument_list|,
name|dmatimings
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|ureg
argument_list|,
name|pci_read_config
argument_list|(
name|parent
argument_list|,
name|ureg
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
operator|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_MASTER
condition|?
literal|0x35
else|:
literal|0xca
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|piotimings
index|[]
init|=
block|{
literal|0xa9
block|,
literal|0x57
block|,
literal|0x44
block|,
literal|0x32
block|,
literal|0x3f
block|}
decl_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|treg
argument_list|,
name|piotimings
index|[
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|-
name|ATA_PIO0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|ureg
argument_list|,
name|pci_read_config
argument_list|(
name|parent
argument_list|,
name|ureg
argument_list|,
literal|1
argument_list|)
operator|&
operator|~
operator|(
name|atadev
operator|->
name|unit
operator|==
name|ATA_MASTER
condition|?
literal|0x35
else|:
literal|0xca
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * SiS chipset support functions  */
end_comment

begin_function
name|int
name|ata_sis_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_SIS963
block|,
literal|0x00
block|,
name|SIS133NEW
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 963"
block|}
block|,
comment|/* south */
block|{
name|ATA_SIS962
block|,
literal|0x00
block|,
name|SIS133NEW
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 962"
block|}
block|,
comment|/* south */
block|{
name|ATA_SIS755
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 755"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS752
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 752"
block|}
block|,
comment|/* unknown */
block|{
name|ATA_SIS751
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 751"
block|}
block|,
comment|/* unknown */
block|{
name|ATA_SIS750
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 750"
block|}
block|,
comment|/* unknown */
block|{
name|ATA_SIS748
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 748"
block|}
block|,
comment|/* unknown */
block|{
name|ATA_SIS746
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 746"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS745
block|,
literal|0x00
block|,
name|SIS100NEW
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"SiS 745"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS740
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"SiS 740"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS735
block|,
literal|0x00
block|,
name|SIS100NEW
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"SiS 735"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS733
block|,
literal|0x00
block|,
name|SIS100NEW
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"SiS 733"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS730
block|,
literal|0x00
block|,
name|SIS100OLD
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"SiS 730"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS658
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 658"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS655
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 655"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS652
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 652"
block|}
block|,
comment|/* unknown */
block|{
name|ATA_SIS651
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 651"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS650
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 650"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS648
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 648"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS646
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 645DX"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS645
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 645"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS640
block|,
literal|0x00
block|,
name|SIS_SOUTH
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"SiS 640"
block|}
block|,
comment|/* ext south */
block|{
name|ATA_SIS635
block|,
literal|0x00
block|,
name|SIS100NEW
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"SiS 635"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS633
block|,
literal|0x00
block|,
name|SIS100NEW
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"SiS 633"
block|}
block|,
comment|/* unknown */
block|{
name|ATA_SIS630
block|,
literal|0x30
block|,
name|SIS100OLD
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"SiS 630S"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS630
block|,
literal|0x00
block|,
name|SIS66
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"SiS 630"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS620
block|,
literal|0x00
block|,
name|SIS66
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"SiS 620"
block|}
block|,
comment|/* 1chip */
block|{
name|ATA_SIS550
block|,
literal|0x00
block|,
name|SIS66
block|,
literal|0
block|,
name|ATA_UDMA5
block|,
literal|"SiS 550"
block|}
block|,
block|{
name|ATA_SIS540
block|,
literal|0x00
block|,
name|SIS66
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"SiS 540"
block|}
block|,
block|{
name|ATA_SIS530
block|,
literal|0x00
block|,
name|SIS66
block|,
literal|0
block|,
name|ATA_UDMA4
block|,
literal|"SiS 530"
block|}
block|,
block|{
name|ATA_SIS5513
block|,
literal|0xc2
block|,
name|SIS33
block|,
literal|0
block|,
name|ATA_UDMA2
block|,
literal|"SiS 5513"
block|}
block|,
block|{
name|ATA_SIS5513
block|,
literal|0x00
block|,
name|SIS33
block|,
literal|0
block|,
name|ATA_WDMA2
block|,
literal|"SiS 5513"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_find_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|idx
operator|->
name|cfg1
operator|==
name|SIS_SOUTH
condition|)
block|{
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x57
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x57
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x7f
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x00
argument_list|,
literal|4
argument_list|)
operator|==
name|ATA_SIS5518
condition|)
block|{
name|idx
operator|->
name|cfg1
operator|=
name|SIS133NEW
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"SiS 96X %s controller"
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|ata_chip_id
name|id
index|[]
init|=
block|{
block|{
name|ATA_SISSOUTH
block|,
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
name|ATA_UDMA6
block|,
literal|"SiS 961"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
if|if
condition|(
name|ata_find_chip
argument_list|(
name|dev
argument_list|,
name|id
argument_list|,
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
argument_list|)
condition|)
name|idx
operator|->
name|cfg1
operator|=
name|SIS133OLD
expr_stmt|;
else|else
block|{
name|idx
operator|->
name|max_dma
operator|=
name|ATA_UDMA5
expr_stmt|;
name|idx
operator|->
name|cfg1
operator|=
name|SIS100NEW
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"SiS 961 %s controller"
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x57
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x57
argument_list|,
literal|1
argument_list|)
operator||
literal|0x80
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_sis_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_sis_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_default_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|SIS33
case|:
break|break;
case|case
name|SIS66
case|:
case|case
name|SIS100OLD
case|:
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x52
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x52
argument_list|,
literal|1
argument_list|)
operator||
literal|0x04
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIS100NEW
case|:
case|case
name|SIS133OLD
case|:
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x49
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x49
argument_list|,
literal|1
argument_list|)
operator||
literal|0x01
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIS133NEW
case|:
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
literal|2
argument_list|)
operator|&
literal|0xfff7
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x52
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x52
argument_list|,
literal|2
argument_list|)
operator|&
literal|0xfff7
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
name|ENXIO
return|;
block|}
name|ctlr
operator|->
name|setmode
operator|=
name|ata_sis_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_sis_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
operator|==
name|SIS133NEW
condition|)
block|{
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|pci_read_config
argument_list|(
name|parent
argument_list|,
name|atadev
operator|->
name|channel
operator|->
name|unit
condition|?
literal|0x52
else|:
literal|0x50
argument_list|,
literal|2
argument_list|)
operator|&
literal|0x8000
condition|)
block|{
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"DMA limited to UDMA33, non-ATA66 cable or device\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x48
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
condition|?
literal|0x20
else|:
literal|0x10
operator|)
condition|)
block|{
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"DMA limited to UDMA33, non-ATA66 cable or device\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
block|}
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
switch|switch
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
condition|)
block|{
case|case
name|SIS133NEW
case|:
block|{
name|u_int32_t
name|timings
index|[]
init|=
block|{
literal|0x28269008
block|,
literal|0x0c266008
block|,
literal|0x04263008
block|,
literal|0x0c0a3008
block|,
literal|0x05093008
block|,
literal|0x22196008
block|,
literal|0x0c0a3008
block|,
literal|0x05093008
block|,
literal|0x050939fc
block|,
literal|0x050936ac
block|,
literal|0x0509347c
block|,
literal|0x0509325c
block|,
literal|0x0509323c
block|,
literal|0x0509322c
block|,
literal|0x0509321c
block|}
decl_stmt|;
name|u_int32_t
name|reg
decl_stmt|;
name|reg
operator|=
operator|(
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x57
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x40
condition|?
literal|0x70
else|:
literal|0x40
operator|)
operator|+
operator|(
name|devno
operator|<<
literal|2
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SIS133OLD
case|:
block|{
name|u_int16_t
name|timings
index|[]
init|=
block|{
literal|0x00cb
block|,
literal|0x0067
block|,
literal|0x0044
block|,
literal|0x0033
block|,
literal|0x0031
block|,
literal|0x0044
block|,
literal|0x0033
block|,
literal|0x0031
block|,
literal|0x8f31
block|,
literal|0x8a31
block|,
literal|0x8731
block|,
literal|0x8531
block|,
literal|0x8331
block|,
literal|0x8231
block|,
literal|0x8131
block|}
decl_stmt|;
name|u_int16_t
name|reg
init|=
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|1
operator|)
decl_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SIS100NEW
case|:
block|{
name|u_int16_t
name|timings
index|[]
init|=
block|{
literal|0x00cb
block|,
literal|0x0067
block|,
literal|0x0044
block|,
literal|0x0033
block|,
literal|0x0031
block|,
literal|0x0044
block|,
literal|0x0033
block|,
literal|0x0031
block|,
literal|0x8b31
block|,
literal|0x8731
block|,
literal|0x8531
block|,
literal|0x8431
block|,
literal|0x8231
block|,
literal|0x8131
block|}
decl_stmt|;
name|u_int16_t
name|reg
init|=
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|1
operator|)
decl_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SIS100OLD
case|:
case|case
name|SIS66
case|:
case|case
name|SIS33
case|:
block|{
name|u_int16_t
name|timings
index|[]
init|=
block|{
literal|0x0c0b
block|,
literal|0x0607
block|,
literal|0x0404
block|,
literal|0x0303
block|,
literal|0x0301
block|,
literal|0x0404
block|,
literal|0x0303
block|,
literal|0x0301
block|,
literal|0xf301
block|,
literal|0xd301
block|,
literal|0xb301
block|,
literal|0xa301
block|,
literal|0x9301
block|,
literal|0x8301
block|}
decl_stmt|;
name|u_int16_t
name|reg
init|=
literal|0x40
operator|+
operator|(
name|devno
operator|<<
literal|1
operator|)
decl_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* VIA chipsets */
end_comment

begin_function
name|int
name|ata_via_ident
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_chip_id
modifier|*
name|idx
decl_stmt|;
specifier|static
name|struct
name|ata_chip_id
name|ids
index|[]
init|=
block|{
block|{
name|ATA_VIA82C586
block|,
literal|0x02
block|,
name|VIA33
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"VIA 82C586B"
block|}
block|,
block|{
name|ATA_VIA82C586
block|,
literal|0x00
block|,
name|VIA33
block|,
literal|0x00
block|,
name|ATA_WDMA2
block|,
literal|"VIA 82C586"
block|}
block|,
block|{
name|ATA_VIA82C596
block|,
literal|0x12
block|,
name|VIA66
block|,
name|VIACLK
block|,
name|ATA_UDMA4
block|,
literal|"VIA 82C596B"
block|}
block|,
block|{
name|ATA_VIA82C596
block|,
literal|0x00
block|,
name|VIA33
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"VIA 82C596"
block|}
block|,
block|{
name|ATA_VIA82C686
block|,
literal|0x40
block|,
name|VIA100
block|,
name|VIABUG
block|,
name|ATA_UDMA5
block|,
literal|"VIA 82C686B"
block|}
block|,
block|{
name|ATA_VIA82C686
block|,
literal|0x10
block|,
name|VIA66
block|,
name|VIACLK
block|,
name|ATA_UDMA4
block|,
literal|"VIA 82C686A"
block|}
block|,
block|{
name|ATA_VIA82C686
block|,
literal|0x00
block|,
name|VIA33
block|,
literal|0x00
block|,
name|ATA_UDMA2
block|,
literal|"VIA 82C686"
block|}
block|,
block|{
name|ATA_VIA8231
block|,
literal|0x00
block|,
name|VIA100
block|,
name|VIABUG
block|,
name|ATA_UDMA5
block|,
literal|"VIA 8231"
block|}
block|,
block|{
name|ATA_VIA8233
block|,
literal|0x00
block|,
name|VIA100
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"VIA 8233"
block|}
block|,
block|{
name|ATA_VIA8233C
block|,
literal|0x00
block|,
name|VIA100
block|,
literal|0x00
block|,
name|ATA_UDMA5
block|,
literal|"VIA 8233C"
block|}
block|,
block|{
name|ATA_VIA8233A
block|,
literal|0x00
block|,
name|VIA133
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"VIA 8233A"
block|}
block|,
block|{
name|ATA_VIA8235
block|,
literal|0x00
block|,
name|VIA133
block|,
literal|0x00
block|,
name|ATA_UDMA6
block|,
literal|"VIA 8235"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|idx
operator|=
name|ata_find_chip
argument_list|(
name|dev
argument_list|,
name|ids
argument_list|,
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
argument_list|)
operator|)
condition|)
return|return
name|ENXIO
return|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %s controller"
argument_list|,
name|idx
operator|->
name|text
argument_list|,
name|ata_mode2str
argument_list|(
name|idx
operator|->
name|max_dma
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|chip
operator|=
name|idx
expr_stmt|;
name|ctlr
operator|->
name|chipinit
operator|=
name|ata_via_chipinit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_via_chipinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_default_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|ENXIO
return|;
comment|/* prepare for ATA-66 on the 82C686a and 82C596b */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|VIACLK
condition|)
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x50
argument_list|,
literal|0x030b030b
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* the southbridge might need the data corruption fix */
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|VIABUG
condition|)
name|ata_via_southbridge_fixup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* set prefetch, postwrite */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x41
argument_list|,
literal|1
argument_list|)
operator||
literal|0xf0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set fifo configuration half'n'half */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x43
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x43
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x90
operator|)
operator||
literal|0x2a
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set status register read retry */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x44
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x44
argument_list|,
literal|1
argument_list|)
operator||
literal|0x08
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set DMA read& end-of-sector fifo flush */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x46
argument_list|,
operator|(
name|pci_read_config
argument_list|(
name|dev
argument_list|,
literal|0x46
argument_list|,
literal|1
argument_list|)
operator|&
literal|0x0c
operator|)
operator||
literal|0xf0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* set sector size */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x60
argument_list|,
name|DEV_BSIZE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
literal|0x68
argument_list|,
name|DEV_BSIZE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|setmode
operator|=
name|ata_via_family_setmode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_via_southbridge_fixup
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_t
modifier|*
name|children
decl_stmt|;
name|int
name|nchildren
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|device_get_children
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|nchildren
argument_list|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchildren
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|ATA_VIA8363
operator|||
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|ATA_VIA8371
operator|||
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|ATA_VIA8662
operator|||
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|ATA_VIA8361
condition|)
block|{
name|u_int8_t
name|reg76
init|=
name|pci_read_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x76
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|reg76
operator|&
literal|0xf0
operator|)
operator|!=
literal|0xd0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Correcting VIA config for southbridge data corruption bug\n"
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x75
argument_list|,
literal|0x80
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|children
index|[
name|i
index|]
argument_list|,
literal|0x76
argument_list|,
operator|(
name|reg76
operator|&
literal|0x0f
operator|)
operator||
literal|0xd0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* common code for VIA, AMD& nVidia */
end_comment

begin_function
specifier|static
name|void
name|ata_via_family_setmode
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|device_t
name|parent
init|=
name|device_get_parent
argument_list|(
name|atadev
operator|->
name|channel
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|u_int8_t
name|timings
index|[]
init|=
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0x55
block|,
literal|0x51
block|,
literal|0xff
block|,
literal|0x55
block|,
literal|0x51
block|,
literal|0x51
block|,
literal|0x51
block|,
literal|0x51
block|,
literal|0x51
block|,
literal|0x51
block|,
literal|0x51
block|}
decl_stmt|;
name|int
name|modes
index|[]
index|[
literal|7
index|]
init|=
block|{
block|{
literal|0xc2
block|,
literal|0xc1
block|,
literal|0xc0
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
comment|/* VIA ATA33 */
block|{
literal|0xee
block|,
literal|0xec
block|,
literal|0xea
block|,
literal|0xe9
block|,
literal|0xe8
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
comment|/* VIA ATA66 */
block|{
literal|0xf7
block|,
literal|0xf6
block|,
literal|0xf4
block|,
literal|0xf2
block|,
literal|0xf1
block|,
literal|0xf0
block|,
literal|0x00
block|}
block|,
comment|/* VIA ATA100 */
block|{
literal|0xf7
block|,
literal|0xf7
block|,
literal|0xf6
block|,
literal|0xf4
block|,
literal|0xf2
block|,
literal|0xf1
block|,
literal|0xf0
block|}
block|,
comment|/* VIA ATA133 */
block|{
literal|0xc2
block|,
literal|0xc1
block|,
literal|0xc0
block|,
literal|0xc4
block|,
literal|0xc5
block|,
literal|0xc6
block|,
literal|0xc7
block|}
block|}
decl_stmt|;
comment|/* AMD/nVIDIA */
name|int
name|devno
init|=
operator|(
name|atadev
operator|->
name|channel
operator|->
name|unit
operator|<<
literal|1
operator|)
operator|+
name|ATA_DEV
argument_list|(
name|atadev
operator|->
name|unit
argument_list|)
decl_stmt|;
name|int
name|reg
init|=
literal|0x53
operator|-
name|devno
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mode
operator|=
name|ata_limit_mode
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|max_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|AMDCABLE
condition|)
block|{
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|!
name|pci_read_config
argument_list|(
name|parent
argument_list|,
literal|0x42
argument_list|,
literal|1
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|devno
operator|)
condition|)
block|{
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"DMA limited to UDMA33, non-ATA66 cable or device\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
block|}
else|else
name|mode
operator|=
name|ata_check_80pin
argument_list|(
name|atadev
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctlr
operator|->
name|chip
operator|->
name|cfg2
operator|&
name|NVIDIA
condition|)
name|reg
operator|+=
literal|0x10
expr_stmt|;
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|reg
operator|-
literal|0x08
argument_list|,
name|timings
index|[
name|ata_mode2idx
argument_list|(
name|mode
argument_list|)
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_command
argument_list|(
name|atadev
argument_list|,
name|ATA_C_SETFEATURES
argument_list|,
literal|0
argument_list|,
name|mode
argument_list|,
name|ATA_C_F_SETXFER
argument_list|,
name|ATA_WAIT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"%s setting %s on %s chip\n"
argument_list|,
operator|(
name|error
operator|)
condition|?
literal|"failed"
else|:
literal|"success"
argument_list|,
name|ata_mode2str
argument_list|(
name|mode
argument_list|)
argument_list|,
name|ctlr
operator|->
name|chip
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
if|if
condition|(
name|mode
operator|>=
name|ATA_UDMA0
condition|)
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
name|modes
index|[
name|ctlr
operator|->
name|chip
operator|->
name|cfg1
index|]
index|[
name|mode
operator|&
name|ATA_MODE_MASK
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|pci_write_config
argument_list|(
name|parent
argument_list|,
name|reg
argument_list|,
literal|0x8b
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|atadev
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* misc functions */
end_comment

begin_function
specifier|static
name|int
name|ata_mode2idx
parameter_list|(
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|(
name|mode
operator|&
name|ATA_DMA_MASK
operator|)
operator|==
name|ATA_UDMA0
condition|)
return|return
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|+
literal|8
return|;
if|if
condition|(
operator|(
name|mode
operator|&
name|ATA_DMA_MASK
operator|)
operator|==
name|ATA_WDMA0
condition|)
return|return
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|+
literal|5
return|;
return|return
operator|(
name|mode
operator|&
name|ATA_MODE_MASK
operator|)
operator|-
name|ATA_PIO0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_check_80pin
parameter_list|(
name|struct
name|ata_device
modifier|*
name|atadev
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
name|mode
operator|>
name|ATA_UDMA2
operator|&&
operator|!
name|atadev
operator|->
name|param
operator|->
name|hwres_cblid
condition|)
block|{
name|ata_prtdev
argument_list|(
name|atadev
argument_list|,
literal|"DMA limited to UDMA33, non-ATA66 cable or device\n"
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ATA_UDMA2
expr_stmt|;
block|}
return|return
name|mode
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ata_chip_id
modifier|*
name|ata_find_chip
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ata_chip_id
modifier|*
name|index
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
name|device_t
modifier|*
name|children
decl_stmt|;
name|u_int32_t
name|devid
decl_stmt|;
name|u_int8_t
name|revid
decl_stmt|;
name|int
name|nchildren
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|device_get_children
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|children
argument_list|,
operator|&
name|nchildren
argument_list|)
condition|)
return|return
literal|0
return|;
name|devid
operator|=
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|revid
operator|=
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
expr_stmt|;
while|while
condition|(
name|index
operator|->
name|chipid
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchildren
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|slot
operator|>=
literal|0
operator|&&
name|pci_get_slot
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|slot
operator|)
operator|||
name|slot
operator|<
literal|0
operator|)
operator|&&
name|pci_get_devid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|==
name|devid
operator|&&
name|pci_get_revid
argument_list|(
name|children
index|[
name|i
index|]
argument_list|)
operator|>=
name|revid
condition|)
block|{
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|index
return|;
block|}
block|}
block|}
name|free
argument_list|(
name|children
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ata_chip_id
modifier|*
name|ata_match_chip
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|ata_chip_id
modifier|*
name|index
parameter_list|)
block|{
while|while
condition|(
name|index
operator|->
name|chipid
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|index
operator|->
name|chipid
operator|&&
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
operator|>=
name|index
operator|->
name|chiprev
condition|)
return|return
name|index
return|;
name|index
operator|++
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ata_default_interrupt
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|rid
init|=
name|ATA_IRQ_RID
decl_stmt|;
if|if
condition|(
operator|!
name|ATA_MASTERDEV
argument_list|(
name|dev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_irq
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
operator|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|r_irq
argument_list|,
name|INTR_TYPE_BIO
operator||
name|INTR_ENTROPY
argument_list|,
name|ata_generic_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|handle
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ata_pci_serialize
parameter_list|(
name|struct
name|ata_channel
modifier|*
name|ch
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|ata_pci_controller
modifier|*
name|scp
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|flags
condition|)
block|{
case|case
name|ATA_LF_LOCK
case|:
if|if
condition|(
name|scp
operator|->
name|locked_ch
operator|==
name|ch
operator|->
name|unit
condition|)
break|break;
while|while
condition|(
operator|!
name|atomic_cmpset_acq_int
argument_list|(
operator|&
name|scp
operator|->
name|locked_ch
argument_list|,
operator|-
literal|1
argument_list|,
name|ch
operator|->
name|unit
argument_list|)
condition|)
name|tsleep
argument_list|(
name|ch
operator|->
name|locking
argument_list|,
name|PRIBIO
argument_list|,
literal|"atasrl"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATA_LF_UNLOCK
case|:
if|if
condition|(
name|scp
operator|->
name|locked_ch
operator|==
operator|-
literal|1
operator|||
name|scp
operator|->
name|locked_ch
operator|!=
name|ch
operator|->
name|unit
condition|)
break|break;
name|atomic_store_rel_int
argument_list|(
operator|&
name|scp
operator|->
name|locked_ch
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
name|ch
operator|->
name|locking
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

end_unit

